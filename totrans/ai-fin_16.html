<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 12. Execution and Deployment"><div class="chapter" id="execution_deployment">
<h1><span class="label">Chapter 12. </span>Execution and Deployment</h1>

<blockquote>
<p class="align_me_right">Considerable progress is needed before autonomous vehicles can operate reliably in mixed urban traffic, heavy rain and snow, unpaved and unmapped roads, and where wireless access is unreliable.</p>
<p data-type="attribution">Todd Litman (2020)</p>
</blockquote>
<blockquote>
<p>An investment firm that engages in algorithmic trading shall have in place effective systems and risk controls suitable to the business it operates to ensure that its trading systems are resilient and have sufficient capacity, are subject to appropriate trading thresholds and limits and prevent the sending of erroneous orders or the systems otherwise functioning in a way that may create or contribute to a disorderly market.</p>
<p data-type="attribution">MiFID II (Article 17)</p>
</blockquote>

<p><a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a> trains a trading bot in the form of a financial Q-learning agent based on historical data. It introduces event-based backtesting as an approach flexible enough to account for typical risk measures, such as trailing stop loss orders or take profit targets. However, all this happens asynchronously in a sandbox environment based on historical data only. As with an autonomous vehicle (AV), there is the problem of deploying the AI in the real world. For an AV this means combining the AI with the car hardware and deploying the AV on test and public streets. For a trading bot this means connecting the trading bot with a trading platform and deploying it such that orders are executed automatically. In other words, the algorithmic side is clear—execution and deployment now need to be added to implement algorithmic trading.</p>

<p><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="execution" id="ix_alg_trade_exec_ch12"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="Oanda environment" id="ix_alg_trade_oanda"/><a data-type="indexterm" data-primary="Oanda trading platform" id="idm45625251792232"/>This chapter introduces the <a href="http://oanda.com">Oanda</a> trading platform for algorithmic trading. Therefore, the focus is on the <a href="https://oreil.ly/TbGKN">v20 API</a> of the platform and not on applications that provide users with an interface for manual trading. To simplify the code, the wrapper package <a href="https://oreil.ly/72pWe"><code>tpqoa</code></a> is introduced and used. It relies on the <a href="https://oreil.ly/H_pIj"><code>v20</code></a> Python package from Oanda and provides a more Pythonic user interface.</p>

<p><a data-type="xref" href="#ed_account">“Oanda Account”</a> details the prerequisites to use a <em>demo account</em> with Oanda. <a data-type="xref" href="#ed_data_retrieval">“Data Retrieval”</a> shows how to retrieve historical and real-time (streaming) data from the API. <a data-type="xref" href="#ed_execution">“Order Execution”</a> deals with the execution of buy and sell orders, potentially including other orders, such as trailing stop loss orders. <a data-type="xref" href="#ed_trading_bot">“Trading Bot”</a> trains a trading bot based on historical intraday data from Oanda and backtests its performance in vectorized fashion. Finally, <a data-type="xref" href="#ed_deployment">“Deployment”</a> shows how to deploy the trading bot in real-time and an automated fashion.</p>






<section data-type="sect1" data-pdf-bookmark="Oanda Account"><div class="sect1" id="ed_account">
<h1>Oanda Account</h1>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="account" id="idm45625261410424"/><a data-type="indexterm" data-primary="tpqoa wrapper" id="idm45625261409480"/>The code in this chapter relies on the Python wrapper package <a href="https://oreil.ly/72pWe"><code>tpqoa</code></a>. This package can be installed via <code>pip</code> as follows:</p>

<pre data-type="programlisting">pip install --upgrade git+https://github.com/yhilpisch/tpqoa.git</pre>

<p>To make use of this package, a demo account with <a href="http://oanda.com">Oanda</a> is sufficient. Once the account is open, an <em>access token</em> is generated on the account page (after login). The access token and the <em>account id</em> (also found on the account page) are then stored in a configuration text file as follows:</p>

<pre data-type="programlisting">[oanda]
account_id = XYZ-ABC-...
access_token = ZYXCAB...
account_type = practice</pre>

<p>If the name of the configuration file is <em>aiif.cfg</em> and if it is stored in the current working directory, then the <code>tpqoa</code> package can be used as follows:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">tpqoa</code>
<code class="n">api</code> <code class="o">=</code> <code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">(</code><code class="s1">'aiif.cfg'</code><code class="p">)</code></pre>
<div data-type="caution"><h1>Risk Disclaimers and Disclosures</h1>
<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="risks and disclaimers" id="idm45625261399512"/><a data-type="indexterm" data-primary="FX (foreign exchange)" id="idm45625261398632"/><a data-type="indexterm" data-primary="CFD (contracts for difference) trading" id="idm45625261397960"/>Oanda is a platform for <em>foreign exchange</em> (FX) and <em>contracts for difference</em> (CFD) trading. These instruments involve considerable risks, in particular when traded with leverage. It is strongly recommended that you read all relevant risk disclaimers and disclosures from Oanda on its <a href="http://oanda.com">website</a> carefully before moving on (check for the appropriate jurisdiction).</p>

<p>All code and examples presented in this chapter are for technical illustration only and do not constitute any investment advice or similar.<a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_oanda" id="idm45625261394584"/></p>
</div>
<div style="page-break-after: always;"/>
</div></section>













<section data-type="sect1" class="less_space" data-pdf-bookmark="Data Retrieval"><div class="sect1" id="ed_data_retrieval">
<h1>Data Retrieval</h1>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="data retrieval" id="ix_Oandaenv_data_retriev"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="data retrieval" id="ix_alg_trade_data_ret"/>As usual, some Python imports and configurations come first:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">os</code>
        <code class="kn">import</code> <code class="nn">time</code>
        <code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>
        <code class="kn">from</code> <code class="nn">pprint</code> <code class="kn">import</code> <code class="n">pprint</code>
        <code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">plt</code><code class="p">,</code> <code class="n">mpl</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'savefig.dpi'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">300</code>
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code>
        <code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'mode.chained_assignment'</code><code class="p">,</code> <code class="bp">None</code><code class="p">)</code>
        <code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'display.float_format'</code><code class="p">,</code> <code class="s1">'{:.5f}'</code><code class="o">.</code><code class="n">format</code><code class="p">)</code>
        <code class="n">np</code><code class="o">.</code><code class="n">set_printoptions</code><code class="p">(</code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">precision</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code>
        <code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s1">'PYTHONHASHSEED'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'0'</code></pre>

<p>Depending on the relevant jurisdiction of the account, Oanda offers a number of tradable FX and CFD instruments. The following Python code retrieves the available instruments for a given account:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tpqoa</code><code>  </code><a class="co" id="co_execution_and_deployment_CO1-1" href="#callout_execution_and_deployment_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">api</code><code> </code><code class="o">=</code><code> </code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">(</code><code class="s1">'</code><code class="s1">../aiif.cfg</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO1-2" href="#callout_execution_and_deployment_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ins</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_instruments</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO1-3" href="#callout_execution_and_deployment_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ins</code><code class="p">[</code><code class="p">:</code><code class="mi">5</code><code class="p">]</code><code>  </code><a class="co" id="co_execution_and_deployment_CO1-4" href="#callout_execution_and_deployment_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">(</code><code class="s1">'</code><code class="s1">AUD/CAD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">AUD_CAD</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>         </code><code class="p">(</code><code class="s1">'</code><code class="s1">AUD/CHF</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">AUD_CHF</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>         </code><code class="p">(</code><code class="s1">'</code><code class="s1">AUD/HKD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">AUD_HKD</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>         </code><code class="p">(</code><code class="s1">'</code><code class="s1">AUD/JPY</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">AUD_JPY</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>
</code><code>         </code><code class="p">(</code><code class="s1">'</code><code class="s1">AUD/NZD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">AUD_NZD</code><code class="s1">'</code><code class="p">)</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO1-1" href="#co_execution_and_deployment_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Imports the <code>tpqoa</code> package</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO1-2" href="#co_execution_and_deployment_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Instantiates an API object given the account credentials</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO1-3" href="#co_execution_and_deployment_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Retrieves the list of available instruments in the format <code>(display_name,</code> 
<span class="keep-together"><code>technical_name)</code></span></p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO1-4" href="#co_execution_and_deployment_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Shows a select few of these instruments</p></dd>
</dl>

<p>Oanda provides a wealth of historical data via its v20 API. The following examples retrieve historical data for the EUR/USD currency pair—the granularity is set to <code>D</code> (that is, <em>daily</em>).</p>
<div style="page-break-after: always;"/>

<p><a data-type="xref" href="#figure_ed_01">Figure 12-1</a> plots the closing (ask) prices:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_history</code><code class="p">(</code><code class="n">instrument</code><code class="o">=</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO2-1" href="#callout_execution_and_deployment_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                              </code><code class="n">start</code><code class="o">=</code><code class="s1">'</code><code class="s1">2018-01-01</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO2-2" href="#callout_execution_and_deployment_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                              </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">2020-07-31</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO2-3" href="#callout_execution_and_deployment_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                              </code><code class="n">granularity</code><code class="o">=</code><code class="s1">'</code><code class="s1">D</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO2-4" href="#callout_execution_and_deployment_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                              </code><code class="n">price</code><code class="o">=</code><code class="s1">'</code><code class="s1">A</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO2-5" href="#callout_execution_and_deployment_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>        </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">671</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">01</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code>
</code><code>        </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">6</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>
</code><code>         </code><code class="c1">#   Column    Non-Null Count  Dtype</code><code>
</code><code>        </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>    </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="mi">0</code><code>   </code><code class="n">o</code><code>         </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>         </code><code class="mi">1</code><code>   </code><code class="n">h</code><code>         </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>         </code><code class="mi">2</code><code>   </code><code class="n">l</code><code>         </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>         </code><code class="mi">3</code><code>   </code><code class="n">c</code><code>         </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>         </code><code class="mi">4</code><code>   </code><code class="n">volume</code><code>    </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">int64</code><code>
</code><code>         </code><code class="mi">5</code><code>   </code><code class="n">complete</code><code>  </code><code class="mi">671</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="nb">bool</code><code>
</code><code>        </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="nb">bool</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>        </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">32.1</code><code> </code><code class="n">KB</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code>                           </code><code class="n">o</code><code>       </code><code class="n">h</code><code>       </code><code class="n">l</code><code>       </code><code class="n">c</code><code>  </code><code class="n">volume</code><code>  </code><code class="n">complete</code><code>
</code><code>        </code><code class="n">time</code><code>
</code><code>        </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">01</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.20101</code><code> </code><code class="mf">1.20819</code><code> </code><code class="mf">1.20051</code><code> </code><code class="mf">1.20610</code><code>   </code><code class="mi">35630</code><code>      </code><code class="bp">True</code><code>
</code><code>        </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">02</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.20620</code><code> </code><code class="mf">1.20673</code><code> </code><code class="mf">1.20018</code><code> </code><code class="mf">1.20170</code><code>   </code><code class="mi">31354</code><code>      </code><code class="bp">True</code><code>
</code><code>        </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">03</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.20170</code><code> </code><code class="mf">1.20897</code><code> </code><code class="mf">1.20049</code><code> </code><code class="mf">1.20710</code><code>   </code><code class="mi">35187</code><code>      </code><code class="bp">True</code><code>
</code><code>        </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.20692</code><code> </code><code class="mf">1.20847</code><code> </code><code class="mf">1.20215</code><code> </code><code class="mf">1.20327</code><code>   </code><code class="mi">36478</code><code>      </code><code class="bp">True</code><code>
</code><code>        </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">07</code><code> </code><code class="mi">22</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.20301</code><code> </code><code class="mf">1.20530</code><code> </code><code class="mf">1.19564</code><code> </code><code class="mf">1.19717</code><code>   </code><code class="mi">27618</code><code>      </code><code class="bp">True</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO2-1" href="#co_execution_and_deployment_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Specifies the instrument…</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO2-2" href="#co_execution_and_deployment_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>…the starting date…</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO2-3" href="#co_execution_and_deployment_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>…the end date…</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO2-4" href="#co_execution_and_deployment_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>…the granularity (<code>D</code> = daily)…</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO2-5" href="#co_execution_and_deployment_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>…and the type of the price series (<code>A</code> = ask)</p></dd>
</dl>

<figure class="thumb"><div id="figure_ed_01" class="figure">
<img src="Images/aiif_1201.png" alt="aiif 1201" width="2468" height="1427"/>
<h6><span class="label">Figure 12-1. </span>Historical daily closing prices for EUR/USD from Oanda</h6>
</div></figure>

<p>Intraday data is as easily retrieved and used as daily data, as the code that follows shows. <a data-type="xref" href="#figure_ed_02">Figure 12-2</a> visualizes minute bar (mid) price data:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_history</code><code class="p">(</code><code class="n">instrument</code><code class="o">=</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                               </code><code class="n">start</code><code class="o">=</code><code class="s1">'</code><code class="s1">2020-07-01</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                               </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">2020-07-31</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                               </code><code class="n">granularity</code><code class="o">=</code><code class="s1">'</code><code class="s1">M1</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO3-1" href="#callout_execution_and_deployment_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                               </code><code class="n">price</code><code class="o">=</code><code class="s1">'</code><code class="s1">M</code><code class="s1">'</code><code class="p">)</code><code>   </code><a class="co" id="co_execution_and_deployment_CO3-2" href="#callout_execution_and_deployment_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">30728</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code> </code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">59</code><code class="p">:</code><code class="mo">00</code><code>
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">6</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>
</code><code>          </code><code class="c1">#   Column    Non-Null Count  Dtype</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>    </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">o</code><code>         </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">h</code><code>         </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">l</code><code>         </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">c</code><code>         </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">volume</code><code>    </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">int64</code><code>
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">complete</code><code>  </code><code class="mi">30728</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="nb">bool</code><code>
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="nb">bool</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">1.4</code><code> </code><code class="n">MB</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code>                           </code><code class="n">o</code><code>       </code><code class="n">h</code><code>       </code><code class="n">l</code><code>       </code><code class="n">c</code><code>  </code><code class="n">volume</code><code>  </code><code class="n">complete</code><code>
</code><code>         </code><code class="n">time</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">55</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.18724</code><code> </code><code class="mf">1.18739</code><code> </code><code class="mf">1.18718</code><code> </code><code class="mf">1.18738</code><code>      </code><code class="mi">57</code><code>      </code><code class="bp">True</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">56</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.18736</code><code> </code><code class="mf">1.18758</code><code> </code><code class="mf">1.18722</code><code> </code><code class="mf">1.18757</code><code>      </code><code class="mi">57</code><code>      </code><code class="bp">True</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">57</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.18756</code><code> </code><code class="mf">1.18756</code><code> </code><code class="mf">1.18734</code><code> </code><code class="mf">1.18734</code><code>      </code><code class="mi">49</code><code>      </code><code class="bp">True</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">58</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.18736</code><code> </code><code class="mf">1.18737</code><code> </code><code class="mf">1.18713</code><code> </code><code class="mf">1.18717</code><code>      </code><code class="mi">36</code><code>      </code><code class="bp">True</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">30</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">59</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="mf">1.18718</code><code> </code><code class="mf">1.18724</code><code> </code><code class="mf">1.18714</code><code> </code><code class="mf">1.18722</code><code>      </code><code class="mi">31</code><code>      </code><code class="bp">True</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO3-1" href="#co_execution_and_deployment_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Specifies the granularity (<code>M1</code> = one minute)…</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO3-2" href="#co_execution_and_deployment_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>…and the type of the price series (<code>M</code> = mid)</p></dd>
</dl>

<figure class="thumb"><div id="figure_ed_02" class="figure">
<img src="Images/aiif_1202.png" alt="aiif 1202" width="2444" height="1460"/>
<h6><span class="label">Figure 12-2. </span>Historical one-minute bar closing prices for EUR/USD from Oanda</h6>
</div></figure>

<p>Whereas historical data is important, for instance, to train and test a trading bot, real-time (streaming) data is required to deploy such a bot for algorithmic trading. <code>tpqoa</code> allows the synchronous streaming of real-time data for all available instruments with a single method call. The method prints by default the time stamp and the bid/ask prices. For algorithmic trading, this default behavior can be adjusted, as <a data-type="xref" href="#ed_deployment">“Deployment”</a> shows:<a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_data_ret" id="idm45625254584984"/><a data-type="indexterm" data-primary="" data-startref="ix_Oandaenv_data_retriev" id="idm45625254584008"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">14</code><code class="p">]:</code> <code class="n">api</code><code class="o">.</code><code class="n">stream_data</code><code class="p">(</code><code class="s1">'EUR_USD'</code><code class="p">,</code> <code class="n">stop</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">09.735715316</code><code class="n">Z</code> <code class="mf">1.18328</code> <code class="mf">1.18342</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">16.245253689</code><code class="n">Z</code> <code class="mf">1.18329</code> <code class="mf">1.18343</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">16.397803785</code><code class="n">Z</code> <code class="mf">1.18328</code> <code class="mf">1.18342</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">17.240232521</code><code class="n">Z</code> <code class="mf">1.18331</code> <code class="mf">1.18346</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">17.358476854</code><code class="n">Z</code> <code class="mf">1.18334</code> <code class="mf">1.18348</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">17.778061207</code><code class="n">Z</code> <code class="mf">1.18331</code> <code class="mf">1.18345</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">18.016544856</code><code class="n">Z</code> <code class="mf">1.18333</code> <code class="mf">1.18346</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">18.144762415</code><code class="n">Z</code> <code class="mf">1.18334</code> <code class="mf">1.18348</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">18.689365678</code><code class="n">Z</code> <code class="mf">1.18331</code> <code class="mf">1.18345</code>
         <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">19.148039139</code><code class="n">Z</code> <code class="mf">1.18331</code> <code class="mf">1.18345</code></pre>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Order Execution"><div class="sect1" id="ed_execution">
<h1>Order Execution</h1>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="order execution" id="ix_Oandaenv_order_exec"/><a data-type="indexterm" data-primary="market orders" data-secondary="execution of" id="ix_market_order_exec"/><a data-type="indexterm" data-primary="execution of trading algorithms" data-secondary="order execution" id="ix_exec_alg_order"/>The AI of an AV needs to be able to control the physical vehicle. To this end it sends different types of signals to the vehicle, for example, to accelerate, break, turn left, or turn right. A trading bot needs to be able to place orders with the trading platform. This section covers different types of orders, such as market orders and stop loss orders.</p>

<p>The most fundamental type of order is a <em>market order</em>. <a data-type="indexterm" data-primary="ask price" id="idm45625249597976"/><a data-type="indexterm" data-primary="bid price" id="idm45625249597240"/>This order allows buying or selling a financial instrument at the current market price (that is, the <em>ask price</em> when buying and the <em>bid price</em> when selling). The following examples are based on an account leverage of 20 and relatively small order sizes. Therefore, liquidity issues, for example, do not play a role. When executing orders via the Oanda v20 API, the API returns a detailed order object. <a data-type="indexterm" data-primary="buy market order, placing" id="idm45625249595224"/>First, a <em>buy market order</em> is placed:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO4-1" href="#callout_execution_and_deployment_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO4-2" href="#callout_execution_and_deployment_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="p">{</code><code class="s1">'</code><code class="s1">accountBalance</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">98553.3172</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">accountID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">101-004-13834683-001</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">batchID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1625</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">commission</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">financing</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">fullPrice</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">asks</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">liquidity</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">10000000</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18345</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">bids</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">liquidity</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">10000000</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18331</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">closeoutAsk</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18345</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">closeoutBid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18331</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">PRICE</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">fullVWAP</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18345</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">gainQuoteHomeConversionFactor</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.840811914585</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">guaranteedExecutionFee</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">halfSpreadCost</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1.4788</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1626</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">instrument</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">lossQuoteHomeConversionFactor</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.849262285586</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">orderID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1625</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">pl</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18345</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">reason</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">MARKET_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">requestID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">78757241547812154</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-08-13T12:07:19.434407966Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">tradeOpened</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">guaranteedExecutionFee</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                          </code><code class="s1">'</code><code class="s1">halfSpreadCost</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1.4788</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                          </code><code class="s1">'</code><code class="s1">initialMarginRequired</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">832.5</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                          </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18345</code><code class="p">,</code><code>
</code><code>                          </code><code class="s1">'</code><code class="s1">tradeID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1626</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                          </code><code class="s1">'</code><code class="s1">units</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">ORDER_FILL</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">units</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">userID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">13834683</code><code class="p">}</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_execution_and_deployment_CO4-3" href="#callout_execution_and_deployment_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>             </code><code class="n">details</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">7</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">instrument</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">units</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                        </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">pl</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>
</code><code>             </code><code class="k">return</code><code> </code><code class="n">details</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO4-4" href="#callout_execution_and_deployment_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:19.434</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18345</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO4-1" href="#co_execution_and_deployment_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Places a <em>buy market order</em> and prints the order object details</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO4-2" href="#co_execution_and_deployment_CO4-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Selects and shows the <code>time</code>, <code>instrument</code>, <code>units</code>, <code>price</code>, and <code>pl</code> details of the order</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="sell market order, placing" id="idm45625258911768"/>Second, the position is closed via a <em>sell market order</em> of the same size. Whereas the first trade has a profit/loss (P&amp;L) of zero by its nature—before accounting for transaction costs—the second trade in general has a nonzero P&amp;L:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO5-1" href="#callout_execution_and_deployment_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO5-2" href="#callout_execution_and_deployment_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="p">{</code><code class="s1">'</code><code class="s1">accountBalance</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">98549.283</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">accountID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">101-004-13834683-001</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">batchID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1627</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">commission</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">financing</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">fullPrice</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">asks</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">liquidity</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">9975000</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18339</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">bids</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">liquidity</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">10000000</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18326</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">closeoutAsk</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18339</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">closeoutBid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18326</code><code class="p">,</code><code>
</code><code>                        </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">PRICE</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">fullVWAP</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18326</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">gainQuoteHomeConversionFactor</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.840850994445</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">guaranteedExecutionFee</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">halfSpreadCost</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1.3732</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1628</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">instrument</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">lossQuoteHomeConversionFactor</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.849301758209</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">orderID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1627</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">pl</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">-4.0342</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18326</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">reason</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">MARKET_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">requestID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">78757241552009237</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-08-13T12:07:20.586564454Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">tradesClosed</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">financing</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">guaranteedExecutionFee</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">halfSpreadCost</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1.3732</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.18326</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">realizedPL</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">-4.0342</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">tradeID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1626</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                            </code><code class="s1">'</code><code class="s1">units</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">ORDER_FILL</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">units</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">userID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">13834683</code><code class="p">}</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code> </code><a class="co" id="co_execution_and_deployment_CO5-3" href="#callout_execution_and_deployment_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:20.586</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18326</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-4.0342</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO5-1" href="#co_execution_and_deployment_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Places a <em>sell market order</em> and prints the order object details</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO5-2" href="#co_execution_and_deployment_CO5-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Selects and shows the <code>time</code>, <code>instrument</code>, <code>units</code>, <code>price</code>, and <code>pl</code> details of the order</p></dd>
</dl>
<div data-type="note" epub:type="note"><h1>Limit Orders</h1>
<p>This chapter covers <em>market orders</em> as a type of base order only. With a market order, buying or selling a financial instrument happens at the price that is current when the order is placed. <a data-type="indexterm" data-primary="limit order" id="idm45625252845848"/>By contrast, a <em>limit order</em>, as the other main type of base order, allows the placement of an order with a minimum price or a maximum price. Only when the minimum/maximum price is reached is the order 
<span class="keep-together">executed.</span> Until that point, no transaction takes place.</p>
</div>

<p><a data-type="indexterm" data-primary="stop loss (SL) order" data-secondary="execution of" id="idm45625257179272"/>Next, consider an example for the same combination of trades but this time with a <em>stop loss</em> (SL) order. An SL order is treated as a separate (limit) order. The following Python code places the orders and shows the details of the SL order object:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">sl_distance</code><code class="o">=</code><code class="mf">0.005</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO6-1" href="#callout_execution_and_deployment_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:21.740</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18343</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sl_order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_transaction</code><code class="p">(</code><code class="n">tid</code><code class="o">=</code><code class="nb">int</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO6-2" href="#callout_execution_and_deployment_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sl_order</code><code>  </code><a class="co" id="co_execution_and_deployment_CO6-3" href="#callout_execution_and_deployment_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1631</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-08-13T12:07:21.740825489Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">userID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">13834683</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">accountID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">101-004-13834683-001</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">batchID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1629</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">requestID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">78757241556206373</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">STOP_LOSS_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">tradeID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1630</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.17843</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.005</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">timeInForce</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">GTC</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">triggerCondition</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">DEFAULT</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">reason</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">ON_FILL</code><code class="s1">'</code><code class="p">}</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">sl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">sl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>
</code><code>          </code><code class="n">sl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">sl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO6-4" href="#callout_execution_and_deployment_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:21.740825489Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">STOP_LOSS_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="mf">1.18343</code><code class="p">,</code><code>
</code><code>          </code><code class="mf">1.17843</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">0.005</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="mi">25000</code><code class="p">,</code><code> </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:23.059</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18329</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-2.9725</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO6-1" href="#co_execution_and_deployment_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The SL distance is defined in currency units.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO6-2" href="#co_execution_and_deployment_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Selects and shows the SL order object data.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO6-3" href="#co_execution_and_deployment_CO6-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Selects and shows some relevant details of the two order objects.</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="trailing stop loss (TSL) order" data-secondary="execution of" id="idm45625259282984"/>A <em>trailing stop loss</em> (TSL) order is handled in the same way. The only difference is that there is no fixed price attached to a TSL order:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">tsl_distance</code><code class="o">=</code><code class="mf">0.005</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO7-1" href="#callout_execution_and_deployment_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:23.204</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18341</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tsl_order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_transaction</code><code class="p">(</code><code class="n">tid</code><code class="o">=</code><code class="nb">int</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO7-2" href="#callout_execution_and_deployment_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tsl_order</code><code>  </code><a class="co" id="co_execution_and_deployment_CO7-3" href="#callout_execution_and_deployment_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1637</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-08-13T12:07:23.204457044Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">userID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">13834683</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">accountID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">101-004-13834683-001</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">batchID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1635</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">requestID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">78757241564598562</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">TRAILING_STOP_LOSS_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">tradeID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1636</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">0.005</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">timeInForce</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">GTC</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">triggerCondition</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">DEFAULT</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">reason</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">ON_FILL</code><code class="s1">'</code><code class="p">}</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">tsl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">7</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">tsl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>
</code><code>          </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">tsl_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO7-4" href="#callout_execution_and_deployment_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:23.204</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">TRAILING_STOP_LOSS_ORDER</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18341</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">0.005</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:24.551</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.1833</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-2.3355</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO7-1" href="#co_execution_and_deployment_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The TSL distance is defined in currency units.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO7-2" href="#co_execution_and_deployment_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Selects and shows the TSL order object data.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO7-3" href="#co_execution_and_deployment_CO7-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Selects and shows some relevant details of the two order objects.</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="take profit (TP) order" data-secondary="execution of" id="idm45625259341608"/>Finally, here is a <em>take profit</em> (TP) order. This order requires a fixed TP target price. Therefore, the following code uses the execution price from the previous order to define the TP price in relative terms. Beyond this small difference, the handling is again the same as before:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tp_price</code><code> </code><code class="o">=</code><code> </code><code class="nb">round</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="mf">0.01</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">)</code><code>
</code><code>         </code><code class="n">tp_price</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">1.1933</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">tp_price</code><code class="o">=</code><code class="n">tp_price</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO8-1" href="#callout_execution_and_deployment_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:25.712</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18344</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">0.0</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tp_order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_transaction</code><code class="p">(</code><code class="n">tid</code><code class="o">=</code><code class="nb">int</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO8-2" href="#callout_execution_and_deployment_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tp_order</code><code>  </code><a class="co" id="co_execution_and_deployment_CO8-3" href="#callout_execution_and_deployment_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1643</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-08-13T12:07:25.712531725Z</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">userID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mi">13834683</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">accountID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">101-004-13834683-001</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">batchID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1641</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">requestID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">78757241572993078</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">TAKE_PROFIT_ORDER</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">tradeID</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">1642</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="mf">1.1933</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">timeInForce</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">GTC</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">triggerCondition</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">DEFAULT</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">reason</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">ON_FILL</code><code class="s1">'</code><code class="p">}</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">tp_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">time</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">7</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">tp_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>
</code><code>          </code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">tp_order</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO8-4" href="#callout_execution_and_deployment_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:25.712</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">TAKE_PROFIT_ORDER</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18344</code><code class="p">,</code><code> </code><code class="mf">1.1933</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="mi">25000</code><code class="p">,</code><code>
</code><code>                                  </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_details</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-08-13T12:07:27.020</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-25000.0</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.18332</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-2.5478</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO8-1" href="#co_execution_and_deployment_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The TP target price is defined relative to the previous execution price.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO8-2" href="#co_execution_and_deployment_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Selects and shows the TP order object data.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO8-3" href="#co_execution_and_deployment_CO8-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Selects and shows some relevant details of the two order objects.</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="execution of trading algorithms" data-secondary="historical transactions" id="idm45625259948904"/><a data-type="indexterm" data-primary="historical transactions, Oanda v20 API" id="idm45625259948072"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="Oanda environment" id="ix_alg_trade_oanda_env"/>The code so far only deals with transaction details of single orders. However, it is also of interest to have an overview of multiple <em>historical transactions</em>. To this end, the 
<span class="keep-together">following</span> method call provides overview data for all the main orders placed in this section, including P&amp;L data:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">48</code><code class="p">]:</code> <code class="n">api</code><code class="o">.</code><code class="n">print_transactions</code><code class="p">(</code><code class="n">tid</code><code class="o">=</code><code class="nb">int</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'id'</code><code class="p">])</code> <code class="o">-</code> <code class="mi">22</code><code class="p">)</code>
          <code class="mi">1626</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">19.434407966</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>      <code class="mf">25000.0</code> <code class="o">|</code>      <code class="mf">0.0</code>
          <code class="mi">1628</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">20.586564454</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>     <code class="o">-</code><code class="mf">25000.0</code> <code class="o">|</code>  <code class="o">-</code><code class="mf">4.0342</code>
          <code class="mi">1630</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">21.740825489</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>      <code class="mf">25000.0</code> <code class="o">|</code>      <code class="mf">0.0</code>
          <code class="mi">1633</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">23.059178023</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>     <code class="o">-</code><code class="mf">25000.0</code> <code class="o">|</code>  <code class="o">-</code><code class="mf">2.9725</code>
          <code class="mi">1636</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">23.204457044</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>      <code class="mf">25000.0</code> <code class="o">|</code>      <code class="mf">0.0</code>
          <code class="mi">1639</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">24.551026466</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>     <code class="o">-</code><code class="mf">25000.0</code> <code class="o">|</code>  <code class="o">-</code><code class="mf">2.3355</code>
          <code class="mi">1642</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">25.712531725</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>      <code class="mf">25000.0</code> <code class="o">|</code>      <code class="mf">0.0</code>
          <code class="mi">1645</code> <code class="o">|</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mo">07</code><code class="p">:</code><code class="mf">27.020414342</code><code class="n">Z</code> <code class="o">|</code>   <code class="n">EUR_USD</code> <code class="o">|</code>     <code class="o">-</code><code class="mf">25000.0</code> <code class="o">|</code>  <code class="o">-</code><code class="mf">2.5478</code></pre>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="account" id="idm45625260011416"/><a data-type="indexterm" data-primary="execution of trading algorithms" data-secondary="account details" id="idm45625260010568"/>Yet another method call provides a snapshot of the <em>account details</em>. The details shown are from an Oanda demo account that has been in use for quite some time for technical testing purposes:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">49</code><code class="p">]:</code> <code class="n">api</code><code class="o">.</code><code class="n">get_account_summary</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">49</code><code class="p">]:</code> <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code> <code class="s1">'101-004-13834683-001'</code><code class="p">,</code>
          <code class="s1">'alias'</code><code class="p">:</code> <code class="s1">'Primary'</code><code class="p">,</code>
          <code class="s1">'currency'</code><code class="p">:</code> <code class="s1">'EUR'</code><code class="p">,</code>
          <code class="s1">'balance'</code><code class="p">:</code> <code class="s1">'98541.4272'</code><code class="p">,</code>
          <code class="s1">'createdByUserID'</code><code class="p">:</code> <code class="mi">13834683</code><code class="p">,</code>
          <code class="s1">'createdTime'</code><code class="p">:</code> <code class="s1">'2020-03-19T06:08:14.363139403Z'</code><code class="p">,</code>
          <code class="s1">'guaranteedStopLossOrderMode'</code><code class="p">:</code> <code class="s1">'DISABLED'</code><code class="p">,</code>
          <code class="s1">'pl'</code><code class="p">:</code> <code class="s1">'-1248.5543'</code><code class="p">,</code>
          <code class="s1">'resettablePL'</code><code class="p">:</code> <code class="s1">'-1248.5543'</code><code class="p">,</code>
          <code class="s1">'resettablePLTime'</code><code class="p">:</code> <code class="s1">'0'</code><code class="p">,</code>
          <code class="s1">'financing'</code><code class="p">:</code> <code class="s1">'-210.0185'</code><code class="p">,</code>
          <code class="s1">'commission'</code><code class="p">:</code> <code class="s1">'0.0'</code><code class="p">,</code>
          <code class="s1">'guaranteedExecutionFees'</code><code class="p">:</code> <code class="s1">'0.0'</code><code class="p">,</code>
          <code class="s1">'marginRate'</code><code class="p">:</code> <code class="s1">'0.0333'</code><code class="p">,</code>
          <code class="s1">'openTradeCount'</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s1">'openPositionCount'</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s1">'pendingOrderCount'</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s1">'hedgingEnabled'</code><code class="p">:</code> <code class="bp">False</code><code class="p">,</code>
          <code class="s1">'unrealizedPL'</code><code class="p">:</code> <code class="s1">'941.9536'</code><code class="p">,</code>
          <code class="s1">'NAV'</code><code class="p">:</code> <code class="s1">'99483.3808'</code><code class="p">,</code>
          <code class="s1">'marginUsed'</code><code class="p">:</code> <code class="s1">'380.83'</code><code class="p">,</code>
          <code class="s1">'marginAvailable'</code><code class="p">:</code> <code class="s1">'99107.2283'</code><code class="p">,</code>
          <code class="s1">'positionValue'</code><code class="p">:</code> <code class="s1">'3808.3'</code><code class="p">,</code>
          <code class="s1">'marginCloseoutUnrealizedPL'</code><code class="p">:</code> <code class="s1">'947.9546'</code><code class="p">,</code>
          <code class="s1">'marginCloseoutNAV'</code><code class="p">:</code> <code class="s1">'99489.3818'</code><code class="p">,</code>
          <code class="s1">'marginCloseoutMarginUsed'</code><code class="p">:</code> <code class="s1">'380.83'</code><code class="p">,</code>
          <code class="s1">'marginCloseoutPercent'</code><code class="p">:</code> <code class="s1">'0.00191'</code><code class="p">,</code>
          <code class="s1">'marginCloseoutPositionValue'</code><code class="p">:</code> <code class="s1">'3808.3'</code><code class="p">,</code>
          <code class="s1">'withdrawalLimit'</code><code class="p">:</code> <code class="s1">'98541.4272'</code><code class="p">,</code>
          <code class="s1">'marginCallMarginUsed'</code><code class="p">:</code> <code class="s1">'380.83'</code><code class="p">,</code>
          <code class="s1">'marginCallPercent'</code><code class="p">:</code> <code class="s1">'0.00383'</code><code class="p">,</code>
          <code class="s1">'lastTransactionID'</code><code class="p">:</code> <code class="s1">'1646'</code><code class="p">}</code></pre>

<p>This concludes the discussion of the basics of executing orders with Oanda. All elements are now together to support the deployment of a trading bot. The remainder of this chapter trains a trading bot on Oanda data and deploys it in automated fashion.<a data-type="indexterm" data-primary="" data-startref="ix_exec_alg_order" id="idm45625249836120"/><a data-type="indexterm" data-primary="" data-startref="ix_market_order_exec" id="idm45625249835272"/><a data-type="indexterm" data-primary="" data-startref="ix_Oandaenv_order_exec" id="idm45625249834328"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Trading Bot"><div class="sect1" id="ed_trading_bot">
<h1>Trading Bot</h1>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="trading bot training" id="ix_Oandaenv_trade_bot"/><a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a> shows in detail how to train a deep Q-learning trading bot and how to backtest it in vectorized and event-based fashion. <a data-type="indexterm" data-primary="event-based backtesting" data-secondary="Oanda environment" id="ix_event_backtest_oanda"/><a data-type="indexterm" data-primary="QL (Q-learning)" data-secondary="as trading bot" data-secondary-sortas="trading bot" id="ix_ql_tradebot_learn"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="event-based backtesting" id="ix_alg_trade_event_backtest"/><a data-type="indexterm" data-primary="execution of trading algorithms" data-secondary="trading bot learning" id="ix_tradebot_exec"/><a data-type="indexterm" data-primary="agents" data-secondary="QL agent" id="ix_agent_ql_ch12"/>This section now repeats selected core steps in this regard based on historical data from Oanda. <a data-type="xref" href="#ed_oanda_env">“Oanda Environment”</a> provides a Python module that contains the environment class <code>OandaEnv</code> to work with Oanda data. It can be used in the same way as the <code>Finance</code> class from <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a>.</p>

<p><a data-type="indexterm" data-primary="OandaEnv class" id="ix_oanda_env_3"/>The following Python code instantiates the learning environment object. During this step, the major data-related parameters driving the learning, validation, and testing are fixed. The <code>OandaEnv</code> class allows the inclusion of leverage, which is typical for FX and CFD trading. Leverage amplifies the realized returns, thereby increasing the profit potential but also the loss risks:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">oandaenv</code><code> </code><code class="kn">as</code><code> </code><code class="nn">oe</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">date</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">2020-08-11</code><code class="s1">'</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">features</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">m</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">v</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="o">%</code><code class="n">time</code><code>
</code><code>         </code><code class="n">learn_env</code><code> </code><code class="o">=</code><code> </code><code class="n">oe</code><code class="o">.</code><code class="n">OandaEnv</code><code class="p">(</code><code class="n">symbol</code><code class="o">=</code><code class="n">symbol</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">start</code><code class="o">=</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} 08:00:00</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">end</code><code class="o">=</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} 13:00:00</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">granularity</code><code class="o">=</code><code class="s1">'</code><code class="s1">S30</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-1" href="#callout_execution_and_deployment_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">price</code><code class="o">=</code><code class="s1">'</code><code class="s1">M</code><code class="s1">'</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-2" href="#callout_execution_and_deployment_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">features</code><code class="o">=</code><code class="n">features</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-3" href="#callout_execution_and_deployment_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">window</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-4" href="#callout_execution_and_deployment_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">lags</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-5" href="#callout_execution_and_deployment_CO9-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">leverage</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-6" href="#callout_execution_and_deployment_CO9-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.4</code><code class="p">,</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-7" href="#callout_execution_and_deployment_CO9-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>                           </code><code class="n">min_performance</code><code class="o">=</code><code class="mf">0.85</code><code>  </code><a class="co" id="co_execution_and_deployment_CO9-8" href="#callout_execution_and_deployment_CO9-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>                          </code><code class="p">)</code><code>
</code><code>         </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mf">23.1</code><code> </code><code class="n">ms</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mf">2.86</code><code> </code><code class="n">ms</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">25.9</code><code> </code><code class="n">ms</code><code>
</code><code>         </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">26.8</code><code> </code><code class="n">ms</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">bincount</code><code class="p">(</code><code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mi">299</code><code class="p">,</code><code> </code><code class="mi">281</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">580</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="mi">08</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="mi">12</code><code class="p">:</code><code class="mi">59</code><code class="p">:</code><code class="mi">30</code><code>
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">6</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>
</code><code>          </code><code class="c1">#   Column   Non-Null Count  Dtype</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>   </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">EUR_USD</code><code>  </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">r</code><code>        </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">s</code><code>        </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">m</code><code>        </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">v</code><code>        </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">d</code><code>        </code><code class="mi">580</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">int64</code><code>
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">31.7</code><code> </code><code class="n">KB</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO9-1" href="#co_execution_and_deployment_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the granularity for the data to five seconds</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-2" href="#co_execution_and_deployment_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the price type to mid prices</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-3" href="#co_execution_and_deployment_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Defines the set of features to be used</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-4" href="#co_execution_and_deployment_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Defines the window length for rolling statistics</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-5" href="#co_execution_and_deployment_CO9-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Specifies the number of lags</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-6" href="#co_execution_and_deployment_CO9-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Fixes the leverage</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-7" href="#co_execution_and_deployment_CO9-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Sets the required minimum accuracy</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO9-8" href="#co_execution_and_deployment_CO9-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Sets the required minimum performance</p></dd>
</dl>

<p>In a next step, the validation environment is instantiated, relying on the parameters of the learning environment—apart from the time interval, for obvious reasons. <a data-type="xref" href="#figure_ed_03">Figure 12-3</a> shows the closing prices of EUR/USD as used in the learning, validation, and test environments (from left to right):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">57</code><code class="p">]:</code> <code class="n">valid_env</code> <code class="o">=</code> <code class="n">oe</code><code class="o">.</code><code class="n">OandaEnv</code><code class="p">(</code><code class="n">symbol</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>
                           <code class="n">start</code><code class="o">=</code><code class="n">f</code><code class="s1">'{date} 13:00:00'</code><code class="p">,</code>
                           <code class="n">end</code><code class="o">=</code><code class="n">f</code><code class="s1">'{date} 14:00:00'</code><code class="p">,</code>
                           <code class="n">granularity</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">granularity</code><code class="p">,</code>
                           <code class="n">price</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">price</code><code class="p">,</code>
                           <code class="n">features</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">features</code><code class="p">,</code>
                           <code class="n">window</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code><code class="p">,</code>
                           <code class="n">lags</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                           <code class="n">leverage</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">leverage</code><code class="p">,</code>
                           <code class="n">min_accuracy</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                           <code class="n">min_performance</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                           <code class="n">mu</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">mu</code><code class="p">,</code>
                           <code class="n">std</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">std</code>
                          <code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">58</code><code class="p">]:</code> <code class="n">valid_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">()</code>
         <code class="o">&lt;</code><code class="k">class</code> <code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'&gt;</code>
         <code class="n">DatetimeIndex</code><code class="p">:</code> <code class="mi">100</code> <code class="n">entries</code><code class="p">,</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code> <code class="mi">13</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code> <code class="n">to</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code> <code class="mi">13</code><code class="p">:</code><code class="mi">59</code><code class="p">:</code><code class="mi">30</code>
         <code class="n">Data</code> <code class="n">columns</code> <code class="p">(</code><code class="n">total</code> <code class="mi">6</code> <code class="n">columns</code><code class="p">):</code>
          <code class="c1">#   Column   Non-Null Count  Dtype</code>
         <code class="o">---</code>  <code class="o">------</code>   <code class="o">--------------</code>  <code class="o">-----</code>
          <code class="mi">0</code>   <code class="n">EUR_USD</code>  <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">1</code>   <code class="n">r</code>        <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">2</code>   <code class="n">s</code>        <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">3</code>   <code class="n">m</code>        <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">4</code>   <code class="n">v</code>        <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">5</code>   <code class="n">d</code>        <code class="mi">100</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">int64</code>
         <code class="n">dtypes</code><code class="p">:</code> <code class="n">float64</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="n">memory</code> <code class="n">usage</code><code class="p">:</code> <code class="mf">5.5</code> <code class="n">KB</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">59</code><code class="p">]:</code> <code class="n">test_env</code> <code class="o">=</code> <code class="n">oe</code><code class="o">.</code><code class="n">OandaEnv</code><code class="p">(</code><code class="n">symbol</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>
                           <code class="n">start</code><code class="o">=</code><code class="n">f</code><code class="s1">'{date} 14:00:00'</code><code class="p">,</code>
                           <code class="n">end</code><code class="o">=</code><code class="n">f</code><code class="s1">'{date} 17:00:00'</code><code class="p">,</code>
                           <code class="n">granularity</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">granularity</code><code class="p">,</code>
                           <code class="n">price</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">price</code><code class="p">,</code>
                           <code class="n">features</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">features</code><code class="p">,</code>
                           <code class="n">window</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code><code class="p">,</code>
                           <code class="n">lags</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                           <code class="n">leverage</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">leverage</code><code class="p">,</code>
                           <code class="n">min_accuracy</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                           <code class="n">min_performance</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                           <code class="n">mu</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">mu</code><code class="p">,</code>
                           <code class="n">std</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">std</code>
                          <code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">60</code><code class="p">]:</code> <code class="n">test_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">()</code>
         <code class="o">&lt;</code><code class="k">class</code> <code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'&gt;</code>
         <code class="n">DatetimeIndex</code><code class="p">:</code> <code class="mi">340</code> <code class="n">entries</code><code class="p">,</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code> <code class="mi">14</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code> <code class="n">to</code> <code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">11</code> <code class="mi">16</code><code class="p">:</code><code class="mi">59</code><code class="p">:</code><code class="mi">30</code>
         <code class="n">Data</code> <code class="n">columns</code> <code class="p">(</code><code class="n">total</code> <code class="mi">6</code> <code class="n">columns</code><code class="p">):</code>
          <code class="c1">#   Column   Non-Null Count  Dtype</code>
         <code class="o">---</code>  <code class="o">------</code>   <code class="o">--------------</code>  <code class="o">-----</code>
          <code class="mi">0</code>   <code class="n">EUR_USD</code>  <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">1</code>   <code class="n">r</code>        <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">2</code>   <code class="n">s</code>        <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">3</code>   <code class="n">m</code>        <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">4</code>   <code class="n">v</code>        <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
          <code class="mi">5</code>   <code class="n">d</code>        <code class="mi">340</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">int64</code>
         <code class="n">dtypes</code><code class="p">:</code> <code class="n">float64</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="n">memory</code> <code class="n">usage</code><code class="p">:</code> <code class="mf">18.6</code> <code class="n">KB</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">61</code><code class="p">]:</code> <code class="n">ax</code> <code class="o">=</code> <code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">axvline</code><code class="p">(</code><code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">],</code> <code class="n">ls</code><code class="o">=</code><code class="s1">'--'</code><code class="p">)</code>
         <code class="n">valid_env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">,</code> <code class="n">style</code><code class="o">=</code><code class="s1">'-.'</code><code class="p">)</code>
         <code class="n">plt</code><code class="o">.</code><code class="n">axvline</code><code class="p">(</code><code class="n">valid_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">],</code> <code class="n">ls</code><code class="o">=</code><code class="s1">'--'</code><code class="p">)</code>
         <code class="n">test_env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">,</code> <code class="n">style</code><code class="o">=</code><code class="s1">'-.'</code><code class="p">);</code></pre>

<figure class="thumb"><div id="figure_ed_03" class="figure">
<img src="Images/aiif_1203.png" alt="aiif 1203" width="2468" height="1466"/>
<h6><span class="label">Figure 12-3. </span>Historical 30-second bar closing prices for EUR/USD from Oanda 
<span class="keep-together">(learning = left, validation = middle, testing = right)</span></h6>
</div></figure>

<p>Based on the Oanda environment, the trading bot from <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a> can be trained and validated. The following Python code performs this task and visualizes the performance results (see <a data-type="xref" href="#figure_ed_04">Figure 12-4</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">sys</code><code>
</code><code>         </code><code class="n">sys</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="s1">'</code><code class="s1">../ch11/</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO10-1" href="#callout_execution_and_deployment_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tradingbot</code><code>  </code><a class="co" id="co_execution_and_deployment_CO10-2" href="#callout_execution_and_deployment_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">Using</code><code> </code><code class="n">TensorFlow</code><code> </code><code class="n">backend</code><code class="o">.</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tradingbot</code><code class="o">.</code><code class="n">set_seeds</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code><code>
</code><code>         </code><code class="n">agent</code><code> </code><code class="o">=</code><code> </code><code class="n">tradingbot</code><code class="o">.</code><code class="n">TradingBot</code><code class="p">(</code><code class="mi">24</code><code class="p">,</code><code> </code><code class="mf">0.001</code><code class="p">,</code><code> </code><code class="n">learn_env</code><code class="o">=</code><code class="n">learn_env</code><code class="p">,</code><code>
</code><code>                                       </code><code class="n">valid_env</code><code class="o">=</code><code class="n">valid_env</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO10-3" href="#callout_execution_and_deployment_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">episodes</code><code> </code><code class="o">=</code><code> </code><code class="mi">31</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="n">time</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">learn</code><code class="p">(</code><code class="n">episodes</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO10-4" href="#callout_execution_and_deployment_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code>  </code><code class="mi">5</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">1.004</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.96</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">10</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">1.005</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.91</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">15</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">0.986</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.87</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">20</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">1.012</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.83</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">25</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">0.995</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.79</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">30</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">VALIDATION</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">97</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">0.972</code><code> </code><code class="o">|</code><code> </code><code class="n">eps</code><code class="p">:</code><code> </code><code class="mf">0.75</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="n">episode</code><code class="p">:</code><code> </code><code class="mi">31</code><code class="o">/</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">treward</code><code class="p">:</code><code>   </code><code class="mi">16</code><code> </code><code class="o">|</code><code> </code><code class="n">perf</code><code class="p">:</code><code> </code><code class="mf">0.981</code><code> </code><code class="o">|</code><code> </code><code class="n">av</code><code class="p">:</code><code> </code><code class="mf">376.0</code><code> </code><code class="o">|</code><code> </code><code class="nb">max</code><code class="p">:</code><code>  </code><code class="mi">577</code><code>
</code><code>         </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mf">22.1</code><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mf">1.17</code><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">23.3</code><code> </code><code class="n">s</code><code>
</code><code>         </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">20.1</code><code> </code><code class="n">s</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tradingbot</code><code class="o">.</code><code class="n">plot_performance</code><code class="p">(</code><code class="n">agent</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO10-5" href="#callout_execution_and_deployment_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO10-1" href="#co_execution_and_deployment_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Imports the <code>tradingbot</code> module from <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a></p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO10-2" href="#co_execution_and_deployment_CO10-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Trains and validates the trading bot based on Oanda data</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO10-3" href="#co_execution_and_deployment_CO10-5"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Visualizes the performance results</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="Oanda environment" id="ix_vector_backtest_oanda"/>As discussed in the previous two chapters, the training and validation performances are just an indicator of the trading bot performance.</p>

<figure class="thumb"><div id="figure_ed_04" class="figure">
<img src="Images/aiif_1204.png" alt="aiif 1204" width="2510" height="1491"/>
<h6><span class="label">Figure 12-4. </span>Training and validation performance results of the trading bot for Oanda data</h6>
</div></figure>

<p>The following code implements a vectorized backtest of the trading bot performance for the test environment—again with the same parameters as the learning environment apart from the time interval used. <a data-type="indexterm" data-primary="backtest() function" id="idm45625246819000"/>The code makes use of the function <code>backtest()</code> as provided in the Python module presented in <a data-type="xref" href="#ed_backtest">“Vectorized Backtesting”</a>. The reported performance numbers include a leverage of 20. This holds true for both the gross performance of the passive benchmark investment and the trading bot over time, as shown in <a data-type="xref" href="#figure_ed_05">Figure 12-5</a>:<a data-type="indexterm" data-primary="" data-startref="ix_oanda_env_3" id="idm45625246815944"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">backtest</code><code> </code><code class="kn">as</code><code> </code><code class="nn">bt</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">test_env</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bt</code><code class="o">.</code><code class="n">backtest</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code><code> </code><code class="n">env</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO11-1" href="#callout_execution_and_deployment_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mi">1</code><code>    </code><code class="mi">263</code><code>
</code><code>         </code><code class="o">-</code><code class="mi">1</code><code>     </code><code class="mi">74</code><code>
</code><code>         </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">p</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO11-2" href="#callout_execution_and_deployment_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">25</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">leverage</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code>
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO11-3" href="#callout_execution_and_deployment_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="mf">0.99966</code><code>
</code><code>         </code><code class="n">s</code><code>   </code><code class="mf">1.05910</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">leverage</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code>
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_execution_and_deployment_CO11-4" href="#callout_execution_and_deployment_CO11-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="o">-</code><code class="mf">0.00034</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.05910</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">leverage</code><code class="p">)</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_execution_and_deployment_CO11-5" href="#callout_execution_and_deployment_CO11-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO11-1" href="#co_execution_and_deployment_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Shows the total number of long and short positions</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO11-2" href="#co_execution_and_deployment_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Shows the number of trades required to implement the strategy</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO11-3" href="#co_execution_and_deployment_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Calculates the gross performance including leverage</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO11-4" href="#co_execution_and_deployment_CO11-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Calculates the net performance including leverage</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO11-5" href="#co_execution_and_deployment_CO11-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Visualizes the gross performance over time including leverage<a data-type="indexterm" data-primary="" data-startref="ix_agent_ql_ch12" id="idm45625245791928"/><a data-type="indexterm" data-primary="" data-startref="ix_tradebot_exec" id="idm45625245790952"/><a data-type="indexterm" data-primary="" data-startref="ix_ql_tradebot_learn" id="idm45625245790008"/></p></dd>
</dl>

<figure class="thumb"><div id="figure_ed_05" class="figure">
<img src="Images/aiif_1205.png" alt="aiif 1205" width="2444" height="1490"/>
<h6><span class="label">Figure 12-5. </span>Gross performance of the passive benchmark investment and the trading bot over time (including leverage)</h6>
</div></figure>
<div data-type="caution"><h1>Simplified Backtesting</h1>
<p>The training and backtesting of the trading bot in this section happen under assumptions that are not realistic. The trading strategy based on the 30-second bars might lead to a large number of trades over a short period of time. Assuming typical transaction costs (bid-ask spreads), such a strategy often is not economically viable. Longer bars or a strategy with fewer trades would be more realistic. However, to allow for a “quick” deployment demo in the next section, the training and backtest are implemented intentionally on the relatively short 30-second bars.<a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_exec_ch12" id="idm45625245785112"/><a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_oanda_env" id="idm45625245784136"/><a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_event_backtest" id="idm45625245783192"/><a data-type="indexterm" data-primary="" data-startref="ix_event_backtest_oanda" id="idm45625245782280"/><a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_oanda" id="idm45625245781336"/><a data-type="indexterm" data-primary="" data-startref="ix_Oandaenv_trade_bot" id="idm45625245780424"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Deployment"><div class="sect1" id="ed_deployment">
<h1>Deployment</h1>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="deployment of trading bot" id="ix_Oandaenv_deploy_trade_bot"/><a data-type="indexterm" data-primary="deployment of trained trading bot" id="ix_deploy_alg_trade"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="deployment" id="ix_alg_trade_deploy"/>This section combines the major elements of the previous sections to deploy the trained trading bot in automated fashion. This is comparable to the point in time at which an AV is prepared to be deployed on the streets. <a data-type="indexterm" data-primary="OandaTradingBot class" id="idm45625245733880"/>The class <code>OandaTradingBot</code> presented in the following code inherits from the <code>tpqoa</code> class and adds some helper functions and the trading logic:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tpqoa</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">class</code><code> </code><code class="nc">OandaTradingBot</code><code class="p">(</code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">)</code><code class="p">:</code><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">config_file</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="p">,</code><code> </code><code class="n">granularity</code><code class="p">,</code><code> </code><code class="n">units</code><code class="p">,</code><code>
</code><code>                          </code><code class="n">verbose</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="nb">super</code><code class="p">(</code><code class="n">OandaTradingBot</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="n">config_file</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code> </code><code class="o">=</code><code> </code><code class="n">agent</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">window</code><code>
</code><code>                 </code><code class="k">if</code><code> </code><code class="n">granularity</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>                     </code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code> </code><code class="o">=</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">granularity</code><code>
</code><code>                 </code><code class="k">else</code><code class="p">:</code><code>
</code><code>                     </code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code> </code><code class="o">=</code><code> </code><code class="n">granularity</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="n">units</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code><code> </code><code class="o">+</code><code>
</code><code>                                    </code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">pl</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code> </code><code class="o">=</code><code> </code><code class="n">verbose</code><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">_prepare_data</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code>
</code><code>                                                     </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">m</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">v</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>                 </code><code class="c1"># self.data_ = (self.data - self.env.mu) / self.env.std  </code><a class="co" id="co_execution_and_deployment_CO12-1" href="#callout_execution_and_deployment_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-2" href="#callout_execution_and_deployment_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">_resample_data</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">right</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">ffill</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-3" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-4" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code class="p">]</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-5" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="o">.</code><code class="n">tz_localize</code><code class="p">(</code><code class="bp">None</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-6" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">_get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-7" href="#callout_execution_and_deployment_CO12-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                 </code><code class="k">return</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="o">.</code><code class="n">values</code><code class="p">,</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code><code>
</code><code>                                                  </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">n_features</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-8" href="#callout_execution_and_deployment_CO12-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">report_trade</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">time</code><code class="p">,</code><code> </code><code class="n">side</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>                 </code><code class="n">pl</code><code> </code><code class="o">=</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'</code><code class="s1">pl</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-9" href="#callout_execution_and_deployment_CO12-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">pl</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pl</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-10" href="#callout_execution_and_deployment_CO12-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                 </code><code class="n">cpl</code><code> </code><code class="o">=</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">pl</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-11" href="#callout_execution_and_deployment_CO12-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="mi">75</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{time} | *** GOING {side} ({self.trades}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{time} | PROFIT/LOSS={pl:.2f} | CUMULATIVE={cpl:.2f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="mi">75</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                 </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>                     </code><code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code>                     </code><code class="k">print</code><code class="p">(</code><code class="mi">75</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">on_success</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">time</code><code class="p">,</code><code> </code><code class="n">bid</code><code class="p">,</code><code> </code><code class="n">ask</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="s1">'</code><code class="s1">ask</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">ask</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">bid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">bid</code><code class="p">,</code><code>
</code><code>                                    </code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">bid</code><code> </code><code class="o">+</code><code> </code><code class="n">ask</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">}</code><code class="p">,</code><code>
</code><code>                                   </code><code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">pd</code><code class="o">.</code><code class="n">Timestamp</code><code class="p">(</code><code class="n">time</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">df</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-12" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">_resample_data</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-13" href="#callout_execution_and_deployment_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                 </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code class="p">:</code><code>
</code><code>                     </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>                     </code><code class="bp">self</code><code class="o">.</code><code class="n">_prepare_data</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                     </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">_get_state</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-14" href="#callout_execution_and_deployment_CO12-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                     </code><code class="n">prediction</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">state</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-15" href="#callout_execution_and_deployment_CO12-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                     </code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="k">if</code><code> </code><code class="n">prediction</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="k">else</code><code> </code><code class="o">-</code><code class="mi">1</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-16" href="#callout_execution_and_deployment_CO12-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                     </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-17" href="#callout_execution_and_deployment_CO12-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>                         </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">units</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code><code>
</code><code>                                         </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">time</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">LONG</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>                     </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" id="co_execution_and_deployment_CO12-18" href="#callout_execution_and_deployment_CO12-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>                         </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code><code>
</code><code>                                         </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">time</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">SHORT</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO12-1" href="#co_execution_and_deployment_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>For demonstration, the normalization is done with the real-time data statistics.<sup><a data-type="noteref" id="idm45625242073656-marker" href="ch12.xhtml#idm45625242073656">1</a></sup></p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-2" href="#co_execution_and_deployment_CO12-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Collects the tick data and resamples it to the required granularity.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-3" href="#co_execution_and_deployment_CO12-7"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Returns the current state of the financial market.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-4" href="#co_execution_and_deployment_CO12-9"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Collects the P&amp;L figures for every trade.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-5" href="#co_execution_and_deployment_CO12-11"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Calculates the cumulative P&amp;L for all trades.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-6" href="#co_execution_and_deployment_CO12-14"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Predicts the market direction and derives the signal (position).</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-7" href="#co_execution_and_deployment_CO12-17"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Checks whether the conditions for a <em>long position</em> (buy order) are met.</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO12-8" href="#co_execution_and_deployment_CO12-18"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Checks whether the conditions for a <em>short position</em> (sell order) are met.</p></dd>
</dl>

<p>The application of this class is straightforward. First, an object is instantiated, providing as the major input the trained trading bot <code>agent</code> from the previous section. 
<span class="keep-together">Second,</span> the streaming for the instrument to be traded needs to be started. <a data-type="indexterm" data-primary=".on_success() method" data-primary-sortas="on success method" id="idm45625241854744"/>Whenever new tick data arrives, the <code>.on_success()</code> method is called, which contains the main logic for both the processing of the tick data and the placement of trades. To speed things up a bit, the deployment example relies, as did the backtesting before, on 
<span class="keep-together">30-second bars.</span> In a production context, when managing real money, a longer time interval might be the better choice—if only to reduce the number of trades and therewith the transaction costs:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">otb</code><code> </code><code class="o">=</code><code> </code><code class="n">OandaTradingBot</code><code class="p">(</code><code class="s1">'</code><code class="s1">../aiif.cfg</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">30s</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                               </code><code class="mi">25000</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO13-1" href="#callout_execution_and_deployment_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">otb</code><code class="o">.</code><code class="n">tick_data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>         </code><code class="n">Index</code><code class="p">:</code><code> </code><code class="mi">0</code><code> </code><code class="n">entries</code><code>
</code><code>         </code><code class="n">Empty</code><code> </code><code class="n">DataFrame</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">80</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">otb</code><code class="o">.</code><code class="n">stream_data</code><code class="p">(</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="n">stop</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO13-2" href="#callout_execution_and_deployment_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">19</code><code class="p">:</code><code class="mf">32.320291893</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">GOING</code><code> </code><code class="n">SHORT</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">19</code><code class="p">:</code><code class="mf">32.320291893</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="n">PROFIT</code><code class="o">/</code><code class="n">LOSS</code><code class="o">=</code><code class="mf">0.00</code><code> </code><code class="o">|</code><code> </code><code class="n">CUMULATIVE</code><code class="o">=</code><code class="mf">0.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">20</code><code class="p">:</code><code class="mf">00.083985447</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">GOING</code><code> </code><code class="n">LONG</code><code> </code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">20</code><code class="p">:</code><code class="mf">00.083985447</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="n">PROFIT</code><code class="o">/</code><code class="n">LOSS</code><code class="o">=</code><code class="o">-</code><code class="mf">6.80</code><code> </code><code class="o">|</code><code> </code><code class="n">CUMULATIVE</code><code class="o">=</code><code class="o">-</code><code class="mf">6.80</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">25</code><code class="p">:</code><code class="mf">00.099901587</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">GOING</code><code> </code><code class="n">SHORT</code><code> </code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">25</code><code class="p">:</code><code class="mf">00.099901587</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="n">PROFIT</code><code class="o">/</code><code class="n">LOSS</code><code class="o">=</code><code class="o">-</code><code class="mf">7.86</code><code> </code><code class="o">|</code><code> </code><code class="n">CUMULATIVE</code><code class="o">=</code><code class="o">-</code><code class="mf">14.66</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">81</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="mi">75</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">*** CLOSING OUT ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>         </code><code class="n">order</code><code> </code><code class="o">=</code><code> </code><code class="n">otb</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="n">otb</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code>
</code><code>                         </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="n">otb</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">*</code><code> </code><code class="n">otb</code><code class="o">.</code><code class="n">units</code><code class="p">,</code><code>
</code><code>                         </code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO13-3" href="#callout_execution_and_deployment_CO13-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">otb</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">otb</code><code class="o">.</code><code class="n">time</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">NEUTRAL</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">order</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO13-4" href="#callout_execution_and_deployment_CO13-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>         </code><code class="k">if</code><code> </code><code class="n">otb</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>             </code><code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code><code>
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="mi">75</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">25</code><code class="p">:</code><code class="mf">16.870357562</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">GOING</code><code> </code><code class="n">NEUTRAL</code><code> </code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">13</code><code class="n">T12</code><code class="p">:</code><code class="mi">25</code><code class="p">:</code><code class="mf">16.870357562</code><code class="n">Z</code><code> </code><code class="o">|</code><code> </code><code class="n">PROFIT</code><code class="o">/</code><code class="n">LOSS</code><code class="o">=</code><code class="o">-</code><code class="mf">3.19</code><code> </code><code class="o">|</code><code> </code><code class="n">CUMULATIVE</code><code class="o">=</code><code class="o">-</code><code class="mf">17.84</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">=</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO13-1" href="#co_execution_and_deployment_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Instantiates the <code>OandaTradingBot</code> object</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO13-2" href="#co_execution_and_deployment_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Starts the streaming of the real-time data and the trading</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO13-3" href="#co_execution_and_deployment_CO13-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Closes the final position after a certain number of ticks retrieved</p></dd>
</dl>

<p>During the deployment, P&amp;L figures are collected in the <code>pl</code> attribute, which is a <code>list</code> object. Once the trading has stopped, the P&amp;L figures can be analyzed:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">82</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pl</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">otb</code><code class="o">.</code><code class="n">pl</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO14-1" href="#callout_execution_and_deployment_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">83</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pl</code><code>  </code><a class="co" id="co_execution_and_deployment_CO14-2" href="#callout_execution_and_deployment_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">83</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">0.</code><code>    </code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">6.7959</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">7.8594</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">3.1862</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pl</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO14-3" href="#callout_execution_and_deployment_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code>  </code><code class="mf">0.</code><code>    </code><code class="p">,</code><code>  </code><code class="o">-</code><code class="mf">6.7959</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">14.6553</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">17.8415</code><code class="p">]</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO14-1" href="#co_execution_and_deployment_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>P&amp;L figures for all trades</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO14-2" href="#co_execution_and_deployment_CO14-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Cumulative P&amp;L figures</p></dd>
</dl>

<p>The simple deployment example illustrates that one can trade algorithmically and in automated fashion with a deep Q-learning trading bot in less than 100 lines of Python code. The major prerequisite is the trained trading bot (i.e., an instance of the 
<span class="keep-together"><code>tradingbot</code> class).</span> Many important aspects are intentionally left out here. For example, in a production environment, one would probably like to persist the data. One would also like to persist the order objects. Measures to make sure that the socket connection is still alive are also important (for example, by monitoring a heartbeat). Overall, security, reliability, logging, and monitoring are not really addressed. Some more details in this regard are provided in Hilpisch (2020).</p>

<p>The Python script in <a data-type="xref" href="#ed_otb">“Oanda Trading Bot”</a> presents a standalone executable version of the <code>OandaTradingBot</code> class. This represents a major step toward a more robust deployment option as compared to an interactive context such as Jupyter Notebook or Jupyter Lab. The script also includes functionality to add SL, TSL, or TP orders for the execution. The script expects a pickled version of the <code>agent</code> object in the current working directory. The following Python code pickles the object for later usage by the script:<a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_deploy" id="idm45625243300440"/><a data-type="indexterm" data-primary="" data-startref="ix_deploy_alg_trade" id="idm45625243299576"/><a data-type="indexterm" data-primary="" data-startref="ix_Oandaenv_deploy_trade_bot" id="idm45625243298632"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">85</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">pickle</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">86</code><code class="p">]:</code> <code class="n">pickle</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'trading.bot'</code><code class="p">,</code> <code class="s1">'wb'</code><code class="p">))</code></pre>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusions"><div class="sect1" id="idm45625242338200">
<h1>Conclusions</h1>

<p>This chapter discusses central aspects of the execution of an algorithmic trading strategy and the deployment of a trading bot. The Oanda trading platform provides directly or indirectly with its v20 API all necessary capabilities to do the following:</p>

<ul>
<li>
<p>Retrieve historical data</p>
</li>
<li>
<p>Train and backtest a trading bot (deep Q-learning agent)</p>
</li>
<li>
<p>Stream real-time data</p>
</li>
<li>
<p>Place market (and limit) orders</p>
</li>
<li>
<p>Make use of SL, TSL, and TP orders</p>
</li>
<li>
<p>Deploy a trading bot in an automated manner</p>
</li>
</ul>

<p>The prerequisites to implement all these steps are a demo account with Oanda, standard hardware and software (open source only), and a stable internet connection. In other words, the barriers of entry to algorithmic trading for the purposes of exploiting economic inefficiencies are pretty low. This is in stark contrast, for example, to the training, design, and construction of AVs for deployment on public streets—the budgets of companies in the AV space run into the billions of dollars. In other words, the finance domain has distinctive advantages compared to other industries and domains with regard to the real-world deployment of AI agents, such as trading bots, as focused on in this and the previous chapter.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="References"><div class="sect1" id="idm45625241795256">
<h1>References</h1>

<p>Books and papers cited in this chapter:</p>

<ul class="author-date-bib">
<li>
<p>Hilpisch, Yves. 2020. <em>Python for Algorithmic Trading: From Idea to Cloud Deployment.</em> Sebastopol: O’Reilly.</p>
</li>
<li>
<p>Litman, Todd. 2020. “Autonomous Vehicle Implementation Predictions.” <em>Victoria Transport Policy Institute</em>. <a href="https://oreil.ly/ds7YM"><em class="hyperlink">https://oreil.ly/ds7YM</em></a>.</p>
</li>
</ul>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Python Code"><div class="sect1" id="idm45625242477000">
<h1>Python Code</h1>

<p>This section contains code used and referenced in the main body of the chapter.</p>








<section data-type="sect2" data-pdf-bookmark="Oanda Environment"><div class="sect2" id="ed_oanda_env">
<h2>Oanda Environment</h2>

<p><a data-type="indexterm" data-primary="Oanda v20 API (Oanda environment)" data-secondary="deployment of trading bot" id="ix_Oandaenv_python_examples"/><a data-type="indexterm" data-primary="event-based backtesting" data-secondary="Oanda environment" id="ix_event_backtest_oanda_2"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="event-based backtesting" id="ix_alg_trade_event_backtest_2"/><a data-type="indexterm" data-primary="algorithmic trading" data-secondary="Oanda environment" id="ix_alg_trade_oanda_env_2"/><a data-type="indexterm" data-primary="OandaEnv class" id="ix_oandaenv_class"/>The following is the Python module with the <code>OandaEnv</code> class to train a trading bot based on historical Oanda data:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code><code>
</code><code class="c1"># Finance Environment</code><code>
</code><code class="c1">#</code><code>
</code><code class="c1"># (c) Dr. Yves J. Hilpisch</code><code>
</code><code class="c1"># Artificial Intelligence in Finance</code><code>
</code><code class="c1">#</code><code>
</code><code class="c1">#</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">math</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">tpqoa</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">random</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">observation_space</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">n</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">shape</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code class="p">)</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">action_space</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">n</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">n</code><code> </code><code class="o">=</code><code> </code><code class="n">n</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">sample</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">n</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">OandaEnv</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="n">start</code><code class="p">,</code><code> </code><code class="n">end</code><code class="p">,</code><code> </code><code class="n">granularity</code><code class="p">,</code><code> </code><code class="n">price</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">features</code><code class="p">,</code><code> </code><code class="n">window</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="p">,</code><code> </code><code class="n">leverage</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="n">min_performance</code><code class="o">=</code><code class="mf">0.85</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">mu</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">std</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="n">symbol</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code> </code><code class="o">=</code><code> </code><code class="n">start</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code> </code><code class="o">=</code><code> </code><code class="n">end</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code> </code><code class="o">=</code><code> </code><code class="n">granularity</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">price</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">api</code><code> </code><code class="o">=</code><code> </code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">(</code><code class="s1">'</code><code class="s1">../aiif.cfg</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code> </code><code class="o">=</code><code> </code><code class="n">features</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">n_features</code><code> </code><code class="o">=</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">features</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="n">window</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="n">lags</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">leverage</code><code> </code><code class="o">=</code><code> </code><code class="n">leverage</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">min_accuracy</code><code> </code><code class="o">=</code><code> </code><code class="n">min_accuracy</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">min_performance</code><code> </code><code class="o">=</code><code> </code><code class="n">min_performance</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code> </code><code class="o">=</code><code> </code><code class="n">mu</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">std</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">observation_space</code><code> </code><code class="o">=</code><code> </code><code class="n">observation_space</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">action_space</code><code> </code><code class="o">=</code><code> </code><code class="n">action_space</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">_get_data</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">_prepare_data</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">_get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Method to retrieve data from Oanda.
        '''</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">../../source/oanda/</code><code class="s1">'</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-1" href="#callout_execution_and_deployment_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">oanda_{self.symbol}_{self.start}_{self.end}_</code><code class="s1">'</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-2" href="#callout_execution_and_deployment_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">{self.granularity}_{self.price}.csv</code><code class="s1">'</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-3" href="#callout_execution_and_deployment_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s1">'</code><code class="s1"> </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">_</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">_</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s1">'</code><code class="s1">:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">_</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code class="p">,</code><code> </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-4" href="#callout_execution_and_deployment_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">except</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">api</code><code class="o">.</code><code class="n">get_history</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">,</code><code>
</code><code>                                       </code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code class="p">,</code><code>
</code><code>                                       </code><code class="bp">self</code><code class="o">.</code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-5" href="#callout_execution_and_deployment_CO15-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="o">.</code><code class="n">to_csv</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">fn</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-6" href="#callout_execution_and_deployment_CO15-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-7" href="#callout_execution_and_deployment_CO15-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-8" href="#callout_execution_and_deployment_CO15-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">_prepare_data</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Method to prepare additional time series data
            (such as features data).
        '''</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">m</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">v</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">std</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">_get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Privat method that returns the state of the environment.
        '''</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">-</code><code>
</code><code>                                    </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Method that returns the state of the environment.
        '''</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="n">bar</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">reset</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Method to reset the environment.
        '''</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">treward</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">performance</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code>
</code><code>        </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">_get_state</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">state</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">step</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">action</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Method to step the environment forwards.
        '''</code><code>
</code><code>        </code><code class="n">correct</code><code> </code><code class="o">=</code><code> </code><code class="n">action</code><code> </code><code class="o">==</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code><code>
</code><code>        </code><code class="n">ret</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">leverage</code><code>
</code><code>        </code><code class="n">reward_1</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="k">if</code><code> </code><code class="n">correct</code><code> </code><code class="k">else</code><code> </code><code class="mi">0</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-9" href="#callout_execution_and_deployment_CO15-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">reward_2</code><code> </code><code class="o">=</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code><code> </code><code class="k">if</code><code> </code><code class="n">correct</code><code> </code><code class="k">else</code><code> </code><code class="o">-</code><code class="nb">abs</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-10" href="#callout_execution_and_deployment_CO15-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">reward</code><code> </code><code class="o">=</code><code> </code><code class="n">reward_1</code><code> </code><code class="o">+</code><code> </code><code class="n">reward_2</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">leverage</code><code>  </code><a class="co" id="co_execution_and_deployment_CO15-11" href="#callout_execution_and_deployment_CO15-10"><img src="Images/10.png" alt="10" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">treward</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">reward_1</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">treward</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">performance</code><code> </code><code class="o">*</code><code class="o">=</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="n">reward_2</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">True</code><code>
</code><code>        </code><code class="k">elif</code><code> </code><code class="n">reward_1</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>
</code><code>            </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">False</code><code>
</code><code>        </code><code class="k">elif</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code><code> </code><code class="o">&lt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">min_accuracy</code><code> </code><code class="ow">and</code><code>
</code><code>              </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">&gt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">15</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">True</code><code>
</code><code>        </code><code class="k">elif</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">performance</code><code> </code><code class="o">&lt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">min_performance</code><code> </code><code class="ow">and</code><code>
</code><code>              </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">&gt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">15</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">True</code><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">False</code><code>
</code><code>        </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">_get_state</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">info</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">state</code><code class="p">,</code><code> </code><code class="n">reward</code><code class="p">,</code><code> </code><code class="n">done</code><code class="p">,</code><code> </code><code class="n">info</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_execution_and_deployment_CO15-1" href="#co_execution_and_deployment_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defines the path for the data file</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-2" href="#co_execution_and_deployment_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Defines the filename of the data file</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-3" href="#co_execution_and_deployment_CO15-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Reads the data if a corresponding data file exists</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-4" href="#co_execution_and_deployment_CO15-5"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Retrieves the data for the API if no such file exists</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-5" href="#co_execution_and_deployment_CO15-6"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Writes the data as a <code>CSV</code> file to disk</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-6" href="#co_execution_and_deployment_CO15-7"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Selects the column with the closing prices</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-7" href="#co_execution_and_deployment_CO15-8"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Renames the column to the instrument name (symbol)</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-8" href="#co_execution_and_deployment_CO15-9"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Reward for correct prediction</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-9" href="#co_execution_and_deployment_CO15-10"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>Reward for the realized performance (return)</p></dd>
<dt><a class="co" id="callout_execution_and_deployment_CO15-10" href="#co_execution_and_deployment_CO15-11"><img src="Images/10.png" alt="10" width="12" height="12"/></a></dt>
<dd><p>Combined reward for prediction and performance<a data-type="indexterm" data-primary="" data-startref="ix_oandaenv_class" id="idm45625240087992"/><a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_event_backtest_2" id="idm45625240087016"/><a data-type="indexterm" data-primary="" data-startref="ix_event_backtest_oanda_2" id="idm45625237874936"/></p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Vectorized Backtesting"><div class="sect2" id="ed_backtest">
<h2>Vectorized Backtesting</h2>

<p><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="Oanda environment" id="idm45625237872920"/><a data-type="indexterm" data-primary="agents" data-secondary="QL agent" id="idm45625237871944"/><a data-type="indexterm" data-primary="backtest() function" id="idm45625237871000"/><a data-type="indexterm" data-primary="QL (Q-learning)" data-secondary="as trading bot" data-secondary-sortas="trading bot" id="idm45625237870328"/>The following is the Python module with the helper function <code>backtest</code> to generate the data to do a vectorized backtest for a deep Q-learning trading bot. The code is also used in <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a>:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code>
<code class="c1"># Vectorized Backtesting of</code>
<code class="c1"># Trading Bot (Financial Q-Learning Agent)</code>
<code class="c1">#</code>
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>
<code class="c1"># Artificial Intelligence in Finance</code>
<code class="c1">#</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>
<code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'mode.chained_assignment'</code><code class="p">,</code> <code class="bp">None</code><code class="p">)</code>

<code class="k">def</code> <code class="nf">reshape</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="n">env</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code> <code class="n">env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>

<code class="k">def</code> <code class="nf">backtest</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code> <code class="n">env</code><code class="p">):</code>
    <code class="n">done</code> <code class="o">=</code> <code class="bp">False</code>
    <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="n">state</code> <code class="o">=</code> <code class="n">env</code><code class="o">.</code><code class="n">reset</code><code class="p">()</code>
    <code class="k">while</code> <code class="ow">not</code> <code class="n">done</code><code class="p">:</code>
        <code class="n">action</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code>
            <code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="n">env</code><code class="p">))[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
        <code class="n">position</code> <code class="o">=</code> <code class="mi">1</code> <code class="k">if</code> <code class="n">action</code> <code class="o">==</code> <code class="mi">1</code> <code class="k">else</code> <code class="o">-</code><code class="mi">1</code>
        <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[:,</code> <code class="s1">'p'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code> <code class="o">=</code> <code class="n">position</code>
        <code class="n">state</code><code class="p">,</code> <code class="n">reward</code><code class="p">,</code> <code class="n">done</code><code class="p">,</code> <code class="n">info</code> <code class="o">=</code> <code class="n">env</code><code class="o">.</code><code class="n">step</code><code class="p">(</code><code class="n">action</code><code class="p">)</code>
    <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'s'</code><code class="p">]</code> <code class="o">=</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">*</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Oanda Trading Bot"><div class="sect2" id="ed_otb">
<h2>Oanda Trading Bot</h2>

<p><a data-type="indexterm" data-primary="OandaTradingBot class" id="idm45625238873128"/>The following is the Python script with the <code>OandaTradingBot</code> class and code to deploy the class:<a data-type="indexterm" data-primary="" data-startref="ix_alg_trade_oanda_env_2" id="idm45625237568616"/><a data-type="indexterm" data-primary="" data-startref="ix_Oandaenv_python_examples" id="idm45625237567576"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code>
<code class="c1"># Oanda Trading Bot</code>
<code class="c1"># and Deployment Code</code>
<code class="c1">#</code>
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>
<code class="c1"># Artificial Intelligence in Finance</code>
<code class="c1">#</code>
<code class="kn">import</code> <code class="nn">sys</code>
<code class="kn">import</code> <code class="nn">tpqoa</code>
<code class="kn">import</code> <code class="nn">pickle</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>

<code class="n">sys</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="s1">'../ch11/'</code><code class="p">)</code>


<code class="k">class</code> <code class="nc">OandaTradingBot</code><code class="p">(</code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">config_file</code><code class="p">,</code> <code class="n">agent</code><code class="p">,</code> <code class="n">granularity</code><code class="p">,</code> <code class="n">units</code><code class="p">,</code>
                 <code class="n">sl_distance</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">tsl_distance</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">tp_price</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>
                 <code class="n">verbose</code><code class="o">=</code><code class="bp">True</code><code class="p">):</code>
        <code class="nb">super</code><code class="p">(</code><code class="n">OandaTradingBot</code><code class="p">,</code> <code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="n">config_file</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">agent</code> <code class="o">=</code> <code class="n">agent</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">env</code> <code class="o">=</code> <code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">window</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">window</code>
        <code class="k">if</code> <code class="n">granularity</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">granularity</code> <code class="o">=</code> <code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">granularity</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">granularity</code> <code class="o">=</code> <code class="n">granularity</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">=</code> <code class="n">units</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">sl_distance</code> <code class="o">=</code> <code class="n">sl_distance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tsl_distance</code> <code class="o">=</code> <code class="n">tsl_distance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tp_price</code> <code class="o">=</code> <code class="n">tp_price</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code> <code class="o">+</code>
                           <code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">pl</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code> <code class="o">=</code> <code class="n">verbose</code>
    <code class="k">def</code> <code class="nf">_prepare_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="sd">''' Prepares the (lagged) features data.</code>
<code class="sd">        '''</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'s'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'m'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'v'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data_</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">mu</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">std</code>
    <code class="k">def</code> <code class="nf">_resample_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="sd">''' Resamples the data to the trading bar length.</code>
<code class="sd">        '''</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">granularity</code><code class="p">,</code>
                                <code class="n">label</code><code class="o">=</code><code class="s1">'right'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">()</code><code class="o">.</code><code class="n">ffill</code><code class="p">()</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">])</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">columns</code> <code class="o">=</code> <code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="o">.</code><code class="n">tz_localize</code><code class="p">(</code><code class="bp">None</code><code class="p">)</code>
    <code class="k">def</code> <code class="nf">_get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="sd">''' Returns the (current) state of the financial market.</code>
<code class="sd">        '''</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code>
        <code class="k">return</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="o">.</code><code class="n">values</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>
    <code class="k">def</code> <code class="nf">report_trade</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">time</code><code class="p">,</code> <code class="n">side</code><code class="p">,</code> <code class="n">order</code><code class="p">):</code>
        <code class="sd">''' Reports trades and order details.</code>
<code class="sd">        '''</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">+=</code> <code class="mi">1</code>
        <code class="n">pl</code> <code class="o">=</code> <code class="nb">float</code><code class="p">(</code><code class="n">order</code><code class="p">[</code><code class="s1">'pl'</code><code class="p">])</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">pl</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pl</code><code class="p">)</code>
        <code class="n">cpl</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">pl</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{time} | *** GOING {side} ({self.trades}) ***'</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{time} | PROFIT/LOSS={pl:.2f} | CUMULATIVE={cpl:.2f}'</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
            <code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code>
            <code class="k">print</code><code class="p">(</code><code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>
    <code class="k">def</code> <code class="nf">on_success</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">time</code><code class="p">,</code> <code class="n">bid</code><code class="p">,</code> <code class="n">ask</code><code class="p">):</code>
        <code class="sd">''' Contains the main trading logic.</code>
<code class="sd">        '''</code>
        <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'ask'</code><code class="p">:</code> <code class="n">ask</code><code class="p">,</code> <code class="s1">'bid'</code><code class="p">:</code> <code class="n">bid</code><code class="p">,</code> <code class="s1">'mid'</code><code class="p">:</code> <code class="p">(</code><code class="n">bid</code> <code class="o">+</code> <code class="n">ask</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code><code class="p">},</code>
                          <code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">pd</code><code class="o">.</code><code class="n">Timestamp</code><code class="p">(</code><code class="n">time</code><code class="p">)])</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tick_data</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">df</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">_resample_data</code><code class="p">()</code>
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code> <code class="o">+=</code> <code class="mi">1</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">_prepare_data</code><code class="p">()</code>
            <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">_get_state</code><code class="p">()</code>
            <code class="n">prediction</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">state</code><code class="p">)[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
            <code class="n">position</code> <code class="o">=</code> <code class="mi">1</code> <code class="k">if</code> <code class="n">prediction</code> <code class="o">==</code> <code class="mi">1</code> <code class="k">else</code> <code class="o">-</code><code class="mi">1</code>
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
                <code class="n">order</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>
                        <code class="n">units</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>
                        <code class="n">sl_distance</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">sl_distance</code><code class="p">,</code>
                        <code class="n">tsl_distance</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl_distance</code><code class="p">,</code>
                        <code class="n">tp_price</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">tp_price</code><code class="p">,</code>
                        <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">time</code><code class="p">,</code> <code class="s1">'LONG'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>
                <code class="n">order</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>
                        <code class="n">units</code><code class="o">=-</code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>
                        <code class="n">sl_distance</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">sl_distance</code><code class="p">,</code>
                        <code class="n">tsl_distance</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl_distance</code><code class="p">,</code>
                        <code class="n">tp_price</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">tp_price</code><code class="p">,</code>
                        <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">time</code><code class="p">,</code> <code class="s1">'SHORT'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>


<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>
    <code class="n">agent</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="nb">open</code><code class="p">(</code><code class="s1">'trading.bot'</code><code class="p">,</code> <code class="s1">'rb'</code><code class="p">))</code>
    <code class="n">otb</code> <code class="o">=</code> <code class="n">OandaTradingBot</code><code class="p">(</code><code class="s1">'../aiif.cfg'</code><code class="p">,</code> <code class="n">agent</code><code class="p">,</code> <code class="s1">'5s'</code><code class="p">,</code>
                          <code class="mi">25000</code><code class="p">,</code> <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
    <code class="n">otb</code><code class="o">.</code><code class="n">stream_data</code><code class="p">(</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code> <code class="n">stop</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code>
    <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>
    <code class="k">print</code><code class="p">(</code><code class="s1">'*** CLOSING OUT ***'</code><code class="p">)</code>
    <code class="n">order</code> <code class="o">=</code> <code class="n">otb</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="n">otb</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>
                    <code class="n">units</code><code class="o">=-</code><code class="n">otb</code><code class="o">.</code><code class="n">position</code> <code class="o">*</code> <code class="n">otb</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>
                    <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
    <code class="n">otb</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="n">otb</code><code class="o">.</code><code class="n">time</code><code class="p">,</code> <code class="s1">'NEUTRAL'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">otb</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
        <code class="n">pprint</code><code class="p">(</code><code class="n">order</code><code class="p">)</code>
    <code class="k">print</code><code class="p">(</code><code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code></pre>
</div></section>





</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45625242073656"><sup><a href="ch12.xhtml#idm45625242073656-marker">1</a></sup> This little trick leads more quickly to trades in this particular context given the data used. For real deployment, the statistics from the learning environment data are to be used for the normalization.</p></div></div></section></div>



  </body></html>