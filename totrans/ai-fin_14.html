<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Vectorized Backtesting"><div class="chapter" id="vectorized_backtesting">
<h1><span class="label">Chapter 10. </span>Vectorized Backtesting</h1>

<blockquote>
<p>Tesla’s chief executive and serial technology entrepreneur, Elon Musk, has said his company’s cars will be able to be summoned and drive autonomously across the US to pick up their owners within the next two years.</p>
<p data-type="attribution">Samuel Gibbs (2016)</p>
</blockquote>
<blockquote>
<p class="align_me_right">Big money is made in the stock market by being on the right side of the major moves.</p>
<p data-type="attribution">Martin Zweig</p>
</blockquote>

<p><a data-type="indexterm" data-primary="vectorized backtesting" id="ix_vector_backtest_ch10"/>The term <em>vectorized backtesting</em> refers to a technical approach to backtesting algorithmic trading strategies, such as those based on a dense neural network (DNN) for market prediction. The books by Hilpisch (2018, ch. 15; 2020, ch. 4) cover vectorized backtesting based on a number of concrete examples. <em>Vectorized</em> in this context refers to a programming paradigm that relies heavily or even exclusively on vectorized code (that is, code without any looping on the Python level). Vectorization of code is good practice with such packages such as <code>Numpy</code> or 
<span class="keep-together"><code>pandas</code></span> in general and has been used intensively in previous chapters as well. The benefits of vectorized code are more concise and easy-to-read code, as well as faster execution in many important scenarios. On the other hand, it might not be as flexible in backtesting trading strategies as, for example, event-based backtesting, which is introduced and used in <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a>.</p>

<p><a data-type="indexterm" data-primary="returns" data-secondary="alpha (above-market returns)" id="idm45625275092424"/><a data-type="indexterm" data-primary="alpha (above-market returns)" id="idm45625275091480"/>Having a good AI-powered predictor available that beats a simple baseline predictor is important but is generally not enough to generate <em>alpha</em> (that is, above-market returns, possibly adjusted for risk). For example, it is also important for a prediction-based trading strategy to predict the large market movements correctly and not just the majority of the (potentially pretty small) market movements. Vectorized backtesting is an easy and fast way of figuring out the economic potential of a trading 
<span class="keep-together">strategy.</span></p>

<p>Compared to autonomous vehicles (AVs), vectorized backtesting is like testing the AI of AVs in virtual environments just to see how it performs “in general” in a risk-free environment. However, for the AI of an AV it is not only important to perform well <em>on average</em>, but it is also of paramount importance to see how it masters critical or even extreme situations. Such an AI is supposed to cause “zero casualties” on average, not 0.1 or 0.5. For a financial AI, it is similarly—even if not equally—important to get the large market movements correct. Whereas this chapter focuses on the pure performance of financial AI agents (trading bots), <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a> goes deeper into risk assessment and the backtesting of standard risk measures.</p>

<p><a data-type="xref" href="#vb_sma_eod_exmple">“Backtesting an SMA-Based Strategy”</a> introduces vectorized backtesting based on a simple example using simple moving averages as technical indicators and end-of-day (EOD) data. This allows for insightful visualizations and an easier understanding of the approach when getting started. <a data-type="xref" href="#vb_dnn_eod_example">“Backtesting a Daily DNN-Based Strategy”</a> trains a DNN based on EOD data and backtests the resulting prediction-based strategy for its economic performance. <a data-type="xref" href="#vb_dnn_id_example">“Backtesting an Intraday DNN-Based Strategy”</a> then does the same with intraday data. In all examples, proportional transaction costs are included in the form of assumed bid-ask spreads.</p>






<section data-type="sect1" data-pdf-bookmark="Backtesting an SMA-Based Strategy"><div class="sect1" id="vb_sma_eod_exmple">
<h1>Backtesting an SMA-Based Strategy</h1>

<p><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="SMA-based" id="ix_vector_backtest_SMA"/><a data-type="indexterm" data-primary="SMA (simple moving average)" id="ix_SMA_ch10"/>This section introduces vectorized backtesting based on a classical trading strategy that uses simple moving averages (SMAs) as technical indicators. The following code realizes the necessary imports and configurations and retrieves EOD data for the EUR/USD currency pair:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">os</code><code>
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">math</code><code>
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>
</code><code>        </code><code class="kn">from</code><code> </code><code class="nn">pylab</code><code> </code><code class="kn">import</code><code> </code><code class="n">plt</code><code class="p">,</code><code> </code><code class="n">mpl</code><code>
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'</code><code class="s1">seaborn</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'</code><code class="s1">savefig.dpi</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">300</code><code>
</code><code>        </code><code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'</code><code class="s1">font.family</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">serif</code><code class="s1">'</code><code>
</code><code>        </code><code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'</code><code class="s1">mode.chained_assignment</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="bp">None</code><code class="p">)</code><code>
</code><code>        </code><code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'</code><code class="s1">display.float_format</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">{:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">)</code><code>
</code><code>        </code><code class="n">np</code><code class="o">.</code><code class="n">set_printoptions</code><code class="p">(</code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">precision</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code>
</code><code>        </code><code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s1">'</code><code class="s1">PYTHONHASHSEED</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">0</code><code class="s1">'</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">url</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">http://hilpisch.com/aiif_eikon_eod_data.csv</code><code class="s1">'</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO1-1" href="#callout_vectorized_backtesting_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO1-2" href="#callout_vectorized_backtesting_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                                        </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO1-3" href="#callout_vectorized_backtesting_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO1-4" href="#callout_vectorized_backtesting_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>        </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">2516</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="n">to</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>
</code><code>        </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">1</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>
</code><code>         </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>
</code><code>        </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="mi">0</code><code>   </code><code class="n">EUR</code><code class="o">=</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>
</code><code>        </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>        </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">39.3</code><code> </code><code class="n">KB</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO1-1" href="#co_vectorized_backtesting_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Retrieves EOD data for EUR/USD</p></dd>
</dl>

<p>The idea of the strategy is the following. Calculate a shorter <code>SMA1</code>, say for 42 days, 
<span class="keep-together">and a longer</span> <code>SMA2</code>, say for 258 days. Whenever <code>SMA1</code> is above <code>SMA2</code>, go long on the financial instrument. Whenever <code>SMA1</code> is below <code>SMA2</code>, go short on the financial instrument. Because the example is based on EUR/USD, going long or short is easily 
<span class="keep-together">accomplished.</span></p>

<p>The following Python code calculates in vectorized fashion the SMA values and visualizes the resulting time series alongside the original time series (see <a data-type="xref" href="#figure_vb_01">Figure 10-1</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO2-1" href="#callout_vectorized_backtesting_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">258</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO2-2" href="#callout_vectorized_backtesting_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO2-3" href="#callout_vectorized_backtesting_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO2-1" href="#co_vectorized_backtesting_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Calculates the shorter <code>SMA1</code></p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO2-2" href="#co_vectorized_backtesting_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Calculates the longer <code>SMA2</code></p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO2-3" href="#co_vectorized_backtesting_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Visualizes the three time series</p></dd>
</dl>

<p>Equipped with the SMA time series data, the resulting positions can, again in vectorized fashion, be derived. Note the shift of the resulting position time series by one day to avoid foresight bias in the data. This shift is necessary since the calculation of the SMAs includes the closing values from the same day. Therefore, the position derived from the SMA values from one day needs to be applied to the next day for the whole time series.</p>

<figure class="thumb"><div id="figure_vb_01" class="figure">
<img src="Images/aiif_1001.png" alt="aiif 1001" width="2415" height="1397"/>
<h6><span class="label">Figure 10-1. </span>Time series data for EUR/USD and SMAs</h6>
</div></figure>

<p><a data-type="xref" href="#figure_vb_02">Figure 10-2</a> visualizes the resulting positions as an overlay to the other time series:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO3-1" href="#callout_vectorized_backtesting_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO3-2" href="#callout_vectorized_backtesting_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO3-3" href="#callout_vectorized_backtesting_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO3-4" href="#callout_vectorized_backtesting_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">secondary_y</code><code class="o">=</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO3-5" href="#callout_vectorized_backtesting_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO3-1" href="#co_vectorized_backtesting_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Deletes rows containing <code>NaN</code> values</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO3-2" href="#co_vectorized_backtesting_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Derives the position values based on same-day SMA values</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO3-3" href="#co_vectorized_backtesting_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Shifts the position values by one day to avoid foresight bias</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO3-4" href="#co_vectorized_backtesting_CO3-5"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Visualizes the position values as derived from the SMAs</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_02" class="figure">
<img src="Images/aiif_1002.png" alt="aiif 1002" width="2569" height="1397"/>
<h6><span class="label">Figure 10-2. </span>Time series data for EUR/USD, SMAs, and resulting positions</h6>
</div></figure>

<p>One crucial step is missing: the combination of the positions with the returns of the financial instrument. Since positions are conveniently represented by a <code>+1</code> for a long position and a <code>-1</code> for a short position, this step boils down to multiplying two columns of the <code>DataFrame</code> object—in vectorized fashion again. The SMA-based trading strategy outperforms the passive benchmark investment by a considerable margin, as <a data-type="xref" href="#figure_vb_03">Figure 10-3</a> illustrates:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO4-1" href="#callout_vectorized_backtesting_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO4-2" href="#callout_vectorized_backtesting_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO4-3" href="#callout_vectorized_backtesting_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="mf">0.8640</code><code>
</code><code>         </code><code class="n">s</code><code>   </code><code class="mf">1.3773</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO4-4" href="#callout_vectorized_backtesting_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="o">-</code><code class="mf">0.1360</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.3773</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO4-5" href="#callout_vectorized_backtesting_CO4-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO4-1" href="#co_vectorized_backtesting_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Calculates the log returns</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO4-2" href="#co_vectorized_backtesting_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Calculates the strategy returns</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO4-3" href="#co_vectorized_backtesting_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Calculates the gross performances</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO4-4" href="#co_vectorized_backtesting_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Calculates the net performances</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO4-5" href="#co_vectorized_backtesting_CO4-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Visualizes the gross performances over time</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_03" class="figure">
<img src="Images/aiif_1003.png" alt="aiif 1003" width="2418" height="1394"/>
<h6><span class="label">Figure 10-3. </span>Gross performance of passive benchmark investment and SMA strategy</h6>
</div></figure>

<p>So far, the performance figures are not considering transaction costs. These are, of course, a crucial element when judging the economic potential of a trading strategy. In the current setup, proportional transaction costs can be easily included in the calculations. The idea is to determine when a trade takes place and to reduce the performance of the trading strategy by a certain value to account for the relevant bid-ask spread. As the following calculations show, and as is obvious from <a data-type="xref" href="#figure_vb_02">Figure 10-2</a>, the trading strategy does not change positions too often. Therefore, in order to have some meaningful effects of transaction costs, they are assumed to be quite a bit higher than typically seen for EUR/USD. The net effect of subtracting transaction costs is a few percentage points under the given assumptions (see <a data-type="xref" href="#figure_vb_04">Figure 10-4</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-1" href="#callout_vectorized_backtesting_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pc</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.005</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-2" href="#callout_vectorized_backtesting_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                               </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">pc</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-3" href="#callout_vectorized_backtesting_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-4" href="#callout_vectorized_backtesting_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-5" href="#callout_vectorized_backtesting_CO5-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="p">[</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO5-6" href="#callout_vectorized_backtesting_CO5-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code>                  </code><code class="n">r</code><code>       </code><code class="n">s</code><code>      </code><code class="n">s_</code><code>
</code><code>         </code><code class="n">Date</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code>  </code><code class="mf">0.0123</code><code>  </code><code class="mf">0.0123</code><code>  </code><code class="mf">0.0023</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mi">10</code><code class="o">-</code><code class="mi">10</code><code>  </code><code class="mf">0.0198</code><code> </code><code class="o">-</code><code class="mf">0.0198</code><code> </code><code class="o">-</code><code class="mf">0.0248</code><code>
</code><code>         </code><code class="mi">2012</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mo">07</code><code> </code><code class="o">-</code><code class="mf">0.0034</code><code> </code><code class="o">-</code><code class="mf">0.0034</code><code> </code><code class="o">-</code><code class="mf">0.0084</code><code>
</code><code>         </code><code class="mi">2014</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mi">24</code><code> </code><code class="o">-</code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0001</code><code> </code><code class="o">-</code><code class="mf">0.0049</code><code>
</code><code>         </code><code class="mi">2016</code><code class="o">-</code><code class="mo">03</code><code class="o">-</code><code class="mi">16</code><code>  </code><code class="mf">0.0102</code><code>  </code><code class="mf">0.0102</code><code>  </code><code class="mf">0.0052</code><code>
</code><code>         </code><code class="mi">2016</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">10</code><code> </code><code class="o">-</code><code class="mf">0.0018</code><code>  </code><code class="mf">0.0018</code><code> </code><code class="o">-</code><code class="mf">0.0032</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="o">-</code><code class="mf">0.0025</code><code> </code><code class="o">-</code><code class="mf">0.0025</code><code> </code><code class="o">-</code><code class="mf">0.0075</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">15</code><code>  </code><code class="mf">0.0035</code><code> </code><code class="o">-</code><code class="mf">0.0035</code><code> </code><code class="o">-</code><code class="mf">0.0085</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="mf">0.8640</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">1.3773</code><code>
</code><code>         </code><code class="n">s_</code><code>   </code><code class="mf">1.3102</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="o">-</code><code class="mf">0.1360</code><code>
</code><code>         </code><code class="n">s</code><code>     </code><code class="mf">0.3773</code><code>
</code><code>         </code><code class="n">s_</code><code>    </code><code class="mf">0.3102</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO5-1" href="#co_vectorized_backtesting_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Calculates the number of trades, including entry and exit trade</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO5-2" href="#co_vectorized_backtesting_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Fixes the proportional transaction costs (deliberately set quite high)</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO5-3" href="#co_vectorized_backtesting_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Adjusts the strategy performance for the transaction costs</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO5-4" href="#co_vectorized_backtesting_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Adjusts the strategy performance for the <em>entry</em> trade</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO5-5" href="#co_vectorized_backtesting_CO5-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Adjusts the strategy performance for the <em>exit</em> trade</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO5-6" href="#co_vectorized_backtesting_CO5-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Shows the adjusted performance values for the regular trades</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_04" class="figure">
<img src="Images/aiif_1004.png" alt="aiif 1004" width="2418" height="1394"/>
<h6><span class="label">Figure 10-4. </span>Gross performance of the SMA strategy before and after transaction costs</h6>
</div></figure>

<p>What about the resulting risk of the trading strategy? For a trading strategy that is based on directional predictions and that takes long or short positions only, the risk, expressed as the volatility (standard deviation of the log returns), is exactly the same as for the passive benchmark investment:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO6-1" href="#callout_vectorized_backtesting_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="mf">0.0054</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.0054</code><code>
</code><code>         </code><code class="n">s_</code><code>   </code><code class="mf">0.0054</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="mi">252</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO6-2" href="#callout_vectorized_backtesting_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="mf">0.0853</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.0853</code><code>
</code><code>         </code><code class="n">s_</code><code>   </code><code class="mf">0.0855</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO6-1" href="#co_vectorized_backtesting_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Daily volatility</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO6-2" href="#co_vectorized_backtesting_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Annualized volatility<a data-type="indexterm" data-primary="" data-startref="ix_SMA_ch10" id="idm45625273705688"/><a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_SMA" id="idm45625273704680"/></p></dd>
</dl>
<div data-type="note" epub:type="note"><h1>Vectorized Backtesting</h1>
<p>Vectorized backtesting is a powerful and efficient approach to backtesting the “pure” performance of a prediction-based trading strategy. <a data-type="indexterm" data-primary="transaction costs" data-secondary="vectorized backtesting" id="idm45625273702216"/><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="transaction costs" id="idm45625273701240"/>It can also accommodate proportional transaction costs, for instance. <a data-type="indexterm" data-primary="backtesting risk measures" data-seealso="event-based backtesting; vectorized backtesting" id="idm45625273700168"/>However, it is not well suited to including typical risk management measures, such as (trailing) stop loss orders or take profit orders. This is addressed in <a data-type="xref" href="ch11.xhtml#risk_management">Chapter 11</a>.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Backtesting a Daily DNN-Based Strategy"><div class="sect1" id="vb_dnn_eod_example">
<h1>Backtesting a Daily DNN-Based Strategy</h1>

<p><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="DNNs" id="ix_vector_backtest_DNN"/><a data-type="indexterm" data-primary="DNNs (dense neural networks)" data-secondary="vectorized backtesting" id="ix_DNNs_vector_backtest"/>The previous section lays out the blueprint for vectorized backtesting on the basis of a simple, easy-to-visualize trading strategy. The same blueprint can be applied, for example, to DNN-based trading strategies with minimal technical adjustments. The following trains a <code>Keras</code> DNN model, as discussed in <a data-type="xref" href="ch07.xhtml#dense_networks">Chapter 7</a>. The data that is used is the same as in the previous example. However, as in <a data-type="xref" href="ch07.xhtml#dense_networks">Chapter 7</a>, different features and lags thereof need to be added to the <code>DataFrame</code> object:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">31</code><code class="p">]:</code> <code class="n">data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                                         <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()[</code><code class="n">symbol</code><code class="p">])</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">32</code><code class="p">]:</code> <code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">()</code>
         <code class="o">&lt;</code><code class="k">class</code> <code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'&gt;</code>
         <code class="n">DatetimeIndex</code><code class="p">:</code> <code class="mi">2516</code> <code class="n">entries</code><code class="p">,</code> <code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code> <code class="n">to</code> <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code>
         <code class="n">Data</code> <code class="n">columns</code> <code class="p">(</code><code class="n">total</code> <code class="mi">1</code> <code class="n">columns</code><code class="p">):</code>
          <code class="c1">#   Column  Non-Null Count  Dtype</code>
         <code class="o">---</code>  <code class="o">------</code>  <code class="o">--------------</code>  <code class="o">-----</code>
          <code class="mi">0</code>   <code class="n">EUR</code><code class="o">=</code>    <code class="mi">2516</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="n">dtypes</code><code class="p">:</code> <code class="n">float64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="n">memory</code> <code class="n">usage</code><code class="p">:</code> <code class="mf">39.3</code> <code class="n">KB</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">33</code><code class="p">]:</code> <code class="n">lags</code> <code class="o">=</code> <code class="mi">5</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">34</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">add_lags</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">lags</code><code class="p">,</code> <code class="n">window</code><code class="o">=</code><code class="mi">20</code><code class="p">):</code>
             <code class="n">cols</code> <code class="o">=</code> <code class="p">[]</code>
             <code class="n">df</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>
             <code class="n">df</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">df</code> <code class="o">/</code> <code class="n">df</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'sma'</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'min'</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">min</code><code class="p">()</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'max'</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">max</code><code class="p">()</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'mom'</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'vol'</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>
             <code class="n">df</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
             <code class="n">df</code><code class="p">[</code><code class="s1">'d'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">df</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
             <code class="n">features</code> <code class="o">=</code> <code class="p">[</code><code class="n">symbol</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">,</code> <code class="s1">'sma'</code><code class="p">,</code> <code class="s1">'min'</code><code class="p">,</code> <code class="s1">'max'</code><code class="p">,</code> <code class="s1">'mom'</code><code class="p">,</code> <code class="s1">'vol'</code><code class="p">]</code>
             <code class="k">for</code> <code class="n">f</code> <code class="ow">in</code> <code class="n">features</code><code class="p">:</code>
                 <code class="k">for</code> <code class="n">lag</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">lags</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>
                     <code class="n">col</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'{f}_lag_{lag}'</code>
                     <code class="n">df</code><code class="p">[</code><code class="n">col</code><code class="p">]</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="n">f</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code>
                     <code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code>
             <code class="n">df</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
             <code class="k">return</code> <code class="n">df</code><code class="p">,</code> <code class="n">cols</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">35</code><code class="p">]:</code> <code class="n">data</code><code class="p">,</code> <code class="n">cols</code> <code class="o">=</code> <code class="n">add_lags</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">lags</code><code class="p">,</code> <code class="n">window</code><code class="o">=</code><code class="mi">20</code><code class="p">)</code></pre>
<div style="page-break-after: always;"/>

<p><a data-type="indexterm" data-primary="create_model() function" id="idm45625273466840"/><a data-type="indexterm" data-primary="set_seeds() function" id="idm45625273466232"/>The following Python code accomplishes additional imports and defines the <code>set_seeds()</code> and <code>create_model()</code> functions:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">random</code>
         <code class="kn">import</code> <code class="nn">tensorflow</code> <code class="kn">as</code> <code class="nn">tf</code>
         <code class="kn">from</code> <code class="nn">keras.layers</code> <code class="kn">import</code> <code class="n">Dense</code><code class="p">,</code> <code class="n">Dropout</code>
         <code class="kn">from</code> <code class="nn">keras.models</code> <code class="kn">import</code> <code class="n">Sequential</code>
         <code class="kn">from</code> <code class="nn">keras.regularizers</code> <code class="kn">import</code> <code class="n">l1</code>
         <code class="kn">from</code> <code class="nn">keras.optimizers</code> <code class="kn">import</code> <code class="n">Adam</code>
         <code class="kn">from</code> <code class="nn">sklearn.metrics</code> <code class="kn">import</code> <code class="n">accuracy_score</code>
         <code class="n">Using</code> <code class="n">TensorFlow</code> <code class="n">backend</code><code class="o">.</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">set_seeds</code><code class="p">(</code><code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">):</code>
             <code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
             <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
             <code class="n">tf</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">set_seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
         <code class="n">set_seeds</code><code class="p">()</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">38</code><code class="p">]:</code> <code class="n">optimizer</code> <code class="o">=</code> <code class="n">Adam</code><code class="p">(</code><code class="n">learning_rate</code><code class="o">=</code><code class="mf">0.0001</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">39</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">create_model</code><code class="p">(</code><code class="n">hl</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code> <code class="n">hu</code><code class="o">=</code><code class="mi">128</code><code class="p">,</code> <code class="n">dropout</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code> <code class="n">rate</code><code class="o">=</code><code class="mf">0.3</code><code class="p">,</code>
                         <code class="n">regularize</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code> <code class="n">reg</code><code class="o">=</code><code class="n">l1</code><code class="p">(</code><code class="mf">0.0005</code><code class="p">),</code>
                         <code class="n">optimizer</code><code class="o">=</code><code class="n">optimizer</code><code class="p">,</code> <code class="n">input_dim</code><code class="o">=</code><code class="nb">len</code><code class="p">(</code><code class="n">cols</code><code class="p">)):</code>
             <code class="k">if</code> <code class="ow">not</code> <code class="n">regularize</code><code class="p">:</code>
                 <code class="n">reg</code> <code class="o">=</code> <code class="bp">None</code>
             <code class="n">model</code> <code class="o">=</code> <code class="n">Sequential</code><code class="p">()</code>
             <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="n">hu</code><code class="p">,</code> <code class="n">input_dim</code><code class="o">=</code><code class="n">input_dim</code><code class="p">,</code>
                          <code class="n">activity_regularizer</code><code class="o">=</code><code class="n">reg</code><code class="p">,</code>
                          <code class="n">activation</code><code class="o">=</code><code class="s1">'relu'</code><code class="p">))</code>
             <code class="k">if</code> <code class="n">dropout</code><code class="p">:</code>
                 <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dropout</code><code class="p">(</code><code class="n">rate</code><code class="p">,</code> <code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">))</code>
             <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">hl</code><code class="p">):</code>
                 <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="n">hu</code><code class="p">,</code> <code class="n">activation</code><code class="o">=</code><code class="s1">'relu'</code><code class="p">,</code>
                              <code class="n">activity_regularizer</code><code class="o">=</code><code class="n">reg</code><code class="p">))</code>
                 <code class="k">if</code> <code class="n">dropout</code><code class="p">:</code>
                     <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dropout</code><code class="p">(</code><code class="n">rate</code><code class="p">,</code> <code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">))</code>
             <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">activation</code><code class="o">=</code><code class="s1">'sigmoid'</code><code class="p">))</code>
             <code class="n">model</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="n">loss</code><code class="o">=</code><code class="s1">'binary_crossentropy'</code><code class="p">,</code>
                           <code class="n">optimizer</code><code class="o">=</code><code class="n">optimizer</code><code class="p">,</code>
                           <code class="n">metrics</code><code class="o">=</code><code class="p">[</code><code class="s1">'accuracy'</code><code class="p">])</code>
             <code class="k">return</code> <code class="n">model</code></pre>

<p>Based on a sequential train-test split of the historical data, the following Python code first trains the DNN model based on normalized features data:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">split</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">2018-01-01</code><code class="s1">'</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-1" href="#callout_vectorized_backtesting_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="p">:</code><code class="n">split</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-2" href="#callout_vectorized_backtesting_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">bincount</code><code class="p">(</code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-3" href="#callout_vectorized_backtesting_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mi">982</code><code class="p">,</code><code> </code><code class="mi">1006</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code class="p">,</code><code> </code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">train</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">train</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-4" href="#callout_vectorized_backtesting_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">train</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-5" href="#callout_vectorized_backtesting_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">set_seeds</code><code class="p">(</code><code class="p">)</code><code>
</code><code>         </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">create_model</code><code class="p">(</code><code class="n">hl</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">hu</code><code class="o">=</code><code class="mi">64</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-6" href="#callout_vectorized_backtesting_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="o">%</code><code class="n">time</code><code>
</code><code>         </code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">epochs</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">validation_split</code><code class="o">=</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="n">shuffle</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-7" href="#callout_vectorized_backtesting_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mf">2.93</code><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mi">574</code><code> </code><code class="n">ms</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">3.5</code><code> </code><code class="n">s</code><code>
</code><code>         </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">1.93</code><code> </code><code class="n">s</code><code>
</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">&lt;</code><code class="n">keras</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">History</code><code> </code><code class="n">at</code><code> </code><code class="mh">0x7fc9392f38d0</code><code class="o">&gt;</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO7-8" href="#callout_vectorized_backtesting_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>         </code><code class="mi">1988</code><code class="o">/</code><code class="mi">1988</code><code> </code><code class="p">[</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="mi">0</code><code class="n">s</code><code> </code><code class="mi">17</code><code class="n">us</code><code class="o">/</code><code class="n">step</code><code>
</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">[</code><code class="mf">0.6745863538872549</code><code class="p">,</code><code> </code><code class="mf">0.5925553441047668</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO7-1" href="#co_vectorized_backtesting_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Splits the data into training and test data</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO7-2" href="#co_vectorized_backtesting_CO7-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Shows the frequency of the labels classes</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO7-3" href="#co_vectorized_backtesting_CO7-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Normalizes the training features data</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO7-4" href="#co_vectorized_backtesting_CO7-6"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Creates the DNN model</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO7-5" href="#co_vectorized_backtesting_CO7-7"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Trains the DNN model on the training data</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO7-6" href="#co_vectorized_backtesting_CO7-8"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Evaluates the performance of the model on the training data</p></dd>
</dl>

<p>So far, this basically repeats the core approach of <a data-type="xref" href="ch07.xhtml#dense_networks">Chapter 7</a>. Vectorized backtesting can now be applied to judge the economic performance of the DNN-based trading strategy <em>in-sample</em> based on the model’s predictions (see <a data-type="xref" href="#figure_vb_05">Figure 10-5</a>). In this context, an upward prediction is naturally interpreted as a long position and a downward prediction as a short position:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-1" href="#callout_vectorized_backtesting_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-2" href="#callout_vectorized_backtesting_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-3" href="#callout_vectorized_backtesting_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">-</code><code class="mi">1</code><code>    </code><code class="mi">1098</code><code>
</code><code>          </code><code class="mi">1</code><code>     </code><code class="mi">890</code><code>
</code><code>         </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">p</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-4" href="#callout_vectorized_backtesting_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-5" href="#callout_vectorized_backtesting_CO8-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="mf">0.8787</code><code>
</code><code>         </code><code class="n">s</code><code>   </code><code class="mf">5.0766</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><code class="o">-</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-6" href="#callout_vectorized_backtesting_CO8-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="o">-</code><code class="mf">0.1213</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">4.0766</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO8-7" href="#callout_vectorized_backtesting_CO8-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO8-1" href="#co_vectorized_backtesting_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Generates the binary predictions</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO8-2" href="#co_vectorized_backtesting_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Translates the predictions into position values</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO8-3" href="#co_vectorized_backtesting_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Shows the number of long and short positions</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO8-4" href="#co_vectorized_backtesting_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Calculates the strategy performance values</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO8-5" href="#co_vectorized_backtesting_CO8-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Calculates the gross and net performances (in-sample)</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO8-6" href="#co_vectorized_backtesting_CO8-7"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Visualizes the gross performances over time (in-sample)</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_05" class="figure">
<img src="Images/aiif_1005.png" alt="aiif 1005" width="2379" height="1394"/>
<h6><span class="label">Figure 10-5. </span>Gross performance of the passive benchmark investment and the daily DNN strategy (in-sample)</h6>
</div></figure>
<div style="page-break-after: always;"/>

<p>Next is the same sequence of calculations for the test data set. Whereas the 
<span class="keep-together">out-performance</span> in-sample is significant, the numbers out-of-sample are not as impressive but are still convincing (see <a data-type="xref" href="#figure_vb_06">Figure 10-6</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">split</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO9-1" href="#callout_vectorized_backtesting_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">test</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO9-2" href="#callout_vectorized_backtesting_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">test_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">d</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO9-3" href="#callout_vectorized_backtesting_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>         </code><code class="mi">503</code><code class="o">/</code><code class="mi">503</code><code> </code><code class="p">[</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="mi">0</code><code class="n">s</code><code> </code><code class="mi">17</code><code class="n">us</code><code class="o">/</code><code class="n">step</code><code>
</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">[</code><code class="mf">0.6933823573897421</code><code class="p">,</code><code> </code><code class="mf">0.5407554507255554</code><code class="p">]</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">test_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">-</code><code class="mi">1</code><code>    </code><code class="mi">406</code><code>
</code><code>          </code><code class="mi">1</code><code>     </code><code class="mi">97</code><code>
</code><code>         </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">p</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="mf">0.9345</code><code>
</code><code>         </code><code class="n">s</code><code>   </code><code class="mf">1.2431</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="o">-</code><code class="mf">0.0655</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.2431</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO9-1" href="#co_vectorized_backtesting_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Generates the test data sub-set</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO9-2" href="#co_vectorized_backtesting_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Normalizes the test data</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO9-3" href="#co_vectorized_backtesting_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Evaluates the model performance on the test data</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="SMA (simple moving average)" id="idm45625271709416"/>The DNN-based trading strategy leads to a larger number of trades as compared to the SMA-based strategy. This makes the inclusion of transaction costs an even more important aspect when judging the economic performance.</p>

<figure class="thumb"><div id="figure_vb_06" class="figure">
<img src="Images/aiif_1006.png" alt="aiif 1006" width="2444" height="1428"/>
<h6><span class="label">Figure 10-6. </span>Gross performance of the passive benchmark investment and the daily DNN strategy (out-of-sample)</h6>
</div></figure>

<p>The following code assumes now realistic bid-ask spreads for EUR/USD on the level of 1.2 pips (that is, 0.00012 in terms of currency units).<sup><a data-type="noteref" id="idm45625271705592-marker" href="ch10.xhtml#idm45625271705592">1</a></sup> To simplify the calculations, an average value for the proportional transaction costs <code>pc</code> is calculated based on the average closing price for EUR/USD (see <a data-type="xref" href="#figure_vb_07">Figure 10-7</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">147</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.00012</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO10-1" href="#callout_vectorized_backtesting_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">pc</code><code> </code><code class="o">=</code><code> </code><code class="n">spread</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO10-2" href="#callout_vectorized_backtesting_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{pc:.6f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>         </code><code class="mf">0.000098</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                               </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">pc</code><code class="p">,</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="mf">0.9345</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">1.2431</code><code>
</code><code>         </code><code class="n">s_</code><code>   </code><code class="mf">1.2252</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>    </code><code class="o">-</code><code class="mf">0.0655</code><code>
</code><code>         </code><code class="n">s</code><code>     </code><code class="mf">0.2431</code><code>
</code><code>         </code><code class="n">s_</code><code>    </code><code class="mf">0.2252</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO10-1" href="#co_vectorized_backtesting_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Fixes the average bid-ask spread</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO10-2" href="#co_vectorized_backtesting_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Calculates the average proportional transaction costs</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_07" class="figure">
<img src="Images/aiif_1007.png" alt="aiif 1007" width="2444" height="1428"/>
<h6><span class="label">Figure 10-7. </span>Gross performance of the daily DNN strategy before and after transaction costs (out-of-sample)</h6>
</div></figure>

<p>The DNN-based trading strategy seems promising both before and after typical transaction costs. However, would a similar strategy be economically viable intraday as well, when even more trades are observed? The next section analyzes a DNN-based intraday strategy.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Backtesting an Intraday DNN-Based Strategy"><div class="sect1" id="vb_dnn_id_example">
<h1>Backtesting an Intraday DNN-Based Strategy</h1>

<p><a data-type="indexterm" data-primary="intraday trading" id="ix_intraday_trade_ch10"/>To train and backtest a DNN model on intraday data, another data set is required:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">url</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">http://hilpisch.com/aiif_eikon_id_eur_usd.csv</code><code class="s1">'</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO11-1" href="#callout_vectorized_backtesting_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO11-2" href="#callout_vectorized_backtesting_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                             </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="s1">'</code><code class="s1">CLOSE</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO11-3" href="#callout_vectorized_backtesting_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="n">data</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="s1">'</code><code class="s1">5min</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">right</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">ffill</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO11-4" href="#callout_vectorized_backtesting_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO11-5" href="#callout_vectorized_backtesting_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">26486</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">10</code><code class="o">-</code><code class="mo">01</code><code> </code><code class="mo">00</code><code class="p">:</code><code class="mo">05</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="mi">23</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code><code>
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="mi">5</code><code class="n">T</code><code>
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">1</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>
</code><code>          </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">EUR</code><code class="o">=</code><code>    </code><code class="mi">26486</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>  </code><code class="n">float64</code><code>
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">413.8</code><code> </code><code class="n">KB</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">5</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="n">add_lags</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="p">,</code><code> </code><code class="n">window</code><code class="o">=</code><code class="mi">20</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO11-1" href="#co_vectorized_backtesting_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Retrieves intraday data for EUR/USD and picks the closing prices</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO11-2" href="#co_vectorized_backtesting_CO11-4"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Resamples the data to five-minute bars</p></dd>
</dl>

<p>The procedure of the previous section can now be repeated with the new data set. First, train the DNN model:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">79</code><code class="p">]:</code> <code class="n">split</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code> <code class="o">*</code> <code class="mf">0.85</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">80</code><code class="p">]:</code> <code class="n">train</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="n">split</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">81</code><code class="p">]:</code> <code class="n">np</code><code class="o">.</code><code class="n">bincount</code><code class="p">(</code><code class="n">train</code><code class="p">[</code><code class="s1">'d'</code><code class="p">])</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">81</code><code class="p">]:</code> <code class="n">array</code><code class="p">([</code><code class="mi">16284</code><code class="p">,</code>  <code class="mi">6207</code><code class="p">])</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">82</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">cw</code><code class="p">(</code><code class="n">df</code><code class="p">):</code>
             <code class="n">c0</code><code class="p">,</code> <code class="n">c1</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">bincount</code><code class="p">(</code><code class="n">df</code><code class="p">[</code><code class="s1">'d'</code><code class="p">])</code>
             <code class="n">w0</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1</code> <code class="o">/</code> <code class="n">c0</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">df</code><code class="p">))</code> <code class="o">/</code> <code class="mi">2</code>
             <code class="n">w1</code> <code class="o">=</code> <code class="p">(</code><code class="mi">1</code> <code class="o">/</code> <code class="n">c1</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">df</code><code class="p">))</code> <code class="o">/</code> <code class="mi">2</code>
             <code class="k">return</code> <code class="p">{</code><code class="mi">0</code><code class="p">:</code> <code class="n">w0</code><code class="p">,</code> <code class="mi">1</code><code class="p">:</code> <code class="n">w1</code><code class="p">}</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">83</code><code class="p">]:</code> <code class="n">mu</code><code class="p">,</code> <code class="n">std</code> <code class="o">=</code> <code class="n">train</code><code class="o">.</code><code class="n">mean</code><code class="p">(),</code> <code class="n">train</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">84</code><code class="p">]:</code> <code class="n">train_</code> <code class="o">=</code> <code class="p">(</code><code class="n">train</code> <code class="o">-</code> <code class="n">mu</code><code class="p">)</code> <code class="o">/</code> <code class="n">std</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">85</code><code class="p">]:</code> <code class="n">set_seeds</code><code class="p">()</code>
         <code class="n">model</code> <code class="o">=</code> <code class="n">create_model</code><code class="p">(</code><code class="n">hl</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">hu</code><code class="o">=</code><code class="mi">128</code><code class="p">,</code>
                              <code class="n">reg</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">dropout</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">86</code><code class="p">]:</code> <code class="o">%%</code><code class="n">time</code>
         <code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">train</code><code class="p">[</code><code class="s1">'d'</code><code class="p">],</code>
                   <code class="n">epochs</code><code class="o">=</code><code class="mi">40</code><code class="p">,</code> <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code>
                   <code class="n">validation_split</code><code class="o">=</code><code class="mf">0.2</code><code class="p">,</code> <code class="n">shuffle</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code>
                   <code class="n">class_weight</code><code class="o">=</code><code class="n">cw</code><code class="p">(</code><code class="n">train</code><code class="p">))</code>
         <code class="n">CPU</code> <code class="n">times</code><code class="p">:</code> <code class="n">user</code> <code class="mf">40.6</code> <code class="n">s</code><code class="p">,</code> <code class="n">sys</code><code class="p">:</code> <code class="mf">5.49</code> <code class="n">s</code><code class="p">,</code> <code class="n">total</code><code class="p">:</code> <code class="mi">46</code> <code class="n">s</code>
         <code class="n">Wall</code> <code class="n">time</code><code class="p">:</code> <code class="mf">25.2</code> <code class="n">s</code>

<code class="n">Out</code><code class="p">[</code><code class="mi">86</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">keras</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">History</code> <code class="n">at</code> <code class="mh">0x7fc91a6b2a90</code><code class="o">&gt;</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">87</code><code class="p">]:</code> <code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">train</code><code class="p">[</code><code class="s1">'d'</code><code class="p">])</code>
         <code class="mi">22491</code><code class="o">/</code><code class="mi">22491</code> <code class="p">[</code><code class="o">==============================</code><code class="p">]</code> <code class="o">-</code> <code class="mi">0</code><code class="n">s</code> <code class="mi">13</code><code class="n">us</code><code class="o">/</code><code class="n">step</code>

<code class="n">Out</code><code class="p">[</code><code class="mi">87</code><code class="p">]:</code> <code class="p">[</code><code class="mf">0.5218664327576152</code><code class="p">,</code> <code class="mf">0.6729803085327148</code><code class="p">]</code></pre>

<p>In-sample, the performance looks promising, as illustrated in <a data-type="xref" href="#figure_vb_08">Figure 10-8</a>:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">88</code><code class="p">]:</code> <code class="n">train</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">89</code><code class="p">]:</code> <code class="n">train</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">89</code><code class="p">]:</code> <code class="o">-</code><code class="mi">1</code>    <code class="mi">11519</code>
          <code class="mi">1</code>    <code class="mi">10972</code>
         <code class="n">Name</code><code class="p">:</code> <code class="n">p</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">int64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">90</code><code class="p">]:</code> <code class="n">train</code><code class="p">[</code><code class="s1">'s'</code><code class="p">]</code> <code class="o">=</code> <code class="n">train</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">*</code> <code class="n">train</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">91</code><code class="p">]:</code> <code class="n">train</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">91</code><code class="p">]:</code> <code class="n">r</code>   <code class="mf">1.0223</code>
         <code class="n">s</code>   <code class="mf">1.6665</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">92</code><code class="p">]:</code> <code class="n">train</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code> <code class="o">-</code> <code class="mi">1</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">92</code><code class="p">]:</code> <code class="n">r</code>   <code class="mf">0.0223</code>
         <code class="n">s</code>   <code class="mf">0.6665</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">93</code><code class="p">]:</code> <code class="n">train</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>

<figure class="thumb"><div id="figure_vb_08" class="figure">
<img src="Images/aiif_1008.png" alt="aiif 1008" width="2415" height="1570"/>
<h6><span class="label">Figure 10-8. </span>Gross performance of the passive benchmark investment and the DNN intraday strategy (in-sample)</h6>
</div></figure>

<p>Out-of-sample, the performance also looks promising before transaction costs. The strategy seems to systematically outperform the passive benchmark investment (see <a data-type="xref" href="#figure_vb_09">Figure 10-9</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">94</code><code class="p">]:</code> <code class="n">test</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">split</code><code class="p">:]</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">95</code><code class="p">]:</code> <code class="n">test_</code> <code class="o">=</code> <code class="p">(</code><code class="n">test</code> <code class="o">-</code> <code class="n">mu</code><code class="p">)</code> <code class="o">/</code> <code class="n">std</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">96</code><code class="p">]:</code> <code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">test_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">test</code><code class="p">[</code><code class="s1">'d'</code><code class="p">])</code>
         <code class="mi">3970</code><code class="o">/</code><code class="mi">3970</code> <code class="p">[</code><code class="o">==============================</code><code class="p">]</code> <code class="o">-</code> <code class="mi">0</code><code class="n">s</code> <code class="mi">19</code><code class="n">us</code><code class="o">/</code><code class="n">step</code>

<code class="n">Out</code><code class="p">[</code><code class="mi">96</code><code class="p">]:</code> <code class="p">[</code><code class="mf">0.5226116042706168</code><code class="p">,</code> <code class="mf">0.668513834476471</code><code class="p">]</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">97</code><code class="p">]:</code> <code class="n">test</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">test_</code><code class="p">[</code><code class="n">cols</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">98</code><code class="p">]:</code> <code class="n">test</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">98</code><code class="p">]:</code> <code class="o">-</code><code class="mi">1</code>    <code class="mi">2273</code>
          <code class="mi">1</code>    <code class="mi">1697</code>
         <code class="n">Name</code><code class="p">:</code> <code class="n">p</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">int64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">99</code><code class="p">]:</code> <code class="n">test</code><code class="p">[</code><code class="s1">'s'</code><code class="p">]</code> <code class="o">=</code> <code class="n">test</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code> <code class="o">*</code> <code class="n">test</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">100</code><code class="p">]:</code> <code class="n">test</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">100</code><code class="p">]:</code> <code class="n">r</code>   <code class="mf">1.0071</code>
          <code class="n">s</code>   <code class="mf">1.0658</code>
          <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">101</code><code class="p">]:</code> <code class="n">test</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code> <code class="o">-</code> <code class="mi">1</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">101</code><code class="p">]:</code> <code class="n">r</code>   <code class="mf">0.0071</code>
          <code class="n">s</code>   <code class="mf">0.0658</code>
          <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">102</code><code class="p">]:</code> <code class="n">test</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>

<p><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="transaction costs" id="ix_vector_backtest_trans_cost"/><a data-type="indexterm" data-primary="transaction costs" data-secondary="vectorized backtesting" id="ix_trans_cost_vector_backtest"/>The final litmus test with regard to pure economic performance comes when adding transaction costs. The strategy leads to hundreds of trades over a relatively short period of time. As the following analysis suggests, based on standard retail bid-ask spreads, the DNN-based strategy is not viable.</p>

<figure class="thumb"><div id="figure_vb_09" class="figure">
<img src="Images/aiif_1009.png" alt="aiif 1009" width="2442" height="1559"/>
<h6><span class="label">Figure 10-9. </span>Gross performance of the passive benchmark investment and the DNN intraday strategy (out-of-sample)</h6>
</div></figure>

<p>Reducing the spread to a level that professional, high-volume traders might achieve, the strategy still does not break even but rather loses a large proportion of the profits to the transaction costs (see <a data-type="xref" href="#figure_vb_10">Figure 10-10</a>):</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">1303</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">104</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.00012</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-1" href="#callout_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">pc_1</code><code> </code><code class="o">=</code><code> </code><code class="n">spread</code><code> </code><code class="o">/</code><code> </code><code class="n">test</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-2" href="#callout_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">105</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.00006</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-3" href="#callout_vectorized_backtesting_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">pc_2</code><code> </code><code class="o">=</code><code> </code><code class="n">spread</code><code> </code><code class="o">/</code><code> </code><code class="n">test</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-4" href="#callout_vectorized_backtesting_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">106</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">pc_1</code><code class="p">,</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-5" href="#callout_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">107</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc_1</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-6" href="#callout_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc_1</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-7" href="#callout_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">108</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">pc_2</code><code class="p">,</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-8" href="#callout_vectorized_backtesting_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">109</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc_2</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-9" href="#callout_vectorized_backtesting_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">pc_2</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" id="co_vectorized_backtesting_CO12-10" href="#callout_vectorized_backtesting_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">110</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">110</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>     </code><code class="mf">1.0071</code><code>
</code><code>          </code><code class="n">s</code><code>     </code><code class="mf">1.0658</code><code>
</code><code>          </code><code class="n">s_1</code><code>   </code><code class="mf">0.9259</code><code>
</code><code>          </code><code class="n">s_2</code><code>   </code><code class="mf">0.9934</code><code>
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">111</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">111</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>      </code><code class="mf">0.0071</code><code>
</code><code>          </code><code class="n">s</code><code>      </code><code class="mf">0.0658</code><code>
</code><code>          </code><code class="n">s_1</code><code>   </code><code class="o">-</code><code class="mf">0.0741</code><code>
</code><code>          </code><code class="n">s_2</code><code>   </code><code class="o">-</code><code class="mf">0.0066</code><code>
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">112</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s_2</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code>
</code><code>              </code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">style</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_vectorized_backtesting_CO12-1" href="#co_vectorized_backtesting_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Assumes bid-ask spread on retail level</p></dd>
<dt><a class="co" id="callout_vectorized_backtesting_CO12-2" href="#co_vectorized_backtesting_CO12-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Assumes bid-ask spread on professional level</p></dd>
</dl>

<figure class="thumb"><div id="figure_vb_10" class="figure">
<img src="Images/aiif_1010.png" alt="aiif 1010" width="2444" height="1559"/>
<h6><span class="label">Figure 10-10. </span>Gross performance of the DNN intraday strategy before and after higher/lower transaction costs (out-of-sample)</h6>
</div></figure>
<div data-type="caution"><h1>Intraday Trading</h1>
<p>Intraday algorithmic trading in the form discussed in this chapter often seems appealing from a statistical point of view. Both 
<span class="keep-together">in-sample</span> and out-of-sample, the DNN model reaches a high accuracy when predicting the market direction. Excluding transaction costs, this also translates both in-sample and out-of-sample into a significant outperformance of the DNN-based strategy when compared to the passive benchmark investment. However, adding transaction costs to the mix reduces the performance of the DNN-based strategy considerably, making it unviable for typical retail bid-ask spreads and not really attractive for lower, high-volume bid-ask spreads.<a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_ch10" id="idm45625269098584"/><a data-type="indexterm" data-primary="" data-startref="ix_DNNs_vector_backtest" id="idm45625269097608"/><a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_DNN" id="idm45625269096664"/><a data-type="indexterm" data-primary="" data-startref="ix_intraday_trade_ch10" id="idm45625269095720"/><a data-type="indexterm" data-primary="" data-startref="ix_trans_cost_vector_backtest" id="idm45625269094776"/><a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_trans_cost" id="idm45625269365288"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusions"><div class="sect1" id="idm45625271530328">
<h1>Conclusions</h1>

<p>Vectorized backtesting proves to be an efficient and valuable approach for backtesting the performance of AI-powered algorithmic trading strategies. This chapter first explains the basic idea behind the approach based on a simple example using two SMAs to derive signals. This allows for a simple visualization of the strategy and resulting positions. It then proceeds by backtesting a DNN-based trading strategy, as discussed in detail in <a data-type="xref" href="ch07.xhtml#dense_networks">Chapter 7</a>, in combination with EOD data. Both before and after transaction costs, the <em>statistical inefficiencies</em> as discovered in <a data-type="xref" href="ch07.xhtml#dense_networks">Chapter 7</a> translate into <em>economic inefficiencies</em>, which means profitable trading strategies. When using the same vectorized backtesting approaches with intraday data, the DNN strategy also shows a significant outperformance both in- and out-of-sample when compared 
<span class="keep-together">to the passive</span> benchmark investment—at least before transaction costs. Adding transaction costs 
<span class="keep-together">to the backtesting</span> illustrates that these must be pretty low, on a level often not 
<span class="keep-together">even achieved</span> by big professional traders, to render the trading strategy 
<span class="keep-together">economically viable.</span></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="References"><div class="sect1" id="idm45625269356760">
<h1>References</h1>

<p>Books and papers cited in this chapter:</p>

<ul class="author-date-bib">
<li>
<p>Gibbs Samuel. 2016. “Elon Musk: Tesla Cars Will Be Able to Cross Us with No Driver in Two Years.” <em>The Guardian</em>. January 11, 2016. <a href="https://oreil.ly/C508Q"><em class="hyperlink">https://oreil.ly/C508Q</em></a>.</p>
</li>
<li>
<p>Hilpisch, Yves. 2018. <em>Python for Finance: Mastering Data-Driven Finance.</em> 2nd ed. Sebastopol: O’Reilly.</p>
</li>
<li>
<p>⸻. 2020. <em>Python for Algorithmic Trading: From Idea to Cloud Deployment.</em> Sebastopol: O’Reilly.</p>
</li>
</ul>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45625271705592"><sup><a href="ch10.xhtml#idm45625271705592-marker">1</a></sup> This, for example, is a typical spread that <a href="http://oanda.com">Oanda</a> offers retail traders.</p></div></div></section></div>



  </body></html>