<html><head></head><body><section data-pdf-bookmark="Chapter 7. Working with Real-Time Data and Sockets" data-type="chapter" epub:type="chapter"><div class="chapter" id="realtime_sockets">&#13;
<h1><span class="label">Chapter 7. </span>Working with Real-Time Data and Sockets</h1>&#13;
&#13;
<blockquote>&#13;
<p class="align_me_right">If you want to find the secrets of the universe, think in terms of energy, frequency, and vibration.</p>&#13;
<p data-type="attribution">Nikola Tesla</p>&#13;
</blockquote>&#13;
&#13;
<p><a data-primary="real-time data" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc0"/><a data-primary="sockets, real-time data and" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc1"/>Developing trading ideas and backtesting them is a rather asynchronous and non-critical process during which there are multiple steps that might or might not be repeated, during which no capital is at stake, and during which performance and speed are not the most important requirements. Turning to the markets to deploy a trading strategy changes the rules considerably. Data arrives in real time and usually in massive amounts, making a real-time processing of the data and the real-time decision making based on the streaming data a necessity. This chapter is about working with real-time data for which <em>sockets</em> are in general the technological tool of choice.&#13;
In this context, here are a few words on central technical terms:</p>&#13;
<dl>&#13;
<dt>Network socket</dt>&#13;
<dd>&#13;
<p>Endpoint of a connection in a computer network, also simply <em>socket</em> for short.</p>&#13;
</dd>&#13;
<dt>Socket address</dt>&#13;
<dd>&#13;
<p>Combination of an Internet Protocol (IP) address and a port number.</p>&#13;
</dd>&#13;
<dt>Socket protocol</dt>&#13;
<dd>&#13;
<p>A protocol defining and handling the socket communication, like the Transfer Control Protocol (TCP).</p>&#13;
</dd>&#13;
<dt>Socket pair</dt>&#13;
<dd>&#13;
<p>Combination of a local and a remote socket that communicate with each other.</p>&#13;
</dd>&#13;
<dt>Socket API</dt>&#13;
<dd>&#13;
<p>The application programming interface allowing for the controlling of sockets and their communication.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="ZeroMQ" data-type="indexterm" id="idm45785358171128"/>This chapter focuses on the use of <a href="http://zeromq.org"><code>ZeroMQ</code></a> as a lightweight, fast, and scalable socket programming library. It is available on multiple platforms with wrappers for the most popular programming languages. <code>ZeroMQ</code> supports different patterns for socket communication. <a data-primary="publisher-subscriber (PUB-SUB) pattern" data-type="indexterm" id="idm45785358168632"/>One of those patterns is the so-called <em>publisher-subscriber</em> (<code>PUB-SUB</code>) pattern where a single socket publishes data and multiple sockets simultaneously retrieve the data. This is similar to a radio station that broadcasts its program that is simultaneously listened to by thousands of people via radio devices.</p>&#13;
&#13;
<p>Given the <code>PUB-SUB</code> pattern, a fundamental application scenario in algorithmic trading is the retrieval of real-time financial data from an exchange, a trading platform, or a data service provider. Suppose you have developed an intraday trading idea based on the EUR/USD currency pair and have backtested it thoroughly. When deploying it, you need to be able to receive and process the price data in real-time. This fits exactly such a <code>PUB-SUB</code> pattern. A central instance broadcasts the new tick data as it becomes available and you, as well as probably thousands of others, receive and process it at the same time.<sup><a data-type="noteref" href="ch07.html#idm45785358164968" id="idm45785358164968-marker">1</a></sup></p>&#13;
&#13;
<p>This chapter is organized as follows. <a data-type="xref" href="#tick_server">“Running a Simple Tick Data Server”</a> describes how to implement and run a tick data server for sample financial data. <a data-type="xref" href="#tick_client">“Connecting a Simple Tick Data Client”</a> implements a tick data client to connect to the tick data server. <a data-type="xref" href="#signal_generation">“Signal Generation in Real Time”</a> shows how to generate trading signals in real time based on data from the tick data server. Finally, <a data-type="xref" href="#stream_plotting">“Visualizing Streaming Data with Plotly”</a> introduces the <a href="http://plot.ly">Plotly</a> plotting package as an efficient way to plot streaming data in real time.</p>&#13;
&#13;
<p>The goal of this chapter is to have a tool set and approaches available to be able to work with streaming data in the context of algorithmic trading.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p>The code in this chapter makes heavy use of ports over which socket communication takes place and requires the simultaneous execution of two or more scripts at the same time. It is therefore recommended to execute the codes in this chapter in different terminal instances, running different Python kernels. The execution within a single Jupyter Notebook, for instance, does not work in general. What works, however, is the execution of the tick data server script (<a data-type="xref" href="#tick_server">“Running a Simple Tick Data Server”</a>) in a terminal and the retrieval of data in a Jupyter Notebook (<a data-type="xref" href="#stream_plotting">“Visualizing Streaming Data with Plotly”</a>).</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running a Simple Tick Data Server" data-type="sect1"><div class="sect1" id="tick_server">&#13;
<h1>Running a Simple Tick Data Server</h1>&#13;
&#13;
<p><a data-primary="real-time data" data-secondary="tick data server for" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc2"/><a data-primary="tick data server" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc3"/>This section shows how to run a simple tick data server based on simulated financial instrument prices. The model used for the data generation is the geometric Brownian motion (without dividends) for which an exact Euler discretization is available, as shown in <a data-type="xref" href="#euler_disc">Equation 7-1</a>. Here, <math alttext="upper S">&#13;
  <mi>S</mi>&#13;
</math> is the instrument price, <math alttext="r">&#13;
  <mi>r</mi>&#13;
</math> is the constant short rate, <math alttext="sigma">&#13;
  <mi>σ</mi>&#13;
</math> is the constant volatility factor, and <math alttext="z">&#13;
  <mi>z</mi>&#13;
</math> is a standard normal random variable. <math alttext="normal upper Delta t">&#13;
  <mrow>&#13;
    <mi>Δ</mi>&#13;
    <mi>t</mi>&#13;
  </mrow>&#13;
</math> is the interval between two discrete observations of the instrument price.</p>&#13;
<div data-type="equation" id="euler_disc">&#13;
<h5><span class="label">Equation 7-1. </span>Euler discretization of geometric Brownian motion</h5>&#13;
<math alttext="upper S Subscript t Baseline equals upper S Subscript t minus normal upper Delta t Baseline dot exp left-parenthesis left-parenthesis r minus StartFraction sigma squared Over 2 EndFraction right-parenthesis normal upper Delta t plus sigma StartRoot normal upper Delta t EndRoot z right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <msub><mi>S</mi> <mi>t</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msub><mi>S</mi> <mrow><mi>t</mi><mo>-</mo><mi>Δ</mi><mi>t</mi></mrow> </msub>&#13;
    <mo>·</mo>&#13;
    <mo form="prefix">exp</mo>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <mfenced close=")" open="(" separators="">&#13;
        <mi>r</mi>&#13;
        <mo>-</mo>&#13;
        <mfrac><msup><mi>σ</mi> <mn>2</mn> </msup> <mn>2</mn></mfrac>&#13;
      </mfenced>&#13;
      <mi>Δ</mi>&#13;
      <mi>t</mi>&#13;
      <mo>+</mo>&#13;
      <mi>σ</mi>&#13;
      <msqrt>&#13;
        <mrow>&#13;
          <mi>Δ</mi>&#13;
          <mi>t</mi>&#13;
        </mrow>&#13;
      </msqrt>&#13;
      <mi>z</mi>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Making use of this model, <a data-type="xref" href="#py_tick_server">“Sample Tick Data Server”</a> presents a Python script that implements a tick data server using <code>ZeroMQ</code> and a class called <code>InstrumentPrice</code> to publish new, simulated tick data in a randomized fashion. The publishing is randomized in two ways. First, the stock price value is based on a Monte Carlo simulation. Second is the length of time interval between two publishing events it randomized. The remainder of this section explains the major parts of the script in detail.</p>&#13;
&#13;
<p>The first part of the following script does some imports, among other things, for the Python wrapper of <code>ZeroMQ</code>. It also instantiates the major objects needed to open a socket of <code>PUB</code> type:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO1-1" id="co_working_with_real_time_data_and_sockets_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">math</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">time</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">random</code><code>&#13;
</code><code>&#13;
</code><code class="n">context</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO1-2" id="co_working_with_real_time_data_and_sockets_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">socket</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO1-3" id="co_working_with_real_time_data_and_sockets_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">socket</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'</code><code class="s1">tcp://0.0.0.0:5555</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO1-4" id="co_working_with_real_time_data_and_sockets_CO1-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO1-1" id="callout_working_with_real_time_data_and_sockets_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This imports the Python wrapper for the <code>ZeroMQ</code> library.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO1-2" id="callout_working_with_real_time_data_and_sockets_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>A <code>Context</code> object is instantiated. It is the central object for the socket communication.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO1-3" id="callout_working_with_real_time_data_and_sockets_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The socket itself is defined based on the <code>PUB</code> socket type (“communication pattern”).</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO1-4" id="callout_working_with_real_time_data_and_sockets_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The socket gets bound to the local IP address (<code>0.0.0.0</code> on Linux and Mac OS, <code>127.0.0.1</code> on Windows) and the port number 5555.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The class <code>InstrumentPrice</code> is for the simulation of instrument price values over time. As attributes, there are the major parameters for the geometric Brownian motion in addition to the instrument symbol and the time at which an instance is created. <a data-primary=".simulate_value() method" data-primary-sortas="simulate_value" data-type="indexterm" id="idm45785358028168"/>The only method <code>.simulate_value()</code> generates new values for the stock price given the time passed since it has been called the last time and a random factor:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code><code> </code><code class="nc">InstrumentPrice</code><code class="p">(</code><code class="nb">object</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-1" id="co_working_with_real_time_data_and_sockets_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="mf">100.</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">sigma</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.4</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">r</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.01</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">simulate_value</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="sd">''' Generates a new, random stock price.&#13;
        '''</code><code>&#13;
</code><code>        </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-2" id="co_working_with_real_time_data_and_sockets_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">dt</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">t</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">t</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="mi">252</code><code> </code><code class="o">*</code><code> </code><code class="mi">8</code><code> </code><code class="o">*</code><code> </code><code class="mi">60</code><code> </code><code class="o">*</code><code> </code><code class="mi">60</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-3" id="co_working_with_real_time_data_and_sockets_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">dt</code><code> </code><code class="o">*</code><code class="o">=</code><code> </code><code class="mi">500</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-4" id="co_working_with_real_time_data_and_sockets_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">t</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-5" id="co_working_with_real_time_data_and_sockets_CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">value</code><code> </code><code class="o">*</code><code class="o">=</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">r</code><code> </code><code class="o">-</code><code> </code><code class="mf">0.5</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">sigma</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">dt</code><code> </code><code class="o">+</code><code>&#13;
</code><code>                               </code><code class="bp">self</code><code class="o">.</code><code class="n">sigma</code><code> </code><code class="o">*</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">dt</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">gauss</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO2-6" id="co_working_with_real_time_data_and_sockets_CO2-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">value</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-1" id="callout_working_with_real_time_data_and_sockets_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The attribute <code>t</code> stores the time of the initialization.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-2" id="callout_working_with_real_time_data_and_sockets_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>When the <code>.simulate_value()</code> method is called, the current time is recorded.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-3" id="callout_working_with_real_time_data_and_sockets_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p><code>dt</code> represents the time interval between the current time and the one stored in <code>self.t</code> in (trading) year fractions.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-4" id="callout_working_with_real_time_data_and_sockets_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>To have larger instrument price movements, this line of code scales the <code>dt</code> variable (by an arbitrary factor).</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-5" id="callout_working_with_real_time_data_and_sockets_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The attribute <code>t</code> is updated with the current time, which represents the reference point for the next call of the method.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO2-6" id="callout_working_with_real_time_data_and_sockets_CO2-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Based on an Euler scheme for the geometric Brownian motion, a new instrument price is simulated.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The main part of the script consists of the instantiation of an object of type <code>InstrumentPrice</code> and an infinite <code>while</code> loop. During the <code>while</code> loop, a new instrument price gets simulated, and a message is created, printed, and sent via the socket.</p>&#13;
&#13;
<p class="pagebreak-before">Finally, the execution pauses for a random amount of time:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">ip</code><code> </code><code class="o">=</code><code> </code><code class="n">InstrumentPrice</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-1" id="co_working_with_real_time_data_and_sockets_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">while</code><code> </code><code class="bp">True</code><code class="p">:</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-2" id="co_working_with_real_time_data_and_sockets_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="n">msg</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">{} {:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">ip</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="n">ip</code><code class="o">.</code><code class="n">simulate_value</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-3" id="co_working_with_real_time_data_and_sockets_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>    </code><code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-4" id="co_working_with_real_time_data_and_sockets_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="n">socket</code><code class="o">.</code><code class="n">send_string</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-5" id="co_working_with_real_time_data_and_sockets_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO3-6" id="co_working_with_real_time_data_and_sockets_CO3-6"><img alt="6" src="assets/6.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-1" id="callout_working_with_real_time_data_and_sockets_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This line instantiates an <code>InstrumentPrice</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-2" id="callout_working_with_real_time_data_and_sockets_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>An infinite <code>while</code> loop is started.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-3" id="callout_working_with_real_time_data_and_sockets_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The message text gets generated based on the <code>symbol</code> attribute and a newly simulated stock price value.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-4" id="callout_working_with_real_time_data_and_sockets_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The message <code>str</code> object is printed to the standard out.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-5" id="callout_working_with_real_time_data_and_sockets_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>It is also sent to subscribed sockets.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO3-6" id="callout_working_with_real_time_data_and_sockets_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The execution of the loop is paused for a random amount of time (between 0 and 2 seconds), simulating the random arrival of new tick data in the markets.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Executing the script prints out messages as follows:</p>&#13;
&#13;
<pre data-type="programlisting">(base) pro:ch07 yves$ Python TickServer.py&#13;
SYMBOL 100.00&#13;
SYMBOL 99.65&#13;
SYMBOL 99.28&#13;
SYMBOL 99.09&#13;
SYMBOL 98.76&#13;
SYMBOL 98.83&#13;
SYMBOL 98.82&#13;
SYMBOL 98.92&#13;
SYMBOL 98.57&#13;
SYMBOL 98.81&#13;
SYMBOL 98.79&#13;
SYMBOL 98.80</pre>&#13;
&#13;
<p>At this point, it cannot yet be verified whether the script is also sending the same message via the socket bound to <code>tcp://0.0.0.0:5555</code> (<code>tcp://127.0.0.1:5555</code> on Windows). To this end, another socket subscribing to the publishing socket is needed to complete the socket pair.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p>Often, the Monte Carlo simulation of prices for financial instruments relies on homogeneous time intervals (like “one trading day”). In many cases, this is a “good enough” approximation when working with, say, end-of-day closing prices over longer horizons. In the context of intraday tick data, the random arrival of the data is an important characteristic that needs to be taken into account. The Python script for the tick data server implements the random arrival times by randomized time intervals during which it pauses the execution.<a data-startref="ix_07_working_with_sockets_-asciidoc3" data-type="indexterm" id="idm45785357645032"/><a data-startref="ix_07_working_with_sockets_-asciidoc2" data-type="indexterm" id="idm45785357644360"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Connecting a Simple Tick Data Client" data-type="sect1"><div class="sect1" id="tick_client">&#13;
<h1>Connecting a Simple Tick Data Client</h1>&#13;
&#13;
<p><a data-primary="real-time data" data-secondary="tick data client for" data-type="indexterm" id="idm45785357641896"/><a data-primary="tick data client" data-type="indexterm" id="idm45785357640696"/>The code for the tick data server is already quite concise, with the <code>InstrumentPrice</code> simulation class representing the longest part. The code for a respective tick data client, as shown in <a data-type="xref" href="#py_tick_client">“Tick Data Client”</a>, is even more concise. It is only a few lines of code that instantiate the main <code>Context</code> object, connect to the publishing socket, and subscribe to the <code>SYMBOL</code> channel, which happens to be the only available channel here. In the <code>while</code> loop, the string-based message is received and printed. That makes for a rather short script.</p>&#13;
&#13;
<p>The initial part of the following script is almost symmetrical to the tick data server script:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO4-1" id="co_working_with_real_time_data_and_sockets_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">context</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO4-2" id="co_working_with_real_time_data_and_sockets_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">socket</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO4-3" id="co_working_with_real_time_data_and_sockets_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">tcp://0.0.0.0:5555</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO4-4" id="co_working_with_real_time_data_and_sockets_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO4-5" id="co_working_with_real_time_data_and_sockets_CO4-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO4-1" id="callout_working_with_real_time_data_and_sockets_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This imports the Python wrapper for the <code>ZeroMQ</code> library.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO4-2" id="callout_working_with_real_time_data_and_sockets_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>For the client, the main object also is an instance of <code>zmq.Context</code>.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO4-3" id="callout_working_with_real_time_data_and_sockets_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>From here, the code is different; the socket type is set to <code>SUB</code>.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO4-4" id="callout_working_with_real_time_data_and_sockets_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This socket connects to the respective IP address and port combination.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO4-5" id="callout_working_with_real_time_data_and_sockets_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>This line of code defines the so-called channel to which the socket subscribes. Here, there is only one, but a specification is nevertheless required. In real-world applications, however, you might receive data for a multitude of different symbols via a socket connection.</p></dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before">The <code>while</code> loop boils down to the retrieval of the messages sent by the server socket and printing them out:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">while</code><code> </code><code class="bp">True</code><code class="p">:</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO5-1" id="co_working_with_real_time_data_and_sockets_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO5-2" id="co_working_with_real_time_data_and_sockets_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="k">print</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO5-3" id="co_working_with_real_time_data_and_sockets_CO5-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO5-1" id="callout_working_with_real_time_data_and_sockets_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This socket receives data in an infinite loop.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO5-2" id="callout_working_with_real_time_data_and_sockets_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This is the main line of code where the data (string-based message) is received.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO5-3" id="callout_working_with_real_time_data_and_sockets_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p><code>data</code> is printed to <code>stdout</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The output of the Python script for the socket client is exactly the same as the one from the Python script for the socket server:</p>&#13;
&#13;
<pre data-type="programlisting">(base) pro:ch07 yves$ Python TickClient.py&#13;
SYMBOL 100.00&#13;
SYMBOL 99.65&#13;
SYMBOL 99.28&#13;
SYMBOL 99.09&#13;
SYMBOL 98.76&#13;
SYMBOL 98.83&#13;
SYMBOL 98.82&#13;
SYMBOL 98.92&#13;
SYMBOL 98.57&#13;
SYMBOL 98.81&#13;
SYMBOL 98.79&#13;
SYMBOL 98.80</pre>&#13;
&#13;
<p>Retrieving data in the form of string-based messages via socket communication is only a prerequisite for the very tasks to be accomplished based on the data, like generating trading signals in real time or visualizing the data. This is what the two next sections cover.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p><code>ZeroMQ</code> allows the transmission of other object types, as well. For example, there is an option to send a Python object via a socket. &#13;
<span class="keep-together">To this end,</span> the object is, by default, serialized and deserialized &#13;
<span class="keep-together">with <code>pickle</code>.</span> The respective methods to accomplish this are <code>.send_pyobj()</code> and <code>.recv_pyobj()</code> (see <a href="https://oreil.ly/ok2kc">The PyZMQ API</a>). In practice, however, platforms and data providers cater to a diverse set of environments, with Python being only one out of many languages. Therefore, string-based socket communication is often used, for example, in combination with standard data formats such as <code>JSON</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Signal Generation in Real Time" data-type="sect1"><div class="sect1" id="signal_generation">&#13;
<h1>Signal Generation in Real Time</h1>&#13;
&#13;
<p><a data-primary="online algorithm" data-secondary="signal generation in real time" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc4"/><a data-primary="real-time data" data-secondary="signal generation in real time" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc5"/>An <a data-primary="online algorithm" data-secondary="defined" data-type="indexterm" id="idm45785357171080"/><em>online algorithm</em> is an algorithm based on data that is received incrementally (bit by bit) over time. Such an algorithm only knows the current and previous states of relevant variables and parameters, but nothing about the future. This is a realistic setting for financial trading algorithms for which any element of (perfect) foresight is to be excluded. <a data-primary="offline algorithm" data-secondary="defined" data-type="indexterm" id="idm45785357169496"/>By contrast, an <em>offline algorithm</em> knows the complete data set from the beginning. Many algorithms in computer science fall into the category of offline algorithms, such as a sorting algorithm over a list of numbers.</p>&#13;
&#13;
<p>To generate signals in real time on the basis of an online algorithm, data needs to be collected and processed over time. Consider, for example, a trading strategy based on the time series momentum of the last three five-second intervals (see <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter 4</a>). Tick data needs to be collected and then resampled, and the momentum needs to be calculated based on the resampled data set. When time passes by, a continuous, incremental updating takes place.&#13;
<a data-type="xref" href="#py_online_algorithm">“Momentum Online Algorithm”</a> presents a Python script that implements the momentum strategy, as described previously as an online algorithm. Technically, there are two major parts in addition to handling the socket communication. First are the retrieval and storage of the tick data:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-1" id="co_working_with_real_time_data_and_sockets_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">mom</code><code> </code><code class="o">=</code><code> </code><code class="mi">3</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-2" id="co_working_with_real_time_data_and_sockets_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">min_length</code><code> </code><code class="o">=</code><code> </code><code class="n">mom</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-3" id="co_working_with_real_time_data_and_sockets_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">while</code><code> </code><code class="bp">True</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-4" id="co_working_with_real_time_data_and_sockets_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-5" id="co_working_with_real_time_data_and_sockets_CO6-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>    </code><code class="n">sym</code><code class="p">,</code><code> </code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-6" id="co_working_with_real_time_data_and_sockets_CO6-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>    </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="n">sym</code><code class="p">:</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">value</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO6-7" id="co_working_with_real_time_data_and_sockets_CO6-7"><img alt="7" src="assets/7.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-1" id="callout_working_with_real_time_data_and_sockets_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates an empty <code>pandas</code> <code>DataFrame</code> to collect the tick data.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-2" id="callout_working_with_real_time_data_and_sockets_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Defines the number of time intervals for the momentum calculation.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-3" id="callout_working_with_real_time_data_and_sockets_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Specifies the (initial) minimum length for the signal generation to be triggered.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-4" id="callout_working_with_real_time_data_and_sockets_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The retrieval of the tick data via the socket connection.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-5" id="callout_working_with_real_time_data_and_sockets_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>A timestamp is generated for the data retrieval.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-6" id="callout_working_with_real_time_data_and_sockets_CO6-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The string-based message is split into the symbol and the numerical value (still a <code>str</code> object here).</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO6-7" id="callout_working_with_real_time_data_and_sockets_CO6-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>This line of code first generates a temporary <code>DataFrame</code> object with the new data and then appends it to the existing <code>DataFrame</code> object.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Second is the resampling and processing of the data, as shown in the following Python code. This happens based on the tick data collected up to a certain point in time. During this step, log returns are calculated based on the resampled data and the momentum is derived. The sign of the momentum defines the positioning to be taken in the financial instrument:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="n">dr</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="s1">'</code><code class="s1">5s</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">right</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-1" id="co_working_with_real_time_data_and_sockets_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">dr</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">dr</code><code> </code><code class="o">/</code><code> </code><code class="n">dr</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-2" id="co_working_with_real_time_data_and_sockets_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">dr</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">min_length</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="n">min_length</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-3" id="co_working_with_real_time_data_and_sockets_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">dr</code><code class="p">[</code><code class="s1">'</code><code class="s1">momentum</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">dr</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">mom</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-4" id="co_working_with_real_time_data_and_sockets_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">51</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">NEW SIGNAL | {}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">51</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">dr</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-5" id="co_working_with_real_time_data_and_sockets_CO7-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">dr</code><code class="p">[</code><code class="s1">'</code><code class="s1">momentum</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mf">1.0</code><code class="p">:</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-6" id="co_working_with_real_time_data_and_sockets_CO7-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">Long market position.</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="c1"># take some action (e.g., place buy order)</code><code>&#13;
</code><code>        </code><code class="k">elif</code><code> </code><code class="n">dr</code><code class="p">[</code><code class="s1">'</code><code class="s1">momentum</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mf">1.0</code><code class="p">:</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO7-7" id="co_working_with_real_time_data_and_sockets_CO7-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">Short market position.</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="c1"># take some action (e.g., place sell order)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-1" id="callout_working_with_real_time_data_and_sockets_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The tick data is resampled to a five-second interval, taking the last available tick value as the relevant one.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-2" id="callout_working_with_real_time_data_and_sockets_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This calculates the log returns over the five-second intervals.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-3" id="callout_working_with_real_time_data_and_sockets_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This increases the minimum length of the resampled <code>DataFrame</code> object by one.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-4" id="callout_working_with_real_time_data_and_sockets_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The momentum and, based on its sign, the positioning are derived given the log returns from three resampled time intervals.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-5" id="callout_working_with_real_time_data_and_sockets_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>This prints the final five rows of the resampled <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-6" id="callout_working_with_real_time_data_and_sockets_CO7-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>A momentum value of <code>1.0</code> means a long market position. In production, the first signal or a change in the signal then triggers certain actions, like placing an order with the broker. Note that the second but last value of the <code>momentum</code> column is used since the last value is based at this stage on incomplete data for the relevant (not yet finished) time interval. Technically, this is due to using the <code>pandas</code> <code>.resample()</code> method with the <code>label='right'</code> parametrization.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO7-7" id="callout_working_with_real_time_data_and_sockets_CO7-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Similarly, a momentum value of <code>-1.0</code> implies a short market position and potentially certain actions that might be triggered, such as a sell order with a broker. Again, the second but last value from the <code>momentum</code> column is used.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When the script is executed, it takes some time, depending on the very parameters chosen, until there is enough (resampled) data available to generate the first signal.</p>&#13;
&#13;
<p>Here is an intermediate example output of the online trading algorithm script:</p>&#13;
&#13;
<pre data-type="programlisting">(base) yves@pro ch07 $ python OnlineAlgorithm.py&#13;
&#13;
===================================================&#13;
NEW SIGNAL | 2020-05-23 11:33:31.233606&#13;
===================================================&#13;
                     SYMBOL  ...  momentum&#13;
2020-05-23 11:33:15   98.65  ...       NaN&#13;
2020-05-23 11:33:20   98.53  ...       NaN&#13;
2020-05-23 11:33:25   98.83  ...       NaN&#13;
2020-05-23 11:33:30   99.33  ...       1.0&#13;
&#13;
[4 rows x 3 columns]&#13;
&#13;
Long market position.&#13;
&#13;
===================================================&#13;
NEW SIGNAL | 2020-05-23 11:33:36.185453&#13;
===================================================&#13;
                     SYMBOL  ...  momentum&#13;
2020-05-23 11:33:15   98.65  ...       NaN&#13;
2020-05-23 11:33:20   98.53  ...       NaN&#13;
2020-05-23 11:33:25   98.83  ...       NaN&#13;
2020-05-23 11:33:30   99.33  ...       1.0&#13;
2020-05-23 11:33:35   97.76  ...      -1.0&#13;
&#13;
[5 rows x 3 columns]&#13;
&#13;
Short market position.&#13;
&#13;
===================================================&#13;
NEW SIGNAL | 2020-05-23 11:33:40.077869&#13;
===================================================&#13;
                     SYMBOL  ...  momentum&#13;
2020-05-23 11:33:20   98.53  ...       NaN&#13;
2020-05-23 11:33:25   98.83  ...       NaN&#13;
2020-05-23 11:33:30   99.33  ...       1.0&#13;
2020-05-23 11:33:35   97.76  ...      -1.0&#13;
2020-05-23 11:33:40   98.51  ...      -1.0&#13;
&#13;
[5 rows x 3 columns]&#13;
&#13;
Short market position.</pre>&#13;
<div data-type="tip">&#13;
<p>It is a good exercise to implement, based on the presented tick &#13;
<span class="keep-together">client</span> script, both an SMA-based strategy and a mean-reversion &#13;
<span class="keep-together">strategy</span> as an online algorithm.<a data-startref="ix_07_working_with_sockets_-asciidoc5" data-type="indexterm" id="idm45785356710632"/><a data-startref="ix_07_working_with_sockets_-asciidoc4" data-type="indexterm" id="idm45785356710024"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Visualizing Streaming Data with Plotly" data-type="sect1"><div class="sect1" id="stream_plotting">&#13;
<h1>Visualizing Streaming Data with Plotly</h1>&#13;
&#13;
<p><a data-primary="Plotly" data-secondary="visualization of streaming data" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc6"/><a data-primary="real-time data" data-secondary="visualizing streaming data with Plotly" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc7"/><a data-primary="streaming data" data-secondary="visualization with Plotly" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc8"/>The visualization of streaming data in real time is generally a demanding task. Fortunately, there are quite a few technologies and Python packages available nowadays that significantly simplify such a task. In what follows, we will work with <a href="http://plot.ly">Plotly</a>, which is both a technology and a service used to generate nice looking, interactive plots for static and streaming data. To follow along, the <code>plotly</code> package needs to be installed. Also, several Jupyter Lab extensions need to be installed &#13;
<span class="keep-together">when working</span> with Jupyter Lab. The following command should be executed on the &#13;
<span class="keep-together">terminal:</span></p>&#13;
&#13;
<pre data-type="programlisting">conda install plotly ipywidgets&#13;
jupyter labextension install jupyterlab-plotly&#13;
jupyter labextension install @jupyter-widgets/jupyterlab-manager&#13;
jupyter labextension install plotlywidget</pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Basics" data-type="sect2"><div class="sect2" id="idm45785356700696">&#13;
<h2>The Basics</h2>&#13;
&#13;
<p><a data-primary="Plotly" data-secondary="basics" data-type="indexterm" id="idm45785356699448"/>Once the required packages and extension are installed, the generation of a streaming plot is quite efficient. The first step is the creation of a Plotly figure widget:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>&#13;
</code><code>        </code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="kn">import</code><code> </code><code class="n">datetime</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">plotly.graph_objects</code><code> </code><code class="kn">as</code><code> </code><code class="nn">go</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO8-1" id="co_working_with_real_time_data_and_sockets_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">fig</code><code> </code><code class="o">=</code><code> </code><code class="n">go</code><code class="o">.</code><code class="n">FigureWidget</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO8-2" id="co_working_with_real_time_data_and_sockets_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">fig</code><code class="o">.</code><code class="n">add_scatter</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO8-2" id="co_working_with_real_time_data_and_sockets_CO8-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">fig</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO8-2" id="co_working_with_real_time_data_and_sockets_CO8-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">FigureWidget</code><code class="p">(</code><code class="p">{</code><code>&#13;
</code><code>       </code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">scatter</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">uid</code><code class="s1">'</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="s1">'</code><code class="s1">e1a65f25-287d-4021-a210-c2f41f32426a</code><code class="s1">'</code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">layout</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">t…</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO8-1" id="callout_working_with_real_time_data_and_sockets_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This imports the graphical objects from <code>plotly</code>.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO8-2" id="callout_working_with_real_time_data_and_sockets_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This instantiates a Plotly figure widget within the Jupyter Notebook.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The second step is to set up the socket communication with the sample tick data server, which needs to run on the same machine in a separate Python process. The incoming data is enriched by a timestamp and collected in <code>list</code> objects. These <code>list</code> objects in turn are used to update the <code>data</code> objects of the figure widget (see <a data-type="xref" href="#plotly_stream_01">Figure 7-1</a>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">context</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">socket</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">tcp://0.0.0.0:5555</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">times</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-1" id="co_working_with_real_time_data_and_sockets_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">prices</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-2" id="co_working_with_real_time_data_and_sockets_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">for</code><code> </code><code class="n">_</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="n">msg</code><code> </code><code class="o">=</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-3" id="co_working_with_real_time_data_and_sockets_CO9-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>            </code><code class="n">times</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">t</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-3" id="co_working_with_real_time_data_and_sockets_CO9-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>            </code><code class="n">_</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">msg</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="n">prices</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="nb">float</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">times</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-4" id="co_working_with_real_time_data_and_sockets_CO9-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">prices</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO9-4" id="co_working_with_real_time_data_and_sockets_CO9-6"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO9-1" id="callout_working_with_real_time_data_and_sockets_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>list</code> object for the timestamps.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO9-2" id="callout_working_with_real_time_data_and_sockets_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p><code>list</code> object for the real-time prices.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO9-3" id="callout_working_with_real_time_data_and_sockets_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generates a timestamp and appends it.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO9-5" id="callout_working_with_real_time_data_and_sockets_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Updates the <code>data</code> object with the amended <code>x</code> (<code>times</code>) and <code>y</code> (<code>prices</code>) data sets.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="plotly_stream_01">&#13;
<img alt="pfat 0701" src="assets/pfat_0701.png"/>&#13;
<h6><span class="label">Figure 7-1. </span>Plot of streaming price data, as retrieved in real time via socket connection</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Three Real-Time Streams" data-type="sect2"><div class="sect2" id="idm45785356310280">&#13;
<h2>Three Real-Time Streams</h2>&#13;
&#13;
<p><a data-primary="Plotly" data-secondary="multiple real-time streams for" data-type="indexterm" id="idm45785356308840"/>A streaming plot with Plotly can have multiple graph objects. <a data-primary="simple moving averages (SMAs)" data-secondary="visualization with price ticks" data-type="indexterm" id="idm45785356307544"/>This comes in handy when, for instance, two simple moving averages (SMAs) shall be visualized in real time in addition to the price ticks. <a data-primary="scatter objects" data-type="indexterm" id="idm45785356306376"/>The following code instantiates again a figure widget—this time with three <code>scatter</code> objects. The tick data from the sample tick data server is collected in a <code>pandas</code> <code>DataFrame</code> object. The two SMAs are calculated after each update from the socket. The amended data sets are used to update the <code>data</code> object of the figure widget (see <a data-type="xref" href="#plotly_stream_02">Figure 7-2</a>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">fig</code><code> </code><code class="o">=</code><code> </code><code class="n">go</code><code class="o">.</code><code class="n">FigureWidget</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">fig</code><code class="o">.</code><code class="n">add_scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">fig</code><code class="o">.</code><code class="n">add_scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">line</code><code class="o">=</code><code class="nb">dict</code><code class="p">(</code><code class="n">width</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">dash</code><code class="o">=</code><code class="s1">'</code><code class="s1">dot</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                         </code><code class="n">mode</code><code class="o">=</code><code class="s1">'</code><code class="s1">lines+markers</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">fig</code><code class="o">.</code><code class="n">add_scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">line</code><code class="o">=</code><code class="nb">dict</code><code class="p">(</code><code class="n">width</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">dash</code><code class="o">=</code><code class="s1">'</code><code class="s1">dash</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                         </code><code class="n">mode</code><code class="o">=</code><code class="s1">'</code><code class="s1">lines+markers</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">fig</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">FigureWidget</code><code class="p">(</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">scatter</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">uid</code><code class="s1">'</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="s1">'</code><code class="s1">bcf83157-f015-411b-a834-d5fd6ac509ba…</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO10-1" id="co_working_with_real_time_data_and_sockets_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">for</code><code> </code><code class="n">_</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">75</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">msg</code><code> </code><code class="o">=</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">sym</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">msg</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="n">sym</code><code class="p">:</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO10-1" id="co_working_with_real_time_data_and_sockets_CO10-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO10-2" id="co_working_with_real_time_data_and_sockets_CO10-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>             </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO10-2" id="co_working_with_real_time_data_and_sockets_CO10-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO10-1" id="callout_working_with_real_time_data_and_sockets_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Collects the tick data in a <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO10-3" id="callout_working_with_real_time_data_and_sockets_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Adds the two SMAs in separate columns to the <code>DataFrame</code> object.</p></dd>&#13;
</dl>&#13;
<div data-type="tip">&#13;
<p>Again, it is a good exercise to combine the plotting of streaming tick data and the two SMAs with the implementation of an online trading algorithm based on the two SMAs. In this case, resampling should be added to the implementation since such trading algorithms are hardly ever based on tick data but rather on bars of fixed length (five seconds, one minute, etc.).</p>&#13;
</div>&#13;
&#13;
<figure><div class="figure" id="plotly_stream_02">&#13;
<img alt="pfat 0702" src="assets/pfat_0702.png"/>&#13;
<h6><span class="label">Figure 7-2. </span>Plot of streaming price data and two SMAs calculated in real time</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Three Sub-Plots for Three Streams" data-type="sect2"><div class="sect2" id="idm45785355449672">&#13;
<h2>Three Sub-Plots for Three Streams</h2>&#13;
&#13;
<p><a data-primary="Plotly" data-secondary="multiple sub-plots for streams" data-type="indexterm" id="idm45785355448264"/>As with conventional Plotly plots, streaming plots based on figure widgets can also have multiple sub-plots. The example that follows creates a streaming plot with three sub-plots. The first plots the real-time tick data. The second plots the log returns data. The third plots the time series momentum based on the log returns data. <a data-type="xref" href="#plotly_stream_03">Figure 7-3</a> shows a snapshot of the whole figure object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">plotly.subplots</code><code> </code><code class="kn">import</code><code> </code><code class="n">make_subplots</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">f</code><code> </code><code class="o">=</code><code> </code><code class="n">make_subplots</code><code class="p">(</code><code class="n">rows</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">cols</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">shared_xaxes</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO11-1" id="co_working_with_real_time_data_and_sockets_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">f</code><code class="o">.</code><code class="n">append_trace</code><code class="p">(</code><code class="n">go</code><code class="o">.</code><code class="n">Scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">row</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">col</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO11-2" id="co_working_with_real_time_data_and_sockets_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">f</code><code class="o">.</code><code class="n">append_trace</code><code class="p">(</code><code class="n">go</code><code class="o">.</code><code class="n">Scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">RETURN</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">line</code><code class="o">=</code><code class="nb">dict</code><code class="p">(</code><code class="n">width</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">dash</code><code class="o">=</code><code class="s1">'</code><code class="s1">dot</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">mode</code><code class="o">=</code><code class="s1">'</code><code class="s1">lines+markers</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">marker</code><code class="o">=</code><code class="p">{</code><code class="s1">'</code><code class="s1">symbol</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">triangle-up</code><code class="s1">'</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">row</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">col</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO11-3" id="co_working_with_real_time_data_and_sockets_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">f</code><code class="o">.</code><code class="n">append_trace</code><code class="p">(</code><code class="n">go</code><code class="o">.</code><code class="n">Scatter</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'</code><code class="s1">MOMENTUM</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">line</code><code class="o">=</code><code class="nb">dict</code><code class="p">(</code><code class="n">width</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">dash</code><code class="o">=</code><code class="s1">'</code><code class="s1">dash</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">mode</code><code class="o">=</code><code class="s1">'</code><code class="s1">lines+markers</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">marker</code><code class="o">=</code><code class="p">{</code><code class="s1">'</code><code class="s1">symbol</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">x</code><code class="s1">'</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">row</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">col</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO11-4" id="co_working_with_real_time_data_and_sockets_CO11-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="c1"># f.update_layout(height=600)  </code><a class="co" href="#callout_working_with_real_time_data_and_sockets_CO11-5" id="co_working_with_real_time_data_and_sockets_CO11-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">fig</code><code> </code><code class="o">=</code><code> </code><code class="n">go</code><code class="o">.</code><code class="n">FigureWidget</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">fig</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">FigureWidget</code><code class="p">(</code><code class="p">{</code><code>&#13;
</code><code>           </code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">SYMBOL</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                     </code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">scatter</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                     </code><code class="s1">'</code><code class="s1">uid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">c8db0cac…</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">for</code><code> </code><code class="n">_</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">75</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">msg</code><code> </code><code class="o">=</code><code> </code><code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">sym</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">msg</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="n">sym</code><code class="p">:</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">RET</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">MOM</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">RET</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="o">.</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">index</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">sym</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">RET</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="o">.</code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">MOM</code><code class="s1">'</code><code class="p">]</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO11-1" id="callout_working_with_real_time_data_and_sockets_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creates three sub-plots that share the x-axis.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO11-2" id="callout_working_with_real_time_data_and_sockets_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates the first sub-plot for the price data.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO11-3" id="callout_working_with_real_time_data_and_sockets_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Creates the second sub-plot for the log returns data.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO11-4" id="callout_working_with_real_time_data_and_sockets_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Creates the third sub-plot for the momentum data.</p></dd>&#13;
<dt><a class="co" href="#co_working_with_real_time_data_and_sockets_CO11-5" id="callout_working_with_real_time_data_and_sockets_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Adjusts the height of the figure object.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="plotly_stream_03">&#13;
<img alt="pfat 0703" src="assets/pfat_0703.png"/>&#13;
<h6><span class="label">Figure 7-3. </span>Streaming price data, log returns, and momentum in different sub-plots</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Streaming Data as Bars" data-type="sect2"><div class="sect2" id="idm45785356232424">&#13;
<h2>Streaming Data as Bars</h2>&#13;
&#13;
<p><a data-primary="Plotly" data-secondary="streaming data as bars" data-type="indexterm" id="idm45785355917480"/><a data-primary="streaming bar plots" data-type="indexterm" id="idm45785355916280"/>Not all streaming data is best visualized as a time series (<code>Scatter</code> object). Some streaming data is better visualized as bars with changing height. <a data-type="xref" href="#py_bars_server">“Sample Data Server for Bar Plot”</a> contains a Python script that serves sample data suited for a bar-based visualization. A single data set (message) consists of eight floating point numbers. The following Python code generates a streaming bar plot (see <a data-type="xref" href="#plotly_stream_04">Figure 7-4</a>). In this context, the x data usually does not change. For the following code to work, the <code>BarsServer.py</code> script needs to be executed in a separate, local Python instance:<a data-startref="ix_07_working_with_sockets_-asciidoc8" data-type="indexterm" id="idm45785356212024"/><a data-startref="ix_07_working_with_sockets_-asciidoc7" data-type="indexterm" id="idm45785356211352"/><a data-startref="ix_07_working_with_sockets_-asciidoc6" data-type="indexterm" id="idm45785356210712"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5556'</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code> <code class="s1">''</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">24</code><code class="p">]:</code> <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">5</code><code class="p">):</code>&#13;
             <code class="n">msg</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">()</code>&#13;
             <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
         <code class="mf">60.361</code> <code class="mf">53.504</code> <code class="mf">67.782</code> <code class="mf">64.165</code> <code class="mf">35.046</code> <code class="mf">94.227</code> <code class="mf">20.221</code> <code class="mf">54.716</code>&#13;
         <code class="mf">79.508</code> <code class="mf">48.210</code> <code class="mf">84.163</code> <code class="mf">73.430</code> <code class="mf">53.288</code> <code class="mf">38.673</code> <code class="mf">4.962</code> <code class="mf">78.920</code>&#13;
         <code class="mf">53.316</code> <code class="mf">80.139</code> <code class="mf">73.733</code> <code class="mf">55.549</code> <code class="mf">21.015</code> <code class="mf">20.556</code> <code class="mf">49.090</code> <code class="mf">29.630</code>&#13;
         <code class="mf">86.664</code> <code class="mf">93.919</code> <code class="mf">33.762</code> <code class="mf">82.095</code> <code class="mf">3.108</code> <code class="mf">92.122</code> <code class="mf">84.194</code> <code class="mf">36.666</code>&#13;
         <code class="mf">37.192</code> <code class="mf">85.305</code> <code class="mf">48.397</code> <code class="mf">36.903</code> <code class="mf">81.835</code> <code class="mf">98.691</code> <code class="mf">61.818</code> <code class="mf">87.121</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">fig</code> <code class="o">=</code> <code class="n">go</code><code class="o">.</code><code class="n">FigureWidget</code><code class="p">()</code>&#13;
         <code class="n">fig</code><code class="o">.</code><code class="n">add_bar</code><code class="p">()</code>&#13;
         <code class="n">fig</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">FigureWidget</code><code class="p">({</code>&#13;
        <code class="s1">'data'</code><code class="p">:</code> <code class="p">[{</code><code class="s1">'type'</code><code class="p">:</code> <code class="s1">'bar'</code><code class="p">,</code> <code class="s1">'uid'</code><code class="p">:</code>&#13;
        <code class="s1">'51c6069f-4924-458d-a1ae-c5b5b5f3b07f'</code><code class="p">}],</code> <code class="s1">'layout'</code><code class="p">:</code> <code class="p">{</code><code class="s1">'templ…</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">x</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="s1">'abcdefgh'</code><code class="p">)</code>&#13;
         <code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">x</code> <code class="o">=</code> <code class="n">x</code>&#13;
         <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">25</code><code class="p">):</code>&#13;
             <code class="n">msg</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">()</code>&#13;
             <code class="n">y</code> <code class="o">=</code> <code class="n">msg</code><code class="o">.</code><code class="n">split</code><code class="p">()</code>&#13;
             <code class="n">y</code> <code class="o">=</code> <code class="p">[</code><code class="nb">float</code><code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="n">y</code><code class="p">]</code>&#13;
             <code class="n">fig</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">y</code> <code class="o">=</code> <code class="n">y</code></pre>&#13;
&#13;
<figure><div class="figure" id="plotly_stream_04">&#13;
<img alt="pfat 0704" src="assets/pfat_0704.png"/>&#13;
<h6><span class="label">Figure 7-4. </span>Streaming data as bars with changing height</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusions" data-type="sect1"><div class="sect1" id="idm45785356023464">&#13;
<h1>Conclusions</h1>&#13;
&#13;
<p>Nowadays, algorithmic trading has to deal with different types of streaming (real-time) data types. The most important type in this regard is tick data for financial instruments that is, in principle, generated and published around the clock.<sup><a data-type="noteref" href="ch07.html#idm45785354874120" id="idm45785354874120-marker">2</a></sup> Sockets are the technological tool of choice to deal with streaming data. A powerful and at the same time easy-to-use library in this regard is <code>ZeroMQ</code>, which is used in this chapter to create a simple tick data server that endlessly emits sample tick data.</p>&#13;
&#13;
<p>Different tick data clients are introduced and explained to generate trading signals in real time based on online algorithms and to visualize the incoming tick data by streaming plots using Plotly. Plotly makes streaming visualization within a Jupyter Notebook an efficient affair, allowing for, among other things, multiple streams at the same time—both in a single plot or in different sub-plots.</p>&#13;
&#13;
<p>Based on the topics covered in this chapter and the previous ones, you are now able to work with both <em>historical structured data</em> (for example, in the context of the backtesting of trading strategies) and <em>real-time streaming data</em> (for example, in the context of generating trading signals in real time). This represents a major milestone in the endeavor to build an automated, algorithmic trading operation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="References and Further Resources" data-type="sect1"><div class="sect1" id="idm45785354869816">&#13;
<h1>References and Further Resources</h1>&#13;
&#13;
<p>The best starting point for a thorough overview of <code>ZeroMQ</code> is the <a href="http://zeromq.org">ZeroMQ home page</a>. The <a href="https://bit.ly/zmq_pub_sub">Learning ZeroMQ with Python</a> tutorial page provides an overview of the <code>PUB-SUB</code> pattern based on the Python wrapper for the socket communication library.</p>&#13;
&#13;
<p>A good place to start working with Plotly is the <a href="http://plot.ly">Plotly home page</a> and in particular the <a href="https://oreil.ly/7ARrQ">Getting Started with Plotly page</a> for Python.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Scripts" data-type="sect1"><div class="sect1" id="idm45785354864200">&#13;
<h1>Python Scripts</h1>&#13;
&#13;
<p><a data-primary="Python scripts" data-secondary="real-time data handling" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc9"/><a data-primary="real-time data" data-secondary="Python script for handling" data-type="indexterm" id="ix_07_working_with_sockets_-asciidoc10"/>This section presents Python scripts referenced and used in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sample Tick Data Server" data-type="sect2"><div class="sect2" id="py_tick_server">&#13;
<h2>Sample Tick Data Server</h2>&#13;
&#13;
<p><a data-primary="real-time data" data-secondary="tick data server for" data-type="indexterm" id="idm45785354858552"/><a data-primary="tick data server" data-type="indexterm" id="idm45785354857576"/>The following is a script that runs a <a data-primary="Monte Carlo simulation" data-secondary="sample tick data server" data-type="indexterm" id="idm45785354856776"/>sample tick data server based on <code>ZeroMQ</code>. It makes use of Monte Carlo simulation for the geometric Brownian motion:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script to Simulate a</code>&#13;
<code class="c1"># Financial Tick Data Server</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="kn">import</code> <code class="nn">math</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="kn">import</code> <code class="nn">random</code>&#13;
&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5555'</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">InstrumentPrice</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="s1">'SYMBOL'</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">t</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">value</code> <code class="o">=</code> <code class="mf">100.</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">sigma</code> <code class="o">=</code> <code class="mf">0.4</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">r</code> <code class="o">=</code> <code class="mf">0.01</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">simulate_value</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Generates a new, random stock price.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">t</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
        <code class="n">dt</code> <code class="o">=</code> <code class="p">(</code><code class="n">t</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">t</code><code class="p">)</code> <code class="o">/</code> <code class="p">(</code><code class="mi">252</code> <code class="o">*</code> <code class="mi">8</code> <code class="o">*</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">60</code><code class="p">)</code>&#13;
        <code class="n">dt</code> <code class="o">*=</code> <code class="mi">500</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">t</code> <code class="o">=</code> <code class="n">t</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">value</code> <code class="o">*=</code> <code class="n">math</code><code class="o">.</code><code class="n">exp</code><code class="p">((</code><code class="bp">self</code><code class="o">.</code><code class="n">r</code> <code class="o">-</code> <code class="mf">0.5</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">sigma</code> <code class="o">**</code> <code class="mi">2</code><code class="p">)</code> <code class="o">*</code> <code class="n">dt</code> <code class="o">+</code>&#13;
                               <code class="bp">self</code><code class="o">.</code><code class="n">sigma</code> <code class="o">*</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">dt</code><code class="p">)</code> <code class="o">*</code> <code class="n">random</code><code class="o">.</code><code class="n">gauss</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">))</code>&#13;
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">value</code>&#13;
&#13;
&#13;
<code class="n">ip</code> <code class="o">=</code> <code class="n">InstrumentPrice</code><code class="p">()</code>&#13;
&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="s1">'{} {:.2f}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">ip</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code> <code class="n">ip</code><code class="o">.</code><code class="n">simulate_value</code><code class="p">())</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
    <code class="n">socket</code><code class="o">.</code><code class="n">send_string</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">2</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tick Data Client" data-type="sect2"><div class="sect2" id="py_tick_client">&#13;
<h2>Tick Data Client</h2>&#13;
&#13;
<p>The following is a script that runs a tick data client based on <code>ZeroMQ</code>. It connects to the tick data server from <a data-type="xref" href="#py_tick_server">“Sample Tick Data Server”</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script</code>&#13;
<code class="c1"># with Tick Data Client</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5555'</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code> <code class="s1">'SYMBOL'</code><code class="p">)</code>&#13;
&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">()</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">data</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Momentum Online Algorithm" data-type="sect2"><div class="sect2" id="py_online_algorithm">&#13;
<h2>Momentum Online Algorithm</h2>&#13;
&#13;
<p><a data-primary="momentum strategies" data-secondary="Python script for momentum online algorithm" data-type="indexterm" id="idm45785355100712"/><a data-primary="online algorithm" data-secondary="Python script for momentum online algorithm" data-type="indexterm" id="idm45785355099704"/>The following is a script that implements a trading strategy based on time series momentum as an online algorithm. It connects to the tick data server from <a data-type="xref" href="#py_tick_server">“Sample Tick Data Server”</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script</code>&#13;
<code class="c1"># with Online Trading Algorithm</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5555'</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code> <code class="s1">'SYMBOL'</code><code class="p">)</code>&#13;
&#13;
<code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">()</code>&#13;
<code class="n">mom</code> <code class="o">=</code> <code class="mi">3</code>&#13;
<code class="n">min_length</code> <code class="o">=</code> <code class="n">mom</code> <code class="o">+</code> <code class="mi">1</code>&#13;
&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">()</code>&#13;
    <code class="n">t</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">()</code>&#13;
    <code class="n">sym</code><code class="p">,</code> <code class="n">value</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">split</code><code class="p">()</code>&#13;
    <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="n">sym</code><code class="p">:</code> <code class="nb">float</code><code class="p">(</code><code class="n">value</code><code class="p">)},</code> <code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">t</code><code class="p">]))</code>&#13;
    <code class="n">dr</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="s1">'5s'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'right'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">()</code>&#13;
    <code class="n">dr</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">dr</code> <code class="o">/</code> <code class="n">dr</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
    <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">dr</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">min_length</code><code class="p">:</code>&#13;
        <code class="n">min_length</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
        <code class="n">dr</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">dr</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">mom</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">())</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="s1">'='</code> <code class="o">*</code> <code class="mi">51</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'NEW SIGNAL | {}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">()))</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">51</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">dr</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">tail</code><code class="p">())</code>&#13;
        <code class="k">if</code> <code class="n">dr</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code> <code class="o">==</code> <code class="mf">1.0</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">Long market position.'</code><code class="p">)</code>&#13;
            <code class="c1"># take some action (e.g., place buy order)</code>&#13;
        <code class="k">elif</code> <code class="n">dr</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code> <code class="o">==</code> <code class="o">-</code><code class="mf">1.0</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">Short market position.'</code><code class="p">)</code>&#13;
            <code class="c1"># take some action (e.g., place sell order)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sample Data Server for Bar Plot" data-type="sect2"><div class="sect2" id="py_bars_server">&#13;
<h2>Sample Data Server for Bar Plot</h2>&#13;
&#13;
<p><a data-primary="streaming bar plots" data-type="indexterm" id="idm45785355089352"/>The following is a Python script that generates sample data for a streaming bar plot<a data-startref="ix_07_working_with_sockets_-asciidoc10" data-type="indexterm" id="idm45785355088520"/><a data-startref="ix_07_working_with_sockets_-asciidoc9" data-type="indexterm" id="idm45785355087784"/>:<a data-startref="ix_07_working_with_sockets_-asciidoc1" data-type="indexterm" id="idm45785355086968"/><a data-startref="ix_07_working_with_sockets_-asciidoc0" data-type="indexterm" id="idm45785355086248"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script to Serve</code>&#13;
<code class="c1"># Random Bars Data</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="kn">import</code> <code class="nn">math</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="kn">import</code> <code class="nn">random</code>&#13;
&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5556'</code><code class="p">)</code>&#13;
&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">bars</code> <code class="o">=</code> <code class="p">[</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">100</code> <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">8</code><code class="p">)]</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="s1">' '</code><code class="o">.</code><code class="n">join</code><code class="p">([</code><code class="n">f</code><code class="s1">'{bar:.3f}'</code> <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="n">bars</code><code class="p">])</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
    <code class="n">socket</code><code class="o">.</code><code class="n">send_string</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">2</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45785358164968"><sup><a href="ch07.html#idm45785358164968-marker">1</a></sup> When speaking of <em>simultaneously</em> or <em>at the same time</em>, this is meant in a theoretical, idealized sense. In practical applications, different distances between the sending and receiving sockets, network speeds, and other factors affect the exact retrieval time per subscriber socket.</p><p data-type="footnote" id="idm45785354874120"><sup><a href="ch07.html#idm45785354874120-marker">2</a></sup> Not all markets are open 24 hours, 7 days per week, and for sure not all financial instruments are traded around the clock. However, cryptocurrency markets, for example, for Bitcoin, indeed operate around the clock, constantly creating new data that needs to be digested in real-time by players active in these markets.</p></div></div></section></body></html>