<html><head></head><body><section data-pdf-bookmark="Chapter 5. Predicting Market Movements with Machine Learning" data-type="chapter" epub:type="chapter"><div class="chapter" id="machine_learning">&#13;
<h1><span class="label">Chapter 5. </span>Predicting Market Movements with Machine Learning</h1>&#13;
&#13;
<blockquote>&#13;
<p class="align_me_right">Skynet begins to learn at a geometric rate. It becomes self-aware at 2:14 a.m. Eastern time, August 29th.</p>&#13;
<p data-type="attribution">The Terminator (<em>Terminator 2</em>)</p>&#13;
</blockquote>&#13;
&#13;
<p>Recent years have seen tremendous progress in the areas of machine learning, deep learning, and artificial intelligence. The financial industry in general and algorithmic traders around the globe in particular also try to benefit from these technological advances.</p>&#13;
&#13;
<p>This chapter introduces techniques from statistics, like <em>linear regression</em>, and from machine learning, like <em>logistic regression</em>, to predict future price movements based on past returns. It also illustrates the use of <em>neural networks</em> to predict stock market movements. This chapter, of course, cannot replace a thorough introduction to machine learning, but it can show, from a practitioner’s point of view, how to concretely apply certain techniques to the price prediction problem. For more details, refer to Hilpisch (2020).<sup><a data-type="noteref" href="ch05.html#idm45785375631928" id="idm45785375631928-marker">1</a></sup></p>&#13;
&#13;
<p>This chapter covers the following types of trading strategies:</p>&#13;
<dl>&#13;
<dt>Linear regression-based strategies</dt>&#13;
<dd>&#13;
<p>Such strategies use linear regression to extrapolate a trend or to derive a financial instrument’s direction of future price movement.</p>&#13;
</dd>&#13;
<dt>Machine learning-based strategies</dt>&#13;
<dd>&#13;
<p>In algorithmic trading it is generally enough to predict the direction of movement for a financial instrument as opposed to the absolute magnitude of that movement. With this reasoning, the prediction problem basically boils down to a <em>classification problem</em> of deciding whether there will be an upwards or downwards movement. Different machine learning algorithms have been developed to attack such classification problems. This chapter introduces logistic regression, as a typical baseline algorithm, for classification.</p>&#13;
</dd>&#13;
<dt>Deep learning-based strategies</dt>&#13;
<dd>&#13;
<p>Deep learning has been popularized by such technological giants as Facebook. Similar to machine learning algorithms, deep learning algorithms based on neural networks allow one to attack classification problems faced in financial market prediction.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The chapter is organized as follows. <a data-type="xref" href="#linear_regression">“Using Linear Regression for Market Movement Prediction”</a> introduces linear regression as a technique to predict index levels and the direction of price movements. <a data-type="xref" href="#machine_learning_scikit">“Using Machine Learning for Market Movement Prediction”</a> focuses on machine learning and introduces <code>scikit-learn</code> on the basis of linear regression. It mainly covers logistic regression as an alternative linear model explicitly applicable to classification problems. <a data-type="xref" href="#deep_learning">“Using Deep Learning for Market Movement Prediction”</a> introduces <code>Keras</code> to predict the direction of stock market movements based on neural network &#13;
<span class="keep-together">algorithms.</span></p>&#13;
&#13;
<p>The major goal of this chapter is to provide practical approaches to predict future price movements in financial markets based on past returns. <a data-primary="efficient market hypothesis" data-type="indexterm" id="idm45785375619720"/>The basic assumption is that the efficient market hypothesis does not hold universally and that, similar to the reasoning behind the technical analysis of stock price charts, the history might provide some insights about the future that can be mined with statistical techniques. In other words, it is assumed that certain patterns in financial markets repeat themselves such that past observations can be leveraged to predict future price movements. More details are covered in Hilpisch (2020).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Linear Regression for Market Movement Prediction" data-type="sect1"><div class="sect1" id="linear_regression">&#13;
<h1>Using Linear Regression for Market Movement Prediction</h1>&#13;
&#13;
<p><a data-primary="linear regression" data-secondary="market movement prediction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc2"/><a data-primary="market movement prediction" data-secondary="linear regression for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc3"/>Ordinary least squares (OLS) and linear regression are decades-old statistical techniques that have proven useful in many different application areas. This section uses linear regression for price prediction purposes. However, it starts with a quick review of the basics and an introduction to the basic approach.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Quick Review of Linear Regression" data-type="sect2"><div class="sect2" id="idm45785375613352">&#13;
<h2>A Quick Review of Linear Regression</h2>&#13;
&#13;
<p><a data-primary="linear regression" data-secondary="review of" data-type="indexterm" id="idm45785375611976"/>Before applying linear regression, a quick review of the approach based on some randomized data might be helpful. <a data-primary="ndarray objects" data-secondary="linear regression and" data-type="indexterm" id="idm45785375610344"/>The example code uses <code>NumPy</code> to first generate an <code>ndarray</code> object with data for the independent variable <code>x</code>. Based on this data, randomized data (“noisy data”) for the dependent variable <code>y</code> is generated. <code>NumPy</code> provides two functions, <code>polyfit</code> and <code>polyval</code>, for a convenient implementation of OLS regression based on simple monomials. For a linear regression, the highest degree for the monomials to be used is set to <code>1</code>. <a data-type="xref" href="#lr_plot_1">Figure 5-1</a> shows the data and the regression line:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">os</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">random</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-1" id="co_predicting_market_movements_with_machine_learning_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="kn">from</code><code> </code><code class="nn">pylab</code><code> </code><code class="kn">import</code><code> </code><code class="n">mpl</code><code class="p">,</code><code> </code><code class="n">plt</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-2" id="co_predicting_market_movements_with_machine_learning_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'</code><code class="s1">seaborn</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'</code><code class="s1">savefig.dpi</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">300</code><code>&#13;
</code><code>        </code><code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'</code><code class="s1">font.family</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">serif</code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s1">'</code><code class="s1">PYTHONHASHSEED</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">0</code><code class="s1">'</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linspace</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-3" id="co_predicting_market_movements_with_machine_learning_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">set_seeds</code><code class="p">(</code><code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">set_seeds</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-4" id="co_predicting_market_movements_with_machine_learning_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">x</code><code> </code><code class="o">+</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">standard_normal</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-5" id="co_predicting_market_movements_with_machine_learning_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">polyfit</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">,</code><code> </code><code class="n">deg</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-6" id="co_predicting_market_movements_with_machine_learning_CO1-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-7" id="co_predicting_market_movements_with_machine_learning_CO1-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">0.94612934</code><code class="p">,</code><code> </code><code class="mf">0.22855261</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-8" id="co_predicting_market_movements_with_machine_learning_CO1-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">bo</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-9" id="co_predicting_market_movements_with_machine_learning_CO1-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">reg</code><code class="p">,</code><code> </code><code class="n">x</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lw</code><code class="o">=</code><code class="mf">2.5</code><code class="p">,</code><code>&#13;
</code><code>                 </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">linear regression</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-10" id="co_predicting_market_movements_with_machine_learning_CO1-10"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO1-11" id="co_predicting_market_movements_with_machine_learning_CO1-11"><img alt="11" src="assets/11.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-1" id="callout_predicting_market_movements_with_machine_learning_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports <code>NumPy</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-2" id="callout_predicting_market_movements_with_machine_learning_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Imports <code>matplotlib</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-3" id="callout_predicting_market_movements_with_machine_learning_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generates an evenly spaced grid of floats for the <code>x</code> values between 0 and 10.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-4" id="callout_predicting_market_movements_with_machine_learning_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Fixes the seed values for all relevant random number generators.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-5" id="callout_predicting_market_movements_with_machine_learning_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Generates the randomized data for the <code>y</code> values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-6" id="callout_predicting_market_movements_with_machine_learning_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>OLS regression of degree 1 (that is, linear regression) is conducted.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-7" id="callout_predicting_market_movements_with_machine_learning_CO1-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Shows the optimal parameter values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-8" id="callout_predicting_market_movements_with_machine_learning_CO1-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Creates a new figure object.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-9" id="callout_predicting_market_movements_with_machine_learning_CO1-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Plots the original data set as dots.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-10" id="callout_predicting_market_movements_with_machine_learning_CO1-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Plots the regression line.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO1-11" id="callout_predicting_market_movements_with_machine_learning_CO1-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Creates the legend.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_1">&#13;
<img alt="pfat 0501" src="assets/pfat_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>Linear regression illustrated based on randomized data</h6>&#13;
</div></figure>&#13;
&#13;
<p>The interval for the dependent variable <code>x</code> is <math display="inline"><mrow><mi>x</mi><mo>∈</mo><mo>[</mo><mn>0</mn><mo>,</mo><mn>10</mn><mo>]</mo></mrow></math>. Enlarging the interval to, say, <math display="inline"><mrow><mi>x</mi><mo>∈</mo><mo>[</mo><mn>0</mn><mo>,</mo><mn>20</mn><mo>]</mo></mrow></math> allows one to “predict” values for the dependent variable <code>y</code> beyond the domain of the original data set by an extrapolation given the optimal regression parameters. <a data-type="xref" href="#lr_plot_2">Figure 5-2</a> visualizes the extrapolation:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">bo</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">xn</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linspace</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO2-1" id="co_predicting_market_movements_with_machine_learning_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">xn</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">reg</code><code class="p">,</code><code> </code><code class="n">xn</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lw</code><code class="o">=</code><code class="mf">2.5</code><code class="p">,</code><code>&#13;
</code><code>                 </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">linear regression</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO2-1" id="callout_predicting_market_movements_with_machine_learning_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Generates an enlarged domain for the <code>x</code> values.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_2">&#13;
<img alt="pfat 0502" src="assets/pfat_0502.png"/>&#13;
<h6><span class="label">Figure 5-2. </span>Prediction (extrapolation) based on linear regression</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Basic Idea for Price Prediction" data-type="sect2"><div class="sect2" id="idm45785375192808">&#13;
<h2>The Basic Idea for Price Prediction</h2>&#13;
&#13;
<p><a data-primary="linear regression" data-secondary="price prediction based on time series data" data-type="indexterm" id="ix_05_machine_learning_-asciidoc4"/><a data-primary="market movement prediction" data-secondary="price prediction based on time series data" data-type="indexterm" id="ix_05_machine_learning_-asciidoc5"/><a data-primary="price prediction, based on time series data" data-type="indexterm" id="ix_05_machine_learning_-asciidoc6"/><a data-primary="time series data sets" data-secondary="price prediction based on" data-type="indexterm" id="ix_05_machine_learning_-asciidoc7"/>Price prediction based on time series data has to deal with one special feature: the time-based ordering of the data. Generally, the ordering of the data is not important for the application of linear regression. In the first example in the previous section, the data on which the linear regression is implemented could have been compiled in completely different orderings, while keeping the <code>x</code> and <code>y</code> pairs constant. Independent of the ordering, the optimal regression parameters would have been the same.</p>&#13;
&#13;
<p>However, in the context of predicting tomorrow’s index level, for example, it seems to be of paramount importance to have the historic index levels in the correct order. If this is the case, one would then try to predict tomorrow’s index level given the index level of today, yesterday, the day before, etc. <a data-primary="lags" data-type="indexterm" id="idm45785375146888"/>The number of days used as input is generally called <em>lags</em>. Using today’s index level and the two more from before therefore translates into <em>three lags</em>.</p>&#13;
&#13;
<p>The next example casts this idea again into a rather simple context. The data the example uses are the numbers from 0 to 11:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">x</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="mi">12</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">x</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">array</code><code class="p">([</code> <code class="mi">0</code><code class="p">,</code>  <code class="mi">1</code><code class="p">,</code>  <code class="mi">2</code><code class="p">,</code>  <code class="mi">3</code><code class="p">,</code>  <code class="mi">4</code><code class="p">,</code>  <code class="mi">5</code><code class="p">,</code>  <code class="mi">6</code><code class="p">,</code>  <code class="mi">7</code><code class="p">,</code>  <code class="mi">8</code><code class="p">,</code>  <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">11</code><code class="p">])</code></pre>&#13;
&#13;
<p>Assume three lags for the regression. This implies three independent variables for the regression and one dependent one. More concretely, 0, 1, and 2 are values of the &#13;
<span class="keep-together">independent</span> variables, while 3 would be the corresponding value for the dependent variable. Moving forward on step (“in time”), the values are 1, 2, and 3, as well as 4. The final combination of values is 8, 9, and 10 with 11. The problem, therefore, is to cast this idea formally into a linear equation of the form <math alttext="upper A dot x equals b">&#13;
  <mrow>&#13;
    <mi>A</mi>&#13;
    <mo>·</mo>&#13;
    <mi>x</mi>&#13;
    <mo>=</mo>&#13;
    <mi>b</mi>&#13;
  </mrow>&#13;
</math> where <math alttext="upper A">&#13;
  <mi>A</mi>&#13;
</math> is a matrix and <math alttext="x">&#13;
  <mi>x</mi>&#13;
</math> and <math alttext="b">&#13;
  <mi>b</mi>&#13;
</math> are vectors:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">3</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-1" id="co_predicting_market_movements_with_machine_learning_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">m</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="p">(</code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">lags</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-2" id="co_predicting_market_movements_with_machine_learning_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">m</code><code class="p">[</code><code class="n">lags</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">x</code><code class="p">[</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-3" id="co_predicting_market_movements_with_machine_learning_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">lags</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-4" id="co_predicting_market_movements_with_machine_learning_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>             </code><code class="n">m</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">x</code><code class="p">[</code><code class="n">i</code><code class="p">:</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lags</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-5" id="co_predicting_market_movements_with_machine_learning_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">m</code><code class="o">.</code><code class="n">T</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO3-6" id="co_predicting_market_movements_with_machine_learning_CO3-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="p">[</code><code> </code><code class="mf">0.</code><code class="p">,</code><code>  </code><code class="mf">1.</code><code class="p">,</code><code>  </code><code class="mf">2.</code><code class="p">,</code><code>  </code><code class="mf">3.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">1.</code><code class="p">,</code><code>  </code><code class="mf">2.</code><code class="p">,</code><code>  </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">2.</code><code class="p">,</code><code>  </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">,</code><code> </code><code class="mf">11.</code><code class="p">]</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-1" id="callout_predicting_market_movements_with_machine_learning_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Defines the number of lags.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-2" id="callout_predicting_market_movements_with_machine_learning_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates an <code>ndarray</code> object with the appropriate dimensions.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-3" id="callout_predicting_market_movements_with_machine_learning_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Defines the target values (dependent variable).</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-4" id="callout_predicting_market_movements_with_machine_learning_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Iterates over the numbers from <code>0</code> to <code>lags - 1</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-5" id="callout_predicting_market_movements_with_machine_learning_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Defines the basis vectors (independent variables)</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO3-6" id="callout_predicting_market_movements_with_machine_learning_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Shows the transpose of the <code>ndarray</code> object <code>m</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In the transposed <code>ndarray</code> object <code>m</code>, the first three columns contain the values for the three independent variables. They together form the matrix <math alttext="upper A">&#13;
  <mi>A</mi>&#13;
</math>. The fourth and final column represents the vector <math alttext="b">&#13;
  <mi>b</mi>&#13;
</math>.&#13;
As a result, linear regression then yields the missing vector <math alttext="x">&#13;
  <mi>x</mi>&#13;
</math>.&#13;
Since there are now more independent variables, <code>polyfit</code> and <code>polyval</code> do not work anymore. However, there is a function in the <code>NumPy</code> sub-package for linear algebra (<code>linalg</code>) that allows one to solve general least-squares problems: <code>lstsq</code>. Only the first element of the results array is needed since it contains the optimal regression parameters:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">lstsq</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">,</code><code> </code><code class="n">m</code><code class="p">[</code><code class="n">lags</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">rcond</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO4-1" id="co_predicting_market_movements_with_machine_learning_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO4-2" id="co_predicting_market_movements_with_machine_learning_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="o">-</code><code class="mf">0.66666667</code><code class="p">,</code><code>  </code><code class="mf">0.33333333</code><code class="p">,</code><code>  </code><code class="mf">1.33333333</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">,</code><code> </code><code class="n">reg</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO4-3" id="co_predicting_market_movements_with_machine_learning_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">,</code><code> </code><code class="mf">11.</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO4-1" id="callout_predicting_market_movements_with_machine_learning_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implements the linear OLS regression.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO4-2" id="callout_predicting_market_movements_with_machine_learning_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Prints out the optimal parameters.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO4-3" id="callout_predicting_market_movements_with_machine_learning_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The <code>dot</code> product yields the prediction results.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This basic idea easily carries over to real-world financial time series data.<a data-startref="ix_05_machine_learning_-asciidoc7" data-type="indexterm" id="idm45785374636024"/><a data-startref="ix_05_machine_learning_-asciidoc6" data-type="indexterm" id="idm45785374635352"/><a data-startref="ix_05_machine_learning_-asciidoc5" data-type="indexterm" id="idm45785374634712"/><a data-startref="ix_05_machine_learning_-asciidoc4" data-type="indexterm" id="idm45785374634072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Predicting Index Levels" data-type="sect2"><div class="sect2" id="idm45785375192184">&#13;
<h2>Predicting Index Levels</h2>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="predicting" data-type="indexterm" id="ix_05_machine_learning_-asciidoc8"/><a data-primary="EUR/USD exchange rate" data-secondary="predicting index levels" data-type="indexterm" id="ix_05_machine_learning_-asciidoc9"/><a data-primary="index levels, predicting" data-type="indexterm" id="ix_05_machine_learning_-asciidoc10"/><a data-primary="linear regression" data-secondary="predicting index levels" data-type="indexterm" id="ix_05_machine_learning_-asciidoc11"/><a data-primary="market movement prediction" data-secondary="predicting index levels" data-type="indexterm" id="ix_05_machine_learning_-asciidoc12"/>The next step is to translate the basic approach to time series data for a real financial instrument, like the EUR/USD exchange rate:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO5-1" id="co_predicting_market_movements_with_machine_learning_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'</code><code class="s1">http://hilpisch.com/pyalgo_eikon_eod_data.csv</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO5-2" id="co_predicting_market_movements_with_machine_learning_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO5-2" id="co_predicting_market_movements_with_machine_learning_CO5-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">2516</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="n">to</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>&#13;
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">12</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">AAPL</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">MSFT</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">INTC</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">AMZN</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">GS</code><code class="o">.</code><code class="n">N</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">SPY</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">6</code><code>   </code><code class="o">.</code><code class="n">SPX</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">7</code><code>   </code><code class="o">.</code><code class="n">VIX</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">8</code><code>   </code><code class="n">EUR</code><code class="o">=</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">9</code><code>   </code><code class="n">XAU</code><code class="o">=</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">10</code><code>  </code><code class="n">GDX</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">11</code><code>  </code><code class="n">GLD</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">12</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">255.5</code><code> </code><code class="n">KB</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO5-3" id="co_predicting_market_movements_with_machine_learning_CO5-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="n">symbol</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO5-4" id="co_predicting_market_movements_with_machine_learning_CO5-5"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO5-1" id="callout_predicting_market_movements_with_machine_learning_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the <code>pandas</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO5-2" id="callout_predicting_market_movements_with_machine_learning_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Retrieves end-of-day (EOD) data and stores it in a <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO5-4" id="callout_predicting_market_movements_with_machine_learning_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The time series data for the specified symbol is selected from the original <code>DataFrame</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO5-5" id="callout_predicting_market_movements_with_machine_learning_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Renames the single column to <code>price</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Formally, the Python code from the preceding simple example hardly needs to be changed to implement the regression-based prediction approach. Just the data object needs to be replaced:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">5</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">lag_{lag}</code><code class="s1">'</code><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO6-1" id="co_predicting_market_movements_with_machine_learning_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">lstsq</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">rcond</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">0.98635864</code><code class="p">,</code><code>  </code><code class="mf">0.02292172</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">0.04769849</code><code class="p">,</code><code>  </code><code class="mf">0.05037365</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">0.01208135</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO6-1" id="callout_predicting_market_movements_with_machine_learning_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Takes the <code>price</code> column and shifts it by <code>lag</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="random walk hypothesis" data-type="indexterm" id="idm45785374463496"/>The optimal regression parameters illustrate what is typically called the <em>random walk hypothesis</em>. This hypothesis states that stock prices or exchange rates, for example, follow a random walk with the consequence that the best predictor for tomorrow’s price is today’s price. The optimal parameters seem to support such a hypothesis since today’s price almost completely explains the predicted price level for tomorrow. The four other values hardly have any weight assigned.</p>&#13;
&#13;
<p><a data-type="xref" href="#lr_plot_3">Figure 5-3</a> shows the EUR/USD exchange rate and the predicted values. Due to the sheer amount of data for the multi-year time window, the two time series are indistinguishable in the plot:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">reg</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO7-1" id="co_predicting_market_movements_with_machine_learning_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO7-2" id="co_predicting_market_movements_with_machine_learning_CO7-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist pagebreak-before">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO7-1" id="callout_predicting_market_movements_with_machine_learning_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the prediction values as the <code>dot</code> product.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO7-2" id="callout_predicting_market_movements_with_machine_learning_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Plots the <code>price</code> and <code>prediction</code> columns.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_3">&#13;
<img alt="pfat 0503" src="assets/pfat_0503.png"/>&#13;
<h6><span class="label">Figure 5-3. </span>EUR/USD exchange rate and predicted values based on linear regression (five lags)</h6>&#13;
</div></figure>&#13;
&#13;
<p>Zooming in by plotting the results for a much shorter time window allows one to better distinguish the two time series. <a data-type="xref" href="#lr_plot_4">Figure 5-4</a> shows the results for a three months time window. This plot illustrates that the prediction for tomorrow’s rate is roughly today’s rate. The prediction is more or less a shift of the original rate to the right by one trading day:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">30</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'price'</code><code class="p">,</code> <code class="s1">'prediction'</code><code class="p">]]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="s1">'2019-10-1'</code><code class="p">:]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code>&#13;
                     <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
<div data-type="note" epub:type="note">&#13;
<p>Applying linear OLS regression to predict rates for EUR/USD based on historical rates provides support for the random walk hypothesis. The results of the numerical example show that today’s rate is the best predictor for tomorrow’s rate in a least-squares sense.<a data-startref="ix_05_machine_learning_-asciidoc12" data-type="indexterm" id="idm45785374160568"/><a data-startref="ix_05_machine_learning_-asciidoc11" data-type="indexterm" id="idm45785374159960"/><a data-startref="ix_05_machine_learning_-asciidoc10" data-type="indexterm" id="idm45785374159320"/><a data-startref="ix_05_machine_learning_-asciidoc9" data-type="indexterm" id="idm45785374158680"/><a data-startref="ix_05_machine_learning_-asciidoc8" data-type="indexterm" id="idm45785374158040"/></p>&#13;
</div>&#13;
&#13;
<figure><div class="figure" id="lr_plot_4">&#13;
<img alt="pfat 0504" src="assets/pfat_0504.png"/>&#13;
<h6><span class="label">Figure 5-4. </span>EUR/USD exchange rate and predicted values based on linear regression (five lags, three months only)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Predicting Future Returns" data-type="sect2"><div class="sect2" id="idm45785374632840">&#13;
<h2>Predicting Future Returns</h2>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="predicting future returns" data-type="indexterm" id="ix_05_machine_learning_-asciidoc13"/><a data-primary="future returns, predicting" data-type="indexterm" id="ix_05_machine_learning_-asciidoc14"/><a data-primary="linear regression" data-secondary="predicting future returns" data-type="indexterm" id="ix_05_machine_learning_-asciidoc15"/><a data-primary="market movement prediction" data-secondary="predicting future returns" data-type="indexterm" id="ix_05_machine_learning_-asciidoc16"/><a data-primary="returns, predicting future" data-type="indexterm" id="ix_05_machine_learning_-asciidoc17"/>So far, the analysis is based on absolute rate levels. However, (log) returns might be a better choice for such statistical applications due to, for example, their characteristic of making the time series data stationary. The code to apply linear regression to the returns data is almost the same as before. This time it is not only today’s return that is relevant to predict tomorrow’s return, but the regression results are also completely different in nature:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                  </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO8-1" id="co_predicting_market_movements_with_machine_learning_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO8-2" id="co_predicting_market_movements_with_machine_learning_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">lag_{lag}</code><code class="s1">'</code><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO8-3" id="co_predicting_market_movements_with_machine_learning_CO8-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>             </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">lstsq</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">rcond</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="o">-</code><code class="mf">0.015689</code><code>  </code><code class="p">,</code><code>  </code><code class="mf">0.00890227</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">0.03634858</code><code class="p">,</code><code>  </code><code class="mf">0.01290924</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">0.00636023</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO8-1" id="callout_predicting_market_movements_with_machine_learning_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the log returns.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO8-2" id="callout_predicting_market_movements_with_machine_learning_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Deletes all lines with <code>NaN</code> values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO8-3" id="callout_predicting_market_movements_with_machine_learning_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Takes the <code>returns</code> column for the lagged data.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="xref" href="#lr_plot_5">Figure 5-5</a> shows the returns data and the prediction values. As the figure impressively illustrates, linear regression obviously cannot predict the magnitude of future returns to some significant extent:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">36</code><code class="p">]:</code> <code class="n">data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">reg</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">37</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'prediction'</code><code class="p">]]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="lr_plot_5">&#13;
<img alt="pfat 0505" src="assets/pfat_0505.png"/>&#13;
<h6><span class="label">Figure 5-5. </span>EUR/USD log returns and predicted values based on linear regression (five lags)</h6>&#13;
</div></figure>&#13;
&#13;
<p>From a trading point of view, one might argue that it is not the magnitude of the forecasted return that is relevant, but rather whether the direction is forecasted correctly or not. To this end, a simple calculation yields an overview. Whenever the linear regression gets the direction right, meaning that the sign of the forecasted return is correct, the product of the market return and the predicted return is positive and otherwise negative.</p>&#13;
&#13;
<p class="pagebreak-before">In the example case, the prediction is 1,250 times correct and 1,242 wrong, which translates into a hit ratio of about 49.9%, or almost exactly 50%:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                        </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO9-1" id="co_predicting_market_movements_with_machine_learning_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO9-2" id="co_predicting_market_movements_with_machine_learning_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1250</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="mf">1.0</code><code>    </code><code class="mi">1242</code><code>&#13;
</code><code>          </code><code class="mf">0.0</code><code>      </code><code class="mi">13</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code class="o">.</code><code class="n">values</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">hits</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO9-3" id="co_predicting_market_movements_with_machine_learning_CO9-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.499001996007984</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO9-1" id="callout_predicting_market_movements_with_machine_learning_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the product of the market and predicted return, takes the sign of the results and counts the values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO9-2" id="callout_predicting_market_movements_with_machine_learning_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Prints out the counts for the two possible values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO9-3" id="callout_predicting_market_movements_with_machine_learning_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the hit ratio defined as the number of correct predictions given all &#13;
<span class="keep-together">predictions</span>.<a data-startref="ix_05_machine_learning_-asciidoc17" data-type="indexterm" id="idm45785373704744"/><a data-startref="ix_05_machine_learning_-asciidoc16" data-type="indexterm" id="idm45785373703992"/><a data-startref="ix_05_machine_learning_-asciidoc15" data-type="indexterm" id="idm45785373703304"/><a data-startref="ix_05_machine_learning_-asciidoc14" data-type="indexterm" id="idm45785373702616"/><a data-startref="ix_05_machine_learning_-asciidoc13" data-type="indexterm" id="idm45785373701928"/></p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Predicting Future Market Direction" data-type="sect2"><div class="sect2" id="idm45785374154696">&#13;
<h2>Predicting Future Market Direction</h2>&#13;
&#13;
<p><a data-primary="linear regression" data-secondary="predicting future market direction" data-type="indexterm" id="idm45785373700376"/><a data-primary="market direction prediction" data-type="indexterm" id="idm45785373699336"/><a data-primary="market movement prediction" data-secondary="predicting future market direction" data-type="indexterm" id="idm45785373698648"/>The question that arises is whether one can improve on the hit ratio by directly implementing the linear regression based on the sign of the log returns that serve as the dependent variable values. In theory at least, this simplifies the problem from predicting an absolute return value to the sign of the return value. The only change in the Python code to implement this reasoning is to use the sign values (that is, <code>1.0</code> or <code>-1.0</code> in Python) for the regression step. This indeed increases the number of hits to 1,301 and the hit ratio to about 51.9%—an improvement of two percentage points:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">lstsq</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">rcond</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO10-1" id="co_predicting_market_movements_with_machine_learning_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="o">-</code><code class="mf">5.11938725</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">2.24077248</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">5.13080606</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">3.03753232</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">2.14819119</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">reg</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO10-2" id="co_predicting_market_movements_with_machine_learning_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1300</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="mf">1.0</code><code>    </code><code class="mi">1205</code><code>&#13;
</code><code>         </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">prediction</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                        </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1301</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="mf">1.0</code><code>    </code><code class="mi">1191</code><code>&#13;
</code><code>          </code><code class="mf">0.0</code><code>      </code><code class="mi">13</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code class="o">.</code><code class="n">values</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">hits</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5193612774451097</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO10-1" id="callout_predicting_market_movements_with_machine_learning_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This directly uses the sign of the return to be predicted for the regression.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO10-2" id="callout_predicting_market_movements_with_machine_learning_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Also, for the prediction step, only the sign is relevant.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Vectorized Backtesting of Regression-Based Strategy" data-type="sect2"><div class="sect2" id="idm45785373162664">&#13;
<h2>Vectorized Backtesting of Regression-Based Strategy</h2>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="vectorized backtesting of regression-based strategy" data-type="indexterm" id="idm45785373161288"/><a data-primary="linear regression" data-secondary="vectorized backtesting of regression-based strategy" data-type="indexterm" id="idm45785373160344"/><a data-primary="market movement prediction" data-secondary="vectorized backtesting of regression-based strategy" data-type="indexterm" id="idm45785373159432"/><a data-primary="vectorized backtesting" data-secondary="regression-based strategy" data-type="indexterm" id="idm45785373158552"/>The hit ratio alone does not tell too much about the economic potential of a trading strategy using linear regression in the way presented so far. It is well known that the ten best and worst days in the markets for a given period of time considerably influence the overall performance of investments.<sup><a data-type="noteref" href="ch05.html#idm45785373157144" id="idm45785373157144-marker">2</a></sup> In an ideal world, a long-short trader would try, of course, to benefit from both best and worst days by going long and short, respectively, on the basis of appropriate market timing indicators. Translated to the current context, this implies that, in addition to the hit ratio, the quality of the market timing matters. Therefore, a backtesting along the lines of the approach in <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter 4</a> can give a better picture of the value of regression for prediction.</p>&#13;
&#13;
<p>Given the data that is already available, vectorized backtesting boils down to two lines of Python code including visualization. This is due to the fact that the prediction values already reflect the market positions (long or short). <a data-type="xref" href="#lr_plot_6">Figure 5-6</a> shows that, in-sample, the strategy under the current assumptions outperforms the market significantly (ignoring, among other things, transaction costs):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">price</code><code>     </code><code class="n">lag_1</code><code>     </code><code class="n">lag_2</code><code>     </code><code class="n">lag_3</code><code>     </code><code class="n">lag_4</code><code>     </code><code class="n">lag_5</code><code>  </code><code>\&#13;
</code><code>         </code><code class="n">Date</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">20</code><code>  </code><code class="mf">1.4101</code><code> </code><code class="o">-</code><code class="mf">0.005858</code><code> </code><code class="o">-</code><code class="mf">0.008309</code><code> </code><code class="o">-</code><code class="mf">0.000551</code><code>  </code><code class="mf">0.001103</code><code> </code><code class="o">-</code><code class="mf">0.001310</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">21</code><code>  </code><code class="mf">1.4090</code><code> </code><code class="o">-</code><code class="mf">0.013874</code><code> </code><code class="o">-</code><code class="mf">0.005858</code><code> </code><code class="o">-</code><code class="mf">0.008309</code><code> </code><code class="o">-</code><code class="mf">0.000551</code><code>  </code><code class="mf">0.001103</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">22</code><code>  </code><code class="mf">1.4137</code><code> </code><code class="o">-</code><code class="mf">0.000780</code><code> </code><code class="o">-</code><code class="mf">0.013874</code><code> </code><code class="o">-</code><code class="mf">0.005858</code><code> </code><code class="o">-</code><code class="mf">0.008309</code><code> </code><code class="o">-</code><code class="mf">0.000551</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">25</code><code>  </code><code class="mf">1.4150</code><code>  </code><code class="mf">0.003330</code><code> </code><code class="o">-</code><code class="mf">0.000780</code><code> </code><code class="o">-</code><code class="mf">0.013874</code><code> </code><code class="o">-</code><code class="mf">0.005858</code><code> </code><code class="o">-</code><code class="mf">0.008309</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">26</code><code>  </code><code class="mf">1.4073</code><code>  </code><code class="mf">0.000919</code><code>  </code><code class="mf">0.003330</code><code> </code><code class="o">-</code><code class="mf">0.000780</code><code> </code><code class="o">-</code><code class="mf">0.013874</code><code> </code><code class="o">-</code><code class="mf">0.005858</code><code>&#13;
</code><code>&#13;
</code><code>                     </code><code class="n">prediction</code><code>    </code><code class="k">return</code><code>&#13;
</code><code>         </code><code class="n">Date</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">20</code><code>         </code><code class="mf">1.0</code><code> </code><code class="o">-</code><code class="mf">0.013874</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">21</code><code>         </code><code class="mf">1.0</code><code> </code><code class="o">-</code><code class="mf">0.000780</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">22</code><code>         </code><code class="mf">1.0</code><code>  </code><code class="mf">0.003330</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">25</code><code>         </code><code class="mf">1.0</code><code>  </code><code class="mf">0.000919</code><code>&#13;
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">26</code><code>         </code><code class="mf">1.0</code><code> </code><code class="o">-</code><code class="mf">0.005457</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO11-1" id="co_predicting_market_movements_with_machine_learning_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO11-2" id="co_predicting_market_movements_with_machine_learning_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>      </code><code class="mf">0.784026</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">1.654154</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO11-3" id="co_predicting_market_movements_with_machine_learning_CO11-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO11-1" id="callout_predicting_market_movements_with_machine_learning_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Multiplies the prediction values (positionings) by the market returns.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO11-2" id="callout_predicting_market_movements_with_machine_learning_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the gross performance of the base instrument and the strategy.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO11-3" id="callout_predicting_market_movements_with_machine_learning_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the gross performance of the base instrument and the strategy over time (in-sample, no transaction costs).</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_6">&#13;
<img alt="pfat 0506" src="assets/pfat_0506.png"/>&#13;
<h6><span class="label">Figure 5-6. </span>Gross performance of EUR/USD and the regression-based strategy (five lags)</h6>&#13;
</div></figure>&#13;
<div data-type="caution">&#13;
<p>The hit ratio of a prediction-based strategy is only one side of the coin when it comes to overall strategy performance. The other side is how well the strategy gets the market timing right. A strategy correctly predicting the best and worst days over a certain period of time might outperform the market even with a hit ratio below 50%. On the other hand, a strategy with a hit ratio well above 50% might still underperform the base instrument if it gets the rare, large movements wrong.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generalizing the Approach" data-type="sect2"><div class="sect2" id="idm45785373026424">&#13;
<h2>Generalizing the Approach</h2>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="evaluation of regression-based strategy" data-type="indexterm" id="idm45785373024984"/><a data-primary="linear regression" data-secondary="generalizing the approach" data-type="indexterm" id="idm45785373056168"/><a data-type="xref" href="#lr_vector_backtester">“Linear Regression Backtesting Class”</a> presents a Python module containing a class for the vectorized backtesting of the regression-based trading strategy in the spirit of <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter 4</a>. In addition to allowing for an arbitrary amount to invest and proportional transaction costs, <a data-primary="in-sample fitting" data-type="indexterm" id="idm45785373053352"/><a data-primary="out-of-sample evaluation" data-type="indexterm" id="idm45785373052680"/>it allows the <em>in-sample fitting</em> of the linear regression model and the <em>out-of-sample evaluation</em>. This means that the regression model is fitted based on one part of the data set, say for the years 2010 to 2015, and is evaluated based on another part of the data set, say for the years 2016 and 2019. For all strategies that involve an optimization or fitting step, this provides a more realistic view on the performance in practice since it helps avoid the problems arising from data snooping and the overfitting of models (see also <a data-type="xref" href="ch04.html#data_snooping">“Data Snooping and Overfitting”</a>).</p>&#13;
&#13;
<p><a data-type="xref" href="#lr_plot_7">Figure 5-7</a> shows that the regression-based strategy based on five lags does outperform the EUR/USD base instrument for the particular configuration also out-of-sample and before accounting for transaction costs:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">LRVectorBacktester</code><code> </code><code class="kn">as</code><code> </code><code class="nn">LR</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO12-1" id="co_predicting_market_movements_with_machine_learning_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code> </code><code class="o">=</code><code> </code><code class="n">LR</code><code class="o">.</code><code class="n">LRVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                              </code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mf">0.0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO12-2" id="co_predicting_market_movements_with_machine_learning_CO12-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO12-3" id="co_predicting_market_movements_with_machine_learning_CO12-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">17166.53</code><code class="p">,</code><code> </code><code class="mf">9442.42</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2017-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="s1">'</code><code class="s1">2018-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO12-4" id="co_predicting_market_movements_with_machine_learning_CO12-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">10160.86</code><code class="p">,</code><code> </code><code class="mf">791.87</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO12-5" id="co_predicting_market_movements_with_machine_learning_CO12-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO12-1" id="callout_predicting_market_movements_with_machine_learning_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the module as <code>LR</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO12-2" id="callout_predicting_market_movements_with_machine_learning_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates an object of the <code>LRVectorBacktester</code> class.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO12-3" id="callout_predicting_market_movements_with_machine_learning_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Trains and evaluates the strategy on the same data set.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO12-4" id="callout_predicting_market_movements_with_machine_learning_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Uses two different data sets for the training and evaluation steps.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO12-5" id="callout_predicting_market_movements_with_machine_learning_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Plots the out of sample strategy performance compared to the market.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_7">&#13;
<img alt="pfat 0507" src="assets/pfat_0507.png"/>&#13;
<h6><span class="label">Figure 5-7. </span>Gross performance of EUR/USD and the regression-based strategy (five lags, out-of-sample, before transaction costs)</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="GDX (VanEck Vectors Gold Miners ETF)" data-secondary="regression-based strategies" data-type="indexterm" id="idm45785372355160"/>Consider the <code>GDX</code> ETF. The strategy configuration chosen shows an outperformance out-of-sample and after taking transaction costs into account (see <a data-type="xref" href="#lr_plot_8">Figure 5-8</a>):<a data-startref="ix_05_machine_learning_-asciidoc3" data-type="indexterm" id="idm45785372352584"/><a data-startref="ix_05_machine_learning_-asciidoc2" data-type="indexterm" id="idm45785372351864"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code> </code><code class="o">=</code><code> </code><code class="n">LR</code><code class="o">.</code><code class="n">LRVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">GDX</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                              </code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mf">0.002</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO13-1" id="co_predicting_market_movements_with_machine_learning_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="o">=</code><code class="mi">7</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">23642.32</code><code class="p">,</code><code> </code><code class="mf">17649.69</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2014-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="s1">'</code><code class="s1">2015-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lags</code><code class="o">=</code><code class="mi">7</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">28513.35</code><code class="p">,</code><code> </code><code class="mf">14888.41</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lrbt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO13-1" id="callout_predicting_market_movements_with_machine_learning_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Changes to the time series data for <code>GDX</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="lr_plot_8">&#13;
<img alt="pfat 0508" src="assets/pfat_0508.png"/>&#13;
<h6><span class="label">Figure 5-8. </span>Gross performance of the <code>GDX</code> ETF and the regression-based strategy (seven lags, out-of-sample, after transaction costs)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Machine Learning for Market Movement Prediction" data-type="sect1"><div class="sect1" id="machine_learning_scikit">&#13;
<h1>Using Machine Learning for Market Movement Prediction</h1>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="market movement prediction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc18"/><a data-primary="market movement prediction" data-secondary="machine learning for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc19"/>Nowadays, the Python ecosystem provides a number of packages in the machine learning field. The most popular of these is <code>scikit-learn</code> (see <a href="http://scikit-learn.org"><code>scikit-learn</code> home page</a>), which is also one of the best documented and maintained packages. This section first introduces the API of the package based on linear regression, replicating some of the results of the previous section. It then goes on to use logistic regression as a classification algorithm to attack the problem of predicting the future market &#13;
<span class="keep-together">direction.</span></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Linear Regression with scikit-learn" data-type="sect2"><div class="sect2" id="idm45785372606408">&#13;
<h2>Linear Regression with scikit-learn</h2>&#13;
&#13;
<p><a data-primary="linear regression" data-secondary="scikit-learn and" data-type="indexterm" id="idm45785372604840"/><a data-primary="machine learning" data-secondary="linear regression with scikit-learn" data-type="indexterm" id="idm45785372603864"/><a data-primary="market movement prediction" data-secondary="linear regression with scikit-learn" data-type="indexterm" id="idm45785372602904"/><a data-primary="scikit-learn" data-type="indexterm" id="idm45785372601928"/>To introduce the <code>scikit-learn</code> API, revisiting the basic idea behind the prediction approach presented in this chapter is fruitful. Data preparation is the same as with <code>NumPy</code> only:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">61</code><code class="p">]:</code> <code class="n">x</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="mi">12</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">62</code><code class="p">]:</code> <code class="n">x</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">62</code><code class="p">]:</code> <code class="n">array</code><code class="p">([</code> <code class="mi">0</code><code class="p">,</code>  <code class="mi">1</code><code class="p">,</code>  <code class="mi">2</code><code class="p">,</code>  <code class="mi">3</code><code class="p">,</code>  <code class="mi">4</code><code class="p">,</code>  <code class="mi">5</code><code class="p">,</code>  <code class="mi">6</code><code class="p">,</code>  <code class="mi">7</code><code class="p">,</code>  <code class="mi">8</code><code class="p">,</code>  <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">11</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">63</code><code class="p">]:</code> <code class="n">lags</code> <code class="o">=</code> <code class="mi">3</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">64</code><code class="p">]:</code> <code class="n">m</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">((</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-</code> <code class="n">lags</code><code class="p">))</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">65</code><code class="p">]:</code> <code class="n">m</code><code class="p">[</code><code class="n">lags</code><code class="p">]</code> <code class="o">=</code> <code class="n">x</code><code class="p">[</code><code class="n">lags</code><code class="p">:]</code>&#13;
         <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">lags</code><code class="p">):</code>&#13;
             <code class="n">m</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="o">=</code> <code class="n">x</code><code class="p">[</code><code class="n">i</code><code class="p">:</code><code class="n">i</code> <code class="o">-</code> <code class="n">lags</code><code class="p">]</code></pre>&#13;
&#13;
<p>Using <code>scikit-learn</code> for our purposes mainly consists of three steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p><em>Model selection</em>: a model is to be picked and instantiated.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Model fitting</em>: the model is to be fitted to the data at hand.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Prediction</em>: given the fitted model, the prediction is conducted.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>To apply linear regression, this translates into the following code that makes use of the <code>linear_model</code> sub-package for generalized linear models (see <a href="https://oreil.ly/5XoG1"><code>scikit-learn</code> linear models page</a>). By default, the <code>LinearRegression</code> model fits an intercept value:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn</code><code> </code><code class="kn">import</code><code> </code><code class="n">linear_model</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-1" id="co_predicting_market_movements_with_machine_learning_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code> </code><code class="o">=</code><code> </code><code class="n">linear_model</code><code class="o">.</code><code class="n">LinearRegression</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-2" id="co_predicting_market_movements_with_machine_learning_CO14-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">,</code><code> </code><code class="n">m</code><code class="p">[</code><code class="n">lags</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-3" id="co_predicting_market_movements_with_machine_learning_CO14-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">LinearRegression</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">coef_</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-4" id="co_predicting_market_movements_with_machine_learning_CO14-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">0.33333333</code><code class="p">,</code><code> </code><code class="mf">0.33333333</code><code class="p">,</code><code> </code><code class="mf">0.33333333</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">intercept_</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-5" id="co_predicting_market_movements_with_machine_learning_CO14-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">2.0</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO14-6" id="co_predicting_market_movements_with_machine_learning_CO14-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">,</code><code> </code><code class="mf">11.</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-1" id="callout_predicting_market_movements_with_machine_learning_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the generalized linear model classes.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-2" id="callout_predicting_market_movements_with_machine_learning_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates a linear regression model.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-3" id="callout_predicting_market_movements_with_machine_learning_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Fits the model to the data.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-4" id="callout_predicting_market_movements_with_machine_learning_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Prints out the optimal regression parameters.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-5" id="callout_predicting_market_movements_with_machine_learning_CO14-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Prints out the intercept values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO14-6" id="callout_predicting_market_movements_with_machine_learning_CO14-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Predicts the sought after values given the fitted model.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Setting the parameter <code>fit_intercept</code> to <code>False</code> gives the exact same regression results as with <code>NumPy</code> and <code>polyfit()</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code> </code><code class="o">=</code><code> </code><code class="n">linear_model</code><code class="o">.</code><code class="n">LinearRegression</code><code class="p">(</code><code class="n">fit_intercept</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO15-1" id="co_predicting_market_movements_with_machine_learning_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">,</code><code> </code><code class="n">m</code><code class="p">[</code><code class="n">lags</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">LinearRegression</code><code class="p">(</code><code class="n">fit_intercept</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">coef_</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="o">-</code><code class="mf">0.66666667</code><code class="p">,</code><code>  </code><code class="mf">0.33333333</code><code class="p">,</code><code>  </code><code class="mf">1.33333333</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">intercept_</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.0</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">m</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code class="o">.</code><code class="n">T</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">3.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">5.</code><code class="p">,</code><code>  </code><code class="mf">6.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code>  </code><code class="mf">8.</code><code class="p">,</code><code>  </code><code class="mf">9.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">,</code><code> </code><code class="mf">11.</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO15-1" id="callout_predicting_market_movements_with_machine_learning_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Forces a fit without intercept value.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This example already illustrates quite well how to apply <code>scikit-learn</code> to the  prediction problem. Due to its consistent API design, the basic approach carries over to other models, as well.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Simple Classification Problem" data-type="sect2"><div class="sect2" id="idm45785372605784">&#13;
<h2>A Simple Classification Problem</h2>&#13;
&#13;
<p><a data-primary="classification problems" data-secondary="machine learning for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc20"/><a data-primary="machine learning" data-secondary="classification problem" data-type="indexterm" id="ix_05_machine_learning_-asciidoc21"/>In a classification problem, it has to be decided to which of a limited set of categories (“classes”) a new observation belongs. A classical problem studied in machine learning is the identification of handwritten digits from 0 to 9. Such an identification leads to a correct result, say 3. Or it leads to a wrong result, say 6 or 8, where all such wrong results are equally wrong. In a financial market context, predicting the price of a financial instrument can lead to a numerical result that is far off the correct one or that is quite close to it. Predicting tomorrow’s market direction, there can only be a correct or a (“completely”) wrong result. The latter is a <em>classification problem</em> with the set of categories limited to, for example, “up” and “down” or “+1” and “–1” or “1” and “0.” By contrast, the former problem is an <em>estimation problem</em>.</p>&#13;
&#13;
<p>A simple example for a classification problem is found on Wikipedia under <a href="https://oreil.ly/zg8gW">Logistic Regression</a>. The data set relates the number of hours studied to prepare for an exam by a number of students to the success of each student in passing the exam or not. While the number of hours studied is a real number (<code>float</code> object), the passing of the exam is either <code>True</code> or <code>False</code> (that is, <code>1</code> or <code>0</code> in numbers). <a data-type="xref" href="#ml_plot_1">Figure 5-9</a> shows the data graphically:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hours</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mf">0.75</code><code class="p">,</code><code> </code><code class="mf">1.</code><code class="p">,</code><code> </code><code class="mf">1.25</code><code class="p">,</code><code> </code><code class="mf">1.5</code><code class="p">,</code><code> </code><code class="mf">1.75</code><code class="p">,</code><code> </code><code class="mf">1.75</code><code class="p">,</code><code> </code><code class="mf">2.</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="mf">2.25</code><code class="p">,</code><code> </code><code class="mf">2.5</code><code class="p">,</code><code> </code><code class="mf">2.75</code><code class="p">,</code><code> </code><code class="mf">3.</code><code class="p">,</code><code> </code><code class="mf">3.25</code><code class="p">,</code><code> </code><code class="mf">3.5</code><code class="p">,</code><code> </code><code class="mf">4.</code><code class="p">,</code><code> </code><code class="mf">4.25</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="mf">4.5</code><code class="p">,</code><code> </code><code class="mf">4.75</code><code class="p">,</code><code> </code><code class="mf">5.</code><code class="p">,</code><code> </code><code class="mf">5.5</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO16-1" id="co_predicting_market_movements_with_machine_learning_CO16-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">success</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code>&#13;
</code><code>                             </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO16-2" id="co_predicting_market_movements_with_machine_learning_CO16-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">ro</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO16-3" id="co_predicting_market_movements_with_machine_learning_CO16-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="o">-</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">1.2</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO16-4" id="co_predicting_market_movements_with_machine_learning_CO16-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO16-1" id="callout_predicting_market_movements_with_machine_learning_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The number of hours studied by the different students (sequence matters).</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO16-2" id="callout_predicting_market_movements_with_machine_learning_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The success of each student in passing the exam (sequence matters).</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO16-3" id="callout_predicting_market_movements_with_machine_learning_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the data set taking <code>hours</code> as <code>x</code> values and <code>success</code> as <code>y</code> values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO16-4" id="callout_predicting_market_movements_with_machine_learning_CO16-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Adjusts the limits of the y-axis.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_1">&#13;
<img alt="pfat 0509" src="assets/pfat_0509.png"/>&#13;
<h6><span class="label">Figure 5-9. </span>Example data for classification problem</h6>&#13;
</div></figure>&#13;
&#13;
<p>The basic question typically raised in a such a context is: given a certain number of hours studied by a student (not in the data set), will they pass the exam or not? What answer could linear regression give? Probably not one that is satisfying, as <a data-type="xref" href="#ml_plot_2">Figure 5-10</a> shows. Given different numbers of hours studied, linear regression gives (prediction) values mainly between 0 and 1, as well as lower and higher. But there can only be <em>failure</em> or <em>success</em> as the outcome of taking the exam:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">80</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">reg</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">polyfit</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">,</code><code> </code><code class="n">deg</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO17-1" id="co_predicting_market_movements_with_machine_learning_CO17-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">81</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">ro</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">reg</code><code class="p">,</code><code> </code><code class="n">hours</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO17-2" id="co_predicting_market_movements_with_machine_learning_CO17-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="o">-</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">1.2</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO17-1" id="callout_predicting_market_movements_with_machine_learning_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implements a linear regression on the data set.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO17-2" id="callout_predicting_market_movements_with_machine_learning_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Plots the regression line in addition to the data set.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_2">&#13;
<img alt="pfat 0510" src="assets/pfat_0510.png"/>&#13;
<h6><span class="label">Figure 5-10. </span>Linear regression applied to the classification problem</h6>&#13;
</div></figure>&#13;
&#13;
<p>This is where classification algorithms, like logistic regression and support vector machines, come into play. For illustration, the application of logistic regression suffices (see James et al. (2013, ch. 4) for more background information).&#13;
The respective class is also found in the <code>linear_model</code> sub-package. <a data-type="xref" href="#ml_plot_3">Figure 5-11</a> shows the result of the following Python code. This time, there is a clear cut (prediction) value for every different input value. The model predicts that students who studied for 0 to 2 hours will fail.&#13;
For all values equal to or higher than 2.75 hours, the model predicts that a student passes the exam:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">82</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code> </code><code class="o">=</code><code> </code><code class="n">linear_model</code><code class="o">.</code><code class="n">LogisticRegression</code><code class="p">(</code><code class="n">solver</code><code class="o">=</code><code class="s1">'</code><code class="s1">lbfgs</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO18-1" id="co_predicting_market_movements_with_machine_learning_CO18-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">83</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hrs</code><code> </code><code class="o">=</code><code> </code><code class="n">hours</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code class="o">.</code><code class="n">T</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO18-2" id="co_predicting_market_movements_with_machine_learning_CO18-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">hrs</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO18-3" id="co_predicting_market_movements_with_machine_learning_CO18-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">LogisticRegression</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">85</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">prediction</code><code> </code><code class="o">=</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">hrs</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO18-4" id="co_predicting_market_movements_with_machine_learning_CO18-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">86</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">ro</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">prediction</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="o">-</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">1.2</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist pagebreak-before">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO18-1" id="callout_predicting_market_movements_with_machine_learning_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates the logistic regression model.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO18-2" id="callout_predicting_market_movements_with_machine_learning_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Reshapes the one-dimensional <code>ndarray</code> object to a two-dimensional one (required by <code>scikit-learn</code>).</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO18-3" id="callout_predicting_market_movements_with_machine_learning_CO18-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Implements the fitting step.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO18-4" id="callout_predicting_market_movements_with_machine_learning_CO18-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Implements the prediction step given the fitted model.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_3">&#13;
<img alt="pfat 0511" src="assets/pfat_0511.png"/>&#13;
<h6><span class="label">Figure 5-11. </span>Logistic regression applied to the classification problem</h6>&#13;
</div></figure>&#13;
&#13;
<p>However, as <a data-type="xref" href="#ml_plot_3">Figure 5-11</a> shows, there is no guarantee that 2.75 hours or more lead to success. It is just “more probable” to succeed from that many hours on than to fail. This probabilistic reasoning can also be analyzed and visualized based on the same model instance, as the following code illustrates. The dashed line in <a data-type="xref" href="#ml_plot_4">Figure 5-12</a> shows the probability for succeeding (monotonically increasing). The dash-dotted line shows the probability for failing (monotonically decreasing):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">87</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">prob</code><code> </code><code class="o">=</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict_proba</code><code class="p">(</code><code class="n">hrs</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO19-1" id="co_predicting_market_movements_with_machine_learning_CO19-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">88</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">success</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">ro</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">prediction</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">prob</code><code class="o">.</code><code class="n">T</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">m--</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$p(h)$ for zero</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO19-2" id="co_predicting_market_movements_with_machine_learning_CO19-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">hours</code><code class="p">,</code><code> </code><code class="n">prob</code><code class="o">.</code><code class="n">T</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">g-.</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$p(h)$ for one</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO19-3" id="co_predicting_market_movements_with_machine_learning_CO19-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="o">-</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">1.2</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO19-1" id="callout_predicting_market_movements_with_machine_learning_CO19-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Predicts probabilities for succeeding and failing, respectively.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO19-2" id="callout_predicting_market_movements_with_machine_learning_CO19-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Plots the probabilities for failing.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO19-3" id="callout_predicting_market_movements_with_machine_learning_CO19-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the probabilities for succeeding.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_4">&#13;
<img alt="pfat 0512" src="assets/pfat_0512.png"/>&#13;
<h6><span class="label">Figure 5-12. </span>Probabilities for succeeding and failing, respectively, based on logistic &#13;
<span class="keep-together">regression</span></h6>&#13;
</div></figure>&#13;
<div data-type="tip">&#13;
<p><code>scikit-learn</code> does a good job of providing access to a great variety of machine learning models in a unified way. The examples show that the API for applying logistic regression does not differ from the one for linear regression. <code>scikit-learn</code>, therefore, is well suited to test a number of appropriate machine learning models in a certain application scenario without altering the Python code very much.</p>&#13;
</div>&#13;
&#13;
<p>Equipped with the basics, the next step is to apply logistic regression to the problem of predicting market direction.<a data-startref="ix_05_machine_learning_-asciidoc21" data-type="indexterm" id="idm45785370898808"/><a data-startref="ix_05_machine_learning_-asciidoc20" data-type="indexterm" id="idm45785370898136"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Using Logistic Regression to Predict Market Direction" data-type="sect2"><div class="sect2" id="idm45785371734872">&#13;
<h2>Using Logistic Regression to Predict Market Direction</h2>&#13;
&#13;
<p><a data-primary="logistic regression" data-secondary="market direction prediction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc22"/><a data-primary="machine learning" data-secondary="using logistic regression to predict market direction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc23"/><a data-primary="market movement prediction" data-secondary="logistic regression to predict market direction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc24"/>In machine learning, one <a data-primary="features" data-secondary="lags and" data-type="indexterm" id="idm45785370887960"/>generally speaks of <em>features</em> instead of <em>independent</em> or <em>explanatory variables</em> as in a regression context. The simple classification example has a single feature only: the number of hours studied. In practice, one often has more than one feature that can be used for classification. <a data-primary="lags" data-type="indexterm" id="idm45785370885352"/>Given the prediction approach introduced in this chapter, one can identify a <em>feature</em> by a <em>lag</em>. Therefore, working with three lags from the time series data means that there are three features. As possible outcomes or categories, there are only <code>+1</code> and <code>-1</code> for an upwards and a downwards movement, respectively. Although the wording changes, the formalism stays the same, particularly with regard to deriving the matrix, now called the <em>feature matrix</em>.</p>&#13;
&#13;
<p>The following code presents an alternative to creating a <code>pandas</code> <code>DataFrame</code> based “feature matrix” to which the three step procedure applies equally well—if not in a more Pythonic fashion. The feature matrix now is a sub-set of the columns in the original data set:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">89</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">GLD</code><code class="s1">'</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">90</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">91</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="n">symbol</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">92</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">93</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">94</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">3</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">95</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO20-1" id="co_predicting_market_movements_with_machine_learning_CO20-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">lag_{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO20-2" id="co_predicting_market_movements_with_machine_learning_CO20-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO20-3" id="co_predicting_market_movements_with_machine_learning_CO20-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>             </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO20-4" id="co_predicting_market_movements_with_machine_learning_CO20-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">96</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO20-5" id="co_predicting_market_movements_with_machine_learning_CO20-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO20-1" id="callout_predicting_market_movements_with_machine_learning_CO20-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates an empty <code>list</code> object to collect column names.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO20-2" id="callout_predicting_market_movements_with_machine_learning_CO20-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates a <code>str</code> object for the column name.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO20-3" id="callout_predicting_market_movements_with_machine_learning_CO20-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Adds a new column to the <code>DataFrame</code> object with the respective lag data.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO20-4" id="callout_predicting_market_movements_with_machine_learning_CO20-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Appends the column name to the <code>list</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO20-5" id="callout_predicting_market_movements_with_machine_learning_CO20-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Makes sure that the data set is complete.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Logistic regression improves the hit ratio compared to linear regression by more than a percentage point to about 54.5%. <a data-primary="GLD (SPDR Gold Shares)" data-secondary="logistic regression-based strategies" data-type="indexterm" id="ix_05_machine_learning_-asciidoc25"/><a data-type="xref" href="#ml_plot_5">Figure 5-13</a> shows the performance of the strategy based on logistic regression-based predictions. Although the hit ratio is higher, the performance is worse than with linear regression:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">97</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn.metrics</code><code> </code><code class="kn">import</code><code> </code><code class="n">accuracy_score</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">98</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code> </code><code class="o">=</code><code> </code><code class="n">linear_model</code><code class="o">.</code><code class="n">LogisticRegression</code><code class="p">(</code><code class="n">C</code><code class="o">=</code><code class="mf">1e7</code><code class="p">,</code><code> </code><code class="n">solver</code><code class="o">=</code><code class="s1">'</code><code class="s1">lbfgs</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                              </code><code class="n">multi_class</code><code class="o">=</code><code class="s1">'</code><code class="s1">auto</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                              </code><code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-1" id="co_predicting_market_movements_with_machine_learning_CO21-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">99</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-2" id="co_predicting_market_movements_with_machine_learning_CO21-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">99</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">LogisticRegression</code><code class="p">(</code><code class="n">C</code><code class="o">=</code><code class="mf">10000000.0</code><code class="p">,</code><code> </code><code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">100</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-3" id="co_predicting_market_movements_with_machine_learning_CO21-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">101</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-4" id="co_predicting_market_movements_with_machine_learning_CO21-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">101</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1983</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">1.0</code><code>     </code><code class="mi">529</code><code>&#13;
</code><code>          </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">prediction</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">102</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code>&#13;
</code><code>                        </code><code class="p">)</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-5" id="co_predicting_market_movements_with_machine_learning_CO21-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1338</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">1.0</code><code>    </code><code class="mi">1159</code><code>&#13;
</code><code>           </code><code class="mf">0.0</code><code>      </code><code class="mi">12</code><code>&#13;
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">104</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">accuracy_score</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                         </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-6" id="co_predicting_market_movements_with_machine_learning_CO21-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">104</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5338375796178344</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">105</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-7" id="co_predicting_market_movements_with_machine_learning_CO21-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">106</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-7" id="co_predicting_market_movements_with_machine_learning_CO21-8"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">106</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>      </code><code class="mf">1.289478</code><code>&#13;
</code><code>          </code><code class="n">strategy</code><code>    </code><code class="mf">2.458716</code><code>&#13;
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">107</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code>&#13;
</code><code>                                                  </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO21-8" id="co_predicting_market_movements_with_machine_learning_CO21-9"><img alt="8" src="assets/8.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-1" id="callout_predicting_market_movements_with_machine_learning_CO21-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates the model object using a <code>C</code> value that gives less weight to the regularization term (see the <a href="https://oreil.ly/D819h">Generalized Linear Models page</a>).</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-2" id="callout_predicting_market_movements_with_machine_learning_CO21-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Fits the model based on the sign of the returns to be predicted.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-3" id="callout_predicting_market_movements_with_machine_learning_CO21-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generates a new column in the <code>DataFrame</code> object and writes the prediction values to it.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-4" id="callout_predicting_market_movements_with_machine_learning_CO21-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Shows the number of the resulting long and short positions, respectively.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-5" id="callout_predicting_market_movements_with_machine_learning_CO21-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Calculates the number of correct and wrong predictions.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-6" id="callout_predicting_market_movements_with_machine_learning_CO21-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The accuracy (hit ratio) is 53.3% in this case.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-7" id="callout_predicting_market_movements_with_machine_learning_CO21-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>However, the gross performance of the strategy…</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO21-9" id="callout_predicting_market_movements_with_machine_learning_CO21-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>…is much higher when compared with the passive benchmark investment.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_5">&#13;
<img alt="pfat 0513" src="assets/pfat_0513.png"/>&#13;
<h6><span class="label">Figure 5-13. </span>Gross performance of <code>GLD</code> ETF and the logistic regression-based strategy (3 lags, in-sample)</h6>&#13;
</div></figure>&#13;
&#13;
<p>Increasing the number of lags used from three to five decreases the hit ratio but improves the gross performance of the strategy to some extent (in-sample, before transaction costs). <a data-type="xref" href="#ml_plot_6">Figure 5-14</a> shows the resulting performance:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">108</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">109</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="n">symbol</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">110</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">111</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">5</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">112</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>          </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">lag_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">lag</code><code>&#13;
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-1" id="co_predicting_market_movements_with_machine_learning_CO22-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>              </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">113</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">114</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-2" id="co_predicting_market_movements_with_machine_learning_CO22-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">114</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">LogisticRegression</code><code class="p">(</code><code class="n">C</code><code class="o">=</code><code class="mf">10000000.0</code><code class="p">,</code><code> </code><code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">115</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">116</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-3" id="co_predicting_market_movements_with_machine_learning_CO22-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">116</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">2047</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">1.0</code><code>     </code><code class="mi">464</code><code>&#13;
</code><code>          </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">prediction</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">117</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code>&#13;
</code><code>                        </code><code class="p">)</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">118</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hits</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">118</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mf">1.0</code><code>    </code><code class="mi">1331</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="mf">1.0</code><code>    </code><code class="mi">1163</code><code>&#13;
</code><code>           </code><code class="mf">0.0</code><code>      </code><code class="mi">12</code><code>&#13;
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">119</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">accuracy_score</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                         </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-4" id="co_predicting_market_movements_with_machine_learning_CO22-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">119</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5312624452409399</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">120</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-5" id="co_predicting_market_movements_with_machine_learning_CO22-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">121</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO22-5" id="co_predicting_market_movements_with_machine_learning_CO22-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">121</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>      </code><code class="mf">1.283110</code><code>&#13;
</code><code>          </code><code class="n">strategy</code><code>    </code><code class="mf">2.656833</code><code>&#13;
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">122</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code>&#13;
</code><code>                                                  </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO22-1" id="callout_predicting_market_movements_with_machine_learning_CO22-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Increases the number of lags to five.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO22-2" id="callout_predicting_market_movements_with_machine_learning_CO22-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Fits the model based on five lags.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO22-3" id="callout_predicting_market_movements_with_machine_learning_CO22-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>There are now significantly more short positions with the new parametrization.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO22-4" id="callout_predicting_market_movements_with_machine_learning_CO22-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The accuracy (hit ratio) decreases to 53.1%.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO22-5" id="callout_predicting_market_movements_with_machine_learning_CO22-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The cumulative performance also increases significantly.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="ml_plot_6">&#13;
<img alt="pfat 0514" src="assets/pfat_0514.png"/>&#13;
<h6><span class="label">Figure 5-14. </span>Gross performance of <code>GLD</code> ETF and the logistic regression-based strategy (five lags, in-sample)</h6>&#13;
</div></figure>&#13;
<div data-type="caution">&#13;
<p>You have to be careful to not fall into the overfitting trap here. A more realistic picture is obtained by an approach that uses <em>training data</em> (= in-sample data) for the <em>fitting</em> of the model and <em>test data</em> (= out-of-sample data) for the <em>evaluation</em> of the strategy performance.<a data-startref="ix_05_machine_learning_-asciidoc25" data-type="indexterm" id="idm45785369582504"/> This is done in the following section, when the approach is generalized again in the form of a Python class.<a data-startref="ix_05_machine_learning_-asciidoc24" data-type="indexterm" id="idm45785369581576"/><a data-startref="ix_05_machine_learning_-asciidoc23" data-type="indexterm" id="idm45785369580936"/><a data-startref="ix_05_machine_learning_-asciidoc22" data-type="indexterm" id="idm45785369648328"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generalizing the Approach" data-type="sect2"><div class="sect2" id="idm45785370897240">&#13;
<h2>Generalizing the Approach</h2>&#13;
&#13;
<p><a data-primary="logistic regression" data-secondary="generalizing the approach" data-type="indexterm" id="ix_05_machine_learning_-asciidoc26"/><a data-type="xref" href="#sci_vector_backtester">“Classification Algorithm Backtesting Class”</a> presents a Python module with a class for the vectorized backtesting of strategies based on linear models from <code>scikit-learn</code>. Although only linear and logistic regression are implemented, the number of models is easily increased.&#13;
In principle, the <code>ScikitVectorBacktester</code> class could inherit selected methods from the <code>LRVectorBacktester</code> but it is presented in a self-contained fashion. This makes it easier to enhance and reuse this class for practical applications.</p>&#13;
&#13;
<p><a data-primary="ScikitBacktester class" data-type="indexterm" id="ix_05_machine_learning_-asciidoc27"/>Based on the <code>ScikitBacktesterClass</code>, an out-of-sample evaluation of the logistic regression-based strategy is possible.&#13;
The example uses the <a data-primary="EUR/USD exchange rate" data-secondary="logistic regression-based strategies" data-type="indexterm" id="idm45785369657528"/><a data-primary="S&amp;P 500" data-secondary="logistic regression-based strategies and" data-type="indexterm" id="idm45785369656584"/>EUR/USD exchange rate as the base instrument.</p>&#13;
&#13;
<p class="pagebreak-before"><a data-type="xref" href="#ml_plot_7">Figure 5-15</a> illustrates that the strategy outperforms the base instrument during the out-of-sample period (spanning the year 2019) however, without considering transaction costs as before:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">123</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">ScikitVectorBacktester</code> <code class="kn">as</code> <code class="nn">SCI</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">124</code><code class="p">]:</code> <code class="n">scibt</code> <code class="o">=</code> <code class="n">SCI</code><code class="o">.</code><code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'EUR='</code><code class="p">,</code>&#13;
                                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                             <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="s1">'logistic'</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">125</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2015-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2015-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">15</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">125</code><code class="p">]:</code> <code class="p">(</code><code class="mf">12192.18</code><code class="p">,</code> <code class="mf">2189.5</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">126</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2016-1-1'</code><code class="p">,</code> <code class="s1">'2018-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2019-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">15</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">126</code><code class="p">]:</code> <code class="p">(</code><code class="mf">10580.54</code><code class="p">,</code> <code class="mf">729.93</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">127</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="ml_plot_7">&#13;
<img alt="pfat 0515" src="assets/pfat_0515.png"/>&#13;
<h6><span class="label">Figure 5-15. </span>Gross performance of S&amp;P 500 and the out-of-sample logistic regression-based strategy (15 lags, no transaction costs)</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="GDX (VanEck Vectors Gold Miners ETF)" data-secondary="logistic regression-based strategies" data-type="indexterm" id="idm45785369130584"/>As another example, consider the same strategy applied to the <code>GDX</code> ETF, for which an out-of-sample outperformance (over the year 2018) is shown in <a data-type="xref" href="#ml_plot_8">Figure 5-16</a> (before transaction costs):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">128</code><code class="p">]:</code> <code class="n">scibt</code> <code class="o">=</code> <code class="n">SCI</code><code class="o">.</code><code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'GDX'</code><code class="p">,</code>&#13;
                                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                             <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.00</code><code class="p">,</code> <code class="s1">'logistic'</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">129</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2013-1-1'</code><code class="p">,</code> <code class="s1">'2017-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2018-1-1'</code><code class="p">,</code> <code class="s1">'2018-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">129</code><code class="p">]:</code> <code class="p">(</code><code class="mf">12686.81</code><code class="p">,</code> <code class="mf">4032.73</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">130</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="ml_plot_8">&#13;
<img alt="pfat 0516" src="assets/pfat_0516.png"/>&#13;
<h6><span class="label">Figure 5-16. </span>Gross performance of <code>GDX</code> ETF and the logistic regression-based strategy (10 lags, out-of-sample, no transaction costs)</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-type="xref" href="#ml_plot_8_a">Figure 5-17</a> shows how the gross performance is diminished—leading even to a net loss—when taking transaction costs into account, while keeping all other parameters constant:<a data-startref="ix_05_machine_learning_-asciidoc27" data-type="indexterm" id="idm45785369935896"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">131</code><code class="p">]:</code> <code class="n">scibt</code> <code class="o">=</code> <code class="n">SCI</code><code class="o">.</code><code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'GDX'</code><code class="p">,</code>&#13;
                                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                             <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0025</code><code class="p">,</code> <code class="s1">'logistic'</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">132</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2013-1-1'</code><code class="p">,</code> <code class="s1">'2017-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2018-1-1'</code><code class="p">,</code> <code class="s1">'2018-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">132</code><code class="p">]:</code> <code class="p">(</code><code class="mf">9588.48</code><code class="p">,</code> <code class="mf">934.4</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">133</code><code class="p">]:</code> <code class="n">scibt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="ml_plot_8_a">&#13;
<img alt="pfat 0517" src="assets/pfat_0517.png"/>&#13;
<h6><span class="label">Figure 5-17. </span>Gross performance of <code>GDX</code> ETF and the logistic regression-based strategy (10 lags, out-of-sample, with transaction costs)</h6>&#13;
</div></figure>&#13;
<div data-type="caution">&#13;
<p>Applying sophisticated machine learning techniques to stock market prediction often yields promising results early on. In several examples, the strategies backtested outperform the base instrument significantly in-sample. Quite often, such stellar performances are due to a mix of simplifying assumptions and also due to an overfitting of the prediction model. For example, testing the very same strategy instead of in-sample on an out-of-sample data set and adding transaction costs—as two ways of getting to a more realistic picture—often shows that the performance of the considered strategy “suddenly” trails the base instrument performance-wise or turns to a net loss<a data-startref="ix_05_machine_learning_-asciidoc26" data-type="indexterm" id="idm45785369085624"/>.<a data-startref="ix_05_machine_learning_-asciidoc19" data-type="indexterm" id="idm45785369084824"/><a data-startref="ix_05_machine_learning_-asciidoc18" data-type="indexterm" id="idm45785370069304"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Deep Learning for Market Movement Prediction" data-type="sect1"><div class="sect1" id="deep_learning">&#13;
<h1>Using Deep Learning for Market Movement Prediction</h1>&#13;
&#13;
<p><a data-primary="deep learning" data-secondary="market movement prediction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc28"/><a data-primary="market movement prediction" data-secondary="deep learning for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc29"/>Right <a data-primary="TensorFlow" data-type="indexterm" id="idm45785370063864"/>from the open sourcing and publication by Google, the deep learning library <a href="http://tensorflow.org"><code>TensorFlow</code></a> has attracted much interest and wide-spread application. This section applies <code>TensorFlow</code> in the same way that the previous section applied <code>scikit-learn</code> to the prediction of stock market movements modeled as a classification problem. <a data-primary="Keras" data-type="indexterm" id="idm45785370061416"/>However, <code>TensorFlow</code> is not used directly; it is rather used via the equally popular <a href="http://keras.io"><code>Keras</code></a> deep learning package. <code>Keras</code> can be thought of as providing a higher level abstraction to the <code>TensorFlow</code> package with an easier to understand and use API.</p>&#13;
&#13;
<p>The libraries are best installed via <code>pip install tensorflow</code>  and <code>pip install keras</code>. <code>scikit-learn</code> also offers classes to apply neural networks to classification problems.</p>&#13;
&#13;
<p>For more background information on deep learning and <code>Keras</code>, see Goodfellow et al. (2016) and Chollet (2017), respectively.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Simple Classification Problem Revisited" data-type="sect2"><div class="sect2" id="idm45785370056056">&#13;
<h2>The Simple Classification Problem Revisited</h2>&#13;
&#13;
<p><a data-primary="classification problems" data-secondary="neural networks for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc30"/><a data-primary="deep learning" data-secondary="classification problem" data-type="indexterm" id="ix_05_machine_learning_-asciidoc31"/>To illustrate the basic approach of applying neural networks to classification problems, the simple classification problem introduced in the previous section again proves useful:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">134</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hours</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mf">0.75</code><code class="p">,</code><code> </code><code class="mf">1.</code><code class="p">,</code><code> </code><code class="mf">1.25</code><code class="p">,</code><code> </code><code class="mf">1.5</code><code class="p">,</code><code> </code><code class="mf">1.75</code><code class="p">,</code><code> </code><code class="mf">1.75</code><code class="p">,</code><code> </code><code class="mf">2.</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="mf">2.25</code><code class="p">,</code><code> </code><code class="mf">2.5</code><code class="p">,</code><code> </code><code class="mf">2.75</code><code class="p">,</code><code> </code><code class="mf">3.</code><code class="p">,</code><code> </code><code class="mf">3.25</code><code class="p">,</code><code> </code><code class="mf">3.5</code><code class="p">,</code><code> </code><code class="mf">4.</code><code class="p">,</code><code> </code><code class="mf">4.25</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="mf">4.5</code><code class="p">,</code><code> </code><code class="mf">4.75</code><code class="p">,</code><code> </code><code class="mf">5.</code><code class="p">,</code><code> </code><code class="mf">5.5</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">135</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">success</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">136</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="s1">'</code><code class="s1">hours</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">hours</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">success</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">success</code><code class="p">}</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO23-1" id="co_predicting_market_movements_with_machine_learning_CO23-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">137</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO23-2" id="co_predicting_market_movements_with_machine_learning_CO23-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>          </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>          </code><code class="n">RangeIndex</code><code class="p">:</code><code> </code><code class="mi">20</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="n">to</code><code> </code><code class="mi">19</code><code>&#13;
</code><code>          </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">2</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>           </code><code class="c1">#   Column   Non-Null Count  Dtype</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>   </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>           </code><code class="mi">0</code><code>   </code><code class="n">hours</code><code>    </code><code class="mi">20</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>     </code><code class="n">float64</code><code>&#13;
</code><code>           </code><code class="mi">1</code><code>   </code><code class="n">success</code><code>  </code><code class="mi">20</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>     </code><code class="n">int64</code><code>&#13;
</code><code>          </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">448.0</code><code> </code><code class="nb">bytes</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO23-1" id="callout_predicting_market_movements_with_machine_learning_CO23-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Stores the two data sub-sets in a <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO23-2" id="callout_predicting_market_movements_with_machine_learning_CO23-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Prints out the meta information for the <code>DataFrame</code> object.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="MLPClassifier" data-type="indexterm" id="idm45785368634280"/>With these preparations, <code>MLPClassifier</code> from <code>scikit-learn</code> can be imported and straightforwardly applied.<sup><a data-type="noteref" href="ch05.html#idm45785368841160" id="idm45785368841160-marker">3</a></sup> <a data-primary="dense neural network (DNN)" data-type="indexterm" id="idm45785368839320"/><a data-primary="DNN (dense neural network)" data-type="indexterm" id="idm45785368838648"/><a data-primary="multi-layer perceptron" data-type="indexterm" id="idm45785368790504"/>“MLP” in this context stands for <em>multi-layer perceptron</em>, which is another expression for <em>dense neural network</em>. As before, the API to apply neural networks with <code>scikit-learn</code> is basically the same:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">138</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn.neural_network</code><code> </code><code class="kn">import</code><code> </code><code class="n">MLPClassifier</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO24-1" id="co_predicting_market_movements_with_machine_learning_CO24-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">139</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">MLPClassifier</code><code class="p">(</code><code class="n">hidden_layer_sizes</code><code class="o">=</code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">,</code><code> </code><code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO24-2" id="co_predicting_market_movements_with_machine_learning_CO24-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO24-1" id="callout_predicting_market_movements_with_machine_learning_CO24-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the <code>MLPClassifier</code> object from <code>scikit-learn</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO24-2" id="callout_predicting_market_movements_with_machine_learning_CO24-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates the <code>MLPClassifier</code> object.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The following code fits the model, generates the predictions, and plots the results, as shown in <a data-type="xref" href="#dl_plot_1">Figure 5-18</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">140</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">hours</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">success</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO25-1" id="co_predicting_market_movements_with_machine_learning_CO25-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">140</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">MLPClassifier</code><code class="p">(</code><code class="n">hidden_layer_sizes</code><code class="o">=</code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">,</code><code>&#13;
</code><code>           </code><code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">141</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">hours</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO25-2" id="co_predicting_market_movements_with_machine_learning_CO25-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">142</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">142</code><code class="p">]</code><code class="p">:</code><code>     </code><code class="n">hours</code><code>  </code><code class="n">success</code><code>  </code><code class="n">prediction</code><code>&#13;
</code><code>          </code><code class="mi">15</code><code>   </code><code class="mf">4.25</code><code>        </code><code class="mi">1</code><code>           </code><code class="mi">1</code><code>&#13;
</code><code>          </code><code class="mi">16</code><code>   </code><code class="mf">4.50</code><code>        </code><code class="mi">1</code><code>           </code><code class="mi">1</code><code>&#13;
</code><code>          </code><code class="mi">17</code><code>   </code><code class="mf">4.75</code><code>        </code><code class="mi">1</code><code>           </code><code class="mi">1</code><code>&#13;
</code><code>          </code><code class="mi">18</code><code>   </code><code class="mf">5.00</code><code>        </code><code class="mi">1</code><code>           </code><code class="mi">1</code><code>&#13;
</code><code>          </code><code class="mi">19</code><code>   </code><code class="mf">5.50</code><code>        </code><code class="mi">1</code><code>           </code><code class="mi">1</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">143</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="o">=</code><code class="s1">'</code><code class="s1">hours</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">y</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">success</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">style</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">ro</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b-</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">ylim</code><code class="o">=</code><code class="p">[</code><code class="o">-</code><code class="o">.</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mf">1.1</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO25-3" id="co_predicting_market_movements_with_machine_learning_CO25-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO25-1" id="callout_predicting_market_movements_with_machine_learning_CO25-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Fits the neural network for classification.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO25-2" id="callout_predicting_market_movements_with_machine_learning_CO25-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Generates the prediction values based on the fitted model.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO25-3" id="callout_predicting_market_movements_with_machine_learning_CO25-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the original data and the prediction values.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This simple example shows that the application of the deep learning approach is quite similar to the approach with <code>scikit-learn</code> and the <code>LogisticRegression</code> model object. The API is basically the same; only the parameters are different.<a data-startref="ix_05_machine_learning_-asciidoc31" data-type="indexterm" id="idm45785369077944"/><a data-startref="ix_05_machine_learning_-asciidoc30" data-type="indexterm" id="idm45785369077384"/></p>&#13;
&#13;
<figure><div class="figure" id="dl_plot_1">&#13;
<img alt="pfat 0518" src="assets/pfat_0518.png"/>&#13;
<h6><span class="label">Figure 5-18. </span>Base data and prediction results with <code>MLPClassifier</code> for the simple classification example</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Deep Neural Networks to Predict Market Direction" data-type="sect2"><div class="sect2" id="idm45785370055432">&#13;
<h2>Using Deep Neural Networks to Predict Market Direction</h2>&#13;
&#13;
<p><a data-primary="deep learning" data-secondary="deep neural networks for predicting market direction" data-type="indexterm" id="ix_05_machine_learning_-asciidoc32"/><a data-primary="deep neural networks" data-type="indexterm" id="ix_05_machine_learning_-asciidoc33"/><a data-primary="market movement prediction" data-secondary="deep neural networks for" data-type="indexterm" id="ix_05_machine_learning_-asciidoc34"/>The next step is to apply the approach to stock market data in the form of log returns from a financial time series. First, the data needs to be retrieved and prepared:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">144</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-1" id="co_predicting_market_movements_with_machine_learning_CO26-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">145</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-2" id="co_predicting_market_movements_with_machine_learning_CO26-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">146</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="n">symbol</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-3" id="co_predicting_market_movements_with_machine_learning_CO26-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">147</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                   </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>   </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-4" id="co_predicting_market_movements_with_machine_learning_CO26-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">148</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-4" id="co_predicting_market_movements_with_machine_learning_CO26-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">149</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">5</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">150</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>          </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-5" id="co_predicting_market_movements_with_machine_learning_CO26-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>              </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">lag_{lag}</code><code class="s1">'</code><code>&#13;
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-6" id="co_predicting_market_movements_with_machine_learning_CO26-7"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>              </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-7" id="co_predicting_market_movements_with_machine_learning_CO26-8"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">151</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO26-8" id="co_predicting_market_movements_with_machine_learning_CO26-9"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">151</code><code class="p">]</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="n">price</code><code>  </code><code class="k">return</code><code>  </code><code class="n">direction</code><code>   </code><code class="n">lag_1</code><code>   </code><code class="n">lag_2</code><code>   </code><code class="n">lag_3</code><code>   </code><code class="n">lag_4</code><code>   </code><code class="n">lag_5</code><code>&#13;
</code><code>     </code><code class="n">Date</code><code>&#13;
</code><code>     </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>  </code><code class="mf">1.1087</code><code>  </code><code class="mf">0.0001</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>  </code><code class="mf">0.0008</code><code> </code><code class="o">-</code><code class="mf">0.0034</code><code>  </code><code class="mf">0.0006</code><code>&#13;
</code><code>     </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">26</code><code>  </code><code class="mf">1.1096</code><code>  </code><code class="mf">0.0008</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>  </code><code class="mf">0.0008</code><code> </code><code class="o">-</code><code class="mf">0.0034</code><code>&#13;
</code><code>     </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code><code>  </code><code class="mf">1.1175</code><code>  </code><code class="mf">0.0071</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>  </code><code class="mf">0.0008</code><code>&#13;
</code><code>     </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>  </code><code class="mf">1.1197</code><code>  </code><code class="mf">0.0020</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0071</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>&#13;
</code><code>     </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>  </code><code class="mf">1.1210</code><code>  </code><code class="mf">0.0012</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0020</code><code>  </code><code class="mf">0.0071</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-1" id="callout_predicting_market_movements_with_machine_learning_CO26-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Reads the data from the <code>CSV</code> file.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-2" id="callout_predicting_market_movements_with_machine_learning_CO26-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Picks the single time series column of interest.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-3" id="callout_predicting_market_movements_with_machine_learning_CO26-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Renames the only column to <code>price</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-4" id="callout_predicting_market_movements_with_machine_learning_CO26-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculates the log returns and defines the <code>direction</code> as a binary column.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-6" id="callout_predicting_market_movements_with_machine_learning_CO26-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Creates the lagged data.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-7" id="callout_predicting_market_movements_with_machine_learning_CO26-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Creates new <code>DataFrame</code> columns with the log returns shifted by the respective number of lags.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-8" id="callout_predicting_market_movements_with_machine_learning_CO26-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Deletes rows containing <code>NaN</code> values.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO26-9" id="callout_predicting_market_movements_with_machine_learning_CO26-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Prints out the final five rows indicating the “patterns” emerging in the five feature columns.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="dense neural network (DNN)" data-type="indexterm" id="idm45785367854968"/><a data-primary="DNN (dense neural network)" data-type="indexterm" id="idm45785368010424"/><a data-primary="Keras" data-type="indexterm" id="idm45785368009736"/>The following code uses a dense neural network (DNN) with the <code>Keras</code> package<sup><a data-type="noteref" href="ch05.html#idm45785368008552" id="idm45785368008552-marker">4</a></sup>, defines training and test data sub-sets, defines the feature columns, and labels and fits the classifier. <a data-primary="TensorFlow" data-type="indexterm" id="idm45785368006536"/>In the backend, <code>Keras</code> uses the <code>TensorFlow</code>  package to accomplish the task. <a data-type="xref" href="#dnn_plot_metrics">Figure 5-19</a> shows how the accuracy of the DNN classifier changes for both the training and validation data sets during training. As validation data set, 20% of the training data (without shuffling) is used:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">152</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tensorflow</code><code> </code><code class="kn">as</code><code> </code><code class="nn">tf</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-1" id="co_predicting_market_movements_with_machine_learning_CO27-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>          </code><code class="kn">from</code><code> </code><code class="nn">keras.models</code><code> </code><code class="kn">import</code><code> </code><code class="n">Sequential</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-2" id="co_predicting_market_movements_with_machine_learning_CO27-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>          </code><code class="kn">from</code><code> </code><code class="nn">keras.layers</code><code> </code><code class="kn">import</code><code> </code><code class="n">Dense</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-3" id="co_predicting_market_movements_with_machine_learning_CO27-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>          </code><code class="kn">from</code><code> </code><code class="nn">keras.optimizers</code><code> </code><code class="kn">import</code><code> </code><code class="n">Adam</code><code class="p">,</code><code> </code><code class="n">RMSprop</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">153</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">optimizer</code><code> </code><code class="o">=</code><code> </code><code class="n">Adam</code><code class="p">(</code><code class="n">learning_rate</code><code class="o">=</code><code class="mf">0.0001</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">154</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">set_seeds</code><code class="p">(</code><code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="n">tf</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">set_seed</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">155</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">set_seeds</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">Sequential</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-4" id="co_predicting_market_movements_with_machine_learning_CO27-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">64</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">relu</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                  </code><code class="n">input_shape</code><code class="o">=</code><code class="p">(</code><code class="n">lags</code><code class="p">,</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-5" id="co_predicting_market_movements_with_machine_learning_CO27-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">64</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">relu</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-5" id="co_predicting_market_movements_with_machine_learning_CO27-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">sigmoid</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-5" id="co_predicting_market_movements_with_machine_learning_CO27-7"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="n">optimizer</code><code class="o">=</code><code class="n">optimizer</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="n">loss</code><code class="o">=</code><code class="s1">'</code><code class="s1">binary_crossentropy</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="n">metrics</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">accuracy</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-6" id="co_predicting_market_movements_with_machine_learning_CO27-8"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">156</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cutoff</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">2017-12-31</code><code class="s1">'</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-7" id="co_predicting_market_movements_with_machine_learning_CO27-9"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">157</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">cutoff</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-8" id="co_predicting_market_movements_with_machine_learning_CO27-10"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">158</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code class="p">,</code><code> </code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">training_data</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">training_data</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-9" id="co_predicting_market_movements_with_machine_learning_CO27-11"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">159</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">training_data</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-9" id="co_predicting_market_movements_with_machine_learning_CO27-12"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">160</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="n">cutoff</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-8" id="co_predicting_market_movements_with_machine_learning_CO27-13"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">161</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">test_data</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-9" id="co_predicting_market_movements_with_machine_learning_CO27-14"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">162</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="o">%</code><code class="n">time</code><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">training_data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">epochs</code><code class="o">=</code><code class="mi">50</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">validation_split</code><code class="o">=</code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="n">shuffle</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO27-10" id="co_predicting_market_movements_with_machine_learning_CO27-15"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>          </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mf">4.86</code><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mi">989</code><code> </code><code class="n">ms</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">5.85</code><code> </code><code class="n">s</code><code>&#13;
</code><code>          </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">3.34</code><code> </code><code class="n">s</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">162</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">&lt;</code><code class="n">tensorflow</code><code class="o">.</code><code class="n">python</code><code class="o">.</code><code class="n">keras</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">History</code><code> </code><code class="n">at</code><code> </code><code class="mh">0x7f996a0a2880</code><code class="o">&gt;</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">163</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">res</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">history</code><code class="o">.</code><code class="n">history</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">164</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">res</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">accuracy</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">val_accuracy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">style</code><code class="o">=</code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-1" id="callout_predicting_market_movements_with_machine_learning_CO27-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the <code>TensorFlow</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-2" id="callout_predicting_market_movements_with_machine_learning_CO27-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Imports the required model object from <code>Keras</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-3" id="callout_predicting_market_movements_with_machine_learning_CO27-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Imports the relevant layer object from <code>Keras</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-4" id="callout_predicting_market_movements_with_machine_learning_CO27-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>A <code>Sequential</code> model is instantiated.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-5" id="callout_predicting_market_movements_with_machine_learning_CO27-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The hidden layers and the output layer are defined.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-8" id="callout_predicting_market_movements_with_machine_learning_CO27-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Compiles the <code>Sequential</code> model object for classification.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-9" id="callout_predicting_market_movements_with_machine_learning_CO27-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Defines the cutoff date between the training and test data.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-10" id="callout_predicting_market_movements_with_machine_learning_CO27-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Defines the training and test data sets.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-11" id="callout_predicting_market_movements_with_machine_learning_CO27-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Normalizes the features data by Gaussian normalization.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO27-15" id="callout_predicting_market_movements_with_machine_learning_CO27-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Fits the model to the training data set.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="dnn_plot_metrics">&#13;
<img alt="pfat 0519" src="assets/pfat_0519.png"/>&#13;
<h6><span class="label">Figure 5-19. </span>Accuracy of DNN classifier on training and validation data per training step</h6>&#13;
</div></figure>&#13;
&#13;
<p>Equipped with the fitted classifier, the model can generate predictions on the training data set. <a data-type="xref" href="#dl_plot_2">Figure 5-20</a> <a data-primary="EUR/USD exchange rate" data-secondary="gross performance versus deep learning-based strategy" data-type="indexterm" id="ix_05_machine_learning_-asciidoc35"/>shows the strategy gross performance compared to the base instrument (in-sample):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">165</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">training_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="mi">63</code><code class="o">/</code><code class="mi">63</code><code> </code><code class="p">[</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="mi">0</code><code class="n">s</code><code> </code><code class="mi">586</code><code class="n">us</code><code class="o">/</code><code class="n">step</code><code> </code><code class="o">-</code><code> </code><code class="n">loss</code><code class="p">:</code><code> </code><code class="mf">0.7556</code><code> </code><code class="o">-</code><code>&#13;
</code><code>           </code><code class="n">accuracy</code><code class="p">:</code><code> </code><code class="mf">0.5152</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">165</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">[</code><code class="mf">0.7555528879165649</code><code class="p">,</code><code> </code><code class="mf">0.5151968002319336</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">166</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pred</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">training_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO28-1" id="co_predicting_market_movements_with_machine_learning_CO28-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">167</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pred</code><code class="p">[</code><code class="p">:</code><code class="mi">30</code><code class="p">]</code><code class="o">.</code><code class="n">flatten</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO28-1" id="co_predicting_market_movements_with_machine_learning_CO28-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">167</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code>&#13;
</code><code>           </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">168</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">pred</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO28-2" id="co_predicting_market_movements_with_machine_learning_CO28-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">169</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">prediction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                                      </code><code class="n">training_data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO28-3" id="co_predicting_market_movements_with_machine_learning_CO28-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">170</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">170</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>      </code><code class="mf">0.826569</code><code>&#13;
</code><code>          </code><code class="n">strategy</code><code>    </code><code class="mf">1.317303</code><code>&#13;
</code><code>          </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">171</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                          </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO28-4" id="co_predicting_market_movements_with_machine_learning_CO28-5"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO28-1" id="callout_predicting_market_movements_with_machine_learning_CO28-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Predicts the market direction in-sample.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO28-3" id="callout_predicting_market_movements_with_machine_learning_CO28-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Transforms the predictions into long-short positions, <code>+1</code> and <code>-1</code>.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO28-4" id="callout_predicting_market_movements_with_machine_learning_CO28-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the strategy returns given the positions.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO28-5" id="callout_predicting_market_movements_with_machine_learning_CO28-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Plots and compares the strategy performance to the benchmark performance (in-sample).</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="dl_plot_2">&#13;
<img alt="pfat 0520" src="assets/pfat_0520.png"/>&#13;
<h6><span class="label">Figure 5-20. </span>Gross performance of EUR/USD compared to the deep learning-based strategy (in-sample, no transaction costs)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The strategy seems to perform somewhat better than the base instrument on the training data set (in-sample, without transaction costs). However, the more interesting question is how it performs on the test data set (out-of-sample). After a wobbly start, the strategy also outperforms the base instrument out-of-sample, as <a data-type="xref" href="#dl_plot_3">Figure 5-21</a> illustrates. This is despite the fact that the accuracy of the classifier is only slightly above 50% on the test data set:<a data-startref="ix_05_machine_learning_-asciidoc35" data-type="indexterm" id="idm45785367171704"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">172</code><code class="p">]:</code> <code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">test_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'direction'</code><code class="p">])</code>&#13;
          <code class="mi">16</code><code class="o">/</code><code class="mi">16</code> <code class="p">[</code><code class="o">==============================</code><code class="p">]</code> <code class="o">-</code> <code class="mi">0</code><code class="n">s</code> <code class="mi">676</code><code class="n">us</code><code class="o">/</code><code class="n">step</code> <code class="o">-</code> <code class="n">loss</code><code class="p">:</code> <code class="mf">0.7292</code> <code class="o">-</code>&#13;
           <code class="n">accuracy</code><code class="p">:</code> <code class="mf">0.5050</code>&#13;
&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">172</code><code class="p">]:</code> <code class="p">[</code><code class="mf">0.7292129993438721</code><code class="p">,</code> <code class="mf">0.5049701929092407</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">173</code><code class="p">]:</code> <code class="n">pred</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">test_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">174</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">pred</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">175</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">175</code><code class="p">]:</code> <code class="o">-</code><code class="mi">1</code>    <code class="mi">368</code>&#13;
           <code class="mi">1</code>    <code class="mi">135</code>&#13;
          <code class="n">Name</code><code class="p">:</code> <code class="n">prediction</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">int64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">176</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">*</code>&#13;
                                  <code class="n">test_data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">177</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">177</code><code class="p">]:</code> <code class="k">return</code>      <code class="mf">0.934478</code>&#13;
          <code class="n">strategy</code>    <code class="mf">1.109065</code>&#13;
          <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">178</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>&#13;
                          <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="dl_plot_3">&#13;
<img alt="pfat 0521" src="assets/pfat_0521.png"/>&#13;
<h6><span class="label">Figure 5-21. </span>Gross performance of EUR/USD compared to the deep learning-based strategy (out-of-sample, no transaction costs)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding Different Types of Features" data-type="sect2"><div class="sect2" id="idm45785368915576">&#13;
<h2>Adding Different Types of Features</h2>&#13;
&#13;
<p><a data-primary="deep learning" data-secondary="adding features to analysis" data-type="indexterm" id="ix_05_machine_learning_-asciidoc36"/><a data-primary="features" data-secondary="adding different types" data-type="indexterm" id="ix_05_machine_learning_-asciidoc37"/>So far, the analysis mainly focuses on the log returns directly. It is, of course, possible not only to add more classes/categories but also to add other types of features to the mix, such as ones based on <em>momentum</em>, <em>volatility</em>, or <em>distance</em> measures. The code that follows derives the additional features and adds them to the data set:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">179</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">momentum</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO29-1" id="co_predicting_market_movements_with_machine_learning_CO29-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">180</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">volatility</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">20</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO29-2" id="co_predicting_market_movements_with_machine_learning_CO29-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">181</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                              </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO29-3" id="co_predicting_market_movements_with_machine_learning_CO29-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">182</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">183</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code class="o">.</code><code class="n">extend</code><code class="p">(</code><code class="p">[</code><code class="s1">'</code><code class="s1">momentum</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">volatility</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">184</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">print</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>                 </code><code class="n">price</code><code>  </code><code class="k">return</code><code>  </code><code class="n">direction</code><code>   </code><code class="n">lag_1</code><code>   </code><code class="n">lag_2</code><code>   </code><code class="n">lag_3</code><code>   </code><code class="n">lag_4</code><code>    </code><code class="n">lag_5</code><code>&#13;
</code><code>    </code><code class="n">Date</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>  </code><code class="mf">1.1087</code><code>  </code><code class="mf">0.0001</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>  </code><code class="mf">0.0008</code><code> </code><code class="o">-</code><code class="mf">0.0034</code><code>   </code><code class="mf">0.0006</code><code>&#13;
</code><code>    </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">26</code><code>  </code><code class="mf">1.1096</code><code>  </code><code class="mf">0.0008</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="o">-</code><code class="mf">0.0034</code><code>&#13;
</code><code>    </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code><code>  </code><code class="mf">1.1175</code><code>  </code><code class="mf">0.0071</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code> </code><code class="o">-</code><code class="mf">0.0038</code><code>   </code><code class="mf">0.0008</code><code>&#13;
</code><code>    </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>  </code><code class="mf">1.1197</code><code>  </code><code class="mf">0.0020</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0071</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>  </code><code class="mf">0.0007</code><code>  </code><code class="o">-</code><code class="mf">0.0038</code><code>&#13;
</code><code>    </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>  </code><code class="mf">1.1210</code><code>  </code><code class="mf">0.0012</code><code>          </code><code class="mi">1</code><code>  </code><code class="mf">0.0020</code><code>  </code><code class="mf">0.0071</code><code>  </code><code class="mf">0.0008</code><code>  </code><code class="mf">0.0001</code><code>   </code><code class="mf">0.0007</code><code>&#13;
</code><code>&#13;
</code><code>                      </code><code class="n">momentum</code><code>  </code><code class="n">volatility</code><code>  </code><code class="n">distance</code><code>&#13;
</code><code>          </code><code class="n">Date</code><code>&#13;
</code><code>          </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>   </code><code class="o">-</code><code class="mf">0.0010</code><code>      </code><code class="mf">0.0024</code><code>    </code><code class="mf">0.0005</code><code>&#13;
</code><code>          </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">26</code><code>   </code><code class="o">-</code><code class="mf">0.0011</code><code>      </code><code class="mf">0.0024</code><code>    </code><code class="mf">0.0004</code><code>&#13;
</code><code>          </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code><code>   </code><code class="o">-</code><code class="mf">0.0003</code><code>      </code><code class="mf">0.0024</code><code>    </code><code class="mf">0.0012</code><code>&#13;
</code><code>          </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>    </code><code class="mf">0.0010</code><code>      </code><code class="mf">0.0028</code><code>    </code><code class="mf">0.0089</code><code>&#13;
</code><code>          </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>    </code><code class="mf">0.0021</code><code>      </code><code class="mf">0.0028</code><code>    </code><code class="mf">0.0110</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO29-1" id="callout_predicting_market_movements_with_machine_learning_CO29-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The momentum-based feature.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO29-2" id="callout_predicting_market_movements_with_machine_learning_CO29-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The volatility-based feature.</p></dd>&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO29-3" id="callout_predicting_market_movements_with_machine_learning_CO29-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The distance-based feature.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The next steps are to redefine the training and test data sets, to normalize the features data, and to update the model to reflect the new features columns:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">185</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">cutoff</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">186</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code class="p">,</code><code> </code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">training_data</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">training_data</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">187</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">training_data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">training_data</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">188</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="n">cutoff</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">189</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_data_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">test_data</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">190</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">set_seeds</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">Sequential</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">32</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">relu</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                          </code><code class="n">input_shape</code><code class="o">=</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">cols</code><code class="p">)</code><code class="p">,</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_predicting_market_movements_with_machine_learning_CO30-1" id="co_predicting_market_movements_with_machine_learning_CO30-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">32</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">relu</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">activation</code><code class="o">=</code><code class="s1">'</code><code class="s1">sigmoid</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">model</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="n">optimizer</code><code class="o">=</code><code class="n">optimizer</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="n">loss</code><code class="o">=</code><code class="s1">'</code><code class="s1">binary_crossentropy</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="n">metrics</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">accuracy</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_predicting_market_movements_with_machine_learning_CO30-1" id="callout_predicting_market_movements_with_machine_learning_CO30-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>input_shape</code> parameter is adjusted to reflect the new number of features.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="gross performance versus deep learning-based strategy" data-type="indexterm" id="ix_05_machine_learning_-asciidoc38"/>Based on the enriched feature set, the classifier can be trained. The in-sample performance of the strategy is quite a bit better than before, as illustrated in <a data-type="xref" href="#dl_plot_4">Figure 5-22</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">191</code><code class="p">]:</code> <code class="o">%%</code><code class="n">time</code>&#13;
          <code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">training_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">training_data</code><code class="p">[</code><code class="s1">'direction'</code><code class="p">],</code>&#13;
                    <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">,</code> <code class="n">epochs</code><code class="o">=</code><code class="mi">25</code><code class="p">)</code>&#13;
          <code class="n">CPU</code> <code class="n">times</code><code class="p">:</code> <code class="n">user</code> <code class="mf">2.32</code> <code class="n">s</code><code class="p">,</code> <code class="n">sys</code><code class="p">:</code> <code class="mi">577</code> <code class="n">ms</code><code class="p">,</code> <code class="n">total</code><code class="p">:</code> <code class="mf">2.9</code> <code class="n">s</code>&#13;
          <code class="n">Wall</code> <code class="n">time</code><code class="p">:</code> <code class="mf">1.48</code> <code class="n">s</code>&#13;
&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">191</code><code class="p">]:</code> <code class="o">&lt;</code><code class="n">tensorflow</code><code class="o">.</code><code class="n">python</code><code class="o">.</code><code class="n">keras</code><code class="o">.</code><code class="n">callbacks</code><code class="o">.</code><code class="n">History</code> <code class="n">at</code> <code class="mh">0x7f996d35c100</code><code class="o">&gt;</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">192</code><code class="p">]:</code> <code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">training_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">training_data</code><code class="p">[</code><code class="s1">'direction'</code><code class="p">])</code>&#13;
          <code class="mi">62</code><code class="o">/</code><code class="mi">62</code> <code class="p">[</code><code class="o">==============================</code><code class="p">]</code> <code class="o">-</code> <code class="mi">0</code><code class="n">s</code> <code class="mi">649</code><code class="n">us</code><code class="o">/</code><code class="n">step</code> <code class="o">-</code> <code class="n">loss</code><code class="p">:</code> <code class="mf">0.6816</code> <code class="o">-</code>&#13;
           <code class="n">accuracy</code><code class="p">:</code> <code class="mf">0.5646</code>&#13;
&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">192</code><code class="p">]:</code> <code class="p">[</code><code class="mf">0.6816270351409912</code><code class="p">,</code> <code class="mf">0.5646397471427917</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">193</code><code class="p">]:</code> <code class="n">pred</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">training_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">194</code><code class="p">]:</code> <code class="n">training_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">pred</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">195</code><code class="p">]:</code> <code class="n">training_data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">training_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">*</code>&#13;
                                       <code class="n">training_data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">196</code><code class="p">]:</code> <code class="n">training_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">196</code><code class="p">]:</code> <code class="k">return</code>      <code class="mf">0.901074</code>&#13;
          <code class="n">strategy</code>    <code class="mf">2.703377</code>&#13;
          <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">197</code><code class="p">]:</code> <code class="n">training_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>&#13;
                          <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="dl_plot_4">&#13;
<img alt="pfat 0522" src="assets/pfat_0522.png"/>&#13;
<h6><span class="label">Figure 5-22. </span>Gross performance of EUR/USD compared to the deep learning-based strategy (in-sample, additional features)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The final step is the evaluation of the classifier and the derivation of the strategy performance out-of-sample. The classifier also performs significantly better, <em>ceteris paribus</em>, when compared to the case without the additional features. As before, the start is a bit wobbly (see <a data-type="xref" href="#dl_plot_5">Figure 5-23</a>):<a data-startref="ix_05_machine_learning_-asciidoc38" data-type="indexterm" id="idm45785366119032"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">198</code><code class="p">]:</code> <code class="n">model</code><code class="o">.</code><code class="n">evaluate</code><code class="p">(</code><code class="n">test_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">],</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'direction'</code><code class="p">])</code>&#13;
          <code class="mi">16</code><code class="o">/</code><code class="mi">16</code> <code class="p">[</code><code class="o">==============================</code><code class="p">]</code> <code class="o">-</code> <code class="mi">0</code><code class="n">s</code> <code class="mi">800</code><code class="n">us</code><code class="o">/</code><code class="n">step</code> <code class="o">-</code> <code class="n">loss</code><code class="p">:</code> <code class="mf">0.6931</code> <code class="o">-</code>&#13;
           <code class="n">accuracy</code><code class="p">:</code> <code class="mf">0.5507</code>&#13;
&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">198</code><code class="p">]:</code> <code class="p">[</code><code class="mf">0.6931276321411133</code><code class="p">,</code> <code class="mf">0.5506958365440369</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">199</code><code class="p">]:</code> <code class="n">pred</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">test_data_</code><code class="p">[</code><code class="n">cols</code><code class="p">])</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">200</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">pred</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">201</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">201</code><code class="p">]:</code> <code class="o">-</code><code class="mi">1</code>    <code class="mi">335</code>&#13;
           <code class="mi">1</code>    <code class="mi">168</code>&#13;
          <code class="n">Name</code><code class="p">:</code> <code class="n">prediction</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">int64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">202</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">test_data</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">*</code>&#13;
                                   <code class="n">test_data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">203</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">203</code><code class="p">]:</code> <code class="k">return</code>      <code class="mf">0.934478</code>&#13;
          <code class="n">strategy</code>    <code class="mf">1.144385</code>&#13;
          <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">204</code><code class="p">]:</code> <code class="n">test_data</code><code class="p">[[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>&#13;
                          <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="dl_plot_5">&#13;
<img alt="pfat 0523" src="assets/pfat_0523.png"/>&#13;
<h6><span class="label">Figure 5-23. </span>Gross performance of EUR/USD compared to the deep learning-based strategy (out-of-sample, additional features)</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="Keras" data-type="indexterm" id="idm45785365647240"/>The <code>Keras</code> package, in combination with the <code>TensorFlow</code> package as its backend, allows one to make use of the most recent advances in deep learning, such as deep neural network (DNN) classifiers, for algorithmic trading. The application is as straightforward as applying other machine learning models with <code>scikit-learn</code>. The approach illustrated in this section allows for an easy enhancement with regard to the different types of features used.</p>&#13;
<div data-type="tip">&#13;
<p>As an exercise, it is worthwhile to code a Python class (in the spirit of <a data-type="xref" href="#lr_vector_backtester">“Linear Regression Backtesting Class”</a> and <a data-type="xref" href="#sci_vector_backtester">“Classification Algorithm Backtesting Class”</a>) that allows for a more systematic and realistic usage of the <code>Keras</code> package for financial market prediction and the backtesting of respective trading<a data-startref="ix_05_machine_learning_-asciidoc37" data-type="indexterm" id="idm45785365745720"/><a data-startref="ix_05_machine_learning_-asciidoc36" data-type="indexterm" id="idm45785365745048"/> strategies<a data-startref="ix_05_machine_learning_-asciidoc34" data-type="indexterm" id="idm45785365744280"/><a data-startref="ix_05_machine_learning_-asciidoc33" data-type="indexterm" id="idm45785365743608"/><a data-startref="ix_05_machine_learning_-asciidoc32" data-type="indexterm" id="idm45785365742920"/>.<a data-startref="ix_05_machine_learning_-asciidoc29" data-type="indexterm" id="idm45785365742104"/><a data-startref="ix_05_machine_learning_-asciidoc28" data-type="indexterm" id="idm45785365741384"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Conclusions" data-type="sect1"><div class="sect1" id="idm45785367061128">&#13;
<h1>Conclusions</h1>&#13;
&#13;
<p>Predicting future market movements is the holy grail in finance. It means to find the truth. It means to overcome <em>efficient markets</em>. If one can do it with a considerable edge, then stellar investment and trading returns are the consequence. This chapter introduces statistical techniques from the fields of traditional statistics, machine learning, and deep learning to predict the future market direction based on past returns or similar financial quantities. Some first in-sample results are promising, both for linear and logistic regression. However, a more reliable impression is gained when evaluating such strategies out-of-sample and when factoring in transaction costs.</p>&#13;
&#13;
<p>This chapter does not claim to have found the holy grail. It rather offers a glimpse on techniques that could prove useful in the search for it. The unified API of <code>scikit-learn</code> also makes it easy to replace, for example, one linear model with another one. In that sense, the <code>ScikitBacktesterClass</code> can be used as a starting point to explore more machine learning models and to apply them to financial time series prediction.</p>&#13;
&#13;
<p>The quote at the beginning of the chapter from the <em>Terminator 2</em> movie from 1991 is rather optimistic with regard to how fast and to what extent computers might be able to learn and acquire consciousness. No matter if you believe that computers will replace human beings in most areas of life or not, or if they indeed one day become self-aware, they have proven useful to human beings as supporting devices in almost any area of life. And algorithms like those used in machine learning, deep learning, or artificial intelligence hold at least the promise to let them become better algorithmic traders in the near future. A more detailed account of these topics and considerations is found in Hilpisch (2020).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="References and Further Resources" data-type="sect1"><div class="sect1" id="idm45785365734584">&#13;
<h1>References and Further Resources</h1>&#13;
&#13;
<p>The books by Guido and Müller (2016) and VanderPlas (2016) provide practical introductions to machine learning with Python and <code>scikit-learn</code>. The book by Hilpisch (2020) focuses exclusively on the application of algorithms for machine and deep learning to the problem of identifying statistical inefficiencies and exploiting economic inefficiencies through algorithmic trading:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Guido, Sarah, and Andreas Müller. 2016. <em>Introduction to Machine Learning with Python: A Guide for Data Scientists</em>. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
<li>&#13;
<p>Hilpisch, Yves. 2020. <em>Artificial Intelligence in Finance: A Python-Based Guide</em>. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
<li>&#13;
<p>VanderPlas, Jake. 2016. <em>Python Data Science Handbook: Essential Tools for Working with Data</em>. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The books by Hastie et al. (2008) and James et al. (2013) provide a thorough, mathematical overview of popular machine learning techniques and algorithms:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Hastie, Trevor, Robert Tibshirani, and Jerome Friedman. 2008. <em>The Elements of Statistical Learning</em>.  2nd ed. New York: Springer.</p>&#13;
</li>&#13;
<li>&#13;
<p>James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. <em>Introduction to Statistical Learning</em>. New York: Springer.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For more background information on deep learning and <code>Keras</code>, refer to these books:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Chollet, Francois. 2017. <em>Deep Learning with Python</em>. Shelter Island: Manning.</p>&#13;
</li>&#13;
<li>&#13;
<p>Goodfellow, Ian, Yoshua Bengio, and Aaron Courville. 2016. <em>Deep Learning</em>. Cambridge: MIT Press. <a href="http://deeplearningbook.org"><em class="hyperlink">http://deeplearningbook.org</em></a>.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Scripts" data-type="sect1"><div class="sect1" id="idm45785365717976">&#13;
<h1>Python Scripts</h1>&#13;
&#13;
<p>This section presents Python scripts referenced and used in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Linear Regression Backtesting Class" data-type="sect2"><div class="sect2" id="lr_vector_backtester">&#13;
<h2>Linear Regression Backtesting Class</h2>&#13;
&#13;
<p><a data-primary="backtesting" data-secondary="Python scripts for linear regression backtesting class" data-type="indexterm" id="idm45785365310440"/><a data-primary="linear regression" data-secondary="vectorized backtesting of regression-based strategy" data-type="indexterm" id="idm45785365309592"/><a data-primary="machine learning" data-secondary="Python scripts" data-type="indexterm" id="idm45785365308744"/><a data-primary="Python scripts" data-secondary="linear regression backtesting class" data-type="indexterm" id="idm45785365307896"/><a data-primary="vectorized backtesting" data-secondary="Python scripts for" data-type="indexterm" id="idm45785365307048"/>The following presents Python code with a class for the vectorized backtesting of strategies based on <em>linear regression</em> used for the prediction of the direction of market movements:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Module with Class</code>&#13;
<code class="c1"># for Vectorized Backtesting</code>&#13;
<code class="c1"># of Linear Regression-Based Strategies</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">LRVectorBacktester</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="sd">''' Class for the vectorized backtesting of</code>&#13;
<code class="sd">    linear regression-based trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">       TR RIC (financial instrument) to work with</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data selection</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data selection</code>&#13;
<code class="sd">    amount: int, float</code>&#13;
<code class="sd">        amount to be invested at the beginning</code>&#13;
<code class="sd">    tc: float</code>&#13;
<code class="sd">        proportional transaction costs (e.g., 0.5% = 0.005) per trade</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    select_data:</code>&#13;
<code class="sd">        selects a sub-set of the data</code>&#13;
<code class="sd">    prepare_lags:</code>&#13;
<code class="sd">        prepares the lagged data for the regression</code>&#13;
<code class="sd">    fit_model:</code>&#13;
<code class="sd">        implements the regression step</code>&#13;
<code class="sd">    run_strategy:</code>&#13;
<code class="sd">        runs the backtest for the regression-based strategy</code>&#13;
<code class="sd">    plot_results:</code>&#13;
<code class="sd">        plots the performance of the strategy compared to the symbol</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">,</code> <code class="n">amount</code><code class="p">,</code> <code class="n">tc</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="n">amount</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">tc</code> <code class="o">=</code> <code class="n">tc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">None</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">select_data</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Selects sub-sets of the financial data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code> <code class="o">&gt;=</code> <code class="n">start</code><code class="p">)</code> <code class="o">&amp;</code>&#13;
                         <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code> <code class="o">&lt;=</code> <code class="n">end</code><code class="p">)]</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">data</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">prepare_lags</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Prepares the lagged data for the regression and prediction steps.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">select_data</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">cols</code> <code class="o">=</code> <code class="p">[]</code>&#13;
        <code class="k">for</code> <code class="n">lag</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>&#13;
            <code class="n">col</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'lag_{lag}'</code>&#13;
            <code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">lagged_data</code> <code class="o">=</code> <code class="n">data</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">fit_model</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Implements the regression step.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">prepare_lags</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">)</code>&#13;
        <code class="n">reg</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">lstsq</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">lagged_data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="p">],</code>&#13;
                              <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">lagged_data</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]),</code>&#13;
                              <code class="n">rcond</code><code class="o">=</code><code class="bp">None</code><code class="p">)[</code><code class="mi">0</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">reg</code> <code class="o">=</code> <code class="n">reg</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start_in</code><code class="p">,</code> <code class="n">end_in</code><code class="p">,</code> <code class="n">start_out</code><code class="p">,</code> <code class="n">end_out</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">3</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtests the trading strategy.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">=</code> <code class="n">lags</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">fit_model</code><code class="p">(</code><code class="n">start_in</code><code class="p">,</code> <code class="n">end_in</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">select_data</code><code class="p">(</code><code class="n">start_out</code><code class="p">,</code> <code class="n">end_out</code><code class="p">)</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">lags</code><code class="p">:]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">prepare_lags</code><code class="p">(</code><code class="n">start_out</code><code class="p">,</code> <code class="n">end_out</code><code class="p">)</code>&#13;
        <code class="n">prediction</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">lagged_data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="p">],</code> <code class="bp">self</code><code class="o">.</code><code class="n">reg</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">prediction</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">*</code> \&#13;
                                   <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code>&#13;
        <code class="c1"># determine when a trade takes place</code>&#13;
        <code class="n">trades</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">0</code>&#13;
        <code class="c1"># subtract transaction costs from return when trade takes place</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">][</code><code class="n">trades</code><code class="p">]</code> <code class="o">-=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> \&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> \&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="c1"># gross performance of the strategy</code>&#13;
        <code class="n">aperf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="c1"># out-/underperformance of strategy</code>&#13;
        <code class="n">operf</code> <code class="o">=</code> <code class="n">aperf</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="nb">round</code><code class="p">(</code><code class="n">aperf</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="nb">round</code><code class="p">(</code><code class="n">operf</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">plot_results</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the cumulative performance of the trading strategy</code>&#13;
<code class="sd">        compared to the symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'No results to plot yet. Run a strategy.'</code><code class="p">)</code>&#13;
        <code class="n">title</code> <code class="o">=</code> <code class="s1">'</code><code class="si">%s</code><code class="s1"> | TC = </code><code class="si">%.4f</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[[</code><code class="s1">'creturns'</code><code class="p">,</code> <code class="s1">'cstrategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="n">title</code><code class="p">,</code>&#13;
                                                     <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">lrbt</code> <code class="o">=</code> <code class="n">LRVectorBacktester</code><code class="p">(</code><code class="s1">'.SPX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2018-06-29'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                            <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2015-12-31'</code><code class="p">,</code>&#13;
                            <code class="s1">'2016-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="n">lrbt</code> <code class="o">=</code> <code class="n">LRVectorBacktester</code><code class="p">(</code><code class="s1">'GDX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                            <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">5</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">lrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2016-12-31'</code><code class="p">,</code>&#13;
                            <code class="s1">'2017-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">5</code><code class="p">))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Classification Algorithm Backtesting Class" data-type="sect2"><div class="sect2" id="sci_vector_backtester">&#13;
<h2>Classification Algorithm Backtesting Class</h2>&#13;
&#13;
<p><a data-primary="backtesting" data-secondary="Python scripts for classification algorithm backtesting" data-type="indexterm" id="idm45785365063528"/><a data-primary="classification problems" data-secondary="Python scripts for vectorized backtesting" data-type="indexterm" id="idm45785365062456"/><a data-primary="logistic regression" data-secondary="Python script for vectorized backtesting" data-type="indexterm" id="idm45785365061480"/>The following presents Python code with a class for the vectorized backtesting of strategies based on <em>logistic regression</em>, as a standard classification algorithm, used for the prediction of the direction of market movements:<a data-startref="ix_05_machine_learning_-asciidoc1" data-type="indexterm" id="idm45785365059768"/><a data-startref="ix_05_machine_learning_-asciidoc0" data-type="indexterm" id="idm45785365059096"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Module with Class</code>&#13;
<code class="c1"># for Vectorized Backtesting</code>&#13;
<code class="c1"># of Machine Learning-Based Strategies</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn</code> <code class="kn">import</code> <code class="n">linear_model</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">ScikitVectorBacktester</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="sd">''' Class for the vectorized backtesting of</code>&#13;
<code class="sd">    machine learning-based trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">        TR RIC (financial instrument) to work with</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data selection</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data selection</code>&#13;
<code class="sd">    amount: int, float</code>&#13;
<code class="sd">        amount to be invested at the beginning</code>&#13;
<code class="sd">    tc: float</code>&#13;
<code class="sd">        proportional transaction costs (e.g., 0.5% = 0.005) per trade</code>&#13;
<code class="sd">    model: str</code>&#13;
<code class="sd">        either 'regression' or 'logistic'</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    select_data:</code>&#13;
<code class="sd">        selects a sub-set of the data</code>&#13;
<code class="sd">    prepare_features:</code>&#13;
<code class="sd">        prepares the features data for the model fitting</code>&#13;
<code class="sd">    fit_model:</code>&#13;
<code class="sd">        implements the fitting step</code>&#13;
<code class="sd">    run_strategy:</code>&#13;
<code class="sd">        runs the backtest for the regression-based strategy</code>&#13;
<code class="sd">    plot_results:</code>&#13;
<code class="sd">        plots the performance of the strategy compared to the symbol</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">,</code> <code class="n">amount</code><code class="p">,</code> <code class="n">tc</code><code class="p">,</code> <code class="n">model</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="n">amount</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">tc</code> <code class="o">=</code> <code class="n">tc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">None</code>&#13;
        <code class="k">if</code> <code class="n">model</code> <code class="o">==</code> <code class="s1">'regression'</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">model</code> <code class="o">=</code> <code class="n">linear_model</code><code class="o">.</code><code class="n">LinearRegression</code><code class="p">()</code>&#13;
        <code class="k">elif</code> <code class="n">model</code> <code class="o">==</code> <code class="s1">'logistic'</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">model</code> <code class="o">=</code> <code class="n">linear_model</code><code class="o">.</code><code class="n">LogisticRegression</code><code class="p">(</code><code class="n">C</code><code class="o">=</code><code class="mf">1e6</code><code class="p">,</code>&#13;
                <code class="n">solver</code><code class="o">=</code><code class="s1">'lbfgs'</code><code class="p">,</code> <code class="n">multi_class</code><code class="o">=</code><code class="s1">'ovr'</code><code class="p">,</code> <code class="n">max_iter</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code>&#13;
        <code class="k">else</code><code class="p">:</code>&#13;
            <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code><code class="s1">'Model not known or not yet implemented.'</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">select_data</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Selects sub-sets of the financial data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code> <code class="o">&gt;=</code> <code class="n">start</code><code class="p">)</code> <code class="o">&amp;</code>&#13;
                         <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code> <code class="o">&lt;=</code> <code class="n">end</code><code class="p">)]</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">data</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">prepare_features</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Prepares the feature columns for the regression and prediction steps.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">select_data</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">feature_columns</code> <code class="o">=</code> <code class="p">[]</code>&#13;
        <code class="k">for</code> <code class="n">lag</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>&#13;
            <code class="n">col</code> <code class="o">=</code> <code class="s1">'lag_{}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="n">col</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">feature_columns</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">fit_model</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="sd">''' Implements the fitting step.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">prepare_features</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">feature_columns</code><code class="p">],</code>&#13;
                       <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]))</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">start_in</code><code class="p">,</code> <code class="n">end_in</code><code class="p">,</code> <code class="n">start_out</code><code class="p">,</code> <code class="n">end_out</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">3</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtests the trading strategy.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">=</code> <code class="n">lags</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">fit_model</code><code class="p">(</code><code class="n">start_in</code><code class="p">,</code> <code class="n">end_in</code><code class="p">)</code>&#13;
        <code class="c1"># data = self.select_data(start_out, end_out)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">prepare_features</code><code class="p">(</code><code class="n">start_out</code><code class="p">,</code> <code class="n">end_out</code><code class="p">)</code>&#13;
        <code class="n">prediction</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">feature_columns</code><code class="p">])</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">=</code> <code class="n">prediction</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code> <code class="o">*</code>&#13;
                                        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">])</code>&#13;
        <code class="c1"># determine when a trade takes place</code>&#13;
        <code class="n">trades</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'prediction'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">0</code>&#13;
        <code class="c1"># subtract transaction costs from return when trade takes place</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">][</code><code class="n">trades</code><code class="p">]</code> <code class="o">-=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code>&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code>&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_subset</code>&#13;
        <code class="c1"># absolute performance of the strategy</code>&#13;
        <code class="n">aperf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="c1"># out-/underperformance of strategy</code>&#13;
        <code class="n">operf</code> <code class="o">=</code> <code class="n">aperf</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="nb">round</code><code class="p">(</code><code class="n">aperf</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="nb">round</code><code class="p">(</code><code class="n">operf</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">plot_results</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the cumulative performance of the trading strategy</code>&#13;
<code class="sd">        compared to the symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'No results to plot yet. Run a strategy.'</code><code class="p">)</code>&#13;
        <code class="n">title</code> <code class="o">=</code> <code class="s1">'</code><code class="si">%s</code><code class="s1"> | TC = </code><code class="si">%.4f</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[[</code><code class="s1">'creturns'</code><code class="p">,</code> <code class="s1">'cstrategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="n">title</code><code class="p">,</code>&#13;
                                                     <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">scibt</code> <code class="o">=</code> <code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'.SPX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                   <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="s1">'regression'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2016-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2017-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="n">scibt</code> <code class="o">=</code> <code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'.SPX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                   <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="s1">'logistic'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2016-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2017-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">))</code>&#13;
    <code class="n">scibt</code> <code class="o">=</code> <code class="n">ScikitVectorBacktester</code><code class="p">(</code><code class="s1">'.SPX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                                   <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">,</code> <code class="s1">'logistic'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">15</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">scibt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2013-12-31'</code><code class="p">,</code>&#13;
                             <code class="s1">'2014-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">15</code><code class="p">))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45785375631928"><sup><a href="ch05.html#idm45785375631928-marker">1</a></sup> The books by Guido and Müller (2016) and VanderPlas (2016) provide practical, general introductions to machine learning with Python.</p><p data-type="footnote" id="idm45785373157144"><sup><a href="ch05.html#idm45785373157144-marker">2</a></sup> See, for example, the discussion in <a href="https://oreil.ly/KRH78">The Tale of 10 Days</a>.</p><p data-type="footnote" id="idm45785368841160"><sup><a href="ch05.html#idm45785368841160-marker">3</a></sup> For details, see <a href="https://oreil.ly/hOwsE"><em class="hyperlink">https://oreil.ly/hOwsE</em></a>.</p><p data-type="footnote" id="idm45785368008552"><sup><a href="ch05.html#idm45785368008552-marker">4</a></sup> For details, refer to <a href="https://keras.io/layers/core/"><em class="hyperlink">https://keras.io/layers/core/</em></a>.</p></div></div></section></body></html>