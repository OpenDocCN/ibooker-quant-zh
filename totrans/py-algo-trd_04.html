<html><head></head><body><section data-pdf-bookmark="Chapter 4. Mastering Vectorized Backtesting" data-type="chapter" epub:type="chapter"><div class="chapter" id="vectorized_backtesting">&#13;
<h1><span class="label">Chapter 4. </span>Mastering Vectorized Backtesting</h1>&#13;
&#13;
<blockquote>&#13;
<p>[T]hey were silly enough to think you can look at the past to predict the future.<sup><a data-type="noteref" href="ch04.html#idm45785385873496" id="idm45785385873496-marker">1</a></sup></p>&#13;
<p data-type="attribution"><em>The Economist</em></p>&#13;
</blockquote>&#13;
&#13;
<p>Developing ideas and hypotheses for an algorithmic trading program is generally the more creative and sometimes even fun part in the preparation stage. Thoroughly testing them is generally the more technical and time consuming part. This chapter is about the vectorized backtesting of different algorithmic trading strategies. It covers the following types of strategies (refer also to <a data-type="xref" href="ch01.html#trading_strategies">“Trading Strategies”</a>):</p>&#13;
<dl>&#13;
<dt>Simple moving averages (SMA) based strategies</dt>&#13;
<dd>&#13;
<p>The basic idea of SMA usage for buy and sell signal generation is already decades old. SMAs are a major tool in the so-called technical analysis of stock prices. A signal is derived, for example, when an SMA defined on a shorter time window—say 42 days—crosses an SMA defined on a longer time window—say 252 days.</p>&#13;
</dd>&#13;
<dt>Momentum strategies</dt>&#13;
<dd>&#13;
<p>These are strategies that are based on the hypothesis that recent performance will persist for some additional time. For example, a stock that is downward trending is assumed to do so for longer, which is why such a stock is to be shorted.</p>&#13;
</dd>&#13;
<dt>Mean-reversion strategies</dt>&#13;
<dd>&#13;
<p>The reasoning behind mean-reversion strategies is that stock prices or prices of other financial instruments tend to revert to some mean level or to some trend level when they have deviated too much from such levels.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The chapter proceeds as follows. <a data-type="xref" href="#using_vectorization">“Making Use of Vectorization”</a> introduces vectorization as a useful technical approach to formulate and backtest trading strategies. <a data-type="xref" href="#simple_moving_averages">“Strategies Based on Simple Moving Averages”</a> is the core of this chapter and covers vectorized backtesting of SMA-based strategies in some depth. <a data-type="xref" href="#momentum_trading">“Strategies Based on Momentum”</a> introduces and backtests trading strategies based on the so-called time series momentum (“recent performance”) of a stock. <a data-type="xref" href="#mean_reversion">“Strategies Based on Mean Reversion”</a> finishes the chapter with coverage of mean-reversion strategies. Finally, <a data-type="xref" href="#data_snooping">“Data Snooping and Overfitting”</a> discusses the pitfalls of data snooping and overfitting in the context of the backtesting of algorithmic trading strategies.</p>&#13;
&#13;
<p>The major goal of this chapter is to master the vectorized implementation approach, which packages like <code>NumPy</code> and <code>pandas</code> allow for, as an efficient and fast backtesting tool. To this end, the approaches presented make a number of simplifying assumptions to better focus the discussion on the major topic of vectorization.</p>&#13;
&#13;
<p>Vectorized backtesting should be considered in the following cases:</p>&#13;
<dl>&#13;
<dt>Simple trading strategies</dt>&#13;
<dd>&#13;
<p>The vectorized backtesting approach clearly has limits when it comes to the modeling of algorithmic trading strategies. However, many popular, simple strategies can be backtested in vectorized fashion.</p>&#13;
</dd>&#13;
<dt>Interactive strategy exploration</dt>&#13;
<dd>&#13;
<p>Vectorized backtesting allows for an agile, interactive exploration of trading strategies and their characteristics. A few lines of code generally suffice to come up with first results, and different parameter combinations are easily tested.</p>&#13;
</dd>&#13;
<dt>Visualization as major goal</dt>&#13;
<dd>&#13;
<p>The approach lends itself pretty well for visualizations of the used data, statistics, signals, and performance results. A few lines of Python code are generally enough to generate appealing and insightful plots.</p>&#13;
</dd>&#13;
<dt>Comprehensive backtesting programs</dt>&#13;
<dd>&#13;
<p>Vectorized backtesting is pretty fast in general, allowing one to test a great variety of parameter combinations in a short amount of time. When speed is key, the approach should be considered.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Making Use of Vectorization" data-type="sect1"><div class="sect1" id="using_vectorization">&#13;
<h1>Making Use of Vectorization</h1>&#13;
&#13;
<p><a data-primary="array programming" data-seealso="vectorization" data-type="indexterm" id="idm45785387501352"/><em>Vectorization</em>, or <em>array programming</em>, refers to a programming style where operations on scalars (that is, integer or floating point numbers) are generalized to vectors, matrices, or even multidimensional arrays. Consider a vector of integers <math alttext="v equals left-parenthesis 1 comma 2 comma 3 comma 4 comma 5 right-parenthesis Superscript upper T">&#13;
  <mrow>&#13;
    <mi>v</mi>&#13;
    <mo>=</mo>&#13;
    <msup><mrow><mo>(</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mn>3</mn><mo>,</mo><mn>4</mn><mo>,</mo><mn>5</mn><mo>)</mo></mrow> <mi>T</mi> </msup>&#13;
  </mrow>&#13;
</math> represented in Python as a <code>list</code> object <code>v = [1, 2, 3, 4, 5]</code>. Calculating the scalar product of such a vector and, say, the number <code>2</code> requires in pure Python a <code>for</code> loop or something similar, such as a list comprehension, which is just different syntax for a <code>for</code> loop:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="n">v</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">sm</code> <code class="o">=</code> <code class="p">[</code><code class="mi">2</code> <code class="o">*</code> <code class="n">i</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="n">v</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">sm</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">10</code><code class="p">]</code></pre>&#13;
&#13;
<p>In principle, Python allows one to multiply a <code>list</code> object by an integer, but Python’s data model gives back another <code>list</code> object in the example case containing two times the elements of the original object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">v</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">]</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Vectorization with NumPy" data-type="sect2"><div class="sect2" id="idm45785387428584">&#13;
<h2>Vectorization with NumPy</h2>&#13;
&#13;
<p><a data-primary="NumPy" data-secondary="vectorization" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc1"/><a data-primary="vectorized backtesting" data-secondary="vectorization with NumPy" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc2"/>The <code>NumPy</code> package for numerical computing (cf. <a href="http://numpy.org"><code>NumPy</code> home page</a>) introduces vectorization to Python. <a data-primary="ndarray class" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc3"/>The major class provided by <code>NumPy</code> is the <code>ndarray</code> class, which stands for <em>n-dimensional array</em>. An instance of such an object can be created, for example, on the basis of the <code>list</code> object <code>v</code>. Scalar multiplication, linear transformations, and similar operations from linear algebra then work &#13;
<span class="keep-together">as desired:</span></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-1" id="co_mastering_vectorized_backtesting_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">v</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-2" id="co_mastering_vectorized_backtesting_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-3" id="co_mastering_vectorized_backtesting_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">type</code><code class="p">(</code><code class="n">a</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-4" id="co_mastering_vectorized_backtesting_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">numpy</code><code class="o">.</code><code class="n">ndarray</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">a</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-5" id="co_mastering_vectorized_backtesting_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mi">2</code><code class="p">,</code><code>  </code><code class="mi">4</code><code class="p">,</code><code>  </code><code class="mi">6</code><code class="p">,</code><code>  </code><code class="mi">8</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5</code><code> </code><code class="o">*</code><code> </code><code class="n">a</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO1-6" id="co_mastering_vectorized_backtesting_CO1-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">2.5</code><code class="p">,</code><code> </code><code class="mf">3.</code><code> </code><code class="p">,</code><code> </code><code class="mf">3.5</code><code class="p">,</code><code> </code><code class="mf">4.</code><code> </code><code class="p">,</code><code> </code><code class="mf">4.5</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-1" id="callout_mastering_vectorized_backtesting_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the <code>NumPy</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-2" id="callout_mastering_vectorized_backtesting_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates an <code>ndarray</code> object based on the <code>list</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-3" id="callout_mastering_vectorized_backtesting_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Prints out the data stored as <code>ndarray</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-4" id="callout_mastering_vectorized_backtesting_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Looks up the type of the object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-5" id="callout_mastering_vectorized_backtesting_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Achieves a scalar multiplication in vectorized fashion.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO1-6" id="callout_mastering_vectorized_backtesting_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Achieves a linear transformation in vectorized fashion.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The transition from a one-dimensional array (a vector) to a two-dimensional array (a matrix) is natural. The same holds true for higher dimensions:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="mi">12</code><code class="p">)</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO2-1" id="co_mastering_vectorized_backtesting_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="p">[</code><code> </code><code class="mi">0</code><code class="p">,</code><code>  </code><code class="mi">1</code><code class="p">,</code><code>  </code><code class="mi">2</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">3</code><code class="p">,</code><code>  </code><code class="mi">4</code><code class="p">,</code><code>  </code><code class="mi">5</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">6</code><code class="p">,</code><code>  </code><code class="mi">7</code><code class="p">,</code><code>  </code><code class="mi">8</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">9</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">11</code><code class="p">]</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">a</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="p">[</code><code> </code><code class="mi">0</code><code class="p">,</code><code>  </code><code class="mi">2</code><code class="p">,</code><code>  </code><code class="mi">4</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">6</code><code class="p">,</code><code>  </code><code class="mi">8</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code class="mi">12</code><code class="p">,</code><code> </code><code class="mi">14</code><code class="p">,</code><code> </code><code class="mi">16</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code class="mi">18</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">22</code><code class="p">]</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO2-2" id="co_mastering_vectorized_backtesting_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="p">[</code><code>  </code><code class="mi">0</code><code class="p">,</code><code>   </code><code class="mi">1</code><code class="p">,</code><code>   </code><code class="mi">4</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code>  </code><code class="mi">9</code><code class="p">,</code><code>  </code><code class="mi">16</code><code class="p">,</code><code>  </code><code class="mi">25</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">36</code><code class="p">,</code><code>  </code><code class="mi">49</code><code class="p">,</code><code>  </code><code class="mi">64</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mi">81</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">,</code><code> </code><code class="mi">121</code><code class="p">]</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO2-1" id="callout_mastering_vectorized_backtesting_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creates a one-dimensional <code>ndarray</code> object and reshapes it to two dimensions.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO2-2" id="callout_mastering_vectorized_backtesting_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the square of every element of the object in vectorized fashion.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In addition, the <code>ndarray</code> class provides certain methods that allow vectorized operations. They often also have counterparts in the form of so-called universal functions that <code>NumPy</code> provides:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO3-1" id="co_mastering_vectorized_backtesting_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">5.5</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">a</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO3-2" id="co_mastering_vectorized_backtesting_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">5.5</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO3-3" id="co_mastering_vectorized_backtesting_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">4.5</code><code class="p">,</code><code> </code><code class="mf">5.5</code><code class="p">,</code><code> </code><code class="mf">6.5</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO3-4" id="co_mastering_vectorized_backtesting_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">1.</code><code class="p">,</code><code>  </code><code class="mf">4.</code><code class="p">,</code><code>  </code><code class="mf">7.</code><code class="p">,</code><code> </code><code class="mf">10.</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO3-1" id="callout_mastering_vectorized_backtesting_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the mean of all elements by a method call.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO3-2" id="callout_mastering_vectorized_backtesting_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the mean of all elements by a universal function.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO3-3" id="callout_mastering_vectorized_backtesting_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the mean along the first axis.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO3-4" id="callout_mastering_vectorized_backtesting_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculates the mean along the second axis.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As a financial example, consider the function <code>generate_sample_data()</code> in <a data-type="xref" href="ch03.html#sample_data">“Python Scripts”</a> that uses an Euler discretization to generate sample paths for a geometric Brownian motion. The implementation makes use of multiple vectorized operations that are combined to a single line of code.</p>&#13;
&#13;
<p>See the <a data-type="xref" href="app01.html#python_numpy_pandas">Appendix A</a> for more details of vectorization with <code>NumPy</code>. Refer to Hilpisch (2018) for a multitude of applications of vectorization in a financial context.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p>The standard instruction set and data model of Python does not generally allow for vectorized numerical operations. <code>NumPy</code> introduces powerful vectorization techniques based on the regular array class <code>ndarray</code> that lead to concise code that is close to mathematical notation in, for example, linear algebra regarding vectors and matrices<a data-startref="ix_04_vectorized_backtesting_-asciidoc3" data-type="indexterm" id="idm45785383670840"/>.<a data-startref="ix_04_vectorized_backtesting_-asciidoc2" data-type="indexterm" id="idm45785383670040"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc1" data-type="indexterm" id="idm45785383669368"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Vectorization with pandas" data-type="sect2"><div class="sect2" id="idm45785384736056">&#13;
<h2>Vectorization with pandas</h2>&#13;
&#13;
<p><a data-primary="pandas" data-secondary="vectorization" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc4"/><a data-primary="vectorized backtesting" data-secondary="vectorization with pandas" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc5"/>The <code>pandas</code> package and the central <code>DataFrame</code> class make heavy use of <code>NumPy</code> and the <code>ndarray</code> class. Therefore, most of the vectorization principles seen in the <code>NumPy</code> context carry over to <code>pandas</code>. The mechanics are best explained again on the basis of a concrete example. To begin with, define a two-dimensional <code>ndarray</code> object first:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">19</code><code class="p">]:</code> <code class="n">a</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="mi">15</code><code class="p">)</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">a</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">array</code><code class="p">([[</code> <code class="mi">0</code><code class="p">,</code>  <code class="mi">1</code><code class="p">,</code>  <code class="mi">2</code><code class="p">],</code>&#13;
                <code class="p">[</code> <code class="mi">3</code><code class="p">,</code>  <code class="mi">4</code><code class="p">,</code>  <code class="mi">5</code><code class="p">],</code>&#13;
                <code class="p">[</code> <code class="mi">6</code><code class="p">,</code>  <code class="mi">7</code><code class="p">,</code>  <code class="mi">8</code><code class="p">],</code>&#13;
                <code class="p">[</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">11</code><code class="p">],</code>&#13;
                <code class="p">[</code><code class="mi">12</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">14</code><code class="p">]])</code></pre>&#13;
&#13;
<p><a data-primary="DataFrame objects" data-secondary="creating" data-type="indexterm" id="idm45785383437384"/>For the creation of a <code>DataFrame</code> object, generate a <code>list</code> object with column names and a <code>DatetimeIndex</code> object next, both of appropriate size given the <code>ndarray</code> object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO4-1" id="co_mastering_vectorized_backtesting_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="s1">'</code><code class="s1">abc</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO4-2" id="co_mastering_vectorized_backtesting_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">columns</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">a</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">index</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">date_range</code><code class="p">(</code><code class="s1">'</code><code class="s1">2021-7-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">periods</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">freq</code><code class="o">=</code><code class="s1">'</code><code class="s1">B</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO4-3" id="co_mastering_vectorized_backtesting_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">index</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">DatetimeIndex</code><code class="p">(</code><code class="p">[</code><code class="s1">'</code><code class="s1">2021-07-01</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2021-07-02</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2021-07-05</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="s1">'</code><code class="s1">2021-07-06</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="s1">'</code><code class="s1">2021-07-07</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                       </code><code class="n">dtype</code><code class="o">=</code><code class="s1">'</code><code class="s1">datetime64[ns]</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">freq</code><code class="o">=</code><code class="s1">'</code><code class="s1">B</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">columns</code><code class="o">=</code><code class="n">columns</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="n">index</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO4-4" id="co_mastering_vectorized_backtesting_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">a</code><code>   </code><code class="n">b</code><code>   </code><code class="n">c</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>   </code><code class="mi">0</code><code>   </code><code class="mi">1</code><code>   </code><code class="mi">2</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>   </code><code class="mi">3</code><code>   </code><code class="mi">4</code><code>   </code><code class="mi">5</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>   </code><code class="mi">6</code><code>   </code><code class="mi">7</code><code>   </code><code class="mi">8</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>   </code><code class="mi">9</code><code>  </code><code class="mi">10</code><code>  </code><code class="mi">11</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>  </code><code class="mi">12</code><code>  </code><code class="mi">13</code><code>  </code><code class="mi">14</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO4-1" id="callout_mastering_vectorized_backtesting_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the <code>pandas</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO4-2" id="callout_mastering_vectorized_backtesting_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates a <code>list</code> object out of the <code>str</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO4-3" id="callout_mastering_vectorized_backtesting_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>A <code>pandas</code> <code>DatetimeIndex</code> object is created that has a “business day” frequency and goes over five periods.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO4-4" id="callout_mastering_vectorized_backtesting_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>A <code>DataFrame</code> object is instantiated based on the <code>ndarray</code> object <code>a</code> with column labels and index values specified.</p></dd>&#13;
</dl>&#13;
&#13;
<p>In principle, vectorization now works similarly to <code>ndarray</code> objects. One difference is that aggregation operations default to column-wise results:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">df</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO5-1" id="co_mastering_vectorized_backtesting_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">a</code><code>   </code><code class="n">b</code><code>   </code><code class="n">c</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>   </code><code class="mi">0</code><code>   </code><code class="mi">2</code><code>   </code><code class="mi">4</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>   </code><code class="mi">6</code><code>   </code><code class="mi">8</code><code>  </code><code class="mi">10</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>  </code><code class="mi">12</code><code>  </code><code class="mi">14</code><code>  </code><code class="mi">16</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>  </code><code class="mi">18</code><code>  </code><code class="mi">20</code><code>  </code><code class="mi">22</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>  </code><code class="mi">24</code><code>  </code><code class="mi">26</code><code>  </code><code class="mi">28</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO5-2" id="co_mastering_vectorized_backtesting_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code>    </code><code class="mi">30</code><code>&#13;
</code><code>         </code><code class="n">b</code><code>    </code><code class="mi">35</code><code>&#13;
</code><code>         </code><code class="n">c</code><code>    </code><code class="mi">40</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">df</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO5-3" id="co_mastering_vectorized_backtesting_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">a</code><code>    </code><code class="mf">6.0</code><code>&#13;
</code><code>         </code><code class="n">b</code><code>    </code><code class="mf">7.0</code><code>&#13;
</code><code>         </code><code class="n">c</code><code>    </code><code class="mf">8.0</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>&#13;
<dl class="calloutlist pagebreak-before">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO5-1" id="callout_mastering_vectorized_backtesting_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the scalar product for the <code>DataFrame</code> object (treated as a matrix).</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO5-2" id="callout_mastering_vectorized_backtesting_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the sum <em>per column</em>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO5-3" id="callout_mastering_vectorized_backtesting_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the mean <em>per column</em>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Column-wise operations can be implemented by referencing the respective column names, either by the bracket notation or the dot notation:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">a</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO6-1" id="co_mastering_vectorized_backtesting_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>     </code><code class="mi">2</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>     </code><code class="mi">8</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>    </code><code class="mi">14</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>    </code><code class="mi">20</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>    </code><code class="mi">26</code><code>&#13;
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5</code><code> </code><code class="o">*</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">a</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">b</code><code> </code><code class="o">-</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">c</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO6-2" id="co_mastering_vectorized_backtesting_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>     </code><code class="mf">0.0</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>     </code><code class="mf">4.5</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>     </code><code class="mf">9.0</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>    </code><code class="mf">13.5</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>    </code><code class="mf">18.0</code><code>&#13;
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO6-1" id="callout_mastering_vectorized_backtesting_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the element-wise sum over columns <code>a</code> and <code>c</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO6-2" id="callout_mastering_vectorized_backtesting_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates a linear transform involving all three columns.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similarly, conditions yielding Boolean results vectors and SQL-like selections based on such conditions are straightforward to implement:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">a</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">5</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO7-1" id="co_mastering_vectorized_backtesting_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>    </code><code class="bp">False</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>    </code><code class="bp">False</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>     </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>     </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>     </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="nb">bool</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code class="p">[</code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">a</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">5</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO7-2" id="co_mastering_vectorized_backtesting_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">a</code><code>   </code><code class="n">b</code><code>   </code><code class="n">c</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>   </code><code class="mi">6</code><code>   </code><code class="mi">7</code><code>   </code><code class="mi">8</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>   </code><code class="mi">9</code><code>  </code><code class="mi">10</code><code>  </code><code class="mi">11</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>  </code><code class="mi">12</code><code>  </code><code class="mi">13</code><code>  </code><code class="mi">14</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO7-1" id="callout_mastering_vectorized_backtesting_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Which element in column <code>a</code> is greater than five?</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO7-2" id="callout_mastering_vectorized_backtesting_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Select all those rows where the element in column <code>a</code> is greater than five.</p></dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before">For a vectorized backtesting of trading strategies, comparisons between two columns or more are typical:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO8-1" id="co_mastering_vectorized_backtesting_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>    </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>    </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>    </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>    </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>    </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="nb">bool</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.15</code><code> </code><code class="o">*</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">a</code><code> </code><code class="o">+</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">b</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">df</code><code class="o">.</code><code class="n">c</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO8-2" id="co_mastering_vectorized_backtesting_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">01</code><code>    </code><code class="bp">False</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">02</code><code>    </code><code class="bp">False</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">05</code><code>    </code><code class="bp">False</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">06</code><code>     </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2021</code><code class="o">-</code><code class="mo">07</code><code class="o">-</code><code class="mo">07</code><code>     </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="n">Freq</code><code class="p">:</code><code> </code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="nb">bool</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO8-1" id="callout_mastering_vectorized_backtesting_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>For which date is the element in column <code>c</code> greater than in column <code>b</code>?</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO8-2" id="callout_mastering_vectorized_backtesting_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Condition comparing a linear combination of columns <code>a</code> and <code>b</code> with column <code>c</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Vectorization with <code>pandas</code> is a powerful concept, in particular for the implementation of financial algorithms and the vectorized backtesting, as illustrated in the remainder of this chapter. For more on the basics of vectorization with <code>pandas</code> and financial examples, refer to Hilpisch (2018, ch. 5).</p>&#13;
<div data-type="tip">&#13;
<p><a data-primary="time series data sets" data-secondary="pandas and vectorization" data-type="indexterm" id="idm45785382266616"/>While <code>NumPy</code> brings general vectorization approaches to the numerical computing world of Python, <code>pandas</code> allows vectorization over time series data. This is really helpful for the implementation of financial algorithms and the backtesting of algorithmic trading strategies. By using this approach, you can expect concise code, as well as a faster code execution, in comparison to standard Python code, making use of <code>for</code> loops and similar idioms to accomplish the same goal.<a data-startref="ix_04_vectorized_backtesting_-asciidoc5" data-type="indexterm" id="idm45785382263912"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc4" data-type="indexterm" id="idm45785382263192"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strategies Based on Simple Moving Averages" data-type="sect1"><div class="sect1" id="simple_moving_averages">&#13;
<h1>Strategies Based on Simple Moving Averages</h1>&#13;
&#13;
<p><a data-primary="backtesting" data-secondary="based on simple moving averages" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc6"/><a data-primary="simple moving averages (SMAs)" data-secondary="trading strategies based on" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc7"/><a data-primary="vectorized backtesting" data-secondary="trading strategies based on simple moving averages" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc8"/>Trading based on simple moving averages (SMAs) is a decades old strategy that has its origins in the technical stock analysis world. Brock et al. (1992), for example, empirically investigate such strategies in systematic fashion. They write:</p>&#13;
<blockquote>&#13;
<p>The term “technical analysis” is a general heading for a myriad of trading techniques….In this paper, we explore two of the simplest and most popular technical rules: moving average-oscillator and trading-range break (resistance and support levels). In the first method, buy and sell signals are generated by two moving averages, a long period, and a short period….Our study reveals that technical analysis helps to predict stock changes.</p></blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting into the Basics" data-type="sect2"><div class="sect2" id="idm45785382251752">&#13;
<h2>Getting into the Basics</h2>&#13;
&#13;
<p>This sub-section focuses on the basics of backtesting trading strategies that make use of two SMAs. <a data-primary="EUR/USD exchange rate" data-secondary="SMA calculation" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc9"/>The example to follow works with end-of-day (EOD) closing data for the EUR/USD exchange rate, as provided in the <em>csv</em> file under the <a href="https://oreil.ly/AzE-p">EOD data file</a>. The data in the data set is from the Refinitiv Eikon Data API and represents EOD values for the respective instruments (<code>RICs</code>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'</code><code class="s1">http://hilpisch.com/pyalgo_eikon_eod_data.csv</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO9-1" id="co_mastering_vectorized_backtesting_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO9-2" id="co_mastering_vectorized_backtesting_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">2516</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="n">to</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>&#13;
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">12</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">AAPL</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">MSFT</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">INTC</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">AMZN</code><code class="o">.</code><code class="n">O</code><code>  </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">GS</code><code class="o">.</code><code class="n">N</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">SPY</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">6</code><code>   </code><code class="o">.</code><code class="n">SPX</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">7</code><code>   </code><code class="o">.</code><code class="n">VIX</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">8</code><code>   </code><code class="n">EUR</code><code class="o">=</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">9</code><code>   </code><code class="n">XAU</code><code class="o">=</code><code>    </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">10</code><code>  </code><code class="n">GDX</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">11</code><code>  </code><code class="n">GLD</code><code>     </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">12</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">255.5</code><code> </code><code class="n">KB</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO9-3" id="co_mastering_vectorized_backtesting_CO9-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO9-4" id="co_mastering_vectorized_backtesting_CO9-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO9-5" id="co_mastering_vectorized_backtesting_CO9-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">2516</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2010</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="n">to</code><code> </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>&#13;
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">1</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">price</code><code>   </code><code class="mi">2516</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>   </code><code class="n">float64</code><code>&#13;
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">39.3</code><code> </code><code class="n">KB</code></pre>&#13;
<dl class="calloutlist pagebreak-before">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO9-1" id="callout_mastering_vectorized_backtesting_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Reads the data from the remotely stored <code>CSV</code> file.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO9-2" id="callout_mastering_vectorized_backtesting_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Shows the meta information for the <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO9-3" id="callout_mastering_vectorized_backtesting_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Transforms the <code>Series</code> object to a <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO9-4" id="callout_mastering_vectorized_backtesting_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Renames the only column to <code>price</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO9-5" id="callout_mastering_vectorized_backtesting_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Shows the meta information for the new <code>DataFrame</code> object.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The calculation of SMAs is made simple by the <code>rolling()</code> method, in combination with a deferred calculation operation:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">42</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO10-1" id="co_mastering_vectorized_backtesting_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">252</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO10-2" id="co_mastering_vectorized_backtesting_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO10-3" id="co_mastering_vectorized_backtesting_CO10-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">price</code><code>      </code><code class="n">SMA1</code><code>      </code><code class="n">SMA2</code><code>&#13;
</code><code>         </code><code class="n">Date</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>  </code><code class="mf">1.1087</code><code>  </code><code class="mf">1.107698</code><code>  </code><code class="mf">1.119630</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">26</code><code>  </code><code class="mf">1.1096</code><code>  </code><code class="mf">1.107740</code><code>  </code><code class="mf">1.119529</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code><code>  </code><code class="mf">1.1175</code><code>  </code><code class="mf">1.107924</code><code>  </code><code class="mf">1.119428</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>  </code><code class="mf">1.1197</code><code>  </code><code class="mf">1.108131</code><code>  </code><code class="mf">1.119333</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>  </code><code class="mf">1.1210</code><code>  </code><code class="mf">1.108279</code><code>  </code><code class="mf">1.119231</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO10-1" id="callout_mastering_vectorized_backtesting_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Creates a column with 42 days of SMA values. The first 41 values will be <code>NaN</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO10-2" id="callout_mastering_vectorized_backtesting_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Creates a column with 252 days of SMA values. The first 251 values will be <code>NaN</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO10-3" id="callout_mastering_vectorized_backtesting_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Prints the final five rows of the data set.</p></dd>&#13;
</dl>&#13;
&#13;
<p>A visualization of the original time series data in combination with the SMAs best illustrates the results (see <a data-type="xref" href="#sma_plot_1">Figure 4-1</a>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">45</code><code class="p">]:</code> <code class="o">%</code><code class="n">matplotlib</code> <code class="n">inline</code>&#13;
         <code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">mpl</code><code class="p">,</code> <code class="n">plt</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>&#13;
         <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'savefig.dpi'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">300</code>&#13;
         <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">46</code><code class="p">]:</code> <code class="n">data</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="s1">'EUR/USD | 42 &amp; 252 days SMAs'</code><code class="p">,</code>&#13;
                   <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<p>The next step is to generate signals, or rather market positionings, based on the relationship between the two SMAs. The rule is to <em>go long whenever the shorter SMA is above the longer one and vice versa</em>. For our purposes, we indicate a long position by 1 and a short position by –1.</p>&#13;
&#13;
<figure><div class="figure" id="sma_plot_1">&#13;
<img alt="pfat 0401" src="assets/pfat_0401.png"/>&#13;
<h6><span class="label">Figure 4-1. </span>The EUR/USD exchange rate with two SMAs</h6>&#13;
</div></figure>&#13;
&#13;
<p>Being able to directly compare two columns of the <code>DataFrame</code> object makes the implementation of the rule an affair of a single line of code only. The positioning over time is illustrated in <a data-type="xref" href="#sma_plot_2">Figure 4-2</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA1</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA2</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                     </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO11-1" id="co_mastering_vectorized_backtesting_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO11-2" id="co_mastering_vectorized_backtesting_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ylim</code><code class="o">=</code><code class="p">[</code><code class="o">-</code><code class="mf">1.1</code><code class="p">,</code><code> </code><code class="mf">1.1</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">title</code><code class="o">=</code><code class="s1">'</code><code class="s1">Market Positioning</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO11-3" id="co_mastering_vectorized_backtesting_CO11-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO11-1" id="callout_mastering_vectorized_backtesting_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implements the trading rule in vectorized fashion. <code>np.where()</code> produces <code>+1</code> for rows where the expression is <code>True</code> and <code>-1</code> for rows where the expression is <code>False</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO11-2" id="callout_mastering_vectorized_backtesting_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Deletes all rows of the data set that contain at least one <code>NaN</code> value.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO11-3" id="callout_mastering_vectorized_backtesting_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the positioning over time.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="sma_plot_2">&#13;
<img alt="pfat 0402" src="assets/pfat_0402.png"/>&#13;
<h6><span class="label">Figure 4-2. </span>Market positioning based on the strategy with two SMAs</h6>&#13;
</div></figure>&#13;
&#13;
<p>To calculate the performance of the strategy, calculate the log returns based on the original financial time series next. The code to do this is again rather concise due to vectorization. <a data-type="xref" href="#sma_plot_3">Figure 4-3</a> shows the histogram of the log returns:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO12-1" id="co_mastering_vectorized_backtesting_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">hist</code><code class="p">(</code><code class="n">bins</code><code class="o">=</code><code class="mi">35</code><code class="p">,</code><code> </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO12-2" id="co_mastering_vectorized_backtesting_CO12-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO12-1" id="callout_mastering_vectorized_backtesting_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the log returns in vectorized fashion over the <code>price</code> column.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO12-2" id="callout_mastering_vectorized_backtesting_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Plots the log returns as a histogram (frequency distribution).</p></dd>&#13;
</dl>&#13;
&#13;
<p>To derive the strategy returns, multiply the <code>position</code> column—shifted by one trading day—with the <code>returns</code> column. Since log returns are additive, calculating the sum over the columns <code>returns</code> and <code>strategy</code> provides a first comparison of the performance of the strategy relative to the base investment itself.</p>&#13;
&#13;
<figure><div class="figure" id="sma_plot_3">&#13;
<img alt="pfat 0403" src="assets/pfat_0403.png"/>&#13;
<h6><span class="label">Figure 4-3. </span>Frequency distribution of EUR/USD log returns</h6>&#13;
</div></figure>&#13;
&#13;
<p>Comparing the returns shows that the strategy books a win over the passive benchmark investment:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO13-1" id="co_mastering_vectorized_backtesting_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO13-2" id="co_mastering_vectorized_backtesting_CO13-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>    </code><code class="o">-</code><code class="mf">0.176731</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">0.253121</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO13-3" id="co_mastering_vectorized_backtesting_CO13-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>     </code><code class="mf">0.838006</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">1.288039</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO13-1" id="callout_mastering_vectorized_backtesting_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Derives the log returns of the strategy given the positionings and market returns.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO13-2" id="callout_mastering_vectorized_backtesting_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Sums up the single log return values for both the stock and the strategy (for illustration only).</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO13-3" id="callout_mastering_vectorized_backtesting_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Applies the exponential function to the sum of the log returns to calculate the <em>gross performance</em>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Calculating the cumulative sum over time with <code>cumsum</code> and, based on this, the cumulative returns by applying the exponential function <code>np.exp()</code> gives a more comprehensive picture of how the strategy compares to the performance of the base financial instrument over time. <a data-type="xref" href="#sma_plot_4">Figure 4-4</a> shows the data graphically and illustrates the outperformance in this particular case:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">55</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'returns'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>&#13;
                     <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="sma_plot_4">&#13;
<img alt="pfat 0404" src="assets/pfat_0404.png"/>&#13;
<h6><span class="label">Figure 4-4. </span>Gross performance of EUR/USD compared to the SMA-based strategy</h6>&#13;
</div></figure>&#13;
&#13;
<p>Average, annualized risk-return statistics for both the stock and the strategy are easy to calculate:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO14-1" id="co_mastering_vectorized_backtesting_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>    </code><code class="o">-</code><code class="mf">0.019671</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">0.028174</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO14-1" id="co_mastering_vectorized_backtesting_CO14-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>    </code><code class="o">-</code><code class="mf">0.019479</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">0.028575</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO14-2" id="co_mastering_vectorized_backtesting_CO14-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>     </code><code class="mf">0.085414</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">0.085405</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO14-2" id="co_mastering_vectorized_backtesting_CO14-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">returns</code><code>     </code><code class="mf">0.085405</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>    </code><code class="mf">0.085373</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO14-1" id="callout_mastering_vectorized_backtesting_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the annualized mean return in both log and regular space.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO14-3" id="callout_mastering_vectorized_backtesting_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the annualized standard deviation in both log and regular space.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Other risk statistics often of interest in the context of trading strategy performances are the <em>maximum drawdown</em> and the <em>longest drawdown period</em>. A helper statistic to use in this context is the cumulative maximum gross performance as calculated by the <code>cummax()</code> method applied to the gross performance of the strategy. <a data-type="xref" href="#sma_plot_5">Figure 4-5</a> shows the two time series for the SMA-based strategy:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">cumret</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO15-1" id="co_mastering_vectorized_backtesting_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">cumret</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cummax</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO15-2" id="co_mastering_vectorized_backtesting_CO15-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">cumret</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO15-3" id="co_mastering_vectorized_backtesting_CO15-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO15-1" id="callout_mastering_vectorized_backtesting_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Defines a new column, <code>cumret</code>, with the gross performance over time.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO15-2" id="callout_mastering_vectorized_backtesting_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Defines yet another column with the running maximum value of the gross &#13;
<span class="keep-together">performance.</span></p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO15-3" id="callout_mastering_vectorized_backtesting_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots the two new columns of the <code>DataFrame</code> object.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="sma_plot_5">&#13;
<img alt="pfat 0405" src="assets/pfat_0405.png"/>&#13;
<h6><span class="label">Figure 4-5. </span>Gross performance and cumulative maximum performance of the SMA-based strategy</h6>&#13;
</div></figure>&#13;
&#13;
<p>The maximum drawdown is then simply calculated as the maximum of the difference between the two relevant columns. The maximum drawdown in the example is about 18 percentage points:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">drawdown</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">cumret</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO16-1" id="co_mastering_vectorized_backtesting_CO16-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">drawdown</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO16-2" id="co_mastering_vectorized_backtesting_CO16-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.17779367070195917</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO16-1" id="callout_mastering_vectorized_backtesting_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the element-wise difference between the two columns.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO16-2" id="callout_mastering_vectorized_backtesting_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Picks out the maximum value from all differences.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The determination of the longest drawdown period is a bit more involved. It requires those dates at which the gross performance equals its cumulative maximum (that is, where a new maximum is set). This information is stored in a temporary object. Then the differences in days between all such dates are calculated and the longest period is picked out. Such periods can be only one day long or more than 100 days. Here, the longest drawdown period lasts for 596 days—a pretty long period:<sup><a data-type="noteref" href="ch04.html#idm45785380499832" id="idm45785380499832-marker">2</a></sup></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">temp</code><code> </code><code class="o">=</code><code> </code><code class="n">drawdown</code><code class="p">[</code><code class="n">drawdown</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO17-1" id="co_mastering_vectorized_backtesting_CO17-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">periods</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">temp</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">to_pydatetime</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                    </code><code class="n">temp</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">to_pydatetime</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO17-2" id="co_mastering_vectorized_backtesting_CO17-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">periods</code><code class="p">[</code><code class="mi">12</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="o">=</code><code class="nb">object</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">periods</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO17-3" id="co_mastering_vectorized_backtesting_CO17-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="mi">596</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO17-1" id="callout_mastering_vectorized_backtesting_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Where are the differences equal to zero?</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO17-2" id="callout_mastering_vectorized_backtesting_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the <code>timedelta</code> values between all index values.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO17-3" id="callout_mastering_vectorized_backtesting_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Picks out the maximum <code>timedelta</code> value.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Vectorized backtesting with <code>pandas</code> is generally a rather efficient endeavor due to the capabilities of the package and the main <code>DataFrame</code> class. However, the interactive approach illustrated so far does not work well when one wishes to implement a larger backtesting program that, for example, optimizes the parameters of an SMA-based strategy. To this end, a more general approach is advisable.</p>&#13;
<div data-type="note" epub:type="note">&#13;
<p><code>pandas</code> proves to be a powerful tool for the vectorized analysis of trading strategies. Many statistics of interest, such as log returns, cumulative returns, annualized returns and volatility, maximum drawdown, and maximum drawdown period, can in general be calculated by a single line or just a few lines of code. Being able to visualize results by a simple method call is an additional benefit.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generalizing the Approach" data-type="sect2"><div class="sect2" id="idm45785382250200">&#13;
<h2>Generalizing the Approach</h2>&#13;
&#13;
<p><a data-type="xref" href="#sma_vector_backtester">“SMA Backtesting Class”</a> presents a Python code that contains a class for the vectorized backtesting of SMA-based trading strategies. In a sense, it is a generalization of the approach introduced in the previous sub-section. It allows one to define an instance of the <code>SMAVectorBacktester</code> class by providing the following parameters:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>symbol</code>: <code>RIC</code> (instrument data) to be used</p>&#13;
</li>&#13;
<li>&#13;
<p><code>SMA1</code>: for the time window in days for the <em>shorter</em> SMA</p>&#13;
</li>&#13;
<li>&#13;
<p><code>SMA2</code>: for the time window in days for the <em>longer</em> SMA</p>&#13;
</li>&#13;
<li>&#13;
<p><code>start</code>: for the start date of the data selection</p>&#13;
</li>&#13;
<li>&#13;
<p><code>end</code>: for the end date of the data selection</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The application itself is best illustrated by an interactive session that makes use of the class. The example first replicates the backtest implemented previously based on EUR/USD exchange rate data. It then optimizes the SMA parameters for maximum gross performance. Based on the optimal parameters, it plots the resulting gross &#13;
<span class="keep-together">performance</span> of the strategy compared to the base instrument over the relevant period &#13;
<span class="keep-together">of time:</span></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">SMAVectorBacktester</code><code> </code><code class="kn">as</code><code> </code><code class="nn">SMA</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO18-1" id="co_mastering_vectorized_backtesting_CO18-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">smabt</code><code> </code><code class="o">=</code><code> </code><code class="n">SMA</code><code class="o">.</code><code class="n">SMAVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">EUR=</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mi">42</code><code class="p">,</code><code> </code><code class="mi">252</code><code class="p">,</code><code>&#13;
</code><code>                                         </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">)</code><code>   </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO18-2" id="co_mastering_vectorized_backtesting_CO18-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">smabt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO18-3" id="co_mastering_vectorized_backtesting_CO18-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">1.29</code><code class="p">,</code><code> </code><code class="mf">0.45</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="o">%</code><code class="n">time</code><code>&#13;
</code><code>         </code><code class="n">smabt</code><code class="o">.</code><code class="n">optimize_parameters</code><code class="p">(</code><code class="p">(</code><code class="mi">30</code><code class="p">,</code><code> </code><code class="mi">50</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                                   </code><code class="p">(</code><code class="mi">200</code><code class="p">,</code><code> </code><code class="mi">300</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO18-4" id="co_mastering_vectorized_backtesting_CO18-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mf">3.76</code><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mf">15.8</code><code> </code><code class="n">ms</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">3.78</code><code> </code><code class="n">s</code><code>&#13;
</code><code>         </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">3.78</code><code> </code><code class="n">s</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code> </code><code class="mf">48.</code><code class="p">,</code><code> </code><code class="mf">238.</code><code class="p">]</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mf">1.5</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">smabt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO18-5" id="co_mastering_vectorized_backtesting_CO18-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO18-1" id="callout_mastering_vectorized_backtesting_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This imports the module as <code>SMA</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO18-2" id="callout_mastering_vectorized_backtesting_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>An instance of the main class is instantiated.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO18-3" id="callout_mastering_vectorized_backtesting_CO18-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Backtests the SMA-based strategy, given the parameters during instantiation.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO18-4" id="callout_mastering_vectorized_backtesting_CO18-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>optimize_parameters()</code> method takes as input parameter ranges with step sizes and determines the optimal combination by a brute force approach.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO18-5" id="callout_mastering_vectorized_backtesting_CO18-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The <code>plot_results()</code> method plots the strategy performance compared to the benchmark instrument, given the currently stored parameter values (here from the optimization procedure).</p></dd>&#13;
</dl>&#13;
&#13;
<p>The gross performance of the strategy with the original parametrization is 1.24 or 124%. The optimized strategy yields an absolute return of 1.44 or 144% for the parameter combination <code>SMA1 = 48</code> and <code>SMA2 = 238</code>. <a data-type="xref" href="#sma_plot_6">Figure 4-6</a> shows the gross performance over time graphically, again compared to the performance of the base instrument, which represents the benchmark<a data-startref="ix_04_vectorized_backtesting_-asciidoc9" data-type="indexterm" id="idm45785380032408"/>.<a data-startref="ix_04_vectorized_backtesting_-asciidoc8" data-type="indexterm" id="idm45785380031640"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc7" data-type="indexterm" id="idm45785380030968"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc6" data-type="indexterm" id="idm45785380030328"/></p>&#13;
&#13;
<figure><div class="figure" id="sma_plot_6">&#13;
<img alt="pfat 0406" src="assets/pfat_0406.png"/>&#13;
<h6><span class="label">Figure 4-6. </span>Gross performance of EUR/USD and the optimized SMA strategy</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strategies Based on Momentum" data-type="sect1"><div class="sect1" id="momentum_trading">&#13;
<h1>Strategies Based on Momentum</h1>&#13;
&#13;
<p><a data-primary="momentum strategies" data-secondary="vectorized backtesting of" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc10"/><a data-primary="vectorized backtesting" data-secondary="momentum-based trading strategies" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc11"/>There are two basic types of momentum strategies. <a data-primary="cross-sectional momentum strategies" data-type="indexterm" id="idm45785380023672"/>The first type is <em>cross-sectional</em> momentum strategies. Selecting from a larger pool of instruments, these strategies buy those instruments that have recently outperformed relative to their peers (or a benchmark) and sell those instruments that have underperformed. The basic idea is that the instruments continue to outperform and underperform, respectively—at least for a certain period of time. Jegadeesh and Titman (1993, 2001) and Chan et al. (1996) study these types of trading strategies and their potential sources of profit.</p>&#13;
&#13;
<p>Cross-sectional momentum strategies have traditionally performed quite well. Jegadeesh and Titman (1993) write:</p>&#13;
<blockquote>&#13;
<p>This paper documents that strategies which buy stocks that have performed well in the past and sell stocks that have performed poorly in the past generate significant positive returns over 3- to 12-month holding periods.</p></blockquote>&#13;
&#13;
<p><a data-primary="time series momentum strategies" data-seealso="momentum strategies" data-type="indexterm" id="idm45785380020200"/>The second type is <em>time series</em> momentum strategies. These strategies buy those instruments that have recently performed well and sell those instruments that have recently performed poorly. In this case, the benchmark is the past returns of the instrument itself. Moskowitz et al. (2012) analyze this type of momentum strategy in detail across a wide range of markets. They write:</p>&#13;
<blockquote>&#13;
<p>Rather than focus on the relative returns of securities in the cross-section, time series momentum focuses purely on a security’s own past return….Our finding of time series momentum in virtually every instrument we examine seems to challenge the “random walk” hypothesis, which in its most basic form implies that knowing whether a price went up or down in the past should not be informative about whether it will go up or down in the future.</p></blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting into the Basics" data-type="sect2"><div class="sect2" id="idm45785380017016">&#13;
<h2>Getting into the Basics</h2>&#13;
&#13;
<p><a data-primary="momentum strategies" data-secondary="basics" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc12"/>Consider <a data-primary="gold price" data-secondary="momentum strategy and" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc13"/>end-of-day closing prices for the gold price in USD (<code>XAU=</code>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">74</code><code class="p">]:</code> <code class="n">data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="s1">'XAU='</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">75</code><code class="p">]:</code> <code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="s1">'XAU='</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">76</code><code class="p">]:</code> <code class="n">data</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code> <code class="o">/</code> <code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code></pre>&#13;
&#13;
<p>The most simple time series momentum strategy is to buy the stock if the last return was positive and to sell it if it was negative. With <code>NumPy</code> and <code>pandas</code> this is easy to formalize; just take the sign of the last available return as the market position. <a data-type="xref" href="#mom_plot_1">Figure 4-7</a> illustrates the performance of this strategy. The strategy does significantly underperform the base instrument:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO19-1" id="co_mastering_vectorized_backtesting_CO19-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO19-2" id="co_mastering_vectorized_backtesting_CO19-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                     </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO19-3" id="co_mastering_vectorized_backtesting_CO19-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO19-1" id="callout_mastering_vectorized_backtesting_CO19-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Defines a new column with the sign (that is, 1 or –1) of the relevant log return; the resulting values represent the market positionings (long or short).</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO19-2" id="callout_mastering_vectorized_backtesting_CO19-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the strategy log returns given the market positionings.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO19-3" id="callout_mastering_vectorized_backtesting_CO19-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Plots and compares the strategy performance with the benchmark instrument.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mom_plot_1">&#13;
<img alt="pfat 0407" src="assets/pfat_0407.png"/>&#13;
<h6><span class="label">Figure 4-7. </span>Gross performance of gold price (USD) and momentum strategy (last return only)</h6>&#13;
</div></figure>&#13;
&#13;
<p>Using a rolling time window, the time series momentum strategy can be generalized to more than just the last return. For example, the average of the <em>last three returns</em> can be used to generate the signal for the positioning. <a data-type="xref" href="#mom_plot_2">Figure 4-8</a> shows that the strategy in this case does much better, both in absolute terms and relative to the base &#13;
<span class="keep-together">instrument:</span></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">80</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO20-1" id="co_mastering_vectorized_backtesting_CO20-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">81</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">82</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO20-1" id="callout_mastering_vectorized_backtesting_CO20-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This time, the mean return over a rolling window of three days is taken.</p></dd>&#13;
</dl>&#13;
&#13;
<p>However, the performance is quite sensitive to the time window parameter. Choosing, for example, the last two returns instead of three leads to a much worse performance, as shown in <a data-type="xref" href="#mom_plot_3">Figure 4-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="mom_plot_2">&#13;
<img alt="pfat 0408" src="assets/pfat_0408.png"/>&#13;
<h6><span class="label">Figure 4-8. </span>Gross performance of gold price (USD) and momentum strategy (last three returns)</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="mom_plot_3">&#13;
<img alt="pfat 0409" src="assets/pfat_0409.png"/>&#13;
<h6><span class="label">Figure 4-9. </span>Gross performance of gold price (USD) and momentum strategy (last two returns)</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Time series momentum might be expected intraday, as well.<a data-startref="ix_04_vectorized_backtesting_-asciidoc13" data-type="indexterm" id="idm45785379579592"/> Actually, one would expect it to be more pronounced intraday than interday. <a data-type="xref" href="#mom_plot_4">Figure 4-10</a> shows the gross performance of five time series momentum strategies for one, three, five, seven, and nine return observations, respectively. <a data-primary="Apple, Inc." data-secondary="intraday stock prices" data-type="indexterm" id="idm45785379691736"/>The data used is intraday stock price data for Apple Inc., as retrieved from the Eikon Data API. The figure is based on the code that follows. Basically all strategies outperform the stock over the course of this intraday time window, although some only slightly:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">83</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">fn</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">../data/AAPL_1min_05052020.csv</code><code class="s1">'</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-1" id="co_mastering_vectorized_backtesting_CO21-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="c1"># fn = '../data/SPX_1min_05052020.csv'  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-1" id="co_mastering_vectorized_backtesting_CO21-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">fn</code><code class="p">,</code><code> </code><code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-1" id="co_mastering_vectorized_backtesting_CO21-3"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">85</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-1" id="co_mastering_vectorized_backtesting_CO21-4"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">241</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">05</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="mi">16</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">05</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code>&#13;
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">6</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="c1">#   Column  Non-Null Count  Dtype</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">HIGH</code><code>    </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">LOW</code><code>     </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">OPEN</code><code>    </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">CLOSE</code><code>   </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">COUNT</code><code>   </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">VOLUME</code><code>  </code><code class="mi">241</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">6</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">13.2</code><code> </code><code class="n">KB</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">86</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">CLOSE</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                  </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">CLOSE</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-2" id="co_mastering_vectorized_backtesting_CO21-5"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">87</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">to_plot</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-3" id="co_mastering_vectorized_backtesting_CO21-6"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">88</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">for</code><code> </code><code class="n">m</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">7</code><code class="p">,</code><code> </code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">m</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">m</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-4" id="co_mastering_vectorized_backtesting_CO21-7"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">m</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">m</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                                        </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-5" id="co_mastering_vectorized_backtesting_CO21-8"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>             </code><code class="n">to_plot</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="s1">'</code><code class="s1">strategy_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">m</code><code class="p">)</code><code>   </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-6" id="co_mastering_vectorized_backtesting_CO21-9"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">89</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">to_plot</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code>&#13;
</code><code>             </code><code class="n">title</code><code class="o">=</code><code class="s1">'</code><code class="s1">AAPL intraday 05. May 2020</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>             </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">style</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO21-7" id="co_mastering_vectorized_backtesting_CO21-10"><img alt="7" src="assets/7.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-1" id="callout_mastering_vectorized_backtesting_CO21-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Reads the intraday data from a <code>CSV</code> file.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-5" id="callout_mastering_vectorized_backtesting_CO21-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the intraday log returns.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-6" id="callout_mastering_vectorized_backtesting_CO21-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Defines a <code>list</code> object to select the columns to be plotted later.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-7" id="callout_mastering_vectorized_backtesting_CO21-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Derives positionings according to the momentum strategy parameter.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-8" id="callout_mastering_vectorized_backtesting_CO21-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Calculates the resulting strategy log returns.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-9" id="callout_mastering_vectorized_backtesting_CO21-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Appends the column name to the <code>list</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO21-10" id="callout_mastering_vectorized_backtesting_CO21-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Plots all relevant columns to compare the strategies’ performances to the benchmark instrument’s performance.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mom_plot_4">&#13;
<img alt="pfat 0410" src="assets/pfat_0410.png"/>&#13;
<h6><span class="label">Figure 4-10. </span>Gross intraday performance of the Apple stock and five momentum strategies (last one, three, five, seven, and nine returns)</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-type="xref" href="#mom_plot_5">Figure 4-11</a> <a data-primary="S&amp;P 500" data-secondary="momentum strategies" data-type="indexterm" id="idm45785378644424"/>shows the performance of the same five strategies for the S&amp;P 500 index. Again, all five strategy configurations outperform the index and all show a positive return (before transaction costs).<a data-startref="ix_04_vectorized_backtesting_-asciidoc12" data-type="indexterm" id="idm45785378643112"/></p>&#13;
&#13;
<figure><div class="figure" id="mom_plot_5">&#13;
<img alt="pfat 0411" src="assets/pfat_0411.png"/>&#13;
<h6><span class="label">Figure 4-11. </span>Gross intraday performance of the S&amp;P 500 index and five momentum strategies (last one, three, five, seven, and nine returns)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generalizing the Approach" data-type="sect2"><div class="sect2" id="idm45785380016424">&#13;
<h2>Generalizing the Approach</h2>&#13;
&#13;
<p><a data-primary="momentum strategies" data-secondary="generalizing the approach" data-type="indexterm" id="idm45785378639016"/><a data-primary="MomVectorBacktester class" data-type="indexterm" id="idm45785378637976"/><a data-type="xref" href="#mom_vector_backtester">“Momentum Backtesting Class”</a> presents a Python module containing the <code>MomVectorBacktester</code> class, which allows for a bit more standardized backtesting of momentum-based strategies. The class has the following attributes:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>symbol</code>: <code>RIC</code> (instrument data) to be used</p>&#13;
</li>&#13;
<li>&#13;
<p><code>start</code>: for the start date of the data selection</p>&#13;
</li>&#13;
<li>&#13;
<p><code>end</code>: for the end date of the data selection</p>&#13;
</li>&#13;
<li>&#13;
<p><code>amount</code>: for the initial amount to be invested</p>&#13;
</li>&#13;
<li>&#13;
<p><code>tc</code>: for the proportional transaction costs per trade</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Compared to the <code>SMAVectorBacktester</code> class, this one introduces two important generalizations: the fixed amount to be invested at the beginning of the backtesting period and proportional transaction costs to get closer to market realities cost-wise. In particular, the addition of transaction costs is important in the context of time series momentum strategies that often lead to a large number of transactions over time.</p>&#13;
&#13;
<p class="pagebreak-before"><a data-primary="gold price" data-secondary="momentum strategy and" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc14"/>The application is as straightforward and convenient as before. The example first replicates the results from the interactive session before, but this time with an initial investment of 10,000 USD. <a data-type="xref" href="#mom_plot_6">Figure 4-12</a> visualizes the performance of the strategy, taking the mean of the last three returns to generate signals for the positioning. The second case covered is one with proportional transaction costs of 0.1% per trade. As <a data-type="xref" href="#mom_plot_7">Figure 4-13</a> illustrates, even small transaction costs deteriorate the performance significantly in this case. The driving factor in this regard is the relatively high frequency of trades that the strategy requires:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">90</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">MomVectorBacktester</code><code> </code><code class="kn">as</code><code> </code><code class="nn">Mom</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO22-1" id="co_mastering_vectorized_backtesting_CO22-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">91</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code> </code><code class="o">=</code><code> </code><code class="n">Mom</code><code class="o">.</code><code class="n">MomVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">XAU=</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                         </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mf">0.0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO22-2" id="co_mastering_vectorized_backtesting_CO22-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">92</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">momentum</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO22-3" id="co_mastering_vectorized_backtesting_CO22-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">92</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">20797.87</code><code class="p">,</code><code> </code><code class="mf">7395.53</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">93</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">94</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code> </code><code class="o">=</code><code> </code><code class="n">Mom</code><code class="o">.</code><code class="n">MomVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">XAU=</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                         </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mf">0.001</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO22-4" id="co_mastering_vectorized_backtesting_CO22-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">95</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">momentum</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO22-5" id="co_mastering_vectorized_backtesting_CO22-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">95</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">10749.4</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">2652.93</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">96</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mombt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO22-1" id="callout_mastering_vectorized_backtesting_CO22-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the module as <code>Mom</code></p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO22-2" id="callout_mastering_vectorized_backtesting_CO22-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates an object of the backtesting class defining the starting capital to be 10,000 USD and the proportional transaction costs to be zero.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO22-3" id="callout_mastering_vectorized_backtesting_CO22-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Backtests the momentum strategy based on a time window of <em>three days</em>: the strategy outperforms the benchmark passive investment.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO22-4" id="callout_mastering_vectorized_backtesting_CO22-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This time, proportional transaction costs of 0.1% are assumed per trade.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO22-5" id="callout_mastering_vectorized_backtesting_CO22-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>In that case, the strategy basically loses all the outperformance<a data-startref="ix_04_vectorized_backtesting_-asciidoc14" data-type="indexterm" id="idm45785379047912"/>.<a data-startref="ix_04_vectorized_backtesting_-asciidoc11" data-type="indexterm" id="idm45785379036232"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc10" data-type="indexterm" id="idm45785379035672"/></p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mom_plot_6">&#13;
<img alt="pfat 0412" src="assets/pfat_0412.png"/>&#13;
<h6><span class="label">Figure 4-12. </span>Gross performance of the gold price (USD) and the momentum strategy (last three returns, no transaction costs)</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="mom_plot_7">&#13;
<img alt="pfat 0413" src="assets/pfat_0413.png"/>&#13;
<h6><span class="label">Figure 4-13. </span>Gross performance of the gold price (USD) and the momentum strategy (last three returns, transaction costs of 0.1%)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strategies Based on Mean Reversion" data-type="sect1"><div class="sect1" id="mean_reversion">&#13;
<h1>Strategies Based on Mean Reversion</h1>&#13;
&#13;
<p><a data-primary="mean-reversion strategies" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc15"/><a data-primary="vectorization" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc16"/>Roughly speaking, mean-reversion strategies rely on a reasoning that is the opposite of momentum strategies. If a financial instrument has performed “too well” relative to its trend, it is shorted, and vice versa. To put it differently, while (time series) momentum strategies assume a <em>positive correlation</em> between returns, mean-reversion strategies assume a <em>negative correlation</em>. Balvers et al. (2000) write:</p>&#13;
<blockquote>&#13;
<p>Mean reversion refers to a tendency of asset prices to return to a trend path.</p></blockquote>&#13;
&#13;
<p>Working with a simple moving average (SMA) as a proxy for a “trend path,” a mean-reversion strategy in, say, the EUR/USD exchange rate can be backtested in a similar fashion as the backtests of the SMA- and momentum-based strategies. The idea is to define a threshold for the distance between the current stock price and the SMA, which signals a long or short position.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting into the Basics" data-type="sect2"><div class="sect2" id="idm45785379024648">&#13;
<h2>Getting into the Basics</h2>&#13;
&#13;
<p><a data-primary="mean-reversion strategies" data-secondary="basics" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc17"/>The <a data-primary="GDX (VanEck Vectors Gold Miners ETF)" data-secondary="mean-reversion strategies" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc18"/><a data-primary="GLD (SPDR Gold Shares)" data-secondary="mean-reversion strategies" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc19"/><a data-primary="gold price" data-secondary="mean-reversion strategies" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc20"/>examples that follow are for two different financial instruments for which one would expect significant mean reversion since they are both based on the gold price:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>GLD</code> is the symbol for SPDR Gold Shares, which is the largest physically backed exchange traded fund (ETF) for gold (cf. <a href="http://spdrgoldshares.com">SPDR Gold Shares home page</a>).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>GDX</code> is the symbol for the VanEck Vectors Gold Miners ETF, which invests in equity products to track the <a data-primary="NYSE Arca Gold Miners Index" data-type="indexterm" id="idm45785379014488"/>NYSE Arca Gold Miners Index (cf. <a href="https://oreil.ly/CmPBA">VanEck Vectors Gold Miners overview page</a>).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The example starts with <code>GDX</code> and implements a mean-reversion strategy on the basis of an SMA of 25 days and a threshold value of 3.5 for the absolute deviation of the current price to deviate from the SMA to signal a positioning. <a data-type="xref" href="#mr_plot_1">Figure 4-14</a> shows the differences between the current price of <code>GDX</code> and the SMA, as well as the positive and negative threshold value to generate sell and buy signals, respectively:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">97</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">GDX</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">98</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="s1">'</code><code class="s1">GDX</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">99</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">returns</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                  </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">100</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">SMA</code><code> </code><code class="o">=</code><code> </code><code class="mi">25</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO23-1" id="co_mastering_vectorized_backtesting_CO23-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">101</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO23-2" id="co_mastering_vectorized_backtesting_CO23-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">102</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">threshold</code><code> </code><code class="o">=</code><code> </code><code class="mf">3.5</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO23-3" id="co_mastering_vectorized_backtesting_CO23-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO23-4" id="co_mastering_vectorized_backtesting_CO23-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">104</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">legend</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO23-5" id="co_mastering_vectorized_backtesting_CO23-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>          </code><code class="n">plt</code><code class="o">.</code><code class="n">axhline</code><code class="p">(</code><code class="n">threshold</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">plt</code><code class="o">.</code><code class="n">axhline</code><code class="p">(</code><code class="o">-</code><code class="n">threshold</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">plt</code><code class="o">.</code><code class="n">axhline</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO23-1" id="callout_mastering_vectorized_backtesting_CO23-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The SMA parameter is defined…</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO23-2" id="callout_mastering_vectorized_backtesting_CO23-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>…and SMA (“trend path”) is calculated.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO23-3" id="callout_mastering_vectorized_backtesting_CO23-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The threshold for the signal generation is defined.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO23-4" id="callout_mastering_vectorized_backtesting_CO23-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The distance is calculated for every point in time.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO23-5" id="callout_mastering_vectorized_backtesting_CO23-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The distance values are plotted.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mr_plot_1">&#13;
<img alt="pfat 0414" src="assets/pfat_0414.png"/>&#13;
<h6><span class="label">Figure 4-14. </span>Difference between current price of <code>GDX</code> and SMA, as well as threshold values for generating mean-reversion signals</h6>&#13;
</div></figure>&#13;
&#13;
<p>Based on the differences and the fixed threshold values, positionings can again be derived in vectorized fashion. <a data-type="xref" href="#mr_plot_2">Figure 4-15</a> shows the resulting positionings:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">105</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">threshold</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">nan</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO24-1" id="co_mastering_vectorized_backtesting_CO24-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">106</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="o">-</code><code class="n">threshold</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO24-2" id="co_mastering_vectorized_backtesting_CO24-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">107</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                      </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">distance</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO24-3" id="co_mastering_vectorized_backtesting_CO24-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">108</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">ffill</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO24-4" id="co_mastering_vectorized_backtesting_CO24-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">109</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">SMA</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ylim</code><code class="o">=</code><code class="p">[</code><code class="o">-</code><code class="mf">1.1</code><code class="p">,</code><code> </code><code class="mf">1.1</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                         </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO24-5" id="co_mastering_vectorized_backtesting_CO24-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO24-1" id="callout_mastering_vectorized_backtesting_CO24-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>If the distance value is greater than the threshold value, go short (set –1 in the new column <code>position</code>), otherwise set <code>NaN</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO24-2" id="callout_mastering_vectorized_backtesting_CO24-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>If the distance value is lower than the negative threshold value, go long (set 1), otherwise keep the column <code>position</code> unchanged.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO24-3" id="callout_mastering_vectorized_backtesting_CO24-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>If there is a change in the sign of the distance value, go market neutral (set 0), otherwise keep the column <code>position</code> unchanged.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO24-4" id="callout_mastering_vectorized_backtesting_CO24-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Forward fill all <code>NaN</code> positions with the previous values; replace all remaining <code>NaN</code> values by 0.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO24-5" id="callout_mastering_vectorized_backtesting_CO24-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Plot the resulting positionings from the index position <code>SMA</code> on.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mr_plot_2">&#13;
<img alt="pfat 0415" src="assets/pfat_0415.png"/>&#13;
<h6><span class="label">Figure 4-15. </span>Positionings generated for <code>GDX</code> based on the mean-reversion strategy</h6>&#13;
</div></figure>&#13;
&#13;
<p>The final step is to derive the strategy returns that are shown in <a data-type="xref" href="#mr_plot_3">Figure 4-16</a>. The strategy outperforms the <code>GDX</code> ETF by quite a margin, although the particular parametrization leads to long periods with a neutral position (neither long or short). These neutral positions are reflected in the flat parts of the strategy curve in <a data-type="xref" href="#mr_plot_3">Figure 4-16</a>:<a data-startref="ix_04_vectorized_backtesting_-asciidoc20" data-type="indexterm" id="idm45785378151704"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">110</code><code class="p">]:</code> <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="n">data</code><code class="p">[</code><code class="s1">'returns'</code><code class="p">]</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">111</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'returns'</code><code class="p">,</code> <code class="s1">'strategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>&#13;
                  <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>&#13;
&#13;
<figure><div class="figure" id="mr_plot_3">&#13;
<img alt="pfat 0416" src="assets/pfat_0416.png"/>&#13;
<h6><span class="label">Figure 4-16. </span>Gross performance of the <code>GDX</code> ETF and the mean-reversion strategy (SMA = 25, threshold = 3.5)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generalizing the Approach" data-type="sect2"><div class="sect2" id="idm45785379024024">&#13;
<h2>Generalizing the Approach</h2>&#13;
&#13;
<p><a data-primary="mean-reversion strategies" data-secondary="generalizing the approach" data-type="indexterm" id="idm45785378086936"/>As before, the vectorized backtesting is more efficient to implement based on a respective Python class. <a data-primary="MRVectorBacktester class" data-type="indexterm" id="idm45785378085576"/>The class <code>MRVectorBacktester</code> presented in <a data-type="xref" href="#mr_vector_backtester">“Mean Reversion Backtesting Class”</a> inherits from the <code>MomVectorBacktester</code> class and just replaces the <code>run_strategy()</code> method to accommodate for the specifics of the mean-reversion strategy.</p>&#13;
&#13;
<p>The example now uses <code>GLD</code> and sets the proportional transaction costs to 0.1%. The initial amount to invest is again set to 10,000 USD. The SMA is 43 this time, and the threshold value is set to 7.5. <a data-type="xref" href="#mr_plot_4">Figure 4-17</a> shows the performance of the mean-reversion strategy compared to the <code>GLD</code> ETF:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">112</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">MRVectorBacktester</code><code> </code><code class="kn">as</code><code> </code><code class="nn">MR</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO25-1" id="co_mastering_vectorized_backtesting_CO25-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">113</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mrbt</code><code> </code><code class="o">=</code><code> </code><code class="n">MR</code><code class="o">.</code><code class="n">MRVectorBacktester</code><code class="p">(</code><code class="s1">'</code><code class="s1">GLD</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2010-1-1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">2019-12-31</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                       </code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mf">0.001</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO25-2" id="co_mastering_vectorized_backtesting_CO25-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">114</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">SMA</code><code class="o">=</code><code class="mi">43</code><code class="p">,</code><code> </code><code class="n">threshold</code><code class="o">=</code><code class="mf">7.5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO25-3" id="co_mastering_vectorized_backtesting_CO25-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">114</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="mf">13542.15</code><code class="p">,</code><code> </code><code class="mf">646.21</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">115</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mrbt</code><code class="o">.</code><code class="n">plot_results</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_mastering_vectorized_backtesting_CO25-4" id="co_mastering_vectorized_backtesting_CO25-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO25-1" id="callout_mastering_vectorized_backtesting_CO25-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Imports the module as <code>MR</code>.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO25-2" id="callout_mastering_vectorized_backtesting_CO25-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates an object of the <code>MRVectorBacktester</code> class with 10,000 USD initial capital and 0.1% proportional transaction costs per trade; the strategy significantly outperforms the benchmark instrument in this case.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO25-3" id="callout_mastering_vectorized_backtesting_CO25-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Backtests the mean-reversion strategy with an <code>SMA</code> value of 43 and a <code>threshold</code> value of 7.5.</p></dd>&#13;
<dt><a class="co" href="#co_mastering_vectorized_backtesting_CO25-4" id="callout_mastering_vectorized_backtesting_CO25-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Plots the cumulative performance of the strategy against the base instrument<a data-startref="ix_04_vectorized_backtesting_-asciidoc19" data-type="indexterm" id="idm45785377912504"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc18" data-type="indexterm" id="idm45785377911768"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc17" data-type="indexterm" id="idm45785377911064"/>.<a data-startref="ix_04_vectorized_backtesting_-asciidoc16" data-type="indexterm" id="idm45785377910232"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc15" data-type="indexterm" id="idm45785377909496"/></p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="mr_plot_4">&#13;
<img alt="pfat 0417" src="assets/pfat_0417.png"/>&#13;
<h6><span class="label">Figure 4-17. </span>Gross performance of the <code>GLD</code> ETF and the mean-reversion strategy (SMA = 43, threshold = 7.5, transaction costs of 0.1%)</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Snooping and Overfitting" data-type="sect1"><div class="sect1" id="data_snooping">&#13;
<h1>Data Snooping and Overfitting</h1>&#13;
&#13;
<p><a data-primary="vectorized backtesting" data-secondary="data snooping and overfitting" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc21"/>The emphasis in this chapter, as well as in the rest of this book, is on the technological implementation of important concepts in algorithmic trading by using Python. The strategies, parameters, data sets, and algorithms used are sometimes arbitrarily chosen and sometimes purposefully chosen to make a certain point. Without a doubt, when discussing technical methods applied to finance, it is more exciting and &#13;
<span class="keep-together">motivating</span> to see examples that show “good results,” even if they might not generalize on other financial instruments or time periods, for example.</p>&#13;
&#13;
<p><a data-primary="data snooping" data-type="indexterm" id="idm45785377901544"/>The ability to show examples with good results often comes at the cost of <em>data snooping</em>. According to White (2000), data snooping can be defined as follows:</p>&#13;
<blockquote>&#13;
<p>Data snooping occurs when a given set of data is used more than once for purposes of inference or model selection.</p></blockquote>&#13;
&#13;
<p>In other words, a certain approach might be applied multiple or even many times on the same data set to arrive at satisfactory numbers and plots. This, of course, is intellectually dishonest in trading strategy research because it pretends that a trading strategy has some economic potential that might not be realistic in a real-world context. Because the focus of this book is the use of Python as a programming language for algorithmic trading, the data snooping approach might be justifiable. This is in analogy to a mathematics book which, by way of an example, solves an equation that has a unique solution that can be easily identified. In mathematics, such straightforward examples are rather the exception than the rule, but they are nevertheless frequently used for didactical purposes.</p>&#13;
&#13;
<p><a data-primary="overfitting" data-type="indexterm" id="idm45785377897976"/>Another problem that arises in this context is <em>overfitting</em>. Overfitting in a trading &#13;
<span class="keep-together">context</span> can be described as follows (see the <a href="https://oreil.ly/uYIGs">Man Institute on Overfitting</a>):</p>&#13;
<blockquote>&#13;
<p>Overfitting is when a model describes noise rather than signal. The model may have good performance on the data on which it was tested, but little or no predictive power on new data in the future. Overfitting can be described as finding patterns that aren’t actually there. There is a cost associated with overfitting—an overfitted strategy will underperform in the future.</p></blockquote>&#13;
&#13;
<p>Even a simple strategy, such as the one based on two SMA values, allows for the backtesting of thousands of different parameter combinations. Some of those combinations are almost certain to show good performance results. As Bailey et al. (2015) discuss in detail, this easily leads to backtest overfitting with the people responsible for the backtesting often not even being aware of the problem. They point out:</p>&#13;
<blockquote>&#13;
<p>Recent advances in algorithmic research and high-performance computing have made it nearly trivial to test millions and billions of alternative investment strategies on a finite dataset of financial time series….[I]t is common practice to use this computational power to calibrate the parameters of an investment strategy in order to maximize its performance. But because the signal-to-noise ratio is so weak, often the result of such calibration is that parameters are chosen to profit from&#13;
past noise rather than future signal. The outcome is an overfit backtest.</p></blockquote>&#13;
&#13;
<p>The problem of the validity of empirical results, in a statistical sense, is of course not constrained to strategy backtesting in a financial context.</p>&#13;
&#13;
<p class="pagebreak-before">Ioannidis (2005), referring to medical publications, emphasizes probabilistic and statistical considerations when judging the reproducibility and validity of research results:</p>&#13;
<blockquote>&#13;
<p>There is increasing concern that in modern research, false findings may be the majority or even&#13;
the vast majority of published research claims. However, this should not be surprising. It can be proven that most claimed research findings are false….As has been shown previously, the probability that a research finding is indeed true depends on the prior probability of it being true (before doing the study), the statistical power of the study, and the level of statistical significance.</p></blockquote>&#13;
&#13;
<p>Against this background, if a trading strategy in this book is shown to perform well given a certain data set, combination of parameters, and maybe a specific machine learning algorithm, this neither constitutes any kind of recommendation for the particular configuration nor allows it to draw more general conclusions about the quality and performance potential of the strategy configuration at hand.</p>&#13;
&#13;
<p>You are, of course, encouraged to use the code and examples presented in this book to explore your own algorithmic trading strategy ideas and to implement them in practice based on your own backtesting results, validations, and conclusions. After all, proper and diligent strategy research is what financial markets will compensate for, not brute-force driven data snooping and overfitting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusions" data-type="sect1"><div class="sect1" id="idm45785377905608">&#13;
<h1>Conclusions</h1>&#13;
&#13;
<p>Vectorization is a powerful concept in scientific computing, as well as for financial analytics, in the context of the backtesting of algorithmic trading strategies. This chapter introduces vectorization both with <code>NumPy</code> and <code>pandas</code> and applies it to backtest three types of trading strategies: strategies based on simple moving averages, momentum, and mean reversion. The chapter admittedly makes a number of simplifying assumptions, and a rigorous backtesting of trading strategies needs to take into account more factors that determine trading success in practice, such as data issues, selection issues, avoidance of overfitting, or market microstructure elements. However, the major goal of the chapter is to focus on the concept of vectorization and what it can do in algorithmic trading from a technological and implementation point of view. With regard to all concrete examples and results presented, the problems of data snooping, overfitting, and statistical significance need to be considered.<a data-startref="ix_04_vectorized_backtesting_-asciidoc21" data-type="indexterm" id="idm45785377884664"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="References and Further Resources" data-type="sect1"><div class="sect1" id="idm45785377883608">&#13;
<h1>References and Further Resources</h1>&#13;
&#13;
<p>For the basics of vectorization with <code>NumPy</code> and <code>pandas</code>, refer to these books:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>McKinney, Wes. 2017. <em>Python for Data Analysis</em>. 2nd ed. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
<li>&#13;
<p>VanderPlas, Jake. 2016. <em>Python Data Science Handbook</em>. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For the use of <code>NumPy</code> and <code>pandas</code> in a financial context, refer to these books:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Hilpisch, Yves. 2015. <em>Derivatives Analytics with Python: Data Analysis, Models, Simulation, Calibration, and Hedging</em>. Wiley Finance.</p>&#13;
</li>&#13;
<li>&#13;
<p>⸻. 2017. <em>Listed Volatility and Variance Derivatives: A Python-Based Guide</em>. Wiley Finance.</p>&#13;
</li>&#13;
<li>&#13;
<p>⸻. 2018. <em>Python for Finance: Mastering Data-Driven Finance</em>. 2nd ed. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For the topics of data snooping and overfitting, refer to these papers:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Bailey, David, Jonathan Borwein, Marcos López de Prado, and Qiji Jim Zhu. 2015. “The Probability of Backtest Overfitting.” <em>Journal of Computational Finance</em> 20, (4): 39-69. <a href="https://oreil.ly/sOHlf"><em class="hyperlink">https://oreil.ly/sOHlf</em></a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Ioannidis, John. 2005. “Why Most Published Research Findings Are False.” <em>PLoS Medicine</em> 2, (8): 696-701.</p>&#13;
</li>&#13;
<li>&#13;
<p>White, Halbert. 2000. “A Reality Check for Data Snooping.” <em>Econometrica</em> 68, (5): 1097-1126.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For more background information and empirical results about trading strategies based on simple moving averages, refer to these sources:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Brock, William, Josef Lakonishok, and Blake LeBaron. 1992. “Simple Technical Trading Rules and the Stochastic Properties of Stock Returns.” <em>Journal of Finance</em> 47, (5): 1731-1764.</p>&#13;
</li>&#13;
<li>&#13;
<p>Droke, Clif. 2001. <em>Moving Averages Simplified.</em> Columbia: Marketplace Books.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The book by Ernest Chan covers in detail trading strategies based on momentum, as well as on mean reversion. The book is also a good source for the pitfalls of backtesting trading strategies:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Chan, Ernest. 2013. <em>Algorithmic Trading: Winning Strategies and Their Rationale</em>. Hoboken et al: John Wiley &amp; Sons.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These research papers analyze characteristics and sources of profit for <em>cross-sectional momentum</em> strategies, the traditional approach to momentum-based trading:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Chan, Louis, Narasimhan Jegadeesh, and Josef Lakonishok. 1996. “Momentum Strategies.” <em>Journal of Finance</em> 51, (5): 1681-1713.</p>&#13;
</li>&#13;
<li>&#13;
<p>Jegadeesh, Narasimhan, and Sheridan Titman. 1993. “Returns to Buying Winners and Selling Losers: Implications for Stock Market Efficiency.” <em>Journal of Finance</em> 48, (1): 65-91.</p>&#13;
</li>&#13;
<li>&#13;
<p>Jegadeesh, Narasimhan, and Sheridan Titman. 2001. “Profitability of Momentum Strategies: An Evaluation of Alternative Explanations.” <em>Journal of Finance</em> 56, (2): 599-720.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The paper by Moskowitz et al. provides an analysis of so-called <em>time series momentum</em> strategies:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Moskowitz, Tobias, Yao Hua Ooi, and Lasse Heje Pedersen. 2012. “Time Series Momentum.” <em>Journal of Financial Economics</em> 104: 228-250.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These papers empirically analyze mean reversion in asset prices:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Balvers, Ronald, Yangru Wu, and Erik Gilliland. 2000. “Mean Reversion across National Stock Markets and Parametric Contrarian Investment Strategies.” <em>Journal of Finance</em> 55, (2): 745-772.</p>&#13;
</li>&#13;
<li>&#13;
<p>Kim, Myung Jig, Charles Nelson, and Richard Startz. 1991. “Mean Reversion in Stock Prices? A Reappraisal of the Empirical Evidence.” <em>Review of Economic Studies</em> 58: 515-528.</p>&#13;
</li>&#13;
<li>&#13;
<p>Spierdijk, Laura, Jacob Bikker, and Peter van den Hoek. 2012. “Mean Reversion in International Stock Markets: An Empirical Analysis of the 20th Century.” <em>Journal of International Money and Finance</em> 31: 228-249.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Scripts" data-type="sect1"><div class="sect1" id="idm45785377883016">&#13;
<h1>Python Scripts</h1>&#13;
&#13;
<p><a data-primary="Python scripts" data-secondary="vectorized backtesting" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc22"/><a data-primary="vectorized backtesting" data-secondary="Python scripts for" data-type="indexterm" id="ix_04_vectorized_backtesting_-asciidoc23"/>This section presents Python scripts referenced and used in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SMA Backtesting Class" data-type="sect2"><div class="sect2" id="sma_vector_backtester">&#13;
<h2>SMA Backtesting Class</h2>&#13;
&#13;
<p>The following presents Python code with a class for the vectorized backtesting of strategies based on <em>simple moving averages</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Module with Class</code>&#13;
<code class="c1"># for Vectorized Backtesting</code>&#13;
<code class="c1"># of SMA-based Strategies</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">from</code> <code class="nn">scipy.optimize</code> <code class="kn">import</code> <code class="n">brute</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">SMAVectorBacktester</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="sd">''' Class for the vectorized backtesting of SMA-based trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">        RIC symbol with which to work</code>&#13;
<code class="sd">    SMA1: int</code>&#13;
<code class="sd">        time window in days for shorter SMA</code>&#13;
<code class="sd">    SMA2: int</code>&#13;
<code class="sd">        time window in days for longer SMA</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data retrieval</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data retrieval</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    set_parameters:</code>&#13;
<code class="sd">        sets one or two new SMA parameters</code>&#13;
<code class="sd">    run_strategy:</code>&#13;
<code class="sd">        runs the backtest for the SMA-based strategy</code>&#13;
<code class="sd">    plot_results:</code>&#13;
<code class="sd">        plots the performance of the strategy compared to the symbol</code>&#13;
<code class="sd">    update_and_run:</code>&#13;
<code class="sd">        updates SMA parameters and returns the (negative) absolute performance</code>&#13;
<code class="sd">    optimize_parameters:</code>&#13;
<code class="sd">        implements a brute force optimization for the two SMA parameters</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">SMA1</code><code class="p">,</code> <code class="n">SMA2</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">SMA1</code> <code class="o">=</code> <code class="n">SMA1</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">SMA2</code> <code class="o">=</code> <code class="n">SMA2</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">None</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code> <code class="o">=</code> <code class="n">raw</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">SMA1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code> <code class="o">=</code> <code class="n">raw</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">SMA2</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">set_parameters</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA1</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">SMA2</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="sd">''' Updates SMA parameters and resp. time series.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="n">SMA1</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">SMA1</code> <code class="o">=</code> <code class="n">SMA1</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">SMA1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="k">if</code> <code class="n">SMA2</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">SMA2</code> <code class="o">=</code> <code class="n">SMA2</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">SMA2</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtests the trading strategy.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code> <code class="o">&gt;</code> <code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">],</code> <code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code>&#13;
        <code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="n">data</code>&#13;
        <code class="c1"># gross performance of the strategy</code>&#13;
        <code class="n">aperf</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="c1"># out-/underperformance of strategy</code>&#13;
        <code class="n">operf</code> <code class="o">=</code> <code class="n">aperf</code> <code class="o">-</code> <code class="n">data</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="nb">round</code><code class="p">(</code><code class="n">aperf</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="nb">round</code><code class="p">(</code><code class="n">operf</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">plot_results</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the cumulative performance of the trading strategy</code>&#13;
<code class="sd">        compared to the symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'No results to plot yet. Run a strategy.'</code><code class="p">)</code>&#13;
        <code class="n">title</code> <code class="o">=</code> <code class="s1">'</code><code class="si">%s</code><code class="s1"> | SMA1=</code><code class="si">%d</code><code class="s1">, SMA2=</code><code class="si">%d</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code>&#13;
                                               <code class="bp">self</code><code class="o">.</code><code class="n">SMA1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">SMA2</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[[</code><code class="s1">'creturns'</code><code class="p">,</code> <code class="s1">'cstrategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="n">title</code><code class="p">,</code>&#13;
                                                     <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">update_and_run</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA</code><code class="p">):</code>&#13;
        <code class="sd">''' Updates SMA parameters and returns negative absolute performance</code>&#13;
<code class="sd">        (for minimazation algorithm).</code>&#13;
&#13;
<code class="sd">        Parameters</code>&#13;
<code class="sd">        ==========</code>&#13;
<code class="sd">        SMA: tuple</code>&#13;
<code class="sd">            SMA parameter tuple</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">set_parameters</code><code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="n">SMA</code><code class="p">[</code><code class="mi">0</code><code class="p">]),</code> <code class="nb">int</code><code class="p">(</code><code class="n">SMA</code><code class="p">[</code><code class="mi">1</code><code class="p">]))</code>&#13;
        <code class="k">return</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">()[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">optimize_parameters</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA1_range</code><code class="p">,</code> <code class="n">SMA2_range</code><code class="p">):</code>&#13;
        <code class="sd">''' Finds global maximum given the SMA parameter ranges.</code>&#13;
&#13;
<code class="sd">        Parameters</code>&#13;
<code class="sd">        ==========</code>&#13;
<code class="sd">        SMA1_range, SMA2_range: tuple</code>&#13;
<code class="sd">            tuples of the form (start, end, step size)</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">opt</code> <code class="o">=</code> <code class="n">brute</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">update_and_run</code><code class="p">,</code> <code class="p">(</code><code class="n">SMA1_range</code><code class="p">,</code> <code class="n">SMA2_range</code><code class="p">),</code> <code class="n">finish</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">opt</code><code class="p">,</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">update_and_run</code><code class="p">(</code><code class="n">opt</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">smabt</code> <code class="o">=</code> <code class="n">SMAVectorBacktester</code><code class="p">(</code><code class="s1">'EUR='</code><code class="p">,</code> <code class="mi">42</code><code class="p">,</code> <code class="mi">252</code><code class="p">,</code>&#13;
                                <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">smabt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">())</code>&#13;
    <code class="n">smabt</code><code class="o">.</code><code class="n">set_parameters</code><code class="p">(</code><code class="n">SMA1</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code> <code class="n">SMA2</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">smabt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">())</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">smabt</code><code class="o">.</code><code class="n">optimize_parameters</code><code class="p">((</code><code class="mi">30</code><code class="p">,</code> <code class="mi">56</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code> <code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">300</code><code class="p">,</code> <code class="mi">4</code><code class="p">)))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Momentum Backtesting Class" data-type="sect2"><div class="sect2" id="mom_vector_backtester">&#13;
<h2>Momentum Backtesting Class</h2>&#13;
&#13;
<p><a data-primary="mean-reversion strategies" data-secondary="Python code with a class for vectorized backtesting" data-type="indexterm" id="idm45785377636984"/><a data-primary="momentum strategies" data-secondary="Python code with a class for vectorized backtesting" data-type="indexterm" id="idm45785377635848"/><a data-primary="vectorized backtesting" data-secondary="Python code with a class for vectorized backtesting of mean-reversion trading strategies" data-type="indexterm" id="idm45785377634872"/>The following presents Python code with a class for the vectorized backtesting of strategies based on <em>time series momentum</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Module with Class</code>&#13;
<code class="c1"># for Vectorized Backtesting</code>&#13;
<code class="c1"># of Momentum-Based Strategies</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">MomVectorBacktester</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="sd">''' Class for the vectorized backtesting of</code>&#13;
<code class="sd">    momentum-based trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">       RIC (financial instrument) to work with</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data selection</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data selection</code>&#13;
<code class="sd">    amount: int, float</code>&#13;
<code class="sd">        amount to be invested at the beginning</code>&#13;
<code class="sd">    tc: float</code>&#13;
<code class="sd">        proportional transaction costs (e.g., 0.5% = 0.005) per trade</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    run_strategy:</code>&#13;
<code class="sd">        runs the backtest for the momentum-based strategy</code>&#13;
<code class="sd">    plot_results:</code>&#13;
<code class="sd">        plots the performance of the strategy compared to the symbol</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">,</code> <code class="n">amount</code><code class="p">,</code> <code class="n">tc</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="n">amount</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">tc</code> <code class="o">=</code> <code class="n">tc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="bp">None</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">momentum</code><code class="o">=</code><code class="mi">1</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtests the trading strategy.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">momentum</code> <code class="o">=</code> <code class="n">momentum</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">momentum</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">())</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code>&#13;
        <code class="c1"># determine when a trade takes place</code>&#13;
        <code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">trades</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">0</code>&#13;
        <code class="c1"># subtract transaction costs from return when trade takes place</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">][</code><code class="n">trades</code><code class="p">]</code> <code class="o">-=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> \&#13;
            <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="n">data</code>&#13;
        <code class="c1"># absolute performance of the strategy</code>&#13;
        <code class="n">aperf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="c1"># out-/underperformance of strategy</code>&#13;
        <code class="n">operf</code> <code class="o">=</code> <code class="n">aperf</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="nb">round</code><code class="p">(</code><code class="n">aperf</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="nb">round</code><code class="p">(</code><code class="n">operf</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">plot_results</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the cumulative performance of the trading strategy</code>&#13;
<code class="sd">        compared to the symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'No results to plot yet. Run a strategy.'</code><code class="p">)</code>&#13;
        <code class="n">title</code> <code class="o">=</code> <code class="s1">'</code><code class="si">%s</code><code class="s1"> | TC = </code><code class="si">%.4f</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[[</code><code class="s1">'creturns'</code><code class="p">,</code> <code class="s1">'cstrategy'</code><code class="p">]]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="n">title</code><code class="p">,</code>&#13;
                                                     <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">mombt</code> <code class="o">=</code> <code class="n">MomVectorBacktester</code><code class="p">(</code><code class="s1">'XAU='</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">,</code>&#13;
                                <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mombt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">())</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mombt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">momentum</code><code class="o">=</code><code class="mi">2</code><code class="p">))</code>&#13;
    <code class="n">mombt</code> <code class="o">=</code> <code class="n">MomVectorBacktester</code><code class="p">(</code><code class="s1">'XAU='</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">,</code>&#13;
                                <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mombt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">momentum</code><code class="o">=</code><code class="mi">2</code><code class="p">))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mean Reversion Backtesting Class" data-type="sect2"><div class="sect2" id="mr_vector_backtester">&#13;
<h2>Mean Reversion Backtesting Class</h2>&#13;
&#13;
<p>The following presents Python code with a class for the vectorized backtesting of strategies based on <em>mean reversion</em>:<a data-startref="ix_04_vectorized_backtesting_-asciidoc23" data-type="indexterm" id="idm45785376961336"/><a data-startref="ix_04_vectorized_backtesting_-asciidoc22" data-type="indexterm" id="idm45785376960504"/>.<a data-startref="ix_04_vectorized_backtesting_-asciidoc0" data-type="indexterm" id="idm45785376959672"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Module with Class</code>&#13;
<code class="c1"># for Vectorized Backtesting</code>&#13;
<code class="c1"># of Mean-Reversion Strategies</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">from</code> <code class="nn">MomVectorBacktester</code> <code class="kn">import</code> <code class="o">*</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">MRVectorBacktester</code><code class="p">(</code><code class="n">MomVectorBacktester</code><code class="p">):</code>&#13;
    <code class="sd">''' Class for the vectorized backtesting of</code>&#13;
<code class="sd">    mean reversion-based trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">        RIC symbol with which to work</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data retrieval</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data retrieval</code>&#13;
<code class="sd">    amount: int, float</code>&#13;
<code class="sd">        amount to be invested at the beginning</code>&#13;
<code class="sd">    tc: float</code>&#13;
<code class="sd">        proportional transaction costs (e.g., 0.5% = 0.005) per trade</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    run_strategy:</code>&#13;
<code class="sd">        runs the backtest for the mean reversion-based strategy</code>&#13;
<code class="sd">    plot_results:</code>&#13;
<code class="sd">        plots the performance of the strategy compared to the symbol</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA</code><code class="p">,</code> <code class="n">threshold</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtests the trading strategy.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'sma'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'distance'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code> <code class="o">-</code> <code class="n">data</code><code class="p">[</code><code class="s1">'sma'</code><code class="p">]</code>&#13;
        <code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="c1"># sell signals</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'distance'</code><code class="p">]</code> <code class="o">&gt;</code> <code class="n">threshold</code><code class="p">,</code>&#13;
                                    <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="n">np</code><code class="o">.</code><code class="n">nan</code><code class="p">)</code>&#13;
        <code class="c1"># buy signals</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'distance'</code><code class="p">]</code> <code class="o">&lt;</code> <code class="o">-</code><code class="n">threshold</code><code class="p">,</code>&#13;
                                    <code class="mi">1</code><code class="p">,</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">])</code>&#13;
        <code class="c1"># crossing of current price and SMA (zero distance)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'distance'</code><code class="p">]</code> <code class="o">*</code>&#13;
                                    <code class="n">data</code><code class="p">[</code><code class="s1">'distance'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">,</code>&#13;
                                    <code class="mi">0</code><code class="p">,</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">])</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">ffill</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code>&#13;
        <code class="c1"># determine when a trade takes place</code>&#13;
        <code class="n">trades</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="s1">'position'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">()</code><code class="o">.</code><code class="n">fillna</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">!=</code> <code class="mi">0</code>&#13;
        <code class="c1"># subtract transaction costs from return when trade takes place</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">][</code><code class="n">trades</code><code class="p">]</code> <code class="o">-=</code> <code class="bp">self</code><code class="o">.</code><code class="n">tc</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> \&#13;
            <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="n">data</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">*</code> \&#13;
            <code class="n">data</code><code class="p">[</code><code class="s1">'strategy'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">results</code> <code class="o">=</code> <code class="n">data</code>&#13;
        <code class="c1"># absolute performance of the strategy</code>&#13;
        <code class="n">aperf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'cstrategy'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="c1"># out-/underperformance of strategy</code>&#13;
        <code class="n">operf</code> <code class="o">=</code> <code class="n">aperf</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">results</code><code class="p">[</code><code class="s1">'creturns'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="nb">round</code><code class="p">(</code><code class="n">aperf</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="nb">round</code><code class="p">(</code><code class="n">operf</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">mrbt</code> <code class="o">=</code> <code class="n">MRVectorBacktester</code><code class="p">(</code><code class="s1">'GDX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">,</code>&#13;
                              <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">SMA</code><code class="o">=</code><code class="mi">25</code><code class="p">,</code> <code class="n">threshold</code><code class="o">=</code><code class="mi">5</code><code class="p">))</code>&#13;
    <code class="n">mrbt</code> <code class="o">=</code> <code class="n">MRVectorBacktester</code><code class="p">(</code><code class="s1">'GDX'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">,</code>&#13;
                              <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">SMA</code><code class="o">=</code><code class="mi">25</code><code class="p">,</code> <code class="n">threshold</code><code class="o">=</code><code class="mi">5</code><code class="p">))</code>&#13;
    <code class="n">mrbt</code> <code class="o">=</code> <code class="n">MRVectorBacktester</code><code class="p">(</code><code class="s1">'GLD'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2020-12-31'</code><code class="p">,</code>&#13;
                              <code class="mi">10000</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">mrbt</code><code class="o">.</code><code class="n">run_strategy</code><code class="p">(</code><code class="n">SMA</code><code class="o">=</code><code class="mi">42</code><code class="p">,</code> <code class="n">threshold</code><code class="o">=</code><code class="mf">7.5</code><code class="p">))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45785385873496"><sup><a href="ch04.html#idm45785385873496-marker">1</a></sup> Source: “Does the Past Predict the Future?” <em>The Economist</em>, September 23, 2009.</p><p data-type="footnote" id="idm45785380499832"><sup><a href="ch04.html#idm45785380499832-marker">2</a></sup> For more on the <code>datetime</code> and <code>timedelta</code> objects, refer to Appendix C of Hilpisch (2018).</p></div></div></section></body></html>