<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 10. Candlestick-Based Trend-Following Strategies" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter10">
<h1><span class="label">Chapter 10. </span>Candlestick-Based <span class="keep-together">Trend-Following Strategies</span></h1>
<p>Pattern<a contenteditable="false" data-primary="trend-following strategies" data-type="indexterm" id="ix_trend_strat_ch10"/> recognition is only one part of the equation. When you a find a pattern, you are most likely to use it within a wider trading framework, as trading systems relying purely on candlestick patterns are unlikely to yield consistent and stable positive returns.</p>
<p>This chapter discusses some examples of strategies you can use to filter the patterns using specific technical rules when dealing with trend following. Each market has its own characteristics and must have optimized strategy parameters, which is why I recommend you focus on understanding the main ideas and concepts rather than take away the exact parameters of the strategies presented in this chapter.</p>
<p>Ideally, the strategies should help you understand how to combine the different candlestick patterns (classic and modern) with some technical indicators. I also discuss the indicators in this chapter so that you understand their mechanisms and their weaknesses.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><em>Filtering</em> refers<a contenteditable="false" data-primary="filtering trends" data-type="indexterm" id="idm46762853143280"/> to the concept of choosing the signals that have a better probability of providing a positive return.</p>
</div>
<section class="pagebreak-before" data-pdf-bookmark="Combining the Double Trouble Pattern with the RSI" data-type="sect1"><div class="sect1" id="idm46762853141808">
<h1 class="less_space">Combining the Double Trouble Pattern with the RSI</h1>
<p>As a reminder<a contenteditable="false" data-primary="trend-following patterns" data-secondary="Double Trouble pattern" data-type="indexterm" id="ix_trend_follow_dble_tble_ch10"/><a contenteditable="false" data-primary="trend-following strategies" data-secondary="Double Trouble pattern and RSI indicator" data-type="indexterm" id="ix_trend_strat_dt_rsi"/><a contenteditable="false" data-primary="modern trend-following patterns" data-secondary="Double Trouble pattern" data-type="indexterm" id="ix_mod_trend_dble_trble_ch10"/><a contenteditable="false" data-primary="relative strength index (RSI) indicator" data-secondary="with Double Trouble pattern" data-secondary-sortas="Double Trouble pattern" data-type="indexterm" id="ix_rsi_dble_tble"/><a contenteditable="false" data-primary="Double Trouble pattern" data-type="indexterm" id="ix_double_trouble_patt_ch10"/><a contenteditable="false" data-primary="average true range (ATR)" data-type="indexterm" id="idm46762853132480"/>, the Double Trouble pattern is a modern trend-following candlestick configuration that incorporates volatility in its characteristics (calculated using the ATR indicator). The RSI is an indicator  that, as discussed previously in the book, reinterprets the market’s momentum into values between 0 and 100 to better understand the current dynamic.</p>
<p>Even though the RSI is a contrarian indicator, I will show you a technique for using it within a trend-following framework.</p>
<p>This strategy uses the RSI as a filter for the detected Double Trouble patterns. This means that whenever a pattern is found, it is run through an RSI filter to validate the signal.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The RSI<a contenteditable="false" data-primary="momentum principle" data-type="indexterm" id="idm46762853129584"/><a contenteditable="false" data-primary="downtrend, asset direction on timeline" data-type="indexterm" id="idm46762853128608"/><a contenteditable="false" data-primary="uptrend, asset direction on timeline" data-type="indexterm" id="idm46762853127632"/> can also be a momentum gauge. Therefore, values above 50 represent bullish momentum (uptrend) while values below 50 represent bearish momentum (downtrend). This is one way to use the RSI as a trend-following indicator.</p>
</div>
<p>The trading conditions of the strategy are as follows:</p>
<ul>
<li>A long signal is generated whenever a bullish Double Trouble pattern appears while the 14-period RSI is above 50.</li>
<li>A short signal is generated whenever a bearish Double Trouble pattern appears while the 14-period RSI is below 50.</li>
</ul>
<p>The filter<a contenteditable="false" data-primary="filtering trends" data-type="indexterm" id="idm46762853124224"/> is therefore the value of the RSI relative to the neutrality level of 50. This is used to increase the hit ratio of the trades using the invisible hand mechanism.<sup><a data-type="noteref" href="ch10.xhtml#idm46762853123120" id="idm46762853123120-marker">1</a></sup> The basic intuition of the strategy is to take only bullish signals in a bullish regime and only bearish signals in a bearish regime.</p>
<p>The following code snippet shows how to code the signal function of the strategy:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code>
</code><code>           </code><code class="n">atr_column</code><code class="p">,</code><code> </code><code class="n">rsi_column</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>  </code><code>
</code><code>        </code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code>           </code><code>
</code><strong><code>           </code><code class="c1"># Bullish setup</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">atr_column</code><code class="p">]</code><code class="p">)</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">rsi_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">50</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>       </code><strong><code>    </code><code class="c1"># Bearish setup</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">atr_column</code><code class="p">]</code><code class="p">)</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">rsi_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">50</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p>Notice the addition of the filter through the RSI line of code stating its value relative to the neutrality level 50. <a data-type="xref" href="#figure10-1">Figure 10-1</a> shows a signal chart on USDCAD.</p>
<p>You can always tweak the strategy so that it better fits your profile and the market’s characteristics. However, you should keep in mind that the RSI is not a miraculous predictor of trend as it is price-derived and therefore lagging (that is, it does not predict the future but simply tells the story of the past). Also, the RSI tends to break and reintegrate the 50 level many times, which may give faulty signals<a contenteditable="false" data-primary="" data-startref="ix_trend_strat_dt_rsi" data-type="indexterm" id="idm46762852784720"/><a contenteditable="false" data-primary="" data-startref="ix_rsi_dble_tble" data-type="indexterm" id="idm46762852851904"/><a contenteditable="false" data-primary="" data-startref="ix_trend_follow_dble_tble_ch10" data-type="indexterm" id="idm46762852850528"/><a contenteditable="false" data-primary="" data-startref="ix_double_trouble_patt_ch10" data-type="indexterm" id="idm46762852849184"/><a contenteditable="false" data-primary="" data-startref="ix_mod_trend_dble_trble_ch10" data-type="indexterm" id="idm46762853004128"/>.</p>
<figure><div class="figure" id="figure10-1"><img alt="" height="297" src="assets/mfpr_1001.png" width="600"/>
<h6><span class="label">Figure 10-1. </span>Signal chart of the strategy using the Double Trouble pattern and the RSI</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Combining the Three Candles Pattern with Moving Averages" data-type="sect1"><div class="sect1" id="idm46762853141216">
<h1>Combining the Three Candles Pattern with <span class="keep-together">Moving Averages</span></h1>
<p>Moving<a contenteditable="false" data-primary="trend-following patterns" data-secondary="Three Candles pattern" data-type="indexterm" id="ix_trend_foll_3candle_ch10"/><a contenteditable="false" data-primary="trend-following strategies" data-secondary="Three Candles pattern and moving averages" data-type="indexterm" id="ix_trend_strat_3candle"/><a contenteditable="false" data-primary="moving averages" data-type="indexterm" id="ix_move_av_ch10"/><a contenteditable="false" data-primary="Three Candles pattern" data-type="indexterm" id="ix_3candle_patt_ch10"/><a contenteditable="false" data-primary="classic trend-following patterns" data-secondary="Three Candles pattern" data-type="indexterm" id="ix_class_trend_3candle_ch10"/><a contenteditable="false" data-primary="filtering trends" data-type="indexterm" id="idm46762852841952"/> averages are great trend filters and help in determining whether to take the signal or not. Remember, a <em>moving average</em> is a mean that follows the market price using a rolling window. This strategy uses two trend-following elements from different fields<sup><a data-type="noteref" href="ch10.xhtml#idm46762852840176" id="idm46762852840176-marker">2</a></sup> in order to give a signal.</p>
<p>The Three Candles pattern is a trend-following configuration composed of big-bodied homogenous successive candlesticks that confirm the underlying trend. Generally, a bullish Three Candles pattern is called Three White Soldiers, while the bearish version is called Three Black Crows.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Similar to using the RSI as a trend follower, using moving averages is extremely useful in determining the underlying trend.</p>
</div>
<p>When you see a market above its moving average (for example, a 100-period moving average), it is generally a sign that a bullish regime is in progress, and when you see a market below its moving average, it is generally a sign that a bearish regime is in progress, thus indicating which type of signal to prefer.</p>
<p>The trading<a contenteditable="false" data-primary="Three Black Crows pattern" data-type="indexterm" id="idm46762853011520"/><a contenteditable="false" data-primary="Three White Soldiers pattern" data-type="indexterm" id="idm46762853010416"/> conditions of the strategy are as follows:</p>
<ul>
<li>A long signal is generated whenever a Three White Soldiers pattern appears while the market price is above its 100-period moving average.</li>
<li>A short signal is generated whenever a Three Black Crows pattern appears while the market price is below its 100-period moving average.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The trend-following strategies use a combination of a candlestick pattern and a trend filter that increases the conviction in the trade. Although historical back-testing shows that the hit ratio is not always increased with the filter, for some markets, the ratio is significantly enhanced.</p>
</div>
<p>The following code snippet shows how to code the signal function of the strategy:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code class="n">ma_column</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code>
</code><code>           </code><code class="n">sell_column</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code>           </code><code>
</code><code>       </code><strong><code>    </code><code class="c1"># Bullish setup</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">body</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="n">body</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code>\</code><code> </code><code>
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">body</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>              </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>              </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>              </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">ma_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>                    </code><code>
</code><code>           </code><strong><code class="c1"># Bearish setup</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">body</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">body</code><code> </code><code>\
</code><code>                </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>                </code><code class="o">&gt;</code><code> </code><code class="n">body</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>                </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code>\
</code><code>                </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">ma_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code>
</code><code>                    </code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p><a data-type="xref" href="#figure10-2">Figure 10-2</a> shows an example of a signal chart with a 100-period moving average (the swooping line starting at the upper left), which acts as a filter. Notice how you see only bullish signals when the market is above its moving average and see only bearish signals when the market is below its moving average.</p>
<figure><div class="figure" id="figure10-2"><img alt="" height="297" src="assets/mfpr_1002.png" width="600"/>
<h6><span class="label">Figure 10-2. </span>Signal chart of the strategy using the Three Candles pattern and <span class="keep-together">moving averages</span></h6>
</div></figure>
<p>The strategy<a contenteditable="false" data-primary="Three White Soldiers pattern" data-type="indexterm" id="idm46762853070832"/> is best used in confirmation of other trend-following strategies. For example, a fundamental trader has a carry trade in USDJPY and sees that a Three White Soldiers pattern has emerged while the market is above its 100-period moving average. This observation can serve as a conviction enhancer or a confirmation to add more to the position. After all, trading is a numbers game, and stacking up the odds on your side increases the probability of gain<a contenteditable="false" data-primary="" data-startref="ix_trend_strat_3candle" data-type="indexterm" id="idm46762852002688"/><a contenteditable="false" data-primary="" data-startref="ix_3candle_patt_ch10" data-type="indexterm" id="idm46762852001312"/><a contenteditable="false" data-primary="" data-startref="ix_trend_foll_3candle_ch10" data-type="indexterm" id="idm46762851999936"/><a contenteditable="false" data-primary="" data-startref="ix_class_trend_3candle_ch10" data-type="indexterm" id="idm46762851943952"/><a contenteditable="false" data-primary="" data-startref="ix_move_av_ch10" data-type="indexterm" id="idm46762851942560"/>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A <em>fundamental trader</em> is a trader<a contenteditable="false" data-primary="fundamental trader" data-type="indexterm" id="idm46762852154608"/> who relies on economic and financial analysis instead of technical analysis to make their decisions.</p>
<p>A <em>carry trade</em> is a currency<a contenteditable="false" data-primary="markets" data-secondary="currency market" data-type="indexterm" id="idm46762852469056"/><a contenteditable="false" data-primary="carry trade" data-type="indexterm" id="idm46762852467648"/><a contenteditable="false" data-primary="currency market, carry trade" data-type="indexterm" id="idm46762852466544"/> position that entails going long on (buying) the currency with the higher interest rate and shorting (selling) the currency with the lower interest rate to benefit from the interest rate differential.</p>
</div>
</div></section>
<section data-pdf-bookmark="Combining the Bottle Pattern with the Stochastic Oscillator" data-type="sect1"><div class="sect1" id="idm46762852792064">
<h1>Combining the Bottle Pattern with <span class="keep-together">the Stochastic Oscillator</span></h1>
<p>Similar<a contenteditable="false" data-primary="trend-following patterns" data-secondary="Bottle pattern" data-type="indexterm" id="ix_trend_foll_bottle_ch10"/><a contenteditable="false" data-primary="trend-following strategies" data-secondary="Bottle pattern and stochastic oscillator indicator" data-type="indexterm" id="ix_trend_strat_bottle"/><a contenteditable="false" data-primary="modern trend-following patterns" data-secondary="Bottle pattern" data-type="indexterm" id="ix_mod_trend_bottle_ch10"/><a contenteditable="false" data-primary="stochastic oscillator indicator" data-type="indexterm" id="ix_stoch_osc_indic"/><a contenteditable="false" data-primary="Bottle pattern" data-type="indexterm" id="ix_bottle_patt_ch10"/> to the RSI, the stochastic oscillator is a momentum indicator heavily used in technical trading and known both to the retail and professional communities. The <em>stochastic oscillator</em> uses a basic normalization function to trap the values between 0 and 100. It is easier to calculate than the RSI. Before discussing the oscillator, let’s look at the concept<a contenteditable="false" data-primary="normalization" data-type="indexterm" id="idm46762853033312"/> of <em>normalization</em>.</p>
<p>Whenever you have an array of different unbounded values such as the market price (or any other random set of time series), you can normalize the values between 0 and 1, with 0 being the lowest value for a specific time window and 1 being the highest value for a specific time window. Take a look at this table:</p>
<table id="table10-1">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr>
<th>Time step</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Value</strong></td>
<td>10</td>
<td>40</td>
<td>5</td>
<td>90</td>
<td>25</td>
</tr>
<tr>
<td>Normalized value</td>
<td>0.06</td>
<td>0.41</td>
<td><strong>0.00</strong></td>
<td><strong>1.00</strong></td>
<td>0.24</td>
</tr>
</tbody>
</table>
<p>The table shows that when the variable moves in time from period 1 to period 5, the normalized values show that they can be bounded between 0 and 1, with 0 referring to the lowest value (5) and 1 referring to the highest value (90). Similarly, notice how the value that lies approximately between 0 and 1 has a normalized value of 0.41, which means it is probably the middle value. This is normal as 40 is around half the distance between 5 and 90.</p>
<p>The following formula shows how to normalize any value between 0 and 1 given a specific time window:</p>
<div data-type="equation">
<math alttext="x Subscript Normalized Baseline equals StartFraction x Subscript Original Baseline minus x Subscript Low Baseline Over x Subscript High Baseline minus x Subscript Low Baseline EndFraction">
<mrow>
<msub><mi>x</mi> <mtext>Normalized</mtext> </msub>
<mo>=</mo>
<mfrac><mrow><msub><mi>x</mi> <mtext>Original</mtext> </msub><mo>-</mo><msub><mi>x</mi> <mtext>Low</mtext> </msub></mrow> <mrow><msub><mi>x</mi> <mtext>High</mtext> </msub><mo>-</mo><msub><mi>x</mi> <mtext>Low</mtext> </msub></mrow></mfrac>
</mrow>
</math>
</div>
<p>Let’s try an example using the previous table. Take the value 10 and try to normalize it using the formula. You should have the following calculation:</p>
<div data-type="equation">
<math alttext="x Subscript Normalized Baseline equals StartFraction 10 minus 5 Over 90 minus 5 EndFraction equals 0.06">
<mrow>
<msub><mi>x</mi> <mtext>Normalized</mtext> </msub>
<mo>=</mo>
<mfrac><mrow><mn>10</mn><mo>-</mo><mn>5</mn></mrow> <mrow><mn>90</mn><mo>-</mo><mn>5</mn></mrow></mfrac>
<mo>=</mo>
<mn>0</mn>
<mo lspace="0%" rspace="0%">.</mo>
<mn>06</mn>
</mrow>
</math>
</div>
<p class="pagebreak-before">The stochastic oscillator normalizes the market price in a modified way by incorporating the highs and lows in the formula so that it becomes as follows:</p>
<div data-type="equation">
<math alttext="Stochastic value Subscript i Baseline equals StartFraction Close Subscript i Baseline minus Low Subscript i minus n colon i Baseline Over High Subscript i minus n colon i Baseline minus Low Subscript i minus n colon i Baseline EndFraction">
<mrow>
<mtext>Stochastic</mtext>
<mspace width="4.pt"/>
<msub><mtext>value</mtext> <mi>i</mi> </msub>
<mo>=</mo>
<mfrac><mrow><msub><mtext>Close</mtext> <mi>i</mi> </msub><mo>-</mo><msub><mtext>Low</mtext> <mrow><mi>i</mi><mo>-</mo><mi>n</mi><mo>:</mo><mi>i</mi></mrow> </msub></mrow> <mrow><msub><mtext>High</mtext> <mrow><mi>i</mi><mo>-</mo><mi>n</mi><mo>:</mo><mi>i</mi></mrow> </msub><mo>-</mo><msub><mtext>Low</mtext> <mrow><mi>i</mi><mo>-</mo><mi>n</mi><mo>:</mo><mi>i</mi></mrow> </msub></mrow></mfrac>
</mrow>
</math>
</div>
<p>The formula means that the current value of the stochastic is the difference between the current close price minus the lowest low price for a set lookback period divided by the difference between the highest high price and the lowest low price for the same lookback period.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The difference between the simple normalization function and the stochastic oscillator’s function is the addition of the high price and low price to the latter.</p>
</div>
<p>The<a contenteditable="false" data-primary="signal line (slowing), calculating on stochastic oscillator" data-type="indexterm" id="idm46762852868704"/> stochastic oscillator can be described as the smoothed version of the previous formula, and it is generally charted with a short-term moving average calculated on its value, called the <em>signal line</em>. To create the default stochastic oscillator, follow these steps:</p>
<ol>
<li>Normalize the values using the stochastic oscillator’s function using a rolling window of 14 periods.</li>
<li>Smooth out the result from the first step with a three-period moving average. This is the stochastic oscillator.</li>
<li>Calculate the signal line, which is another three-period moving average calculated on the values of the second step. This is the signal line.</li>
</ol>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The first<a contenteditable="false" data-primary="smoothing" data-secondary="stochastic oscillator" data-type="indexterm" id="idm46762852808656"/> moving average calculated on the stochastic oscillator is referred to as <em>smoothing</em>, while the signal line is referred to as <span class="keep-together"><em>slowing</em></span>.</p>
</div>
<p>Similar<a contenteditable="false" data-primary="relative strength index (RSI) indicator" data-secondary="compared to stochastic oscillator" data-type="indexterm" id="idm46762852963968"/> to the RSI, the stochastic oscillator is bounded between 0 and 100 and has an oversold zone below 20 and an overbought zone above 80. Because of its formula, it is relatively more volatile than the RSI and tends to move from one extreme to another faster.</p>
<p>Many techniques<a contenteditable="false" data-primary="cross technique, stochastic oscillator" data-type="indexterm" id="idm46762852961808"/> are possible with the stochastic oscillator, but the one that interests us is the cross between it and its signal line. This is referred to as the <em>cross technique</em> and is famous in contrarian strategies. (However, I am using it with a trend-following candlestick pattern and therefore turning it into a trend-following technique.)</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You must be careful with the stochastic oscillator as it tends to stick to the extremes from time to time due to the nature of the normalization function, thus providing false signals. The stickiness effect is manifested when the oscillator remains in the oversold and overbought zones for extended periods of time.</p>
</div>
<p>The following snippet shows how to code the stochastic oscillator:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">stochastic_oscillator</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> 
                             <code class="n">lookback</code><code class="p">,</code> 
                             <code class="n">high</code><code class="p">,</code> 
                             <code class="n">low</code><code class="p">,</code> 
                             <code class="n">close</code><code class="p">,</code> 
                             <code class="n">position</code><code class="p">,</code> 
                             <code class="n">slowing</code> <code class="o">=</code> <code class="kc">False</code><code class="p">,</code> 
                             <code class="n">smoothing</code> <code class="o">=</code> <code class="kc">False</code><code class="p">,</code> 
                             <code class="n">slowing_period</code> <code class="o">=</code> <code class="mi">1</code><code class="p">,</code> 
                             <code class="n">smoothing_period</code> <code class="o">=</code> <code class="mi">1</code><code class="p">):</code>
            
    <code class="n">data</code> <code class="o">=</code> <code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
        
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)):</code>
            
        <code class="k">try</code><code class="p">:</code>
            
            <code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">position</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">close</code><code class="p">]</code> <code class="o">-</code> <code class="nb">min</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code> <code class="o">-</code> <code class="n">lookback</code> \
                                <code class="o">+</code> <code class="mi">1</code><code class="p">:</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">low</code><code class="p">]))</code> <code class="o">/</code> <code class="p">(</code><code class="nb">max</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code> <code class="o">-</code> <code class="n">lookback</code>\
                                <code class="o">+</code> <code class="mi">1</code><code class="p">:</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">high</code><code class="p">])</code> <code class="o">-</code> <code class="nb">min</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code> <code class="o">-</code> <code class="n">lookback</code> \
                                <code class="o">+</code> <code class="mi">1</code><code class="p">:</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">low</code><code class="p">]))</code>
            
        <code class="k">except</code> <code class="ne">ValueError</code><code class="p">:</code>
            
            <code class="k">pass</code>
        
    <code class="n">data</code><code class="p">[:,</code> <code class="n">position</code><code class="p">]</code> <code class="o">=</code> <code class="n">data</code><code class="p">[:,</code> <code class="n">position</code><code class="p">]</code> <code class="o">*</code> <code class="mi">100</code>  
            
    <code class="k">if</code> <code class="n">slowing</code> <code class="o">==</code> <code class="kc">True</code> <code class="ow">and</code> <code class="n">smoothing</code> <code class="o">==</code> <code class="kc">False</code><code class="p">:</code>
        
        <code class="n">data</code> <code class="o">=</code> <code class="n">ma</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">slowing_period</code><code class="p">,</code> <code class="n">position</code><code class="p">,</code> <code class="n">position</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
    
    <code class="k">if</code> <code class="n">smoothing</code> <code class="o">==</code> <code class="kc">True</code> <code class="ow">and</code> <code class="n">slowing</code> <code class="o">==</code> <code class="kc">False</code><code class="p">:</code>
        
        <code class="n">data</code> <code class="o">=</code> <code class="n">ma</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">smoothing_period</code><code class="p">,</code> <code class="n">position</code><code class="p">,</code> <code class="n">position</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
        
    <code class="k">if</code> <code class="n">smoothing</code> <code class="o">==</code> <code class="kc">True</code> <code class="ow">and</code> <code class="n">slowing</code> <code class="o">==</code> <code class="kc">True</code><code class="p">:</code>
    
        <code class="n">data</code> <code class="o">=</code> <code class="n">ma</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">slowing_period</code><code class="p">,</code> <code class="n">position</code><code class="p">,</code>   <code class="n">position</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
        
        <code class="n">data</code> <code class="o">=</code> <code class="n">ma</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">smoothing_period</code><code class="p">,</code> <code class="n">position</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">position</code> <code class="o">+</code> <code class="mi">2</code><code class="p">)</code>        
       
    <code class="n">data</code> <code class="o">=</code> <code class="n">delete_row</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">lookback</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">data</code>
</pre>
<p>The trading conditions of the strategy are as follows:</p>
<ul>
<li>A long signal is generated whenever a bullish Bottle pattern appears while the stochastic oscillator is above its signal line.</li>
<li>A short signal is generated whenever a bearish Bottle pattern appears while the stochastic oscillator is below its signal line.</li>
</ul>
<p>The following code snippet shows how to code the signal function of the strategy:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code>
</code><code>           </code><code class="n">stochastic_column</code><code class="p">,</code><code> </code><code class="n">signal_column</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>  </code><code>
</code><code>        </code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code> </code><strong><code>          </code><code>
</code><code>           </code><code class="c1"># Bullish setup</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">stochastic_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">signal_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><strong><code>           </code><code class="c1"># Bearish setup</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">stochastic_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">signal_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p class="pagebreak-before"><a data-type="xref" href="#figure10-3">Figure 10-3</a> shows the signal chart on USDCHF<a contenteditable="false" data-primary="" data-startref="ix_trend_strat_bottle" data-type="indexterm" id="idm46762851450320"/><a contenteditable="false" data-primary="" data-startref="ix_stoch_osc_indic" data-type="indexterm" id="idm46762851528368"/><a contenteditable="false" data-primary="" data-startref="ix_trend_foll_bottle_ch10" data-type="indexterm" id="idm46762851527104"/><a contenteditable="false" data-primary="" data-startref="ix_bottle_patt_ch10" data-type="indexterm" id="idm46762851525664"/><a contenteditable="false" data-primary="" data-startref="ix_mod_trend_bottle_ch10" data-type="indexterm" id="idm46762851375040"/>.</p>
<figure><div class="figure" id="figure10-3">
<p><img alt="" height="297" src="assets/mfpr_1003.png" width="600"/></p>
<h6><span class="label">Figure 10-3. </span>Signal chart of the strategy using the Bottle pattern and the stochastic <span class="keep-together">oscillator</span></h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Combining the Marubozu Pattern with K’s Volatility Bands" data-type="sect1"><div class="sect1" id="idm46762853057888">
<h1>Combining the Marubozu Pattern with <span class="keep-together">K’s Volatility Bands</span></h1>
<p>Let’s get to square<a contenteditable="false" data-primary="volatility bands" data-type="indexterm" id="ix_volatil_band"/><a contenteditable="false" data-primary="Marubozu pattern" data-type="indexterm" id="ix_marubozu_ch10"/><a contenteditable="false" data-primary="trend-following strategies" data-secondary="Marubozu pattern and K’s volatility band" data-type="indexterm" id="ix_trend_strat_marubozu"/><a contenteditable="false" data-primary="classic trend-following patterns" data-secondary="Marubozu pattern" data-type="indexterm" id="ix_class_trend_marubozu_ch10"/><a contenteditable="false" data-primary="K’s volatility bands" data-type="indexterm" id="idm46762851484176"/> one with the first candlestick pattern covered in this book. The Marubozu pattern can be considered the most powerful candlestick since it has no wicks, meaning that the market went straight from one point to another without <span class="keep-together">hesitation</span>.</p>
<p>This strategy<a contenteditable="false" data-primary="envelopment techniques" data-secondary="K’s volatility bands" data-type="indexterm" id="idm46762851481808"/> uses a concept known as a <em>volatility band</em>, which is a framing technique that envelops the market price to deliver dynamic support and resistance levels.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There are many types of volatility bands. The most well-known are Bollinger bands. The reliability of different types of volatility bands depends on the underlying markets and their parameters.</p>
</div>
<p>Before you can grasp K’s volatility bands, you have to understand the basics of Bollinger bands. Developed by John Bollinger, the bands are more statistical in nature than technical.</p>
<p>Consider the following list: {11, 4, 5, 20}. Given the four values, how would you describe the elements? Generally, the best measure that describes elements in a list is the mean. It is also the best estimate of the next expected value (if you were to add a new element chronologically). To calculate the mean of a list, follow this formula:</p>
<div data-type="equation">
<math alttext="chi equals StartFraction 1 Over n EndFraction left-parenthesis sigma-summation Underscript i equals 1 Overscript n Endscripts x Subscript i Baseline right-parenthesis equals StartFraction x 1 plus x 2 plus period period period plus x Subscript n Baseline Over n EndFraction">
<mrow>
<mi>χ</mi>
<mo>=</mo>
<mfrac><mn>1</mn> <mi>n</mi></mfrac>
<mrow>
<mo>(</mo>
<msubsup><mo>∑</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </msubsup>
<msub><mi>x</mi> <mi>i</mi> </msub>
<mo>)</mo>
</mrow>
<mo>=</mo>
<mfrac><mrow><msub><mi>x</mi> <mn>1</mn> </msub><mo>+</mo><msub><mi>x</mi> <mn>2</mn> </msub><mo>+</mo><mo lspace="0%" rspace="0%">.</mo><mo lspace="0%" rspace="0%">.</mo><mo lspace="0%" rspace="0%">.</mo><mo>+</mo><msub><mi>x</mi> <mi>n</mi> </msub></mrow> <mi>n</mi></mfrac>
</mrow>
</math>
</div>
<p>Therefore, according to the formula, you must sum them and divide the result by their quantity:</p>
<div data-type="equation">
<math alttext="chi equals StartFraction 11 plus 4 plus 5 plus 20 Over 4 EndFraction equals 10">
<mrow>
<mi>χ</mi>
<mo>=</mo>
<mfrac><mrow><mn>11</mn><mo>+</mo><mn>4</mn><mo>+</mo><mn>5</mn><mo>+</mo><mn>20</mn></mrow> <mn>4</mn></mfrac>
<mo>=</mo>
<mn>10</mn>
</mrow>
</math>
</div>
<p>Hence, the mean of the list is 10. Remember the concept of volatility from previous chapters where you use the ATR to approximate the fluctuations of the price relative to a past period. The bands use another technique to calculate volatility, which is the one used in descriptive statistics, that is, standard deviation<a contenteditable="false" data-primary="standard deviation" data-type="indexterm" id="idm46762851542304"/>.</p>
<p><em>Standard deviation</em> is the square root of the squared deviations of each variable from the group’s mean. The concept may sound complicated, but let’s simplify it in a few steps:</p>
<ul>
<li>Calculate the distance of each variable (the close price) from the mean of the lookback period at the same time step.</li>
<li>Square the distances so that you do not get negative values. </li>
<li>Calculate the mean of these squared distances. The result is called the <em>variance</em>.</li>
<li>Calculate the square root of the variance<a contenteditable="false" data-primary="variance" data-type="indexterm" id="idm46762851530128"/>. The result is called the <span class="keep-together"><em>standard deviation</em></span>.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Taking the square root in the last step allows you to compare apples to apples with the mean.</p>
</div>
<p>Mathematically speaking, the formula of the standard deviation is expressed as <span class="keep-together">follows</span>:</p>
<div data-type="equation">
<math alttext="sigma equals StartRoot StartFraction 1 Over n EndFraction sigma-summation Underscript i equals 1 Overscript n Endscripts left-parenthesis x Subscript i Baseline minus chi right-parenthesis squared EndRoot">
<mrow>
<mi>σ</mi>
<mo>=</mo>
<msqrt>
<mrow>
<mfrac><mn>1</mn> <mi>n</mi></mfrac>
<msubsup><mo>∑</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </msubsup>
<msup><mrow><mo>(</mo><msub><mi>x</mi> <mi>i</mi> </msub><mo>-</mo><mi>χ</mi><mo>)</mo></mrow> <mn>2</mn> </msup>
</mrow>
</msqrt>
</mrow>
</math>
</div>
<p>Now<a contenteditable="false" data-primary="rolling standard deviation measure" data-type="indexterm" id="idm46762851170896"/> that you know how to calculate a moving average, you can simply apply a rolling standard deviation measure, which is the same as a moving average except you are calculating a rolling volatility. Bollinger<a contenteditable="false" data-primary="Bollinger bands" data-type="indexterm" id="ic_boll_band"/> bands are found as follows:</p>
<ul>
<li>The upper Bollinger band is the sum of the current 20-period moving average and the current standard deviation multiplied by 2.</li>
<li>The lower Bollinger band is the difference between the current 20-period moving average and the current standard deviation multiplied by 2.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The constant (2 by default) is multiplied by the standard deviation’s value, and then the product is summed or subtracted from the current value of the moving average.</p>
</div>
<p><a data-type="xref" href="#figure10-4">Figure 10-4</a> shows an example with Bollinger bands applied on USDCHF. Some traders like to keep the middle line (which is simply the 20-period moving average). However, with Bollinger bands, the line does not provide as much value as the bands themselves.</p>
<figure><div class="figure" id="figure10-4"><img alt="" height="294" src="assets/mfpr_1004.png" width="600"/>
<h6><span class="label">Figure 10-4. </span>An example of Bollinger bands applied on USDCHF</h6>
</div></figure>
<p>Generally, when the market reaches the lower Bollinger band, it is believed to be oversold, and a bullish reacted is expected. Similarly, when the market reaches the upper Bollinger band, it is believed to be overbought, and a bearish reacted is expected<a contenteditable="false" data-primary="" data-startref="ic_boll_band" data-type="indexterm" id="idm46762851582624"/>.</p>
<p>Let’s now<a contenteditable="false" data-primary="K's volatility bands" data-type="indexterm" id="ix_ks_vol_band"/> look at K’s volatility bands, which are inspired by Bollinger bands. They follow these conditions:</p>
<ul>
<li>Calculate the mean between the highest highs and the lowest lows of the last 20 periods.</li>
<li>Calculate the highest standard deviation measure of the last 20 periods.</li>
<li>The upper volatility band is the sum of the result from the first step and the second step multiplied by 2.</li>
<li>The lower volatility band is the difference between the result from the first step and the second step multiplied by 2.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Similarly, the constant (2 by default) is multiplied by the standard deviation’s maximum value, and then the product is summed or subtracted from the current value of the mean of the maximum highs and lows.</p>
</div>
<p>The following code snippet shows the function to code K’s volatility bands:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<strong><code class="c1"># Defining the standard deviation function</code></strong><code>
</code><code class="k">def</code><code> </code><code class="nf">volatility</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">,</code><code> </code><code class="n">close</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>     </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">delete_row</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">)</code><code>    </code><code>
</code><code>     </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">k_volatility_band</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">,</code><code> </code><code class="n">multiplier</code><code class="p">,</code><code> </code><code class="n">high</code><code class="p">,</code><code> </code><code class="n">low</code><code class="p">,</code><code> </code><code class="n">close</code><code class="p">,</code><code> </code><code>
</code><code>                      </code><code class="n">position</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><strong><code>    </code><code class="c1"># Calculating the median line</code></strong><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">max</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">high</code><code class="p">]</code><code class="p">)</code><code> </code><code>
</code><code>            </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">min</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">low</code><code class="p">]</code><code class="p">)</code><code> </code><code>
</code><code>            </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code>\
</code><code>                                    </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code> </code><code>\</code><code class="o">/</code><code> </code><code class="mi">2</code><code>
</code><code>            </code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">ValueError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">delete_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
</code><code>
</code><strong><code>    </code><code class="c1"># Calculating maximum volatility</code></strong><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">volatility</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">,</code><code> </code><code class="n">close</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">max</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code>\
</code><code>                                    </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code> </code><code>
</code><code>            </code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">ValueError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>   </code><code>
</code><code>   </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">delete_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><code> </code><strong><code>   </code><code class="c1"># Calculating the bands</code></strong><code>
</code><code>    </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="p">(</code><code class="n">multiplier</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code>\
</code><code>                            </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="p">(</code><code class="n">multiplier</code><code> </code><code class="o">*</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code>\
</code><code>                            </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">delete_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>    </code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Keeping the middle line is essential to the strategy as it is the main filter. Therefore, with K’s volatility bands, the middle line is present in the chart.</p>
</div>
<p>Note that the words <em>volatility </em>and <em>standard deviation</em> are used<a contenteditable="false" data-primary="standard deviation" data-type="indexterm" id="idm46762850568208"/> interchangeably. <a data-type="xref" href="#figure10-5">Figure 10-5</a> shows an example with K’s volatility bands applied on USDCHF.</p>
<figure><div class="figure" id="figure10-5"><img alt="" height="294" src="assets/mfpr_1005.png" width="600"/>
<h6><span class="label">Figure 10-5. </span>An example of K’s volatility bands applied on USDCHF</h6>
</div></figure>
<p>Let’s now discuss the strategy. The trading conditions are as follows:</p>
<ul>
<li>A long signal is generated whenever a bullish Marubozu pattern appears while the market price is below the middle line.</li>
<li>A short signal is generated whenever a bearish Marubozu pattern appears while the market price is above the middle line.</li>
</ul>
<p>The following code snippet shows how to code the signal function of the strategy:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code>
</code><code>           </code><code class="n">middle_band</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>  </code><code>
</code><code>        </code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code>          </code><strong><code> </code><code>
</code><code>           </code><code class="c1"># Bullish setup</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">middle_band</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code>
</code><code>       </code><strong><code>             </code><code>
</code><code>           </code><code class="c1"># Bearish setup</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">middle_band</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code></pre>
<p><a data-type="xref" href="#figure10-6">Figure 10-6</a> shows the signal chart on AUDNZD.</p>
<figure><div class="figure" id="figure10-6"><img alt="" height="294" src="assets/mfpr_1006.png" width="600"/>
<h6><span class="label">Figure 10-6. </span>Signal chart of the strategy using the Marubozu pattern and K’s volatility bands</h6>
</div></figure>
<p>Optionally, you can consider the following more restraining conditions (however, the signals will be less frequent):</p>
<ul>
<li>A long signal is generated whenever a bullish Marubozu pattern appears while the market price is below the lower volatility band.</li>
<li>A short signal is generated whenever a bearish Marubozu pattern appears while the market price is above the upper volatility band.</li>
</ul>
<p>To sum up, the strategy can have fewer signals, but intuitively, it has a strong foundation pertaining to the most powerful candlestick (in terms of amplitude) and the statistical extreme<a contenteditable="false" data-primary="" data-startref="ix_ks_vol_band" data-type="indexterm" id="idm46762851041856"/><a contenteditable="false" data-primary="" data-startref="ix_trend_strat_marubozu" data-type="indexterm" id="idm46762851003760"/><a contenteditable="false" data-primary="" data-startref="ix_volatil_band" data-type="indexterm" id="idm46762851002384"/><a contenteditable="false" data-primary="" data-startref="ix_class_trend_marubozu_ch10" data-type="indexterm" id="idm46762851001008"/><a contenteditable="false" data-primary="" data-startref="ix_marubozu_ch10" data-type="indexterm" id="idm46762851009600"/>.</p>
</div></section>
<section data-pdf-bookmark="Combining the H Pattern with the Trend Intensity Index" data-type="sect1"><div class="sect1" id="idm46762851399456">
<h1>Combining the H Pattern with the Trend Intensity Index</h1>
<p>The <em>trend intensity index</em> (TII) measures<a contenteditable="false" data-primary="trend intensity index (TII)" data-type="indexterm" id="ix_trend_intense_tii"/><a contenteditable="false" data-primary="modern trend-following patterns" data-secondary="H pattern" data-type="indexterm" id="ix_mod_trend_h_patt_ch10"/><a contenteditable="false" data-primary="trend-following patterns" data-secondary="H pattern" data-type="indexterm" id="ix_trend_h_patt_ch10"/><a contenteditable="false" data-primary="H pattern" data-type="indexterm" id="ix_h_patt_ch10"/><a contenteditable="false" data-primary="trend-following strategies" data-secondary="H pattern and TII" data-type="indexterm" id="ix_trend_strat_h_patt"/><a contenteditable="false" data-primary="TII (trend intensity index)" data-type="indexterm" id="ix_tii_trend_intens"/> the strength of the trend. It is a simple calculation created out of a moving average and price deviations around it to show, in a bounded appearance, the intensity of the trend. To build the indicator, follow these steps:</p>
<ol>
<li>Calculate a 20-period moving average on the market price.</li>
<li>Calculate the deviations of the market price from the moving average. This is done by doing so on two columns. If the close price is greater than its moving average, then the first column is filled by the difference between the two (up variable), and if the current market price is lower than its moving average, then the second column is filled by the difference between the two (down variable).</li>
<li>Count the values where the market was above its moving average and where it was below it.</li>
</ol>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Counting the values with certain conditions can be accomplished with the <code>numpy</code> function <code>count_nonzero()</code>.</p>
</div>
<ul>
<li>Apply the following formula to find the TII (by default, a 20-period lookback):</li>
</ul>
<div data-type="equation">
<math alttext="upper T upper I upper I Subscript i Baseline equals left-parenthesis StartFraction Number of up Over Number of up plus Number of down EndFraction right-parenthesis x Baseline 100">
<mrow>
<mi>T</mi>
<mi>I</mi>
<msub><mi>I</mi> <mi>i</mi> </msub>
<mo>=</mo>
<mrow>
<mo>(</mo>
<mfrac><mrow><mtext>Number</mtext><mspace width="4.pt"/><mtext>of</mtext><mspace width="4.pt"/><mtext>up</mtext></mrow> <mrow><mtext>Number</mtext><mspace width="4.pt"/><mtext>of</mtext><mspace width="4.pt"/><mtext>up</mtext><mspace width="5.0pt"/><mo>+</mo><mspace width="5.0pt"/><mtext>Number</mtext><mspace width="4.pt"/><mtext>of</mtext><mspace width="4.pt"/><mtext>down</mtext></mrow></mfrac>
<mo>)</mo>
</mrow>
<mi>x</mi>
<mn>100</mn>
</mrow>
</math>
</div>
<p>To code the TII in Python, use the following function:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">trend_intensity_indicator</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>
</code><code>    </code><code>
</code><strong><code>    </code><code class="c1"># Calculating the moving average</code></strong><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">ma</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">lookback</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">)</code><code>
</code><code>
</code><strong><code>    </code><code class="c1"># Deviations</code></strong><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code class="p">:</code><code>
</code><code>           </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code>\
</code><code>           </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code class="p">:</code><code>
</code><code>           </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code>\
</code><code>           </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code>
</code><code>              </code><code>
</code><code>  </code><strong><code>  </code><code class="c1"># Trend intensity index</code></strong><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>        </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">count_nonzero</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code>\
</code><code>                                </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code>
</code><code>            </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>        </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">count_nonzero</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="n">lookback</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">:</code><code class="n">i</code><code> </code><code>\
</code><code>                                </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">2</code><code class="p">]</code><code class="p">)</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">3</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code>\
</code><code>                                </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">position</code><code> </code><code class="o">+</code><code> </code><code class="mi">4</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code> </code><code>\
</code><code>                                </code><code class="o">*</code><code> </code><code class="mi">100</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">delete_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">position</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>
</code><code>     </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p>Typically, a strong bullish momentum is in progress when the TII is above 50, and a strong bearish momentum is in progress when the TII is below 50.</p>
<p>The trading conditions of the strategy are as follows:</p>
<ul>
<li>A long signal is generated whenever a bullish H pattern appears while the 20-period TII is above 50.</li>
<li>A short signal is generated whenever a bearish H pattern appears while the 20-period TII is below 50.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>It is preferable to tweak the lookback of the TII to find the right adjustment. The H pattern, being a reversal-invalidation pattern (thus, a trend confirmation pattern), could work well with an indicator that shows the strength of the underlying trend.</p>
</div>
<p class="pagebreak-before">The following code snippet shows how to code the signal function of the strategy:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">,</code><code> </code><code>
</code><code>           </code><code class="n">tii_column</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">rounding</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">)</code><code> </code><strong><code class="c1"># Put 0 instead of 4 as of pair 4</code></strong><code>
</code><code>   </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>  </code><code>
</code><code>        </code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code>           </code><code>
</code><code>          </code><strong><code> </code><code class="c1"># Bullish setup</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">high_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">tii_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">50</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>          </code><strong><code> </code><code class="c1"># Bearish setup</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">close_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">open_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">low_column</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">tii_column</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">50</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p><a data-type="xref" href="#figure10-7">Figure 10-7</a> shows the signal chart on EURGBP.</p>
<figure><div class="figure" id="figure10-7"><img alt="" height="294" src="assets/mfpr_1007.png" width="600"/>
<h6><span class="label">Figure 10-7. </span>Signal chart of the strategy using the H pattern and the trend intensity index</h6>
</div></figure>
<p>The graph shows that there was one signal that coincided with the bullish conditions<a contenteditable="false" data-primary="" data-startref="ix_trend_h_patt_ch10" data-type="indexterm" id="idm46762851016464"/><a contenteditable="false" data-primary="" data-startref="ix_trend_intense_tii" data-type="indexterm" id="idm46762851015088"/><a contenteditable="false" data-primary="" data-startref="ix_h_patt_ch10" data-type="indexterm" id="idm46762849702416"/><a contenteditable="false" data-primary="" data-startref="ix_mod_trend_h_patt_ch10" data-type="indexterm" id="idm46762849701040"/><a contenteditable="false" data-primary="" data-startref="ix_tii_trend_intens" data-type="indexterm" id="idm46762849708112"/><a contenteditable="false" data-primary="" data-startref="ix_trend_strat_h_patt" data-type="indexterm" id="idm46762849706736"/><a contenteditable="false" data-primary="" data-startref="ix_trend_strat_ch10" data-type="indexterm" id="idm46762849705360"/>.</p>
<p>To sum up this chapter, it is important to combine the right patterns with the right indicators, and this is done through back-testing. Naturally, the combinations presented are merely examples, and more powerful combinations can be created by fusing other indicators with other patterns. It is also interesting to know that you can include multiple patterns in your strategies rather than combine just one pattern with one indicator.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm46762853123120"><sup><a href="ch10.xhtml#idm46762853123120-marker">1</a></sup> The <em>invisible hand mechanism</em> involves using trades in tandem with the trend, for example, only taking buy signals in a bullish trend while disregarding any sell signals.</p><p data-type="footnote" id="idm46762852840176"><sup><a href="ch10.xhtml#idm46762852840176-marker">2</a></sup> The Three Candles pattern comes from the field of pattern recognition, while moving averages come from the field of statistics and trend-following technical indicators.</p></div></div></section></div></body></html>