<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 2. Algorithmic Mindset and Functions" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter2">
<h1><span class="label">Chapter 2. </span>Algorithmic Mindset and Functions</h1>
<p>An <em>algorithm</em> is a set<a contenteditable="false" data-primary="algorithmic mindset and functions" data-type="indexterm" id="ix_alg_mindset_func_ch2"/><a contenteditable="false" data-primary="algorithm" data-type="indexterm" id="idm46762874656256"/> of rules that a computer applies given the realization of certain conditions. You generally use an algorithm to solve a specific problem or to simply follow a repetitive sequence of tasks. You can also use algorithms to find patterns by scanning for the conditions that you set.</p>
<p>The main purpose of this book is to show you how to scan, find, and evaluate candlestick patterns and strategies. The main benefits of using an algorithm as opposed to manually performing the tasks are as follows:</p>
<dl>
<dt>Speed</dt>
<dd>Algorithms can run at extreme speed compared to humans. While a simple algorithm can scan hundreds of thousands of data pieces in a few seconds, a human may spend weeks and months doing the same task.</dd>
<dt>Discipline</dt>
<dd>Algorithms follow a distinct set of rules and do not have feelings or emotions that make them ignore the rules occasionally. In addition, algorithms do not fall into the trap of subjective interpretation. This is important for the evaluation process as you need objective and clear measures to judge your trading system.</dd>
<dt>Percentage of error</dt>
<dd>Algorithms are generally error-free when there are no bugs in the code. Humans can make a lot of mistakes due to inattention and fatigue.</dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A <em>trading system</em> is composed<a contenteditable="false" data-primary="trading system" data-type="indexterm" id="idm46762874650016"/> of multiple algorithms such as trading and risk management algorithms. A robust trading system relies on clear and stable rules-based algorithms to give reliable measures.</p>
</div>
<p>This chapter is divided into four sections. First it covers <a data-type="link" href="#primal-functions">primal functions</a>, which deal with the basic data manipulation that I use throughout the book. Then it shows how to <a data-type="link" href="#coding-signals">code the signals</a> of the patterns and strategies. It then moves on to <a data-type="link" href="#signal-charts">visualizing the signals</a> on the price charts so that you have an aesthetic and interpretable representation. Finally, you’ll learn the <a data-type="link" href="#performance-evaluation">key performance evaluation metrics</a> and how to code them. Make sure you master the concepts of this chapter as they are crucial for the rest of the book; they are helpful not only in detecting the patterns but also in creating strategies.</p>
<section data-pdf-bookmark="Coding the Primal Functions " data-type="sect1"><div class="sect1" id="primal-functions">
<h1>Coding the Primal Functions </h1>
<p>The <em>primal functions</em> are<a contenteditable="false" data-primary="algorithmic mindset and functions" data-secondary="primal functions" data-type="indexterm" id="ix_alg_mindset_func_primal"/><a contenteditable="false" data-primary="primal functions, coding of" data-type="indexterm" id="ix_primal_func"/> of a small collection of custom functions that help you better manipulate data arrays. The idea of primal functions began as an exercise for me to practice coding in my early years, but over time, they became regular code snippets that I use all the time in my research.</p>
<p>Analyzing and back-testing are repetitive tasks that require some functions to work everywhere. Let’s start with the most basic primal functions (remember, you will be using <code>numpy</code> throughout the book).</p>
<section data-pdf-bookmark="The Function to Add Columns to an Array" data-type="sect2"><div class="sect2" id="idm46762874080416">
<h2>The Function to Add Columns to an Array</h2>
<p>Occasionally, you need<a contenteditable="false" data-primary="columns in arrays, adding or deleting" data-type="indexterm" id="ix_col_add_del"/><a contenteditable="false" data-primary="primal functions, coding of" data-secondary="adding columns to array" data-type="indexterm" id="idm46762874357184"/> to add columns to populate them with either indicators or signals. For example, assume that you have an OHLC array composed of four columns. You can use a function to add an extra column that you may use to harbor the <span class="keep-together">following</span>:</p>
<ul>
<li>An indicator calculated from the close price, such as a simple moving average<sup><a data-type="noteref" href="ch02.xhtml#idm46762874354240" id="idm46762874354240-marker">1</a></sup></li>
<li>A proxy for buy and sell signals using predetermined binary values (such as 1 for buy signals and −1 for sell signals)</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The rows<a contenteditable="false" data-primary="arrays" data-secondary="rows as time steps" data-type="indexterm" id="idm46762874350448"/><a contenteditable="false" data-primary="rows in arrays" data-secondary="as time steps" data-secondary-sortas="time steps" data-type="indexterm" id="idm46762874349040"/> in the arrays represent time steps. I use the hourly time frame in the book, which means that every row contains the hourly OHLC values and any indicator value or a buy and sell proxy.</p>
</div>
<p class="pagebreak-before">The first primal function<a contenteditable="false" data-primary="add_column() function" data-type="indexterm" id="idm46762874346448"/><a contenteditable="false" data-primary="arrays" data-secondary="adding columns to" data-type="indexterm" id="idm46762874345344"/> is therefore <code>add_column()</code>, as shown in the following code snippet:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">times</code><code class="p">):</code>
    
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">times</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>
    
        <code class="n">new</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">((</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">),</code> <code class="mi">1</code><code class="p">),</code> <code class="n">dtype</code> <code class="o">=</code> <code class="nb">float</code><code class="p">)</code>
        
        <code class="n">data</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">new</code><code class="p">,</code> <code class="n">axis</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">data</code></pre>
<p>The function<a contenteditable="false" data-primary="np.zeros() function" data-type="indexterm" id="idm46762877406992"/> loops a predetermined number of times chosen by the variable <code>times</code>, and for every loop, a new array is created containing zero values and having the same length as the original data, as shown by <code>len(data)</code>. This new array is born out of the <code>np.zeros()</code> prebuilt <code>numpy</code> function.</p>
<p>The final step is to take this freshly created array and paste it right next to the original four columns<a contenteditable="false" data-primary="np.append() function" data-type="indexterm" id="idm46762877402528"/> using <code>np.append()</code>, thus giving an array with five columns.</p>
<p>As the loop continues, the number of columns increases. The argument <code>axis</code> specifies a binary choice between rows and columns. When it is equal to 0, it refers to rows, and when it is equal to 1, it refers to columns. Remember that the variable <code>times</code> is the number of columns that you want to add, and this is specified when calling the function. Let’s look at an example to make things clearer.</p>
<p>You have an array called <code>my_data</code> consisting of four columns, and you want to add five new columns to update your original array so that it has nine columns. What would you write to accomplish this assuming you have already defined the <code>add_column()</code> function? The answer is as follows:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<strong><code class="c1"># Adding five columns to an existing array</code></strong><code>
</code><code class="n">my_data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="The Function to Delete Columns from an Array" data-type="sect2"><div class="sect2" id="idm46762874079760">
<h2>The Function to Delete Columns from an Array</h2>
<p>Extra columns<a contenteditable="false" data-primary="primal functions, coding of" data-secondary="deleting columns from array" data-type="indexterm" id="ix_primal_func_del_col"/><a contenteditable="false" data-primary="arrays" data-secondary="deleting columns from" data-type="indexterm" id="ix_array_delete_col"/> may occur when trying to calculate complex indicators because you may have to populate them by intermediary calculations that are not needed after the indicator is ready. An example of this would to be to use a column to calculate weights and to use the next column to calculate a weight-based indicator. You would retain the indicator column but not the weight column.</p>
<p>At the end, you want to retain the final result of the indicator and remove the previous columns so that you have a clean array composed of OHLC data with the indicator’s readings in the next column.</p>
<p>A quick<a contenteditable="false" data-primary="delete_column() function" data-type="indexterm" id="idm46762877836720"/> and easy way to do this is the <code>delete_column()</code> function. The following code snippet shows how to define it:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">delete_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">index</code><code class="p">,</code> <code class="n">times</code><code class="p">):</code>
    
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">times</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>
    
        <code class="n">data</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">index</code><code class="p">,</code> <code class="n">axis</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">data</code>
</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Remember<a contenteditable="false" data-primary="functions, defining" data-type="indexterm" id="idm46762872629632"/> that to use a function, you must define it first. This means that after writing the syntax of the function, you must execute it so that Python stores it in its memory.</p>
</div>
<p>The function loops around the specified range, which is the number of columns you want to delete as of a selected index. For example, the function deletes the three columns as of column number 4, which is included.</p>
<p>The function<a contenteditable="false" data-primary="indexing of columns in Python" data-type="indexterm" id="idm46762872627280"/><a contenteditable="false" data-primary="np.delete() function" data-type="indexterm" id="idm46762872626176"/> states that the newly transformed array has a column deleted using the built-in <code>numpy</code> function <code>np.delete()</code> starting from the variable <code>index</code>. Finally, the variable <code>times</code> is the number of columns to delete, and this is specified when calling the function. Here are two examples to make things clearer:</p>
<ul>
<li>
<p>You have an array consisting of 10 columns, and you want to erase 4 of them starting from the column indexed at 4. Here is how to do so:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">delete_column</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>
		</pre>
</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Remember that a column indexed at 4 is not the fourth column but the fifth. This is because Python starts indexing at zero.</p>
</div>
<ul>
<li>
<p>You have an array consisting of eight columns, and you want to erase two of them starting from the column indexed at 1. Here is how to do so:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">delete_column</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code></pre>
</li>
</ul>
<p>You would use <code>delete_column()</code> mostly with technical indicators as opposed to patterns, as the latter are direct rules instead of sequential complex calculations like some indicators<a contenteditable="false" data-primary="" data-startref="ix_primal_func_del_col" data-type="indexterm" id="idm46762878966048"/><a contenteditable="false" data-primary="" data-startref="ix_array_delete_col" data-type="indexterm" id="idm46762878964768"/><a contenteditable="false" data-primary="" data-startref="ix_col_add_del" data-type="indexterm" id="idm46762878963392"/>.</p>
</div></section>
<section data-pdf-bookmark="The Function to Add Rows to an Array" data-type="sect2"><div class="sect2" id="idm46762877841824">
<h2>The Function to Add Rows to an Array</h2>
<p>Sometimes<a contenteditable="false" data-primary="rows in arrays" data-secondary="adding or deleting" data-type="indexterm" id="idm46762878960592"/><a contenteditable="false" data-primary="primal functions, coding of" data-secondary="adding rows to array" data-type="indexterm" id="idm46762878959184"/><a contenteditable="false" data-primary="add_row() function" data-type="indexterm" id="idm46762877155840"/><a contenteditable="false" data-primary="arrays" data-secondary="adding rows to" data-type="indexterm" id="idm46762877154736"/> you want to add rows to the end of an array due to lag or the addition of manual values from the coder. You can add empty rows to the end of an array using the following function:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">add_row</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">times</code><code class="p">):</code>

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">times</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>       

        <code class="n">columns</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">shape</code><code class="p">(</code><code class="n">data</code><code class="p">)[</code><code class="mi">1</code><code class="p">]</code>

        <code class="n">new</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">((</code><code class="mi">1</code><code class="p">,</code> <code class="n">columns</code><code class="p">),</code> <code class="n">dtype</code> <code class="o">=</code> <code class="nb">float</code><code class="p">)</code>

        <code class="n">data</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">new</code><code class="p">,</code> <code class="n">axis</code> <code class="o">=</code> <code class="mi">0</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">data</code>
</pre>
<p>The function<a contenteditable="false" data-primary="np.shape() function" data-type="indexterm" id="idm46762879061952"/> loops around the data, and in each loop it finds the shape of the array using the <code>np.shape()</code> built-in function, which gives out the number or rows and columns in a matrix. Since you are interested only in the number of columns, you would add <code>[1]</code> to tell the algorithm that you want only the second value, which is the number of columns. Having stored the number in the variable <code>columns</code>, the algorithm proceeds to the next line and creates a whole new array made up of zeros with only one row and a column number equal to the variable <code>columns</code>. Finally, the algorithm appends this freshly created array with one row to the end of the original array, thus giving out a new row with the same size as the other rows.</p>
</div></section>
<section data-pdf-bookmark="The Function to Remove Rows from an Array" data-type="sect2"><div class="sect2" id="idm46762878058880">
<h2>The Function to Remove Rows from an Array</h2>
<p>When<a contenteditable="false" data-primary="primal functions, coding of" data-secondary="deleting rows from array" data-type="indexterm" id="idm46762878057376"/><a contenteditable="false" data-primary="delete_row() function" data-type="indexterm" id="idm46762878056032"/><a contenteditable="false" data-primary="arrays" data-secondary="deleting rows from" data-type="indexterm" id="idm46762878054928"/> calculating indicators, some calculations may require a minimum number of data in the past; otherwise, you would see invalid values, which appear as NaN<sup><a data-type="noteref" href="ch02.xhtml#idm46762878053424" id="idm46762878053424-marker">2</a></sup> in Python. The following function deletes rows from the start:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">delete_row</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">number</code><code class="p">):</code>
    
    <code class="n">data</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="n">number</code><code class="p">:,</code> <code class="p">]</code>
    
    <code class="k">return</code> <code class="n">data</code></pre>
<p>This simple function states that the data actually starts from the <code>number</code> index and continues to the end of the data. Basically, it ignores a select number of rows from the beginning.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46762877682048">
<h5>Basic Array Syntax or Array Manipulation</h5>
<p>Referring<a contenteditable="false" data-primary="arrays" data-secondary="manipulation rules of thumb" data-type="indexterm" id="idm46762877680880"/> to data in Python requires practice. Here is a quick summary to use as rules of thumb:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<strong><code class="c1"># An array has the following structure: array[row, column]</code><code>
</code><code>
</code><code class="c1"># Referring to the whole my_data array</code><code>
</code></strong><code class="n">my_data</code><code>
</code><strong><code class="c1"># Referring to the first 100 rows inside the array</code><code>
</code></strong><code class="n">my_data</code><code class="p">[</code><code class="p">:</code><code class="mi">100</code><code class="p">,</code><code> </code><code class="p">]</code><code>
</code><strong><code class="c1"># Referring to the first 100 rows of the first two columns</code><code>
</code></strong><code class="n">my_data</code><code class="p">[</code><code class="p">:</code><code class="mi">100</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">:</code><code class="mi">2</code><code class="p">]</code><code>
</code><strong><code class="c1"># Referring to all the rows of the seventh column</code><code>
</code></strong><code class="n">my_data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">]</code><code>
</code><strong><code class="c1"># Referring to the last 500 rows of the array </code><code>
</code></strong><code class="n">my_data</code><code class="p">[</code><code class="o">-</code><code class="mi">500</code><code class="p">:</code><code class="p">,</code><code> </code><code class="p">]</code><code>  </code><strong><code>          </code><code>
</code><code class="c1"># Referring to the first row of the first column</code><code>
</code></strong><code class="n">my_data</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code>
</code><strong><code class="c1"># Referring to the last row of the last column</code></strong><code>
</code><code class="n">my_data</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code>
</code></pre>
</div></aside>
</div></section>
<section data-pdf-bookmark="The Function to Round Numbers" data-type="sect2"><div class="sect2" id="idm46762877678736">
<h2>The Function to Round Numbers</h2>
<p>Why discuss<a contenteditable="false" data-primary="rounding numbers" data-type="indexterm" id="ix_round_num"/><a contenteditable="false" data-primary="primal functions, coding of" data-secondary="rounding numbers" data-type="indexterm" id="ix_primal_func_round_num"/> such a simple concept here that does not seem to be important enough to be a function on its own? The answer is that there are certain patterns that are extremely rare unless you round the numbers of the OHLC data.</p>
<p>Let’s look<a contenteditable="false" data-primary="currency pairs, and rounding numbers" data-type="indexterm" id="idm46762875758032"/><a contenteditable="false" data-primary="pipette (fifth decimal in currency)" data-type="indexterm" id="idm46762875756928"/><a contenteditable="false" data-primary="pip (fourth decimal in currency)" data-type="indexterm" id="idm46762875755856"/> at an example of the currency pair EURUSD. In recent years, for accuracy reasons, retail market dealers started quoting most currency pairs in five decimals instead of four. While traders were used to the concept of a <em>pip</em>, which is the fourth decimal (i.e., the 4 in 1.0964), they now have a <em>pipette, </em>which is the fifth decimal (the 5 in 1.09645).</p>
<p>The change can be confusing for market participants who have been used to the conventional four-decimals system, but it is necessary and favors a tighter spread quoted by dealers. The <em>spread</em> is the difference between the ask (buy) and bid (sell) prices. It is the compensation of the market dealer for the risk taken. It is considered a transaction cost to the trader because it entails buying slightly more expensive and selling slightly cheaper.</p>
<p>Let’s take this opportunity to discuss how currency pairs work and then build up to the need to round the numbers eventually.</p>
<p>A currency pair is made up of two currencies; the one on the left is the base currency, and the one on its right is the price currency. When you see the pair EURUSD quoting at 1.0500, it means that to buy 1 EUR, you need to spend 1.0500 USD.</p>
<p>Now, let’s assume that you bought 10,000 EUR for 10,500 USD and several weeks later find that EURUSD is quoting at 1.0750. What does this mean exactly? It means that the value of EUR has gone up relative to the value of USD because now you need 10,750 USD to buy 10,000 EUR; therefore, theoretically, you have made 250 USD (which you can also refer to as 250 pips gain, as the value per 1 EUR has gone up by 0.0250). This is realized only if you exchange your EUR back to USD, which gives you back 10,750 USD instead of 10,500 USD. With the development of markets and the introduction of the five-decimals system, you may now see EURUSD with five numbers after the decimals (e.g., EURUSD at 1.07516).</p>
<p>There are certain candlestick patterns that require a close price similar to the open price. This is why I include rounding in some of the patterns presented in subsequent chapters. The optimal rounding number for currency pairs must be four decimals—no more, no less. The following code block shows the rounding<a contenteditable="false" data-primary="rounding() function" data-type="indexterm" id="idm46762875722832"/> function:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">rounding</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">how_far</code><code class="p">):</code>
    
    <code class="n">data</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="n">decimals</code> <code class="o">=</code> <code class="n">how_far</code><code class="p">)</code>
    
    <code class="k">return</code> <code class="n">data</code>
</pre>
<p>The function<a contenteditable="false" data-primary="round() function" data-type="indexterm" id="idm46762874592064"/> uses a built-in function called <code>round()</code> to simplify the process. Make sure to understand the necessity of rounding the OHLC data when searching for specific patterns as you will need it in subsequent chapters.</p>
<p>Before moving on, let’s briefly practice the new functions you have learned in this section. Suppose you have an OHLC array and you want to:</p>
<ul>
<li>
<p>Add two columns to the array:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">add_column</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code></pre>
</li>
<li>
<p>Delete three columns starting from the second column:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">delete_column</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code></pre>
</li>
<li>
<p>Add 11 rows to the end of the array:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">add_row</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">11</code><code class="p">)</code></pre>
</li>
<li>
<p>Delete the first four rows in the array:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">delete_row</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code></pre>
</li>
<li>
<p>Round all the values in the array to four decimals:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">rounding</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>
</pre>
</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Remember<a contenteditable="false" data-primary="data variable" data-type="indexterm" id="idm46762878317184"/> that the variable <code>data</code> is generally used in the functions and refers to any data you want to refer to, whereas the variable <code>my_data</code><em> </em>is my default name of all the OHLC arrays<a contenteditable="false" data-primary="" data-startref="ix_alg_mindset_func_primal" data-type="indexterm" id="idm46762877499648"/><a contenteditable="false" data-primary="" data-startref="ix_primal_func" data-type="indexterm" id="idm46762877498304"/> I import<a contenteditable="false" data-primary="" data-startref="ix_primal_func_round_num" data-type="indexterm" id="idm46762877496800"/><a contenteditable="false" data-primary="" data-startref="ix_round_num" data-type="indexterm" id="idm46762877495424"/>.</p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="Coding Signals" data-type="sect1"><div class="sect1" id="coding-signals">
<h1>Coding Signals</h1>
<p>This marks<a contenteditable="false" data-primary="signal algorithm" data-secondary="coding signals" data-type="indexterm" id="ix_signal_alg_code"/><a contenteditable="false" data-primary="algorithmic mindset and functions" data-secondary="coding signals" data-type="indexterm" id="ix_alg_mindset_func_sig"/> the beginning of the signal algorithm. Remember, the aim of this section is to see how to create a set of conditions in order to find valid signals. Up to this point, you have imported an OHLC array of an asset or a currency pair.</p>
<p>As I have not yet started the discussion of any candlestick patterns, I will create a hypothetical pattern and then code its conditions and create the signal algorithm. Let’s call this hypothetical configuration the Alpha pattern:</p>
<ul>
<li>A long (buy) signal<a contenteditable="false" data-primary="long (buy) signal" data-type="indexterm" id="idm46762877470176"/> is generated on the next open whenever the current low is lower than the low price 5 periods ago and the low price 13 periods ago but higher than the low price 21 periods ago. Simultaneously, the close price of the current bar must be higher than the close price 3 periods ago.</li>
<li>A short (sell) signal<a contenteditable="false" data-primary="short (sell) signal" data-type="indexterm" id="idm46762877468496"/> is generated on the next open whenever the current high price is higher than the high price 5 periods ago and the high price 13 periods ago but lower than the high price 21 periods ago. Simultaneously, the close price of the current bar must be lower than the close price 3 periods ago.</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A <em>short sell</em> position is a complex action where you profit from a price decrease. In layperson’s terms, you borrow an asset from a third party and then sell it to a buyer. Finally, you buy it back and return it to the original owner. If the price has decreased, you would pocket the difference; otherwise, you would buy it back at a higher price than when you sold it.</p>
</div>
<p>The previous<a contenteditable="false" data-primary="signal() function" data-type="indexterm" id="idm46762877465104"/> bullet points give everything you need to generate buy and sell signals, and hence, you can start coding the <code>signal()</code> function.</p>
<p>Think of the <code>signal()</code> function as the one that scans each row and leaves a trace if all the conditions you set are made. These traces are buy and sell proxy orders.</p>
<p>The first thing you need to tell the algorithm is to have a sufficient number of columns that you want to populate with buy and sell orders. As previously seen, you can do this with <code>add_column()</code>. The next step is to tell the algorithm to loop around the totality of data, and this is done using the <code>for</code> statement, which performs a finite loop between a predefined range, which in your case is the length of the OHLC data array.</p>
<p>As you<a contenteditable="false" data-primary="try() function" data-type="indexterm" id="idm46762877460416"/><a contenteditable="false" data-primary="except() function" data-type="indexterm" id="idm46762877459280"/> are initiating the position on the next open price after validating the pattern at the close price, you can use the <code>try()</code> and <code>except()</code> functions, which simply bypass errors caused by having a signal at the last data of the array that gives a trigger on the next nonexistent row. To illustrate this error, imagine having 500 rows and getting a buy signal on the 500th row. Since you are buying on the next open, the signal would appear on the next row, which does not exist. This would cause an index error.</p>
<p>By now, you<a contenteditable="false" data-primary="if statements" data-type="indexterm" id="idm46762877456640"/> are ready to code the Alpha pattern’s conditions. I generally code the bullish conditions first. Therefore, after telling the algorithm to add two columns and to loop across the data while ignoring the <code>IndexError()</code> issue, I will simply add the conditions using the <code>if</code> statement.</p>
<p>The conditions<a contenteditable="false" data-primary="for() loop" data-type="indexterm" id="idm46762877453648"/> are intuitive: all you need to know is that the variable <code>i</code> refers to the current row index in the ongoing loop and therefore <code>i-5</code> refers to the variable five rows (time steps) before the current one. The <code>i</code> variable is used with the <code>for</code> loop so that the conditions can be applied to every row.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46762877450720">
<h5>Indexing Refresher</h5>
<p>Remember<a contenteditable="false" data-primary="indexing of columns in Python" data-type="indexterm" id="idm46762877449152"/> that with Python indexing columns and rows at zero, the following rules of thumb must be memorized for any OHLC data I use in the book:</p>
<ul>
<li>The index 0 refers to the open price column.</li>
<li>The index 1 refers to the high price column.</li>
<li>The index 2 refers to the low price column.</li>
<li>The index 3 refers to the close price column.</li>
</ul>
<p>Additionally, you may have the following if they are not preceded by another calculation (indicator):</p>
<ul>
<li>The index 4 refers to the buy signals column.</li>
<li>The index 5 refers to the sell signals column.</li>
</ul>
</div></aside>
<p>However, sometimes<a contenteditable="false" data-primary="OHLC data" data-secondary="calculating indicators after" data-type="indexterm" id="idm46762877443296"/> you may need to calculate indicators or volatility measures after the OHLC data, which pushes the buy and sell columns to the next indices. This is covered in <a data-type="xref" href="ch03.xhtml#ch3_indicator-analysis">“Indicator Analysis”</a>. The following code snippet defines the function of the Alpha pattern:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code>    </code><code>
</code><code>    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>    </code><code>
</code><code>
</code><code>       </code><code class="k">try</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>         </code><strong><code>  </code><code class="c1"># Bullish Alpha</code></strong><code>
</code><code>           </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">13</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code>
</code><code>              </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">21</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>              </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code>
</code><code>                    </code><code>
</code><code>        </code><strong><code>   </code><code class="c1"># Bearish Alpha</code></strong><code>
</code><code>           </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">13</code><code class="p">,</code><code>
</code><code>                </code><code class="err">​</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">21</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>\
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                  </code><code>
</code><code>                    </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code>
</code><code>
</code><code>       </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>              </code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p>The statement <code>data[i, 4] == 0</code> is the condition that to have a buy signal, you must not have had a buy signal in the previous row.<sup><a data-type="noteref" href="ch02.xhtml#idm46762875822448" id="idm46762875822448-marker">3</a></sup> This is to avoid successive signals in case the pattern is repetitive in nature<a contenteditable="false" data-primary="long (buy) signal" data-type="indexterm" id="idm46762875826944"/>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46762875825584">
<h5>Writing if Statements the Right Way</h5>
<p>With conditions, the equal sign is doubled; otherwise, you get a syntax error. See the following example:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<strong><code class="c1"># Wrong syntax</code></strong><code>
</code><code class="k">if</code><code> </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>
</code><strong><code class="c1"># Correct syntax</code></strong><code>
</code><code class="k">if</code><code> </code><code class="n">x</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code></pre>
</div></aside>
<p>The proxy for a long signal is the number 1 inputted in the column indexed at 4 (therefore, the fifth column). The reason I write <code>data[i + 1, 4] = 1</code> after validating the pattern is to force the algorithm to buy on the next open after finishing with the current close price. In parallel, the proxy for a short signal is the number −1 in the column indexed at 5 (therefore, the sixth column).</p>
<p>And voilà, you have coded the necessary conditions to create signals based on the open of the row. How would you code the following conditions?</p>
<ul>
<li>A long signal is generated on the next open price whenever the current close price is higher than the close price two periods ago.</li>
<li>A short signal is generated<a contenteditable="false" data-primary="short (sell) signal" data-type="indexterm" id="idm46762877769696"/> on the next open price whenever the current close price is lower than the close price two periods ago.</li>
</ul>
<p>The answer is in the following code snippet:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>   </code><code>
</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>   </code><code>
</code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>
</code><strong><code>            </code><code class="c1"># Bullish signal</code></strong><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code>
</code><code>
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>
</code><code> </code><strong><code>           </code><code class="c1"># Bearish signal</code></strong><code>
</code><code>            </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code>
</code><code>
</code><code>                </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code>
</code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code></pre>
<p>There you have it! The way you code signals is by using functions and then calling them. Calling a function is synonymous to applying it and seeing it realized.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>To call a signal function, use the following syntax:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">signal</code><code class="p">(</code><code class="n">my_data</code><code class="p">)</code></pre>
<p>The <code>return</code> statement<a contenteditable="false" data-primary="return statement" data-type="indexterm" id="idm46762874466816"/> obliges you to redefine your array to be what you want it to be (as defined by the signal function). This obligation comes from the fact that you are adding columns and, therefore, you must re-create the array.</p>
</div>
<p>Now, let’s proceed to the third algorithm: visual representation of the signals. It may seem that this is an optional step, and it is, but it is helpful to look at a sample of the signals so that you get an idea of what to expect. You must also visually check the signals of the patterns to make sure the algorithm is detecting the right configurations<a contenteditable="false" data-startref="ix_alg_mindset_func_sig" data-type="indexterm" id="idm46762874464880"/><a contenteditable="false" data-primary="" data-startref="ix_signal_alg_code" data-type="indexterm" id="idm46762877273600"/>.</p>
</div></section>
<section data-pdf-bookmark="Creating the Signal Charts" data-type="sect1"><div class="sect1" id="signal-charts">
<h1>Creating the Signal Charts</h1>
<p>When<a contenteditable="false" data-primary="visualization algorithm" data-secondary="signals charts" data-type="indexterm" id="ix_vis_signal_alg_chart"/><a contenteditable="false" data-primary="signal algorithm" data-secondary="creating signals charts" data-type="indexterm" id="ix_signal_alg_chart"/><a contenteditable="false" data-primary="algorithmic mindset and functions" data-secondary="creating signals charts" data-type="indexterm" id="ix_alg_mindset_func_sig_ch"/> you create and apply long and short signals, you have the core of your strategy ready, so you need to evaluate it in two different ways:</p>
<dl>
<dt>Subjectively</dt>
<dd>Visually inspect<a contenteditable="false" data-primary="subjective signal chart evaluation" data-type="indexterm" id="idm46762877244720"/> multiple signal charts to detect anomalies that can give hints to coding bugs (e.g., a wrong pattern detected by the algorithm). This can also help you understand better the frequency and the succession of signals. This is what you will see in this section.</dd>
<dt>Objectively</dt>
<dd>Objective evaluation<a contenteditable="false" data-primary="objective signal chart evaluation" data-type="indexterm" id="idm46762877242624"/> is the more important method. It is about calculating performance metrics such as the hit ratio. You will see and code all the metrics needed in the next section as I discuss them in depth.</dd>
</dl>
<p>The simple diagram in <a data-type="xref" href="#figure2-1">Figure 2-1</a> can help you understand where you stand at this point. Visualization is the third algorithm within the framework after importing the historical data and coding the signals.</p>
<figure><div class="figure" id="figure2-1"><img alt="" height="284" src="assets/mfpr_0201.png" width="600"/>
<h6><span class="label">Figure 2-1. </span>Algorithmic diagram</h6>
</div></figure>
<p><a data-type="xref" href="ch01.xhtml#chapter1">Chapter 1</a> covered how to import historical OHLC data from the MetaTrader 5 platform, and you have also seen how to load your own data in case it is not included on the MetaTrader 5 platform. This chapter has already discussed how to code and apply the signals generated from a set of conditions called the Alpha pattern. Let’s continue with that same example.</p>
<p>Here is a refresher of the trading conditions leading to a valid Alpha pattern:</p>
<ul>
<li>A long signal<a contenteditable="false" data-primary="long (buy) signal" data-type="indexterm" id="idm46762877235616"/> is generated on the next open whenever the current low is lower than the low price 5 periods ago and the low price 13 periods ago but higher than the low price 21 periods ago. Simultaneously, the close price of the current bar must be higher than the close price 3 periods ago.</li>
<li>A short signal<a contenteditable="false" data-primary="short (sell) signal" data-type="indexterm" id="idm46762877233936"/> is generated on the next open whenever the current high price is higher than the high price 5 periods ago and the high price 13 periods ago but lower than the high price 21 periods ago. Simultaneously, the close price of the current bar must be lower than the close price 3 periods ago.</li>
</ul>
<p>The next<a contenteditable="false" data-primary="simple bar charts" data-type="indexterm" id="ix_simple_bar_chart"/> step is to visualize these signals using simple bar charts. I then apply upward-pointing arrows where long signals are generated and downward-pointing arrows where short signals are generated. Later in the book, I create these signal charts using candlesticks, but since I have not introduced those yet, I will use <em>simple bar charts</em>, which are black vertical lines joining the highs and the lows of every bar. <a data-type="xref" href="#figure2-2">Figure 2-2</a> shows a simple bar.</p>
<figure><div class="figure" id="figure2-2"><img alt="" height="261" src="assets/mfpr_0202.png" width="91"/>
<h6><span class="label">Figure 2-2. </span>A simple high to low bar</h6>
</div></figure>
<p>As a reminder, I have not yet discussed technical analysis, so don’t worry if you feel overwhelmed with information, as everything should be clearer by the <a data-type="link" href="ch03.xhtml#chapter3">next chapter</a>.</p>
<p>Take a look at <a data-type="xref" href="#figure2-3">Figure 2-3</a>. It is an example of a simple bar chart where a vertical line has been drawn between the high and the low of every hour.</p>
<p>Let’s apply the signals from the Alpha pattern on the bars so that you know the positioning of your trades relative to the price action. This allows you to see what has happened to the price every time you have gotten an Alpha signal.</p>
<figure><div class="figure" id="figure2-3"><img alt="" height="432" src="assets/mfpr_0203.png" width="600"/>
<h6><span class="label">Figure 2-3. </span>Simple bar chart on USDCHF</h6>
</div></figure>
<p>Use the following<a contenteditable="false" data-primary="signal_chart() function" data-type="indexterm" id="ix_sig_chart_func"/><a contenteditable="false" data-primary="ohlc_plot_bars() function" data-type="indexterm" id="idm46762877220464"/> function, which I call <code>signal_chart()</code>. Before I define the signal chart, here is how to create the simple bar chart by using the <code>ohlc_plot_bars()</code> function, defined as follows:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">ohlc_plot_bars</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">window</code><code class="p">):</code>
     
    <code class="n">sample</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="o">-</code><code class="n">window</code><code class="p">:,</code> <code class="p">]</code>
    
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">sample</code><code class="p">)):</code>
        
        <code class="n">plt</code><code class="o">.</code><code class="n">vlines</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">i</code><code class="p">,</code> <code class="n">ymin</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">2</code><code class="p">],</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">1</code><code class="p">],</code> 
        <code class="n">color</code> <code class="o">=</code> <code class="s1">'black'</code><code class="p">,</code> <code class="n">linewidth</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>  
        
        <code class="k">if</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">]</code> <code class="o">&gt;</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">]:</code>
            
            <code class="n">plt</code><code class="o">.</code><code class="n">vlines</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">i</code><code class="p">,</code> <code class="n">ymin</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">],</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> 
            <code class="n">color</code> <code class="o">=</code> <code class="s1">'black'</code><code class="p">,</code> <code class="n">linewidth</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>  

        <code class="k">if</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">]</code> <code class="o">&lt;</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">]:</code>
            
            <code class="n">plt</code><code class="o">.</code><code class="n">vlines</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">i</code><code class="p">,</code> <code class="n">ymin</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">],</code> 
            <code class="n">color</code> <code class="o">=</code> <code class="s1">'black'</code><code class="p">,</code> <code class="n">linewidth</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>  
            
        <code class="k">if</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">]</code> <code class="o">==</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">]:</code>
            
            <code class="n">plt</code><code class="o">.</code><code class="n">vlines</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="n">i</code><code class="p">,</code> <code class="n">ymin</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="n">ymax</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code> <code class="o">+</code> 
            <code class="mf">0.00003</code><code class="p">,</code> <code class="n">color</code> <code class="o">=</code> <code class="s1">'black'</code><code class="p">,</code> <code class="n">linewidth</code> <code class="o">=</code> <code class="mf">1.00</code><code class="p">)</code>  
            
    <code class="n">plt</code><code class="o">.</code><code class="n">grid</code><code class="p">()</code>
</pre>
<p>The function<a contenteditable="false" data-primary="plt.vlines()" data-type="indexterm" id="idm46762877167216"/> allows you to plot the simple bar chart. It first starts by defining the <em>lookback period</em>, which is the number of recent observations to include in the visualization. The variable for the lookback period is <code>window</code>; thus, a window of 500 shows you the last 500 observations. It later loops around the observations that are within the variable <code>window</code> and plots vertical lines using <code>plt.vlines()</code>, as shown in the previous code.</p>
<p>To chart the last 500 bars, use the following syntax:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">ohlc_plot_bars</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code></pre>
<p>Now, let’s add the signals represented by arrows to the simple bar chart. Take a look at the following code block that defines the <code>signal_chart()</code> function and notice how it uses the previous function I showed:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code> <code class="nf">signal_chart</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">position</code><code class="p">,</code> <code class="n">buy_column</code><code class="p">,</code> <code class="n">sell_column</code><code class="p">,</code> <code class="n">window</code> <code class="o">=</code> <code class="mi">500</code><code class="p">):</code>
 
    <code class="n">sample</code> <code class="o">=</code> <code class="n">data</code><code class="p">[</code><code class="o">-</code><code class="n">window</code><code class="p">:,</code> <code class="p">]</code>
    
    <code class="n">fig</code><code class="p">,</code> <code class="n">ax</code> <code class="o">=</code> <code class="n">plt</code><code class="o">.</code><code class="n">subplots</code><code class="p">(</code><code class="n">figsize</code> <code class="o">=</code> <code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">5</code><code class="p">))</code>
    
    <code class="n">ohlc_plot_bars</code><code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">window</code><code class="p">)</code>    

    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">sample</code><code class="p">)):</code>
        
        <code class="k">if</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">buy_column</code><code class="p">]</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
            
            <code class="n">x</code> <code class="o">=</code> <code class="n">i</code>
            <code class="n">y</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">position</code><code class="p">]</code>
        
            <code class="n">ax</code><code class="o">.</code><code class="n">annotate</code><code class="p">(</code><code class="s1">' '</code><code class="p">,</code> <code class="n">xy</code> <code class="o">=</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">),</code> 
                        <code class="n">arrowprops</code> <code class="o">=</code> <code class="nb">dict</code><code class="p">(</code><code class="n">width</code> <code class="o">=</code> <code class="mi">9</code><code class="p">,</code> <code class="n">headlength</code> <code class="o">=</code> <code class="mi">11</code><code class="p">,</code> 
                        <code class="n">headwidth</code> <code class="o">=</code> <code class="mi">11</code><code class="p">,</code> <code class="n">facecolor</code> <code class="o">=</code> <code class="s1">'green'</code><code class="p">,</code> <code class="n">color</code> <code class="o">=</code> 
                        <code class="s1">'green'</code><code class="p">))</code>
        
        <code class="k">elif</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">sell_column</code><code class="p">]</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>
            
            <code class="n">x</code> <code class="o">=</code> <code class="n">i</code>
            <code class="n">y</code> <code class="o">=</code> <code class="n">sample</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">position</code><code class="p">]</code>
        
            <code class="n">ax</code><code class="o">.</code><code class="n">annotate</code><code class="p">(</code><code class="s1">' '</code><code class="p">,</code> <code class="n">xy</code> <code class="o">=</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">),</code> 
                        <code class="n">arrowprops</code> <code class="o">=</code> <code class="nb">dict</code><code class="p">(</code><code class="n">width</code> <code class="o">=</code> <code class="mi">9</code><code class="p">,</code> <code class="n">headlength</code> <code class="o">=</code> <code class="o">-</code><code class="mi">11</code><code class="p">,</code> 
                        <code class="n">headwidth</code> <code class="o">=</code> <code class="o">-</code><code class="mi">11</code><code class="p">,</code> <code class="n">facecolor</code> <code class="o">=</code> <code class="s1">'red'</code><code class="p">,</code> <code class="n">color</code> <code class="o">=</code> 
                        <code class="s1">'red'</code><code class="p">))</code>  
</pre>
<p>The variable <code>position</code> should be set to zero because the signals refer to open prices, which makes the arrows well placed. The function is therefore called like this:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">signal_chart</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="n">window</code> <code class="o">=</code> <code class="mi">250</code><code class="p">)</code></pre>
<p>If you apply this function on the OHLC array where you have already applied the signals from the Alpha pattern, you would get the signal chart in <a data-type="xref" href="#figure2-4">Figure 2-4</a>. Note that upward-pointing arrows represent exactly where long signals have been generated, whereas downward-pointing arrows represent where short signals have been generated. <a data-type="xref" href="#figure2-4">Figure 2-4</a> shows a signal chart on the hourly USDCHF values<a contenteditable="false" data-primary="" data-startref="ix_sig_chart_func" data-type="indexterm" id="idm46762877584976"/>.</p>
<figure><div class="figure" id="figure2-4"><img alt="" height="432" src="assets/mfpr_0204.png" width="600"/>
<h6><span class="label">Figure 2-4. </span>Signal chart on USDCHF</h6>
</div></figure>
<p>Let’s recap what you have done so far. You started by defining and coding the signals so that you have your proxies for buy and sell orders. Then you coded a chart function that shows these signals superimposed on the price chart, which gives an idea of where you bought and sold in the past.</p>
<p>Note that even though the simple bar chart shows only the highs and lows, the signals are put where the open price is, as it takes into account the totality of the OHLC data.</p>
<p class="pagebreak-before">The following code shows the chronological order of doing this process on the hourly values of USDCHF, as shown in the previous chart:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<strong><code class="c1"># Choosing the asset</code></strong><code>
</code><code class="n">pair</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>
</code><strong><code class="c1"># Time frame</code></strong><code>
</code><code class="n">horizon</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">H1</code><code class="s1">'</code><code>
</code><code>
</code><strong><code class="c1"># Importing the asset as an array</code></strong><code>
</code><code class="n">my_data</code><code> </code><code class="o">=</code><code> </code><code class="n">mass_import</code><code class="p">(</code><code class="n">pair</code><code class="p">,</code><code> </code><code class="n">horizon</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="c1"># Creating the signal function</code></strong><code>
</code><code class="k">def</code><code> </code><code class="nf">signal</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">add_column</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>   </code><code>
</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>   </code><code>
</code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>
</code><code>       </code><strong><code>     </code><code class="c1"># Bullish Alpha</code></strong><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code>
</code><code>               </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">13</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">21</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>
</code><code>               </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>
</code><code>                     </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>
</code><code>         </code><strong><code>   </code><code class="c1"># Bearish Alpha</code></strong><code>
</code><code>            </code><code class="k">elif</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code>
</code><code>                 </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">13</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">21</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code>
</code><code>                 </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>
</code><code>                     </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code>
</code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code><code>
</code><strong><code class="c1"># Calling the signal function</code></strong><code>
</code><code class="n">my_data</code><code> </code><code class="o">=</code><code> </code><code class="n">signal</code><code class="p">(</code><code class="n">my_data</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="c1"># Charting the latest 150 signals</code></strong><code>
</code><code class="n">signal_chart</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="mi">150</code><code class="p">)</code><code>
</code></pre>
<p class="pagebreak-before"><a data-type="xref" href="#figure2-5">Figure 2-5</a> shows the same process applied on the hourly values of EURUSD. Note that the pattern is hypothetical and has no scientific backing<a contenteditable="false" data-primary="" data-startref="ix_simple_bar_chart" data-type="indexterm" id="idm46762877926608"/><a contenteditable="false" data-primary="" data-startref="ix_vis_signal_alg_chart" data-type="indexterm" id="idm46762877872736"/><a contenteditable="false" data-primary="" data-startref="ix_alg_mindset_func_sig_ch" data-type="indexterm" id="idm46762877871360"/><a contenteditable="false" data-primary="" data-startref="ix_signal_alg_chart" data-type="indexterm" id="idm46762877870016"/>.</p>
<figure><div class="figure" id="figure2-5"><img alt="" height="294" src="assets/mfpr_0205.png" width="600"/>
<h6><span class="label">Figure 2-5. </span>Signal chart on the EURUSD</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Coding Performance Evaluation Functions" data-type="sect1"><div class="sect1" id="performance-evaluation">
<h1>Coding Performance Evaluation Functions</h1>
<p>Visualizing<a contenteditable="false" data-primary="performance evaluation" data-type="indexterm" id="ix_perf_eval_ch2"/><a contenteditable="false" data-primary="algorithmic mindset and functions" data-secondary="performance evaluation functions" data-type="indexterm" id="ix_alg_mindset_func_perf"/> signals is only a first step. You need objective data that tells you whether you have a winning or losing trading system.</p>
<p>For this, you need <em>performance evaluation</em>, which is simply the calculation of different metrics and ratios that give you hints about past performance. Your job afterward is to interpret these metrics and try to tweak the use of the pattern to improve the <span class="keep-together">metrics</span>.</p>
<p>Remember, a trading strategy can easily be a few conditions that lead to a pattern; therefore, even though this book discusses the details of candlestick patterns, I will briefly review trading strategies. Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.xhtml#chapter10">10</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch11.xhtml#chapter11">11</a> discuss a few strategies that naturally involve candlestick patterns.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Performance evaluation also involves the expectation that past performance indicates future performance. This kind of persistence is unlikely, but back-testing and evaluating past performance is the best you can do to validate and take your strategy live.</p>
</div>
<section class="pagebreak-before" data-pdf-bookmark="The Hit Ratio" data-type="sect2"><div class="sect2" id="idm46762878506320">
<h2 class="less_space">The Hit Ratio</h2>
<p>We humans<a contenteditable="false" data-primary="hit ratio" data-secondary="in performance evaluation" data-secondary-sortas="performance evaluation" data-type="indexterm" id="idm46762878462272"/> like to be right more often than we are wrong. Typically, we are proud of our achievements and ashamed of our failures, which is why we are comforted when we find out that most of our decisions led to the expected and desired results. Being right most of the time provides an ego boost that everyone welcomes. After all, who doesn’t want to be seen as successful?</p>
<p>The <em>hit ratio</em> in trading jargon is the number of past profitable trades divided by the total number of realized past trades. This means that the hit ratio measures the percentage of when you were right about the future direction. A 70% hit ratio means that, on average, you tend to make money on 70 trades out of every 100, which is not bad, but you must absolutely be careful because this is a double-edged sword, and you will see why later. Now, let’s take a look at the mathematical representation of the hit ratio:</p>
<div data-type="equation">
<math alttext="Hit ratio equals StartFraction Number of profitable trades Over Number of total trades EndFraction">
<mrow>
<mtext>Hit</mtext>
<mspace width="4.pt"/>
<mtext>ratio</mtext>
<mo>=</mo>
<mfrac><mrow><mtext>Number</mtext><mspace width="4.pt"/><mtext>of</mtext><mspace width="4.pt"/><mtext>profitable</mtext><mspace width="4.pt"/><mtext>trades</mtext></mrow> <mrow><mtext>Number</mtext><mspace width="4.pt"/><mtext>of</mtext><mspace width="4.pt"/><mtext>total</mtext><mspace width="4.pt"/><mtext>trades</mtext></mrow></mfrac>
</mrow>
</math>
</div>
<p>Evidently, the number of total trades includes both the number of profitable and losing trades. The hit ratio is one of the most observed and analyzed performance metrics due to its psychological effect on the receiver. Make sure you calculate the ratio on the total number of realized trades excluding the pending trades.</p>
</div></section>
<section data-pdf-bookmark="The Rate of Return" data-type="sect2"><div class="sect2" id="idm46762876617872">
<h2>The Rate of Return</h2>
<p>When<a contenteditable="false" data-primary="performance evaluation" data-secondary="rate of return" data-type="indexterm" id="idm46762876615984"/><a contenteditable="false" data-primary="rate of return" data-type="indexterm" id="idm46762876614576"/> you invest $100 and one year later it becomes $105, what can you say about your rate of return? Instead of stating that you have gained $5, you can present your profit as a return over the initial investment calculated this way:</p>
<div data-type="equation">
<math alttext="Rate of return equals left-parenthesis StartFraction New balance Over Initial balance EndFraction right-parenthesis minus 1">
<mrow>
<mtext>Rate</mtext>
<mspace width="4.pt"/>
<mtext>of</mtext>
<mspace width="4.pt"/>
<mtext>return</mtext>
<mo>=</mo>
<mo>(</mo>
<mfrac><mrow><mtext>New</mtext><mspace width="4.pt"/><mtext>balance</mtext></mrow> <mrow><mtext>Initial</mtext><mspace width="4.pt"/><mtext>balance</mtext></mrow></mfrac>
<mo>)</mo>
<mo>-</mo>
<mn>1</mn>
</mrow>
</math>
</div>
<p>This means that your rate of return is 5%. Expressing profitability in percentage terms gives better information regarding the magnitude of the gains and losses on the portfolio. Take, for example, these two hypotheticals:</p>
<ul>
<li>Portfolio A made $125,000.</li>
<li>Portfolio B returned 10%.</li>
</ul>
<p>Portfolio A does seem more impressive, but what if I told you that both portfolios had a starting (initial) balance of $2,000,000? This sure makes portfolio A the underperformer, as it made only 6.25%, whereas portfolio B made 10% ($200,000).</p>
<p>You can<a contenteditable="false" data-primary="gross rate of return" data-type="indexterm" id="idm46762876650480"/><a contenteditable="false" data-primary="net rate of return" data-type="indexterm" id="idm46762876649344"/> also calculate several types of returns, namely, the <em>gross</em> rate of return and the <em>net</em> rate of return. Surely what should interest you is the latter as it is net of fees. Let’s see the difference between the two in the following example:</p>
<ul>
<li>Initial balance on 01/01/2021 = $1,000,000</li>
<li>Final gross balance on 12/31/2021 = $1,175,000</li>
<li>Total unpaid commissions and fees incurred during 2021 = $35,000</li>
<li>Unpaid research provider fees during 2021 = $10,000</li>
</ul>
<p>In this example, the gross rate of return is the one that does not consider the fees paid to the broker and other third-party vendors:</p>
<div data-type="equation">
<math alttext="Gross rate of return left-parenthesis StartFraction 1 comma 175 comma 000 Over 1 comma 000 comma 000 EndFraction right-parenthesis minus 1 equals 17.5 percent-sign">
<mrow>
<mtext>Gross</mtext>
<mspace width="4.pt"/>
<mtext>rate</mtext>
<mspace width="4.pt"/>
<mtext>of</mtext>
<mspace width="4.pt"/>
<mtext>return</mtext>
<mo>=</mo>
<mo>(</mo>
<mfrac><mrow><mn>1</mn><mo lspace="0%" rspace="0%">,</mo><mn>175</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn></mrow> <mrow><mn>1</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn></mrow></mfrac>
<mo>)</mo>
<mo>-</mo>
<mn>1</mn>
<mo>=</mo>
<mn>17</mn>
<mo lspace="0%" rspace="0%">.</mo>
<mn>5</mn>
<mo lspace="0%" rspace="0%">%</mo>
</mrow>
</math>
</div>
<p>The net return is closer to what you actually gain and is found through this <span class="keep-together">calculation</span>:</p>
<div data-type="equation">
<math alttext="Net rate of return left-parenthesis StartFraction 1 comma 175 comma 000 minus 35 comma 000 minus 10 comma 000 Over 1 comma 000 comma 000 EndFraction right-parenthesis minus 1 equals 13 percent-sign">
<mrow>
<mtext>Net</mtext>
<mspace width="4.pt"/>
<mtext>rate</mtext>
<mspace width="4.pt"/>
<mtext>of</mtext>
<mspace width="4.pt"/>
<mtext>return</mtext>
<mo>=</mo>
<mo>(</mo>
<mfrac><mrow><mn>1</mn><mo lspace="0%" rspace="0%">,</mo><mn>175</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn><mo>-</mo><mn>35</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn><mo>-</mo><mn>10</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn></mrow> <mrow><mn>1</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn><mo lspace="0%" rspace="0%">,</mo><mn>000</mn></mrow></mfrac>
<mo>)</mo>
<mo>-</mo>
<mn>1</mn>
<mo>=</mo>
<mn>13</mn>
<mo lspace="0%" rspace="0%">%</mo>
</mrow>
</math>
</div>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The portfolio is still profitable but has taken a hit after subtracting the costs. Some portfolios switch from winners to losers after removing the costs, which is why it is important to choose a broker with an acceptable fee structure so that it does not eat away your profits over time. Even small differences in commissions can have a huge impact on active traders.</p>
</div>
</div></section>
<section data-pdf-bookmark="The Profit Factor" data-type="sect2"><div class="sect2" id="idm46762876617248">
<h2>The Profit Factor</h2>
<p>The <em>profit factor</em> is a quick<a contenteditable="false" data-primary="performance evaluation" data-secondary="profit factor" data-type="indexterm" id="idm46762878427664"/><a contenteditable="false" data-primary="profit factor" data-type="indexterm" id="idm46762878426256"/> measure to see how much you are winning for every 1 currency unit of loss. It is calculated as the ratio between gross overall profit and gross<a contenteditable="false" data-primary="gross total loss" data-type="indexterm" id="idm46762878424864"/><a contenteditable="false" data-primary="gross total profit" data-type="indexterm" id="idm46762878423760"/> overall loss, meaning that you divide the sum of the profits from all profitable trades by the sum of the losses from all losing trades. Mathematically, it is expressed as <span class="keep-together">follows</span>:</p>
<div data-type="equation">
<math alttext="Profit factor equals StartFraction Gross total profit Over StartAbsoluteValue Gross total loss EndAbsoluteValue EndFraction">
<mrow>
<mtext>Profit</mtext>
<mspace width="4.pt"/>
<mtext>factor</mtext>
<mo>=</mo>
<mfrac><mrow><mtext>Gross</mtext><mspace width="4.pt"/><mtext>total</mtext><mspace width="4.pt"/><mtext>profit</mtext></mrow> <mrow><mo>|</mo><mtext>Gross</mtext><mspace width="4.pt"/><mtext>total</mtext><mspace width="4.pt"/><mtext>loss</mtext><mo>|</mo></mrow></mfrac>
</mrow>
</math>
</div>
<p>It is important to divide by the absolute value of the gross total loss. Let’s consider an example of a portfolio that had $127,398 profits in 2020 and $88,318 losses. What would be the profit ratio in this case?</p>
<p>The answer is 1.44, which is interpreted as gaining on average $1.44 for every $1.00 lost. Whenever the profitability is positive, the profit factor is bigger than 1, and whenever the profitability is negative, the profit factor is less than 1. Some traders like to optimize their strategies by tweaking them until they find the highest profit factor.</p>
</div></section>
<section data-pdf-bookmark="The Risk-Reward Ratio" data-type="sect2"><div class="sect2" id="idm46762878412288">
<h2>The Risk-Reward Ratio</h2>
<p>A good<a contenteditable="false" data-primary="risk-reward ratio" data-type="indexterm" id="ix_risk_reward"/><a contenteditable="false" data-primary="performance evaluation" data-secondary="risk-reward ratio" data-type="indexterm" id="ix_perf_eval_risk_rew"/> trading system is measured by the amount of reward acquired per amount of risk taken to achieve the reward. When you risk $1.00 to gain $1.00, the risk-reward ratio is equal to 1.00, and you have 50% chance of either winning or losing the same amount, unless you have a statistical edge that over time makes you win more often than you lose.</p>
<p>This statistical<a contenteditable="false" data-primary="hit ratio" data-type="indexterm" id="idm46762878406768"/><a contenteditable="false" data-primary="stop price" data-type="indexterm" id="idm46762878405632"/><a contenteditable="false" data-primary="target price" data-type="indexterm" id="ix_target_price"/> edge is the notion of the hit ratio. When you enter a trade and set your <em>target </em>(the level at which you close out profitably) and your <em>stop </em>(the level at which you close out at a loss to avoid a worse outcome), you can actually calculate your theoretical (expected) risk-reward ratio.</p>
<p>Here is a simple example based on buying the cryptocurrency Cardano (ADA) relative to the USDT (a proxy for the USD):</p>
<ul>
<li>Buy ADAUSDT at $1.00.</li>
<li>Set stop at $0.95.</li>
<li>Set target at $1.10.</li>
</ul>
<p>What is the risk-reward ratio of this trade, and how can you interpret it? Simply put, you are risking $0.05 to gain $0.10, which means your reward is double the risk; hence, the risk-reward ratio is 2.00.</p>
<div data-type="equation">
<math alttext="Risk reward ratio equals StartFraction StartAbsoluteValue Entry price minus Target price EndAbsoluteValue Over StartAbsoluteValue Entry price minus Stop price EndAbsoluteValue EndFraction">
<mrow>
<mtext>Risk</mtext>
<mspace width="4.pt"/>
<mtext>reward</mtext>
<mspace width="4.pt"/>
<mtext>ratio</mtext>
<mo>=</mo>
<mfrac><mrow><mo>|</mo><mtext>Entry</mtext><mspace width="4.pt"/><mtext>price</mtext><mo>-</mo><mtext>Target</mtext><mspace width="4.pt"/><mtext>price</mtext><mo>|</mo></mrow> <mrow><mo>|</mo><mtext>Entry</mtext><mspace width="4.pt"/><mtext>price</mtext><mo>-</mo><mtext>Stop</mtext><mspace width="4.pt"/><mtext>price</mtext><mo>|</mo></mrow></mfrac>
</mrow>
</math>
</div>
<p>The preceding formula shows how to calculate the theoretical or expected risk-reward ratio, which is set before the trade.</p>
<div data-type="tip"><h6>Tip</h6>
<p>A rule of thumb is to generally try to target strategies that offer a risk-reward ratio close to 2.00, as this gives you enough margin of predictability error to stay in the green. Assuming same quantity trading, with a 2.00 risk-reward ratio, you only need a hit ratio of 33.33% to break even.</p>
</div>
<p>The break-even hit ratio is the minimum hit ratio needed to achieve zero profit and loss, excluding costs and fees. As it is just an indicative measure, the break-even hit ratio is rarely presented in performance reports. However, you can easily calculate it through the risk-reward ratio like this:</p>
<div data-type="equation">
<math>
<mrow>
<mtext>Break-even hit ratio</mtext>
<mo>=</mo>
<mfrac><mn>1</mn> <mrow><mn>1</mn><mo>+</mo><mtext>Risk reward ratio</mtext></mrow></mfrac>
</mrow>
</math>
</div>
<p>That gives you a negative relationship between the hit ratio and the risk-reward ratio, as the less you risk and increase your reward, the less you are likely to actually hit the reward (target) because you are closer to the risk (stop). Consider the following example:</p>
<ul>
<li>Hit ratio since 01-01-2021 = 43.67%</li>
<li>Realized risk-reward ratio since 01-01-2021 = 2.11</li>
</ul>
<p>What would be the break-even hit ratio in this case? By using the formula, you can find the following result:</p>
<div data-type="equation">
<math>
<mrow>
<mtext>Break-even hit ratio</mtext>
<mo>=</mo>
<mfrac><mn>1</mn> <mrow><mn>1</mn><mo>+</mo><mn>2</mn><mo lspace="0%" rspace="0%">.</mo><mn>11</mn></mrow></mfrac>
<mo>=</mo>
<mn>32</mn>
<mo lspace="0%" rspace="0%">.</mo>
<mn>15</mn>
<mo lspace="0%" rspace="0%">%</mo>
</mrow>
</math>
</div>
<p>This means that you have a winning strategy because you have on average 43–44 profitable trades per 100 trades. Furthermore, for each of these trades, you win on average 2.11 times the amount you lose, and this is what makes the difference. Proper risk management is what makes profitable trading systems. A first look on the hit ratio leaves the eye unimpressed, but by glancing at the risk-reward, a whole new picture emerges<a contenteditable="false" data-primary="" data-startref="ix_target_price" data-type="indexterm" id="idm46762876870800"/>.</p>
<p>In reality, some trades can be closed before getting stopped out or before seeing their targets, and this is due to various reasons, like getting another signal in the same direction. Therefore, you have two different risk-reward ratios:</p>
<dl>
<dt>The theoretical risk-reward ratio</dt>
<dd>This is generally<a contenteditable="false" data-primary="theoretical risk-reward ratio" data-type="indexterm" id="idm46762876867696"/> set before the trade and is a forecast.</dd>
<dt>The realized risk-reward ratio</dt>
<dd>This is the average<a contenteditable="false" data-primary="realized risk-reward ratio" data-type="indexterm" id="idm46762876865584"/> profit per trade divided by the average loss per trade, which gives an idea of how close you are to your theoretical risk-reward ratio.</dd>
</dl>
<p>Let’s take a look at another example to interpret the two ratios:</p>
<ul>
<li>Theoretical risk-reward ratio set on 01-01-2021 = 2.00</li>
<li>Average gain per trade during 2021 = $241,597</li>
<li>Average loss per trade during 2021 = $127,222</li>
</ul>
<p>The realized risk-reward ratio is therefore 1.90, which is slightly less than the theoretical one. This is acceptable as sometimes you exit some trades before reaching the stop or target level. The ratios presented in the back-tests in this book are the realized ones<a contenteditable="false" data-primary="" data-startref="ix_perf_eval_risk_rew" data-type="indexterm" id="idm46762876861440"/><a contenteditable="false" data-primary="" data-startref="ix_risk_reward" data-type="indexterm" id="idm46762876860064"/>.</p>
</div></section>
<section data-pdf-bookmark="The Number of Trades" data-type="sect2"><div class="sect2" id="idm46762878411344">
<h2>The Number of Trades</h2>
<p>The frequency<a contenteditable="false" data-primary="frequency of signals" data-type="indexterm" id="idm46762876857536"/> of trades is important for performance evaluation. A rule of thumb to keep in mind is to have at least 30 trades in order to meet the minimum threshold for reliability. Of course, over the years, the frequency of trades must be much higher. Some patterns are so rare that they are unlikely to give many signals, thus preventing you from properly judging them.</p>
<p>Unfortunately, some patterns can be quite rare, but, in any case, the book is not about blemishing and glorifying them, as some are actually very bad and nonpredictive yet are used by many retail traders to analyze the market. This brings us to the second utility of the book: demystification. It is time to see how to code these metrics in Python.</p>
</div></section>
<section data-pdf-bookmark="Creating a Performance Evaluation Function" data-type="sect2"><div class="sect2" id="idm46762876855600">
<h2>Creating a Performance Evaluation Function</h2>
<p>You have finally ended the theoretical part of the discussion of performance metrics. Even though in reality there are more metrics that dig into the details of performance, you do not need to calculate them all to get a quick idea of what works and what does not.</p>
<p>For example, the rate of return is not very useful in the back-tests later in the book because it is a function of position size and transaction costs, so it does not deal with predictability directly. This is why I use only the other four metrics:</p>
<ul>
<li>The hit ratio<a contenteditable="false" data-primary="hit ratio" data-secondary="in performance evaluation" data-secondary-sortas="performance evaluation" data-type="indexterm" id="idm46762876852752"/> gives you a preliminary idea of the predictability of the pattern or the strategy.</li>
<li>The profit<a contenteditable="false" data-primary="profit factor" data-type="indexterm" id="idm46762876850512"/> factor allows you to see whether the generated profits are greater than the generated losses regardless of position sizing.</li>
<li>The realized<a contenteditable="false" data-primary="realized risk-reward ratio" data-type="indexterm" id="idm46762876848832"/> risk-reward ratio shows you how much you are being rewarded compared to the risk you are taking.</li>
<li>The frequency<a contenteditable="false" data-primary="signal frequency" data-type="indexterm" id="idm46762876847024"/> of signals reveals whether the results are meaningful or not and whether you expect frequent signals or uncommon ones.</li>
</ul>
<p class="pagebreak-before">The performance<a contenteditable="false" data-primary="performance evaluation" data-secondary="creating a function" data-type="indexterm" id="ix_perf_eval_create_func"/><a contenteditable="false" data-primary="performance() function" data-type="indexterm" id="ix_perf_func"/> metrics are bundled into a Python function that I call <code>performance()</code>, shown in the following code block. I will explain after the code how it works and what it outputs:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="k">def</code><code> </code><code class="nf">performance</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">open_price</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">buy_column</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">sell_column</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">long_result_col</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">short_result_col</code><code class="p">,</code><code> </code><code>
</code><code>                 </code><code class="n">total_result_col</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code>
</code><strong><code>    </code><code class="c1"># Variable holding period</code></strong><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                </code><code>
</code><code>                </code><code class="k">for</code><code> </code><code class="n">a</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1000</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                    </code><code>
</code><code>                    </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="ow">or</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code>\
</code><code>                                              </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">long_result_col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">open_price</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code>\
</code><code>                                                   </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_price</code><code class="p">]</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="k">break</code><code>
</code><code>                    </code><code>
</code><code>                    </code><code class="k">else</code><code class="p">:</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="k">continue</code><code>                </code><code>
</code><code>                    </code><code>
</code><code>            </code><code class="k">else</code><code class="p">:</code><code>
</code><code>                </code><code>
</code><code>                </code><code class="k">continue</code><code>
</code><code>            </code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>
</code><code>                    </code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                </code><code>
</code><code>                </code><code class="k">for</code><code> </code><code class="n">a</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">i</code><code> </code><code class="o">+</code><code> </code><code class="mi">1000</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                                        </code><code>
</code><code>                    </code><code class="k">if</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">buy_column</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="ow">or</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">sell_column</code><code class="p">]</code><code> </code><code>\
</code><code>                                              </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">short_result_col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">open_price</code><code class="p">]</code><code> </code><code class="o">-</code><code>\
</code><code>                                                    </code><code class="n">data</code><code class="p">[</code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">open_price</code><code class="p">]</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="k">break</code><code>   </code><code>
</code><code>                     </code><code>
</code><code>                    </code><code class="k">else</code><code class="p">:</code><code>
</code><code>                        </code><code>
</code><code>                        </code><code class="k">continue</code><code>
</code><code>                    </code><code>
</code><code>            </code><code class="k">else</code><code class="p">:</code><code>
</code><code>                </code><code class="k">continue</code><code>
</code><code>            </code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="ne">IndexError</code><code class="p">:</code><code>
</code><code>            </code><code>
</code><code>            </code><code class="k">pass</code><code>   </code><code>
</code><code>        </code><code>
</code><code> </code><strong><code>   </code><code class="c1"># Aggregating the long &amp; short results into one column</code></strong><code>
</code><code>    </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">total_result_col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">long_result_col</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code>\
</code><code>                                </code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">short_result_col</code><code class="p">]</code><code>  </code><code>
</code><code>    </code><code>
</code><strong><code>    </code><code class="c1"># Profit factor   </code></strong><code class="c1"> </code><code>
</code><code>    </code><code class="n">total_net_profits</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">total_result_col</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code>\
</code><code>                        </code><code class="n">total_result_col</code><code class="p">]</code><code>
</code><code>    </code><code class="n">total_net_losses</code><code>  </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">data</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">total_result_col</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code>\
</code><code>                        </code><code class="n">total_result_col</code><code class="p">]</code><code> </code><code>
</code><code>    </code><code class="n">total_net_losses</code><code>  </code><code class="o">=</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">total_net_losses</code><code class="p">)</code><code>
</code><code>    </code><code class="n">profit_factor</code><code>     </code><code class="o">=</code><code> </code><code class="nb">round</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">total_net_profits</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code>\
</code><code>                        </code><code class="n">np</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">total_net_losses</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
</code><code>
</code><strong><code>    </code><code class="c1"># Hit ratio  </code></strong><code class="c1">  </code><code>
</code><code>    </code><code class="n">hit_ratio</code><code>         </code><code class="o">=</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">total_net_profits</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">total_net_losses</code><code class="p">)</code><code> </code><code>\
</code><code>                        </code><code class="o">+</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">total_net_profits</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">hit_ratio</code><code>         </code><code class="o">=</code><code> </code><code class="n">hit_ratio</code><code> </code><code class="o">*</code><code> </code><code class="mi">100</code><code>
</code><code>    </code><code>
</code><strong><code>    </code><code class="c1"># Risk-reward ratio</code></strong><code>
</code><code>    </code><code class="n">average_gain</code><code>            </code><code class="o">=</code><code> </code><code class="n">total_net_profits</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">average_loss</code><code>            </code><code class="o">=</code><code> </code><code class="n">total_net_losses</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">realized_risk_reward</code><code>    </code><code class="o">=</code><code> </code><code class="n">average_gain</code><code> </code><code class="o">/</code><code> </code><code class="n">average_loss</code><code>
</code><code>
</code><strong><code>    </code><code class="c1"># Number of trades</code></strong><code>
</code><code>    </code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">total_net_losses</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">total_net_profits</code><code class="p">)</code><code>
</code><code>        </code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Hit Ratio         = </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">hit_ratio</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Profit factor     = </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">profit_factor</code><code class="p">)</code><code> </code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Realized RR       = </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">round</code><code class="p">(</code><code class="n">realized_risk_reward</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Number of trades  = </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">trades</code><code class="p">)</code><code>    </code><code>
</code></pre>
<p>The function is not as complex as it seems. For instance, it takes seven variables that refer to the array and its column indices. The variable <code>data</code> represents the OHLC array that contains the historical data and the signals generated by the pattern. Remember, the signals are in the form of 1s in case of a long trigger and in the form of −1s in case of a short trigger. The variable <code>open_price</code> is simply the first column of the array, which represents the open price for each time step. In your case, it would be each hour as you are using the hourly time frame.</p>
<p>Do not<a contenteditable="false" data-primary="long_result_col variable" data-type="indexterm" id="idm46762876101728"/><a contenteditable="false" data-primary="short_result_col variable" data-type="indexterm" id="idm46762876100576"/> forget that the first column of an array is indexed at zero in Python, so the variable <code>open_price</code> always has a value of 0. The following two variables represent the positions where the buy and sell signals are stored, respectively. With simple patterns, it is generally 4 and 5, while with more complex patterns, it can be more. The <code>long_result_col</code> and the <code>short_result_col</code> variables are the indices of the results found from the <code>buy_column</code> and <code>sell_column</code>.</p>
<p>This means that whenever you exit a long position, the result of that position is stored in the column described by the variable <code>long_result_col</code>. Finally, <code>total_result_col</code> is always the next column to come after <code>short_result_col</code> as it is the sum of the two result columns. The <code>total_result_col</code> column is created to facilitate the calculation of the performance metrics. Now, to call the function, use the following syntax:</p>
<pre data-code-language="python" data-executable="true" data-type="programlisting">
<code class="n">my_data</code> <code class="o">=</code> <code class="n">performance</code><code class="p">(</code><code class="n">my_data</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code></pre>
<p>The statement calls the performance function on an array called <code>my_data</code>, which you have seen how to import, then it replaces the variables with the necessary values. If you are unsure of how to find the variables, carefully reread the previous paragraph<a contenteditable="false" data-primary="" data-startref="ix_perf_func" data-type="indexterm" id="idm46762876453456"/><a contenteditable="false" data-primary="" data-startref="ix_perf_eval_create_func" data-type="indexterm" id="idm46762876452208"/>.</p>
</div></section>
<section data-pdf-bookmark="A Hypothetical Example: Appraising Performance" data-type="sect2"><div class="sect2" id="idm46762876450480">
<h2>A Hypothetical Example: Appraising Performance</h2>
<p>Before<a contenteditable="false" data-primary="performance evaluation" data-secondary="examples" data-type="indexterm" id="ix_perf_eval_example"/> I close this chapter, let’s take a look at a full example and interpret its results. After all, back-testing is about understanding what the strategy or pattern has given so that you improve it. The following details are for a portfolio that uses a single strategy between 2017 and 2021:</p>
<ul>
<li>Total number of trades = 2,348</li>
<li>Profitable trades = 1,236</li>
<li>Losing trades = 1,112</li>
<li>Theoretical risk-reward ratio = 2.00</li>
<li>Total net gain from trades = $457,995</li>
<li>Total net loss from trades = $321,589</li>
<li>Average gain per trade = $370.54</li>
<li>Average loss per trade = $289.19</li>
</ul>
<section data-pdf-bookmark="What is the hit ratio of the period between 2017 and 2021?" data-type="sect3"><div class="sect3" id="what_is_the_hit_ratio_of_the_period_between_2017_and_2012">
<h3>What is the hit ratio of the period between 2017 and 2021?</h3>
<p>The hit ratio<a contenteditable="false" data-primary="hit ratio" data-secondary="in performance evaluation" data-secondary-sortas="performance evaluation" data-type="indexterm" id="idm46762876439872"/> is simply the number of profitable trades divided by the total number of realized trades. In this example, it is 52.64%.</p>
</div></section>
<section data-pdf-bookmark="What is the net profit factor between 2017 and 2021? How would you interpret it?" data-type="sect3"><div class="sect3" id="what_is_the_net_profit_factor_between_2017_and_2021_how_would_you_interpret_it">
<h3>What is the net profit factor between 2017 and 2021? How would you interpret it?</h3>
<p>The profit factor<a contenteditable="false" data-primary="performance evaluation" data-secondary="profit factor" data-type="indexterm" id="idm46762876436256"/><a contenteditable="false" data-primary="profit factor" data-type="indexterm" id="idm46762876434848"/> is the total profits divided by the total losses. In this example, it is 1.42, which is well above 1.00. The portfolio is generating $1.42 for every $1.00 it loses.</p>
</div></section>
<section data-pdf-bookmark="What is the realized risk-reward ratio between 2017 and 2021? And how does it compare to the theoretical risk-reward ratio?" data-type="sect3"><div class="sect3" id="what_is_the_realized_risk-reward_ratio_between_2017_and_2021_and-how_does_it_compare_to_the_theoretical_risk-reward_ratio">
<h3>What is the realized risk-reward ratio between 2017 and 2021? And how does it compare to the theoretical risk-reward ratio?</h3>
<p>The realized<a contenteditable="false" data-primary="risk-reward ratio" data-type="indexterm" id="idm46762876431824"/> risk-reward ratio is the ratio of the average gain per trade to the average loss per trade. In this example, it is 1.28. It is well below the theoretical risk-reward ratio, which stands at 2.00, and therefore the portfolio is experiencing suboptimal risk management, probably due to early closing of positions.</p>
</div></section>
<section data-pdf-bookmark="How should we interpret the frequency of signals?" data-type="sect3"><div class="sect3" id="how_should_we_interpret_the_frequency_of_signals">
<h3>How should we interpret the frequency of signals?</h3>
<p>With 2,348 trades<a contenteditable="false" data-primary="signal frequency" data-type="indexterm" id="idm46762879231232"/><a contenteditable="false" data-primary="frequency of signals" data-type="indexterm" id="idm46762879230096"/> over the course of five years, the portfolio has a relatively high trading activity, about 469 trades per year. Transaction costs are a cause of concern with such a high number of trades. Statistically, the performance metrics should properly describe the portfolio’s situation since there are many signals.</p>
</div></section>
<section data-pdf-bookmark="Is this a well-managed portfolio?" data-type="sect3"><div class="sect3" id="is_this_a_well-managed_portfolio">
<h3>Is this a well-managed portfolio?</h3>
<p>Even though profitability as shown by the profit factor is high, the manager should consider improving the realized risk-reward ratio while maintaining a hit ratio above 50%. This can be done through tweaks, optimizations, and even reviewing the entry/exit techniques. The manager should also investigate filtering the trades in order to decrease brokerage fees. However, the portfolio is in the green and seems to have a predictive strategy<a contenteditable="false" data-primary="" data-startref="ix_perf_eval_example" data-type="indexterm" id="idm46762879227024"/><a contenteditable="false" data-primary="" data-startref="ix_alg_mindset_func_perf" data-type="indexterm" id="idm46762879225648"/><a contenteditable="false" data-primary="" data-startref="ix_perf_eval_ch2" data-type="indexterm" id="idm46762879224208"/><a contenteditable="false" data-primary="" data-startref="ix_alg_mindset_func_ch2" data-type="indexterm" id="idm46762879222832"/>.</p>
<p>You have now finished building the core of the algorithms that you will use to analyze and back-test the candlestick patterns. Before presenting those patterns, you have one more stop to make, which is to understand technical analysis, the field of research where candlestick pattern recognition lies.</p>
</div></section>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm46762874354240"><sup><a href="ch02.xhtml#idm46762874354240-marker">1</a></sup> A <em>moving average</em> is a mean calculated on a rolling window. It is typically used to understand the trend of the market. Moving averages are discussed in greater depth in <a data-type="xref" href="ch03.xhtml#chapter3">Chapter 3</a>.</p><p data-type="footnote" id="idm46762878053424"><sup><a href="ch02.xhtml#idm46762878053424-marker">2</a></sup> An abbreviation for Not a Number. The cell that has NaN is considered invalid and will yield only other NaNs if used in calculations.</p><p data-type="footnote" id="idm46762875822448"><sup><a href="ch02.xhtml#idm46762875822448-marker">3</a></sup> Since I use an hourly time frame throughout the book, the previous row refers to the previous hourly <span class="keep-together">candlestick</span>.</p></div></div></section></div></body></html>