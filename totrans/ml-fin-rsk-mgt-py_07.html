<html><head></head><body><section data-pdf-bookmark="Chapter 5. Modeling Market Risk" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_5">&#13;
<h1><span class="label">Chapter 5. </span>Modeling Market Risk</h1>&#13;
&#13;
<blockquote data-type="epigram">&#13;
<p>&#13;
A measure of risk driven by historical data assumes the future will follow the pattern of the past. You need to understand the limitations of that assumption. More importantly, you need to model scenarios in which that pattern breaks down.</p>&#13;
<p data-type="attribution"> Miles Kennedy </p>&#13;
</blockquote>&#13;
&#13;
<p><a data-primary="market risk" data-type="indexterm" id="ix_market_risk_ch5"/>Risk is ubiquitous in finance, but it is hard to quantify. First and foremost, it’s important to know how to differentiate the sources of financial risks on the grounds that it might not be a wise move to use the same tools against risks arising from different sources.</p>&#13;
&#13;
<p>Thus, treating the various sources of financial risk differently is crucial because the impacts of those different risks, as well as the tools used to mitigate them, are completely different. Assuming that firms are subject to large market fluctuations, then all assets in their portfolios are susceptible to risk originating from these fluctuations. However, a different tool should be developed to cope with a risk emanating from customer profiles. In addition, keep in mind that different risk factors contribute significantly to asset prices. All of these examples imply that treating risk factors needs careful consideration in finance.</p>&#13;
&#13;
<p>As was briefly discussed previously, these risks are mainly market, credit, liquidity, and operational risks. It is evident that some other types can be added to this list, but they can be thought of as subbranches of these main four risk types, which will be our focus throughout this chapter.</p>&#13;
&#13;
<p><em>Market risk</em> is the risk arising from changes in financial indicators, such as the exchange rate, interest rate, inflation, and so on. Market risk can be referred to as risk of losses in on- and off-balance-sheet positions arising from movements in market prices (BIS 2020). Let’s now see how these factors affect market risk. Suppose that &#13;
<span class="keep-together">a rise</span> in inflation rates poses a threat to the current profitability of the financial &#13;
<span class="keep-together">institutions</span>, since inflation creates pressures on interest rates. This, in turn, affects the cost of funds for borrowers. These instances can be amplified, but we should also note the interactions of these financial risk sources. That is, when a single source of financial risk changes, other risk sources cannot stay constant. Thus to some extent, financial indicators are interrelated, meaning that the interactions of these risk sources should be taken into account.</p>&#13;
&#13;
<p>As you can imagine, there are different tools to manage market risk. Of them, the most prominent and widely accepted tools are value at risk (VaR) and expected shortfall (ES). The ultimate aim of this chapter is to augment these approaches using recent developments in ML. At this juncture, it would be tempting to ask the following questions:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Do traditional models fail in finance?</p>&#13;
</li>&#13;
<li>&#13;
<p>What makes the ML-based model different?</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>I will start by tackling the first question. The first and foremost challenge that traditional models are unable to address is the complexity of the financial system. Due either to some strong assumptions, or simply their inability to capture the complexity introduced by the data, long-standing traditional models are starting to be replaced by ML-based models.</p>&#13;
&#13;
<p>This fact is well put by Prado (2020):</p>&#13;
<blockquote>&#13;
<p>Considering the complexity of modern financial systems, it is unlikely that a researcher will be able to uncover the ingredients of a theory by visual inspection of the data or by running a few regressions.</p></blockquote>&#13;
&#13;
<p><a data-primary="ML (machine learning)" data-secondary="and market risk" data-secondary-sortas="market risk" data-type="indexterm" id="idm45737235263360"/>To address the second question, it would be  wise to think about the working logic of ML models. ML models, as opposed to old statistical methods, try to unveil the associations between variables, identify key variables, and enable us to find out the impact of the variables on the dependent variable without the need for a well-established theory. This is, in fact, the beauty of ML models in the sense that they allow us to discover theories rather than require them:</p>&#13;
<blockquote data-type="epigram">&#13;
<p>Many methods from statistics and machine learning (ML) may, in principle, be used for both prediction and inference. However, statistical methods have a long-standing focus on inference, which is achieved through the creation and fitting of a project-specific probability model...&#13;
</p>&#13;
<p>By contrast, ML concentrates on prediction by using general-purpose learning algorithms to find patterns in often rich and unwieldy data.</p>&#13;
<p data-type="attribution">Bzdok (2018, p. 232)</p>&#13;
</blockquote>&#13;
&#13;
<p class="pagebreak-before less_space">In the following section, we’ll start our discussion on the market risk models. First, we’ll talk about the application of the VaR and ES models. After discussing the traditional application of these models, we will learn how we can improve them by using an ML-based approach. Let’s jump in.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Value at Risk (VaR)" data-type="sect1"><div class="sect1" id="idm45737235257600">&#13;
<h1>Value at Risk (VaR)</h1>&#13;
&#13;
<p><a data-primary="VaR (Value at Risk)" data-type="indexterm" id="ix_valueatrisk_VaR"/><a data-primary="market risk" data-secondary="Value at Risk" data-type="indexterm" id="ix_market_risk_VaR"/>The VaR model emerged from a request made by a J.P. Morgan executive who wanted to have a summary report showing possible losses as well as risks that J.P. Morgan was exposed to on a given day. This report would inform executives about the risks assumed by the institution in an aggregated manner. The method by which market risk is computed is known as VaR. This report was the starting point of VaR, and now it has become so widespread that not only institutions prefer using VaR, but its adoption has become required by regulators.</p>&#13;
&#13;
<p>The adoption of VaR dates back to the 1990s, and despite numerous extensions to it and new proposed models, it is still in use. What makes it so appealing? The answer comes from Kevin Dowd (2002, p. 10):</p>&#13;
<blockquote data-type="epigram">&#13;
<p>The VaR figure has two important characteristics. The first is that it provides a common consistent measure of risk across different positions and risk factors. It enables us to measure the risk associated with a fixed-income position, say, in a way that is comparable to and consistent with a measure of the risk associated with equity positions. VaR provides us with a common risk yardstick, and this yardstick makes it possible for institutions to manage their risks in new ways that were not possible before. The other characteristic of VaR is that it takes account of the correlations between different risk factors. If two risks offset each other, the VaR allows for this offset and tells us that the overall risk is fairly low.</p>&#13;
</blockquote>&#13;
&#13;
<p>In fact, VaR  addresses one of the most common questions an investor has:&#13;
<em>what is the maximum expected loss of my investment?</em></p>&#13;
&#13;
<p>VaR provides a very intuitive and practical answer to this question. In this regard, it is used to measure the worst expected loss for a company over a given period and a pre-defined confidence interval. Suppose that a daily VaR of an investment is $1 million with 95% confidence interval. This would read as there being a 5% chance that an investor might incur a loss greater than $1 million in a day.</p>&#13;
&#13;
<p><a data-primary="asset or portfolio value, VaR" data-type="indexterm" id="idm45737235248848"/><a data-primary="portfolio or asset value, VaR" data-type="indexterm" id="idm45737235248128"/>Based on this definition, we can determine that the components of VaR are a <a data-primary="confidence interval, VaR" data-type="indexterm" id="idm45737235247312"/>confidence interval, a <a data-primary="time period, VaR" data-type="indexterm" id="idm45737235246496"/>time period, the value of an asset or portfolio, and the <a data-primary="standard deviation" data-type="indexterm" id="idm45737235245664"/>standard deviation, as we are talking about risk.</p>&#13;
&#13;
<p>In summary, there are some important points in VaR analysis that need to be &#13;
<span class="keep-together">highlighted</span>:</p>&#13;
&#13;
<ul class="pagebreak-before less_space">&#13;
<li>&#13;
<p>VaR needs an estimation of the probability of loss.</p>&#13;
</li>&#13;
<li>&#13;
<p>VaR concentrates on the potential losses. We are not talking about actual or realized losses; rather, VaR is a kind of loss projection.</p>&#13;
</li>&#13;
<li>&#13;
<p>VaR has three key ingredients:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Standard deviation that defines the level of loss.</p>&#13;
</li>&#13;
<li>&#13;
<p>Fixed time horizon over which risk is assessed.</p>&#13;
</li>&#13;
<li>&#13;
<p>Confidence interval.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>VaR can be measured via three different approaches:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Variance-covariance VaR</p>&#13;
</li>&#13;
<li>&#13;
<p>Historical simulation VaR</p>&#13;
</li>&#13;
<li>&#13;
<p>Monte Carlo VaR</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Variance-Covariance Method" data-type="sect2"><div class="sect2" id="idm45737235233360">&#13;
<h2>Variance-Covariance Method</h2>&#13;
&#13;
<p><a data-primary="variance-covariance method, VaR" data-type="indexterm" id="ix_var_covar_method"/><a data-primary="VaR (Value at Risk)" data-secondary="variance-covariance method" data-type="indexterm" id="ix_var_var-covar"/><a data-primary="market risk" data-secondary="Value at Risk" data-tertiary="variance-covariance method" data-type="indexterm" id="ix_market_risk_VaR_covar"/><a data-primary="parametric modeling" data-type="indexterm" id="idm45737235227600"/>The variance-covariance method is also known as the <em>parametric</em> method, because observations are assumed to be normally distributed.&#13;
<a data-primary="normal distribution of assets assumption, VaR" data-type="indexterm" id="ix_norm_distr_assumption"/>The variance-covariance method is commonplace in that returns are deemed to follow normal distribution. The parametric form assumption makes the application of variance-covariance method easy.</p>&#13;
&#13;
<p><a data-primary="correlation of risk" data-type="indexterm" id="idm45737235224736"/>As in all VaR approaches, we can either work with a single asset or a portfolio. However, working with a portfolio requires careful treatment in the sense that correlation structure and portfolio variance need to be estimated. At this point, correlation comes into the picture, and historical data is used to calculate correlation, mean, and standard deviation. When augmenting this with an ML-based approach, correlation structure will be our main focus.</p>&#13;
&#13;
<p>Suppose that we have a portfolio consisting of a single asset, as shown in <a data-type="xref" href="#VaR_illustration">Figure 5-1</a>. It is shown that the return of this asset is zero and standard deviation is 1, and if the holding period is 1, the corresponding VaR value can be computed from the value of the asset by the corresponding Z-value and standard deviation. Hence, the normality assumption makes things easier, but it is a strong assumption, as there is no guarantee that asset returns are normally distributed; rather, most asset returns do not follow a normal distribution. Moreover, due to the normality assumption, potential risk in tail might not be captured. Therefore the normality assumption comes with a cost. See the following:</p>&#13;
&#13;
<pre class="pagebreak-before less_space" data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">pandas</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pd</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">numpy</code><code> </code><code class="kn">as</code><code> </code><code class="nn">np</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">matplotlib.pyplot</code><code> </code><code class="kn">as</code><code> </code><code class="nn">plt</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">datetime</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">yfinance</code><code> </code><code class="kn">as</code><code> </code><code class="nn">yf</code><code>&#13;
</code><code>        </code><code class="kn">from</code><code> </code><code class="nn">scipy.stats</code><code> </code><code class="kn">import</code><code> </code><code class="n">norm</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">requests</code><code>&#13;
</code><code>        </code><code class="kn">from</code><code> </code><code class="nn">io</code><code> </code><code class="kn">import</code><code> </code><code class="n">StringIO</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">seaborn</code><code> </code><code class="kn">as</code><code> </code><code class="nn">sns</code><code class="p">;</code><code> </code><code class="n">sns</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="kn">import</code><code> </code><code class="nn">warnings</code><code>&#13;
</code><code>        </code><code class="n">warnings</code><code class="o">.</code><code class="n">filterwarnings</code><code class="p">(</code><code class="s1">'</code><code class="s1">ignore</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'</code><code class="s1">figure.figsize</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>&#13;
</code><code>        </code><code class="n">std_dev</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>        </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mf">0.01</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">pdf</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">mean</code><code class="p">,</code><code> </code><code class="n">std_dev</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">pdf</code><code> </code><code class="o">=</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">min_ylim</code><code class="p">,</code><code> </code><code class="n">max_ylim</code><code> </code><code class="o">=</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">text</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">max_ylim</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.9</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">95</code><code class="s1">%</code><code class="s1">:${:.4f}</code><code class="s1">'</code><code>&#13;
</code><code>                 </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">axvline</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">linestyle</code><code class="o">=</code><code class="s1">'</code><code class="s1">dashed</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">linewidth</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">title</code><code class="p">(</code><code class="s1">'</code><code class="s1">Value at Risk Illustration</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>&#13;
</code><code>        </code><code class="n">std_dev</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>        </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">arange</code><code class="p">(</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mf">0.01</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">pdf</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">mean</code><code class="p">,</code><code> </code><code class="n">std_dev</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO1-1" id="co_modeling_market_risk_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">pdf</code><code> </code><code class="o">=</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">min_ylim</code><code class="p">,</code><code> </code><code class="n">max_ylim</code><code> </code><code class="o">=</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">ylim</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO1-2" id="co_modeling_market_risk_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">text</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">max_ylim</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.9</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">95</code><code class="s1">%</code><code class="s1">:${:.4f}</code><code class="s1">'</code><code>&#13;
</code><code>                 </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO1-3" id="co_modeling_market_risk_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">axvline</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">linestyle</code><code class="o">=</code><code class="s1">'</code><code class="s1">dashed</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="n">linewidth</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">title</code><code class="p">(</code><code class="s1">'</code><code class="s1">Value at Risk Illustration</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO1-1" id="callout_modeling_market_risk_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Generating probability density function based on given <code>x</code>, mean, and standard deviation</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO1-2" id="callout_modeling_market_risk_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Limiting the x-axis and y-axis</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO1-3" id="callout_modeling_market_risk_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Specifying the location of <code>x</code> at 5% percentile of the <code>x</code> data</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="VaR_illustration">&#13;
<img alt="VaR_illustration" src="assets/mlfr_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>VaR illustration</h6>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Following Fama (1965), it was realized that stock price returns do not follow normal distribution due to fat tail and asymmetry. This empirical observation implies that stock returns have higher kurtosis than that of a normal distribution.</p>&#13;
&#13;
<p>Having high kurtosis amounts to fat tail, and&#13;
this is able to capture the extreme negative returns.&#13;
As the variance-covariance method is unable to capture fat tail, it cannot, therefore, estimate extreme negative returns that are likely to occur, especially in periods of crisis.</p>&#13;
</div>&#13;
&#13;
<p>Let’s see how we apply the variance-covariance VaR in Python. To illustrate, let’s consider a two-asset portfolio. The formula of the variance-covariance VaR is as follows:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign VaR equals upper V sigma Subscript p Baseline StartRoot t EndRoot upper Z Subscript alpha Baseline dollar-sign">&#13;
  <mrow>&#13;
    <mtext>VaR</mtext>&#13;
    <mo>=</mo>&#13;
    <mi>V</mi>&#13;
    <msub><mi>σ</mi> <mi>p</mi> </msub>&#13;
    <msqrt>&#13;
      <mi>t</mi>&#13;
    </msqrt>&#13;
    <msub><mi>Z</mi> <mi>α</mi> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign sigma Subscript p Baseline equals StartRoot w 1 squared sigma 1 squared plus w 2 squared sigma 2 squared plus rho w 1 w 2 sigma 1 sigma 2 EndRoot dollar-sign">&#13;
  <mrow>&#13;
    <msub><mi>σ</mi> <mi>p</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msqrt>&#13;
      <mrow>&#13;
        <msubsup><mi>w</mi> <mn>1</mn> <mn>2</mn> </msubsup>&#13;
        <msubsup><mi>σ</mi> <mn>1</mn> <mn>2</mn> </msubsup>&#13;
        <mo>+</mo>&#13;
        <msubsup><mi>w</mi> <mn>2</mn> <mn>2</mn> </msubsup>&#13;
        <msubsup><mi>σ</mi> <mn>2</mn> <mn>2</mn> </msubsup>&#13;
        <mo>+</mo>&#13;
        <mi>ρ</mi>&#13;
        <msub><mi>w</mi> <mn>1</mn> </msub>&#13;
        <msub><mi>w</mi> <mn>2</mn> </msub>&#13;
        <msub><mi>σ</mi> <mn>1</mn> </msub>&#13;
        <msub><mi>σ</mi> <mn>2</mn> </msub>&#13;
      </mrow>&#13;
    </msqrt>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign sigma Subscript p Baseline equals StartRoot w 1 sigma 1 plus w 2 plus sigma plus 2 w 1 w 2 sigma-summation Underscript 1 comma 2 Endscripts EndRoot dollar-sign">&#13;
  <mrow>&#13;
    <msub><mi>σ</mi> <mi>p</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msqrt>&#13;
      <mrow>&#13;
        <msub><mi>w</mi> <mn>1</mn> </msub>&#13;
        <msub><mi>σ</mi> <mn>1</mn> </msub>&#13;
        <mo>+</mo>&#13;
        <msub><mi>w</mi> <mn>2</mn> </msub>&#13;
        <mo>+</mo>&#13;
        <mi>σ</mi>&#13;
        <mo>+</mo>&#13;
        <mn>2</mn>&#13;
        <msub><mi>w</mi> <mn>1</mn> </msub>&#13;
        <msub><mi>w</mi> <mn>2</mn> </msub>&#13;
        <msub><mo>∑</mo> <mrow><mn>1</mn><mo>,</mo><mn>2</mn></mrow> </msub>&#13;
      </mrow>&#13;
    </msqrt>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before less_space">To apply this in code, we start with the following:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">getDailyData</code><code class="p">(</code><code class="n">symbol</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="n">parameters</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="s1">'</code><code class="s1">function</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">TIME_SERIES_DAILY_ADJUSTED</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="s1">'</code><code class="s1">symbol</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">symbol</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="s1">'</code><code class="s1">outputsize</code><code class="s1">'</code><code class="p">:</code><code class="s1">'</code><code class="s1">full</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="s1">'</code><code class="s1">datatype</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">csv</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                               </code><code class="s1">'</code><code class="s1">apikey</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">insert your api key here</code><code class="s1">'</code><code class="p">}</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO2-1" id="co_modeling_market_risk_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code>                </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">https://www.alphavantage.co/query</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                        </code><code class="n">params</code><code class="o">=</code><code class="n">parameters</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO2-2" id="co_modeling_market_risk_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code>                </code><code class="n">csvText</code><code> </code><code class="o">=</code><code> </code><code class="n">StringIO</code><code class="p">(</code><code class="n">response</code><code class="o">.</code><code class="n">text</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO2-3" id="co_modeling_market_risk_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">csvText</code><code class="p">,</code><code> </code><code class="n">index_col</code><code class="o">=</code><code class="s1">'</code><code class="s1">timestamp</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>                </code><code class="k">return</code><code> </code><code class="n">data</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s2">"</code><code class="s2">IBM</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">MSFT</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">INTC</code><code class="s2">"</code><code class="p">]</code><code>&#13;
</code><code>        </code><code class="n">stock3</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>        </code><code class="k">for</code><code> </code><code class="n">symbol</code><code> </code><code class="ow">in</code><code> </code><code class="n">symbols</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="n">stock3</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">getDailyData</code><code class="p">(</code><code class="n">symbol</code><code class="p">)</code><code class="p">[</code><code class="p">:</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="p">[</code><code class="s1">'</code><code class="s1">close</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>                          </code><code class="p">[</code><code class="s1">'</code><code class="s1">2020-01-01</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2020-12-31</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO2-4" id="co_modeling_market_risk_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="n">stocks</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">stock3</code><code class="p">)</code><code class="o">.</code><code class="n">T</code><code>&#13;
</code><code>        </code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="n">symbols</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stocks</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code>                </code><code class="n">IBM</code><code>    </code><code class="n">MSFT</code><code>   </code><code class="n">INTC</code><code>&#13;
</code><code>        </code><code class="n">timestamp</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">02</code><code>  </code><code class="mf">135.42</code><code>  </code><code class="mf">160.62</code><code>  </code><code class="mf">60.84</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">03</code><code>  </code><code class="mf">134.34</code><code>  </code><code class="mf">158.62</code><code>  </code><code class="mf">60.10</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">06</code><code>  </code><code class="mf">134.10</code><code>  </code><code class="mf">159.03</code><code>  </code><code class="mf">59.93</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">07</code><code>  </code><code class="mf">134.19</code><code>  </code><code class="mf">157.58</code><code>  </code><code class="mf">58.93</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">08</code><code>  </code><code class="mf">135.31</code><code>  </code><code class="mf">160.09</code><code>  </code><code class="mf">58.97</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO2-1" id="callout_modeling_market_risk_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Identifying the parameters to be used in extracting data from Alpha Vantage</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO2-2" id="callout_modeling_market_risk_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Making a request to the Alpha Vantage website</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO2-3" id="callout_modeling_market_risk_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Opening the response file, which is in a text format</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO2-4" id="callout_modeling_market_risk_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Reversing the data that covers the period of 2019-01 to 2019-12 and appending the daily stock prices of IBM, MSFT, and INTC</p></dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="Alpha Vantage API" data-type="indexterm" id="idm45737233361808"/>Alpha Vantage is a data-providing company that partners with major exchanges and institutions. Using Alpha Vantage’s API, it is possible to access stock prices with various time intervals (intraday, daily, weekly, and so on), stock fundamentals, and foreign exchange information. For more information, please see <a href="https://oreil.ly/ByZYD">Alpha Vantage’s website</a>.</p>&#13;
</div>&#13;
&#13;
<p>We then perform our calculations:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stocks_returns</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">stocks</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-1" id="co_modeling_market_risk_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">stocks_returns</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code>                  </code><code class="n">IBM</code><code>      </code><code class="n">MSFT</code><code>      </code><code class="n">INTC</code><code>&#13;
</code><code>        </code><code class="n">timestamp</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">03</code><code> </code><code class="o">-</code><code class="mf">0.008007</code><code> </code><code class="o">-</code><code class="mf">0.012530</code><code> </code><code class="o">-</code><code class="mf">0.012238</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">06</code><code> </code><code class="o">-</code><code class="mf">0.001788</code><code>  </code><code class="mf">0.002581</code><code> </code><code class="o">-</code><code class="mf">0.002833</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">07</code><code>  </code><code class="mf">0.000671</code><code> </code><code class="o">-</code><code class="mf">0.009160</code><code> </code><code class="o">-</code><code class="mf">0.016827</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">08</code><code>  </code><code class="mf">0.008312</code><code>  </code><code class="mf">0.015803</code><code>  </code><code class="mf">0.000679</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">09</code><code>  </code><code class="mf">0.010513</code><code>  </code><code class="mf">0.012416</code><code>  </code><code class="mf">0.005580</code><code>&#13;
</code><code>        </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>              </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>       </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>       </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>  </code><code class="mf">0.006356</code><code>  </code><code class="mf">0.007797</code><code>  </code><code class="mf">0.010679</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">28</code><code>  </code><code class="mf">0.001042</code><code>  </code><code class="mf">0.009873</code><code>  </code><code class="mf">0.000000</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">29</code><code> </code><code class="o">-</code><code class="mf">0.008205</code><code> </code><code class="o">-</code><code class="mf">0.003607</code><code>  </code><code class="mf">0.048112</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>  </code><code class="mf">0.004352</code><code> </code><code class="o">-</code><code class="mf">0.011081</code><code> </code><code class="o">-</code><code class="mf">0.013043</code><code>&#13;
</code><code>        </code><code class="mi">2020</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>  </code><code class="mf">0.012309</code><code>  </code><code class="mf">0.003333</code><code>  </code><code class="mf">0.021711</code><code>&#13;
</code><code>&#13;
</code><code>        </code><code class="p">[</code><code class="mi">252</code><code> </code><code class="n">rows</code><code> </code><code class="n">x</code><code> </code><code class="mi">3</code><code> </code><code class="n">columns</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stocks_returns_mean</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="n">weights</code><code>  </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-2" id="co_modeling_market_risk_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">weights</code><code> </code><code class="o">/</code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">weights</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-3" id="co_modeling_market_risk_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">cov_var</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">cov</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-4" id="co_modeling_market_risk_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="n">port_std</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">weights</code><code class="o">.</code><code class="n">T</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">cov_var</code><code class="p">)</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">weights</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-5" id="co_modeling_market_risk_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">=</code><code> </code><code class="mf">1e6</code><code>&#13;
</code><code>        </code><code class="n">conf_level</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.95</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">VaR_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">alpha</code><code> </code><code class="o">=</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">ppf</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">,</code><code> </code><code class="n">stocks_returns_mean</code><code class="p">,</code><code> </code><code class="n">port_std</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-6" id="co_modeling_market_risk_CO3-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">VaR_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">-</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                              </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">alpha</code><code class="p">)</code><code class="p">)</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO3-7" id="co_modeling_market_risk_CO3-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Parametric VaR result for {} is {} </code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">VaR_param</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">VaR_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">-</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">alpha</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">25</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">VaR_param</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR_param</code><code> </code><code class="o">=</code><code> </code><code class="n">VaR_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">VaR_param</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">42606.16125893139</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">41024.50194348814</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">43109.25240851776</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">42606.16125893</code><code class="p">,</code><code> </code><code class="mf">41024.50194349</code><code class="p">,</code><code> </code><code class="mf">43109.25240852</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-1" id="callout_modeling_market_risk_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculating logarithmic return</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-2" id="callout_modeling_market_risk_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Drawing random numbers for weights</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-3" id="callout_modeling_market_risk_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generating weights</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-4" id="callout_modeling_market_risk_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculating covariance matrix</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-5" id="callout_modeling_market_risk_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Finding the portfolio standard deviation</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-6" id="callout_modeling_market_risk_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Computing the Z-score for a specific value using the percent point function (<code>ppf</code>)</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO3-7" id="callout_modeling_market_risk_CO3-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Estimating the variance-covariance VaR model</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="time period, VaR" data-type="indexterm" id="idm45737234288896"/>VaR changes depending on the time horizon in the sense that holding assets for a longer period makes an investor more susceptible to risk. As shown in <a data-type="xref" href="#VaR_horizon">Figure 5-2</a>, VaR increases in relation to holding time by the amount of <math alttext="StartRoot t EndRoot">&#13;
  <msqrt>&#13;
    <mi>t</mi>&#13;
  </msqrt>&#13;
</math>. Additionally, the holding period is the longest period for portfolio liquidation. Taking into account the reporting purpose, a 30-day period may be a more suitable one for an investor. Therefore, we’ll illustrate that period in the following code, in which we generate <a data-type="xref" href="#VaR_horizon">Figure 5-2</a>.</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">var_horizon</code> <code class="o">=</code> <code class="p">[]</code>&#13;
         <code class="n">time_horizon</code> <code class="o">=</code> <code class="mi">30</code>&#13;
         <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">)):</code>&#13;
             <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">time_horizon</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>&#13;
                 <code class="n">var_horizon</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">VaR_param</code><code class="p">[</code><code class="n">j</code><code class="p">]</code> <code class="o">*</code> <code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">i</code><code class="p">))</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">var_horizon</code><code class="p">[:</code><code class="n">time_horizon</code><code class="p">],</code> <code class="s2">"o"</code><code class="p">,</code>&#13;
                  <code class="n">c</code><code class="o">=</code><code class="s1">'blue'</code><code class="p">,</code> <code class="n">marker</code><code class="o">=</code><code class="s1">'*'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'IBM'</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">var_horizon</code><code class="p">[</code><code class="n">time_horizon</code><code class="p">:</code><code class="n">time_horizon</code> <code class="o">+</code> <code class="mi">30</code><code class="p">],</code> <code class="s2">"o"</code><code class="p">,</code>&#13;
                  <code class="n">c</code><code class="o">=</code><code class="s1">'green'</code><code class="p">,</code> <code class="n">marker</code><code class="o">=</code><code class="s1">'o'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'MSFT'</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">var_horizon</code><code class="p">[</code><code class="n">time_horizon</code> <code class="o">+</code> <code class="mi">30</code><code class="p">:</code><code class="n">time_horizon</code> <code class="o">+</code> <code class="mi">60</code><code class="p">],</code> <code class="s2">"o"</code><code class="p">,</code>&#13;
                  <code class="n">c</code><code class="o">=</code><code class="s1">'red'</code><code class="p">,</code> <code class="n">marker</code><code class="o">=</code><code class="s1">'v'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'INTC'</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s2">"Days"</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s2">"USD"</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">title</code><code class="p">(</code><code class="s2">"VaR over 30-day period"</code><code class="p">)</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">()</code>&#13;
         <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>&#13;
&#13;
<p>The pros and cons of the variance-covariance method are as follows:</p>&#13;
<dl>&#13;
<dt>Pros</dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Easy to calculate</p>&#13;
</li>&#13;
<li>&#13;
<p>Does not require a large number of samples</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Cons</dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Observations are normally distributed</p>&#13;
</li>&#13;
<li>&#13;
<p>Does not work well with nonlinear structures</p>&#13;
</li>&#13;
<li>&#13;
<p>Requires the computation of the covariance matrix</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="VaR_horizon">&#13;
<img alt="VaR_horizon" src="assets/mlfr_0502.png"/>&#13;
<h6><span class="label">Figure 5-2. </span>VaR over different horizons</h6>&#13;
</div></figure>&#13;
&#13;
<p>So, even though assuming normality sounds appealing, it may not be the best way to estimate VaR, especially in the case where the asset returns do not have a normal distribution. Luckily, there is another method that does not have a normality assumption, namely the historical simulation VaR model.<a data-primary="" data-startref="ix_market_risk_VaR_covar" data-type="indexterm" id="idm45737234493536"/><a data-primary="" data-startref="ix_norm_distr_assumption" data-type="indexterm" id="idm45737234492496"/><a data-primary="" data-startref="ix_var_covar_method" data-type="indexterm" id="idm45737234491536"/><a data-primary="" data-startref="ix_var_var-covar" data-type="indexterm" id="idm45737234490592"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Historical Simulation Method" data-type="sect2"><div class="sect2" id="idm45737235232384">&#13;
<h2>The Historical Simulation Method</h2>&#13;
&#13;
<p><a data-primary="market risk" data-secondary="Value at Risk" data-tertiary="historical simulation method" data-type="indexterm" id="ix_market_risk_var_historic_sim"/><a data-primary="VaR (Value at Risk)" data-secondary="historical simulation method" data-type="indexterm" id="ix_var_historic_sim"/><a data-primary="historical simulation method" data-type="indexterm" id="ix_historic_sim_method"/>Having strong assumptions, such as a normal distribution, might be the cause of inaccurate estimations. A solution to this issue is the historical simulation VaR. This is an empirical method: instead of using a parametric approach, we find the percentile, which is the Z-table equivalent of variance-covariance method. Suppose that the confidence interval is 95%; 5% will be used in lieu of the Z-table values, and all we need to do is to multiply this percentile by the initial investment.</p>&#13;
&#13;
<p>The following are the steps taken in the historical simulation VaR:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Obtain the asset returns of the portfolio (or individual asset)</p>&#13;
</li>&#13;
<li>&#13;
<p>Find the corresponding return percentile based on confidence interval</p>&#13;
</li>&#13;
<li>&#13;
<p>Multiply this percentile by initial investment</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>To do this in code, we can define the following function:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">VaR_historical</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO4-1" id="co_modeling_market_risk_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">Hist_percentile95</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code>&#13;
</code><code>                             </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">Hist_percentile95</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                                        </code><code class="mi">5</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Based on historical values 95</code><code class="si">% o</code><code class="s2">f {}</code><code class="s2">'</code><code class="s2">s return is {:.4f}</code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">Hist_percentile95</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="n">VaR_historical</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">-</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                                   </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">Hist_percentile95</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Historical VaR result for {} is {:.2f} </code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">VaR_historical</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">35</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR_historical</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code class="n">conf_level</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO4-2" id="co_modeling_market_risk_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">historical</code><code> </code><code class="n">values</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">IBM</code><code class="s1">'</code><code class="s1">s return is -0.0371</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">37081.53</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">historical</code><code> </code><code class="n">values</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">MSFT</code><code class="s1">'</code><code class="s1">s return is -0.0426</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">42583.68</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">historical</code><code> </code><code class="n">values</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">INTC</code><code class="s1">'</code><code class="s1">s return is -0.0425</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">42485.39</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO4-1" id="callout_modeling_market_risk_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculating the 95% percentile of stock returns</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO4-2" id="callout_modeling_market_risk_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Estimating the historical simulation VaR</p></dd>&#13;
</dl>&#13;
&#13;
<p>The historical simulation VaR method implicitly assumes that historical price changes have a similar pattern, i.e., that there is no structural break. The pros and cons of this method are as follows:</p>&#13;
<dl>&#13;
<dt>Pros</dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>No distributional assumption</p>&#13;
</li>&#13;
<li>&#13;
<p>Works well with nonlinear structures</p>&#13;
</li>&#13;
<li>&#13;
<p>Easy to calculate</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Cons</dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Requires a large sample</p>&#13;
</li>&#13;
<li>&#13;
<p>Needs high computing power<a data-primary="" data-startref="ix_historic_sim_method" data-type="indexterm" id="idm45737234854336"/><a data-primary="" data-startref="ix_market_risk_var_historic_sim" data-type="indexterm" id="idm45737234853360"/><a data-primary="" data-startref="ix_var_historic_sim" data-type="indexterm" id="idm45737234852352"/></p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Monte Carlo Simulation VaR" data-type="sect2"><div class="sect2" id="idm45737234785648">&#13;
<h2>The Monte Carlo Simulation VaR</h2>&#13;
&#13;
<p><a data-primary="Monte Carlo simulation method, VaR" data-type="indexterm" id="ix_monte_carlo_sim"/><a data-primary="VaR (Value at Risk)" data-secondary="Monte Carlo simulation method" data-type="indexterm" id="ix_var_monte_carlo_sim"/><a data-primary="market risk" data-secondary="Value at Risk" data-tertiary="Monte Carlo simulation method" data-type="indexterm" id="ix_market_risk_VaR_MC"/>Before delving into the Monte Carlo simulation VaR estimation, it would be good to briefly introduce the Monte Carlo simulation. Monte Carlo is a computerized mathematical method used to make an estimation in cases where there is no closed-form solution, so it is a highly efficient tool for numerical approximation. Monte Carlo relies on repeated random samples from a given distribution.</p>&#13;
&#13;
<p>The logic behind Monte Carlo is well defined by Glasserman (2003, p. 11):</p>&#13;
<blockquote data-type="epigram">&#13;
<p>Monte Carlo methods are based on the analogy between probability and volume. The mathematics of measure formalizes the intuitive notion of probability, associating an event with a set of outcomes and defining the probability of the event to be its volume or measure relative to that of a universe of possible outcomes. Monte Carlo uses this identity in reverse, calculating the volume of a set by interpreting the volume as a probability.</p>&#13;
</blockquote>&#13;
&#13;
<p>From the application standpoint, Monte Carlo is very similar to the historical simulation VaR, but it does not use historical observations. Rather, it generates random samples from a given distribution. Monte Carlo helps decision makers by providing links between possible outcomes and probabilities, which makes it an efficient and applicable tool in finance.</p>&#13;
&#13;
<p>Mathematical Monte Carlo can be defined in the following way:</p>&#13;
&#13;
<p>Let <math alttext="upper X 1 comma upper X 2 comma ellipsis comma upper X Subscript n Baseline">&#13;
  <mrow>&#13;
    <msub><mi>X</mi> <mn>1</mn> </msub>&#13;
    <mo>,</mo>&#13;
    <msub><mi>X</mi> <mn>2</mn> </msub>&#13;
    <mo>,</mo>&#13;
    <mo>⋯</mo>&#13;
    <mo>,</mo>&#13;
    <msub><mi>X</mi> <mi>n</mi> </msub>&#13;
  </mrow>&#13;
</math> be independent and identically distributed random variables, and f(x) be a real-valued function. The law of large numbers states that:</p>&#13;
<div data-type="equation">&#13;
<math alttext="sans-serif upper E left-parenthesis f left-parenthesis upper X right-parenthesis right-parenthesis almost-equals StartFraction 1 Over upper N EndFraction sigma-summation Underscript i Overscript upper N Endscripts f left-parenthesis upper X Subscript i Baseline right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <mi>𝖤</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mrow>&#13;
        <mo>(</mo>&#13;
        <mi>X</mi>&#13;
        <mo>)</mo>&#13;
      </mrow>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>≈</mo>&#13;
    <mfrac><mn>1</mn> <mi>N</mi></mfrac>&#13;
    <munderover><mo>∑</mo> <mi>i</mi> <mi>N</mi> </munderover>&#13;
    <mi>f</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>X</mi> <mi>i</mi> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>So in a nutshell, a Monte Carlo simulation is doing nothing but generating random samples and calculating their mean. Computationally, it follows these steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Define the domain</p>&#13;
</li>&#13;
<li>&#13;
<p>Generate random numbers</p>&#13;
</li>&#13;
<li>&#13;
<p>Iterate and aggregate the result</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>The determination of mathematical <math alttext="pi">&#13;
  <mi>π</mi>&#13;
</math> is a simple but illustrative example of Monte Carlo application.</p>&#13;
&#13;
<p>Suppose we have a circle with radius <em>r</em> = 1 and an area of 4. The area of a circle is <math alttext="pi">&#13;
  <mi>π</mi>&#13;
</math>, and area of a square in which we try to fit the circle is 4. The ratio turns out to be:</p>&#13;
<div data-type="equation" id="eq_1">&#13;
<math alttext="dollar-sign StartFraction pi Over 4 EndFraction dollar-sign">&#13;
  <mfrac><mi>π</mi> <mn>4</mn></mfrac>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>To leave <math alttext="pi">&#13;
  <mi>π</mi>&#13;
</math> alone, the proportion between a circle and area can be defined as:</p>&#13;
<div data-type="equation" id="eq_2">&#13;
<math alttext="dollar-sign StartFraction upper C i r c u m f e r e n c e Subscript c i r c l e Baseline Over upper A r e a Subscript s q u a r e Baseline EndFraction equals StartFraction m Over n EndFraction dollar-sign">&#13;
  <mrow>&#13;
    <mfrac><mrow><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>u</mi><mi>m</mi><mi>f</mi><mi>e</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>c</mi><msub><mi>e</mi> <mrow><mi>c</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow> </msub></mrow> <mrow><mi>A</mi><mi>r</mi><mi>e</mi><msub><mi>a</mi> <mrow><mi>s</mi><mi>q</mi><mi>u</mi><mi>a</mi><mi>r</mi><mi>e</mi></mrow> </msub></mrow></mfrac>&#13;
    <mo>=</mo>&#13;
    <mfrac><mi>m</mi> <mi>n</mi></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before less_space">Once we equalize these equations, it turns out that:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign pi equals 4 x StartFraction m Over n EndFraction dollar-sign">&#13;
  <mrow>&#13;
    <mi>π</mi>&#13;
    <mo>=</mo>&#13;
    <mn>4</mn>&#13;
    <mi>x</mi>&#13;
    <mfrac><mi>m</mi> <mi>n</mi></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>If we go step by step, the first is to define domain, which is [-1, 1]. So the numbers inside the circle satisfy <math alttext="x squared plus y squared less-than-or-equal-to 1">&#13;
  <mrow>&#13;
    <msup><mi>x</mi> <mn>2</mn> </msup>&#13;
    <mo>+</mo>&#13;
    <msup><mi>y</mi> <mn>2</mn> </msup>&#13;
    <mo>≤</mo>&#13;
    <mn>1</mn>&#13;
  </mrow>&#13;
</math>.</p>&#13;
&#13;
<p>The second step is to generate random numbers to meet this given condition. That is to say, we need to have uniformly distributed random samples, which is a rather easy task in Python. For the sake of practice, I will generate 100 uniformly distributed random numbers using the NumPy library:<a data-primary="" data-startref="ix_market_risk_VaR" data-type="indexterm" id="idm45737232609008"/><a data-primary="" data-startref="ix_valueatrisk_VaR" data-type="indexterm" id="idm45737232662608"/><a data-primary="" data-startref="ix_market_risk_VaR_MC" data-type="indexterm" id="idm45737232661664"/><a data-primary="" data-startref="ix_monte_carlo_sim" data-type="indexterm" id="idm45737232660720"/><a data-primary="" data-startref="ix_var_monte_carlo_sim" data-type="indexterm" id="idm45737232505728"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">uniform</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO5-1" id="co_modeling_market_risk_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">uniform</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sample</code><code> </code><code class="o">=</code><code> </code><code class="mi">100</code><code>&#13;
</code><code>         </code><code class="k">def</code><code> </code><code class="nf">pi_calc</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">point_inside_circle</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="k">if</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code> </code><code class="o">+</code><code> </code><code class="n">y</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">:</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO5-2" id="co_modeling_market_risk_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>                     </code><code class="n">point_inside_circle</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">pi value is {}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="mi">4</code><code> </code><code class="o">*</code><code> </code><code class="n">point_inside_circle</code><code class="o">/</code><code class="n">sample</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pi_calc</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">pi</code><code> </code><code class="n">value</code><code> </code><code class="ow">is</code><code> </code><code class="mf">3.2</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">uniform</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1000000</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">y</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">uniform</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1000000</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sample</code><code> </code><code class="o">=</code><code> </code><code class="mi">1000000</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="k">def</code><code> </code><code class="nf">pi_calc</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">point_inside_circle</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="k">if</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code> </code><code class="o">+</code><code> </code><code class="n">y</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">1</code><code class="p">:</code><code>&#13;
</code><code>                     </code><code class="n">point_inside_circle</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">pi value is {:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="mi">4</code><code> </code><code class="o">*</code><code> </code><code class="n">point_inside_circle</code><code class="o">/</code><code class="n">sample</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pi_calc</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">pi</code><code> </code><code class="n">value</code><code> </code><code class="ow">is</code><code> </code><code class="mf">3.14</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sim_data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">[</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">num_reps</code><code> </code><code class="o">=</code><code> </code><code class="mi">1000</code><code>&#13;
</code><code>         </code><code class="n">n</code><code> </code><code class="o">=</code><code> </code><code class="mi">100</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">mean</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">randn</code><code class="p">(</code><code class="n">n</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">randn</code><code class="p">(</code><code class="n">n</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">temp</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">normal</code><code class="p">(</code><code class="n">mean</code><code class="p">,</code><code> </code><code class="n">std</code><code class="p">,</code><code> </code><code class="n">num_reps</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">sim_data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">concat</code><code class="p">(</code><code class="p">[</code><code class="n">sim_data</code><code class="p">,</code><code> </code><code class="n">temp</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">sim_data</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">Simulation 1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Simulation 2</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Simulation 3</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sim_data</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code>      </code><code class="n">Simulation</code><code> </code><code class="mi">1</code><code>  </code><code class="n">Simulation</code><code> </code><code class="mi">2</code><code>  </code><code class="n">Simulation</code><code> </code><code class="mi">3</code><code>&#13;
</code><code>         </code><code class="mi">0</code><code>        </code><code class="mf">1.587297</code><code>     </code><code class="o">-</code><code class="mf">0.256668</code><code>      </code><code class="mf">1.137718</code><code>&#13;
</code><code>         </code><code class="mi">1</code><code>        </code><code class="mf">0.053628</code><code>     </code><code class="o">-</code><code class="mf">0.177641</code><code>     </code><code class="o">-</code><code class="mf">1.642747</code><code>&#13;
</code><code>         </code><code class="mi">2</code><code>       </code><code class="o">-</code><code class="mf">1.636260</code><code>     </code><code class="o">-</code><code class="mf">0.626633</code><code>      </code><code class="mf">0.393466</code><code>&#13;
</code><code>         </code><code class="mi">3</code><code>        </code><code class="mf">1.088207</code><code>      </code><code class="mf">0.847237</code><code>      </code><code class="mf">0.453473</code><code>&#13;
</code><code>         </code><code class="mi">4</code><code>       </code><code class="o">-</code><code class="mf">0.479977</code><code>     </code><code class="o">-</code><code class="mf">0.114377</code><code>     </code><code class="o">-</code><code class="mf">2.108050</code><code>&#13;
</code><code>         </code><code class="o">.</code><code class="o">.</code><code>            </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>           </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>           </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>         </code><code class="mi">995</code><code>      </code><code class="mf">1.615190</code><code>      </code><code class="mf">0.940931</code><code>      </code><code class="mf">0.172129</code><code>&#13;
</code><code>         </code><code class="mi">996</code><code>     </code><code class="o">-</code><code class="mf">0.015111</code><code>     </code><code class="o">-</code><code class="mf">1.149821</code><code>     </code><code class="o">-</code><code class="mf">0.279746</code><code>&#13;
</code><code>         </code><code class="mi">997</code><code>     </code><code class="o">-</code><code class="mf">0.806576</code><code>     </code><code class="o">-</code><code class="mf">0.141932</code><code>     </code><code class="o">-</code><code class="mf">1.246538</code><code>&#13;
</code><code>         </code><code class="mi">998</code><code>      </code><code class="mf">1.609327</code><code>      </code><code class="mf">0.582967</code><code>     </code><code class="o">-</code><code class="mf">1.879237</code><code>&#13;
</code><code>         </code><code class="mi">999</code><code>     </code><code class="o">-</code><code class="mf">0.943749</code><code>     </code><code class="o">-</code><code class="mf">0.286847</code><code>      </code><code class="mf">0.777052</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="p">[</code><code class="mi">1000</code><code> </code><code class="n">rows</code><code> </code><code class="n">x</code><code> </code><code class="mi">3</code><code> </code><code class="n">columns</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">MC_VaR</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">MC_percentile95</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">sim_data</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">sim_data</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">MC_percentile95</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">sim_data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO5-3" id="co_modeling_market_risk_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Based on simulation 95</code><code class="si">% o</code><code class="s2">f {}</code><code class="s2">'</code><code class="s2">s return is {:.4f}</code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">MC_percentile95</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="n">VaR_MC</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">-</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                           </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">MC_percentile95</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO5-4" id="co_modeling_market_risk_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Simulation VaR result for {} is {:.2f} </code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">VaR_MC</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">35</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">MC_VaR</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">simulation</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">1</code><code class="s1">'</code><code class="s1">s return is -1.7880</code><code>&#13;
</code><code>         </code><code class="n">Simulation</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">1</code><code> </code><code class="ow">is</code><code> </code><code class="mf">1787990.69</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">simulation</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">2</code><code class="s1">'</code><code class="s1">s return is -1.6290</code><code>&#13;
</code><code>         </code><code class="n">Simulation</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">2</code><code> </code><code class="ow">is</code><code> </code><code class="mf">1628976.68</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>         </code><code class="n">Based</code><code> </code><code class="n">on</code><code> </code><code class="n">simulation</code><code> </code><code class="mi">95</code><code class="o">%</code><code> </code><code class="n">of</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">3</code><code class="s1">'</code><code class="s1">s return is -1.5156</code><code>&#13;
</code><code>         </code><code class="n">Simulation</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">Simulation</code><code> </code><code class="mi">3</code><code> </code><code class="ow">is</code><code> </code><code class="mf">1515623.93</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO5-1" id="callout_modeling_market_risk_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Generating random numbers from uniform distribution</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO5-2" id="callout_modeling_market_risk_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Checking if points are inside the circle, which has a radius of 1</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO5-3" id="callout_modeling_market_risk_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculating 95% of every stock return and appending the result in the list named  <code>MC_percentile95</code></p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO5-4" id="callout_modeling_market_risk_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Estimating Monte Carlo VaR</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Denoising" data-type="sect1"><div class="sect1" id="idm45737235256976">&#13;
<h1>Denoising</h1>&#13;
&#13;
<p><a data-primary="market risk" data-secondary="denoising" data-type="indexterm" id="ix_market_risk_denois"/><a data-primary="denoising" data-secondary="market risk, modeling" data-type="indexterm" id="ix_denois_market_risk"/>Volatility is everywhere, but it is a formidable task to find out what kind of volatility is most valuable. <a data-primary="noise and signal in the market" data-type="indexterm" id="idm45737232471264"/>In general, there are two types of information in the market: <em>noise</em> and <em>signal</em>. The former generates nothing but random information, but the latter equips us with valuable information by which an investor can make money. To illustrate, consider that there are two main players in the market: one using noisy information called a noise trader, and an informed trader who exploits signal or insider information. The noise trader’s trading motivation is driven by random behavior. So information flow in the market is considered a buying signal for some noise traders and a selling signal for others.</p>&#13;
&#13;
<p>However, informed traders are considered to be rational ones in the sense that they are able to assess a signal because they know that it is private &#13;
<span class="keep-together">information</span>.</p>&#13;
&#13;
<p>Consequently, continuous flow of information should be treated with caution. In short, information coming from noise traders can be considered as noise, and information coming from insiders can be taken as signal, and this is the sort of information that matters. Investors who cannot distinguish between noise and signal can fail to gain profit and/or assess risk properly.</p>&#13;
&#13;
<p>Now the problem turns out to be differentiating the flow of information in the financial markets. How can we differentiate noise from signal? And how can we use this information?</p>&#13;
&#13;
<p><a data-primary="Marchenko–Pastur theorem" data-type="indexterm" id="ix_march_pastur"/>It is now worthwhile to discuss the Marchenko–Pastur theorem, which helps have homogenous <a data-primary="covariance matrix, denoising" data-type="indexterm" id="ix_covar_matrix_denois"/>covariance matrices. The Marchenko–Pastur theorem allows us to extract signal from noise using eigenvalues of covariance matrices.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="eigenvalue" data-type="indexterm" id="idm45737228201424"/><a data-primary="eigenvector" data-type="indexterm" id="idm45737228200560"/>Let <math alttext="upper A element-of double-struck upper R Superscript n x n">&#13;
  <mrow>&#13;
    <mi>A</mi>&#13;
    <mo>∈</mo>&#13;
    <msup><mi>ℝ</mi> <mrow><mi>n</mi><mi>x</mi><mi>n</mi></mrow> </msup>&#13;
  </mrow>&#13;
</math> be a square matrix. Then,  <math alttext="lamda element-of double-struck upper R">&#13;
  <mrow>&#13;
    <mi>λ</mi>&#13;
    <mo>∈</mo>&#13;
    <mi>ℝ</mi>&#13;
  </mrow>&#13;
</math> is an eigenvalue of <em>A</em> and <math alttext="x element-of double-struck upper R Superscript n">&#13;
  <mrow>&#13;
    <mi>x</mi>&#13;
    <mo>∈</mo>&#13;
    <msup><mi>ℝ</mi> <mi>n</mi> </msup>&#13;
  </mrow>&#13;
</math> is the corresponding eigenvector of <em>A</em> if</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper A x equals lamda x dollar-sign">&#13;
  <mrow>&#13;
    <mi>A</mi>&#13;
    <mi>x</mi>&#13;
    <mo>=</mo>&#13;
    <mi>λ</mi>&#13;
    <mi>x</mi>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <math alttext="x element-of double-struck upper R Superscript n Baseline not-equals 0">&#13;
  <mrow>&#13;
    <mi>x</mi>&#13;
    <mo>∈</mo>&#13;
    <msup><mi>ℝ</mi> <mi>n</mi> </msup>&#13;
    <mo>≠</mo>&#13;
    <mn>0</mn>&#13;
  </mrow>&#13;
</math>.</p>&#13;
</div>&#13;
&#13;
<p><em>Eigenvalue</em> and <em>eigenvector</em> have special meanings in a financial context. Eigenvectors represent the variance in covariance matrix, while an eigenvalue shows the magnitude of an eigenvector. Specifically, the largest eigenvector corresponds to largest variance, and the magnitude of this is equal to the corresponding eigenvalue. Due to noise in the data, some eigenvalues can be thought of as random, and it makes sense to detect and filter out these eigenvalues to retain only signals.</p>&#13;
&#13;
<p>To differentiate noise and signal, we fit the Marchenko–Pastur theorem&#13;
probability density function (PDF) to the noisy covariance. <a data-primary="PDF (probability density function)" data-type="indexterm" id="idm45737227801872"/>The PDF the of Marchenko–Pastur theorem takes the following form (Prado 2020):</p>&#13;
<div data-type="equation">&#13;
<math mode="display">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>λ</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <mfenced close="" open="{" separators="">&#13;
      <mtable>&#13;
        <mtr>&#13;
          <mtd columnalign="left">&#13;
            <mrow>&#13;
              <mfrac><mi>T</mi> <mi>N</mi></mfrac>&#13;
              <msqrt>&#13;
                <mrow>&#13;
                  <mrow>&#13;
                    <mo>(</mo>&#13;
                    <msub><mi>λ</mi> <mi>t</mi> </msub>&#13;
                    <mo>-</mo>&#13;
                    <mi>λ</mi>&#13;
                    <mo>)</mo>&#13;
                  </mrow>&#13;
                  <mrow>&#13;
                    <mo>(</mo>&#13;
                    <mi>λ</mi>&#13;
                    <mo>-</mo>&#13;
                    <msub><mi>λ</mi> <mo>-</mo> </msub>&#13;
                    <mo>)</mo>&#13;
                  </mrow>&#13;
                </mrow>&#13;
              </msqrt>&#13;
            </mrow>&#13;
          </mtd>&#13;
          <mtd columnalign="right">&#13;
            <mrow>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>if</mtext>&#13;
              <mspace width="4.pt"/>&#13;
              <mi>λ</mi>&#13;
              <mo>∈</mo>&#13;
              <mo>[</mo>&#13;
              <mi>λ</mi>&#13;
              <mo>-</mo>&#13;
              <msub><mi>λ</mi> <mo>-</mo> </msub>&#13;
              <mo>]</mo>&#13;
            </mrow>&#13;
          </mtd>&#13;
        </mtr>&#13;
        <mtr>&#13;
          <mtd columnalign="left">&#13;
            <mrow>&#13;
              <mn>0</mn>&#13;
              <mo>,</mo>&#13;
            </mrow>&#13;
          </mtd>&#13;
          <mtd columnalign="right">&#13;
            <mrow>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>if</mtext>&#13;
              <mspace width="4.pt"/>&#13;
              <mi>λ</mi>&#13;
              <mo>∉</mo>&#13;
              <mo>[</mo>&#13;
              <mi>λ</mi>&#13;
              <mo>-</mo>&#13;
              <msub><mi>λ</mi> <mo>-</mo> </msub>&#13;
              <mo>]</mo>&#13;
            </mrow>&#13;
          </mtd>&#13;
        </mtr>&#13;
      </mtable>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math></div>&#13;
&#13;
<p>where <math alttext="lamda Subscript plus Baseline and lamda Subscript minus Baseline">&#13;
  <mrow>&#13;
    <msub><mi>λ</mi> <mo>+</mo> </msub>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>and</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <msub><mi>λ</mi> <mo>-</mo> </msub>&#13;
  </mrow>&#13;
</math> are the maximum and minimum eigenvalues, respectively.</p>&#13;
&#13;
<p>In the following code block, which is a slight modification of the code provided by Prado (2020), we will generate the probability density function of a Marchenko–<span class="keep-together">Pastur</span> distribution and kernel density, which will allow us to model a random variable in a nonparametric approach. Then, the Marchenko–Pastur distribution will be fitted to the data:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">mp_pdf</code><code class="p">(</code><code class="n">sigma2</code><code class="p">,</code><code> </code><code class="n">q</code><code class="p">,</code><code> </code><code class="n">obs</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">lambda_plus</code><code> </code><code class="o">=</code><code> </code><code class="n">sigma2</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">q</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-1" id="co_modeling_market_risk_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">lambda_minus</code><code> </code><code class="o">=</code><code> </code><code class="n">sigma2</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">q</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-2" id="co_modeling_market_risk_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>             </code><code class="n">l</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linspace</code><code class="p">(</code><code class="n">lambda_minus</code><code class="p">,</code><code> </code><code class="n">lambda_plus</code><code class="p">,</code><code> </code><code class="n">obs</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">pdf_mp</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">pi</code><code> </code><code class="o">*</code><code> </code><code class="n">sigma2</code><code> </code><code class="o">*</code><code> </code><code class="n">q</code><code> </code><code class="o">*</code><code> </code><code class="n">l</code><code class="p">)</code><code> </code><code>\&#13;
</code><code>                      </code><code class="o">*</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="p">(</code><code class="n">lambda_plus</code><code>  </code><code class="o">-</code><code> </code><code class="n">l</code><code class="p">)</code><code>&#13;
</code><code>                      </code><code class="o">*</code><code>  </code><code class="p">(</code><code class="n">l</code><code> </code><code class="o">-</code><code> </code><code class="n">lambda_minus</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-3" id="co_modeling_market_risk_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>             </code><code class="n">pdf_mp</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="n">pdf_mp</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="n">l</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">pdf_mp</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn.neighbors</code><code> </code><code class="kn">import</code><code> </code><code class="n">KernelDensity</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="k">def</code><code> </code><code class="nf">kde_fit</code><code class="p">(</code><code class="n">bandwidth</code><code class="p">,</code><code class="n">obs</code><code class="p">,</code><code class="n">x</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">kde</code><code> </code><code class="o">=</code><code> </code><code class="n">KernelDensity</code><code class="p">(</code><code class="n">bandwidth</code><code class="p">,</code><code> </code><code class="n">kernel</code><code class="o">=</code><code class="s1">'</code><code class="s1">gaussian</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-4" id="co_modeling_market_risk_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>             </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">obs</code><code class="o">.</code><code class="n">shape</code><code class="p">)</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">kde_fit</code><code class="o">=</code><code class="n">kde</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">obs</code><code class="p">)</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-5" id="co_modeling_market_risk_CO6-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>             </code><code class="k">if</code><code> </code><code class="n">x</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">x</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">unique</code><code class="p">(</code><code class="n">obs</code><code class="p">)</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">x</code><code class="o">.</code><code class="n">shape</code><code class="p">)</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">x</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">logprob</code><code> </code><code class="o">=</code><code> </code><code class="n">kde_fit</code><code class="o">.</code><code class="n">score_samples</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-6" id="co_modeling_market_risk_CO6-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>             </code><code class="n">pdf_kde</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="n">logprob</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">=</code><code class="n">x</code><code class="o">.</code><code class="n">flatten</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">pdf_kde</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">corr_mat</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">normal</code><code class="p">(</code><code class="n">size</code><code class="o">=</code><code class="p">(</code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="mi">1000</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-7" id="co_modeling_market_risk_CO6-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>         </code><code class="n">corr_coef</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">corrcoef</code><code class="p">(</code><code class="n">corr_mat</code><code class="p">,</code><code> </code><code class="n">rowvar</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-8" id="co_modeling_market_risk_CO6-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>         </code><code class="n">sigma2</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>         </code><code class="n">obs</code><code> </code><code class="o">=</code><code> </code><code class="n">corr_mat</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">q</code><code> </code><code class="o">=</code><code> </code><code class="n">corr_mat</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">corr_mat</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="k">def</code><code> </code><code class="nf">plotting</code><code class="p">(</code><code class="n">corr_coef</code><code class="p">,</code><code> </code><code class="n">q</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">ev</code><code class="p">,</code><code> </code><code class="n">_</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">linalg</code><code class="o">.</code><code class="n">eigh</code><code class="p">(</code><code class="n">corr_coef</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-9" id="co_modeling_market_risk_CO6-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>             </code><code class="n">idx</code><code> </code><code class="o">=</code><code> </code><code class="n">ev</code><code class="o">.</code><code class="n">argsort</code><code class="p">(</code><code class="p">)</code><code class="p">[</code><code class="p">:</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">eigen_val</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">diagflat</code><code class="p">(</code><code class="n">ev</code><code class="p">[</code><code class="n">idx</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-10" id="co_modeling_market_risk_CO6-10"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>             </code><code class="n">pdf_mp</code><code> </code><code class="o">=</code><code> </code><code class="n">mp_pdf</code><code class="p">(</code><code class="mf">1.</code><code class="p">,</code><code> </code><code class="n">q</code><code class="o">=</code><code class="n">corr_mat</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">corr_mat</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                             </code><code class="n">obs</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-11" id="co_modeling_market_risk_CO6-11"><img alt="11" src="assets/11.png"/></a><code>&#13;
</code><code>             </code><code class="n">kde_pdf</code><code> </code><code class="o">=</code><code> </code><code class="n">kde_fit</code><code class="p">(</code><code class="mf">0.01</code><code class="p">,</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">diag</code><code class="p">(</code><code class="n">eigen_val</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO6-12" id="co_modeling_market_risk_CO6-12"><img alt="12" src="assets/12.png"/></a><code>&#13;
</code><code>             </code><code class="n">ax</code><code> </code><code class="o">=</code><code> </code><code class="n">pdf_mp</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">title</code><code class="o">=</code><code class="s2">"</code><code class="s2">Marchenko-Pastur Theorem</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="n">label</code><code class="o">=</code><code class="s2">"</code><code class="s2">M-P</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">style</code><code class="o">=</code><code class="s1">'</code><code class="s1">r--</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">kde_pdf</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">label</code><code class="o">=</code><code class="s2">"</code><code class="s2">Empirical Density</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">style</code><code class="o">=</code><code class="s1">'</code><code class="s1">o-</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">alpha</code><code class="o">=</code><code class="mf">0.3</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">ax</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="n">xlabel</code><code class="o">=</code><code class="s2">"</code><code class="s2">Eigenvalue</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">ylabel</code><code class="o">=</code><code class="s2">"</code><code class="s2">Frequency</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">ax</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="s2">"</code><code class="s2">upper right</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">plt</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plotting</code><code class="p">(</code><code class="n">corr_coef</code><code class="p">,</code><code> </code><code class="n">q</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-1" id="callout_modeling_market_risk_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculating maximum expected eigenvalue</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-2" id="callout_modeling_market_risk_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculating minimum expected eigenvalue</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-3" id="callout_modeling_market_risk_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generating probability density function of Marchenko-Pastur distribution</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-4" id="callout_modeling_market_risk_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Initiating kernel density estimation</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-5" id="callout_modeling_market_risk_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Fitting kernel density to the observations</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-6" id="callout_modeling_market_risk_CO6-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Assessing the log density model on observations</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-7" id="callout_modeling_market_risk_CO6-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Generating random samples from normal distribution</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-8" id="callout_modeling_market_risk_CO6-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Converting covariance matrix into correlation matrix</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-9" id="callout_modeling_market_risk_CO6-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Calculating eigenvalues of the correlation matrix</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-10" id="callout_modeling_market_risk_CO6-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Turning the NumPy array into diagonal matrix</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-11" id="callout_modeling_market_risk_CO6-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Calling <code>mp_pdf</code> to estimate the probability density function of the Marchenko–Pastur distribution</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO6-12" id="callout_modeling_market_risk_CO6-12"><img alt="12" src="assets/12.png"/></a></dt>&#13;
<dd><p>Calling <code>kde_fit</code> to fit kernel distribution to the data</p></dd>&#13;
</dl>&#13;
&#13;
<p>The resulting <a data-type="xref" href="#Marchenko_Pastur">Figure 5-3</a> shows that the Marchenko–Pastur distribution fits the data well. Thanks to the Marchenko–Pastur theorem, we are able to differentiate the noise and signal; we can now refer to data for which the noise has filtered as <em>denoised</em>.<a data-primary="" data-startref="ix_march_pastur" data-type="indexterm" id="idm45737228737232"/></p>&#13;
&#13;
<figure><div class="figure" id="Marchenko_Pastur">&#13;
<img alt="M_P" src="assets/mlfr_0503.png"/>&#13;
<h6><span class="label">Figure 5-3. </span>Fitting Marchenko–Pastur distribution</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="VaR (Value at Risk)" data-secondary="noised versus denoised" data-type="indexterm" id="idm45737228734000"/>So far, we have discussed the main steps to take to denoising the covariance matrix so that we can plug it into the VaR model, which is called the <em>denoised VaR</em> estimation. Denoising the covariance matrix is nothing but taking unnecessary information (noise) out of the data. So we can then make use of the signal from the market,&#13;
focusing our attention on the important events only.</p>&#13;
&#13;
<p>Denoising the covariance matrix includes the following stages:<sup><a data-type="noteref" href="ch05.html#idm45737228731696" id="idm45737228731696-marker">1</a></sup></p>&#13;
<ol>&#13;
<li>&#13;
<p>Calculate the eigenvalues and eigenvectors based on correlation matrix.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use kernel density estimation, find the eigenvector for a specific eigenvalue.</p>&#13;
</li>&#13;
<li>&#13;
<p>Fit the Marchenko–Pastur distribution to the kernel density estimation.</p>&#13;
</li>&#13;
<li>&#13;
<p>Find the maximum theoretical eigenvalue using the Marchenko–Pastur &#13;
<span class="keep-together">distribution</span>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Calculate the average of eigenvalues greater than the theoretical value.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use these new eigenvalues and eigenvectors to calculate the denoised correlation matrix.</p>&#13;
</li>&#13;
<li>&#13;
<p>Calculate the denoised covariance matrix by the new correlation matrix.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Let’s take a look at how easy it is to apply finding the denoised covariance matrix with a few lines of code using the <code>portfoliolab</code> library in Python:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">portfoliolab</code><code> </code><code class="kn">as</code><code> </code><code class="nn">pl</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk_estimators</code><code> </code><code class="o">=</code><code> </code><code class="n">pl</code><code class="o">.</code><code class="n">estimators</code><code class="o">.</code><code class="n">RiskEstimators</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stock_prices</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cov_matrix</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">cov</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">cov_matrix</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code>            </code><code class="n">IBM</code><code>      </code><code class="n">MSFT</code><code>      </code><code class="n">INTC</code><code>&#13;
</code><code>         </code><code class="n">IBM</code><code>   </code><code class="mf">0.000672</code><code>  </code><code class="mf">0.000465</code><code>  </code><code class="mf">0.000569</code><code>&#13;
</code><code>         </code><code class="n">MSFT</code><code>  </code><code class="mf">0.000465</code><code>  </code><code class="mf">0.000770</code><code>  </code><code class="mf">0.000679</code><code>&#13;
</code><code>         </code><code class="n">INTC</code><code>  </code><code class="mf">0.000569</code><code>  </code><code class="mf">0.000679</code><code>  </code><code class="mf">0.001158</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tn_relation</code><code> </code><code class="o">=</code><code> </code><code class="n">stock_prices</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">stock_prices</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO7-1" id="co_modeling_market_risk_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">kde_bwidth</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.25</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO7-2" id="co_modeling_market_risk_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">cov_matrix_denoised</code><code> </code><code class="o">=</code><code> </code><code class="n">risk_estimators</code><code class="o">.</code><code class="n">denoise_covariance</code><code class="p">(</code><code class="n">cov_matrix</code><code class="p">,</code><code>&#13;
</code><code>                                                                  </code><code class="n">tn_relation</code><code class="p">,</code><code>&#13;
</code><code>                                                                  </code><code class="n">kde_bwidth</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO7-3" id="co_modeling_market_risk_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">cov_matrix_denoised</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">cov_matrix_denoised</code><code class="p">,</code><code>&#13;
</code><code>                                            </code><code class="n">index</code><code class="o">=</code><code class="n">cov_matrix</code><code class="o">.</code><code class="n">index</code><code class="p">,</code><code>&#13;
</code><code>                                            </code><code class="n">columns</code><code class="o">=</code><code class="n">cov_matrix</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">cov_matrix_denoised</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code>            </code><code class="n">IBM</code><code>      </code><code class="n">MSFT</code><code>      </code><code class="n">INTC</code><code>&#13;
</code><code>         </code><code class="n">IBM</code><code>   </code><code class="mf">0.000672</code><code>  </code><code class="mf">0.000480</code><code>  </code><code class="mf">0.000589</code><code>&#13;
</code><code>         </code><code class="n">MSFT</code><code>  </code><code class="mf">0.000480</code><code>  </code><code class="mf">0.000770</code><code>  </code><code class="mf">0.000638</code><code>&#13;
</code><code>         </code><code class="n">INTC</code><code>  </code><code class="mf">0.000589</code><code>  </code><code class="mf">0.000638</code><code>  </code><code class="mf">0.001158</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">VaR_parametric_denoised</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">port_std</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">weights</code><code class="o">.</code><code class="n">T</code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">cov_matrix_denoised</code><code class="p">)</code><code>&#13;
</code><code>                                </code><code class="o">.</code><code class="n">dot</code><code class="p">(</code><code class="n">weights</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO7-4" id="co_modeling_market_risk_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>             </code><code class="n">alpha</code><code> </code><code class="o">=</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">ppf</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">,</code><code> </code><code class="n">stocks_returns_mean</code><code class="p">,</code><code> </code><code class="n">port_std</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Parametric VaR result for {} is {} </code><code class="s2">"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code class="n">VaR_param</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">VaR_params</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">-</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">alpha</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">--</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">25</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">VaR_params</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR_parametric_denoised</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">42519.03744155</code><code class="p">,</code><code> </code><code class="mf">40937.37812611</code><code class="p">,</code><code> </code><code class="mf">43022.12859114</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">symbols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s2">"</code><code class="s2">IBM</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">MSFT</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">INTC</code><code class="s2">"</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">stock3</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">symbol</code><code> </code><code class="ow">in</code><code> </code><code class="n">symbols</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">stock3</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">getDailyData</code><code class="p">(</code><code class="n">symbol</code><code class="p">)</code><code class="p">[</code><code class="p">:</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="p">[</code><code class="s1">'</code><code class="s1">close</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>                           </code><code class="p">[</code><code class="s1">'</code><code class="s1">2007-04-01</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">2009-02-01</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">stocks_crisis</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">stock3</code><code class="p">)</code><code class="o">.</code><code class="n">T</code><code>&#13;
</code><code>         </code><code class="n">stocks_crisis</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="n">symbols</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stocks_crisis</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code>               </code><code class="n">IBM</code><code>   </code><code class="n">MSFT</code><code>   </code><code class="n">INTC</code><code>&#13;
</code><code>         </code><code class="n">timestamp</code><code>&#13;
</code><code>         </code><code class="mi">2007</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mo">02</code><code>  </code><code class="mf">95.21</code><code>  </code><code class="mf">27.74</code><code>  </code><code class="mf">19.13</code><code>&#13;
</code><code>         </code><code class="mi">2007</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mo">03</code><code>  </code><code class="mf">96.10</code><code>  </code><code class="mf">27.87</code><code>  </code><code class="mf">19.31</code><code>&#13;
</code><code>         </code><code class="mi">2007</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mo">04</code><code>  </code><code class="mf">96.21</code><code>  </code><code class="mf">28.50</code><code>  </code><code class="mf">19.38</code><code>&#13;
</code><code>         </code><code class="mi">2007</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mo">05</code><code>  </code><code class="mf">96.52</code><code>  </code><code class="mf">28.55</code><code>  </code><code class="mf">19.58</code><code>&#13;
</code><code>         </code><code class="mi">2007</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">09</code><code>  </code><code class="mf">96.62</code><code>  </code><code class="mf">28.57</code><code>  </code><code class="mf">20.10</code><code>&#13;
</code><code>         </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>           </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>         </code><code class="mi">2009</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">26</code><code>  </code><code class="mf">91.60</code><code>  </code><code class="mf">17.63</code><code>  </code><code class="mf">13.38</code><code>&#13;
</code><code>         </code><code class="mi">2009</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">27</code><code>  </code><code class="mf">91.66</code><code>  </code><code class="mf">17.66</code><code>  </code><code class="mf">13.81</code><code>&#13;
</code><code>         </code><code class="mi">2009</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">28</code><code>  </code><code class="mf">94.82</code><code>  </code><code class="mf">18.04</code><code>  </code><code class="mf">14.01</code><code>&#13;
</code><code>         </code><code class="mi">2009</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">29</code><code>  </code><code class="mf">92.51</code><code>  </code><code class="mf">17.59</code><code>  </code><code class="mf">13.37</code><code>&#13;
</code><code>         </code><code class="mi">2009</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">30</code><code>  </code><code class="mf">91.65</code><code>  </code><code class="mf">17.10</code><code>  </code><code class="mf">12.90</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="p">[</code><code class="mi">463</code><code> </code><code class="n">rows</code><code> </code><code class="n">x</code><code> </code><code class="mi">3</code><code> </code><code class="n">columns</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stock_prices</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_crisis</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">stocks_returns</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">stocks</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cov_matrix</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">cov</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">42606.16125893139</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">41024.50194348814</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">43109.25240851776</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">42606.16125893</code><code class="p">,</code><code> </code><code class="mf">41024.50194349</code><code class="p">,</code><code> </code><code class="mf">43109.25240852</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR_parametric_denoised</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">VaR</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="p">[</code><code class="mf">42606.16125893</code><code> </code><code class="mf">41024.50194349</code><code>&#13;
</code><code>          </code><code class="mf">43109.25240852</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="mf">42519.03744155</code><code class="p">,</code><code> </code><code class="mf">40937.37812611</code><code class="p">,</code><code> </code><code class="mf">43022.12859114</code><code class="p">]</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO7-1" id="callout_modeling_market_risk_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Relating the number of observations <code>T</code> to the number of variables <code>N</code></p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO7-2" id="callout_modeling_market_risk_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Identifying the bandwidth for kernel density estimation</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO7-3" id="callout_modeling_market_risk_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Generating the denoised covariance matrix</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO7-4" id="callout_modeling_market_risk_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Incorporating the denoised covariance matrix into the VaR formula</p></dd>&#13;
</dl>&#13;
&#13;
<p>The difference between the traditionally applied VaR and the denoised VaR is even more pronounced in a <a data-primary="crisis periods" data-secondary="VaRs and denoising during" data-type="indexterm" id="ix_crisis_vars_denois"/>crisis period.&#13;
<a data-primary="correlation breakdown" data-type="indexterm" id="idm45737230085952"/>During a crisis period, correlation among assets becomes higher, which is sometimes referred to as <em>correlation breakdown</em>.&#13;
We will evaluate the effect of a crisis to check this phenomenon, and to do that, we will use the 2017–2018 crisis. However, the exact beginning and ending date of the crisis is necessary to run this analysis; we’ll get this information from the National Bureau of Economic Research (NBER), which announces business cycles.<sup><a data-type="noteref" href="ch05.html#idm45737230084272" id="idm45737230084272-marker">2</a></sup></p>&#13;
&#13;
<p>The result confirms that the correlation, and thereby VaRs, become higher during &#13;
<span class="keep-together">crisis</span> periods.</p>&#13;
&#13;
<p>Now, we managed to obtain a ML-based VaR using a denoised covariance matrix in lieu of an empirical matrix that we calculate directly from the data. Despite its appeal and ease of use, VaR is not a coherent risk measure, which requires satisfying certain conditions or axioms. You can think of these axioms as technical requirements for a risk measure.<a data-primary="" data-startref="ix_covar_matrix_denois" data-type="indexterm" id="idm45737230929360"/></p>&#13;
&#13;
<p>Let <math alttext="alpha element-of left-parenthesis 0 comma 1 right-parenthesis">&#13;
  <mrow>&#13;
    <mi>α</mi>&#13;
    <mo>∈</mo>&#13;
    <mo>(</mo>&#13;
    <mn>0</mn>&#13;
    <mo>,</mo>&#13;
    <mn>1</mn>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> be a fixed confidence level and (<math alttext="omega">&#13;
  <mi>ω</mi>&#13;
</math>,  <math alttext="script upper F">&#13;
  <mi>ℱ</mi>&#13;
</math>, <math alttext="sans-serif upper P">&#13;
  <mi>𝖯</mi>&#13;
</math>) be a probability space in which <math alttext="omega">&#13;
  <mi>ω</mi>&#13;
</math> represents a sample space, <math alttext="script upper F">&#13;
  <mi>ℱ</mi>&#13;
</math> denotes a subset of sample space, and <math alttext="sans-serif upper P">&#13;
  <mi>𝖯</mi>&#13;
</math> is probability measure.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>To illustrate, say <math alttext="omega">&#13;
  <mi>ω</mi>&#13;
</math> is the set of all possible outcomes in the event of tossing a coin, <math alttext="omega">&#13;
  <mi>ω</mi>&#13;
</math> = {H, T}. <math alttext="script upper F">&#13;
  <mi>ℱ</mi>&#13;
</math> can be treated as tossing a coin twice, <math alttext="script upper F equals 2 Superscript omega">&#13;
  <mrow>&#13;
    <mi>ℱ</mi>&#13;
    <mo>=</mo>&#13;
    <msup><mn>2</mn> <mi>ω</mi> </msup>&#13;
  </mrow>&#13;
</math> = <math alttext="2 squared">&#13;
  <msup><mn>2</mn> <mn>2</mn> </msup>&#13;
</math>. Finally, probability measure, <math alttext="sans-serif upper P">&#13;
  <mi>𝖯</mi>&#13;
</math>, is the odds of getting tails (0.5).</p>&#13;
</div>&#13;
&#13;
<p>Here are the four axioms of a coherent risk measure:</p>&#13;
<dl>&#13;
<dt><a data-primary="translation invariance, VaR coherent risk measure" data-type="indexterm" id="idm45737229813616"/>Translation invariance</dt>&#13;
<dd>&#13;
<div class="openblock">&#13;
<p>For all outcomes <em>Y</em> and a constant  <math alttext="a element-of double-struck upper R">&#13;
  <mrow>&#13;
    <mi>a</mi>&#13;
    <mo>∈</mo>&#13;
    <mi>ℝ</mi>&#13;
  </mrow>&#13;
</math>, we have</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper V a upper R left-parenthesis upper Y plus a right-parenthesis equals upper V a upper R left-parenthesis upper Y right-parenthesis plus a dollar-sign">&#13;
  <mrow>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mo>(</mo>&#13;
    <mi>Y</mi>&#13;
    <mo>+</mo>&#13;
    <mi>a</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mo>(</mo>&#13;
    <mi>Y</mi>&#13;
    <mo>)</mo>&#13;
    <mo>+</mo>&#13;
    <mi>a</mi>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>which means that if a riskless amount <em>a</em> is added to the portfolio, it results in lowering VaR by <em>a</em>.</p>&#13;
</div>&#13;
&#13;
</dd>&#13;
<dt><a data-primary="subadditivity, VaR coherent risk measure" data-type="indexterm" id="ix_subadditivity"/>Subadditivity</dt>&#13;
<dd>&#13;
<div class="openblock">&#13;
<p>For all <math alttext="upper Y 1">&#13;
  <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
</math> and <math alttext="upper Y 2">&#13;
  <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
</math>, we have</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper V a upper R left-parenthesis upper Y 1 plus upper Y 2 right-parenthesis less-than-or-equal-to upper V a upper R left-parenthesis upper Y 1 right-parenthesis plus upper V a upper R left-parenthesis upper Y 2 right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
      <mo>+</mo>&#13;
      <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>≤</mo>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>+</mo>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>This axiom stresses the importance of diversification in risk management. Take <math alttext="upper Y 1">&#13;
  <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
</math> and <math alttext="upper Y 2">&#13;
  <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
</math> as two assets: if they are both included in the portfolio, then that results in lower VaR than having them separately. Let’s check whether VaR satisfies the subadditivity assumption:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">asset1</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="o">-</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mf">0.1</code><code class="p">,</code><code> </code><code class="mf">0.4</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO8-1" id="co_modeling_market_risk_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">VaR1</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset1</code><code class="p">,</code><code> </code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the Asset 1 is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">asset2</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mf">0.01</code><code class="p">,</code><code> </code><code class="mf">0.4</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO8-2" id="co_modeling_market_risk_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">VaR2</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset2</code><code class="p">,</code><code> </code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the Asset 2 is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR2</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">VaR_all</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset1</code><code> </code><code class="o">+</code><code> </code><code class="n">asset2</code><code class="p">,</code><code> </code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the portfolio is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR_all</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">Asset</code><code> </code><code class="mi">1</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.3100</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">Asset</code><code> </code><code class="mi">2</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.2830</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">portfolio</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.4000</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">asset1</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="o">-</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mf">0.05</code><code class="p">,</code><code> </code><code class="mf">0.03</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO8-1" id="co_modeling_market_risk_CO8-3"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">VaR1</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset1</code><code class="p">,</code><code> </code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the Asset 1 is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">asset2</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mf">0.5</code><code class="p">,</code><code> </code><code class="mf">0.02</code><code class="p">,</code><code> </code><code class="mf">0.8</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO8-2" id="co_modeling_market_risk_CO8-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">VaR2</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset2</code><code class="p">,</code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the Asset 2 is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR2</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">VaR_all</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">asset1</code><code> </code><code class="o">+</code><code> </code><code class="n">asset2</code><code> </code><code class="p">,</code><code> </code><code class="mi">90</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">VaR for the portfolio is {:.4f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">VaR_all</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">Asset</code><code> </code><code class="mi">1</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.0440</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">Asset</code><code> </code><code class="mi">2</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.5660</code><code>&#13;
</code><code>         </code><code class="n">VaR</code><code> </code><code class="k">for</code><code> </code><code class="n">the</code><code> </code><code class="n">portfolio</code><code> </code><code class="ow">is</code><code> </code><code class="mf">0.2750</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO8-1" id="callout_modeling_market_risk_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Asset return for the first asset</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO8-2" id="callout_modeling_market_risk_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Asset return for the second asset</p></dd>&#13;
</dl>&#13;
&#13;
<p>It turns out that portfolio VaR is less that the sum of the individual VaRs, which makes no sense due to the risk mitigation through diversification. More elaborately, portfolio VaR should be lower than the sum of individual VaRs via diversification, as diversification mitigates risk, which in turn reduces the portfolio VaR.<a data-primary="" data-startref="ix_crisis_vars_denois" data-type="indexterm" id="idm45737229397952"/></p>&#13;
</div>&#13;
&#13;
</dd>&#13;
</dl>&#13;
<dl class="pagebreak-before less_space">&#13;
<dt><a data-primary="positive homogeneity, VaR coherent risk measure" data-type="indexterm" id="idm45737230870208"/>Positive homogeneity</dt>&#13;
<dd>&#13;
<div class="openblock">&#13;
<p>For all outcomes <em>Y</em> and <em>a</em> &gt; 0, we have</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper V a upper R left-parenthesis a upper Y right-parenthesis equals a upper V a upper R left-parenthesis upper Y right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mo>(</mo>&#13;
    <mi>a</mi>&#13;
    <mi>Y</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>a</mi>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mo>(</mo>&#13;
    <mi>Y</mi>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>which implies that the risk and value of the portfolio go in tandem—that is, if the value of a portfolio increases by an amount <em>a</em>, the risk goes up by <em>a</em>.</p>&#13;
</div>&#13;
&#13;
</dd>&#13;
<dt><a data-primary="monotonicity, VaR coherent risk measure" data-type="indexterm" id="idm45737229853312"/>Monotonicity</dt>&#13;
<dd>&#13;
<div class="openblock">&#13;
<p>For any two outcomes, <math alttext="upper Y 1">&#13;
  <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
</math> and <math alttext="upper Y 2">&#13;
  <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
</math>, if&#13;
<math alttext="upper Y 1 less-than-or-equal-to upper Y 2">&#13;
  <mrow>&#13;
    <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
    <mo>≤</mo>&#13;
    <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
  </mrow>&#13;
</math>, then:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper V a upper R left-parenthesis upper Y 2 right-parenthesis less-than-or-equal-to upper V a upper R left-parenthesis upper Y 1 right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>Y</mi> <mn>2</mn> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>≤</mo>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <mi>R</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>Y</mi> <mn>1</mn> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>At first, this may seem puzzling, but it is intuitive in the sense that monotonicity implies a lower VaR in the case of higher asset returns.</p>&#13;
</div>&#13;
&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>We now know that VaR is not a coherent risk measure. However, VaR is not the only tool by which we estimate market risk. Expected shortfall is another, and coherent, market risk measure.<a data-primary="" data-startref="ix_denois_market_risk" data-type="indexterm" id="idm45737229292800"/><a data-primary="" data-startref="ix_market_risk_denois" data-type="indexterm" id="idm45737229291824"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Expected Shortfall" data-type="sect1"><div class="sect1" id="idm45737232572128">&#13;
<h1>Expected Shortfall</h1>&#13;
&#13;
<p><a data-primary="market risk" data-secondary="expected shortfall" data-type="indexterm" id="ix_market_risk_es"/><a data-primary="loss distribution, and expected shortfall" data-type="indexterm" id="ix_loss_distr_ES"/><a data-primary="ES (expected shortfall) model" data-secondary="traditional" data-type="indexterm" id="ix_exp_short_trad"/><a data-primary="coherent risk measure, VaR versus ES" data-type="indexterm" id="ix_coherent_risk_var_es"/>Unlike VaR, ES focuses on the tail of the distribution. More specifically, ES enables us to take into account unexpected risks in the market. However, this doesn’t mean that ES and VaR are two entirely different concepts. Rather, they are related—that is, it is possible to express ES <em>using</em> VaR.</p>&#13;
&#13;
<p>Let’s assume that loss distribution is continuous; then ES can be mathematically defined as:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript alpha Baseline equals StartFraction 1 Over 1 minus alpha EndFraction integral Subscript alpha Superscript 1 Baseline q Subscript u Baseline d u dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>α</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mrow><mn>1</mn><mo>-</mo><mi>α</mi></mrow></mfrac>&#13;
    <msubsup><mo>∫</mo> <mi>α</mi> <mn>1</mn> </msubsup>&#13;
    <msub><mi>q</mi> <mi>u</mi> </msub>&#13;
    <mi>d</mi>&#13;
    <mi>u</mi>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <em>q</em> denotes the quantile of the loss distribution. The ES formula suggests that it is nothing but a probability weighted average of <math alttext="left-parenthesis 1 minus alpha right-parenthesis percent-sign">&#13;
  <mrow>&#13;
    <mo>(</mo>&#13;
    <mn>1</mn>&#13;
    <mo>-</mo>&#13;
    <mi>α</mi>&#13;
    <mo>)</mo>&#13;
    <mo>%</mo>&#13;
  </mrow>&#13;
</math> of losses.</p>&#13;
&#13;
<p>Let’s substitute <math alttext="q Subscript u">&#13;
  <msub><mi>q</mi> <mi>u</mi> </msub>&#13;
</math> and VaR, which gives us the following equation:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript alpha Baseline equals StartFraction 1 Over 1 minus alpha EndFraction integral Subscript alpha Superscript 1 Baseline upper V a upper R Subscript u Baseline d u dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>α</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mrow><mn>1</mn><mo>-</mo><mi>α</mi></mrow></mfrac>&#13;
    <msubsup><mo>∫</mo> <mi>α</mi> <mn>1</mn> </msubsup>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <msub><mi>R</mi> <mi>u</mi> </msub>&#13;
    <mi>d</mi>&#13;
    <mi>u</mi>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before less_space">Alternatively, it is the mean of losses exceeding VaR:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript alpha Baseline equals sans-serif upper E left-parenthesis upper L vertical-bar upper L greater-than upper V a upper R Subscript alpha Baseline right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>α</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mi>𝖤</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>L</mi>&#13;
      <mo>|</mo>&#13;
      <mi>L</mi>&#13;
      <mo>&gt;</mo>&#13;
      <mi>V</mi>&#13;
      <mi>a</mi>&#13;
      <msub><mi>R</mi> <mi>α</mi> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Loss distribution can be continuous or discrete and, as you can imagine, if it takes the discrete form, the ES is different such that</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript alpha Baseline equals StartFraction 1 Over 1 minus alpha EndFraction sigma-summation Underscript n equals 0 Overscript 1 Endscripts max left-parenthesis upper L Subscript n Baseline right-parenthesis probability left-parenthesis upper L Subscript n Baseline right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>α</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mrow><mn>1</mn><mo>-</mo><mi>α</mi></mrow></mfrac>&#13;
    <msubsup><mo>∑</mo> <mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow> <mn>1</mn> </msubsup>&#13;
    <mtext>max</mtext>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>L</mi> <mi>n</mi> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo form="prefix">Pr</mo>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>L</mi> <mi>n</mi> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <math alttext="m a x left-parenthesis upper L Subscript n Baseline right-parenthesis">&#13;
  <mrow>&#13;
    <mi>m</mi>&#13;
    <mi>a</mi>&#13;
    <mi>x</mi>&#13;
    <mo>(</mo>&#13;
    <msub><mi>L</mi> <mi>n</mi> </msub>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> shows the highest <math alttext="n Superscript t h">&#13;
  <msup><mi>n</mi> <mrow><mi>t</mi><mi>h</mi></mrow> </msup>&#13;
</math> loss, and <math alttext="probability left-parenthesis upper L Subscript n Baseline right-parenthesis">&#13;
  <mrow>&#13;
    <mo form="prefix">Pr</mo>&#13;
    <mo>(</mo>&#13;
    <msub><mi>L</mi> <mi>n</mi> </msub>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math> indicates probability of <math alttext="n Superscript t h">&#13;
  <msup><mi>n</mi> <mrow><mi>t</mi><mi>h</mi></mrow> </msup>&#13;
</math> highest loss.&#13;
In code, we can formulate this as:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">ES_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">alpha</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">ppf</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">,</code><code class="n">stocks_returns_mean</code><code class="p">,</code><code class="n">port_std</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">VaR_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code> </code><code class="n">alpha</code><code class="p">)</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO9-1" id="co_modeling_market_risk_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                 </code><code class="n">ES_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">)</code><code> </code><code>\&#13;
</code><code>                            </code><code class="o">*</code><code> </code><code class="n">initial_investment</code><code> </code><code>\&#13;
</code><code>                            </code><code class="o">*</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">expect</code><code class="p">(</code><code class="k">lambda</code><code> </code><code class="n">x</code><code class="p">:</code><code> </code><code class="n">x</code><code class="p">,</code><code>&#13;
</code><code>                                          </code><code class="n">lb</code><code> </code><code class="o">=</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">ppf</code><code class="p">(</code><code class="n">conf_level</code><code class="p">,</code><code>&#13;
</code><code>                                                        </code><code class="n">stocks_returns_mean</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                                        </code><code class="n">port_std</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                                          </code><code class="n">loc</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns_mean</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                          </code><code class="n">scale</code><code> </code><code class="o">=</code><code> </code><code class="n">port_std</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO9-2" id="co_modeling_market_risk_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"</code><code class="s2">Parametric ES result for {i} is {ES_param}</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ES_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">52776.42396231898</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">54358.083277762125</code><code>&#13;
</code><code>         </code><code class="n">Parametric</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">52273.33281273264</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO9-1" id="callout_modeling_market_risk_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Estimating the variance-covariance VaR</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO9-2" id="callout_modeling_market_risk_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Given the confidence interval, estimating the ES based on VaR</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="historical simulation method" data-type="indexterm" id="idm45737231012576"/>ES can also be computed based on the historical observations. Like the historical simulation VaR method, parametric assumption can be relaxed. To do that, the first return (or loss) corresponding to the 95% is found, and then the mean of the observations greater than the 95% gives us the result.</p>&#13;
&#13;
<p>Here is what we do in code:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">ES_historical</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code>&#13;
</code><code>                             </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">ES_hist_percentile95</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">percentile</code><code class="p">(</code><code class="n">stocks_returns</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                                      </code><code class="mi">5</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO10-1" id="co_modeling_market_risk_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                 </code><code class="n">ES_historical</code><code> </code><code class="o">=</code><code> </code><code class="n">stocks_returns</code><code class="p">[</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code class="p">]</code><code class="p">[</code><code class="n">stocks_returns</code><code class="p">[</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code>&#13;
</code><code>                                                        </code><code class="n">ES_hist_percentile95</code><code class="p">]</code><code>\&#13;
</code><code>                                                        </code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO10-2" id="co_modeling_market_risk_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>                 </code><code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">Historical ES result for {} is {:.4f} </code><code class="s2">"</code><code>&#13;
</code><code>                       </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code> </code><code class="n">ES_historical</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ES_historical</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="o">-</code><code class="mf">64802.3898</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="o">-</code><code class="mf">65765.0848</code><code>&#13;
</code><code>         </code><code class="n">Historical</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="o">-</code><code class="mf">88462.7404</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO10-1" id="callout_modeling_market_risk_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculating the 95% of the returns</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO10-2" id="callout_modeling_market_risk_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Estimating the ES based on the historical observations</p></dd>&#13;
</dl>&#13;
&#13;
<p>Thus far, we have seen how to model the expected shortfall in a traditional way. Now, it is time to introduce an ML-based approach to further enhance the estimation performance and reliability  of the ES model.<a data-primary="" data-startref="ix_coherent_risk_var_es" data-type="indexterm" id="idm45737230795600"/><a data-primary="" data-startref="ix_exp_short_trad" data-type="indexterm" id="idm45737230794624"/><a data-primary="" data-startref="ix_loss_distr_ES" data-type="indexterm" id="idm45737230793680"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Liquidity-Augmented Expected Shortfall" data-type="sect1"><div class="sect1" id="idm45737229290624">&#13;
<h1>Liquidity-Augmented Expected Shortfall</h1>&#13;
&#13;
<p><a data-primary="market risk" data-secondary="liquidity-augmented expected shortfall" data-type="indexterm" id="ix_market_risk_liq_aug_es"/><a data-primary="liquidity-augmented expected shortfall" data-type="indexterm" id="ix_liq_aug_es"/><a data-primary="ES (expected shortfall) model" data-secondary="liquidity-augmented" data-type="indexterm" id="ix_exp_short_liq_aug"/>As discussed, ES provides us with a coherent risk measure to gauge market risk. However, though we differentiate financial risks as market, credit, liquidity, and operational risks, that does not necessarily mean that these risks are entirely unrelated to one another. Rather, they are, to some extent, correlated. That is, once a financial crisis hit the market, market risk surges along with the drawdown on lines of credit, which in turn increases liquidity risk.</p>&#13;
&#13;
<p>This fact is supported by Antoniades (2014, p. 6) stating that:</p>&#13;
<blockquote data-type="epigram">&#13;
<p>&#13;
Common pool of liquid assets is the resource constraint through which liquidity risk can affect the supply of mortgage credit.</p>&#13;
&#13;
<p>During the financial crisis of 2007–2008 the primary source of stresses to bank funding conditions arose from the funding illiquidity experienced in the markets for wholesale funding.</p>&#13;
</blockquote>&#13;
&#13;
<p><a data-primary="liquidity risk" data-type="indexterm" id="idm45737230747088"/>Ignoring the liqudity dimension of risk may result in underestimating the market risk. Therefore, augmenting ES with liquidity risk may make a more accurate &#13;
<span class="keep-together">and reliable</span> estimation. Well, it sounds appealing, but how can we find a proxy for &#13;
<span class="keep-together">liquidity</span>?</p>&#13;
&#13;
<p><a data-primary="bid-ask spread" data-secondary="in ES model" data-secondary-sortas="ES model" data-type="indexterm" id="ix_bid-ask_es_model"/><a data-primary="bid-ask spread" data-type="indexterm" id="ix_bid-ask_spread"/>In the literature, bid-ask spread measures are commonly used for modeling liquidity. Shortly, <em>bid-ask spread</em> is the difference between the highest available price (bid price) that a buyer is willing to pay and the lowest price (ask price) that a seller is willing to get. So bid-ask spread gives a tool to measure the transaction cost.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><em>Liquidity</em> can be <a data-primary="liquidity" data-type="indexterm" id="idm45737230739792"/>defined as the ease of making a transaction in which assets are sold in a very short time period without a significant impact on market price. There are two main measures of &#13;
<span class="keep-together">liquidity</span>:</p>&#13;
<dl>&#13;
<dt><a data-primary="market liquidity" data-type="indexterm" id="idm45737230737440"/>Market liquidity</dt>&#13;
<dd>&#13;
<p>The ease with which an asset is traded.</p>&#13;
</dd>&#13;
<dt><a data-primary="funding liquidity risk" data-type="indexterm" id="idm45737230735456"/>Funding liquidity</dt>&#13;
<dd>&#13;
<p>The ease with which an investor can obtain funding.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Liquidity and the risk arising from it will be discussed in greater detail in <a data-type="xref" href="ch07.html#chapter_7">Chapter 7</a>.</p>&#13;
</div>&#13;
&#13;
<p>To the extent that bid-ask spread is a good indicator of transaction cost, it is also a good proxy of liquidity in the sense that transaction cost is one of the components of liquidity. Spreads can be defined various ways depending on their focus. Here are the bid-ask spreads that we will use to incorporate liquidity risk into the ES model:</p>&#13;
<dl>&#13;
<dt><a data-primary="effective spread" data-type="indexterm" id="idm45737230730656"/>Effective spread</dt>&#13;
<dd>&#13;
<div class="openblock"><div data-type="equation">&#13;
<math alttext="dollar-sign Effective spread equals 2 StartAbsoluteValue left-parenthesis upper P Subscript t Baseline minus upper P Subscript m i d Baseline right-parenthesis EndAbsoluteValue dollar-sign">&#13;
  <mrow>&#13;
    <mtext>Effective</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>spread</mtext>&#13;
    <mo>=</mo>&#13;
    <mn>2</mn>&#13;
    <mo>|</mo>&#13;
    <mo>(</mo>&#13;
    <msub><mi>P</mi> <mi>t</mi> </msub>&#13;
    <mo>-</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
    <mo>)</mo>&#13;
    <mo>|</mo>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <math alttext="upper P Subscript t">&#13;
  <msub><mi>P</mi> <mi>t</mi> </msub>&#13;
</math> is the price of trade at time <em>t</em> and <math alttext="upper P Subscript m i d">&#13;
  <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
</math> is the midpoint of the bid-ask offer (<math alttext="left-parenthesis upper P Subscript a s k Baseline minus upper P Subscript b i d Baseline right-parenthesis slash 2">&#13;
  <mrow>&#13;
    <mo>(</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>a</mi><mi>s</mi><mi>k</mi></mrow> </msub>&#13;
    <mo>-</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>b</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
    <mo>)</mo>&#13;
    <mo>/</mo>&#13;
    <mn>2</mn>&#13;
  </mrow>&#13;
</math>) prevailing at the time of the <math alttext="t">&#13;
  <mi>t</mi>&#13;
</math>.</p>&#13;
</div>&#13;
&#13;
</dd>&#13;
<dt><a data-primary="proportional quoted spread" data-type="indexterm" id="idm45737230704720"/>Proportional quoted spread</dt>&#13;
<dd>&#13;
<div class="openblock"><div data-type="equation">&#13;
<math alttext="dollar-sign Proportional quoted spread equals left-parenthesis upper P Subscript a s k Baseline minus upper P Subscript b i d Baseline right-parenthesis slash upper P Subscript m i d Baseline dollar-sign">&#13;
  <mrow>&#13;
    <mtext>Proportional</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>quoted</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>spread</mtext>&#13;
    <mo>=</mo>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msub><mi>P</mi> <mrow><mi>a</mi><mi>s</mi><mi>k</mi></mrow> </msub>&#13;
      <mo>-</mo>&#13;
      <msub><mi>P</mi> <mrow><mi>b</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>/</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <math alttext="upper P Subscript a s k">&#13;
  <msub><mi>P</mi> <mrow><mi>a</mi><mi>s</mi><mi>k</mi></mrow> </msub>&#13;
</math> is the ask price and <math alttext="upper P Subscript b i d">&#13;
  <msub><mi>P</mi> <mrow><mi>b</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
</math> and <math alttext="upper P Subscript m i d">&#13;
  <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
</math> are bid price and mid price, respectively.<a data-primary="" data-startref="ix_market_risk_es" data-type="indexterm" id="idm45737226042240"/><a data-primary="" data-startref="ix_exp_short_liq_aug" data-type="indexterm" id="idm45737226041296"/><a data-primary="" data-startref="ix_liq_aug_es" data-type="indexterm" id="idm45737226040352"/><a data-primary="" data-startref="ix_market_risk_liq_aug_es" data-type="indexterm" id="idm45737226039408"/></p>&#13;
</div>&#13;
&#13;
</dd>&#13;
<dt><a data-primary="quoted spread" data-type="indexterm" id="idm45737226038016"/>Quoted spread</dt>&#13;
<dd>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign Quoted spread equals upper P Subscript a s k Baseline minus upper P Subscript b i d Baseline dollar-sign">&#13;
  <mrow>&#13;
    <mtext>Quoted</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>spread</mtext>&#13;
    <mo>=</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>a</mi><mi>s</mi><mi>k</mi></mrow> </msub>&#13;
    <mo>-</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>b</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
</dd>&#13;
<dt><a data-primary="proportional effective spread" data-type="indexterm" id="idm45737226028240"/>Proportional effective spread</dt>&#13;
<dd>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign Proportional effective spread equals 2 left-parenthesis StartAbsoluteValue upper P Subscript t Baseline minus upper P Subscript m i d Baseline EndAbsoluteValue right-parenthesis slash upper P Subscript m i d Baseline dollar-sign">&#13;
  <mrow>&#13;
    <mtext>Proportional</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>effective</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>spread</mtext>&#13;
    <mo>=</mo>&#13;
    <mrow>&#13;
      <mn>2</mn>&#13;
      <mo>(</mo>&#13;
      <mo>|</mo>&#13;
    </mrow>&#13;
    <msub><mi>P</mi> <mi>t</mi> </msub>&#13;
    <mo>-</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
    <mrow>&#13;
      <mo>|</mo>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>/</mo>&#13;
    <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Effective Cost" data-type="sect1"><div class="sect1" id="idm45737226012720">&#13;
<h1>Effective Cost</h1>&#13;
&#13;
<p><a data-primary="market risk" data-secondary="effective cost" data-type="indexterm" id="ix_market_risk_eff_cost"/><a data-primary="ES (expected shortfall) model" data-secondary="effective cost" data-type="indexterm" id="ix_es_effect_cost"/><a data-primary="effective cost, ES" data-type="indexterm" id="ix_effect_cost_es"/>A buyer-initiated trade occurs when a trade is executed at a price above the quoted mid price. Similarly, a seller-initiated trade occurs when a trade is executed at a price below the quoted mid price. We can then describe the <em>effective cost</em> as follows:</p>&#13;
<div data-type="equation">&#13;
<math mode="display">&#13;
  <mrow>&#13;
    <mtext>Effective</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>cost</mtext>&#13;
    <mo>=</mo>&#13;
    <mfenced close="" open="{" separators="">&#13;
      <mtable>&#13;
        <mtr>&#13;
          <mtd columnalign="left">&#13;
            <mrow>&#13;
              <mrow>&#13;
                <mo>(</mo>&#13;
                <msub><mi>P</mi> <mi>t</mi> </msub>&#13;
                <mo>-</mo>&#13;
                <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
                <mo>)</mo>&#13;
              </mrow>&#13;
              <mo>/</mo>&#13;
              <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>for</mtext>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>buyer-initiated</mtext>&#13;
            </mrow>&#13;
          </mtd>&#13;
        </mtr>&#13;
        <mtr>&#13;
          <mtd columnalign="left">&#13;
            <mrow>&#13;
              <mrow>&#13;
                <mo>(</mo>&#13;
                <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
                <mo>/</mo>&#13;
                <msub><mi>P</mi> <mi>t</mi> </msub>&#13;
                <mo>)</mo>&#13;
              </mrow>&#13;
              <mo>/</mo>&#13;
              <msub><mi>P</mi> <mrow><mi>m</mi><mi>i</mi><mi>d</mi></mrow> </msub>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>for</mtext>&#13;
              <mspace width="4.pt"/>&#13;
              <mtext>seller-initiated</mtext>&#13;
            </mrow>&#13;
          </mtd>&#13;
        </mtr>&#13;
      </mtable>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math></div>&#13;
&#13;
<p>Now we need to find a way to incorporate these bid-ask spreads into the ES model so that we are able to account for the liquidity risk as well as market risk. We will employ two different methods to accomplish this task. The first method we’ll use is to take the cross-sectional mean of the bid-ask spread, as suggested by Chordia et al., (2000) and Pástor and Stambaugh (2003). The second method is to apply principal component analysis (PCA) as proposed by Mancini et al. (2013).</p>&#13;
&#13;
<p><a data-primary="cross-section mean of bid-ask spread" data-type="indexterm" id="ix_cross_sec_bid-ask"/>The cross-sectional mean is nothing but a row-wise averaging of the bid-ask spread. Using this method, we are able to generate a measure for market-wide liquidity. The averaging formula is as follows:</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper L Subscript upper M comma t Baseline equals StartFraction 1 Over upper N EndFraction sigma-summation Underscript i Overscript upper N Endscripts upper L Subscript i comma t dollar-sign">&#13;
  <mrow>&#13;
    <msub><mi>L</mi> <mrow><mi>M</mi><mo>,</mo><mi>t</mi></mrow> </msub>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mi>N</mi></mfrac>&#13;
    <msubsup><mo>∑</mo> <mi>i</mi> <mi>N</mi> </msubsup>&#13;
    <msub><mi>L</mi> <mrow><mi>i</mi><mo>,</mo><mi>t</mi></mrow> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where <math alttext="upper L Subscript upper M comma t">&#13;
  <msub><mi>L</mi> <mrow><mi>M</mi><mo>,</mo><mi>t</mi></mrow> </msub>&#13;
</math> is the market liquidity and <math alttext="upper L Subscript i comma t">&#13;
  <msub><mi>L</mi> <mrow><mi>i</mi><mo>,</mo><mi>t</mi></mrow> </msub>&#13;
</math> is the individual liquidity measure, namely bid-ask spread in our case.&#13;
Then we can calculate</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript upper L Baseline equals upper E upper S plus Liquidity cost dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>L</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mi>E</mi>&#13;
    <mi>S</mi>&#13;
    <mo>+</mo>&#13;
    <mtext>Liquidity</mtext>&#13;
    <mspace width="4.pt"/>&#13;
    <mtext>cost</mtext>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper E upper S Subscript upper L Baseline equals StartFraction 1 Over 1 minus alpha EndFraction integral Subscript alpha Superscript 1 Baseline upper V a upper R Subscript u Baseline d u plus one-half upper P Subscript l a s t Baseline left-parenthesis mu plus k sigma right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>E</mi>&#13;
    <msub><mi>S</mi> <mi>L</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mrow><mn>1</mn><mo>-</mo><mi>α</mi></mrow></mfrac>&#13;
    <msubsup><mo>∫</mo> <mi>α</mi> <mn>1</mn> </msubsup>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <msub><mi>R</mi> <mi>u</mi> </msub>&#13;
    <mi>d</mi>&#13;
    <mi>u</mi>&#13;
    <mo>+</mo>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
    <msub><mi>P</mi> <mrow><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi></mrow> </msub>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>μ</mi>&#13;
      <mo>+</mo>&#13;
      <mi>k</mi>&#13;
      <mi>σ</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>where</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><math alttext="upper P Subscript l a s t">&#13;
  <msub><mi>P</mi> <mrow><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi></mrow> </msub>&#13;
</math> is the closing stock price</p>&#13;
</li>&#13;
<li>&#13;
<p><math alttext="mu">&#13;
  <mi>μ</mi>&#13;
</math> is the mean of spread</p>&#13;
</li>&#13;
<li>&#13;
<p><em>k</em> is the scaling factor to accommodate fat tail</p>&#13;
</li>&#13;
<li>&#13;
<p><math alttext="sigma">&#13;
  <mi>σ</mi>&#13;
</math> is the standard deviation of the spread</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before less_space">To convert these methods to code, we’ll do the following:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bid_ask</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'</code><code class="s1">bid_ask.csv</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-1" id="co_modeling_market_risk_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">ASKHI</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">BIDLO</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-2" id="co_modeling_market_risk_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">buyer_seller_initiated</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">if</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">:</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-3" id="co_modeling_market_risk_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                 </code><code class="n">buyer_seller_initiated</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-4" id="co_modeling_market_risk_CO11-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>             </code><code class="k">else</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">buyer_seller_initiated</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-5" id="co_modeling_market_risk_CO11-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">buyer_seller_init</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">buyer_seller_initiated</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">effective_cost</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">if</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">buyer_seller_init</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">effective_cost</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                                        </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                        </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-6" id="co_modeling_market_risk_CO11-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>             </code><code class="k">else</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">effective_cost</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                                        </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">)</code><code class="o">/</code><code>&#13;
</code><code>                                        </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-7" id="co_modeling_market_risk_CO11-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>         </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">effective_cost</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">effective_cost</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">quoted</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">ASKHI</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">BIDLO</code><code class="s1">'</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-8" id="co_modeling_market_risk_CO11-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>         </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">prop_quoted</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">ASKHI</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">BIDLO</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code>\&#13;
</code><code>                                  </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-8" id="co_modeling_market_risk_CO11-9"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>         </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">effective</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-8" id="co_modeling_market_risk_CO11-10"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>         </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">prop_effective</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                                             </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid_price</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code>\&#13;
</code><code>                                             </code><code class="n">bid_ask</code><code class="p">[</code><code class="s1">'</code><code class="s1">PRC</code><code class="s1">'</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-8" id="co_modeling_market_risk_CO11-11"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread_meas</code><code> </code><code class="o">=</code><code> </code><code class="n">bid_ask</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">5</code><code class="p">:</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="n">spread_meas</code><code class="o">.</code><code class="n">corr</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code>                 </code><code class="n">effective_cost</code><code>    </code><code class="n">quoted</code><code>  </code><code class="n">prop_quoted</code><code>  </code><code class="n">effective</code><code>  </code><code>\&#13;
</code><code>         </code><code class="n">effective_cost</code><code>        </code><code class="mf">1.000000</code><code>  </code><code class="mf">0.441290</code><code>     </code><code class="mf">0.727917</code><code>   </code><code class="mf">0.800894</code><code>&#13;
</code><code>         </code><code class="n">quoted</code><code>                </code><code class="mf">0.441290</code><code>  </code><code class="mf">1.000000</code><code>     </code><code class="mf">0.628526</code><code>   </code><code class="mf">0.717246</code><code>&#13;
</code><code>         </code><code class="n">prop_quoted</code><code>           </code><code class="mf">0.727917</code><code>  </code><code class="mf">0.628526</code><code>     </code><code class="mf">1.000000</code><code>   </code><code class="mf">0.514979</code><code>&#13;
</code><code>         </code><code class="n">effective</code><code>             </code><code class="mf">0.800894</code><code>  </code><code class="mf">0.717246</code><code>     </code><code class="mf">0.514979</code><code>   </code><code class="mf">1.000000</code><code>&#13;
</code><code>         </code><code class="n">prop_effective</code><code>        </code><code class="mf">0.999847</code><code>  </code><code class="mf">0.442053</code><code>     </code><code class="mf">0.728687</code><code>   </code><code class="mf">0.800713</code><code>&#13;
</code><code>&#13;
</code><code>                         </code><code class="n">prop_effective</code><code>&#13;
</code><code>         </code><code class="n">effective_cost</code><code>        </code><code class="mf">0.999847</code><code>&#13;
</code><code>         </code><code class="n">quoted</code><code>                </code><code class="mf">0.442053</code><code>&#13;
</code><code>         </code><code class="n">prop_quoted</code><code>           </code><code class="mf">0.728687</code><code>&#13;
</code><code>         </code><code class="n">effective</code><code>             </code><code class="mf">0.800713</code><code>&#13;
</code><code>         </code><code class="n">prop_effective</code><code>        </code><code class="mf">1.000000</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread_meas</code><code class="o">.</code><code class="n">describe</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code>     </code><code class="n">effective_cost</code><code>      </code><code class="n">quoted</code><code>  </code><code class="n">prop_quoted</code><code>   </code><code class="n">effective</code><code>  </code><code class="n">prop_effective</code><code>&#13;
</code><code>      </code><code class="n">count</code><code>      </code><code class="mf">756.000000</code><code>  </code><code class="mf">756.000000</code><code>   </code><code class="mf">756.000000</code><code>  </code><code class="mf">756.000000</code><code>      </code><code class="mf">756.000000</code><code>&#13;
</code><code>      </code><code class="n">mean</code><code>         </code><code class="mf">0.004247</code><code>    </code><code class="mf">1.592583</code><code>     </code><code class="mf">0.015869</code><code>    </code><code class="mf">0.844314</code><code>        </code><code class="mf">0.008484</code><code>&#13;
</code><code>      </code><code class="n">std</code><code>          </code><code class="mf">0.003633</code><code>    </code><code class="mf">0.921321</code><code>     </code><code class="mf">0.007791</code><code>    </code><code class="mf">0.768363</code><code>        </code><code class="mf">0.007257</code><code>&#13;
</code><code>      </code><code class="nb">min</code><code>          </code><code class="mf">0.000000</code><code>    </code><code class="mf">0.320000</code><code>     </code><code class="mf">0.003780</code><code>    </code><code class="mf">0.000000</code><code>        </code><code class="mf">0.000000</code><code>&#13;
</code><code>      </code><code class="mi">25</code><code class="o">%</code><code>          </code><code class="mf">0.001517</code><code>    </code><code class="mf">0.979975</code><code>     </code><code class="mf">0.010530</code><code>    </code><code class="mf">0.300007</code><code>        </code><code class="mf">0.003029</code><code>&#13;
</code><code>      </code><code class="mi">50</code><code class="o">%</code><code>          </code><code class="mf">0.003438</code><code>    </code><code class="mf">1.400000</code><code>     </code><code class="mf">0.013943</code><code>    </code><code class="mf">0.610000</code><code>        </code><code class="mf">0.006874</code><code>&#13;
</code><code>      </code><code class="mi">75</code><code class="o">%</code><code>          </code><code class="mf">0.005854</code><code>    </code><code class="mf">1.962508</code><code>     </code><code class="mf">0.019133</code><code>    </code><code class="mf">1.180005</code><code>        </code><code class="mf">0.011646</code><code>&#13;
</code><code>      </code><code class="nb">max</code><code>          </code><code class="mf">0.023283</code><code>    </code><code class="mf">8.110000</code><code>     </code><code class="mf">0.055451</code><code>    </code><code class="mf">6.750000</code><code>        </code><code class="mf">0.047677</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">high_corr</code><code> </code><code class="o">=</code><code> </code><code class="n">spread_meas</code><code class="o">.</code><code class="n">corr</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">unstack</code><code class="p">(</code><code class="p">)</code><code>\&#13;
</code><code>                     </code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code class="o">.</code><code class="n">drop_duplicates</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-9" id="co_modeling_market_risk_CO11-12"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>         </code><code class="n">high_corr</code><code class="p">[</code><code class="p">(</code><code class="n">high_corr</code><code> </code><code class="o">&gt;</code><code> </code><code class="mf">0.80</code><code class="p">)</code><code> </code><code class="o">&amp;</code><code> </code><code class="p">(</code><code class="n">high_corr</code><code> </code><code class="o">!=</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">]</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-10" id="co_modeling_market_risk_CO11-13"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">effective_cost</code><code>  </code><code class="n">prop_effective</code><code>    </code><code class="mf">0.999847</code><code>&#13;
</code><code>         </code><code class="n">effective</code><code>       </code><code class="n">effective_cost</code><code>    </code><code class="mf">0.800894</code><code>&#13;
</code><code>         </code><code class="n">prop_effective</code><code>  </code><code class="n">effective</code><code>         </code><code class="mf">0.800713</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sorted_spread_measures</code><code> </code><code class="o">=</code><code> </code><code class="n">bid_ask</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">5</code><code class="p">:</code><code class="o">-</code><code class="mi">2</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cross_sec_mean_corr</code><code> </code><code class="o">=</code><code> </code><code class="n">sorted_spread_measures</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-11" id="co_modeling_market_risk_CO11-14"><img alt="11" src="assets/11.png"/></a><code>&#13;
</code><code>         </code><code class="n">std_corr</code><code> </code><code class="o">=</code><code> </code><code class="n">sorted_spread_measures</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">3</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-12" id="co_modeling_market_risk_CO11-15"><img alt="12" src="assets/12.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">index</code><code class="o">=</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">last_prices</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="n">symbols</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">last_prices</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">stocks</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-13" id="co_modeling_market_risk_CO11-16"><img alt="13" src="assets/13.png"/></a><code>&#13;
</code><code>         </code><code class="n">df</code><code class="p">[</code><code class="s1">'</code><code class="s1">last_prices</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">last_prices</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">ES_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">ES_params</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code> </code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">alpha</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">ppf</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">,</code><code> </code><code class="n">stocks_returns_mean</code><code class="p">,</code><code> </code><code class="n">port_std</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">,</code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">stocks</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">VaR_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">initial_investment</code><code> </code><code class="o">*</code><code> </code><code class="n">alpha</code><code class="p">)</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code>&#13;
</code><code>                 </code><code class="n">ES_param</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code class="p">)</code><code> </code><code>\&#13;
</code><code>                            </code><code class="o">*</code><code> </code><code class="n">norm</code><code class="o">.</code><code class="n">expect</code><code class="p">(</code><code class="k">lambda</code><code> </code><code class="n">x</code><code class="p">:</code><code> </code><code class="n">VaR_param</code><code class="p">,</code><code> </code><code class="n">lb</code><code> </code><code class="o">=</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="n">ES_params</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">ES_param</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">return</code><code> </code><code class="n">ES_params</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ES_params</code><code> </code><code class="o">=</code><code> </code><code class="n">ES_parametric</code><code class="p">(</code><code class="n">initial_investment</code><code class="p">,</code><code> </code><code class="n">conf_level</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">symbols</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">The ES result for {symbols[i]} is {ES_params[i]}</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">145760.89803654602</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">140349.84772375744</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">ES</code><code> </code><code class="n">result</code><code> </code><code class="k">for</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">147482.03450111256</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">k</code><code> </code><code class="o">=</code><code> </code><code class="mf">1.96</code><code>&#13;
</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">symbols</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">symbols</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">The liquidity Adjusted ES of {} is {}</code><code class="s1">'</code><code>&#13;
</code><code>                   </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">j</code><code class="p">,</code><code> </code><code class="n">ES_params</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                           </code><code class="p">(</code><code class="n">cross_sec_mean_corr</code><code> </code><code class="o">+</code><code> </code><code class="n">k</code><code> </code><code class="o">*</code><code> </code><code class="n">std_corr</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO11-14" id="co_modeling_market_risk_CO11-17"><img alt="14" src="assets/14.png"/></a><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">145833.08767607837</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">140477.40110495212</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">147510.60526566216</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-1" id="callout_modeling_market_risk_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Importing the <code>bid_ask</code> data</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-2" id="callout_modeling_market_risk_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculating the mid price</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-3" id="callout_modeling_market_risk_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Defining conditions for buyer- and seller-initiated trade</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-4" id="callout_modeling_market_risk_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>If the above-given condition holds, it returns 1, and it is appended into the <code>buyer_seller_initiated</code> list</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-5" id="callout_modeling_market_risk_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>If the above-given condition does not hold, it returns 0, and it is appended into the <code>buyer_seller_initiated</code> list</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-6" id="callout_modeling_market_risk_CO11-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>If the <code>buyer_seller_initiated</code> variable takes a value of 1, the corresponding effective cost formula is run</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-7" id="callout_modeling_market_risk_CO11-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>If the <code>buyer_seller_initiated</code> variable takes a value of 0, the corresponding effective cost formula is run</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-8" id="callout_modeling_market_risk_CO11-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Calculating the quoted, proportional quoted, effective, and proportional effective spreads</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-12" id="callout_modeling_market_risk_CO11-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Obtaining the correlation matrices and listing them column-wise</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-13" id="callout_modeling_market_risk_CO11-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Sorting out the correlation greater than 80%</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-14" id="callout_modeling_market_risk_CO11-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Calculating the cross-sectional mean of spread measures</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-15" id="callout_modeling_market_risk_CO11-12"><img alt="12" src="assets/12.png"/></a></dt>&#13;
<dd><p>Obtaining the standard deviation of spreads</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-16" id="callout_modeling_market_risk_CO11-13"><img alt="13" src="assets/13.png"/></a></dt>&#13;
<dd><p>Filtering the last observed stock prices from the <code>stocks</code> data</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO11-17" id="callout_modeling_market_risk_CO11-14"><img alt="14" src="assets/14.png"/></a></dt>&#13;
<dd><p>Estimating the liquidity-adjusted ES<a data-primary="" data-startref="ix_cross_sec_bid-ask" data-type="indexterm" id="idm45737226238944"/></p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="PCA (principle component analysis) of bid-ask spread" data-type="indexterm" id="ix_pca_bid-ask"/>The PCA is a method used to reduce dimensionality. It is used to extract as much information as possible using as few components as possible. If we were to take <a data-type="xref" href="#scree_plot">Figure 5-4</a> as an example, out of five features, we might pick two components. So we reduce dimensionality at the expense of losing information because, depending on our chosen cut-off point, we pick the number of components and lose as much information as how many components we left off.</p>&#13;
&#13;
<p class="pagebreak-before less_space">To be more specific, the point at which <a data-type="xref" href="#scree_plot">Figure 5-4</a> gets flatter implies that we retain less information and this is the cut-off point for the PCA. However, it is not an easy call in that there is a trade-off between the cutoff point and information retained. On the one hand, the higher the cut-off point (the higher number of components we have), the more information we retain (the less dimensionality we reduce). On the other hand, the lower the cut-off point (the fewer number of components we have), the less information we retain (the higher dimensionality we reduce). Getting a flatter scree plot is not the only criteria for selecting a suitable number of components, so what would be the possible criteria for picking the proper number of components? Here are the possible cut-off criteria for PCA:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Greater than 80% explained variance</p>&#13;
</li>&#13;
<li>&#13;
<p>More than one eigenvalue</p>&#13;
</li>&#13;
<li>&#13;
<p>The point at which the scree plot gets flatter</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="VaR (Value at Risk)" data-secondary="liquidity adjustment applied to" data-type="indexterm" id="idm45737227055104"/>Please note that liquidity adjustment can be applied to VaR, too. The same procedure applies to VaR. Mathematically,</p>&#13;
<div data-type="equation">&#13;
<math alttext="dollar-sign upper V a upper R Subscript upper L Baseline equals sigma Subscript p Baseline StartRoot t EndRoot upper Z Subscript alpha Baseline plus one-half upper P Subscript l a s t Baseline left-parenthesis mu plus k sigma right-parenthesis dollar-sign">&#13;
  <mrow>&#13;
    <mi>V</mi>&#13;
    <mi>a</mi>&#13;
    <msub><mi>R</mi> <mi>L</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msub><mi>σ</mi> <mi>p</mi> </msub>&#13;
    <msqrt>&#13;
      <mi>t</mi>&#13;
    </msqrt>&#13;
    <msub><mi>Z</mi> <mi>α</mi> </msub>&#13;
    <mo>+</mo>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
    <msub><mi>P</mi> <mrow><mi>l</mi><mi>a</mi><mi>s</mi><mi>t</mi></mrow> </msub>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>μ</mi>&#13;
      <mo>+</mo>&#13;
      <mi>k</mi>&#13;
      <mi>σ</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>This application is left to the reader.</p>&#13;
</div>&#13;
&#13;
<p>However, dimensionality reduction is not the only thing that we can take advantage of. In this example, we apply PCA for the benefit of getting the peculiar features of liquidity, because PCA filters the most important information from the data for us:<a data-primary="" data-startref="ix_pca_bid-ask" data-type="indexterm" id="idm45737232043168"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn.decomposition</code><code> </code><code class="kn">import</code><code> </code><code class="n">PCA</code><code>&#13;
</code><code>         </code><code class="kn">from</code><code> </code><code class="nn">sklearn.preprocessing</code><code> </code><code class="kn">import</code><code> </code><code class="n">StandardScaler</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">scaler</code><code> </code><code class="o">=</code><code> </code><code class="n">StandardScaler</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">spread_meas_scaled</code><code> </code><code class="o">=</code><code> </code><code class="n">scaler</code><code class="o">.</code><code class="n">fit_transform</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">abs</code><code class="p">(</code><code class="n">spread_meas</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-1" id="co_modeling_market_risk_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">pca</code><code> </code><code class="o">=</code><code> </code><code class="n">PCA</code><code class="p">(</code><code class="n">n_components</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-2" id="co_modeling_market_risk_CO12-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">prin_comp</code><code> </code><code class="o">=</code><code> </code><code class="n">pca</code><code class="o">.</code><code class="n">fit_transform</code><code class="p">(</code><code class="n">spread_meas_scaled</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-3" id="co_modeling_market_risk_CO12-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">var_expl</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="n">pca</code><code class="o">.</code><code class="n">explained_variance_ratio_</code><code class="p">,</code><code> </code><code class="n">decimals</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-4" id="co_modeling_market_risk_CO12-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="n">cum_var</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="n">pca</code><code class="o">.</code><code class="n">explained_variance_ratio_</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="n">decimals</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-5" id="co_modeling_market_risk_CO12-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Individually Explained Variances are:</code><code class="se">\n</code><code class="s1">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">var_expl</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">==</code><code class="s1">'</code><code class="o">*</code><code class="mi">30</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Cumulative Explained Variances are: {}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">cum_var</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">Individually</code><code> </code><code class="n">Explained</code><code> </code><code class="n">Variances</code><code> </code><code class="n">are</code><code class="p">:</code><code>&#13;
</code><code>         </code><code class="p">[</code><code class="mf">0.7494</code><code> </code><code class="mf">0.1461</code><code> </code><code class="mf">0.0983</code><code> </code><code class="mf">0.0062</code><code> </code><code class="mf">0.</code><code>    </code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>&#13;
</code><code>         </code><code class="n">Cumulative</code><code> </code><code class="n">Explained</code><code> </code><code class="n">Variances</code><code> </code><code class="n">are</code><code class="p">:</code><code> </code><code class="p">[</code><code class="mf">0.7494</code><code> </code><code class="mf">0.8955</code><code> </code><code class="mf">0.9938</code><code> </code><code class="mf">1.</code><code>     </code><code class="mf">1.</code><code>    </code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">pca</code><code class="o">.</code><code class="n">explained_variance_ratio_</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-6" id="co_modeling_market_risk_CO12-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s1">'</code><code class="s1">Number of Components</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'</code><code class="s1">Variance Explained</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">title</code><code class="p">(</code><code class="s1">'</code><code class="s1">Scree Plot</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">pca</code><code> </code><code class="o">=</code><code> </code><code class="n">PCA</code><code class="p">(</code><code class="n">n_components</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-7" id="co_modeling_market_risk_CO12-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>         </code><code class="n">pca</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">abs</code><code class="p">(</code><code class="n">spread_meas_scaled</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">prin_comp</code><code> </code><code class="o">=</code><code> </code><code class="n">pca</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">abs</code><code class="p">(</code><code class="n">spread_meas_scaled</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">prin_comp</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">abs</code><code class="p">(</code><code class="n">prin_comp</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">Component 1</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                                                </code><code class="s1">'</code><code class="s1">Component 2</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="k">print</code><code class="p">(</code><code class="n">pca</code><code class="o">.</code><code class="n">explained_variance_ratio_</code><code class="o">*</code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="p">[</code><code class="mf">65.65640435</code><code> </code><code class="mf">19.29704671</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">myplot</code><code class="p">(</code><code class="n">score</code><code class="p">,</code><code> </code><code class="n">coeff</code><code class="p">,</code><code> </code><code class="n">labels</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">xs</code><code> </code><code class="o">=</code><code> </code><code class="n">score</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">ys</code><code> </code><code class="o">=</code><code> </code><code class="n">score</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">n</code><code> </code><code class="o">=</code><code> </code><code class="n">coeff</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>             </code><code class="n">scalex</code><code> </code><code class="o">=</code><code> </code><code class="mf">1.0</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="n">xs</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">xs</code><code class="o">.</code><code class="n">min</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">scaley</code><code> </code><code class="o">=</code><code> </code><code class="mf">1.0</code><code> </code><code class="o">/</code><code> </code><code class="p">(</code><code class="n">ys</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">ys</code><code class="o">.</code><code class="n">min</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">plt</code><code class="o">.</code><code class="n">scatter</code><code class="p">(</code><code class="n">xs</code><code> </code><code class="o">*</code><code> </code><code class="n">scalex</code><code> </code><code class="o">*</code><code> </code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">ys</code><code> </code><code class="o">*</code><code> </code><code class="n">scaley</code><code> </code><code class="o">*</code><code> </code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">s</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">n</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">plt</code><code class="o">.</code><code class="n">arrow</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">color</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                           </code><code class="n">alpha</code><code class="o">=</code><code class="mf">0.5</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">if</code><code> </code><code class="n">labels</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>&#13;
</code><code>                     </code><code class="n">plt</code><code class="o">.</code><code class="n">text</code><code class="p">(</code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">Var</code><code class="s2">"</code><code class="o">+</code><code class="nb">str</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">black</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>                 </code><code class="k">else</code><code class="p">:</code><code>&#13;
</code><code>                     </code><code class="n">plt</code><code class="o">.</code><code class="n">text</code><code class="p">(</code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code class="mi">0</code><code> </code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">coeff</code><code class="p">[</code><code class="n">i</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">labels</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="n">color</code><code class="o">=</code><code class="s1">'</code><code class="s1">black</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>             </code><code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s2">"</code><code class="s2">PC{}</code><code class="s2">"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s2">"</code><code class="s2">PC{}</code><code class="s2">"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">plt</code><code class="o">.</code><code class="n">grid</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread_measures_scaled_df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">spread_meas_scaled</code><code class="p">,</code><code>&#13;
</code><code>                                                  </code><code class="n">columns</code><code class="o">=</code><code class="n">spread_meas</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">myplot</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">spread_measures_scaled_df</code><code class="p">)</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">:</code><code class="mi">2</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="n">np</code><code class="o">.</code><code class="n">transpose</code><code class="p">(</code><code class="n">pca</code><code class="o">.</code><code class="n">components_</code><code class="p">[</code><code class="mi">0</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="p">:</code><code class="p">]</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="nb">list</code><code class="p">(</code><code class="n">spread_measures_scaled_df</code><code class="o">.</code><code class="n">columns</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO12-8" id="co_modeling_market_risk_CO12-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-1" id="callout_modeling_market_risk_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Standardizing the spread measures</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-2" id="callout_modeling_market_risk_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Identifying the number of principal components as 5</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-3" id="callout_modeling_market_risk_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Applying the principal component to the <em>spread_measures_scaled</em></p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-4" id="callout_modeling_market_risk_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Observing the explained variance of the five principal components</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-5" id="callout_modeling_market_risk_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Observing the cumulative explained variance of the five principal components</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-6" id="callout_modeling_market_risk_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Drawing the <em>scree plot</em> (<a data-type="xref" href="#scree_plot">Figure 5-4</a>)</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-7" id="callout_modeling_market_risk_CO12-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Based on scree plot, determining two to be the number of components to be used in our PCA analysis</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO12-8" id="callout_modeling_market_risk_CO12-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Drawing the <em>biplot</em> (<a data-type="xref" href="#bi_plot">Figure 5-5</a>) to observe the relationship between components and features</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="scree_plot">&#13;
<img alt="mlfr 0504" src="assets/mlfr_0504.png"/>&#13;
<h6><span class="label">Figure 5-4. </span>PCA scree plot</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="bi_plot">&#13;
<img alt="mlfr 0505" src="assets/mlfr_0505.png"/>&#13;
<h6><span class="label">Figure 5-5. </span>PCA biplot</h6>&#13;
</div></figure>&#13;
&#13;
<p>We now have all the necessary information, and by incorporating this information, we are able to calculate the liquidity-adjusted ES. Unsurprisingly, the following code reveals that the liquidity-adjusted ES provides larger values compared to the standard ES application. This implies that including a liquidity dimension in our ES estimation results in higher risk:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">prin_comp1_rescaled</code><code> </code><code class="o">=</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>\&#13;
</code><code>                               </code><code class="o">+</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO13-1" id="co_modeling_market_risk_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">prin_comp2_rescaled</code><code> </code><code class="o">=</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>\&#13;
</code><code>                               </code><code class="o">+</code><code> </code><code class="n">prin_comp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO13-2" id="co_modeling_market_risk_CO13-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">prin_comp_rescaled</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">concat</code><code class="p">(</code><code class="p">[</code><code class="n">prin_comp1_rescaled</code><code class="p">,</code><code>&#13;
</code><code>                                         </code><code class="n">prin_comp2_rescaled</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                                        </code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">prin_comp_rescaled</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code>    </code><code class="n">Component</code><code> </code><code class="mi">1</code><code>  </code><code class="n">Component</code><code> </code><code class="mi">2</code><code>&#13;
</code><code>         </code><code class="mi">0</code><code>     </code><code class="mf">1.766661</code><code>     </code><code class="mf">1.256192</code><code>&#13;
</code><code>         </code><code class="mi">1</code><code>     </code><code class="mf">4.835170</code><code>     </code><code class="mf">1.939466</code><code>&#13;
</code><code>         </code><code class="mi">2</code><code>     </code><code class="mf">3.611486</code><code>     </code><code class="mf">1.551059</code><code>&#13;
</code><code>         </code><code class="mi">3</code><code>     </code><code class="mf">0.962666</code><code>     </code><code class="mf">0.601529</code><code>&#13;
</code><code>         </code><code class="mi">4</code><code>     </code><code class="mf">0.831065</code><code>     </code><code class="mf">0.734612</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean_pca_liq</code><code> </code><code class="o">=</code><code> </code><code class="n">prin_comp_rescaled</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO13-3" id="co_modeling_market_risk_CO13-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">mean_pca_liq</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">1.0647130086973815</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">k</code><code> </code><code class="o">=</code><code> </code><code class="mf">1.96</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">j</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">symbols</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">symbols</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">The liquidity Adjusted ES of {} is {}</code><code class="s1">'</code><code>&#13;
</code><code>                   </code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">j</code><code class="p">,</code><code> </code><code class="n">ES_params</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">j</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">)</code><code> </code><code class="o">*</code><code>&#13;
</code><code>                           </code><code class="p">(</code><code class="n">mean_pca_liq</code><code> </code><code class="o">+</code><code> </code><code class="n">k</code><code> </code><code class="o">*</code><code> </code><code class="n">std_corr</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_modeling_market_risk_CO13-4" id="co_modeling_market_risk_CO13-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">IBM</code><code> </code><code class="ow">is</code><code> </code><code class="mf">145866.2662997893</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">MSFT</code><code> </code><code class="ow">is</code><code> </code><code class="mf">140536.02510785797</code><code>&#13;
</code><code>         </code><code class="n">The</code><code> </code><code class="n">liquidity</code><code> </code><code class="n">Adjusted</code><code> </code><code class="n">ES</code><code> </code><code class="n">of</code><code> </code><code class="n">INTC</code><code> </code><code class="ow">is</code><code> </code><code class="mf">147523.7364940803</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO13-1" id="callout_modeling_market_risk_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculating the liquidity part of the liquidity-adjusted ES formula for the first principal component</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO13-2" id="callout_modeling_market_risk_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculating the liquidity part of the liquidity-adjusted ES formula for the second principal component</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO13-3" id="callout_modeling_market_risk_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculating cross-sectional mean of the two principal components</p></dd>&#13;
<dt><a class="co" href="#co_modeling_market_risk_CO13-4" id="callout_modeling_market_risk_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Estimating the liquidity-adjusted ES<a data-primary="" data-startref="ix_bid-ask_spread" data-type="indexterm" id="idm45737229756720"/><a data-primary="" data-startref="ix_bid-ask_es_model" data-type="indexterm" id="idm45737229755744"/><a data-primary="" data-startref="ix_effect_cost_es" data-type="indexterm" id="idm45737229754800"/><a data-primary="" data-startref="ix_es_effect_cost" data-type="indexterm" id="idm45737229753856"/><a data-primary="" data-startref="ix_market_risk_eff_cost" data-type="indexterm" id="idm45737229752912"/></p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45737226011776">&#13;
<h1>Conclusion</h1>&#13;
&#13;
<p>Market risk has been always under scrutiny as it gives us the extent to which a company is vulnerable to risk emanating from market events. In a financial risk management textbook, it is customary to find a VaR and an ES model, which are two prominent and commonly applied models in theory and practice. In this chapter, after providing an introduction to these models, models were introduced to revisit and improve model estimation. To this end, we first tried to differentiate information flows in the form of noise and signal, which is called denoising. Then, we employed a denoised covariance matrix to improve the VaR estimation.</p>&#13;
&#13;
<p>Next, we discussed an ES model as a coherent risk measure. The method that we applied to improve this model was a liquidity-based approach, by which we revisited the ES model and augmented it using a liquidity component so that it was possible to consider liquidity risk in estimating ES.</p>&#13;
&#13;
<p>Further improvements in market risk estimation are possible, but our aim here is to give a general idea and the requisite tooling to provide a decent foundation for ML-based market risk approaches. However, you can go further and apply different tools. In the next chapter, we will discuss credit risk modeling as suggested by regulatory bodies like the Basel Committee on Banking Supervision (BCBS) and then enrich this model using an ML-based approach.<a data-primary="" data-startref="ix_market_risk_ch5" data-type="indexterm" id="idm45737229749008"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="References" data-type="sect1"><div class="sect1" id="idm45737229747776">&#13;
<h1>References</h1>&#13;
&#13;
<p>Articles cited in this chapter:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Antoniades, Adonis. 2016. “Liquidity Risk and the Credit Crunch of 2007-2008: Evidence from Micro-Level Data on Mortgage Loan Applications.” <em>Journal of Financial and Quantitative Analysis</em> 51 (6): 1795-1822.</p>&#13;
</li>&#13;
<li>&#13;
<p>Bzdok, D., N. Altman, and M. Krzywinski. 2018. “Points of Significance: Statistics Versus Machine Learning.” <em>Nature Methods</em> 15 (4): 233-234.</p>&#13;
</li>&#13;
<li>&#13;
<p>BIS, Calculation of RWA for Market Risk, 2020.</p>&#13;
</li>&#13;
<li>&#13;
<p>Chordia, Tarun, Richard Roll, and Avanidhar Subrahmanyam. 2000. “Commonality in Liquidity.” Journal of Financial Economics 56 (1): 3-28.</p>&#13;
</li>&#13;
<li>&#13;
<p>Mancini, Loriano, Angelo Ranaldo, and Jan Wrampelmeyer. 2013. “Liquidity in the Foreign Exchange Market: Measurement, Commonality, and Risk Premiums.” <em>The Journal of Finance</em> 68 (5): 1805-1841.</p>&#13;
</li>&#13;
<li>&#13;
<p>Pástor, Ľuboš, and Robert F. Stambaugh. 2003. “Liquidity Risk and Expected Stock Returns.” <em>Journal of Political Economy</em> 111 (3): 642-685.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Books cited in this chapter:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Dowd, Kevin. 2003. <em>An Introduction to Market Risk Measurement</em>. Hoboken, NJ: John Wiley and Sons.</p>&#13;
</li>&#13;
<li>&#13;
<p>Glasserman, Paul. <em>Monte Carlo Methods in Financial Engineering</em>. 2013. Stochastic Modelling and Applied Probability Series, Volume 53. New York: Springer Science &amp; Business Media.</p>&#13;
</li>&#13;
<li>&#13;
<p>M. López De Prado. 2020. <em>Machine Learning for Asset Managers</em>. Cambridge: Cambridge University Press.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45737228731696"><sup><a href="ch05.html#idm45737228731696-marker">1</a></sup> The details of the procedure can be found at <a href="https://oreil.ly/gkQjX">Hudson and Thames</a>.</p><p data-type="footnote" id="idm45737230084272"><sup><a href="ch05.html#idm45737230084272-marker">2</a></sup> See <a href="https://oreil.ly/07s71">NBER’s website</a> for further information.</p></div></div></section></body></html>