<html><head></head><body><section data-pdf-bookmark="Chapter 10. Automating Trading Operations" data-type="chapter" epub:type="chapter"><div class="chapter" id="automated_trading">&#13;
<h1><span class="label">Chapter 10. </span>Automating Trading Operations</h1>&#13;
&#13;
<blockquote class="align_me_right">&#13;
<p><a data-primary="automated trading operations" data-type="indexterm" id="ix_10_automated_trading_-asciidoc0"/>People <a data-primary="Domingos, Pedro" data-type="indexterm" id="idm45785343029576"/>worry that computers will get too smart and take over the world, but the real problem is that they‚Äôre too stupid and they‚Äôve already taken over the world.</p>&#13;
<p data-type="attribution">Pedro Domingos</p>&#13;
</blockquote>&#13;
&#13;
<p>‚ÄúNow what?‚Äù you might think. The trading platform that allows one to retrieve historical data and streaming data is available. It allows one to place buy and sell orders and to check the account status. A number of different methods have been introduced in this book to derive algorithmic trading strategies by predicting the direction of market price movements. You may ask, ‚ÄúHow, after all, can this all be put together to work in automated fashion?‚Äù This cannot be answered in any generality. However, this chapter addresses a number of topics that are important in this context. The chapter assumes that a single automated, algorithmic trading strategy is to be deployed. This simplifies, for example, aspects like capital and risk management.</p>&#13;
&#13;
<p>The chapter covers the following topics. <a data-type="xref" href="#auto_capital">‚ÄúCapital Management‚Äù</a> discusses the <em>Kelly criterion</em>. Depending on the strategy characteristics and the trading capital available, the Kelly criterion helps with sizing the trades. To gain confidence in an algorithmic trading strategy, the strategy needs to be backtested thoroughly with regard to both performance and risk characteristics. <a data-type="xref" href="#auto_strat">‚ÄúML-Based Trading Strategy‚Äù</a> backtests an example strategy based on a classification algorithm from machine learning (ML), as introduced in <a data-type="xref" href="ch01.html#trading_strategies">‚ÄúTrading Strategies‚Äù</a>. To deploy the algorithmic trading strategy for automated trading, it needs to be translated into an online algorithm that works with incoming streaming data in real time. <a data-type="xref" href="#auto_online">‚ÄúOnline Algorithm‚Äù</a> covers the transformation of an <em>offline</em> algorithm into an <em>online</em> algorithm.</p>&#13;
&#13;
<p><a data-type="xref" href="#auto_infra_deploy">‚ÄúInfrastructure and Deployment‚Äù</a> then sets out to make sure that the automated, algorithmic trading strategy runs robustly and reliably in the cloud. Not all topics of relevance can be covered in detail, but <em>cloud deployment</em> seems to be the only viable option from an availability, performance, and security point of view in this context. <a data-type="xref" href="#auto_logg_monit">‚ÄúLogging and Monitoring‚Äù</a> covers logging and monitoring. Logging is important in order to be able to analyze the history and certain events during the deployment of an automated trading strategy. Monitoring via socket communication, as introduced in <a data-type="xref" href="ch07.html#realtime_sockets">Chapter¬†7</a>, allows one to observe events remotely in real time. The chapter concludes with <a data-type="xref" href="#viz_summary">‚ÄúVisual Step-by-Step Overview‚Äù</a>, which provides a visual summary of the core steps for the automated deployment of algorithmic trading strategies in the cloud.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Capital Management" data-type="sect1"><div class="sect1" id="auto_capital">&#13;
<h1>Capital Management</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="capital management" data-type="indexterm" id="ix_10_automated_trading_-asciidoc1"/><a data-primary="capital management" data-secondary="automated trading operations and" data-type="indexterm" id="ix_10_automated_trading_-asciidoc2"/>A central question in algorithmic trading is how much capital to deploy to a given algorithmic trading strategy given the total available capital. The answer to this question depends on the main goal one is trying to achieve by algorithmic trading. Most individuals and financial institutions will agree that the <em>maximization of long-term wealth</em> is a good candidate objective. <a data-primary="Thorp, Edward" data-type="indexterm" id="idm45785345808680"/>This is what Edward Thorp had in mind when he derived the <em>Kelly criterion</em> to investing, as described in Rotando and Thorp (1992). Simply speaking, the Kelly criterion allows for an explicit calculation of the fraction of the available capital a trader should deploy to a strategy, given its statistical return characteristics.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kelly Criterion in Binomial Setting" data-type="sect2"><div class="sect2" id="idm45785345807096">&#13;
<h2>Kelly Criterion in Binomial Setting</h2>&#13;
&#13;
<p><a data-primary="capital management" data-secondary="Kelly criterion in binomial setting" data-type="indexterm" id="ix_10_automated_trading_-asciidoc3"/><a data-primary="Kelly criterion" data-secondary="in binomial setting" data-type="indexterm" id="ix_10_automated_trading_-asciidoc4"/>The common way of introducing the theory of the Kelly criterion to investing is on the basis of a coin tossing game or, more generally, a binomial setting (only two outcomes are possible). This section follows that path. Assume a gambler is playing a coin tossing game against an infinitely rich bank or casino. Assume further that the probability for heads is some value <math alttext="p">&#13;
  <mi>p</mi>&#13;
</math> for which the following holds:</p>&#13;
<div data-type="equation">&#13;
<math alttext="one-half less-than p less-than 1" display="block">&#13;
  <mrow>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
    <mo>&lt;</mo>&#13;
    <mi>p</mi>&#13;
    <mo>&lt;</mo>&#13;
    <mn>1</mn>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Probability for tails is defined by the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="q equals 1 minus p less-than one-half" display="block">&#13;
  <mrow>&#13;
    <mi>q</mi>&#13;
    <mo>=</mo>&#13;
    <mn>1</mn>&#13;
    <mo>-</mo>&#13;
    <mi>p</mi>&#13;
    <mo>&lt;</mo>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>The gambler can place bets <math alttext="b greater-than 0">&#13;
  <mrow>&#13;
    <mi>b</mi>&#13;
    <mo>&gt;</mo>&#13;
    <mn>0</mn>&#13;
  </mrow>&#13;
</math> of arbitrary size, whereby the gambler wins the same amount if right and loses it all if wrong. Given the assumptions about the probabilities, the gambler would of course want to bet on heads.</p>&#13;
&#13;
<p class="pagebreak-before">Therefore, the expected value for this betting game <math alttext="upper B">&#13;
  <mi>B</mi>&#13;
</math> (that is, the random variable representing this game) in a one-shot setting is as follows:</p>&#13;
<div data-type="equation">&#13;
<math alttext="bold upper E left-parenthesis upper B right-parenthesis equals p dot b minus q dot b equals left-parenthesis p minus q right-parenthesis dot b greater-than 0" display="block">&#13;
  <mrow>&#13;
    <mi>ùêÑ</mi>&#13;
    <mo>(</mo>&#13;
    <mi>B</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>p</mi>&#13;
    <mo>¬∑</mo>&#13;
    <mi>b</mi>&#13;
    <mo>-</mo>&#13;
    <mi>q</mi>&#13;
    <mo>¬∑</mo>&#13;
    <mi>b</mi>&#13;
    <mo>=</mo>&#13;
    <mo>(</mo>&#13;
    <mi>p</mi>&#13;
    <mo>-</mo>&#13;
    <mi>q</mi>&#13;
    <mo>)</mo>&#13;
    <mo>¬∑</mo>&#13;
    <mi>b</mi>&#13;
    <mo>&gt;</mo>&#13;
    <mn>0</mn>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>A risk-neutral gambler with unlimited funds would like to bet as large an amount as possible since this would maximize the expected payoff. However, trading in financial markets is not a one-shot game in general. It is a repeated game. Therefore, assume that <math alttext="b Subscript i">&#13;
  <msub><mi>b</mi> <mi>i</mi> </msub>&#13;
</math> represents the amount that is bet on day <math alttext="i">&#13;
  <mi>i</mi>&#13;
</math> and that <math alttext="c 0">&#13;
  <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
</math> represents the initial capital. The capital <math alttext="c 1">&#13;
  <msub><mi>c</mi> <mn>1</mn> </msub>&#13;
</math> at the end of day one depends on the betting success on that day and might be either <math alttext="c 0 plus b 1">&#13;
  <mrow>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>+</mo>&#13;
    <msub><mi>b</mi> <mn>1</mn> </msub>&#13;
  </mrow>&#13;
</math> or <math alttext="c 0 minus b 1">&#13;
  <mrow>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>-</mo>&#13;
    <msub><mi>b</mi> <mn>1</mn> </msub>&#13;
  </mrow>&#13;
</math>. The expected value for a gamble that is repeated <math alttext="n">&#13;
  <mi>n</mi>&#13;
</math> times then is as follows:</p>&#13;
<div data-type="equation">&#13;
<math alttext="bold upper E left-parenthesis upper B Superscript n Baseline right-parenthesis equals c 0 plus sigma-summation Underscript i equals 1 Overscript n Endscripts left-parenthesis p minus q right-parenthesis dot b Subscript i" display="block">&#13;
  <mrow>&#13;
    <mi>ùêÑ</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <msup><mi>B</mi> <mi>n</mi> </msup>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>+</mo>&#13;
    <munderover><mo>‚àë</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </munderover>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>p</mi>&#13;
      <mo>-</mo>&#13;
      <mi>q</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>¬∑</mo>&#13;
    <msub><mi>b</mi> <mi>i</mi> </msub>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>In classical economic theory, with risk-neutral, expected utility-maximizing agents, a gambler would try to maximize the preceding expression. It is easily seen that it is maximized by betting all available funds, <math alttext="b Subscript i Baseline equals c Subscript i minus 1">&#13;
  <mrow>&#13;
    <msub><mi>b</mi> <mi>i</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msub><mi>c</mi> <mrow><mi>i</mi><mo>-</mo><mn>1</mn></mrow> </msub>&#13;
  </mrow>&#13;
</math>, like in the one-shot scenario. However, this in turn implies that a single loss will wipe out all available funds and will lead to ruin (unless unlimited borrowing is possible). Therefore, this strategy does not lead to a maximization of long-term wealth.</p>&#13;
&#13;
<p>While betting the maximum capital available might lead to sudden ruin, betting nothing at all avoids any kind of loss but does not benefit from the advantageous gamble either. This is where the Kelly criterion comes into play since it derives the <em>optimal fraction</em> <math alttext="f Superscript asterisk">&#13;
  <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
</math> of the available capital to bet per round of betting. Assume that <math alttext="n equals h plus t">&#13;
  <mrow>&#13;
    <mi>n</mi>&#13;
    <mo>=</mo>&#13;
    <mi>h</mi>&#13;
    <mo>+</mo>&#13;
    <mi>t</mi>&#13;
  </mrow>&#13;
</math> where <math alttext="h">&#13;
  <mi>h</mi>&#13;
</math> stands for the number of heads observed during <math alttext="n">&#13;
  <mi>n</mi>&#13;
</math> rounds of betting and where <math alttext="t">&#13;
  <mi>t</mi>&#13;
</math> stands for the number of tails. With these definitions, the available capital after <math alttext="n">&#13;
  <mi>n</mi>&#13;
</math> rounds is the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="c Subscript n Baseline equals c 0 dot left-parenthesis 1 plus f right-parenthesis Superscript h Baseline dot left-parenthesis 1 minus f right-parenthesis Superscript t" display="block">&#13;
  <mrow>&#13;
    <msub><mi>c</mi> <mi>n</mi> </msub>&#13;
    <mo>=</mo>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi>f</mi><mo>)</mo></mrow> <mi>h</mi> </msup>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mrow><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow> <mi>t</mi> </msup>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before">In such a context, long-term wealth maximization boils down to maximizing the average geometric growth rate per bet which is given as follows:</p>&#13;
<div data-type="equation">&#13;
<math alttext="StartLayout 1st Row 1st Column r Superscript g 2nd Column equals log left-parenthesis StartFraction c Subscript n Baseline Over c 0 EndFraction right-parenthesis Superscript 1 slash n Baseline 2nd Row 1st Column Blank 2nd Column equals log left-parenthesis StartFraction c 0 dot left-parenthesis 1 plus f right-parenthesis Superscript h Baseline dot left-parenthesis 1 minus f right-parenthesis Superscript t Baseline Over c 0 EndFraction right-parenthesis Superscript 1 slash n Baseline 3rd Row 1st Column Blank 2nd Column equals log left-parenthesis left-parenthesis 1 plus f right-parenthesis Superscript h Baseline dot left-parenthesis 1 minus f right-parenthesis Superscript t Baseline right-parenthesis Superscript 1 slash n Baseline 4th Row 1st Column Blank 2nd Column equals StartFraction h Over n EndFraction log left-parenthesis 1 plus f right-parenthesis plus StartFraction t Over n EndFraction log left-parenthesis 1 minus f right-parenthesis EndLayout" display="block">&#13;
  <mtable displaystyle="true">&#13;
    <mtr>&#13;
      <mtd columnalign="right">&#13;
        <msup><mi>r</mi> <mi>g</mi> </msup>&#13;
      </mtd>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mo form="prefix">log</mo>&#13;
          <msup><mfenced close=")" open="(" separators=""><mfrac><msub><mi>c</mi> <mi>n</mi> </msub> <msub><mi>c</mi> <mn>0</mn> </msub></mfrac></mfenced> <mrow><mn>1</mn><mo>/</mo><mi>n</mi></mrow> </msup>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mo form="prefix">log</mo>&#13;
          <msup><mfenced close=")" open="(" separators=""><mfrac><mrow><msub><mi>c</mi> <mn>0</mn> </msub><mo>¬∑</mo><msup><mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi>f</mi><mo>)</mo></mrow> <mi>h</mi> </msup><mo>¬∑</mo><msup><mrow><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow> <mi>t</mi> </msup></mrow> <msub><mi>c</mi> <mn>0</mn> </msub></mfrac></mfenced> <mrow><mn>1</mn><mo>/</mo><mi>n</mi></mrow> </msup>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mo form="prefix">log</mo>&#13;
          <msup><mfenced close=")" open="(" separators=""><msup><mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi>f</mi><mo>)</mo></mrow> <mi>h</mi> </msup><mo>¬∑</mo><msup><mrow><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow> <mi>t</mi> </msup></mfenced> <mrow><mn>1</mn><mo>/</mo><mi>n</mi></mrow> </msup>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mi>h</mi> <mi>n</mi></mfrac>&#13;
          <mo form="prefix">log</mo>&#13;
          <mrow>&#13;
            <mo>(</mo>&#13;
            <mn>1</mn>&#13;
            <mo>+</mo>&#13;
            <mi>f</mi>&#13;
            <mo>)</mo>&#13;
          </mrow>&#13;
          <mo>+</mo>&#13;
          <mfrac><mi>t</mi> <mi>n</mi></mfrac>&#13;
          <mo form="prefix">log</mo>&#13;
          <mrow>&#13;
            <mo>(</mo>&#13;
            <mn>1</mn>&#13;
            <mo>-</mo>&#13;
            <mi>f</mi>&#13;
            <mo>)</mo>&#13;
          </mrow>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
  </mtable>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>The problem then formally is to maximize the <em>expected</em> average rate of growth by choosing <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math> optimally. With <math alttext="bold upper E left-parenthesis h right-parenthesis equals n dot p">&#13;
  <mrow>&#13;
    <mi>ùêÑ</mi>&#13;
    <mo>(</mo>&#13;
    <mi>h</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>n</mi>&#13;
    <mo>¬∑</mo>&#13;
    <mi>p</mi>&#13;
  </mrow>&#13;
</math> and <math alttext="bold upper E left-parenthesis t right-parenthesis equals n dot q">&#13;
  <mrow>&#13;
    <mi>ùêÑ</mi>&#13;
    <mo>(</mo>&#13;
    <mi>t</mi>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>n</mi>&#13;
    <mo>¬∑</mo>&#13;
    <mi>q</mi>&#13;
  </mrow>&#13;
</math>, one gets:</p>&#13;
<div data-type="equation">&#13;
<math alttext="StartLayout 1st Row 1st Column bold upper E left-parenthesis r Superscript g Baseline right-parenthesis 2nd Column equals bold upper E left-parenthesis StartFraction h Over n EndFraction log left-parenthesis 1 plus f right-parenthesis plus StartFraction t Over n EndFraction log left-parenthesis 1 minus f right-parenthesis right-parenthesis 2nd Row 1st Column Blank 2nd Column equals bold upper E left-parenthesis p log left-parenthesis 1 plus f right-parenthesis plus q log left-parenthesis 1 minus f right-parenthesis right-parenthesis 3rd Row 1st Column Blank 2nd Column equals p log left-parenthesis 1 plus f right-parenthesis plus q log left-parenthesis 1 minus f right-parenthesis 4th Row 1st Column Blank 2nd Column identical-to upper G left-parenthesis f right-parenthesis EndLayout" display="block">&#13;
  <mtable displaystyle="true">&#13;
    <mtr>&#13;
      <mtd columnalign="right">&#13;
        <mrow>&#13;
          <mi>ùêÑ</mi>&#13;
          <mo>(</mo>&#13;
          <msup><mi>r</mi> <mi>g</mi> </msup>&#13;
          <mo>)</mo>&#13;
        </mrow>&#13;
      </mtd>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mi>ùêÑ</mi>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <mfrac><mi>h</mi> <mi>n</mi></mfrac>&#13;
            <mo form="prefix">log</mo>&#13;
            <mrow>&#13;
              <mo>(</mo>&#13;
              <mn>1</mn>&#13;
              <mo>+</mo>&#13;
              <mi>f</mi>&#13;
              <mo>)</mo>&#13;
            </mrow>&#13;
            <mo>+</mo>&#13;
            <mfrac><mi>t</mi> <mi>n</mi></mfrac>&#13;
            <mo form="prefix">log</mo>&#13;
            <mrow>&#13;
              <mo>(</mo>&#13;
              <mn>1</mn>&#13;
              <mo>-</mo>&#13;
              <mi>f</mi>&#13;
              <mo>)</mo>&#13;
            </mrow>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mi>ùêÑ</mi>&#13;
          <mo>(</mo>&#13;
          <mi>p</mi>&#13;
          <mo form="prefix">log</mo>&#13;
          <mo>(</mo>&#13;
          <mn>1</mn>&#13;
          <mo>+</mo>&#13;
          <mi>f</mi>&#13;
          <mo>)</mo>&#13;
          <mo>+</mo>&#13;
          <mi>q</mi>&#13;
          <mo form="prefix">log</mo>&#13;
          <mo>(</mo>&#13;
          <mn>1</mn>&#13;
          <mo>-</mo>&#13;
          <mi>f</mi>&#13;
          <mo>)</mo>&#13;
          <mo>)</mo>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mi>p</mi>&#13;
          <mo form="prefix">log</mo>&#13;
          <mo>(</mo>&#13;
          <mn>1</mn>&#13;
          <mo>+</mo>&#13;
          <mi>f</mi>&#13;
          <mo>)</mo>&#13;
          <mo>+</mo>&#13;
          <mi>q</mi>&#13;
          <mo form="prefix">log</mo>&#13;
          <mo>(</mo>&#13;
          <mn>1</mn>&#13;
          <mo>-</mo>&#13;
          <mi>f</mi>&#13;
          <mo>)</mo>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>‚â°</mo>&#13;
          <mi>G</mi>&#13;
          <mo>(</mo>&#13;
          <mi>f</mi>&#13;
          <mo>)</mo>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
  </mtable>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>One can now maximize the term by choosing the optimal fraction <math alttext="f Superscript asterisk">&#13;
  <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
</math> according to the first order condition. The first derivative is given by the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="StartLayout 1st Row 1st Column upper G prime left-parenthesis f right-parenthesis 2nd Column equals StartFraction p Over 1 plus f EndFraction minus StartFraction q Over 1 minus f EndFraction 2nd Row 1st Column Blank 2nd Column equals StartFraction p minus p f minus q minus q f Over left-parenthesis 1 plus f right-parenthesis left-parenthesis 1 minus f right-parenthesis EndFraction 3rd Row 1st Column Blank 2nd Column equals StartFraction p minus q minus f Over left-parenthesis 1 plus f right-parenthesis left-parenthesis 1 minus f right-parenthesis EndFraction EndLayout" display="block">&#13;
  <mtable displaystyle="true">&#13;
    <mtr>&#13;
      <mtd columnalign="right">&#13;
        <mrow>&#13;
          <msup><mi>G</mi> <mo>'</mo> </msup>&#13;
          <mrow>&#13;
            <mo>(</mo>&#13;
            <mi>f</mi>&#13;
            <mo>)</mo>&#13;
          </mrow>&#13;
        </mrow>&#13;
      </mtd>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mi>p</mi> <mrow><mn>1</mn><mo>+</mo><mi>f</mi></mrow></mfrac>&#13;
          <mo>-</mo>&#13;
          <mfrac><mi>q</mi> <mrow><mn>1</mn><mo>-</mo><mi>f</mi></mrow></mfrac>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mrow><mi>p</mi><mo>-</mo><mi>p</mi><mi>f</mi><mo>-</mo><mi>q</mi><mo>-</mo><mi>q</mi><mi>f</mi></mrow> <mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi>f</mi><mo>)</mo><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow></mfrac>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mrow><mi>p</mi><mo>-</mo><mi>q</mi><mo>-</mo><mi>f</mi></mrow> <mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi>f</mi><mo>)</mo><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow></mfrac>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
  </mtable>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>From the first order condition, one gets the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper G prime left-parenthesis f right-parenthesis ModifyingAbove equals With factorial 0 right double arrow f Superscript asterisk Baseline equals p minus q" display="block">&#13;
  <mrow>&#13;
    <msup><mi>G</mi> <mo>'</mo> </msup>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mover accent="true"><mo>=</mo> <mo>!</mo></mover>&#13;
    <mn>0</mn>&#13;
    <mo>‚áí</mo>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
    <mo>=</mo>&#13;
    <mi>p</mi>&#13;
    <mo>-</mo>&#13;
    <mi>q</mi>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>If one trusts this to be the maximum (and not the minimum), this result implies that it is optimal to invest a fraction <math alttext="f Superscript asterisk Baseline equals p minus q">&#13;
  <mrow>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
    <mo>=</mo>&#13;
    <mi>p</mi>&#13;
    <mo>-</mo>&#13;
    <mi>q</mi>&#13;
  </mrow>&#13;
</math> per round of betting. With, for example, <math alttext="p equals">&#13;
  <mrow>&#13;
    <mi>p</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math> 0.55, one has <math alttext="f Superscript asterisk Baseline equals">&#13;
  <mrow>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math> 0.55 - 0.45 = 0.1, or that the optimal fraction is 10%.</p>&#13;
&#13;
<p>The following Python code formalizes these concepts and results through simulation. First, some imports and configurations:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">math</code>&#13;
        <code class="kn">import</code> <code class="nn">time</code>&#13;
        <code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
        <code class="kn">import</code> <code class="nn">datetime</code> <code class="kn">as</code> <code class="nn">dt</code>&#13;
        <code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">plt</code><code class="p">,</code> <code class="n">mpl</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>&#13;
        <code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>&#13;
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'savefig.dpi'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">300</code>&#13;
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code></pre>&#13;
&#13;
<p>The idea is to simulate, for example, 50 series with 100 coin tosses per series. The Python code for this is straightforward:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.55</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO1-1" id="co_automating_trading_operations_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">f</code><code> </code><code class="o">=</code><code> </code><code class="n">p</code><code> </code><code class="o">-</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">p</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO1-2" id="co_automating_trading_operations_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">f</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO1-2" id="co_automating_trading_operations_CO1-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.10000000000000009</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">6</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">I</code><code> </code><code class="o">=</code><code> </code><code class="mi">50</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO1-3" id="co_automating_trading_operations_CO1-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">7</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">n</code><code> </code><code class="o">=</code><code> </code><code class="mi">100</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO1-4" id="co_automating_trading_operations_CO1-5"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO1-1" id="callout_automating_trading_operations_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Fixes the probability for heads.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO1-2" id="callout_automating_trading_operations_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the optimal fraction according to the Kelly criterion.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO1-4" id="callout_automating_trading_operations_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The number of series to be simulated.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO1-5" id="callout_automating_trading_operations_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The number of trials per series.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary=".run_simulation() method" data-primary-sortas="run_simulation" data-type="indexterm" id="idm45785342658296"/>The major part is the Python function <code>run_simulation()</code>, which achieves the simulation according to the preceding assumptions. <a data-type="xref" href="#auto_plot_01">Figure¬†10-1</a> shows the simulation results:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">run_simulation</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="n">c</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">zeros</code><code class="p">(</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">I</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-1" id="co_automating_trading_operations_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>            </code><code class="n">c</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">100</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-2" id="co_automating_trading_operations_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>            </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">I</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-3" id="co_automating_trading_operations_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                </code><code class="k">for</code><code> </code><code class="n">t</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">n</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-4" id="co_automating_trading_operations_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                    </code><code class="n">o</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">binomial</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">p</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-5" id="co_automating_trading_operations_CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                    </code><code class="k">if</code><code> </code><code class="n">o</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-6" id="co_automating_trading_operations_CO2-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>                        </code><code class="n">c</code><code class="p">[</code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="n">f</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">c</code><code class="p">[</code><code class="n">t</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-7" id="co_automating_trading_operations_CO2-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                    </code><code class="k">else</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-8" id="co_automating_trading_operations_CO2-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>                        </code><code class="n">c</code><code class="p">[</code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="n">f</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">c</code><code class="p">[</code><code class="n">t</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">i</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-9" id="co_automating_trading_operations_CO2-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="n">c</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">9</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">c_1</code><code> </code><code class="o">=</code><code> </code><code class="n">run_simulation</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-10" id="co_automating_trading_operations_CO2-10"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">c_1</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">10</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="p">[</code><code class="mf">100.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">100.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">100.</code><code>  </code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">100.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">100.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">100.</code><code>  </code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">90.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">110.</code><code>  </code><code class="p">,</code><code>  </code><code class="mf">90.</code><code>  </code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">110.</code><code>  </code><code class="p">,</code><code>  </code><code class="mf">90.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">110.</code><code>  </code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code> </code><code class="mf">99.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">121.</code><code>  </code><code class="p">,</code><code>  </code><code class="mf">99.</code><code>  </code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">121.</code><code>  </code><code class="p">,</code><code>  </code><code class="mf">81.</code><code>  </code><code class="p">,</code><code> </code><code class="mf">121.</code><code>  </code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code class="mf">226.35</code><code class="p">,</code><code> </code><code class="mf">338.13</code><code class="p">,</code><code> </code><code class="mf">413.27</code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">123.97</code><code class="p">,</code><code> </code><code class="mf">123.97</code><code class="p">,</code><code> </code><code class="mf">123.97</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code class="mf">248.99</code><code class="p">,</code><code> </code><code class="mf">371.94</code><code class="p">,</code><code> </code><code class="mf">454.6</code><code> </code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">136.37</code><code class="p">,</code><code> </code><code class="mf">136.37</code><code class="p">,</code><code> </code><code class="mf">136.37</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">[</code><code class="mf">273.89</code><code class="p">,</code><code> </code><code class="mf">409.14</code><code class="p">,</code><code> </code><code class="mf">409.14</code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="mf">122.73</code><code class="p">,</code><code> </code><code class="mf">150.01</code><code class="p">,</code><code> </code><code class="mf">122.73</code><code class="p">]</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">11</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_1</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lw</code><code class="o">=</code><code class="mf">0.5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-11" id="co_automating_trading_operations_CO2-11"><img alt="11" src="assets/11.png"/></a><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_1</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">lw</code><code class="o">=</code><code class="mf">2.5</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO2-12" id="co_automating_trading_operations_CO2-12"><img alt="12" src="assets/12.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-1" id="callout_automating_trading_operations_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates an <code>ndarray</code> object to store the simulation results.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-2" id="callout_automating_trading_operations_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Initializes the starting capital with 100.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-3" id="callout_automating_trading_operations_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Outer loop for the series simulations.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-4" id="callout_automating_trading_operations_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Inner loop for the series itself.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-5" id="callout_automating_trading_operations_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Simulates the tossing of a coin.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-6" id="callout_automating_trading_operations_CO2-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>If <code>1</code> or heads‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-7" id="callout_automating_trading_operations_CO2-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>‚Ä¶then add the win to the capital.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-8" id="callout_automating_trading_operations_CO2-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>If <code>0</code> or tails‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-9" id="callout_automating_trading_operations_CO2-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>‚Ä¶subtract the loss from the capital.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-10" id="callout_automating_trading_operations_CO2-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>This runs the simulation.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-11" id="callout_automating_trading_operations_CO2-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Plots all 50 series.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO2-12" id="callout_automating_trading_operations_CO2-12"><img alt="12" src="assets/12.png"/></a></dt>&#13;
<dd><p>Plots the average over all 50 series.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_01">&#13;
<img alt="pfat 1001" src="assets/pfat_1001.png"/>&#13;
<h6><span class="label">Figure 10-1. </span>50 simulated series with 100 trials each (red line = average)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The following code repeats the simulation for different values of <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math>. As shown in <a data-type="xref" href="#auto_plot_02">Figure¬†10-2</a>, a lower fraction leads to a lower growth rate on average. Higher values might lead both to a higher average capital at the end of the simulation (<math alttext="f equals">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math>0.25) or lead to a much lower average capital (<math alttext="f equals">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math>0.5]). In both cases where the fraction <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math> is higher, the volatility increases considerably:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">12</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">c_2</code><code> </code><code class="o">=</code><code> </code><code class="n">run_simulation</code><code class="p">(</code><code class="mf">0.05</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO3-1" id="co_automating_trading_operations_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">13</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">c_3</code><code> </code><code class="o">=</code><code> </code><code class="n">run_simulation</code><code class="p">(</code><code class="mf">0.25</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO3-2" id="co_automating_trading_operations_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">c_4</code><code> </code><code class="o">=</code><code> </code><code class="n">run_simulation</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO3-3" id="co_automating_trading_operations_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_1</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$f^*=0.1$</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_2</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">b</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$f=0.05$</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_3</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">y</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$f=0.25$</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">c_4</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">m</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">$f=0.5$</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO3-1" id="callout_automating_trading_operations_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Simulation with <math alttext="f equals">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math> 0.05.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO3-2" id="callout_automating_trading_operations_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Simulation with <math alttext="f equals">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math> 0.25.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO3-3" id="callout_automating_trading_operations_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Simulation with <math alttext="f equals">&#13;
  <mrow>&#13;
    <mi>f</mi>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math> 0.5.<a data-startref="ix_10_automated_trading_-asciidoc4" data-type="indexterm" id="idm45785342253640"/><a data-startref="ix_10_automated_trading_-asciidoc3" data-type="indexterm" id="idm45785342252936"/></p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_02">&#13;
<img alt="pfat 1002" src="assets/pfat_1002.png"/>&#13;
<h6><span class="label">Figure 10-2. </span>Average capital over time for different values of <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math></h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kelly Criterion for Stocks and Indices" data-type="sect2"><div class="sect2" id="idm45785345806152">&#13;
<h2>Kelly Criterion for Stocks and Indices</h2>&#13;
&#13;
<p><a data-primary="capital management" data-secondary="Kelly criterion for stocks and indices" data-type="indexterm" id="ix_10_automated_trading_-asciidoc5"/><a data-primary="Kelly criterion" data-secondary="stocks and indices" data-type="indexterm" id="ix_10_automated_trading_-asciidoc6"/>Assume now a stock market setting in which the relevant stock (index) can take on only two values after a period of one year from today, given its known value today. The setting is again binomial but this time a bit closer on the modeling side to stock market realities.<sup><a data-type="noteref" href="ch10.html#idm45785342245112" id="idm45785342245112-marker">1</a></sup> Specifically, assume the following holds true:</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper P left-parenthesis r Superscript upper S Baseline equals mu plus sigma right-parenthesis equals upper P left-parenthesis r Superscript upper S Baseline equals mu minus sigma right-parenthesis equals one-half" display="block">&#13;
  <mrow>&#13;
    <mi>P</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <msup><mi>r</mi> <mi>S</mi> </msup>&#13;
      <mo>=</mo>&#13;
      <mi>Œº</mi>&#13;
      <mo>+</mo>&#13;
      <mi>œÉ</mi>&#13;
    </mfenced>&#13;
    <mo>=</mo>&#13;
    <mi>P</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <msup><mi>r</mi> <mi>S</mi> </msup>&#13;
      <mo>=</mo>&#13;
      <mi>Œº</mi>&#13;
      <mo>-</mo>&#13;
      <mi>œÉ</mi>&#13;
    </mfenced>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Here, <math alttext="bold upper E left-parenthesis r Superscript upper S Baseline right-parenthesis equals mu greater-than 0">&#13;
  <mrow>&#13;
    <mi>ùêÑ</mi>&#13;
    <mo>(</mo>&#13;
    <msup><mi>r</mi> <mi>S</mi> </msup>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
    <mi>Œº</mi>&#13;
    <mo>&gt;</mo>&#13;
    <mn>0</mn>&#13;
  </mrow>&#13;
</math> is the the expected return of the stock over one year, and <math alttext="sigma greater-than 0">&#13;
  <mrow>&#13;
    <mi>œÉ</mi>&#13;
    <mo>&gt;</mo>&#13;
    <mn>0</mn>&#13;
  </mrow>&#13;
</math> is the standard deviation of returns (volatility). In a one-period setting, one gets the following for the available capital after one year (with <math alttext="c 0">&#13;
  <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
</math> and <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math> defined as before):</p>&#13;
<div data-type="equation">&#13;
<math alttext="c left-parenthesis f right-parenthesis equals c 0 dot left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot r plus f dot r Superscript upper S Baseline right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <mi>c</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>¬∑</mo>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <mn>1</mn>&#13;
      <mo>+</mo>&#13;
      <mrow>&#13;
        <mo>(</mo>&#13;
        <mn>1</mn>&#13;
        <mo>-</mo>&#13;
        <mi>f</mi>&#13;
        <mo>)</mo>&#13;
      </mrow>&#13;
      <mo>¬∑</mo>&#13;
      <mi>r</mi>&#13;
      <mo>+</mo>&#13;
      <mi>f</mi>&#13;
      <mo>¬∑</mo>&#13;
      <msup><mi>r</mi> <mi>S</mi> </msup>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before">Here, <math alttext="r">&#13;
  <mi>r</mi>&#13;
</math> is the constant short rate earned on cash not invested in the stock. Maximizing the geometric growth rate means maximizing the term:</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper G left-parenthesis f right-parenthesis equals bold upper E left-parenthesis log StartFraction c left-parenthesis f right-parenthesis Over c 0 EndFraction right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <mi>G</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <mi>ùêÑ</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <mo form="prefix">log</mo>&#13;
      <mfrac><mrow><mi>c</mi><mo>(</mo><mi>f</mi><mo>)</mo></mrow> <msub><mi>c</mi> <mn>0</mn> </msub></mfrac>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Assume now that there are <math alttext="n">&#13;
  <mi>n</mi>&#13;
</math> relevant trading days in the year so that for each such trading day <math alttext="i">&#13;
  <mi>i</mi>&#13;
</math> the following holds true:</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper P left-parenthesis r Subscript i Superscript upper S Baseline equals StartFraction mu Over n EndFraction plus StartFraction sigma Over StartRoot n EndRoot EndFraction right-parenthesis equals upper P left-parenthesis r Subscript i Superscript upper S Baseline equals StartFraction mu Over n EndFraction minus StartFraction sigma Over StartRoot n EndRoot EndFraction right-parenthesis equals one-half" display="block">&#13;
  <mrow>&#13;
    <mi>P</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <msubsup><mi>r</mi> <mi>i</mi> <mi>S</mi> </msubsup>&#13;
      <mo>=</mo>&#13;
      <mfrac><mi>Œº</mi> <mi>n</mi></mfrac>&#13;
      <mo>+</mo>&#13;
      <mfrac><mi>œÉ</mi> <msqrt><mi>n</mi></msqrt></mfrac>&#13;
    </mfenced>&#13;
    <mo>=</mo>&#13;
    <mi>P</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <msubsup><mi>r</mi> <mi>i</mi> <mi>S</mi> </msubsup>&#13;
      <mo>=</mo>&#13;
      <mfrac><mi>Œº</mi> <mi>n</mi></mfrac>&#13;
      <mo>-</mo>&#13;
      <mfrac><mi>œÉ</mi> <msqrt><mi>n</mi></msqrt></mfrac>&#13;
    </mfenced>&#13;
    <mo>=</mo>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Note that volatility scales with the square root of the number of trading days. Under these assumptions, the daily values scale up to the yearly ones from before and one gets the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="c Subscript n Baseline left-parenthesis f right-parenthesis equals c 0 dot product Underscript i equals 1 Overscript n Endscripts left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot StartFraction r Over n EndFraction plus f dot r Subscript i Superscript upper S Baseline right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <msub><mi>c</mi> <mi>n</mi> </msub>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <msub><mi>c</mi> <mn>0</mn> </msub>&#13;
    <mo>¬∑</mo>&#13;
    <munderover><mo>‚àè</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </munderover>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <mn>1</mn>&#13;
      <mo>+</mo>&#13;
      <mrow>&#13;
        <mo>(</mo>&#13;
        <mn>1</mn>&#13;
        <mo>-</mo>&#13;
        <mi>f</mi>&#13;
        <mo>)</mo>&#13;
      </mrow>&#13;
      <mo>¬∑</mo>&#13;
      <mfrac><mi>r</mi> <mi>n</mi></mfrac>&#13;
      <mo>+</mo>&#13;
      <mi>f</mi>&#13;
      <mo>¬∑</mo>&#13;
      <msubsup><mi>r</mi> <mi>i</mi> <mi>S</mi> </msubsup>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>One now has to maximize the following quantity to achieve maximum long-term wealth when investing in the stock:</p>&#13;
<div data-type="equation">&#13;
<math alttext="StartLayout 1st Row 1st Column upper G Subscript n Baseline left-parenthesis f right-parenthesis 2nd Column equals bold upper E left-parenthesis log StartFraction c Subscript n Baseline left-parenthesis f right-parenthesis Over c 0 EndFraction right-parenthesis 2nd Row 1st Column Blank 2nd Column equals bold upper E left-parenthesis sigma-summation Underscript i equals 1 Overscript n Endscripts log left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot StartFraction r Over n EndFraction plus f dot r Subscript i Superscript upper S Baseline right-parenthesis right-parenthesis 3rd Row 1st Column Blank 2nd Column equals one-half sigma-summation Underscript i equals 1 Overscript n Endscripts log left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot StartFraction r Over n EndFraction plus f dot left-parenthesis StartFraction mu Over n EndFraction plus StartFraction sigma Over StartRoot n EndRoot EndFraction right-parenthesis right-parenthesis 4th Row 1st Column Blank 2nd Column plus log left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot StartFraction r Over n EndFraction plus f dot left-parenthesis StartFraction mu Over n EndFraction minus StartFraction sigma Over StartRoot n EndRoot EndFraction right-parenthesis right-parenthesis 5th Row 1st Column Blank 2nd Column equals StartFraction n Over 2 EndFraction log left-parenthesis left-parenthesis 1 plus left-parenthesis 1 minus f right-parenthesis dot StartFraction r Over n EndFraction plus f dot StartFraction mu Over n EndFraction right-parenthesis squared minus StartFraction f squared sigma squared Over n EndFraction right-parenthesis EndLayout" display="block">&#13;
  <mtable displaystyle="true">&#13;
    <mtr>&#13;
      <mtd columnalign="right">&#13;
        <mrow>&#13;
          <msub><mi>G</mi> <mi>n</mi> </msub>&#13;
          <mrow>&#13;
            <mo>(</mo>&#13;
            <mi>f</mi>&#13;
            <mo>)</mo>&#13;
          </mrow>&#13;
        </mrow>&#13;
      </mtd>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mi>ùêÑ</mi>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <mo form="prefix">log</mo>&#13;
            <mfrac><mrow><msub><mi>c</mi> <mi>n</mi> </msub><mrow><mo>(</mo><mi>f</mi><mo>)</mo></mrow></mrow> <msub><mi>c</mi> <mn>0</mn> </msub></mfrac>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mi>ùêÑ</mi>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <munderover><mo>‚àë</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </munderover>&#13;
            <mo form="prefix">log</mo>&#13;
            <mfenced close=")" open="(" separators="">&#13;
              <mn>1</mn>&#13;
              <mo>+</mo>&#13;
              <mrow>&#13;
                <mo>(</mo>&#13;
                <mn>1</mn>&#13;
                <mo>-</mo>&#13;
                <mi>f</mi>&#13;
                <mo>)</mo>&#13;
              </mrow>&#13;
              <mo>¬∑</mo>&#13;
              <mfrac><mi>r</mi> <mi>n</mi></mfrac>&#13;
              <mo>+</mo>&#13;
              <mi>f</mi>&#13;
              <mo>¬∑</mo>&#13;
              <msubsup><mi>r</mi> <mi>i</mi> <mi>S</mi> </msubsup>&#13;
            </mfenced>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
          <munderover><mo>‚àë</mo> <mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow> <mi>n</mi> </munderover>&#13;
          <mo form="prefix">log</mo>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <mn>1</mn>&#13;
            <mo>+</mo>&#13;
            <mrow>&#13;
              <mo>(</mo>&#13;
              <mn>1</mn>&#13;
              <mo>-</mo>&#13;
              <mi>f</mi>&#13;
              <mo>)</mo>&#13;
            </mrow>&#13;
            <mo>¬∑</mo>&#13;
            <mfrac><mi>r</mi> <mi>n</mi></mfrac>&#13;
            <mo>+</mo>&#13;
            <mi>f</mi>&#13;
            <mo>¬∑</mo>&#13;
            <mfenced close=")" open="(" separators="">&#13;
              <mfrac><mi>Œº</mi> <mi>n</mi></mfrac>&#13;
              <mo>+</mo>&#13;
              <mfrac><mi>œÉ</mi> <msqrt><mi>n</mi></msqrt></mfrac>&#13;
            </mfenced>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>+</mo>&#13;
          <mo form="prefix">log</mo>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <mn>1</mn>&#13;
            <mo>+</mo>&#13;
            <mrow>&#13;
              <mo>(</mo>&#13;
              <mn>1</mn>&#13;
              <mo>-</mo>&#13;
              <mi>f</mi>&#13;
              <mo>)</mo>&#13;
            </mrow>&#13;
            <mo>¬∑</mo>&#13;
            <mfrac><mi>r</mi> <mi>n</mi></mfrac>&#13;
            <mo>+</mo>&#13;
            <mi>f</mi>&#13;
            <mo>¬∑</mo>&#13;
            <mfenced close=")" open="(" separators="">&#13;
              <mfrac><mi>Œº</mi> <mi>n</mi></mfrac>&#13;
              <mo>-</mo>&#13;
              <mfrac><mi>œÉ</mi> <msqrt><mi>n</mi></msqrt></mfrac>&#13;
            </mfenced>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
    <mtr>&#13;
      <mtd/>&#13;
      <mtd columnalign="left">&#13;
        <mrow>&#13;
          <mo>=</mo>&#13;
          <mfrac><mi>n</mi> <mn>2</mn></mfrac>&#13;
          <mo form="prefix">log</mo>&#13;
          <mfenced close=")" open="(" separators="">&#13;
            <msup><mfenced close=")" open="(" separators=""><mn>1</mn><mo>+</mo><mrow><mo>(</mo><mn>1</mn><mo>-</mo><mi>f</mi><mo>)</mo></mrow><mo>¬∑</mo><mfrac><mi>r</mi> <mi>n</mi></mfrac><mo>+</mo><mi>f</mi><mo>¬∑</mo><mfrac><mi>Œº</mi> <mi>n</mi></mfrac></mfenced> <mn>2</mn> </msup>&#13;
            <mo>-</mo>&#13;
            <mfrac><mrow><msup><mi>f</mi> <mn>2</mn> </msup><msup><mi>œÉ</mi> <mn>2</mn> </msup></mrow> <mi>n</mi></mfrac>&#13;
          </mfenced>&#13;
        </mrow>&#13;
      </mtd>&#13;
    </mtr>&#13;
  </mtable>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Using a <a href="https://oreil.ly/xX4tA">Taylor series expansion</a>, one finally arrives at the &#13;
<span class="keep-together">following:</span></p>&#13;
<div data-type="equation">&#13;
<math alttext="upper G Subscript n Baseline left-parenthesis f right-parenthesis equals r plus left-parenthesis mu minus r right-parenthesis dot f minus StartFraction sigma squared Over 2 EndFraction dot f squared plus script upper O left-parenthesis StartFraction 1 Over StartRoot n EndRoot EndFraction right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <msub><mi>G</mi> <mi>n</mi> </msub>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <mi>r</mi>&#13;
    <mo>+</mo>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>Œº</mi>&#13;
      <mo>-</mo>&#13;
      <mi>r</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>¬∑</mo>&#13;
    <mi>f</mi>&#13;
    <mo>-</mo>&#13;
    <mfrac><msup><mi>œÉ</mi> <mn>2</mn> </msup> <mn>2</mn></mfrac>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mi>f</mi> <mn>2</mn> </msup>&#13;
    <mo>+</mo>&#13;
    <mi>ùí™</mi>&#13;
    <mfenced close=")" open="(" separators="">&#13;
      <mfrac><mn>1</mn> <msqrt><mi>n</mi></msqrt></mfrac>&#13;
    </mfenced>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Or for infinitely many trading points in time (that is, for continuous trading), one arrives at the following:</p>&#13;
<div data-type="equation">&#13;
<math alttext="upper G Subscript normal infinity Baseline left-parenthesis f right-parenthesis equals r plus left-parenthesis mu minus r right-parenthesis dot f minus StartFraction sigma squared Over 2 EndFraction dot f squared" display="block">&#13;
  <mrow>&#13;
    <msub><mi>G</mi> <mi>‚àû</mi> </msub>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>f</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <mi>r</mi>&#13;
    <mo>+</mo>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>Œº</mi>&#13;
      <mo>-</mo>&#13;
      <mi>r</mi>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>¬∑</mo>&#13;
    <mi>f</mi>&#13;
    <mo>-</mo>&#13;
    <mfrac><msup><mi>œÉ</mi> <mn>2</mn> </msup> <mn>2</mn></mfrac>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mi>f</mi> <mn>2</mn> </msup>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>The optimal fraction <math alttext="f Superscript asterisk">&#13;
  <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
</math> then is given through the first order condition by the following expression:</p>&#13;
<div data-type="equation">&#13;
<math alttext="f Superscript asterisk Baseline equals StartFraction mu minus r Over sigma squared EndFraction" display="block">&#13;
  <mrow>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
    <mo>=</mo>&#13;
    <mfrac><mrow><mi>Œº</mi><mo>-</mo><mi>r</mi></mrow> <msup><mi>œÉ</mi> <mn>2</mn> </msup></mfrac>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>This represents the expected excess return of the stock over the risk-free rate divided by the variance of the returns. This expression looks similar to the Sharpe ratio but is different.</p>&#13;
&#13;
<p>A real-world example shall illustrate the application of the preceding formula and its role in leveraging equity deployed to trading strategies. <a data-primary="S&amp;P 500" data-secondary="passive long position in" data-type="indexterm" id="ix_10_automated_trading_-asciidoc7"/>The trading strategy under consideration is simply a <em>passive long position in the S&amp;P 500 index</em>. To this end, base data is quickly retrieved and required statistics are easily derived:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">16</code><code class="p">]:</code> <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                           <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">17</code><code class="p">]:</code> <code class="n">symbol</code> <code class="o">=</code> <code class="s1">'.SPX'</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">18</code><code class="p">]:</code> <code class="n">data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="n">symbol</code><code class="p">])</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">19</code><code class="p">]:</code> <code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code> <code class="o">/</code> <code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">20</code><code class="p">]:</code> <code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">21</code><code class="p">]:</code> <code class="n">data</code><code class="o">.</code><code class="n">tail</code><code class="p">()</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">21</code><code class="p">]:</code>                <code class="o">.</code><code class="n">SPX</code>    <code class="k">return</code>&#13;
         <code class="n">Date</code>&#13;
         <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">23</code>  <code class="mf">3224.01</code>  <code class="mf">0.000866</code>&#13;
         <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code>  <code class="mf">3223.38</code> <code class="o">-</code><code class="mf">0.000195</code>&#13;
         <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code>  <code class="mf">3240.02</code>  <code class="mf">0.000034</code>&#13;
         <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code>  <code class="mf">3221.29</code> <code class="o">-</code><code class="mf">0.005798</code>&#13;
         <code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code>  <code class="mf">3230.78</code>  <code class="mf">0.002942</code></pre>&#13;
&#13;
<p>The statistical properties of the S&amp;P 500 index over the period covered suggest an optimal fraction of about 4.5 to be invested in the long position in the index. In other words, for every dollar available, 4.5 dollars shall be invested, implying a <em>leverage ratio</em> of 4.5 in accordance with the optimal Kelly fraction or, in this case, the optimal Kelly <em>factor</em>.</p>&#13;
&#13;
<p class="pagebreak-before">Everything being equal, the Kelly criterion implies a higher leverage when the expected return is higher and the volatility (variance) is lower:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">22</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-1" id="co_automating_trading_operations_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-1" id="co_automating_trading_operations_CO4-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">23</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.09992181916534204</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">24</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sigma</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">252</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-2" id="co_automating_trading_operations_CO4-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">sigma</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-2" id="co_automating_trading_operations_CO4-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.14761569775486563</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">26</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.0</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-3" id="co_automating_trading_operations_CO4-5"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">27</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">f</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">mu</code><code> </code><code class="o">-</code><code> </code><code class="n">r</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">sigma</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code> </code><a class="co" href="#callout_automating_trading_operations_CO4-4" id="co_automating_trading_operations_CO4-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">f</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO4-4" id="co_automating_trading_operations_CO4-7"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">28</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">4.585590244019818</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO4-1" id="callout_automating_trading_operations_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Calculates the annualized return.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO4-3" id="callout_automating_trading_operations_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the annualized volatility.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO4-5" id="callout_automating_trading_operations_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Sets the risk-free rate to 0 (for simplicity).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO4-6" id="callout_automating_trading_operations_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculates the optimal Kelly fraction to be invested in the strategy.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The following Python code simulates the application of the Kelly criterion and the optimal leverage ratio. For simplicity and comparison reasons, the initial equity is set to 1 while the initially invested total capital is set to <math alttext="1 dot f Superscript asterisk">&#13;
  <mrow>&#13;
    <mn>1</mn>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
  </mrow>&#13;
</math>. Depending on the performance of the capital deployed to the strategy, the total capital itself is adjusted daily according to the available equity. After a loss, the capital is reduced; after a profit, the capital is increased. The evolution of the equity position compared to the index itself is shown in <a data-type="xref" href="#auto_plot_03">Figure¬†10-3</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">equs</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">kelly_strategy</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">global</code><code> </code><code class="n">equs</code><code>&#13;
</code><code>             </code><code class="n">equ</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">equity_{:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">equs</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">equ</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">cap</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">capital_{:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="n">equ</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-1" id="co_automating_trading_operations_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">data</code><code class="p">[</code><code class="n">cap</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">equ</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">f</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-2" id="co_automating_trading_operations_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">i</code><code class="p">,</code><code> </code><code class="n">t</code><code> </code><code class="ow">in</code><code> </code><code class="nb">enumerate</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">t_1</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-3" id="co_automating_trading_operations_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                 </code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">cap</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">cap</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t_1</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code>\&#13;
</code><code>                                     </code><code class="n">math</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-4" id="co_automating_trading_operations_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                 </code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">equ</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">cap</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code>\&#13;
</code><code>                                     </code><code class="n">data</code><code class="p">[</code><code class="n">cap</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t_1</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code>\&#13;
</code><code>                                     </code><code class="n">data</code><code class="p">[</code><code class="n">equ</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t_1</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-5" id="co_automating_trading_operations_CO5-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                 </code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">cap</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">equ</code><code class="p">]</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="n">t</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">f</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-6" id="co_automating_trading_operations_CO5-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">kelly_strategy</code><code class="p">(</code><code class="n">f</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.5</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-7" id="co_automating_trading_operations_CO5-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">kelly_strategy</code><code class="p">(</code><code class="n">f</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.66</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-8" id="co_automating_trading_operations_CO5-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">kelly_strategy</code><code class="p">(</code><code class="n">f</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO5-9" id="co_automating_trading_operations_CO5-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">print</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="n">equs</code><code class="p">]</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                     </code><code class="n">equity_2</code><code class="o">.</code><code class="mi">29</code><code>  </code><code class="n">equity_3</code><code class="o">.</code><code class="mo">03</code><code>  </code><code class="n">equity_4</code><code class="o">.</code><code class="mi">59</code><code>&#13;
</code><code>         </code><code class="n">Date</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">23</code><code>     </code><code class="mf">6.628865</code><code>     </code><code class="mf">9.585294</code><code>    </code><code class="mf">14.205748</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">24</code><code>     </code><code class="mf">6.625895</code><code>     </code><code class="mf">9.579626</code><code>    </code><code class="mf">14.193019</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">27</code><code>     </code><code class="mf">6.626410</code><code>     </code><code class="mf">9.580610</code><code>    </code><code class="mf">14.195229</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">30</code><code>     </code><code class="mf">6.538582</code><code>     </code><code class="mf">9.412991</code><code>    </code><code class="mf">13.818934</code><code>&#13;
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code>     </code><code class="mf">6.582748</code><code>     </code><code class="mf">9.496919</code><code>    </code><code class="mf">14.005618</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ax</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="n">equs</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">,</code><code> </code><code class="n">legend</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-1" id="callout_automating_trading_operations_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Generates a new column for <code>equity</code> and sets the initial value to 1.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-2" id="callout_automating_trading_operations_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Generates a new column for <code>capital</code> and sets the initial value to <math alttext="1 dot f Superscript asterisk">&#13;
  <mrow>&#13;
    <mn>1</mn>&#13;
    <mo>¬∑</mo>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
  </mrow>&#13;
</math>.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-3" id="callout_automating_trading_operations_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Picks the right <code>DatetimeIndex</code> value for the previous values.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-4" id="callout_automating_trading_operations_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculates the new capital position given the return.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-5" id="callout_automating_trading_operations_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Adjusts the equity value according to the capital position performance.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-6" id="callout_automating_trading_operations_CO5-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Adjusts the capital position given the new equity position and the fixed leverage ratio.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-7" id="callout_automating_trading_operations_CO5-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Simulates the Kelly criterion based strategy for half of <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math>‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-8" id="callout_automating_trading_operations_CO5-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>‚Ä¶for two thirds of <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math>‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO5-9" id="callout_automating_trading_operations_CO5-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>‚Ä¶and <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math> itself.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_03">&#13;
<img alt="pfat 1003" src="assets/pfat_1003.png"/>&#13;
<h6><span class="label">Figure 10-3. </span>Gross performance of S&amp;P 500 compared to equity position given &#13;
<span class="keep-together">different</span> values of <math alttext="f">&#13;
  <mi>f</mi>&#13;
</math></h6>&#13;
</div></figure>&#13;
&#13;
<p>As <a data-type="xref" href="#auto_plot_03">Figure¬†10-3</a> illustrates, applying the optimal Kelly leverage leads to a rather erratic evolution of the equity position (high volatility), which is intuitively plausible, given the leverage ratio of 4.59. One would expect the volatility of the equity position to increase with increasing leverage.&#13;
Therefore, practitioners often do not use ‚Äúfull Kelly‚Äù (4.6), but rather ‚Äúhalf Kelly‚Äù (2.3). In the current example, this is reduced to:</p>&#13;
<div data-type="equation">&#13;
<math alttext="one-half dot f Superscript asterisk Baseline almost-equals 2.3" display="block">&#13;
  <mrow>&#13;
    <mfrac><mn>1</mn> <mn>2</mn></mfrac>&#13;
    <mo>‚Ä¢</mo>&#13;
    <msup><mi>f</mi> <mo>*</mo> </msup>&#13;
    <mo>‚âà</mo>&#13;
    <mn>2.3</mn>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>Against this background, <a data-type="xref" href="#auto_plot_03">Figure¬†10-3</a> also shows the evolution of the equity position for values lower than ‚Äúfull Kelly.‚Äù The risk indeed reduces with lower values of latexmath<a data-startref="ix_10_automated_trading_-asciidoc7" data-type="indexterm" id="idm45785341191272"/>:[$f$]<a data-startref="ix_10_automated_trading_-asciidoc6" data-type="indexterm" id="idm45785341190408"/><a data-startref="ix_10_automated_trading_-asciidoc5" data-type="indexterm" id="idm45785341189688"/>.<a data-startref="ix_10_automated_trading_-asciidoc2" data-type="indexterm" id="idm45785341188872"/><a data-startref="ix_10_automated_trading_-asciidoc1" data-type="indexterm" id="idm45785341188152"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="ML-Based Trading Strategy" data-type="sect1"><div class="sect1" id="auto_strat">&#13;
<h1>ML-Based Trading Strategy</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="ML-based trading strategy" data-type="indexterm" id="ix_10_automated_trading_-asciidoc8"/><a data-primary="machine learning" data-secondary="ML-based trading strategy" data-type="indexterm" id="ix_10_automated_trading_-asciidoc9"/><a data-primary="ML-based strategies" data-type="indexterm" id="ix_10_automated_trading_-asciidoc10"/><a data-primary="Oanda v20 RESTful API" data-type="indexterm" id="ix_10_automated_trading_-asciidoc11"/><a data-primary="v20 wrapper package" data-type="indexterm" id="ix_10_automated_trading_-asciidoc12"/><a data-type="xref" href="ch08.html#trading_oanda">Chapter¬†8</a> introduces the Oanda trading platform, its RESTful API and the Python wrapper package <code>tpqoa</code>. This section combines an ML-based approach for predicting the direction of market price movements with historical data from the Oanda v20 RESTful API to backtest an algorithmic trading strategy for the EUR/USD currency pair. It uses vectorized backtesting, taking into account this time the bid-ask spread &#13;
<span class="keep-together">as proportional</span> transactions costs. It also adds, compared to the plain vectorized &#13;
<span class="keep-together">backtesting</span> approach introduced in <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter¬†4</a>, a more in-depth analysis of the risk characteristics of the trading strategy tested.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Vectorized Backtesting" data-type="sect2"><div class="sect2" id="idm45785340653160">&#13;
<h2>Vectorized Backtesting</h2>&#13;
&#13;
<p><a data-primary="EUR/USD exchange rate" data-secondary="vectorized backtesting of ML-based trading strategy" data-type="indexterm" id="ix_10_automated_trading_-asciidoc13"/><a data-primary="ML-based strategies" data-secondary="vectorized backtesting" data-type="indexterm" id="ix_10_automated_trading_-asciidoc14"/><a data-primary="vectorized backtesting" data-secondary="ML-based trading strategy" data-type="indexterm" id="ix_10_automated_trading_-asciidoc15"/>The backtest is based on intraday data, more specifically on bars of 10 minutes in length. <a data-primary="Oanda v20 RESTful API" data-type="indexterm" id="idm45785340647640"/><a data-primary="v20 wrapper package" data-type="indexterm" id="idm45785340646968"/>The following code connects to the Oanda v20 API and retrieves 10-minute bar data for one week. <a data-type="xref" href="#auto_plot_04">Figure¬†10-4</a> visualizes the mid close prices over the period for which data is retrieved:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tpqoa</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="o">%</code><code class="n">time</code><code> </code><code class="n">api</code><code> </code><code class="o">=</code><code> </code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">(</code><code class="s1">'</code><code class="s1">../pyalgo.cfg</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-1" id="co_automating_trading_operations_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">CPU</code><code> </code><code class="n">times</code><code class="p">:</code><code> </code><code class="n">user</code><code> </code><code class="mi">893</code><code> </code><code class="err">¬µ</code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="p">:</code><code> </code><code class="mi">198</code><code> </code><code class="err">¬µ</code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">total</code><code class="p">:</code><code> </code><code class="mf">1.09</code><code> </code><code class="n">ms</code><code>&#13;
</code><code>         </code><code class="n">Wall</code><code> </code><code class="n">time</code><code class="p">:</code><code> </code><code class="mf">1.04</code><code> </code><code class="n">ms</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">instrument</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">EUR_USD</code><code class="s1">'</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-1" id="co_automating_trading_operations_CO6-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code> </code><code class="o">=</code><code> </code><code class="n">api</code><code class="o">.</code><code class="n">get_history</code><code class="p">(</code><code class="n">instrument</code><code class="p">,</code><code>&#13;
</code><code>                                </code><code class="n">start</code><code class="o">=</code><code class="s1">'</code><code class="s1">2020-06-08</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">2020-06-13</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                </code><code class="n">granularity</code><code class="o">=</code><code class="s1">'</code><code class="s1">M10</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>                                </code><code class="n">price</code><code class="o">=</code><code class="s1">'</code><code class="s1">M</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-1" id="co_automating_trading_operations_CO6-3"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">tail</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code>                            </code><code class="n">o</code><code>        </code><code class="n">h</code><code>        </code><code class="n">l</code><code>        </code><code class="n">c</code><code>  </code><code class="n">volume</code><code>  </code><code class="n">complete</code><code>&#13;
</code><code>         </code><code class="n">time</code><code>&#13;
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code><code>  </code><code class="mf">1.12572</code><code>  </code><code class="mf">1.12593</code><code>  </code><code class="mf">1.12532</code><code>  </code><code class="mf">1.12568</code><code>     </code><code class="mi">221</code><code>      </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">20</code><code class="p">:</code><code class="mo">00</code><code>  </code><code class="mf">1.12569</code><code>  </code><code class="mf">1.12578</code><code>  </code><code class="mf">1.12532</code><code>  </code><code class="mf">1.12558</code><code>     </code><code class="mi">163</code><code>      </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">30</code><code class="p">:</code><code class="mo">00</code><code>  </code><code class="mf">1.12560</code><code>  </code><code class="mf">1.12573</code><code>  </code><code class="mf">1.12534</code><code>  </code><code class="mf">1.12543</code><code>     </code><code class="mi">192</code><code>      </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">40</code><code class="p">:</code><code class="mo">00</code><code>  </code><code class="mf">1.12544</code><code>  </code><code class="mf">1.12594</code><code>  </code><code class="mf">1.12528</code><code>  </code><code class="mf">1.12542</code><code>     </code><code class="mi">219</code><code>      </code><code class="bp">True</code><code>&#13;
</code><code>         </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">50</code><code class="p">:</code><code class="mo">00</code><code>  </code><code class="mf">1.12544</code><code>  </code><code class="mf">1.12624</code><code>  </code><code class="mf">1.12541</code><code>  </code><code class="mf">1.12554</code><code>     </code><code class="mi">296</code><code>      </code><code class="bp">True</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="o">&lt;</code><code class="k">class</code><code> </code><code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'</code><code class="s1">&gt;</code><code>&#13;
</code><code>         </code><code class="n">DatetimeIndex</code><code class="p">:</code><code> </code><code class="mi">701</code><code> </code><code class="n">entries</code><code class="p">,</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code> </code><code class="n">to</code><code> </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">20</code><code class="p">:</code><code class="mi">50</code><code class="p">:</code><code class="mo">00</code><code>&#13;
</code><code>         </code><code class="n">Data</code><code> </code><code class="n">columns</code><code> </code><code class="p">(</code><code class="n">total</code><code> </code><code class="mi">6</code><code> </code><code class="n">columns</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="c1">#   Column    Non-Null Count  Dtype</code><code>&#13;
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>    </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>  </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>          </code><code class="mi">0</code><code>   </code><code class="n">o</code><code>         </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">1</code><code>   </code><code class="n">h</code><code>         </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">2</code><code>   </code><code class="n">l</code><code>         </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">3</code><code>   </code><code class="n">c</code><code>         </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">float64</code><code>&#13;
</code><code>          </code><code class="mi">4</code><code>   </code><code class="n">volume</code><code>    </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="n">int64</code><code>&#13;
</code><code>          </code><code class="mi">5</code><code>   </code><code class="n">complete</code><code>  </code><code class="mi">701</code><code> </code><code class="n">non</code><code class="o">-</code><code class="n">null</code><code>    </code><code class="nb">bool</code><code>&#13;
</code><code>         </code><code class="n">dtypes</code><code class="p">:</code><code> </code><code class="nb">bool</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">float64</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">memory</code><code> </code><code class="n">usage</code><code class="p">:</code><code> </code><code class="mf">33.5</code><code> </code><code class="n">KB</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">spread</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.00012</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-2" id="co_automating_trading_operations_CO6-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">=</code><code> </code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-3" id="co_automating_trading_operations_CO6-5"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ptc</code><code> </code><code class="o">=</code><code> </code><code class="n">spread</code><code> </code><code class="o">/</code><code> </code><code class="n">mean</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-4" id="co_automating_trading_operations_CO6-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="n">ptc</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO6-4" id="co_automating_trading_operations_CO6-7"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.00010599557439495706</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">legend</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO6-1" id="callout_automating_trading_operations_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Connects to the API and retrieves the data.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO6-4" id="callout_automating_trading_operations_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Specifies the average bid-ask spread.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO6-5" id="callout_automating_trading_operations_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the mean closing price for the data set.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO6-6" id="callout_automating_trading_operations_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Calculates the average proportional transactions costs given the average spread and the average mid closing price.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_04">&#13;
<img alt="pfat 1004" src="assets/pfat_1004.png"/>&#13;
<h6><span class="label">Figure 10-4. </span>EUR/USD exchange rate (10-minute bars)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The ML-based strategy uses a number of time series features, such as the log return and the minimum and the maximum of the closing price. In addition, the features data is lagged. In other words, the ML algorithm shall learn from historical patterns as embodied by the lagged features data:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">instrument</code><code class="p">,</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="mi">20</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-1" id="co_automating_trading_operations_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">data</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-2" id="co_automating_trading_operations_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">vol</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-3" id="co_automating_trading_operations_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mom</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-4" id="co_automating_trading_operations_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">sma</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">instrument</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-5" id="co_automating_trading_operations_CO7-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">instrument</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">min</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-6" id="co_automating_trading_operations_CO7-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>         </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">instrument</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-7" id="co_automating_trading_operations_CO7-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">6</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-8" id="co_automating_trading_operations_CO7-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">features</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">vol</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">mom</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">sma</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-8" id="co_automating_trading_operations_CO7-9"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">52</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>         </code><code class="k">for</code><code> </code><code class="n">f</code><code> </code><code class="ow">in</code><code> </code><code class="n">features</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                 </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">{f}_lag_{lag}</code><code class="s1">'</code><code>&#13;
</code><code>                 </code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">f</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-8" id="co_automating_trading_operations_CO7-10"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>                 </code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-9" id="co_automating_trading_operations_CO7-11"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="n">lags</code><code class="p">,</code><code> </code><code class="p">:</code><code class="n">lags</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO7-10" id="co_automating_trading_operations_CO7-12"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code>&#13;
</code><code>                          </code><code class="n">return_lag_1</code><code>  </code><code class="n">return_lag_2</code><code>  </code><code class="n">return_lag_3</code><code>  </code><code class="n">return_lag_4</code><code> </code><code>\&#13;
</code><code>     </code><code class="n">time</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">20</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000097</code><code>      </code><code class="mf">0.000018</code><code>     </code><code class="o">-</code><code class="mf">0.000452</code><code>      </code><code class="mf">0.000035</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">30</code><code class="p">:</code><code class="mo">00</code><code>     </code><code class="o">-</code><code class="mf">0.000115</code><code>      </code><code class="mf">0.000097</code><code>      </code><code class="mf">0.000018</code><code>     </code><code class="o">-</code><code class="mf">0.000452</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">40</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000027</code><code>     </code><code class="o">-</code><code class="mf">0.000115</code><code>      </code><code class="mf">0.000097</code><code>      </code><code class="mf">0.000018</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">50</code><code class="p">:</code><code class="mo">00</code><code>     </code><code class="o">-</code><code class="mf">0.000142</code><code>      </code><code class="mf">0.000027</code><code>     </code><code class="o">-</code><code class="mf">0.000115</code><code>      </code><code class="mf">0.000097</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">05</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000035</code><code>     </code><code class="o">-</code><code class="mf">0.000142</code><code>      </code><code class="mf">0.000027</code><code>     </code><code class="o">-</code><code class="mf">0.000115</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">05</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code><code>     </code><code class="o">-</code><code class="mf">0.000159</code><code>      </code><code class="mf">0.000035</code><code>     </code><code class="o">-</code><code class="mf">0.000142</code><code>      </code><code class="mf">0.000027</code><code>&#13;
</code><code>&#13;
</code><code>                          </code><code class="n">return_lag_5</code><code>  </code><code class="n">return_lag_6</code><code>&#13;
</code><code>     </code><code class="n">time</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">20</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000000</code><code>      </code><code class="mf">0.000009</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">30</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000035</code><code>      </code><code class="mf">0.000000</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">40</code><code class="p">:</code><code class="mo">00</code><code>     </code><code class="o">-</code><code class="mf">0.000452</code><code>      </code><code class="mf">0.000035</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">04</code><code class="p">:</code><code class="mi">50</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000018</code><code>     </code><code class="o">-</code><code class="mf">0.000452</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">05</code><code class="p">:</code><code class="mo">00</code><code class="p">:</code><code class="mo">00</code><code>      </code><code class="mf">0.000097</code><code>      </code><code class="mf">0.000018</code><code>&#13;
</code><code>     </code><code class="mi">2020</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mo">05</code><code class="p">:</code><code class="mi">10</code><code class="p">:</code><code class="mo">00</code><code>     </code><code class="o">-</code><code class="mf">0.000115</code><code>      </code><code class="mf">0.000097</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-1" id="callout_automating_trading_operations_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifies the window length for certain features.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-2" id="callout_automating_trading_operations_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the log returns from the closing prices.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-3" id="callout_automating_trading_operations_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Calculates the rolling volatility.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-4" id="callout_automating_trading_operations_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Derives the time series momentum as the mean of the recent log returns.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-5" id="callout_automating_trading_operations_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Calculates the simple moving average.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-6" id="callout_automating_trading_operations_CO7-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Calculates the rolling maximum value.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-7" id="callout_automating_trading_operations_CO7-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Calculates the rolling minimum value.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-8" id="callout_automating_trading_operations_CO7-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Adds the lagged features data to the <code>DataFrame</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-11" id="callout_automating_trading_operations_CO7-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Defines the labels data as the market direction (<code>+1</code> or <em>up</em> and <code>-1</code> or <em>down</em>).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO7-12" id="callout_automating_trading_operations_CO7-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Shows a small sub-set from the resulting lagged features data.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Given the features and label data, different supervised learning algorithms could now be applied. <a data-primary="AdaBoost algorithm" data-type="indexterm" id="idm45785339848904"/>In what follows, a so-called <em>AdaBoost algorithm</em> for classification is used from the <code>scikit-learn</code> ML package (see <a href="https://oreil.ly/WIANy"><code>AdaBoostClassifier</code></a>). The idea of boosting in the context of classification is to use an <em>ensemble</em> of base classifiers to arrive at a superior predictor that is supposed to be less prone to overfitting (see <a data-type="xref" href="ch04.html#data_snooping">‚ÄúData Snooping and Overfitting‚Äù</a>). <a data-primary="decision tree classification algorithm" data-type="indexterm" id="idm45785340629528"/>As the base classifier, a <em>decision tree classification algorithm</em> from <code>scikit-learn</code> is used (see <a href="https://oreil.ly/wb-wh"><code>DecisionTreeClassifier</code></a>).</p>&#13;
&#13;
<p>The code trains and tests the algorithmic trading strategy based on a sequential train-test split. The accuracy scores of the model for the training and test data are both significantly above 50%. Instead of accuracy scores, one would also speak in a financial trading context of the <a data-primary="hit ratio, defined" data-type="indexterm" id="idm45785340626472"/><em>hit ratio</em> of the trading strategy (that is, the number of winning trades compared to all trades). Since the hit ratio is significantly greater than 50%, this might indicate‚Äîin the context of the Kelly criterion‚Äîa statistical edge compared to a random walk setting:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">from</code><code> </code><code class="nn">sklearn.metrics</code><code> </code><code class="kn">import</code><code> </code><code class="n">accuracy_score</code><code>&#13;
</code><code>         </code><code class="kn">from</code><code> </code><code class="nn">sklearn.tree</code><code> </code><code class="kn">import</code><code> </code><code class="n">DecisionTreeClassifier</code><code>&#13;
</code><code>         </code><code class="kn">from</code><code> </code><code class="nn">sklearn.ensemble</code><code> </code><code class="kn">import</code><code> </code><code class="n">AdaBoostClassifier</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">n_estimators</code><code class="o">=</code><code class="mi">15</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-1" id="co_automating_trading_operations_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-1" id="co_automating_trading_operations_CO8-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">max_depth</code><code class="o">=</code><code class="mi">2</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-1" id="co_automating_trading_operations_CO8-3"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">min_samples_leaf</code><code class="o">=</code><code class="mi">15</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-1" id="co_automating_trading_operations_CO8-4"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">subsample</code><code class="o">=</code><code class="mf">0.33</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-1" id="co_automating_trading_operations_CO8-5"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">dtc</code><code> </code><code class="o">=</code><code> </code><code class="n">DecisionTreeClassifier</code><code class="p">(</code><code class="n">random_state</code><code class="o">=</code><code class="n">random_state</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="n">max_depth</code><code class="o">=</code><code class="n">max_depth</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="n">min_samples_leaf</code><code class="o">=</code><code class="n">min_samples_leaf</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-2" id="co_automating_trading_operations_CO8-6"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">AdaBoostClassifier</code><code class="p">(</code><code class="n">base_estimator</code><code class="o">=</code><code class="n">dtc</code><code class="p">,</code><code>&#13;
</code><code>                                   </code><code class="n">n_estimators</code><code class="o">=</code><code class="n">n_estimators</code><code class="p">,</code><code>&#13;
</code><code>                                   </code><code class="n">random_state</code><code class="o">=</code><code class="n">random_state</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-3" id="co_automating_trading_operations_CO8-7"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">split</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.7</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="n">split</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mu</code><code class="p">,</code><code> </code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">train</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">train</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-4" id="co_automating_trading_operations_CO8-8"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">train_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">train</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-4" id="co_automating_trading_operations_CO8-9"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-5" id="co_automating_trading_operations_CO8-10"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">AdaBoostClassifier</code><code class="p">(</code><code class="n">algorithm</code><code class="o">=</code><code class="s1">'</code><code class="s1">SAMME.R</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">base_estimator</code><code class="o">=</code><code class="n">DecisionTreeClassifier</code><code class="p">(</code><code class="n">ccp_alpha</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">class_weight</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">criterion</code><code class="o">=</code><code class="s1">'</code><code class="s1">gini</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">max_depth</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">max_features</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">max_leaf_nodes</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">min_impurity_decrease</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">min_impurity_split</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">min_samples_leaf</code><code class="o">=</code><code class="mi">15</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">min_samples_split</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">min_weight_fraction_leaf</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">presort</code><code class="o">=</code><code class="s1">'</code><code class="s1">deprecated</code><code class="s1">'</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">splitter</code><code class="o">=</code><code class="s1">'</code><code class="s1">best</code><code class="s1">'</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">learning_rate</code><code class="o">=</code><code class="mf">1.0</code><code class="p">,</code><code> </code><code class="n">n_estimators</code><code class="o">=</code><code class="mi">15</code><code class="p">,</code><code> </code><code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">accuracy_score</code><code class="p">(</code><code class="n">train</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">train_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-6" id="co_automating_trading_operations_CO8-11"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">65</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.8050847457627118</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">66</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">split</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-7" id="co_automating_trading_operations_CO8-12"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">67</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test_</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">test</code><code> </code><code class="o">-</code><code> </code><code class="n">mu</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="n">std</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-7" id="co_automating_trading_operations_CO8-13"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">68</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">test_</code><code class="p">[</code><code class="n">cols</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-8" id="co_automating_trading_operations_CO8-14"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">accuracy_score</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">direction</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO8-9" id="co_automating_trading_operations_CO8-15"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">0.5665024630541872</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-1" id="callout_automating_trading_operations_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Specifies major parameters for the ML algorithm (see the references for the model classes provided previously).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-6" id="callout_automating_trading_operations_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Instantiates the base classification algorithm (decision tree).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-7" id="callout_automating_trading_operations_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Instantiates the AdaBoost classification algorithm.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-8" id="callout_automating_trading_operations_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Applies Gaussian normalization to the <em>training</em> features data set.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-10" id="callout_automating_trading_operations_CO8-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Fits the model based on the training data set.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-11" id="callout_automating_trading_operations_CO8-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Shows the accuracy of the predictions from the trained model <em>in-sample</em> (training data set).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-12" id="callout_automating_trading_operations_CO8-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Applies Gaussian normalization to the <em>testing</em> features data set (using the parameters from the training features data set).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-14" id="callout_automating_trading_operations_CO8-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Generates the predictions for the test data set.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO8-15" id="callout_automating_trading_operations_CO8-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Shows the accuracy of the predictions from the trained model <em>out-of-sample</em> (test data set).</p></dd>&#13;
</dl>&#13;
&#13;
<p>It is well known that the hit ratio is only one side of the coin of success in financial trading. The other side comprises, among other things, getting the important trades right, as well as the transactions costs implied by the trading strategy.<sup><a data-type="noteref" href="ch10.html#idm45785339950712" id="idm45785339950712-marker">2</a></sup> To this end, only a formal vectorized backtesting approach allows one to judge the quality of the trading strategy. The following code takes into account the proportional transaction costs based on the average bid-ask spread. <a data-type="xref" href="#auto_plot_05">Figure¬†10-5</a> compares the performance of the algorithmic trading strategy (without and with proportional transaction costs) to the performance of the passive benchmark investment:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO9-1" id="co_automating_trading_operations_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="nb">sum</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO9-2" id="co_automating_trading_operations_CO9-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">77</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">position</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">diff</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">,</code><code>&#13;
</code><code>                                        </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">ptc</code><code class="p">,</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO9-3" id="co_automating_trading_operations_CO9-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                                        </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code>&#13;
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>         </code><code class="mf">0.990182</code><code>&#13;
</code><code>         </code><code class="n">strategy</code><code>       </code><code class="mf">1.015827</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">1.007570</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist pagebreak-before">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO9-1" id="callout_automating_trading_operations_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Derives the log returns for the ML-based algorithmic trading strategy.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO9-2" id="callout_automating_trading_operations_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the number of trades implied by the trading strategy based on changes in the position.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO9-3" id="callout_automating_trading_operations_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Whenever a trade takes place, the proportional transaction costs are subtracted from the strategy‚Äôs log return on that day.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_05">&#13;
<img alt="pfat 1005" src="assets/pfat_1005.png"/>&#13;
<h6><span class="label">Figure 10-5. </span>Gross performance of EUR/USD exchange rate and algorithmic trading strategy (before and after transaction costs)</h6>&#13;
</div></figure>&#13;
<div data-type="caution">&#13;
<p>Vectorized backtesting has its limits with regard to how close to market realities strategies can be tested. <a data-primary="transaction costs" data-type="indexterm" id="idm45785339796696"/>For example, it does not allow one to include fixed transaction costs per trade directly. One could, as an approximation, take a multiple of the average proportional transaction costs (based on average position sizes) to account indirectly for fixed transactions costs. However, this would not be precise in general. If a higher degree of precision is required, other approaches, such as <em>event-based backtesting</em> (see <a data-type="xref" href="ch06.html#event_based_backtesting">Chapter¬†6</a>) with explicit loops over every bar of the price data, need to be applied.<a data-startref="ix_10_automated_trading_-asciidoc15" data-type="indexterm" id="idm45785339794200"/><a data-startref="ix_10_automated_trading_-asciidoc14" data-type="indexterm" id="idm45785339793512"/><a data-startref="ix_10_automated_trading_-asciidoc13" data-type="indexterm" id="idm45785339792824"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Optimal Leverage" data-type="sect2"><div class="sect2" id="idm45785340652568">&#13;
<h2>Optimal Leverage</h2>&#13;
&#13;
<p><a data-primary="Kelly criterion" data-secondary="optimal leverage" data-type="indexterm" id="ix_10_automated_trading_-asciidoc16"/><a data-primary="ML-based strategies" data-secondary="optimal leverage" data-type="indexterm" id="ix_10_automated_trading_-asciidoc17"/>Equipped with the trading strategy‚Äôs log returns data, the mean and variance values can be calculated in order to derive the optimal leverage according to the Kelly criterion. The code that follows scales the numbers to annualized values, although this does not change the optimal leverage values according to the Kelly criterion since the mean return and the variance scale with the same factor:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">=</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">52</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO10-1" id="co_automating_trading_operations_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>         </code><code class="n">mean</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>        </code><code class="o">-</code><code class="mf">1.705965</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">1.304023</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">var</code><code> </code><code class="o">=</code><code> </code><code class="n">test</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">var</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">52</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO10-2" id="co_automating_trading_operations_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>         </code><code class="n">var</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>         </code><code class="mf">0.011306</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">0.011370</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">vol</code><code> </code><code class="o">=</code><code> </code><code class="n">var</code><code> </code><code class="o">*</code><code class="o">*</code><code> </code><code class="mf">0.5</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO10-3" id="co_automating_trading_operations_CO10-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>         </code><code class="n">vol</code><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>         </code><code class="mf">0.106332</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">0.106631</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">/</code><code> </code><code class="n">var</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO10-4" id="co_automating_trading_operations_CO10-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>        </code><code class="o">-</code><code class="mf">150.884961</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">114.687875</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mean</code><code> </code><code class="o">/</code><code> </code><code class="n">var</code><code> </code><code class="o">*</code><code> </code><code class="mf">0.5</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO10-5" id="co_automating_trading_operations_CO10-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">return</code><code>        </code><code class="o">-</code><code class="mf">75.442481</code><code>&#13;
</code><code>         </code><code class="n">strategy_tc</code><code>    </code><code class="mf">57.343938</code><code>&#13;
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO10-1" id="callout_automating_trading_operations_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Annualized mean returns.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO10-2" id="callout_automating_trading_operations_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Annualized variances.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO10-3" id="callout_automating_trading_operations_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Annualized volatilities.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO10-4" id="callout_automating_trading_operations_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Optimal leverage according to the Kelly criterion (‚Äúfull Kelly‚Äù).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO10-5" id="callout_automating_trading_operations_CO10-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Optimal leverage according to the Kelly criterion (‚Äúhalf Kelly‚Äù).</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="half Kelly criterion" data-type="indexterm" id="idm45785340082680"/>Using the ‚Äúhalf Kelly‚Äù criterion, the optimal leverage for the trading strategy is above 50. With a number of brokers, such as Oanda, and certain financial instruments, such as foreign exchange pairs and contracts for difference (CFDs), such leverage ratios are feasible, even for retail traders. <a data-type="xref" href="#auto_plot_06">Figure¬†10-6</a> shows, in comparison, the performance of the trading strategy with transaction costs for different leverage values:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">80</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">to_plot</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">81</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">for</code><code> </code><code class="n">lev</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">30</code><code class="p">,</code><code> </code><code class="mi">40</code><code class="p">,</code><code> </code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code>&#13;
</code><code>             </code><code class="n">label</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">lstrategy_tc_</code><code class="si">%d</code><code class="s1">'</code><code> </code><code class="o">%</code><code> </code><code class="n">lev</code><code>&#13;
</code><code>             </code><code class="n">test</code><code class="p">[</code><code class="n">label</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">strategy_tc</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">lev</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO11-1" id="co_automating_trading_operations_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>             </code><code class="n">to_plot</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">label</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">82</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">test</code><code class="p">[</code><code class="n">to_plot</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO11-1" id="callout_automating_trading_operations_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Scales the strategy returns for different leverage values.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="auto_plot_06">&#13;
<img alt="pfat 1006" src="assets/pfat_1006.png"/>&#13;
<h6><span class="label">Figure 10-6. </span>Gross performance of the algorithmic trading strategy for different leverage values</h6>&#13;
</div></figure>&#13;
<div data-type="caution">&#13;
<p><a data-primary="leveraged trading, risks of" data-type="indexterm" id="idm45785338250392"/>Leverage increases risks associated with trading strategies significantly. Traders should read the risk disclaimers and regulations carefully. A positive backtesting performance is also no guarantee whatsoever for future performances. All results shown are illustrative only and are meant to demonstrate the application of programming and analytics approaches. In some jurisdictions, such as in Germany, leverage ratios are capped for retail traders based on different groups of financial instruments.<a data-startref="ix_10_automated_trading_-asciidoc17" data-type="indexterm" id="idm45785338291816"/><a data-startref="ix_10_automated_trading_-asciidoc16" data-type="indexterm" id="idm45785338291176"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Risk Analysis" data-type="sect2"><div class="sect2" id="idm45785338238728">&#13;
<h2>Risk Analysis</h2>&#13;
&#13;
<p><a data-primary="ML-based strategies" data-secondary="risk analysis" data-type="indexterm" id="ix_10_automated_trading_-asciidoc18"/><a data-primary="risk analysis, for ML-based trading strategy" data-type="indexterm" id="ix_10_automated_trading_-asciidoc19"/>Since leverage increases the risk associated with a certain trading strategy considerably, a more in-depth risk analysis seems in order. The risk analysis that follows assumes a leverage ratio of 30. <a data-primary="maximum drawdown" data-type="indexterm" id="idm45785338070136"/>First, the maximum drawdown and the longest drawdown period shall be calculated. <em>Maximum drawdown</em> is the largest loss (dip) after a recent high. <a data-primary="longest drawdown period" data-type="indexterm" id="idm45785338068952"/>Accordingly, the <em>longest drawdown period</em> is the longest period that the trading strategy needs to get back to a recent high. The analysis assumes that the initial equity position is 3,333 EUR leading to an initial position size of 100,000 EUR for a leverage ratio of 30. It also assumes that there are no adjustments with regard to the equity over time, no matter what the performance is:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">83</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">equity</code><code> </code><code class="o">=</code><code> </code><code class="mi">3333</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-1" id="co_automating_trading_operations_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">84</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">test</code><code class="p">[</code><code class="s1">'</code><code class="s1">lstrategy_tc_30</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-2" id="co_automating_trading_operations_CO12-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">85</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">lstrategy_tc_30</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>&#13;
</code><code>                                   </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">equity</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-3" id="co_automating_trading_operations_CO12-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">86</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cummax</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-4" id="co_automating_trading_operations_CO12-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">87</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">drawdown</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-5" id="co_automating_trading_operations_CO12-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">88</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">drawdown</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-6" id="co_automating_trading_operations_CO12-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">88</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">511.38321383258017</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">89</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">t_max</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">drawdown</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">idxmax</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-7" id="co_automating_trading_operations_CO12-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>         </code><code class="n">t_max</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO12-7" id="co_automating_trading_operations_CO12-8"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">89</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">Timestamp</code><code class="p">(</code><code class="s1">'</code><code class="s1">2020-06-12 10:30:00</code><code class="s1">'</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-1" id="callout_automating_trading_operations_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The initial equity.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-2" id="callout_automating_trading_operations_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The relevant log returns time series‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-3" id="callout_automating_trading_operations_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>‚Ä¶scaled by the initial equity.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-4" id="callout_automating_trading_operations_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The cumulative maximum values over time.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-5" id="callout_automating_trading_operations_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The drawdown values over time.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-6" id="callout_automating_trading_operations_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The maximum drawdown value.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO12-7" id="callout_automating_trading_operations_CO12-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>The point in time when it happens.</p></dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before">Technically, a new high is characterized by a drawdown value of 0. The drawdown period is the time between two such highs. <a data-type="xref" href="#auto_plot_07">Figure¬†10-7</a> visualizes both the maximum drawdown and the drawdown periods:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">90</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">temp</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">drawdown</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">drawdown</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-1" id="co_automating_trading_operations_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">91</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">periods</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">temp</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">to_pydatetime</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code>&#13;
</code><code>                    </code><code class="n">temp</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">to_pydatetime</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-2" id="co_automating_trading_operations_CO13-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">92</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">periods</code><code class="p">[</code><code class="mi">20</code><code class="p">:</code><code class="mi">30</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-2" id="co_automating_trading_operations_CO13-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">92</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">array</code><code class="p">(</code><code class="p">[</code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">seconds</code><code class="o">=</code><code class="mi">600</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>          </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">seconds</code><code class="o">=</code><code class="mi">1200</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>         </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">seconds</code><code class="o">=</code><code class="mi">1200</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">seconds</code><code class="o">=</code><code class="mi">1200</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>               </code><code class="n">dtype</code><code class="o">=</code><code class="nb">object</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">93</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">t_per</code><code> </code><code class="o">=</code><code> </code><code class="n">periods</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-3" id="co_automating_trading_operations_CO13-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">94</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">t_per</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-3" id="co_automating_trading_operations_CO13-5"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">94</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">timedelta</code><code class="p">(</code><code class="n">seconds</code><code class="o">=</code><code class="mi">26400</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">95</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">t_per</code><code class="o">.</code><code class="n">seconds</code><code> </code><code class="o">/</code><code> </code><code class="mi">60</code><code> </code><code class="o">/</code><code> </code><code class="mi">60</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO13-4" id="co_automating_trading_operations_CO13-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="n">Out</code><code class="p">[</code><code class="mi">95</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mf">7.333333333333333</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">96</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">cummax</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>         </code><code class="n">plt</code><code class="o">.</code><code class="n">axvline</code><code class="p">(</code><code class="n">t_max</code><code class="p">,</code><code> </code><code class="n">c</code><code class="o">=</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">alpha</code><code class="o">=</code><code class="mf">0.5</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO13-1" id="callout_automating_trading_operations_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Identifies highs for which the drawdown must be 0.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO13-2" id="callout_automating_trading_operations_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the <code>timedelta</code> values between all highs.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO13-4" id="callout_automating_trading_operations_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The longest drawdown period in <em>seconds</em>‚Ä¶</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO13-6" id="callout_automating_trading_operations_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>‚Ä¶transformed to <em>hours</em>.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="value-at-risk (VAR)" data-type="indexterm" id="ix_10_automated_trading_-asciidoc20"/>Another important risk measure is <em>value-at-risk</em> (VaR). It is quoted as a currency amount and represents the maximum loss to be expected given both a certain time horizon and a confidence level.</p>&#13;
&#13;
<figure><div class="figure" id="auto_plot_07">&#13;
<img alt="pfat 1007" src="assets/pfat_1007.png"/>&#13;
<h6><span class="label">Figure 10-7. </span>Maximum drawdown (vertical line) and drawdown periods (horizontal lines)</h6>&#13;
</div></figure>&#13;
&#13;
<p>The following code derives VaR values based on the log returns of the equity position for the leveraged trading strategy over time for different confidence levels. The time interval is fixed to the bar length of ten minutes:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">97</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">scipy.stats</code><code> </code><code class="kn">as</code><code> </code><code class="nn">scs</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">98</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">percs</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="mf">0.01</code><code class="p">,</code><code> </code><code class="mf">0.1</code><code class="p">,</code><code> </code><code class="mf">1.</code><code class="p">,</code><code> </code><code class="mf">2.5</code><code class="p">,</code><code> </code><code class="mf">5.0</code><code class="p">,</code><code> </code><code class="mf">10.0</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO14-1" id="co_automating_trading_operations_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">99</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                  </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">100</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR</code><code> </code><code class="o">=</code><code> </code><code class="n">scs</code><code class="o">.</code><code class="n">scoreatpercentile</code><code class="p">(</code><code class="n">equity</code><code> </code><code class="o">*</code><code> </code><code class="n">risk</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">percs</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO14-2" id="co_automating_trading_operations_CO14-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">101</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">print_var</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">{}    {}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="s1">'</code><code class="s1">Confidence Level</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Value-at-Risk</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="k">print</code><code class="p">(</code><code class="mi">33</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="k">for</code><code> </code><code class="n">pair</code><code> </code><code class="ow">in</code><code> </code><code class="nb">zip</code><code class="p">(</code><code class="n">percs</code><code class="p">,</code><code> </code><code class="n">VaR</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">{:16.2f} {:16.3f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="mi">100</code><code> </code><code class="o">-</code><code> </code><code class="n">pair</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="o">-</code><code class="n">pair</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO14-3" id="co_automating_trading_operations_CO14-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">102</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_var</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO14-3" id="co_automating_trading_operations_CO14-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>          </code><code class="n">Confidence</code><code> </code><code class="n">Level</code><code>    </code><code class="n">Value</code><code class="o">-</code><code class="n">at</code><code class="o">-</code><code class="n">Risk</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>                     </code><code class="mf">99.99</code><code>          </code><code class="mf">162.570</code><code>&#13;
</code><code>                     </code><code class="mf">99.90</code><code>          </code><code class="mf">161.348</code><code>&#13;
</code><code>                     </code><code class="mf">99.00</code><code>          </code><code class="mf">132.382</code><code>&#13;
</code><code>                     </code><code class="mf">97.50</code><code>          </code><code class="mf">122.913</code><code>&#13;
</code><code>                     </code><code class="mf">95.00</code><code>          </code><code class="mf">100.950</code><code>&#13;
</code><code>                     </code><code class="mf">90.00</code><code>           </code><code class="mf">62.622</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO14-1" id="callout_automating_trading_operations_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Defines the percentile values to be used.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO14-2" id="callout_automating_trading_operations_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the VaR values given the percentile values.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO14-3" id="callout_automating_trading_operations_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Translates the percentile values into confidence levels and the VaR values (negative values) to positive values for printing.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Finally, the following code calculates the VaR values for a time horizon of <em>one hour</em> by resampling the original <code>DataFrame</code> object. In effect, the VaR values are increased for all confidence levels:<a data-startref="ix_10_automated_trading_-asciidoc20" data-type="indexterm" id="idm45785337331016"/><a data-startref="ix_10_automated_trading_-asciidoc19" data-type="indexterm" id="idm45785337330456"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">103</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hourly</code><code> </code><code class="o">=</code><code> </code><code class="n">risk</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="s1">'</code><code class="s1">1H</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">right</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO15-1" id="co_automating_trading_operations_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">104</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">hourly</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">hourly</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                   </code><code class="n">hourly</code><code class="p">[</code><code class="s1">'</code><code class="s1">equity</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">105</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">VaR</code><code> </code><code class="o">=</code><code> </code><code class="n">scs</code><code class="o">.</code><code class="n">scoreatpercentile</code><code class="p">(</code><code class="n">equity</code><code> </code><code class="o">*</code><code> </code><code class="n">hourly</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">percs</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO15-2" id="co_automating_trading_operations_CO15-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">106</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">print_var</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">Confidence</code><code> </code><code class="n">Level</code><code>    </code><code class="n">Value</code><code class="o">-</code><code class="n">at</code><code class="o">-</code><code class="n">Risk</code><code>&#13;
</code><code>          </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>&#13;
</code><code>                     </code><code class="mf">99.99</code><code>          </code><code class="mf">252.460</code><code>&#13;
</code><code>                     </code><code class="mf">99.90</code><code>          </code><code class="mf">251.744</code><code>&#13;
</code><code>                     </code><code class="mf">99.00</code><code>          </code><code class="mf">244.593</code><code>&#13;
</code><code>                     </code><code class="mf">97.50</code><code>          </code><code class="mf">232.674</code><code>&#13;
</code><code>                     </code><code class="mf">95.00</code><code>          </code><code class="mf">125.498</code><code>&#13;
</code><code>                     </code><code class="mf">90.00</code><code>           </code><code class="mf">61.701</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO15-1" id="callout_automating_trading_operations_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Resamples the data from 10-minute to 1-hour bars.<a data-startref="ix_10_automated_trading_-asciidoc18" data-type="indexterm" id="idm45785337124984"/></p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO15-2" id="callout_automating_trading_operations_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Calculates the VaR values given the percentile values.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Persisting the Model Object" data-type="sect2"><div class="sect2" id="idm45785338238184">&#13;
<h2>Persisting the Model Object</h2>&#13;
&#13;
<p><a data-primary="ML-based strategies" data-secondary="persisting the model object" data-type="indexterm" id="idm45785337063336"/>Once the algorithmic trading strategy is accepted based on the backtesting, leveraging, and risk analysis results, the model object and other relevant algorithm components might be persisted for later use in deployment. It embodies now the ML-based trading strategy or the trading algorithm.<a data-startref="ix_10_automated_trading_-asciidoc12" data-type="indexterm" id="idm45785337061960"/><a data-startref="ix_10_automated_trading_-asciidoc11" data-type="indexterm" id="idm45785337061320"/><a data-startref="ix_10_automated_trading_-asciidoc10" data-type="indexterm" id="idm45785337060680"/><a data-startref="ix_10_automated_trading_-asciidoc9" data-type="indexterm" id="idm45785337060040"/><a data-startref="ix_10_automated_trading_-asciidoc8" data-type="indexterm" id="idm45785337085512"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">107</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">pickle</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">108</code><code class="p">]:</code> <code class="n">algorithm</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'model'</code><code class="p">:</code> <code class="n">model</code><code class="p">,</code> <code class="s1">'mu'</code><code class="p">:</code> <code class="n">mu</code><code class="p">,</code> <code class="s1">'std'</code><code class="p">:</code> <code class="n">std</code><code class="p">}</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">109</code><code class="p">]:</code> <code class="n">pickle</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">algorithm</code><code class="p">,</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'algorithm.pkl'</code><code class="p">,</code> <code class="s1">'wb'</code><code class="p">))</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Online Algorithm" data-type="sect1"><div class="sect1" id="auto_online">&#13;
<h1>Online Algorithm</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="online algorithm" data-type="indexterm" id="ix_10_automated_trading_-asciidoc21"/><a data-primary="online algorithm" data-secondary="automated trading operations" data-type="indexterm" id="ix_10_automated_trading_-asciidoc22"/>The trading algorithm tested so far is an <em>offline algorithm</em>. Such algorithms use a complete data set to solve a problem at hand. The problem has been to train an AdaBoost classification algorithm based on a decision tree as the base classifier, a number of different time series features, and directional label data. In practice, when deploying the trading algorithm in financial markets, it must consume data piece by piece as it arrives to predict the direction of the market movement for the next time interval (bar). This section makes use of the persisted model object from the previous section and embeds it into a streaming data context.</p>&#13;
&#13;
<p>The code that transforms the <em>offline</em> trading algorithm into an <em>online</em> trading algorithm mainly addresses the following issues:</p>&#13;
<dl>&#13;
<dt>Tick data</dt>&#13;
<dd>&#13;
<p>Tick data arrives in real time and is to be processed in real time, such as to be collected in a <code>DataFrame</code> object.</p>&#13;
</dd>&#13;
<dt>Resampling</dt>&#13;
<dd>&#13;
<p>The tick data is to be resampled to the appropriate bar length given the trading algorithm. For illustration, a shorter bar length is used for resampling than for the training and backtesting.</p>&#13;
</dd>&#13;
<dt>Prediction</dt>&#13;
<dd>&#13;
<p>The trading algorithm generates a prediction for the direction of the market movement over the relevant time interval that by nature lies in the future.</p>&#13;
</dd>&#13;
<dt>Orders</dt>&#13;
<dd>&#13;
<p>Given the current position and the prediction (‚Äúsignal‚Äù) generated by the algorithm, an order is placed or the position is kept unchanged.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="xref" href="ch08.html#trading_oanda">Chapter¬†8</a>, and in particular <a data-type="xref" href="ch08.html#oanda_streaming">‚ÄúWorking with Streaming Data‚Äù</a>, shows how to retrieve tick data from the Oanda API in real time. <a data-primary=".on_success() method" data-primary-sortas="on_success" data-type="indexterm" id="idm45785336873800"/>The basic approach is to redefine the <code>.on_success()</code> method of the <code>tpqoa.tpqoa</code> class to implement the trading logic.</p>&#13;
&#13;
<p>First, the persisted trading algorithm is loaded; it represents the trading logic to be followed. It consists of the trained model itself and the parameters for the normalization of the features data, which are integral parts of the algorithm:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">110</code><code class="p">]:</code> <code class="n">algorithm</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="nb">open</code><code class="p">(</code><code class="s1">'algorithm.pkl'</code><code class="p">,</code> <code class="s1">'rb'</code><code class="p">))</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">111</code><code class="p">]:</code> <code class="n">algorithm</code><code class="p">[</code><code class="s1">'model'</code><code class="p">]</code>&#13;
<code class="n">Out</code><code class="p">[</code><code class="mi">111</code><code class="p">]:</code> <code class="n">AdaBoostClassifier</code><code class="p">(</code><code class="n">algorithm</code><code class="o">=</code><code class="s1">'SAMME.R'</code><code class="p">,</code>&#13;
          <code class="n">base_estimator</code><code class="o">=</code><code class="n">DecisionTreeClassifier</code><code class="p">(</code><code class="n">ccp_alpha</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code>&#13;
          <code class="n">class_weight</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>&#13;
          <code class="n">criterion</code><code class="o">=</code><code class="s1">'gini'</code><code class="p">,</code>&#13;
          <code class="n">max_depth</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code>&#13;
          <code class="n">max_features</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>&#13;
          <code class="n">max_leaf_nodes</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>&#13;
          <code class="n">min_impurity_decrease</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code>&#13;
          <code class="n">min_impurity_split</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>&#13;
          <code class="n">min_samples_leaf</code><code class="o">=</code><code class="mi">15</code><code class="p">,</code>&#13;
          <code class="n">min_samples_split</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code>&#13;
          <code class="n">min_weight_fraction_leaf</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code>&#13;
          <code class="n">presort</code><code class="o">=</code><code class="s1">'deprecated'</code><code class="p">,</code>&#13;
          <code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">,</code>&#13;
          <code class="n">splitter</code><code class="o">=</code><code class="s1">'best'</code><code class="p">),</code>&#13;
          <code class="n">learning_rate</code><code class="o">=</code><code class="mf">1.0</code><code class="p">,</code> <code class="n">n_estimators</code><code class="o">=</code><code class="mi">15</code><code class="p">,</code> <code class="n">random_state</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code></pre>&#13;
&#13;
<p><a data-primary="MLTrader class" data-type="indexterm" id="ix_10_automated_trading_-asciidoc23"/>In the following code, the new class <code>MLTrader</code>, which inherits from <code>tpqoa.tpqoa</code> and which, via the <code>.on_success()</code> and additional helper methods, transforms the trading algorithm into a real-time context. <a data-primary="offline algorithm" data-secondary="transformation to online algorithm" data-type="indexterm" id="idm45785336719224"/><a data-primary="online algorithm" data-secondary="transformation of offline algorithm to" data-type="indexterm" id="idm45785336718280"/>It is the transformation of the <em>offline algorithm</em> to a so-called <em>online algorithm</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">112</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">class</code><code> </code><code class="nc">MLTrader</code><code class="p">(</code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">config_file</code><code class="p">,</code><code> </code><code class="n">algorithm</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="nb">super</code><code class="p">(</code><code class="n">MLTrader</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="n">config_file</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">algorithm</code><code class="p">[</code><code class="s1">'</code><code class="s1">model</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-1" id="co_automating_trading_operations_CO16-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code> </code><code class="o">=</code><code> </code><code class="n">algorithm</code><code class="p">[</code><code class="s1">'</code><code class="s1">mu</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-1" id="co_automating_trading_operations_CO16-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">std</code><code> </code><code class="o">=</code><code> </code><code class="n">algorithm</code><code class="p">[</code><code class="s1">'</code><code class="s1">std</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-1" id="co_automating_trading_operations_CO16-3"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="mi">100000</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-2" id="co_automating_trading_operations_CO16-4"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-3" id="co_automating_trading_operations_CO16-5"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">5s</code><code class="s1">'</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-4" id="co_automating_trading_operations_CO16-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-5" id="co_automating_trading_operations_CO16-7"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">=</code><code> </code><code class="mi">6</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-6" id="co_automating_trading_operations_CO16-8"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">sma</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">vol</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">mom</code><code class="s1">'</code><code class="p">]</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="k">def</code><code> </code><code class="nf">prepare_features</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-7" id="co_automating_trading_operations_CO16-9"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                                               </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">sma</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">min</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mom</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code><code>&#13;
</code><code>                      </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">vol</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">return</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code>&#13;
</code><code>                      </code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code> </code><code class="o">/</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">std</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>&#13;
</code><code>                  </code><code class="k">for</code><code> </code><code class="n">f</code><code> </code><code class="ow">in</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">:</code><code>&#13;
</code><code>                      </code><code class="k">for</code><code> </code><code class="n">lag</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>                          </code><code class="n">col</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">{f}_lag_{lag}</code><code class="s1">'</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">f</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code><code>&#13;
</code><code>              </code><code class="k">def</code><code> </code><code class="nf">on_success</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">time</code><code class="p">,</code><code> </code><code class="n">bid</code><code class="p">,</code><code> </code><code class="n">ask</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-8" id="co_automating_trading_operations_CO16-10"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>                  </code><code class="n">df</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="p">{</code><code class="s1">'</code><code class="s1">bid</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">bid</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">ask</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">ask</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                                   </code><code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">pd</code><code class="o">.</code><code class="n">Timestamp</code><code class="p">(</code><code class="n">time</code><code class="p">)</code><code class="o">.</code><code class="n">tz_localize</code><code class="p">(</code><code class="bp">None</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">df</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">,</code><code>&#13;
</code><code>                                          </code><code class="n">label</code><code class="o">=</code><code class="s1">'</code><code class="s1">right</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">ffill</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                  </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code>&#13;
</code><code>                  </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code class="p">:</code><code>&#13;
</code><code>                      </code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code> </code><code class="o">+</code><code class="o">=</code><code class="mi">1</code><code>&#13;
</code><code>                      </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mid</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">bid</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">+</code><code>&#13;
</code><code>                                          </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">ask</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code>&#13;
</code><code>                      </code><code class="bp">self</code><code class="o">.</code><code class="n">prepare_features</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>                      </code><code class="n">features</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">)</code><code>&#13;
</code><code>                      </code><code class="n">signal</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">features</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code>&#13;
</code><code>                      </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">NEW SIGNAL: {signal}</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="se">\r</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>                      </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">signal</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-9" id="co_automating_trading_operations_CO16-11"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>                          </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">*** GOING LONG ***</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="n">units</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>                      </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">signal</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO16-10" id="co_automating_trading_operations_CO16-12"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>                          </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">*** GOING SHORT ***</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code><code>&#13;
</code><code>                                      </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>&#13;
</code><code>                          </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-1" id="callout_automating_trading_operations_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The trained AdaBoost model object and the normalization parameters.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-4" id="callout_automating_trading_operations_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The number of units traded.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-5" id="callout_automating_trading_operations_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The initial, neutral position.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-6" id="callout_automating_trading_operations_CO16-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The bar length on which the algorithm is implemented.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-7" id="callout_automating_trading_operations_CO16-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The length of the window for selected features.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-8" id="callout_automating_trading_operations_CO16-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The number of lags (must be in line with algorithm training).</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-9" id="callout_automating_trading_operations_CO16-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>The method that generates the lagged features data.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-10" id="callout_automating_trading_operations_CO16-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>The redefined method that embodies the trading logic.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-11" id="callout_automating_trading_operations_CO16-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Check for a long signal and long trade.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO16-12" id="callout_automating_trading_operations_CO16-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Check for a short signal and short trade.</p></dd>&#13;
</dl>&#13;
&#13;
<p>With the new class <code>MLTrader</code>, automated trading is made simple. A few lines of code are enough in an interactive context. The parameters are set such that the first order is placed after a short while. In reality, however, all parameters must, of course, be in line with original ones from the research and backtesting phase. They could, for example, also be persisted on disk and be read with the algorithm:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">113</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mlt</code><code> </code><code class="o">=</code><code> </code><code class="n">MLTrader</code><code class="p">(</code><code class="s1">'</code><code class="s1">../pyalgo.cfg</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">algorithm</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO17-1" id="co_automating_trading_operations_CO17-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">114</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">mlt</code><code class="o">.</code><code class="n">stream_data</code><code class="p">(</code><code class="n">instrument</code><code class="p">,</code><code> </code><code class="n">stop</code><code class="o">=</code><code class="mi">500</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO17-2" id="co_automating_trading_operations_CO17-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>          </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">*** CLOSING OUT ***</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>          </code><code class="n">mlt</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="n">mlt</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="n">mlt</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">*</code><code> </code><code class="n">mlt</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_automating_trading_operations_CO17-3" id="co_automating_trading_operations_CO17-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO17-1" id="callout_automating_trading_operations_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instantiates the trading object.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO17-2" id="callout_automating_trading_operations_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Starts the streaming, data processing, and trading.</p></dd>&#13;
<dt><a class="co" href="#co_automating_trading_operations_CO17-3" id="callout_automating_trading_operations_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Closes out the final open position.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The preceding code generates an output similar to the following<a data-startref="ix_10_automated_trading_-asciidoc23" data-type="indexterm" id="idm45785336558504"/>:<a data-startref="ix_10_automated_trading_-asciidoc22" data-type="indexterm" id="idm45785336557704"/><a data-startref="ix_10_automated_trading_-asciidoc21" data-type="indexterm" id="idm45785334048504"/></p>&#13;
&#13;
<pre data-type="programlisting">          *** GOING LONG ***&#13;
&#13;
&#13;
          {'id': '1735', 'time': '2020-08-19T14:46:15.552233563Z', 'userID':&#13;
           13834683, 'accountID': '101-004-13834683-001', 'batchID': '1734',&#13;
           'requestID': '42730658849646182', 'type': 'ORDER_FILL', 'orderID':&#13;
           '1734', 'instrument': 'EUR_USD', 'units': '100000.0',&#13;
           'gainQuoteHomeConversionFactor': '0.835983419025',&#13;
           'lossQuoteHomeConversionFactor': '0.844385262432', 'price': 1.1903,&#13;
           'fullVWAP': 1.1903, 'fullPrice': {'type': 'PRICE', 'bids': [{'price':&#13;
           1.19013, 'liquidity': '10000000'}], 'asks': [{'price': 1.1903,&#13;
           'liquidity': '10000000'}], 'closeoutBid': 1.19013, 'closeoutAsk':&#13;
           1.1903}, 'reason': 'MARKET_ORDER', 'pl': '0.0', 'financing': '0.0',&#13;
           'commission': '0.0', 'guaranteedExecutionFee': '0.0',&#13;
           'accountBalance': '98507.7425', 'tradeOpened': {'tradeID': '1735',&#13;
           'units': '100000.0', 'price': 1.1903, 'guaranteedExecutionFee': '0.0',&#13;
           'halfSpreadCost': '7.1416', 'initialMarginRequired': '3330.0'},&#13;
           'halfSpreadCost': '7.1416'}&#13;
&#13;
          *** GOING SHORT ***&#13;
&#13;
&#13;
          {'id': '1737', 'time': '2020-08-19T14:48:10.510726213Z', 'userID':&#13;
           13834683, 'accountID': '101-004-13834683-001', 'batchID': '1736',&#13;
           'requestID': '42730659332312267', 'type': 'ORDER_FILL', 'orderID':&#13;
           '1736', 'instrument': 'EUR_USD', 'units': '-200000.0',&#13;
           'gainQuoteHomeConversionFactor': '0.835885095595',&#13;
           'lossQuoteHomeConversionFactor': '0.844285950827', 'price': 1.19029,&#13;
           'fullVWAP': 1.19029, 'fullPrice': {'type': 'PRICE', 'bids': [{'price':&#13;
           1.19029, 'liquidity': '10000000'}], 'asks': [{'price': 1.19042,&#13;
           'liquidity': '10000000'}], 'closeoutBid': 1.19029, 'closeoutAsk':&#13;
           1.19042}, 'reason': 'MARKET_ORDER', 'pl': '-0.8443', 'financing':&#13;
           '0.0', 'commission': '0.0', 'guaranteedExecutionFee': '0.0',&#13;
           'accountBalance': '98506.8982', 'tradeOpened': {'tradeID': '1737',&#13;
           'units': '-100000.0', 'price': 1.19029, 'guaranteedExecutionFee':&#13;
           '0.0', 'halfSpreadCost': '5.4606', 'initialMarginRequired': '3330.0'},&#13;
           'tradesClosed': [{'tradeID': '1735', 'units': '-100000.0', 'price':&#13;
           1.19029, 'realizedPL': '-0.8443', 'financing': '0.0',&#13;
           'guaranteedExecutionFee': '0.0', 'halfSpreadCost': '5.4606'}],&#13;
           'halfSpreadCost': '10.9212'}&#13;
&#13;
          *** GOING LONG ***&#13;
&#13;
&#13;
          {'id': '1739', 'time': '2020-08-19T14:48:15.529680632Z', 'userID':&#13;
           13834683, 'accountID': '101-004-13834683-001', 'batchID': '1738',&#13;
           'requestID': '42730659353297789', 'type': 'ORDER_FILL', 'orderID':&#13;
           '1738', 'instrument': 'EUR_USD', 'units': '200000.0',&#13;
           'gainQuoteHomeConversionFactor': '0.835835944263',&#13;
           'lossQuoteHomeConversionFactor': '0.844236305512', 'price': 1.1905,&#13;
           'fullVWAP': 1.1905, 'fullPrice': {'type': 'PRICE', 'bids': [{'price':&#13;
           1.19035, 'liquidity': '10000000'}], 'asks': [{'price': 1.1905,&#13;
           'liquidity': '10000000'}], 'closeoutBid': 1.19035, 'closeoutAsk':&#13;
           1.1905}, 'reason': 'MARKET_ORDER', 'pl': '-17.729', 'financing':&#13;
           '0.0', 'commission': '0.0', 'guaranteedExecutionFee': '0.0',&#13;
           'accountBalance': '98489.1692', 'tradeOpened': {'tradeID': '1739',&#13;
           'units': '100000.0', 'price': 1.1905, 'guaranteedExecutionFee': '0.0',&#13;
           'halfSpreadCost': '6.3003', 'initialMarginRequired': '3330.0'},&#13;
           'tradesClosed': [{'tradeID': '1737', 'units': '100000.0', 'price':&#13;
           1.1905, 'realizedPL': '-17.729', 'financing': '0.0',&#13;
           'guaranteedExecutionFee': '0.0', 'halfSpreadCost': '6.3003'}],&#13;
           'halfSpreadCost': '12.6006'}&#13;
&#13;
          *** CLOSING OUT ***&#13;
&#13;
&#13;
          {'id': '1741', 'time': '2020-08-19T14:49:11.976885485Z', 'userID':&#13;
           13834683, 'accountID': '101-004-13834683-001', 'batchID': '1740',&#13;
           'requestID': '42730659588338204', 'type': 'ORDER_FILL', 'orderID':&#13;
           '1740', 'instrument': 'EUR_USD', 'units': '-100000.0',&#13;
           'gainQuoteHomeConversionFactor': '0.835730636848',&#13;
           'lossQuoteHomeConversionFactor': '0.844129939731', 'price': 1.19051,&#13;
           'fullVWAP': 1.19051, 'fullPrice': {'type': 'PRICE', 'bids': [{'price':&#13;
           1.19051, 'liquidity': '10000000'}], 'asks': [{'price': 1.19064,&#13;
           'liquidity': '10000000'}], 'closeoutBid': 1.19051, 'closeoutAsk':&#13;
           1.19064}, 'reason': 'MARKET_ORDER', 'pl': '0.8357', 'financing':&#13;
           '0.0', 'commission': '0.0', 'guaranteedExecutionFee': '0.0',&#13;
           'accountBalance': '98490.0049', 'tradesClosed': [{'tradeID': '1739',&#13;
           'units': '-100000.0', 'price': 1.19051, 'realizedPL': '0.8357',&#13;
           'financing': '0.0', 'guaranteedExecutionFee': '0.0', 'halfSpreadCost':&#13;
           '5.4595'}], 'halfSpreadCost': '5.4595'}</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Infrastructure and Deployment" data-type="sect1"><div class="sect1" id="auto_infra_deploy">&#13;
<h1>Infrastructure and Deployment</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="infrastructure and deployment" data-type="indexterm" id="idm45785334046472"/>Deploying an automated algorithmic trading strategy with real funds requires an appropriate infrastructure. Among other things, the infrastructure should satisfy the following:</p>&#13;
<dl>&#13;
<dt>Reliability</dt>&#13;
<dd>&#13;
<p>The infrastructure on which to deploy an algorithmic trading strategy should allow for high availability (for example, 99.9% or higher) and should otherwise take care of reliability (automatic backups, redundancy of drives and web connections, and so on).</p>&#13;
</dd>&#13;
<dt>Performance</dt>&#13;
<dd>&#13;
<p>Depending on the amount of data being processed and the computational demand the algorithms generate, the infrastructure must have enough CPU cores, working memory (RAM), and storage (SSD). In addition, the web connections should be fast enough.</p>&#13;
</dd>&#13;
<dt>Security</dt>&#13;
<dd>&#13;
<p>The operating system and the applications that run on it should be protected by strong passwords, as well as SSL encryption and hard drive encryption. The hardware should be protected from fire, water, and unauthorized physical access.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Basically, these requirements can only be fulfilled by renting an appropriate infrastructure from a professional data center or a cloud provider. Own investments in the physical infrastructure to satisfy the aforementioned requirements can in general only be justified by the bigger, or even the biggest, players in the financial markets.</p>&#13;
&#13;
<p><a data-primary="Droplet" data-secondary="costs" data-type="indexterm" id="idm45785333994088"/>From a development and testing point of view, even the smallest Droplet (cloud instance) from DigitalOcean (<a href="http://digitalocean.com"><em class="hyperlink">http://digitalocean.com</em></a>) is enough to get started. At the time of writing, such a Droplet costs 5 USD per month and is billed by the hour, created within minutes, and destroyed within seconds.<sup><a data-type="noteref" href="ch10.html#idm45785334066856" id="idm45785334066856-marker">3</a></sup></p>&#13;
&#13;
<p>How to set up a Droplet with DigitalOcean is explained in detail in <a data-type="xref" href="ch02.html#python_environment">Chapter¬†2</a> (specifically in <a data-type="xref" href="ch02.html#cloud_instance">‚ÄúUsing Cloud Instances‚Äù</a>), with Bash scripts that can be adjusted to reflect individual requirements regarding Python packages, for example.</p>&#13;
<div data-type="caution">&#13;
<p>Although the development and testing of automated algorithmic trading strategies is possible from a local computer (desktop, notebook, or similar), it is not appropriate for the deployment of automated strategies trading real money. A simple loss of the web connection or a brief power outage might bring down the whole algorithm, leaving, for example, unintended open positions in the portfolio. As another example, it would cause one to miss out on real-time tick data and end up with corrupted data sets, potentially leading to wrong signals and unintended trades and positions.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logging and Monitoring" data-type="sect1"><div class="sect1" id="auto_logg_monit">&#13;
<h1>Logging and Monitoring</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="logging and monitoring" data-type="indexterm" id="ix_10_automated_trading_-asciidoc24"/><a data-primary="logging, of automated trading operations" data-type="indexterm" id="ix_10_automated_trading_-asciidoc25"/><a data-primary="monitoring" data-secondary="automated trading operations" data-type="indexterm" id="ix_10_automated_trading_-asciidoc26"/>Assume now that the automated algorithmic trading strategy is to be deployed on a remote server (virtual cloud instance or dedicated server). Further assume that all required Python packages have been installed (see <a data-type="xref" href="ch02.html#cloud_instance">‚ÄúUsing Cloud Instances‚Äù</a>) and that, for instance, <code>Jupyter Lab</code> is running securely (see <a href="https://oreil.ly/cnBHE">Running a notebook server</a>). What else needs to be considered from the algorithmic traders‚Äô point of view if they do not want to sit all day in front of the screen being logged in to the server?</p>&#13;
&#13;
<p>This section addresses two important topics in this regard: <em>logging</em> and <em>real-time monitoring</em>. Logging persists information and events on disk for later inspection. It is standard practice in software application development and deployment. However, here the focus might be put instead on the financial side, logging important financial data and event information for later inspection and analysis. The same holds true for real-time monitoring making use of socket communication. Via sockets, a constant real-time stream of important financial aspects can be created that can then be retrieved and processed on a local computer, even if the deployment happens in the cloud.</p>&#13;
&#13;
<p><a data-type="xref" href="#auto_script">‚ÄúAutomated Trading Strategy‚Äù</a> presents a Python script implementing all these aspects and making use of the code from <a data-type="xref" href="#auto_online">‚ÄúOnline Algorithm‚Äù</a>. The script brings the code in a shape that allows, for example, the <em>deployment</em> of the algorithmic trading strategy‚Äîsbased on the persisted algorithm object‚Äîson a remote server. It adds both <em>logging and monitoring</em> capabilities based on a custom function that, among other things, makes use of <code>ZeroMQ</code> (see <a href="http://zeromq.org"><em class="hyperlink">http://zeromq.org</em></a>) for socket communication. In combination with the short script from <a data-type="xref" href="#auto_monitor">‚ÄúStrategy Monitoring‚Äù</a>, this allows for a remote real-time monitoring of the activity on a remote server.<sup><a data-type="noteref" href="ch10.html#idm45785334006200" id="idm45785334006200-marker">4</a></sup></p>&#13;
&#13;
<p>When the script from <a data-type="xref" href="#auto_script">‚ÄúAutomated Trading Strategy‚Äù</a> is executed, either locally or remotely, the output that is logged and sent via the socket looks as follows:</p>&#13;
&#13;
<pre data-type="programlisting">2020-06-15 17:04:14.298653&#13;
================================================================================&#13;
NUMBER OF TICKS: 147 | NUMBER OF BARS: 49&#13;
&#13;
================================================================================&#13;
MOST RECENT DATA&#13;
                     return_lag_1  return_lag_2  ...  max_lag_5  max_lag_6&#13;
2020-06-15 15:04:06      0.026508     -0.125253  ...  -1.703276  -1.700746&#13;
2020-06-15 15:04:08     -0.049373      0.026508  ...  -1.694419  -1.703276&#13;
2020-06-15 15:04:10     -0.077828     -0.049373  ...  -1.694419  -1.694419&#13;
2020-06-15 15:04:12      0.064448     -0.077828  ...  -1.705807  -1.694419&#13;
2020-06-15 15:04:14     -0.020918      0.064448  ...  -1.710869  -1.705807&#13;
&#13;
[5 rows x 36 columns]&#13;
&#13;
================================================================================&#13;
features:&#13;
[[-0.02091774  0.06444794 -0.07782834 -0.04937258  0.02650799 -0.12525265&#13;
  -2.06428556 -1.96568848 -2.16288147 -2.08071843 -1.94925692 -2.19574189&#13;
   0.92939697  0.92939697 -1.07368691  0.92939697 -1.07368691 -1.07368691&#13;
  -1.41861822 -1.42605902 -1.4294412  -1.42470615 -1.4274119  -1.42470615&#13;
  -1.05508516 -1.06879043 -1.06879043 -1.0619378  -1.06741991 -1.06741991&#13;
  -1.70580717 -1.70707253 -1.71339931 -1.7108686  -1.7108686  -1.70580717]]&#13;
position: 1&#13;
signal:   1&#13;
&#13;
&#13;
2020-06-15 17:04:14.402154&#13;
================================================================================&#13;
*** NO TRADE PLACED ***&#13;
&#13;
*** END OF CYCLE ***&#13;
&#13;
&#13;
2020-06-15 17:04:16.199950&#13;
================================================================================&#13;
&#13;
&#13;
================================================================================&#13;
*** GOING NEUTRAL ***&#13;
&#13;
{'id': '979', 'time': '2020-06-15T15:04:16.138027118Z', 'userID': 13834683,&#13;
'accountID': '101-004-13834683-001', 'batchID': '978',&#13;
'requestID': '60721506683906591', 'type': 'ORDER_FILL', 'orderID': '978',&#13;
'instrument': 'EUR_USD', 'units': '-100000.0',&#13;
'gainQuoteHomeConversionFactor': '0.882420762903',&#13;
'lossQuoteHomeConversionFactor': '0.891289313284',&#13;
'price': 1.12751, 'fullVWAP': 1.12751, 'fullPrice': {'type': 'PRICE',&#13;
'bids': [{'price': 1.12751, 'liquidity': '10000000'}],&#13;
'asks': [{'price': 1.12765, 'liquidity': '10000000'}],&#13;
'closeoutBid': 1.12751, 'closeoutAsk': 1.12765}, 'reason': 'MARKET_ORDER',&#13;
'pl': '-3.5652', 'financing': '0.0', 'commission': '0.0',&#13;
'guaranteedExecutionFee': '0.0', 'accountBalance': '99259.7485',&#13;
'tradesClosed': [{'tradeID': '975', 'units': '-100000.0',&#13;
'price': 1.12751, 'realizedPL': '-3.5652', 'financing': '0.0',&#13;
'guaranteedExecutionFee': '0.0', 'halfSpreadCost': '6.208'}],&#13;
'halfSpreadCost': '6.208'}&#13;
================================================================================</pre>&#13;
&#13;
<p>Running the script from <a data-type="xref" href="#auto_monitor">‚ÄúStrategy Monitoring‚Äù</a> locally then allows for the real-time retrieval and processing of such information. Of course, it is easy to adjust the logging and streaming data to one‚Äôs own requirements.<sup><a data-type="noteref" href="ch10.html#idm45785336429992" id="idm45785336429992-marker">5</a></sup> Furthermore, the trading script and the whole logic can be adjusted to include such elements as stop losses or take profit targets programmatically.</p>&#13;
<div data-type="caution">&#13;
<p><a data-primary="CFD (contracts for difference)" data-secondary="algorithmic trading risks" data-type="indexterm" id="idm45785336290008"/><a data-primary="currency pairs" data-secondary="algorithmic trading risks" data-type="indexterm" id="idm45785336288952"/><a data-primary="currency pairs" data-seealso="EUR/USD exchange rate" data-type="indexterm" id="idm45785334100840"/>Trading currency pairs and/or CFDs is associated with a number of financial risks. Implementing an algorithmic trading strategy for such instruments automatically leads to a number of additional risks. Among them are flaws in the trading and/or execution logic, as well as technical risks including problems associated with socket communication, delayed retrieval, or even loss of tick data during the deployment. Therefore, before one deploys a trading strategy in automated fashion one should make sure that all associated market, execution, operational, technical, and other risks have been identified, evaluated, and properly addressed. The code presented in this chapter is only for technical illustration purposes.<a data-startref="ix_10_automated_trading_-asciidoc26" data-type="indexterm" id="idm45785334099064"/><a data-startref="ix_10_automated_trading_-asciidoc25" data-type="indexterm" id="idm45785334098376"/><a data-startref="ix_10_automated_trading_-asciidoc24" data-type="indexterm" id="idm45785334097688"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Visual Step-by-Step Overview" data-type="sect1"><div class="sect1" id="viz_summary">&#13;
<h1>Visual Step-by-Step Overview</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="visual step-by-step overview" data-type="indexterm" id="ix_10_automated_trading_-asciidoc27"/>This final section provides a step-by-step overview in screenshots. While the previous sections are based on the FXCM trading platform, the visual overview is based on the Oanda trading platform.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuring Oanda Account" data-type="sect2"><div class="sect2" id="idm45785334015912">&#13;
<h2>Configuring Oanda Account</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="configuring Oanda account" data-type="indexterm" id="idm45785334014776"/><a data-primary="Oanda" data-secondary="account configuration" data-type="indexterm" id="idm45785334013720"/>The first step is to set up an account with Oanda (or any other trading platform to this end) and to set the correct leverage ratio for the account according to the Kelly criterion and as shown in <a data-type="xref" href="#auto_00">Figure¬†10-8</a>.</p>&#13;
&#13;
<figure><div class="figure" id="auto_00">&#13;
<img alt="pfat 1008" src="assets/pfat_1008.png"/>&#13;
<h6><span class="label">Figure 10-8. </span>Setting leverage on Oanda</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up the Hardware" data-type="sect2"><div class="sect2" id="idm45785336486936">&#13;
<h2>Setting Up the Hardware</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="hardware setup" data-type="indexterm" id="idm45785336485736"/><a data-primary="DigitalOcean" data-secondary="droplet setup" data-type="indexterm" id="idm45785336484744"/>The second step is to create a DigitalOcean droplet, as shown in <a data-type="xref" href="#auto_01">Figure¬†10-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="auto_01">&#13;
<img alt="pfat 1009" src="assets/pfat_1009.png"/>&#13;
<h6><span class="label">Figure 10-9. </span>DigitalOcean droplet</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up the Python Environment" data-type="sect2"><div class="sect2" id="idm45785334027112">&#13;
<h2>Setting Up the Python Environment</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="Python environment setup" data-type="indexterm" id="idm45785334025912"/>The third step is to put all the software on the droplet (see <a data-type="xref" href="#auto_02">Figure¬†10-10</a>) in order to set up the infrastructure.&#13;
When it all works fine, you can create a new Jupyter Notebook and start your interactive Python session (see <a data-type="xref" href="#auto_03">Figure¬†10-11</a>).</p>&#13;
&#13;
<figure class="width-80"><div class="figure" id="auto_02">&#13;
<img alt="pfat 1010" src="assets/pfat_1010.png"/>&#13;
<h6><span class="label">Figure 10-10. </span>Installing Python and packages</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="auto_03">&#13;
<img alt="pfat 1011" src="assets/pfat_1011.png"/>&#13;
<h6><span class="label">Figure 10-11. </span>Testing Jupyter Lab</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uploading the Code" data-type="sect2"><div class="sect2" id="idm45785336170216">&#13;
<h2>Uploading the Code</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="uploading code" data-type="indexterm" id="idm45785336168984"/><a data-primary="Python scripts" data-secondary="uploading for automated trading operations" data-type="indexterm" id="idm45785336167944"/>The fourth step is to upload the Python scripts for automated trading and real-time monitoring, as shown in <a data-type="xref" href="#auto_04">Figure¬†10-12</a>. The configuration file with the account credentials also needs to be uploaded.</p>&#13;
&#13;
<figure><div class="figure" id="auto_04">&#13;
<img alt="pfat 1012" src="assets/pfat_1012.png"/>&#13;
<h6><span class="label">Figure 10-12. </span>Uploading Python code files</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running the Code" data-type="sect2"><div class="sect2" id="idm45785336581048">&#13;
<h2>Running the Code</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="running code" data-type="indexterm" id="idm45785336579848"/><a data-primary="Python scripts" data-secondary="automated trading operations" data-type="indexterm" id="idm45785336578808"/>The fifth step is to run the Python script for automated trading, as shown in <a data-type="xref" href="#auto_05">Figure¬†10-13</a>.&#13;
<a data-type="xref" href="#auto_06">Figure¬†10-14</a> shows a trade that the Python script has initiated.</p>&#13;
&#13;
<figure><div class="figure" id="auto_05">&#13;
<img alt="pfat 1013" src="assets/pfat_1013.png"/>&#13;
<h6><span class="label">Figure 10-13. </span>Running the Python script</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="auto_06">&#13;
<img alt="pfat 1014" src="assets/pfat_1014.png"/>&#13;
<h6><span class="label">Figure 10-14. </span>A trade initiated by the Python script</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Real-Time Monitoring" data-type="sect2"><div class="sect2" id="idm45785334038344">&#13;
<h2>Real-Time Monitoring</h2>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="real-time monitoring" data-type="indexterm" id="idm45785334558008"/><a data-primary="monitoring" data-secondary="automated trading operations" data-type="indexterm" id="idm45785334556968"/><a data-primary="real-time monitoring" data-type="indexterm" id="idm45785334556008"/>The final step is to run the monitoring script locally (provided you have set the correct IP in the local script), as seen in <a data-type="xref" href="#auto_07">Figure¬†10-15</a>. In practice, this means that you can monitor locally in real time what exactly is happening on your cloud instance.<a data-startref="ix_10_automated_trading_-asciidoc27" data-type="indexterm" id="idm45785334554136"/></p>&#13;
&#13;
<figure><div class="figure" id="auto_07">&#13;
<img alt="pfat 1015" src="assets/pfat_1015.png"/>&#13;
<h6><span class="label">Figure 10-15. </span>Local real-time monitoring via socket</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusions" data-type="sect1"><div class="sect1" id="idm45785336524968">&#13;
<h1>Conclusions</h1>&#13;
&#13;
<p>This chapter is about the deployment of an algorithmic trading strategy in automated fashion, based on a classification algorithm from machine learning to predict the direction of market movements. It addresses such important topics as capital management (based on the Kelly criterion), vectorized backtesting for performance and risk, the transformation of offline to online trading algorithms, an appropriate infrastructure for deployment, and logging and monitoring during deployment.</p>&#13;
&#13;
<p>The topic of this chapter is complex and requires a broad skill set from the algorithmic trading practitioner. On the other hand, having RESTful APIs for algorithmic trading available, such as the one from Oanda, simplifies the automation task considerably since the core part boils down mainly to making use of the capabilities of the Python wrapper package <code>tpqoa</code> for tick data retrieval and order placement. Around this core, elements to mitigate operational and technical risks should be added as far as appropriate and possible.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="References and Further Resources" data-type="sect1"><div class="sect1" id="idm45785336521608">&#13;
<h1>References and Further Resources</h1>&#13;
&#13;
<p>Papers cited in this chapter:</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Rotando, Louis, and Edward Thorp. 1992. ‚ÄúThe Kelly Criterion and the Stock Market.‚Äù <em>The American Mathematical Monthly</em> 99 (10): 922-931.</p>&#13;
</li>&#13;
<li>&#13;
<p>Hung, Jane. 2010. ‚ÄúBetting with the Kelly Criterion.‚Äù <a href="http://bit.ly/betting_with_kelly"><em class="hyperlink">http://bit.ly/betting_with_kelly</em></a>.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Script" data-type="sect1"><div class="sect1" id="idm45785334310216">&#13;
<h1>Python Script</h1>&#13;
&#13;
<p><a data-primary="automated trading operations" data-secondary="Python scripts for" data-type="indexterm" id="ix_10_automated_trading_-asciidoc28"/><a data-primary="Python scripts" data-secondary="automated trading operations" data-type="indexterm" id="ix_10_automated_trading_-asciidoc29"/>This section contains Python scripts used in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Trading Strategy" data-type="sect2"><div class="sect2" id="auto_script">&#13;
<h2>Automated Trading Strategy</h2>&#13;
&#13;
<p><a data-primary="ML-based strategies" data-secondary="Python script for" data-type="indexterm" id="idm45785336568216"/>The following Python script contains the code for the automated deployment of the ML-based trading strategy, as discussed and backtested in this chapter:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Automated ML-Based Trading Strategy for Oanda</code>&#13;
<code class="c1"># Online Algorithm, Logging, Monitoring</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="kn">import</code> <code class="nn">tpqoa</code>&#13;
<code class="kn">import</code> <code class="nn">pickle</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">import</code> <code class="nn">datetime</code> <code class="kn">as</code> <code class="nn">dt</code>&#13;
&#13;
<code class="n">log_file</code> <code class="o">=</code> <code class="s1">'automated_strategy.log'</code>&#13;
&#13;
<code class="c1"># loads the persisted algorithm object</code>&#13;
<code class="n">algorithm</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="nb">open</code><code class="p">(</code><code class="s1">'algorithm.pkl'</code><code class="p">,</code> <code class="s1">'rb'</code><code class="p">))</code>&#13;
&#13;
<code class="c1"># sets up the socket communication via ZeroMQ (here: "publisher")</code>&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># this binds the socket communication to all IP addresses of the machine</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'tcp://0.0.0.0:5555'</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># recreating the log file</code>&#13;
<code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">log_file</code><code class="p">,</code> <code class="s1">'w'</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
    <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s1">'*** NEW LOG FILE ***</code><code class="se">\n</code><code class="s1">'</code><code class="p">)</code>&#13;
    <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="nb">str</code><code class="p">(</code><code class="n">dt</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n\n\n</code><code class="s1">'</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">def</code> <code class="nf">logger_monitor</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="n">time</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">sep</code><code class="o">=</code><code class="bp">True</code><code class="p">):</code>&#13;
    <code class="sd">''' Custom logger and monitor function.</code>&#13;
<code class="sd">    '''</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">log_file</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
        <code class="n">t</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">dt</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="s1">''</code>&#13;
        <code class="k">if</code> <code class="n">time</code><code class="p">:</code>&#13;
            <code class="n">msg</code> <code class="o">+=</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="n">t</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="k">if</code> <code class="n">sep</code><code class="p">:</code>&#13;
            <code class="n">msg</code> <code class="o">+=</code> <code class="mi">80</code> <code class="o">*</code> <code class="s1">'='</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">message</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n\n</code><code class="s1">'</code>&#13;
        <code class="c1"># sends the message via the socket</code>&#13;
        <code class="n">socket</code><code class="o">.</code><code class="n">send_string</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="c1"># writes the message to the log file</code>&#13;
        <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">MLTrader</code><code class="p">(</code><code class="n">tpqoa</code><code class="o">.</code><code class="n">tpqoa</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">config_file</code><code class="p">,</code> <code class="n">algorithm</code><code class="p">):</code>&#13;
        <code class="nb">super</code><code class="p">(</code><code class="n">MLTrader</code><code class="p">,</code> <code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="n">config_file</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">model</code> <code class="o">=</code> <code class="n">algorithm</code><code class="p">[</code><code class="s1">'model'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">mu</code> <code class="o">=</code> <code class="n">algorithm</code><code class="p">[</code><code class="s1">'mu'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">std</code> <code class="o">=</code> <code class="n">algorithm</code><code class="p">[</code><code class="s1">'std'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">=</code> <code class="mi">100000</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">=</code> <code class="s1">'2s'</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">window</code> <code class="o">=</code> <code class="mi">2</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">=</code> <code class="mi">6</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">window</code> <code class="o">+</code> <code class="mi">1</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">features</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'return'</code><code class="p">,</code> <code class="s1">'vol'</code><code class="p">,</code> <code class="s1">'mom'</code><code class="p">,</code> <code class="s1">'sma'</code><code class="p">,</code> <code class="s1">'min'</code><code class="p">,</code> <code class="s1">'max'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">prepare_features</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'vol'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mom'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">sign</code><code class="p">(</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">())</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'sma'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'min'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">min</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'max'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">max</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code> <code class="o">-=</code> <code class="bp">self</code><code class="o">.</code><code class="n">mu</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code> <code class="o">/=</code> <code class="bp">self</code><code class="o">.</code><code class="n">std</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">cols</code> <code class="o">=</code> <code class="p">[]</code>&#13;
        <code class="k">for</code> <code class="n">f</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">:</code>&#13;
            <code class="k">for</code> <code class="n">lag</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>&#13;
                <code class="n">col</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'{f}_lag_{lag}'</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">col</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">f</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="n">lag</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">col</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">report_trade</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">pos</code><code class="p">,</code> <code class="n">order</code><code class="p">):</code>&#13;
        <code class="sd">''' Prints, logs, and sends trade data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">out</code> <code class="o">=</code> <code class="s1">'</code><code class="se">\n\n</code><code class="s1">'</code> <code class="o">+</code> <code class="mi">80</code> <code class="o">*</code> <code class="s1">'='</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="n">out</code> <code class="o">+=</code> <code class="s1">'*** GOING {} *** </code><code class="se">\n</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">pos</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="n">out</code> <code class="o">+=</code> <code class="nb">str</code><code class="p">(</code><code class="n">order</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="n">out</code> <code class="o">+=</code> <code class="mi">80</code> <code class="o">*</code> <code class="s1">'='</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code>&#13;
        <code class="n">logger_monitor</code><code class="p">(</code><code class="n">out</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">out</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">on_success</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">time</code><code class="p">,</code> <code class="n">bid</code><code class="p">,</code> <code class="n">ask</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">ticks</code><code class="p">,</code> <code class="mi">20</code> <code class="o">*</code> <code class="s1">' '</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="se">\r</code><code class="s1">'</code><code class="p">)</code>&#13;
        <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code><code class="s1">'bid'</code><code class="p">:</code> <code class="nb">float</code><code class="p">(</code><code class="n">bid</code><code class="p">),</code> <code class="s1">'ask'</code><code class="p">:</code> <code class="nb">float</code><code class="p">(</code><code class="n">ask</code><code class="p">)},</code>&#13;
                          <code class="n">index</code><code class="o">=</code><code class="p">[</code><code class="n">pd</code><code class="o">.</code><code class="n">Timestamp</code><code class="p">(</code><code class="n">time</code><code class="p">)</code><code class="o">.</code><code class="n">tz_localize</code><code class="p">(</code><code class="bp">None</code><code class="p">)])</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">df</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">raw_data</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'right'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">()</code><code class="o">.</code><code class="n">ffill</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code class="p">:</code>&#13;
            <code class="n">logger_monitor</code><code class="p">(</code><code class="s1">'NUMBER OF TICKS: {} | '</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">ticks</code><code class="p">)</code> <code class="o">+</code>&#13;
                           <code class="s1">'NUMBER OF BARS: {}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">min_length</code><code class="p">))</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">min_length</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'mid'</code><code class="p">]</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'bid'</code><code class="p">]</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'ask'</code><code class="p">])</code> <code class="o">/</code> <code class="mi">2</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">prepare_features</code><code class="p">()</code>&#13;
            <code class="n">features</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">values</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
            <code class="n">signal</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">features</code><code class="p">)[</code><code class="mi">0</code><code class="p">]</code>&#13;
            <code class="c1"># logs and sends major financial information</code>&#13;
            <code class="n">logger_monitor</code><code class="p">(</code><code class="s1">'MOST RECENT DATA</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code>&#13;
                           <code class="nb">str</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">cols</code><code class="p">]</code><code class="o">.</code><code class="n">tail</code><code class="p">()),</code>&#13;
                           <code class="bp">False</code><code class="p">)</code>&#13;
            <code class="n">logger_monitor</code><code class="p">(</code><code class="s1">'features:</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code> <code class="nb">str</code><code class="p">(</code><code class="n">features</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code>&#13;
                           <code class="s1">'position: '</code> <code class="o">+</code> <code class="nb">str</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code> <code class="o">+</code>&#13;
                           <code class="s1">'signal:   '</code> <code class="o">+</code> <code class="nb">str</code><code class="p">(</code><code class="n">signal</code><code class="p">),</code> <code class="bp">False</code><code class="p">)</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">signal</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>  <code class="c1"># going long?</code>&#13;
                <code class="n">order</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code>&#13;
                                          <code class="n">units</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code> <code class="o">*</code>&#13;
                                          <code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>&#13;
                                          <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="s1">'LONG'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">signal</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>  <code class="c1"># going short?</code>&#13;
                <code class="n">order</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code>&#13;
                                          <code class="n">units</code><code class="o">=-</code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code><code class="p">)</code> <code class="o">*</code>&#13;
                                          <code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>&#13;
                                          <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="s1">'SHORT'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>&#13;
            <code class="k">else</code><code class="p">:</code>  <code class="c1"># no trade</code>&#13;
                <code class="n">logger_monitor</code><code class="p">(</code><code class="s1">'*** NO TRADE PLACED ***'</code><code class="p">)</code>&#13;
&#13;
            <code class="n">logger_monitor</code><code class="p">(</code><code class="s1">'*** END OF CYCLE ***</code><code class="se">\n\n</code><code class="s1">'</code><code class="p">,</code> <code class="bp">False</code><code class="p">,</code> <code class="bp">False</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">mlt</code> <code class="o">=</code> <code class="n">MLTrader</code><code class="p">(</code><code class="s1">'../pyalgo.cfg'</code><code class="p">,</code> <code class="n">algorithm</code><code class="p">)</code>&#13;
    <code class="n">mlt</code><code class="o">.</code><code class="n">stream_data</code><code class="p">(</code><code class="s1">'EUR_USD'</code><code class="p">,</code> <code class="n">stop</code><code class="o">=</code><code class="mi">150</code><code class="p">)</code>&#13;
    <code class="n">order</code> <code class="o">=</code> <code class="n">mlt</code><code class="o">.</code><code class="n">create_order</code><code class="p">(</code><code class="n">mlt</code><code class="o">.</code><code class="n">stream_instrument</code><code class="p">,</code>&#13;
                             <code class="n">units</code><code class="o">=-</code><code class="n">mlt</code><code class="o">.</code><code class="n">position</code> <code class="o">*</code> <code class="n">mlt</code><code class="o">.</code><code class="n">units</code><code class="p">,</code>&#13;
                             <code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">ret</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
    <code class="n">mlt</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
    <code class="n">mlt</code><code class="o">.</code><code class="n">report_trade</code><code class="p">(</code><code class="s1">'NEUTRAL'</code><code class="p">,</code> <code class="n">order</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strategy Monitoring" data-type="sect2"><div class="sect2" id="auto_monitor">&#13;
<h2>Strategy Monitoring</h2>&#13;
&#13;
<p><a data-primary="monitoring" data-secondary="Python scripts for strategy monitoring" data-type="indexterm" id="idm45785334993816"/><a data-primary="Python scripts" data-secondary="strategy monitoring" data-type="indexterm" id="idm45785334992776"/>The following Python script contains code to remotely monitor the execution of the Python script from <a data-type="xref" href="#auto_script">‚ÄúAutomated Trading Strategy‚Äù</a><a data-startref="ix_10_automated_trading_-asciidoc29" data-type="indexterm" id="idm45785334990920"/><a data-startref="ix_10_automated_trading_-asciidoc28" data-type="indexterm" id="idm45785334990232"/>.<a data-startref="ix_10_automated_trading_-asciidoc0" data-type="indexterm" id="idm45785334989416"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Automated ML-Based Trading Strategy for Oanda</code>&#13;
<code class="c1"># Strategy Monitoring via Socket Communication</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">zmq</code>&#13;
&#13;
<code class="c1"># sets up the socket communication via ZeroMQ (here: "subscriber")</code>&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">socket</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># adjust the IP address to reflect the remote location</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'tcp://134.122.70.51:5555'</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># local IP address used for testing</code>&#13;
<code class="c1"># socket.connect('tcp://0.0.0.0:5555')</code>&#13;
&#13;
&#13;
<code class="c1"># configures the socket to retrieve every message</code>&#13;
<code class="n">socket</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code> <code class="s1">''</code><code class="p">)</code>&#13;
&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">recv_string</code><code class="p">()</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45785342245112"><sup><a href="ch10.html#idm45785342245112-marker">1</a></sup> The exposition follows Hung (2010).</p><p data-type="footnote" id="idm45785339950712"><sup><a href="ch10.html#idm45785339950712-marker">2</a></sup> It is a stylized empirical fact that it is of paramount importance for the investment and trading performance to get the largest market movements right (that is, the biggest winner <em>and</em> loser movements). This aspect is neatly illustrated in <a data-type="xref" href="#auto_plot_05">Figure¬†10-5</a>, which shows that the trading strategy gets a large downwards movement in the underlying instrument correct, leading to a larger jump for the trading strategy.</p><p data-type="footnote" id="idm45785334066856"><sup><a href="ch10.html#idm45785334066856-marker">3</a></sup> Use the link <a href="http://bit.ly/do_sign_up"><em class="hyperlink">http://bit.ly/do_sign_up</em></a> to get a 10 USD bonus on DigitalOcean when signing up for a new account.</p><p data-type="footnote" id="idm45785334006200"><sup><a href="ch10.html#idm45785334006200-marker">4</a></sup> The logging approach used here is pretty simple in the form of a simple text file. It is easy to change the logging and persisting of, say, the relevant financial data in the form of a database or appropriate binary storage formats, such as <code>HDF5</code> (see <a data-type="xref" href="ch03.html#financial_data">Chapter¬†3</a>).</p><p data-type="footnote" id="idm45785336429992"><sup><a href="ch10.html#idm45785336429992-marker">5</a></sup> Note that the socket communication, as implemented in the two scripts, is not encrypted and is sending plain text over the web, which might represent a security risk in production.</p></div></div></section></body></html>