<html><head></head><body><section data-pdf-bookmark="Chapter 6. Building Classes for &#10;Event-Based Backtesting" data-type="chapter" epub:type="chapter"><div class="chapter" id="event_based_backtesting">&#13;
<h1><span class="label">Chapter 6. </span>Building Classes for &#13;
<span class="keep-together">Event-Based Backtesting</span></h1>&#13;
&#13;
<blockquote>&#13;
<p class="align_me_right"><a data-primary="event-based backtesting" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc0"/><a data-primary="event-based backtesting" data-secondary="building classes for" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc1"/>The <a data-primary="Cocteau, Jean" data-type="indexterm" id="idm45785364604952"/>actual tragedies of life bear no relation to one’s preconceived ideas. In the event, one is always bewildered by their simplicity, their grandeur of design, and by that element of the bizarre which seems inherent in them.</p>&#13;
<p data-type="attribution">Jean Cocteau</p>&#13;
</blockquote>&#13;
&#13;
<p>On the one hand, <em>vectorized backtesting</em> with <code>NumPy</code> and <code>pandas</code> is generally convenient and efficient to implement due to the concise code, and it is fast to execute due to these packages being optimized for such operations. However, the approach cannot cope with all types of trading strategies nor with all phenomena that the trading reality presents an algorithmic trader with. <a data-primary="vectorized backtesting" data-secondary="potential shortcomings" data-type="indexterm" id="idm45785364600968"/>When it comes to vectorized backtesting, potential shortcomings of the approach are the following:</p>&#13;
<dl>&#13;
<dt>Look-ahead bias</dt>&#13;
<dd>&#13;
<p>Vectorized backtesting is based on the complete data set available and does not take into account that new data arrives incrementally.</p>&#13;
</dd>&#13;
<dt>Simplification</dt>&#13;
<dd>&#13;
<p>For example, fixed transaction costs cannot be modeled by vectorization, which is mainly based on relative returns. Also, fixed amounts per trade or the non-divisibility of single financial instruments (for example, a share of a stock) cannot be modeled properly.</p>&#13;
</dd>&#13;
<dt>Non-recursiveness</dt>&#13;
<dd>&#13;
<p>Algorithms, embodying trading strategies, might take recurse to state variables over time, like profit and loss up to a certain point in time or similar path-dependent statistics. Vectorization cannot cope with such features.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="event-based backtesting" data-secondary="advantages" data-type="indexterm" id="idm45785363477368"/>On the other hand, <em>event-based backtesting</em> allows one to address these issues by a more realistic approach to model trading realities. On a basic level, an <em>event</em> is characterized by the arrival of new data. Backtesting a trading strategy for the Apple Inc. stock based on end-of-day data, an event would be a new closing price for the Apple stock. It can also be a change in an interest rate, or the hitting of a stop loss level. Advantages of the event-based backtesting approach generally are the following:</p>&#13;
<dl>&#13;
<dt>Incremental approach</dt>&#13;
<dd>&#13;
<p>As in the trading reality, backtesting takes place on the premise that new data arrives incrementally, tick-by-tick and quote-by-quote.</p>&#13;
</dd>&#13;
<dt>Realistic modeling</dt>&#13;
<dd>&#13;
<p>One has complete freedom to model those processes that are triggered by a new and specific event.</p>&#13;
</dd>&#13;
<dt>Path dependency</dt>&#13;
<dd>&#13;
<p>It is straightforward to keep track of conditional, recursive, or otherwise path-dependent statistics, such as the maximum or minimum price seen so far, and to include them in the trading algorithm.</p>&#13;
</dd>&#13;
<dt>Reusability</dt>&#13;
<dd>&#13;
<p>Backtesting different types of trading strategies requires a similar base functionality that can be implemented and unified through object-oriented programming.</p>&#13;
</dd>&#13;
<dt>Close to trading</dt>&#13;
<dd>&#13;
<p>Certain elements of an event-based backtesting system can sometimes also be used for the automated implementation of the trading strategy.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In what follows, a new event is generally identified by a <em>bar</em>, which represents one unit of new data. For example, events can be <em>one-minute bars</em> for an intraday trading strategy or <em>one-day bars</em> for a trading strategy based on daily closing prices.</p>&#13;
&#13;
<p>The chapter is organized as follows. <a data-type="xref" href="#base_class">“Backtesting Base Class”</a> presents a base class for the event-based backtesting of trading strategies. <a data-type="xref" href="#long_only">“Long-Only Backtesting Class”</a> and <a data-type="xref" href="#long_short">“Long-Short Backtesting Class”</a> make use of the base class to implement long-only and long-short backtesting classes, respectively.</p>&#13;
&#13;
<p>The goals of this chapter are to understand event-based modeling, to create classes that allow a more realistic backtesting, and to have a foundational backtesting infrastructure available as a starting point for further enhancements and refinements.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Backtesting Base Class" data-type="sect1"><div class="sect1" id="base_class">&#13;
<h1>Backtesting Base Class</h1>&#13;
&#13;
<p><a data-primary="base class, for event-based backtesting" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc2"/><a data-primary="event-based backtesting" data-secondary="base class" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc3"/>When it comes to building the infrastructure—in the form of a Python class—for event-based backtesting, several requirements must be met:</p>&#13;
<dl>&#13;
<dt>Retrieving and preparing data</dt>&#13;
<dd>&#13;
<p>The base class shall take care of the data retrieval and possibly the preparation for the backtesting itself. To keep the discussion focused, end-of-day (EOD) data as read from a CSV file is the type of data the base class shall allow for.</p>&#13;
</dd>&#13;
<dt>Helper and convenience functions</dt>&#13;
<dd>&#13;
<p>It shall provide a couple of helper and convenience functions that make backtesting easier. Examples are functions for plotting data, printing out state variables, or returning date and price information for a given bar.</p>&#13;
</dd>&#13;
<dt>Placing orders</dt>&#13;
<dd>&#13;
<p>The base class shall cover the placing of basic buy and sell orders. For simplicity, only market buy and sell orders are modeled.</p>&#13;
</dd>&#13;
<dt>Closing out positions</dt>&#13;
<dd>&#13;
<p>At the end of any backtesting, any market positions need to be closed out. The base class shall take care of this final trade.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>If the base class meets these requirements, respective classes to backtest strategies based on simple moving averages (SMAs), momentum, or mean reversion (see <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter 4</a>), as well as on machine learning-based prediction (see <a data-type="xref" href="ch05.html#machine_learning">Chapter 5</a>), can be built upon it. <a data-type="xref" href="#py_base_class">“Backtesting Base Class”</a> presents an implementation of such a base class called <code>BacktestBase</code>. The following is a walk through the single methods of this class to get an overview of its design.</p>&#13;
&#13;
<p><a data-primary="__main__ method" data-primary-sortas="main" data-type="indexterm" id="idm45785363446168"/>With regard to the special method <code>__main__</code>, there are only a few noteworthy things. First, the initial amount available is stored twice, both in a private attribute <code>_amount</code> that is kept constant and in a regular attribute <code>amount</code> that represents the running balance. The default assumption is that there are no transaction costs:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">symbol</code><code class="p">,</code><code> </code><code class="n">start</code><code class="p">,</code><code> </code><code class="n">end</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="p">,</code><code>&#13;
</code><code>                 </code><code class="n">ftc</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="n">ptc</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code> </code><code class="o">=</code><code> </code><code class="n">symbol</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code> </code><code class="o">=</code><code> </code><code class="n">start</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code> </code><code class="o">=</code><code> </code><code class="n">end</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code> </code><code class="o">=</code><code> </code><code class="n">amount</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">=</code><code> </code><code class="n">amount</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code> </code><code class="o">=</code><code> </code><code class="n">ftc</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code> </code><code class="o">=</code><code> </code><code class="n">ptc</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-4" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-5" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-6" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-7" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code> </code><code class="o">=</code><code> </code><code class="n">verbose</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-8" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">(</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Stores the initial amount in a private attribute.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Sets the starting cash balance value.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-3" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Defines fixed transaction costs per trade.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-4" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Defines proportional transaction costs per trade.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-5" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Units of the instrument (for example, number of shares) in the portfolio initially.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-6" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Sets the initial position to market neutral.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-7" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Sets the initial number of trades to zero.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-8" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO1-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Sets <code>self.verbose</code> to <code>True</code> to get full output.</p></dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary=".get_data() method" data-primary-sortas="get_data" data-type="indexterm" id="idm45785363256184"/>During initialization, the <code>get_data</code> method is called, which retrieves EOD  data from a CSV file for the provided symbol and the given time interval. It also calculates the log returns. The Python code that follows has been used extensively in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch04.html#vectorized_backtesting">4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.html#machine_learning">5</a>. Therefore, it does not need to be explained in detail here:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code></pre>&#13;
&#13;
<p><a data-primary=".plot_data() method" data-primary-sortas="plot_data" data-type="indexterm" id="idm45785363238072"/>The <code>.plot_data()</code> method is just a simple helper method to plot the (adjusted close) values for the provided symbol:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">plot_data</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">cols</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the closing prices for symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="n">cols</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="n">cols</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'price'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">),</code> <code class="n">title</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">)</code></pre>&#13;
&#13;
<p><a data-primary=".get_date_price() method" data-primary-sortas="get_date_price" data-type="indexterm" id="idm45785362997112"/>A method that gets frequently called is <code>.get_date_price()</code>. For a given <code>bar</code>, it returns the date and price information:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">get_date_price</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Return date and price for bar.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="n">bar</code><code class="p">])[:</code><code class="mi">10</code><code class="p">]</code>&#13;
        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">price</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="n">date</code><code class="p">,</code> <code class="n">price</code></pre>&#13;
&#13;
<p><a data-primary=".print_balance() method" data-primary-sortas="print_balance" data-type="indexterm" id="idm45785363088744"/><a data-primary=".print_net_wealth() method" data-primary-sortas="print_net_wealth" data-type="indexterm" id="idm45785362978696"/><code>.print_balance()</code> prints out the current cash balance given a certain bar, while <code>.print_net_wealth()</code> does the same for the net wealth (= current balance plus value of trading position):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">print_balance</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Print out current cash balance info.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | current balance {self.amount:.2f}'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print_net_wealth</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Print out current cash balance info.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="n">net_wealth</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">*</code> <code class="n">price</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | current net wealth {net_wealth:.2f}'</code><code class="p">)</code></pre>&#13;
&#13;
<p><a data-primary=".place_buy_order() method" data-primary-sortas="place_buy_order" data-type="indexterm" id="idm45785362975176"/><a data-primary=".place_sell_order() method" data-primary-sortas="place_sell_order" data-type="indexterm" id="idm45785362974328"/>Two core methods are <code>.place_buy_order()</code> and <code>.place_sell_order()</code>. They allow the emulated buying and selling of units of a financial instrument. First is the <code>.place_buy_order()</code> method, which is commented on in detail:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">place_buy_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="sd">''' Place a buy order.&#13;
        '''</code><code>&#13;
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-4" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">units</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-5" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-6" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-7" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | selling {units} units at {price:.2f}</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-8" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-9" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-10" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-10"><img alt="10" src="assets/10.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The date and price information for the given <code>bar</code> is retrieved.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>If no value for <code>units</code> is given…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-3" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>…the number of <code>units</code> is calculated given the value for <code>amount</code>. (Note that one needs to be given.) The calculation does not include transaction costs.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-4" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The current cash balance is reduced by the cash outlays for the units of the instrument to be bought <em>plus</em> the proportional and fixed transaction costs. Note that it is not checked whether there is enough liquidity available or not.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-5" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The value of <code>self.units</code> is increased by the number of units bought.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-6" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>This increases the counter for the number of trades by one.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-7" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>If <code>self.verbose</code> is <code>True</code>…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-8" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>…print out information about trade execution…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-9" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>…the current cash balance…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-10" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO2-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>…and the current net wealth.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Second, the <code>.place_sell_order()</code> method, which has only two minor adjustments compared to the <code>.place_buy_order()</code> method:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">place_sell_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="sd">''' Place a sell order.&#13;
        '''</code><code>&#13;
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">units</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | selling {units} units at {price:.2f}</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The current cash balance is increased by the proceeds of the sale <em>minus</em> transactions costs.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The value of <code>self.units</code> is decreased by the number of units sold.</p></dd>&#13;
</dl>&#13;
&#13;
<p>No matter what kind of trading strategy is backtested, the position at the end of the backtesting period needs to be closed out. The code in the <code>BacktestBase</code> class assumes that the position is not liquidated but rather accounted for with its asset value to calculate and print the performance figures:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">close_out</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="sd">''' Closing out a long or short position.&#13;
        '''</code><code>&#13;
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | inventory {self.units} units at {price:.2f}</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">55</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Final balance   [$] {:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">perf</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code><code> </code><code class="o">/</code><code>&#13;
</code><code>                </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code> </code><code class="o">*</code><code> </code><code class="mi">100</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Net Performance [</code><code class="s1">%</code><code class="s1">] {:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">perf</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Trades Executed [#] {:.2f}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">55</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>No transaction costs are subtracted at the end.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The final balance consists of the current cash balance plus the value of the trading position.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-3" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This calculates the net performance in percent.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The final part of the Python script is the <code>__main__</code> section, which gets executed when the file is run as a script:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">bb</code> <code class="o">=</code> <code class="n">BacktestBase</code><code class="p">(</code><code class="s1">'AAPL.O'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">bb</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">())</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">bb</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">tail</code><code class="p">())</code>&#13;
    <code class="n">bb</code><code class="o">.</code><code class="n">plot_data</code><code class="p">()</code></pre>&#13;
&#13;
<p>It instantiates an object based on the <code>BacktestBase</code> class. This leads automatically to the data retrieval for the symbol provided. <a data-type="xref" href="#bt_plot_1">Figure 6-1</a> shows the resulting plot. The following output shows the meta information for the respective <code>DataFrame</code> object and the five most recent data rows:</p>&#13;
&#13;
<pre data-type="programlisting">In [1]: %run BacktestBase.py&#13;
&lt;class 'pandas.core.frame.DataFrame'&gt;&#13;
DatetimeIndex: 2515 entries, 2010-01-05 to 2019-12-31&#13;
Data columns (total 2 columns):&#13;
 #   Column  Non-Null Count  Dtype&#13;
---  ------  --------------  -----&#13;
 0   price   2515 non-null   float64&#13;
 1   return  2515 non-null   float64&#13;
dtypes: float64(2)&#13;
memory usage: 58.9 KB&#13;
None&#13;
             price    return&#13;
Date&#13;
2019-12-24  284.27  0.000950&#13;
2019-12-26  289.91  0.019646&#13;
2019-12-27  289.80 -0.000380&#13;
2019-12-30  291.52  0.005918&#13;
2019-12-31  293.65  0.007280&#13;
&#13;
In [2]:</pre>&#13;
&#13;
<figure><div class="figure" id="bt_plot_1">&#13;
<img alt="pfat 0601" src="assets/pfat_0601.png"/>&#13;
<h6><span class="label">Figure 6-1. </span>Plot of data as retrieved for <code>symbol</code> by the <code>BacktestBase</code> class</h6>&#13;
</div></figure>&#13;
&#13;
<p>The two subsequent sections present classes to backtest long-only and long-short trading strategies. Since these classes rely on the base class presented in this section, the implementation of the backtesting routines is rather concise.</p>&#13;
<div data-type="tip">&#13;
<p>Using object-oriented programming allows one to build a basic backtesting infrastructure in the form of a Python class. Standard functionality needed during the backtesting of different kinds of algorithmic trading strategies is made available by such a class in a non-redundant, easy-to-maintain fashion. It is also straightforward to enhance the base class to provide more features by default that might benefit a multitude of other classes built on top of it.<a data-startref="ix_06_event_based_backtesting_-asciidoc3" data-type="indexterm" id="idm45785362023160"/><a data-startref="ix_06_event_based_backtesting_-asciidoc2" data-type="indexterm" id="idm45785362022488"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Long-Only Backtesting Class" data-type="sect1"><div class="sect1" id="long_only">&#13;
<h1>Long-Only Backtesting Class</h1>&#13;
&#13;
<p><a data-primary="event-based backtesting" data-secondary="long-only backtesting class" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc4"/><a data-primary="long-only backtesting class" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc5"/>Certain investor preferences or regulations might prohibit short selling as part of a trading strategy. As a consequence, a trader or portfolio manager is only allowed to enter long positions or to park capital in the form of cash or similar low risk assets, like money market accounts. <a data-type="xref" href="#py_long_only">“Long-Only Backtesting Class”</a> shows the code of a backtesting class for long-only strategies called <code>BacktestLongOnly</code>. Since it relies on and inherits from the <code>BacktestBase</code> class, the code to implement the three strategies based on SMAs, momentum, and mean reversion is rather concise.</p>&#13;
&#13;
<p><a data-primary=".run_mean_reversion_strategy() method" data-primary-sortas="run_mean_reversion_strategy" data-type="indexterm" id="idm45785362015912"/>The method <code>.run_mean_reversion_strategy()</code> implements the backtesting procedure for the mean reversion-based strategy. This method is commented on in detail, since it might be a bit trickier from an implementation standpoint. The basic insights, however, easily carry over to the methods implementing the other two strategies:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">run_mean_reversion_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">SMA</code><code class="p">,</code><code> </code><code class="n">threshold</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="sd">''' Backtesting a mean reversion-based strategy.&#13;
&#13;
        Parameters&#13;
        ==========&#13;
        SMA: int&#13;
            simple moving average in days&#13;
        threshold: float&#13;
            absolute value for deviation-based signal relative to SMA&#13;
        '''</code><code>&#13;
</code><code>        </code><code class="n">msg</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="se">\n</code><code class="s1">Running mean reversion strategy | </code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="n">msg</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">SMA={SMA} &amp; thr={threshold}</code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="n">msg</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | </code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="n">msg</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">proportional costs {self.ptc}</code><code class="s1">'</code><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code> </code><code class="o">*</code><code> </code><code class="mi">55</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-4" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code>        </code><code class="k">for</code><code> </code><code class="n">bar</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">SMA</code><code class="p">,</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-5" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>            </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-6" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-7"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code>&#13;
</code><code>                        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">threshold</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-7" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-8"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-8" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-9"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-9" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-10"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>            </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-10" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-11"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>                </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-11" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-12"><img alt="11" src="assets/11.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-12" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-13"><img alt="12" src="assets/12.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-13" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-14"><img alt="13" src="assets/13.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-14" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-15"><img alt="14" src="assets/14.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>At the beginning, this method prints out an overview of the major parameters for the backtesting.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The position is set to market neutral, which is done here for more clarity and should be the case anyway.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-4" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The current cash balance is reset to the initial amount in case another backtest run has overwritten the value.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-5" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This calculates the SMA values needed for the strategy implementation.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-6" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The start value <code>SMA</code> ensures that there are SMA values available to start implementing and backtesting the strategy.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-7" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>The condition checks whether the position is market neutral.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-8" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>If the position is market neutral, it is checked whether the current price is low enough relative to the SMA to trigger a buy order and to go long.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-9" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>This executes the buy order in the amount of the current cash balance.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-10" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>The market position is set to long.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-11" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>The condition checks whether the position is long the market.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-12" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>If that is the case, it is checked whether the current price has returned to the SMA level or above.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-13" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-12"><img alt="12" src="assets/12.png"/></a></dt>&#13;
<dd><p>In such a case, a sell order is placed for all units of the financial instrument.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-14" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-13"><img alt="13" src="assets/13.png"/></a></dt>&#13;
<dd><p>The market position is set to neutral again.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-15" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO5-14"><img alt="14" src="assets/14.png"/></a></dt>&#13;
<dd><p>At the end of the backtesting period, the market position gets closed out if one is open.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Executing the Python script in <a data-type="xref" href="#py_long_only">“Long-Only Backtesting Class”</a> yields backtesting results, as shown in the following. <a data-primary="transaction costs" data-type="indexterm" id="idm45785361574616"/>The examples illustrate the influence of fixed and proportional transaction costs. First, they eat into the performance in general. In any case, taking account of transaction costs reduces the performance. Second, they bring to light the importance of the number of trades a certain strategy triggers over time. Without transaction costs, the momentum strategy significantly outperforms the SMA-based strategy. With transaction costs, the SMA-based strategy outperforms the momentum strategy since it relies on fewer trades:</p>&#13;
&#13;
<pre data-type="programlisting">Running SMA strategy | SMA1=42 &amp; SMA2=252&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 56204.95&#13;
Net Performance [%] 462.05&#13;
=======================================================&#13;
&#13;
&#13;
Running momentum strategy | 60 days&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 136716.52&#13;
Net Performance [%] 1267.17&#13;
=======================================================&#13;
&#13;
&#13;
Running mean reversion strategy | SMA=50 &amp; thr=5&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 53907.99&#13;
Net Performance [%] 439.08&#13;
=======================================================&#13;
&#13;
&#13;
Running SMA strategy | SMA1=42 &amp; SMA2=252&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] 51959.62&#13;
Net Performance [%] 419.60&#13;
=======================================================&#13;
&#13;
&#13;
Running momentum strategy | 60 days&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] 38074.26&#13;
Net Performance [%] 280.74&#13;
=======================================================&#13;
&#13;
&#13;
Running mean reversion strategy | SMA=50 &amp; thr=5&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] 15375.48&#13;
Net Performance [%] 53.75&#13;
=======================================================</pre>&#13;
<div data-type="caution">&#13;
<p><a data-type="xref" href="ch05.html#machine_learning">Chapter 5</a> emphasizes that there are two sides of the performance coin: the hit ratio for the correct prediction of the market direction and the market timing (that is, when exactly the prediction is correct). The results shown here illustrate that there is even a “third side”: the number of trades triggered by a strategy. A strategy that demands a higher frequency of trades has to bear higher transaction costs that easily eat up an alleged outperformance over another strategy with no or low transaction costs. Among other things, this often makes the case for low-cost passive investment strategies based, for example, on exchange-traded funds (ETFs).<a data-startref="ix_06_event_based_backtesting_-asciidoc5" data-type="indexterm" id="idm45785361569016"/><a data-startref="ix_06_event_based_backtesting_-asciidoc4" data-type="indexterm" id="idm45785361568408"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Long-Short Backtesting Class" data-type="sect1"><div class="sect1" id="long_short">&#13;
<h1>Long-Short Backtesting Class</h1>&#13;
&#13;
<p><a data-primary="event-based backtesting" data-secondary="long-short backtesting class" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc6"/><a data-primary="long-short backtesting class" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc7"/><a data-type="xref" href="#py_long_short">“Long-Short Backtesting Class”</a> <a data-primary="BacktestLongShort class" data-type="indexterm" id="idm45785361562968"/>presents the <code>BacktestLongShort</code> class, which also inherits from the <code>BacktestBase</code> class. In addition to implementing the respective methods for the backtesting of the different strategies, it implements two additional methods to go long and short, respectively.&#13;
<a data-primary=".go_long() method" data-primary-sortas="go_long" data-type="indexterm" id="idm45785361561272"/>Only the <code>.go_long()</code> method is commented on in detail, since the <code>.go_short()</code> method does exactly the same in the opposite direction:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">go_long</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-4" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-5" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="k">elif</code><code> </code><code class="n">amount</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-6" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>            </code><code class="k">if</code><code> </code><code class="n">amount</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">all</code><code class="s1">'</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-7" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                </code><code class="n">amount</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-8" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="n">amount</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-9" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">go_short</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="n">units</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">elif</code><code> </code><code class="n">amount</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">if</code><code> </code><code class="n">amount</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">all</code><code class="s1">'</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="n">amount</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code>&#13;
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="n">amount</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>In addition to <code>bar</code>, the methods expect either a number for the units of the traded instrument or a currency amount.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>In the <code>.go_long()</code> case, it is first checked whether there is a short position.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-3" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>If so, this short position gets closed first.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-4" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>It is then checked whether <code>units</code> is given…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-5" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>…which triggers a buy order accordingly.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-6" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>If <code>amount</code> is given, there can be two cases.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-7" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>First, the value is <code>all</code>, which translates into…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-8" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>…all the available cash in the current cash balance.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-9" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO6-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Second, the value is a number that is then simply taken to place the respective buy order. Note that it is not checked whether there is enough liquidity or not.</p></dd>&#13;
</dl>&#13;
<div data-type="caution">&#13;
<p>To keep the implementation concise throughout, there are many simplifications in the Python classes that transfer responsibility to the user. For example, the classes do not take care of whether there is enough liquidity or not to execute a trade. This is an economic simplification since, in theory, one could assume enough or even unlimited credit for the algorithmic trader. As another example, certain methods expect that at least one of two parameters (either <code>units</code> or <code>amount</code>) is specified. There is no code that catches the case where both are not set. This is a technical simplification.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary=".run_mean_reversion_strategy() method" data-primary-sortas="run_mean_reversion_strategy" data-type="indexterm" id="idm45785361416328"/>The following presents the core loop from the <code>.run_mean_reversion_strategy()</code> method of the <code>BacktestLongShort</code> class. Again, the mean-reversion strategy is picked since the implementation is a bit more involved. For instance, it is the only strategy that also leads to intermediate market neutral positions. This necessitates more checks compared to the other two strategies, as seen in <a data-type="xref" href="#py_long_short">“Long-Short Backtesting Class”</a>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code>        </code><code class="k">for</code><code> </code><code class="n">bar</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">SMA</code><code class="p">,</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-1" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code>&#13;
</code><code>                        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">threshold</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-2" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">go_long</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-3" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-4" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                </code><code class="k">elif</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code>&#13;
</code><code>                        </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">+</code><code> </code><code class="n">threshold</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-5" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">go_short</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-6" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>            </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-7" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>                </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&gt;</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-8" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-8"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-9" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-9"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-10" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-10"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>            </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-11" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-11"><img alt="11" src="assets/11.png"/></a><code>&#13;
</code><code>                </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">price</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">SMA</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-12" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-12"><img alt="12" src="assets/12.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-13" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-13"><img alt="13" src="assets/13.png"/></a><code>&#13;
</code><code>                    </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" href="#callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-14" id="co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-14"><img alt="14" src="assets/14.png"/></a><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-1" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The first top-level condition checks whether the position is market neutral.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-2" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>If this is true, it is then checked whether the current price is low enough relative to the SMA.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-3" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>In such a case, the <code>.go_long()</code> method is called…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-4" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>…and the market position is set to long.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-5" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>If the current price is high enough relative to the SMA, the <code>.go_short()</code> method is called…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-6" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>…and the market position is set to short.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-7" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>The second top-level condition checks for a long market position.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-8" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>In such a case, it is further checked whether the current price is at or above the SMA level again.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-9" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>If so, the long position gets closed out by selling all units in the portfolio.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-10" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>The market position is reset to neutral.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-11" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-11"><img alt="11" src="assets/11.png"/></a></dt>&#13;
<dd><p>Finally, the third top-level condition checks for a short position.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-12" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-12"><img alt="12" src="assets/12.png"/></a></dt>&#13;
<dd><p>If the current price is at or below the SMA…</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-13" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-13"><img alt="13" src="assets/13.png"/></a></dt>&#13;
<dd><p>…a buy order for all units short is triggered to close out the short position.</p></dd>&#13;
<dt><a class="co" href="#co_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-14" id="callout_building_classes_for___span_class__keep_together__event_based_backtesting__span__CO7-14"><img alt="14" src="assets/14.png"/></a></dt>&#13;
<dd><p>The market position is then reset to neutral.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Executing the Python script in <a data-type="xref" href="#py_long_short">“Long-Short Backtesting Class”</a> yields performance results that shed further light on strategy characteristics. One might be inclined to assume that adding the flexibility to short a financial instrument yields better results. However, reality shows that this is not necessarily true. All strategies perform worse both without and after transaction costs. Some configurations even pile up net losses or even a position of debt. Although these are specific results only, they illustrate that it is risky in such a context to jump to conclusions too early and to not take into account limits for piling up debt:</p>&#13;
&#13;
<pre data-type="programlisting">Running SMA strategy | SMA1=42 &amp; SMA2=252&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 45631.83&#13;
Net Performance [%] 356.32&#13;
=======================================================&#13;
&#13;
&#13;
Running momentum strategy | 60 days&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 105236.62&#13;
Net Performance [%] 952.37&#13;
=======================================================&#13;
&#13;
&#13;
Running mean reversion strategy | SMA=50 &amp; thr=5&#13;
fixed costs 0.0 | proportional costs 0.0&#13;
=======================================================&#13;
Final balance   [$] 17279.15&#13;
Net Performance [%] 72.79&#13;
=======================================================&#13;
&#13;
&#13;
Running SMA strategy | SMA1=42 &amp; SMA2=252&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] 38369.65&#13;
Net Performance [%] 283.70&#13;
=======================================================&#13;
&#13;
&#13;
Running momentum strategy | 60 days&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] 6883.45&#13;
Net Performance [%] -31.17&#13;
=======================================================&#13;
&#13;
&#13;
Running mean reversion strategy | SMA=50 &amp; thr=5&#13;
fixed costs 10.0 | proportional costs 0.01&#13;
=======================================================&#13;
Final balance   [$] -5110.97&#13;
Net Performance [%] -151.11&#13;
=======================================================</pre>&#13;
<div data-type="caution">&#13;
<p><a data-primary="CFD (contracts for difference)" data-secondary="risks of losses" data-type="indexterm" id="idm45785360852040"/>Situations where trading might eat up all the initial equity and might even lead to a position of debt arise, for example, in the context of trading contracts-for-difference (CFDs). These are highly leveraged products for which the trader only needs to put down, say, 5% of the position value as the initial margin (when the leverage is 20). If the position value changes by, say, 10%, the trader might be required to meet a corresponding margin call. For a long position of 100,000 USD, equity of 5,000 USD is required. If the position drops to 90,000 USD, the equity is wiped out and the trader must put down 5,000 USD more to cover the losses. This assumes that no margin stop outs are in place that would close the position as soon as the remaining equity drops to 0 USD.<a data-startref="ix_06_event_based_backtesting_-asciidoc7" data-type="indexterm" id="idm45785360850280"/><a data-startref="ix_06_event_based_backtesting_-asciidoc6" data-type="indexterm" id="idm45785360849672"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Conclusions" data-type="sect1"><div class="sect1" id="idm45785361566920">&#13;
<h1>Conclusions</h1>&#13;
&#13;
<p>This chapter presents classes for the event-based backtesting of trading strategies. Compared to vectorized backtesting, event-based backtesting makes intentional and heavy use of loops and iterations to be able to tackle every single new event (generally, the arrival of new data) individually. This allows for a more flexible approach that can, among other things, easily cope with fixed transaction costs or more complex strategies (and variations thereof).</p>&#13;
&#13;
<p><a data-type="xref" href="#base_class">“Backtesting Base Class”</a> presents a base class with certain methods useful for the backtesting of a variety of trading strategies. <a data-type="xref" href="#long_only">“Long-Only Backtesting Class”</a> and <a data-type="xref" href="#long_short">“Long-Short Backtesting Class”</a> build on this infrastructure to implement classes that allow the backtesting of long-only and long-short trading strategies. Mainly for comparison reasons, the implementations include all three strategies formally introduced in <a data-type="xref" href="ch04.html#vectorized_backtesting">Chapter 4</a>. Taking the classes of this chapter as a starting point, enhancements and refinements are easily achieved.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="References and Further Resources" data-type="sect1"><div class="sect1" id="idm45785360843128">&#13;
<h1>References and Further Resources</h1>&#13;
&#13;
<p>Previous chapters introduce the basic ideas and concepts with regard to the three trading strategies covered in this chapter. This chapter for the first time makes a more systemic use of Python classes and object-oriented programming (OOP). A good introduction to OOP with Python and Python’s data model is found in Ramalho (2021). A more concise introduction to OOP applied to finance is found in Hilpisch (2018, ch. 6):</p>&#13;
&#13;
<ul class="author-date-bib">&#13;
<li>&#13;
<p>Hilpisch, Yves. 2018. <em>Python for Finance: Mastering Data-Driven Finance</em>. 2nd ed. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
<li>&#13;
<p>Ramalho, Luciano. 2021. <em>Fluent Python: Clear, Concise, and Effective Programming</em>. 2nd ed. Sebastopol: O’Reilly.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The Python ecosystem provides a number of optional packages that allow the backtesting of algorithmic trading strategies. Four of them are the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://pmorissette.github.io/bt/">bt</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://backtrader.com/">Backtrader</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://gbeced.github.io/pyalgotrade/">PyAlgoTrade</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://github.com/quantopian/zipline">Zipline</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><code>Zipline</code>, for example, powers the popular <a href="http://quantopian.com">Quantopian</a> platform for the backtesting of algorithmic trading strategies but can also be installed and used locally.</p>&#13;
&#13;
<p>Although these packages might allow for a more thorough backtesting of algorithmic trading strategies than the rather simple classes presented in this chapter, the main goal of this book is to empower the reader and algorithmic trader to implement Python code in a self-contained fashion. Even if standard packages are later used to do the actual backtesting, a good understanding of the different approaches and their mechanics is beneficial, if not required.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Scripts" data-type="sect1"><div class="sect1" id="idm45785360830520">&#13;
<h1>Python Scripts</h1>&#13;
&#13;
<p>This section presents Python scripts referenced and used in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Backtesting Base Class" data-type="sect2"><div class="sect2" id="py_base_class">&#13;
<h2>Backtesting Base Class</h2>&#13;
&#13;
<p><a data-primary="base class, for event-based backtesting" data-type="indexterm" id="idm45785360827896"/><a data-primary="event-based backtesting" data-secondary="base class" data-type="indexterm" id="idm45785360827288"/><a data-primary="Python scripts" data-secondary="backtesting base class" data-type="indexterm" id="idm45785360826440"/>The <a data-primary="event-based backtesting" data-secondary="Python scripts for" data-type="indexterm" id="ix_06_event_based_backtesting_-asciidoc8"/>following Python code contains the base class for event-based backtesting:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script with Base Class</code>&#13;
<code class="c1"># for Event-Based Backtesting</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">mpl</code><code class="p">,</code> <code class="n">plt</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>&#13;
<code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">BacktestBase</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>&#13;
    <code class="sd">''' Base class for event-based backtesting of trading strategies.</code>&#13;
&#13;
<code class="sd">    Attributes</code>&#13;
<code class="sd">    ==========</code>&#13;
<code class="sd">    symbol: str</code>&#13;
<code class="sd">        TR RIC (financial instrument) to be used</code>&#13;
<code class="sd">    start: str</code>&#13;
<code class="sd">        start date for data selection</code>&#13;
<code class="sd">    end: str</code>&#13;
<code class="sd">        end date for data selection</code>&#13;
<code class="sd">    amount: float</code>&#13;
<code class="sd">        amount to be invested either once or per trade</code>&#13;
<code class="sd">    ftc: float</code>&#13;
<code class="sd">        fixed transaction costs per trade (buy or sell)</code>&#13;
<code class="sd">    ptc: float</code>&#13;
<code class="sd">        proportional transaction costs per trade (buy or sell)</code>&#13;
&#13;
<code class="sd">    Methods</code>&#13;
<code class="sd">    =======</code>&#13;
<code class="sd">    get_data:</code>&#13;
<code class="sd">        retrieves and prepares the base data set</code>&#13;
<code class="sd">    plot_data:</code>&#13;
<code class="sd">        plots the closing price for the symbol</code>&#13;
<code class="sd">    get_date_price:</code>&#13;
<code class="sd">        returns the date and price for the given bar</code>&#13;
<code class="sd">    print_balance:</code>&#13;
<code class="sd">        prints out the current (cash) balance</code>&#13;
<code class="sd">    print_net_wealth:</code>&#13;
<code class="sd">        prints out the current net wealth</code>&#13;
<code class="sd">    place_buy_order:</code>&#13;
<code class="sd">        places a buy order</code>&#13;
<code class="sd">    place_sell_order:</code>&#13;
<code class="sd">        places a sell order</code>&#13;
<code class="sd">    close_out:</code>&#13;
<code class="sd">        closes out a long or short position</code>&#13;
<code class="sd">    '''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">end</code><code class="p">,</code> <code class="n">amount</code><code class="p">,</code>&#13;
                 <code class="n">ftc</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">ptc</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">verbose</code><code class="o">=</code><code class="bp">True</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code> <code class="o">=</code> <code class="n">amount</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="n">amount</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">ftc</code> <code class="o">=</code> <code class="n">ftc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">ptc</code> <code class="o">=</code> <code class="n">ptc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code> <code class="o">=</code> <code class="n">verbose</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">get_data</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">''' Retrieves and prepares the data.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'http://hilpisch.com/pyalgo_eikon_eod_data.csv'</code><code class="p">,</code>&#13;
                          <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>&#13;
        <code class="n">raw</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code><code class="p">]</code>&#13;
        <code class="n">raw</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">:</code> <code class="s1">'price'</code><code class="p">},</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
        <code class="n">raw</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">raw</code> <code class="o">/</code> <code class="n">raw</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">raw</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">plot_data</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">cols</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="sd">''' Plots the closing prices for symbol.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="k">if</code> <code class="n">cols</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="n">cols</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'price'</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">),</code> <code class="n">title</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_date_price</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Return date and price for bar.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="n">bar</code><code class="p">])[:</code><code class="mi">10</code><code class="p">]</code>&#13;
        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">price</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code>&#13;
        <code class="k">return</code> <code class="n">date</code><code class="p">,</code> <code class="n">price</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print_balance</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Print out current cash balance info.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | current balance {self.amount:.2f}'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print_net_wealth</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Print out current cash balance info.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="n">net_wealth</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">*</code> <code class="n">price</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | current net wealth {net_wealth:.2f}'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">place_buy_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="sd">''' Place a buy order.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">units</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="n">units</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">amount</code> <code class="o">/</code> <code class="n">price</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">-=</code> <code class="p">(</code><code class="n">units</code> <code class="o">*</code> <code class="n">price</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">ftc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">+=</code> <code class="n">units</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | selling {units} units at {price:.2f}'</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">place_sell_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="sd">''' Place a sell order.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">units</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>&#13;
            <code class="n">units</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">amount</code> <code class="o">/</code> <code class="n">price</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">+=</code> <code class="p">(</code><code class="n">units</code> <code class="o">*</code> <code class="n">price</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">ftc</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">-=</code> <code class="n">units</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | selling {units} units at {price:.2f}'</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">close_out</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>&#13;
        <code class="sd">''' Closing out a long or short position.</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">+=</code> <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">*</code> <code class="n">price</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | inventory {self.units} units at {price:.2f}'</code><code class="p">)</code>&#13;
            <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Final balance   [$] {:.2f}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">))</code>&#13;
        <code class="n">perf</code> <code class="o">=</code> <code class="p">((</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code> <code class="o">/</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code> <code class="o">*</code> <code class="mi">100</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Net Performance [%] {:.2f}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">perf</code><code class="p">))</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Trades Executed [#] {:.2f}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code class="p">))</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">bb</code> <code class="o">=</code> <code class="n">BacktestBase</code><code class="p">(</code><code class="s1">'AAPL.O'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">bb</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">())</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">bb</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">tail</code><code class="p">())</code>&#13;
    <code class="n">bb</code><code class="o">.</code><code class="n">plot_data</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Long-Only Backtesting Class" data-type="sect2"><div class="sect2" id="py_long_only">&#13;
<h2>Long-Only Backtesting Class</h2>&#13;
&#13;
<p><a data-primary="event-based backtesting" data-secondary="long-only backtesting class" data-type="indexterm" id="idm45785360589416"/><a data-primary="long-only backtesting class" data-type="indexterm" id="idm45785360588232"/><a data-primary="Python scripts" data-secondary="long-only backtesting class" data-type="indexterm" id="idm45785360587544"/>The following presents Python code with a class for the event-based backtesting of <em>long-only</em> strategies, with implementations for strategies based on <em>SMAs</em>, <em>momentum</em>, and <em>mean reversion</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script with Long Only Class</code>&#13;
<code class="c1"># for Event-Based Backtesting</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">from</code> <code class="nn">BacktestBase</code> <code class="kn">import</code> <code class="o">*</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">BacktestLongOnly</code><code class="p">(</code><code class="n">BacktestBase</code><code class="p">):</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_sma_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA1</code><code class="p">,</code> <code class="n">SMA2</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtesting an SMA-based strategy.</code>&#13;
&#13;
<code class="sd">        Parameters</code>&#13;
<code class="sd">        ==========</code>&#13;
<code class="sd">        SMA1, SMA2: int</code>&#13;
<code class="sd">            shorter and longer term simple moving average (in days)</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running SMA strategy | SMA1={SMA1} &amp; SMA2={SMA2}'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># initial neutral position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># no trades yet</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>  <code class="c1"># reset initial capital</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA2</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">SMA2</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>  <code class="c1"># long position</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># market neutral</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_momentum_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">momentum</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtesting a momentum-based strategy.</code>&#13;
&#13;
<code class="sd">        Parameters</code>&#13;
<code class="sd">        ==========</code>&#13;
<code class="sd">        momentum: int</code>&#13;
<code class="sd">            number of days for mean return calculation</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running momentum strategy | {momentum} days'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># initial neutral position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># no trades yet</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>  <code class="c1"># reset initial capital</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">momentum</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">momentum</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>  <code class="c1"># long position</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># market neutral</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_mean_reversion_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA</code><code class="p">,</code> <code class="n">threshold</code><code class="p">):</code>&#13;
        <code class="sd">''' Backtesting a mean reversion-based strategy.</code>&#13;
&#13;
<code class="sd">        Parameters</code>&#13;
<code class="sd">        ==========</code>&#13;
<code class="sd">        SMA: int</code>&#13;
<code class="sd">            simple moving average in days</code>&#13;
<code class="sd">        threshold: float</code>&#13;
<code class="sd">            absolute value for deviation-based signal relative to SMA</code>&#13;
<code class="sd">        '''</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running mean reversion strategy | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'SMA={SMA} &amp; thr={threshold}'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>&#13;
&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">SMA</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;</code>&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">-</code> <code class="n">threshold</code><code class="p">):</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">amount</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="nf">run_strategies</code><code class="p">():</code>&#13;
        <code class="n">lobt</code><code class="o">.</code><code class="n">run_sma_strategy</code><code class="p">(</code><code class="mi">42</code><code class="p">,</code> <code class="mi">252</code><code class="p">)</code>&#13;
        <code class="n">lobt</code><code class="o">.</code><code class="n">run_momentum_strategy</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>&#13;
        <code class="n">lobt</code><code class="o">.</code><code class="n">run_mean_reversion_strategy</code><code class="p">(</code><code class="mi">50</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>&#13;
    <code class="n">lobt</code> <code class="o">=</code> <code class="n">BacktestLongOnly</code><code class="p">(</code><code class="s1">'AAPL.O'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">,</code>&#13;
                            <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>&#13;
    <code class="n">run_strategies</code><code class="p">()</code>&#13;
    <code class="c1"># transaction costs: 10 USD fix, 1% variable</code>&#13;
    <code class="n">lobt</code> <code class="o">=</code> <code class="n">BacktestLongOnly</code><code class="p">(</code><code class="s1">'AAPL.O'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                            <code class="mi">10000</code><code class="p">,</code> <code class="mf">10.0</code><code class="p">,</code> <code class="mf">0.01</code><code class="p">,</code> <code class="bp">False</code><code class="p">)</code>&#13;
    <code class="n">run_strategies</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Long-Short Backtesting Class" data-type="sect2"><div class="sect2" id="py_long_short">&#13;
<h2>Long-Short Backtesting Class</h2>&#13;
&#13;
<p><a data-primary="Python scripts" data-secondary="long-short backtesting class" data-type="indexterm" id="idm45785359925672"/><a data-primary="BacktestLongShort class" data-type="indexterm" id="idm45785359924488"/><a data-primary="event-based backtesting" data-secondary="long-short backtesting class" data-type="indexterm" id="idm45785359923816"/><a data-primary="long-short backtesting class" data-type="indexterm" id="idm45785359922856"/>The following Python code contains a class for the event-based backtesting of <em>long-short</em> strategies, with implementations for strategies based on <em>SMAs</em>, <em>momentum</em>, and <em>mean reversion</em>:<a data-startref="ix_06_event_based_backtesting_-asciidoc8" data-type="indexterm" id="idm45785359920344"/><a data-startref="ix_06_event_based_backtesting_-asciidoc1" data-type="indexterm" id="idm45785359919576"/><a data-startref="ix_06_event_based_backtesting_-asciidoc0" data-type="indexterm" id="idm45785359918872"/></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#</code>&#13;
<code class="c1"># Python Script with Long-Short Class</code>&#13;
<code class="c1"># for Event-Based Backtesting</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Python for Algorithmic Trading</code>&#13;
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>&#13;
<code class="c1"># The Python Quants GmbH</code>&#13;
<code class="c1">#</code>&#13;
<code class="kn">from</code> <code class="nn">BacktestBase</code> <code class="kn">import</code> <code class="o">*</code>&#13;
&#13;
&#13;
<code class="k">class</code> <code class="nc">BacktestLongShort</code><code class="p">(</code><code class="n">BacktestBase</code><code class="p">):</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">go_long</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">units</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="n">units</code><code class="p">)</code>&#13;
        <code class="k">elif</code> <code class="n">amount</code><code class="p">:</code>&#13;
            <code class="k">if</code> <code class="n">amount</code> <code class="o">==</code> <code class="s1">'all'</code><code class="p">:</code>&#13;
                <code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="n">amount</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">go_short</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">units</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="n">units</code><code class="p">)</code>&#13;
        <code class="k">elif</code> <code class="n">amount</code><code class="p">:</code>&#13;
            <code class="k">if</code> <code class="n">amount</code> <code class="o">==</code> <code class="s1">'all'</code><code class="p">:</code>&#13;
                <code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">amount</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="n">amount</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_sma_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA1</code><code class="p">,</code> <code class="n">SMA2</code><code class="p">):</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running SMA strategy | SMA1={SMA1} &amp; SMA2={SMA2}'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># initial neutral position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># no trades yet</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>  <code class="c1"># reset initial capital</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA1</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA2</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">SMA2</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">]:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_long</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="s1">'all'</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>  <code class="c1"># long position</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">]:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA1'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA2'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_short</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="s1">'all'</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>  <code class="c1"># short position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_momentum_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">momentum</code><code class="p">):</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running momentum strategy | {momentum} days'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># initial neutral position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># no trades yet</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>  <code class="c1"># reset initial capital</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'return'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">momentum</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">momentum</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">]:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_long</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="s1">'all'</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>  <code class="c1"># long position</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">]:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'momentum'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;=</code> <code class="mi">0</code><code class="p">:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_short</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="s1">'all'</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>  <code class="c1"># short position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">run_mean_reversion_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">SMA</code><code class="p">,</code> <code class="n">threshold</code><code class="p">):</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n\n</code><code class="s1">Running mean reversion strategy | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'SMA={SMA} &amp; thr={threshold}'</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'</code><code class="se">\n</code><code class="s1">fixed costs {self.ftc} | '</code>&#13;
        <code class="n">msg</code> <code class="o">+=</code> <code class="n">f</code><code class="s1">'proportional costs {self.ptc}'</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'='</code> <code class="o">*</code> <code class="mi">55</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># initial neutral position</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>  <code class="c1"># no trades yet</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">amount</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>  <code class="c1"># reset initial capital</code>&#13;
&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">SMA</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>&#13;
&#13;
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">SMA</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>&#13;
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;</code>&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">-</code> <code class="n">threshold</code><code class="p">):</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_long</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>&#13;
                <code class="k">elif</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;</code>&#13;
                        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">+</code> <code class="n">threshold</code><code class="p">):</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">go_short</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&gt;=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>&#13;
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'price'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code> <code class="o">&lt;=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'SMA'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]:</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>&#13;
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="nf">run_strategies</code><code class="p">():</code>&#13;
        <code class="n">lsbt</code><code class="o">.</code><code class="n">run_sma_strategy</code><code class="p">(</code><code class="mi">42</code><code class="p">,</code> <code class="mi">252</code><code class="p">)</code>&#13;
        <code class="n">lsbt</code><code class="o">.</code><code class="n">run_momentum_strategy</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>&#13;
        <code class="n">lsbt</code><code class="o">.</code><code class="n">run_mean_reversion_strategy</code><code class="p">(</code><code class="mi">50</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>&#13;
    <code class="n">lsbt</code> <code class="o">=</code> <code class="n">BacktestLongShort</code><code class="p">(</code><code class="s1">'EUR='</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code> <code class="mi">10000</code><code class="p">,</code>&#13;
                             <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>&#13;
    <code class="n">run_strategies</code><code class="p">()</code>&#13;
    <code class="c1"># transaction costs: 10 USD fix, 1% variable</code>&#13;
    <code class="n">lsbt</code> <code class="o">=</code> <code class="n">BacktestLongShort</code><code class="p">(</code><code class="s1">'AAPL.O'</code><code class="p">,</code> <code class="s1">'2010-1-1'</code><code class="p">,</code> <code class="s1">'2019-12-31'</code><code class="p">,</code>&#13;
                             <code class="mi">10000</code><code class="p">,</code> <code class="mf">10.0</code><code class="p">,</code> <code class="mf">0.01</code><code class="p">,</code> <code class="bp">False</code><code class="p">)</code>&#13;
    <code class="n">run_strategies</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>