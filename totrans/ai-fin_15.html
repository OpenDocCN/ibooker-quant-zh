<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Risk Management"><div class="chapter" id="risk_management">
<h1><span class="label">Chapter 11. </span>Risk Management</h1>

<blockquote>
<p class="align_me_right">A significant barrier to deploying autonomous vehicles (AVs) on a massive scale is safety assurance.</p>
<p data-type="attribution">Majid Khonji et al. (2019)</p>
</blockquote>
<blockquote>
<p class="align_me_right">Having better prediction raises the value of judgment. After all, it doesn’t help to know the likelihood of rain if you don’t know how much you like staying dry or how much you hate carrying an umbrella.</p>
<p data-type="attribution">Ajay Agrawal et al. (2018)</p>
</blockquote>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" id="ix_risk_man_alg_trading_ch11"/>Vectorized backtesting in general enables one to judge the economic potential of a prediction-based algorithmic trading strategy on an as-is basis (that is, in its pure form). Most AI agents applied in practice have more components than just the 
<span class="keep-together">prediction</span> model. For example, the AI of autonomous vehicles (AVs) comes not standalone but rather with a large number of rules and heuristics that restrict what actions the AI takes or can take. In the context of AVs, this primarily relates to managing risks, such as those resulting from collisions or crashes.</p>

<p>In a financial context, AI agents or trading bots are also not deployed as-is in general. Rather, there are a number of standard risk measures that are typically used, such as <em>(trailing) stop loss orders</em> or <em>take profit orders</em>. The reasoning is clear. When placing directional bets in financial markets, too-large losses are to be avoided. Similarly, when a certain profit level is reached, the success is to be protected by early close outs. How such risk measures are handled is a matter, more often than not, of human judgment, supported probably by a formal analysis of relevant data and statistics. <a data-type="indexterm" data-primary="Agrawal, Ajay" id="idm45625269339128"/>Conceptually, this is a major point discussed in the book by Agrawal et al. (2018): AI provides improved predictions, but human judgment still plays a role in setting decision rules and action boundaries.</p>

<p>This chapter has a threefold purpose. First, it backtests in both <em>vectorized</em> and <em>event-based</em> fashion algorithmic trading strategies that result from a trained deep 
<span class="keep-together">Q-learning</span> agent. Henceforth, such agents are called <em>trading bots</em>. Second, it assesses risks related to the financial instrument on which the strategies are implemented. And third, it backtests typical risk measures, such as stop loss orders, using the event-based approach introduced in this chapter. The major benefit of event-based 
<span class="keep-together">backtesting</span> when compared to vectorized backtesting is a higher degree of flexibility in modeling and analyzing decision rules and risk management measures. In other words, it allows one to zoom in on details that are pushed toward the background when working with vectorized programming approaches.</p>

<p><a data-type="xref" href="#rm_trading_bot">“Trading Bot”</a> introduces and trains the trading bot based on the financial Q-learning agent from <a data-type="xref" href="ch09.xhtml#reinforcement_learning">Chapter 9</a>. <a data-type="xref" href="#rm_vec_back">“Vectorized Backtesting”</a> uses vectorized backtesting from <a data-type="xref" href="ch10.xhtml#vectorized_backtesting">Chapter 10</a> to judge the (pure) economic performance of the trading bot. Event-based backtesting is introduced in <a data-type="xref" href="#rm_event_back">“Event-Based Backtesting”</a>. First, a base class is discussed. Second, based on the base class, the backtesting of the trading bot is implemented and conducted. In this context, also see Hilpisch (2020, ch. 6). <a data-type="xref" href="#rm_assessing_risk">“Assessing Risk”</a> analyzes selected statistical measures important for setting risk management rules, such as <em>maximum drawdown</em> and <em>average true range</em> (ATR). <a data-type="xref" href="#rm_risk_measures">“Backtesting Risk Measures”</a> then backtests the impact of major risk measures on the performance of the trading bot.</p>






<section data-type="sect1" data-pdf-bookmark="Trading Bot"><div class="sect1" id="rm_trading_bot">
<h1>Trading Bot</h1>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="FQLAgent trading bot" id="ix_risk_man_fql_agent_ch11"/><a data-type="indexterm" data-primary="FQLAgent" id="ix_fql_agent_ch11"/><a data-type="indexterm" data-primary="QL (Q-learning)" data-secondary="FQLAgent" id="ix_QL_fql_agent_ch11"/><a data-type="indexterm" data-primary="agents" data-secondary="FQLAgent" id="ix_agent_fql_ch11"/>This section presents a trading bot based on the financial Q-learning agent, <code>FQLAgent</code>, from <a data-type="xref" href="ch09.xhtml#reinforcement_learning">Chapter 9</a>. This is the trading bot that is analyzed in subsequent sections. As usual, our imports come first:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">os</code>
        <code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>
        <code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">plt</code><code class="p">,</code> <code class="n">mpl</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'savefig.dpi'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">300</code>
        <code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code>
        <code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'mode.chained_assignment'</code><code class="p">,</code> <code class="bp">None</code><code class="p">)</code>
        <code class="n">pd</code><code class="o">.</code><code class="n">set_option</code><code class="p">(</code><code class="s1">'display.float_format'</code><code class="p">,</code> <code class="s1">'{:.4f}'</code><code class="o">.</code><code class="n">format</code><code class="p">)</code>
        <code class="n">np</code><code class="o">.</code><code class="n">set_printoptions</code><code class="p">(</code><code class="n">suppress</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">precision</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code>
        <code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s1">'PYTHONHASHSEED'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'0'</code></pre>

<p><a data-type="xref" href="#rm_finance">“Finance Environment”</a> presents a Python module with the <code>Finance</code> class used in the following. <a data-type="xref" href="#rm_trading_bot">“Trading Bot”</a> provides the Python module with the <code>TradingBot</code> class and some helper functions for plotting training and validation results. <a data-type="indexterm" data-primary="Finance environment class" id="idm45625269415160"/><a data-type="indexterm" data-primary="TradingBot class" id="idm45625269414392"/>Both classes are pretty close to the ones introduced in <a data-type="xref" href="ch09.xhtml#reinforcement_learning">Chapter 9</a>, which is why they are used here without further explanations.</p>

<p>The following code trains the trading bot on historical end-of-day (EOD) data, including a sub-set of the data used for validation. <a data-type="xref" href="#figure_rm_01">Figure 11-1</a> shows average total rewards as achieved for the different training episodes:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">finance</code>
        <code class="kn">import</code> <code class="nn">tradingbot</code>
        <code class="n">Using</code> <code class="n">TensorFlow</code> <code class="n">backend</code><code class="o">.</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">symbol</code> <code class="o">=</code> <code class="s1">'EUR='</code>
        <code class="n">features</code> <code class="o">=</code> <code class="p">[</code><code class="n">symbol</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">,</code> <code class="s1">'m'</code><code class="p">,</code> <code class="s1">'v'</code><code class="p">]</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">4</code><code class="p">]:</code> <code class="n">a</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="n">b</code> <code class="o">=</code> <code class="mi">1750</code>
        <code class="n">c</code> <code class="o">=</code> <code class="mi">250</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">5</code><code class="p">]:</code> <code class="n">learn_env</code> <code class="o">=</code> <code class="n">finance</code><code class="o">.</code><code class="n">Finance</code><code class="p">(</code><code class="n">symbol</code><code class="p">,</code> <code class="n">features</code><code class="p">,</code> <code class="n">window</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code> <code class="n">lags</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code>
                         <code class="n">leverage</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">min_performance</code><code class="o">=</code><code class="mf">0.9</code><code class="p">,</code> <code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.475</code><code class="p">,</code>
                         <code class="n">start</code><code class="o">=</code><code class="n">a</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="n">a</code> <code class="o">+</code> <code class="n">b</code><code class="p">,</code> <code class="n">mu</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">std</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">6</code><code class="p">]:</code> <code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">()</code>
        <code class="o">&lt;</code><code class="k">class</code> <code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'&gt;</code>
        <code class="n">DatetimeIndex</code><code class="p">:</code> <code class="mi">1750</code> <code class="n">entries</code><code class="p">,</code> <code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">02</code> <code class="n">to</code> <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code>
        <code class="n">Data</code> <code class="n">columns</code> <code class="p">(</code><code class="n">total</code> <code class="mi">6</code> <code class="n">columns</code><code class="p">):</code>
         <code class="c1">#   Column  Non-Null Count  Dtype</code>
        <code class="o">---</code>  <code class="o">------</code>  <code class="o">--------------</code>  <code class="o">-----</code>
         <code class="mi">0</code>   <code class="n">EUR</code><code class="o">=</code>    <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="mi">1</code>   <code class="n">r</code>       <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="mi">2</code>   <code class="n">s</code>       <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="mi">3</code>   <code class="n">m</code>       <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="mi">4</code>   <code class="n">v</code>       <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">float64</code>
         <code class="mi">5</code>   <code class="n">d</code>       <code class="mi">1750</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>   <code class="n">int64</code>
        <code class="n">dtypes</code><code class="p">:</code> <code class="n">float64</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
        <code class="n">memory</code> <code class="n">usage</code><code class="p">:</code> <code class="mf">95.7</code> <code class="n">KB</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">7</code><code class="p">]:</code> <code class="n">valid_env</code> <code class="o">=</code> <code class="n">finance</code><code class="o">.</code><code class="n">Finance</code><code class="p">(</code><code class="n">symbol</code><code class="p">,</code> <code class="n">features</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">features</code><code class="p">,</code>
                                    <code class="n">window</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code><code class="p">,</code>
                                    <code class="n">lags</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                    <code class="n">leverage</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">leverage</code><code class="p">,</code>
                                    <code class="n">min_performance</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code>
                                    <code class="n">start</code><code class="o">=</code><code class="n">a</code> <code class="o">+</code> <code class="n">b</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="n">a</code> <code class="o">+</code> <code class="n">b</code> <code class="o">+</code> <code class="n">c</code><code class="p">,</code>
                                    <code class="n">mu</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">mu</code><code class="p">,</code> <code class="n">std</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">std</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">8</code><code class="p">]:</code> <code class="n">valid_env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">info</code><code class="p">()</code>
        <code class="o">&lt;</code><code class="k">class</code> <code class="err">'</code><code class="nc">pandas</code><code class="o">.</code><code class="n">core</code><code class="o">.</code><code class="n">frame</code><code class="o">.</code><code class="n">DataFrame</code><code class="s1">'&gt;</code>
        <code class="n">DatetimeIndex</code><code class="p">:</code> <code class="mi">250</code> <code class="n">entries</code><code class="p">,</code> <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">13</code> <code class="n">to</code> <code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">10</code>
        <code class="n">Data</code> <code class="n">columns</code> <code class="p">(</code><code class="n">total</code> <code class="mi">6</code> <code class="n">columns</code><code class="p">):</code>
         <code class="c1">#   Column  Non-Null Count  Dtype</code>
        <code class="o">---</code>  <code class="o">------</code>  <code class="o">--------------</code>  <code class="o">-----</code>
         <code class="mi">0</code>   <code class="n">EUR</code><code class="o">=</code>    <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
         <code class="mi">1</code>   <code class="n">r</code>       <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
         <code class="mi">2</code>   <code class="n">s</code>       <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
         <code class="mi">3</code>   <code class="n">m</code>       <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
         <code class="mi">4</code>   <code class="n">v</code>       <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">float64</code>
         <code class="mi">5</code>   <code class="n">d</code>       <code class="mi">250</code> <code class="n">non</code><code class="o">-</code><code class="n">null</code>    <code class="n">int64</code>
        <code class="n">dtypes</code><code class="p">:</code> <code class="n">float64</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="n">int64</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
        <code class="n">memory</code> <code class="n">usage</code><code class="p">:</code> <code class="mf">13.7</code> <code class="n">KB</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">9</code><code class="p">]:</code> <code class="n">tradingbot</code><code class="o">.</code><code class="n">set_seeds</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
        <code class="n">agent</code> <code class="o">=</code> <code class="n">tradingbot</code><code class="o">.</code><code class="n">TradingBot</code><code class="p">(</code><code class="mi">24</code><code class="p">,</code> <code class="mf">0.001</code><code class="p">,</code> <code class="n">learn_env</code><code class="p">,</code> <code class="n">valid_env</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">10</code><code class="p">]:</code> <code class="n">episodes</code> <code class="o">=</code> <code class="mi">61</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">11</code><code class="p">]:</code> <code class="o">%</code><code class="n">time</code> <code class="n">agent</code><code class="o">.</code><code class="n">learn</code><code class="p">(</code><code class="n">episodes</code><code class="p">)</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">10</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.936</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.95</code>
         <code class="o">=======================================================================</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">20</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.897</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.86</code>
         <code class="o">=======================================================================</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">30</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">1.035</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.78</code>
         <code class="o">=======================================================================</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">40</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.935</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.70</code>
         <code class="o">=======================================================================</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">50</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.890</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.64</code>
         <code class="o">=======================================================================</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">60</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">VALIDATION</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>  <code class="mi">247</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.998</code> <code class="o">|</code> <code class="n">eps</code><code class="p">:</code> <code class="mf">0.58</code>
         <code class="o">=======================================================================</code>
         <code class="n">episode</code><code class="p">:</code> <code class="mi">61</code><code class="o">/</code><code class="mi">61</code> <code class="o">|</code> <code class="n">treward</code><code class="p">:</code>   <code class="mi">17</code> <code class="o">|</code> <code class="n">perf</code><code class="p">:</code> <code class="mf">0.979</code> <code class="o">|</code> <code class="n">av</code><code class="p">:</code> <code class="mf">475.1</code> <code class="o">|</code> <code class="nb">max</code><code class="p">:</code> <code class="mi">1747</code>
         <code class="n">CPU</code> <code class="n">times</code><code class="p">:</code> <code class="n">user</code> <code class="mf">51.4</code> <code class="n">s</code><code class="p">,</code> <code class="n">sys</code><code class="p">:</code> <code class="mf">2.53</code> <code class="n">s</code><code class="p">,</code> <code class="n">total</code><code class="p">:</code> <code class="mf">53.9</code> <code class="n">s</code>
         <code class="n">Wall</code> <code class="n">time</code><code class="p">:</code> <code class="mi">47</code> <code class="n">s</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">12</code><code class="p">]:</code> <code class="n">tradingbot</code><code class="o">.</code><code class="n">plot_treward</code><code class="p">(</code><code class="n">agent</code><code class="p">)</code></pre>

<figure class="thumb"><div id="figure_rm_01" class="figure">
<img src="Images/aiif_1101.png" alt="aiif 1101" width="2497" height="1491"/>
<h6><span class="label">Figure 11-1. </span>Average total reward per training episode</h6>
</div></figure>

<p><a data-type="xref" href="#figure_rm_02">Figure 11-2</a> compares the gross performance of the trading bot on the training data—exhibiting quite some variance due to alternating between exploitation and exploration—with the one on the validation data set making use of exploitation only:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">13</code><code class="p">]:</code> <code class="n">tradingbot</code><code class="o">.</code><code class="n">plot_performance</code><code class="p">(</code><code class="n">agent</code><code class="p">)</code></pre>

<figure class="thumb"><div id="figure_rm_02" class="figure">
<img src="Images/aiif_1102.png" alt="aiif 1102" width="2484" height="1491"/>
<h6><span class="label">Figure 11-2. </span>Gross performance on training and validation data set</h6>
</div></figure>

<p>This trained trading bot is used for backtesting in the following sections.<a data-type="indexterm" data-primary="" data-startref="ix_agent_fql_ch11" id="idm45625268269416"/><a data-type="indexterm" data-primary="" data-startref="ix_fql_agent_ch11" id="idm45625268268440"/><a data-type="indexterm" data-primary="" data-startref="ix_QL_fql_agent_ch11" id="idm45625268267496"/><a data-type="indexterm" data-primary="" data-startref="ix_risk_man_fql_agent_ch11" id="idm45625268266552"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Vectorized Backtesting"><div class="sect1" id="rm_vec_back">
<h1>Vectorized Backtesting</h1>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="DNN-based vectorized backtesting" id="ix_risk_man_DNNs_vector_backtest"/><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="DNNs" id="ix_vector_backtest_DNN_ch11"/><a data-type="indexterm" data-primary="DNNs (dense neural networks)" data-secondary="vectorized backtesting" id="ix_DNNs_vector_backtest_ch11"/>Vectorized backtesting cannot directly be applied to the trading bot. <a data-type="xref" href="ch10.xhtml#vectorized_backtesting">Chapter 10</a> uses dense neural networks (DNNs) to illustrate the approach. In this context, the data with the features and labels sub-sets is prepared first and then fed to the DNN to 
<span class="keep-together">generate</span> all predictions at once. In a reinforcement learning (RL) context, data is generated and collected by interacting with the environment action by action and step by step.</p>

<p><a data-type="indexterm" data-primary="backtest() function" id="idm45625268253208"/>To this end, the following Python code defines the <code>backtest</code> function, which takes as input a <code>TradingBot</code> instance and a <code>Finance</code> instance. It generates in the original <code>DataFrame</code> objects of the <code>Finance</code> environment columns with the positions the trading bot takes and the resulting strategy performance:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">14</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">reshape</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>             </code><code class="k">return</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">s</code><code class="p">,</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code><code>
</code><code>                                   </code><code class="n">learn_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO1-1" href="#callout_risk_management_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">15</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">def</code><code> </code><code class="nf">backtest</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code><code> </code><code class="n">env</code><code class="p">)</code><code class="p">:</code><code>
</code><code>             </code><code class="n">env</code><code class="o">.</code><code class="n">min_accuracy</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.0</code><code>
</code><code>             </code><code class="n">env</code><code class="o">.</code><code class="n">min_performance</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.0</code><code>
</code><code>             </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="bp">False</code><code>
</code><code>             </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" id="co_risk_management_CO1-2" href="#callout_risk_management_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>             </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">reset</code><code class="p">(</code><code class="p">)</code><code>
</code><code>             </code><code class="k">while</code><code> </code><code class="ow">not</code><code> </code><code class="n">done</code><code class="p">:</code><code>
</code><code>                 </code><code class="n">action</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code>
</code><code>                     </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">)</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO1-3" href="#callout_risk_management_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                 </code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="k">if</code><code> </code><code class="n">action</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="k">else</code><code> </code><code class="o">-</code><code class="mi">1</code><code>  </code><a class="co" id="co_risk_management_CO1-4" href="#callout_risk_management_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                 </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">loc</code><code class="p">[</code><code class="p">:</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">position</code><code>  </code><a class="co" id="co_risk_management_CO1-5" href="#callout_risk_management_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>                 </code><code class="n">state</code><code class="p">,</code><code> </code><code class="n">reward</code><code class="p">,</code><code> </code><code class="n">done</code><code class="p">,</code><code> </code><code class="n">info</code><code> </code><code class="o">=</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">step</code><code class="p">(</code><code class="n">action</code><code class="p">)</code><code>
</code><code>             </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">learn_env</code><code class="o">.</code><code class="n">leverage</code><code>  </code><a class="co" id="co_risk_management_CO1-6" href="#callout_risk_management_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO1-1" href="#co_risk_management_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Reshapes a single feature-label combination</p></dd>
<dt><a class="co" id="callout_risk_management_CO1-2" href="#co_risk_management_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Generates a column for the position values</p></dd>
<dt><a class="co" id="callout_risk_management_CO1-3" href="#co_risk_management_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Derives the optimal action (prediction) given the trained DNN</p></dd>
<dt><a class="co" id="callout_risk_management_CO1-4" href="#co_risk_management_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Derives the resulting position (<code>+1</code> for long/upwards, <code>–1</code> for short/downwards)…</p></dd>
<dt><a class="co" id="callout_risk_management_CO1-5" href="#co_risk_management_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>…and stores in the corresponding column at the appropriate index position</p></dd>
<dt><a class="co" id="callout_risk_management_CO1-6" href="#co_risk_management_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Calculates the strategy log returns given the position values</p></dd>
</dl>

<p>Equipped with the <code>backtest</code> function, vectorized backtesting boils down to a few lines of Python code as in <a data-type="xref" href="ch10.xhtml#vectorized_backtesting">Chapter 10</a>.</p>

<p><a data-type="xref" href="#figure_rm_03">Figure 11-3</a> compares the passive benchmark investment’s gross performance with the strategy gross performance:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">16</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code>  </code><a class="co" id="co_risk_management_CO2-1" href="#callout_risk_management_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">17</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">backtest</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code><code> </code><code class="n">env</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO2-2" href="#callout_risk_management_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">p</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO2-3" href="#callout_risk_management_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">18</code><code class="p">]</code><code class="p">:</code><code>  </code><code class="mi">1</code><code>    </code><code class="mi">961</code><code>
</code><code>         </code><code class="o">-</code><code class="mi">1</code><code>    </code><code class="mi">786</code><code>
</code><code>         </code><code class="n">Name</code><code class="p">:</code><code> </code><code class="n">p</code><code class="p">,</code><code> </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">int64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO2-4" href="#callout_risk_management_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">19</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="mf">0.7725</code><code>
</code><code>         </code><code class="n">s</code><code>   </code><code class="mf">1.5155</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_risk_management_CO2-5" href="#callout_risk_management_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">20</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">r</code><code>   </code><code class="o">-</code><code class="mf">0.2275</code><code>
</code><code>         </code><code class="n">s</code><code>    </code><code class="mf">0.5155</code><code>
</code><code>         </code><code class="n">dtype</code><code class="p">:</code><code> </code><code class="n">float64</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">21</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">r</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">s</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="p">]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code><code>
</code><code>                 </code><code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO2-1" href="#co_risk_management_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Specifies the relevant environment</p></dd>
<dt><a class="co" id="callout_risk_management_CO2-2" href="#co_risk_management_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Generates the additional data required</p></dd>
<dt><a class="co" id="callout_risk_management_CO2-3" href="#co_risk_management_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Counts the number of long and short positions</p></dd>
<dt><a class="co" id="callout_risk_management_CO2-4" href="#co_risk_management_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Calculates the gross performances for the passive benchmark investment (<code>r</code>) and the strategy (<code>s</code>)…</p></dd>
<dt><a class="co" id="callout_risk_management_CO2-5" href="#co_risk_management_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>…as well as the corresponding net performances</p></dd>
</dl>

<figure class="thumb"><div id="figure_rm_03" class="figure">
<img src="Images/aiif_1103.png" alt="aiif 1103" width="2418" height="1394"/>
<h6><span class="label">Figure 11-3. </span>Gross performance of the passive benchmark investment and the trading bot (in-sample)</h6>
</div></figure>

<p>To get a more realistic picture of the performance of the trading bot, the following Python code creates a test environment with data that the trading bot has not 
<span class="keep-together">yet seen.</span> <a data-type="xref" href="#figure_rm_04">Figure 11-4</a> shows how the trading bot fares compared to the passive 
<span class="keep-together">benchmark</span> investment:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">22</code><code class="p">]:</code> <code class="n">test_env</code> <code class="o">=</code> <code class="n">finance</code><code class="o">.</code><code class="n">Finance</code><code class="p">(</code><code class="n">symbol</code><code class="p">,</code> <code class="n">features</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">features</code><code class="p">,</code>
                                    <code class="n">window</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">window</code><code class="p">,</code>
                                    <code class="n">lags</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                    <code class="n">leverage</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">leverage</code><code class="p">,</code>
                                    <code class="n">min_performance</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code>
                                    <code class="n">start</code><code class="o">=</code><code class="n">a</code> <code class="o">+</code> <code class="n">b</code> <code class="o">+</code> <code class="n">c</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>
                                    <code class="n">mu</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">mu</code><code class="p">,</code> <code class="n">std</code><code class="o">=</code><code class="n">learn_env</code><code class="o">.</code><code class="n">std</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">23</code><code class="p">]:</code> <code class="n">env</code> <code class="o">=</code> <code class="n">test_env</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">24</code><code class="p">]:</code> <code class="n">backtest</code><code class="p">(</code><code class="n">agent</code><code class="p">,</code> <code class="n">env</code><code class="p">)</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'p'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">value_counts</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">25</code><code class="p">]:</code> <code class="o">-</code><code class="mi">1</code>    <code class="mi">437</code>
          <code class="mi">1</code>     <code class="mi">56</code>
         <code class="n">Name</code><code class="p">:</code> <code class="n">p</code><code class="p">,</code> <code class="n">dtype</code><code class="p">:</code> <code class="n">int64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">26</code><code class="p">]:</code> <code class="n">r</code>   <code class="mf">0.9144</code>
         <code class="n">s</code>   <code class="mf">1.0992</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">sum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code> <code class="o">-</code> <code class="mi">1</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">27</code><code class="p">]:</code> <code class="n">r</code>   <code class="o">-</code><code class="mf">0.0856</code>
         <code class="n">s</code>    <code class="mf">0.0992</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">28</code><code class="p">]:</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">(</code>
                     <code class="p">)</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">));</code></pre>

<figure class="thumb"><div id="figure_rm_04" class="figure">
<img src="Images/aiif_1104.png" alt="aiif 1104" width="2444" height="1428"/>
<h6><span class="label">Figure 11-4. </span>Gross performance of the passive benchmark investment and the trading bot (out-of-sample)</h6>
</div></figure>

<p>The out-of-sample performance without any risk measures implemented seems already promising. However, to be able to properly judge the real performance of a trading strategy, risk measures should be included. This is where event-based backtesting comes into play.<a data-type="indexterm" data-primary="" data-startref="ix_DNNs_vector_backtest_ch11" id="idm45625267388824"/><a data-type="indexterm" data-primary="" data-startref="ix_risk_man_DNNs_vector_backtest" id="idm45625267387880"/><a data-type="indexterm" data-primary="" data-startref="ix_vector_backtest_DNN_ch11" id="idm45625267386920"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Event-Based Backtesting"><div class="sect1" id="rm_event_back">
<h1>Event-Based Backtesting</h1>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="event-based backtesting" id="ix_risk_man_event_backtest"/><a data-type="indexterm" data-primary="event-based backtesting" id="ix_event_backtest_gen"/>Given the results of the previous section, the out-of-sample performance without any risk measures seems already promising. However, to be able to properly analyze risk measures, such as trailing stop loss orders, <em>event-based backtesting</em> is required. This section introduces this alternative approach to judging the performance of algorithmic trading strategies.</p>

<p><a data-type="xref" href="#rm_base">“Backtesting Base Class”</a> presents the <code>BacktestingBase</code> class that can be flexibly used to test different types of directional trading strategies. <a data-type="indexterm" data-primary="BacktestingBase class" id="ix_backtest_base_class"/>The code has detailed comments on the important lines. This base class provides the following methods:</p>
<dl>
<dt><code>get_date_price()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary=".get_date_price() method" data-primary-sortas="get_date_price() method" id="idm45625267376040"/>For a given <code>bar</code> (index value for the <code>DataFrame</code> object containing the financial data), it returns the relevant <code>date</code> and <code>price</code>.</p>
</dd>
<dt><code>print_balance()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary=".print_balance() method" data-primary-sortas="print_balance() method" id="idm45625267371896"/>For a given <code>bar</code>, it prints the current (cash) balance of the trading bot.</p>
</dd>
<dt><code>calculate_net_wealth()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary=".calculate_net_wealth() method" data-primary-sortas="calculate_net_wealth() method" id="idm45625267369064"/>For a given <code>price</code>, it returns the net wealth composed of the current (cash) balance and the instrument position.</p>
</dd>
<dt><code>print_net_wealth()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary=".print_net_wealth() method" data-primary-sortas="print_net_wealth() method" id="idm45625267366088"/>For a given <code>bar</code>, it prints the net wealth of the trading bot.</p>
</dd>
<dt><code>place_buy_order()</code>, <code>place_sell_order()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary="market orders" data-secondary="execution of" id="idm45625267362712"/><a data-type="indexterm" data-primary=".place_buy_order() method" data-primary-sortas="place_buy_order() method" id="idm45625267361736"/><a data-type="indexterm" data-primary=".place_sell_order() method" data-primary-sortas="place_sell_order() method" id="idm45625267360760"/>For a given <code>bar</code> and a given number of <code>units</code> or a given <code>amount</code>, these methods place buy or sell orders and adjust relevant quantities accordingly (for example, accounting for transaction costs).</p>
</dd>
<dt><code>close_out()</code></dt>
<dd>
<p><a data-type="indexterm" data-primary=".close_out() method" data-primary-sortas="close_out() method" id="idm45625267356888"/>At a given <code>bar</code>, this method closes open positions and calculates and reports performance statistics.</p>
</dd>
</dl>

<p>The following Python code illustrates how an instance of the 
<span class="keep-together"><code>BacktestingBase</code></span> class functions based on some simple steps:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">29</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">backtesting</code><code> </code><code class="kn">as</code><code> </code><code class="nn">bt</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">30</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code> </code><code class="o">=</code><code> </code><code class="n">bt</code><code class="o">.</code><code class="n">BacktestingBase</code><code class="p">(</code><code class="n">env</code><code class="o">=</code><code class="n">agent</code><code class="o">.</code><code class="n">learn_env</code><code class="p">,</code><code> </code><code class="n">model</code><code class="o">=</code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">amount</code><code class="o">=</code><code class="mi">10000</code><code class="p">,</code><code> </code><code class="n">ptc</code><code class="o">=</code><code class="mf">0.0001</code><code class="p">,</code><code> </code><code class="n">ftc</code><code class="o">=</code><code class="mf">1.0</code><code class="p">,</code><code>
</code><code>                                 </code><code class="n">verbose</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-1" href="#callout_risk_management_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">initial_amount</code><code>  </code><a class="co" id="co_risk_management_CO3-2" href="#callout_risk_management_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">31</code><code class="p">]</code><code class="p">:</code><code> </code><code class="mi">10000</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">32</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bar</code><code> </code><code class="o">=</code><code> </code><code class="mi">100</code><code>  </code><a class="co" id="co_risk_management_CO3-3" href="#callout_risk_management_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-4" href="#callout_risk_management_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">33</code><code class="p">]</code><code class="p">:</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">2010-06-25</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="mf">1.2374</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">get_state</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-5" href="#callout_risk_management_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">34</code><code class="p">]</code><code class="p">:</code><code>               </code><code class="n">EUR</code><code class="o">=</code><code>       </code><code class="n">r</code><code>       </code><code class="n">s</code><code>       </code><code class="n">m</code><code>      </code><code class="n">v</code><code>
</code><code>         </code><code class="n">Date</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">22</code><code> </code><code class="o">-</code><code class="mf">0.0242</code><code> </code><code class="o">-</code><code class="mf">0.5622</code><code> </code><code class="o">-</code><code class="mf">0.0916</code><code> </code><code class="o">-</code><code class="mf">0.2022</code><code> </code><code class="mf">1.5316</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">23</code><code>  </code><code class="mf">0.0176</code><code>  </code><code class="mf">0.6940</code><code> </code><code class="o">-</code><code class="mf">0.0939</code><code> </code><code class="o">-</code><code class="mf">0.0915</code><code> </code><code class="mf">1.5563</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">24</code><code>  </code><code class="mf">0.0354</code><code>  </code><code class="mf">0.3034</code><code> </code><code class="o">-</code><code class="mf">0.0865</code><code>  </code><code class="mf">0.6391</code><code> </code><code class="mf">1.0890</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">35</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="mi">5000</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-6" href="#callout_risk_management_CO3-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">25</code><code> </code><code class="o">|</code><code> </code><code class="n">buy</code><code> </code><code class="mi">4040</code><code> </code><code class="n">units</code><code> </code><code class="k">for</code><code> </code><code class="mf">1.2374</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">06</code><code class="o">-</code><code class="mi">25</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">4999.40</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">36</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-7" href="#callout_risk_management_CO3-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">16</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">wealth</code><code> </code><code class="o">=</code><code> </code><code class="mf">10450.17</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">37</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="mi">2</code><code> </code><code class="o">*</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-8" href="#callout_risk_management_CO3-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">16</code><code> </code><code class="o">|</code><code> </code><code class="n">sell</code><code> </code><code class="mi">1000</code><code> </code><code class="n">units</code><code> </code><code class="k">for</code><code> </code><code class="mf">1.3492</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">16</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">6347.47</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">38</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">bb</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="mi">3</code><code> </code><code class="o">*</code><code> </code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO3-9" href="#callout_risk_management_CO3-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="n">sell</code><code> </code><code class="mi">3040</code><code> </code><code class="n">units</code><code> </code><code class="k">for</code><code> </code><code class="mf">1.4434</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10733.97</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">7.3397</code><code>
</code><code>         </code><code class="mi">2011</code><code class="o">-</code><code class="mo">04</code><code class="o">-</code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 3</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO3-1" href="#co_risk_management_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Instantiates a <code>BacktestingBase</code> object</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-2" href="#co_risk_management_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Looks up the <code>initial_amount</code> attribute value</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-3" href="#co_risk_management_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Fixes a <code>bar</code> value</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-4" href="#co_risk_management_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Retrieves the <code>date</code> and <code>price</code> values for the <code>bar</code></p></dd>
<dt><a class="co" id="callout_risk_management_CO3-5" href="#co_risk_management_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Retrieves the state of the <code>Finance</code> environment for the <code>bar</code></p></dd>
<dt><a class="co" id="callout_risk_management_CO3-6" href="#co_risk_management_CO3-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Places a buy order using the <code>amount</code> parameter</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-7" href="#co_risk_management_CO3-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Prints the net wealth at a later point (<code>2 * bar</code>)</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-8" href="#co_risk_management_CO3-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Places a sell order at that later point using the <code>units</code> parameter</p></dd>
<dt><a class="co" id="callout_risk_management_CO3-9" href="#co_risk_management_CO3-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>Closes out the remaining long position even later (<code>3 * bar</code>)</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="TBBacktester class" id="ix_tbbacktester_class"/>Inheriting from the <code>BacktestingBase</code> class, the <code>TBBacktester</code> class implements the event-based backtesting for the trading bot:<a data-type="indexterm" data-primary="" data-startref="ix_backtest_base_class" id="idm45625267277608"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">39</code><code class="p">]</code><code class="p">:</code><code> </code><code class="k">class</code><code> </code><code class="nc">TBBacktester</code><code class="p">(</code><code class="n">bt</code><code class="o">.</code><code class="n">BacktestingBase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">_reshape</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">state</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="sd">''' Helper method to reshape state objects.
                 '''</code><code>
</code><code>                 </code><code class="k">return</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">,</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">n_features</code><code class="p">]</code><code class="p">)</code><code>
</code><code>             </code><code class="k">def</code><code> </code><code class="nf">backtest_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                 </code><code class="sd">''' Event-based backtesting of the trading bot's performance.
                 '''</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                 </code><code class="k">for</code><code> </code><code class="n">bar</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                     </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>                     </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">==</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>                         </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | *** START BACKTEST ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                     </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">get_state</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-1" href="#callout_risk_management_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                     </code><code class="n">action</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code>
</code><code>                                 </code><code class="bp">self</code><code class="o">.</code><code class="n">_reshape</code><code class="p">(</code><code class="n">state</code><code class="o">.</code><code class="n">values</code><code class="p">)</code><code class="p">)</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-2" href="#callout_risk_management_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                     </code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="k">if</code><code> </code><code class="n">action</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="k">else</code><code> </code><code class="o">-</code><code class="mi">1</code><code>  </code><a class="co" id="co_risk_management_CO4-3" href="#callout_risk_management_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                     </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO4-4" href="#callout_risk_management_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>                             </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                             </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | *** GOING LONG ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                             </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code>
</code><code>                                              </code><code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>                             </code><code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>                     </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="ow">in</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">]</code><code> </code><code class="ow">and</code><code> </code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO4-5" href="#callout_risk_management_CO4-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>                             </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                             </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | *** GOING SHORT ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code class="p">:</code><code>
</code><code>                             </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">,</code><code>
</code><code>                                               </code><code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code class="p">)</code><code>
</code><code>                         </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>                             </code><code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>                         </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="o">-</code><code class="mi">1</code><code>
</code><code>                     </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="p">(</code><code class="n">date</code><code class="p">,</code><code>
</code><code>                                              </code><code class="bp">self</code><code class="o">.</code><code class="n">calculate_net_wealth</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-6" href="#callout_risk_management_CO4-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="p">,</code><code>
</code><code>                                                 </code><code class="n">columns</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">net_wealth</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-7" href="#callout_risk_management_CO4-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'</code><code class="s1">date</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-8" href="#callout_risk_management_CO4-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">index</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DatetimeIndex</code><code class="p">(</code><code>
</code><code>                                                 </code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">index</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO4-9" href="#callout_risk_management_CO4-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>                 </code><code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO4-1" href="#co_risk_management_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Retrieves the state of the <code>Finance</code> environment</p></dd>
<dt><a class="co" id="callout_risk_management_CO4-2" href="#co_risk_management_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Generates the optimal action (prediction) given the state and the <code>model</code> object</p></dd>
<dt><a class="co" id="callout_risk_management_CO4-3" href="#co_risk_management_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Derives the optimal position (long/short) given the optimal action (prediction)</p></dd>
<dt><a class="co" id="callout_risk_management_CO4-4" href="#co_risk_management_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Enters a <em>long</em> position if the conditions are met</p></dd>
<dt><a class="co" id="callout_risk_management_CO4-5" href="#co_risk_management_CO4-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Enters a <em>short</em> position if the conditions are met</p></dd>
<dt><a class="co" id="callout_risk_management_CO4-6" href="#co_risk_management_CO4-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Collects the net wealth values over time and transforms them into a <code>DataFrame</code> object</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="transaction costs" data-secondary="event-based backtesting" id="ix_trans_cost_event_backtest"/><a data-type="indexterm" data-primary="event-based backtesting" data-secondary="transaction costs" id="ix_event_backtest_trans_cost"/>The application of the <code>TBBacktester</code> class is straightforward, given that the <code>Finance</code> and <code>TradingBot</code> instances are already available. The following code backtests the trading bot first on the <em>learning environment</em> data—without and with transaction costs. <a data-type="xref" href="#figure_rm_05">Figure 11-5</a> compares the two cases visually over time:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">40</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">learn_env</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">41</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code> </code><code class="o">=</code><code> </code><code class="n">TBBacktester</code><code class="p">(</code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code>
</code><code>                           </code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO5-1" href="#callout_risk_management_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">42</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO5-2" href="#callout_risk_management_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">14601.85</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">46.0185</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 828</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">43</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb_</code><code> </code><code class="o">=</code><code> </code><code class="n">TBBacktester</code><code class="p">(</code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code>
</code><code>                            </code><code class="mf">0.00012</code><code class="p">,</code><code> </code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">44</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb_</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO5-3" href="#callout_risk_management_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">13222.08</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">32.2208</code><code>
</code><code>         </code><code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 828</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">45</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ax</code><code> </code><code class="o">=</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>
</code><code>         </code><code class="n">tb_</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">net_wealth (after tc)</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>         </code><code class="n">tb_</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO5-1" href="#co_risk_management_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Event-based backtest in-sample <em>without</em> transaction costs</p></dd>
<dt><a class="co" id="callout_risk_management_CO5-2" href="#co_risk_management_CO5-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Event-based backtest in-sample <em>with</em> transaction costs</p></dd>
</dl>

<figure class="thumb"><div id="figure_rm_05" class="figure">
<img src="Images/aiif_1105.png" alt="aiif 1105" width="2482" height="1394"/>
<h6><span class="label">Figure 11-5. </span>Gross performance of the trading bot before and after transaction costs 
<span class="keep-together">(in-sample)</span></h6>
</div></figure>

<p><a data-type="xref" href="#figure_rm_06">Figure 11-6</a> compares the gross performances of the trading bot for the <em>test environment</em> data over time—again, before and after transaction costs:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">46</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">test_env</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">47</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code> </code><code class="o">=</code><code> </code><code class="n">TBBacktester</code><code class="p">(</code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code>
</code><code>                           </code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO6-1" href="#callout_risk_management_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">48</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO6-2" href="#callout_risk_management_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10936.79</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">9.3679</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 186</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">49</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb_</code><code> </code><code class="o">=</code><code> </code><code class="n">TBBacktester</code><code class="p">(</code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code>
</code><code>                            </code><code class="mf">0.00012</code><code class="p">,</code><code> </code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">50</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb_</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO6-3" href="#callout_risk_management_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10695.72</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">6.9572</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 186</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">51</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">ax</code><code> </code><code class="o">=</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code>
</code><code>         </code><code class="n">tb_</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">columns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="s1">'</code><code class="s1">net_wealth (after tc)</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>         </code><code class="n">tb_</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO6-1" href="#co_risk_management_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Event-based backtest out-of-sample <em>without</em> transaction costs</p></dd>
<dt><a class="co" id="callout_risk_management_CO6-2" href="#co_risk_management_CO6-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Event-based backtest out-of-sample <em>with</em> transaction costs</p></dd>
</dl>

<figure class="thumb"><div id="figure_rm_06" class="figure">
<img src="Images/aiif_1106.png" alt="aiif 1106" width="2482" height="1428"/>
<h6><span class="label">Figure 11-6. </span>Gross performance of the trading bot before and after transaction costs (out-of-sample)</h6>
</div></figure>

<p>How does the performance before transaction costs from the event-based backtesting compare to the performance from the vectorized backtesting? <a data-type="xref" href="#figure_rm_07">Figure 11-7</a> shows the normalized net wealth compared to the gross performance over time. Due to the different technical approaches, the two time series are not exactly the same but are pretty similar. The performance difference can be mainly explained by the fact that the event-based backtesting assumes the same amount for every position taken. Vectorized backtesting takes compound effects into account, leading to a slightly higher reported performance:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">52</code><code class="p">]:</code> <code class="n">ax</code> <code class="o">=</code> <code class="p">(</code><code class="n">tb</code><code class="o">.</code><code class="n">net_wealths</code> <code class="o">/</code> <code class="n">tb</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>
         <code class="n">tp</code> <code class="o">=</code> <code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[[</code><code class="s1">'r'</code><code class="p">,</code> <code class="s1">'s'</code><code class="p">]]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">:]</code><code class="o">.</code><code class="n">cumsum</code><code class="p">()</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">exp</code><code class="p">)</code>
         <code class="p">(</code><code class="n">tp</code> <code class="o">/</code> <code class="n">tp</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">);</code></pre>

<figure class="thumb"><div id="figure_rm_07" class="figure">
<img src="Images/aiif_1107.png" alt="aiif 1107" width="2444" height="1428"/>
<h6><span class="label">Figure 11-7. </span>Gross performance of the passive benchmark investment and the trading bot (vectorized and event-based backtesting)</h6>
</div></figure>
<div data-type="note" epub:type="note"><h1>Performance Differences</h1>
<p><a data-type="indexterm" data-primary="transaction costs" data-secondary="vectorized backtesting" id="idm45625265393192"/><a data-type="indexterm" data-primary="vectorized backtesting" data-secondary="transaction costs" id="idm45625265392216"/>The performance numbers from the vectorized and the event-based backtesting are close but not exactly the same. In the first case, it is assumed that financial instruments are perfectly divisible. Compounding is also done continuously. In the latter case, only full units of the financial instrument are accepted for trading, which is closer to reality. The net wealth calculations are based on price differences. The event-based code as it is used does not, for example, check whether the current balance is large enough to cover a certain trade by cash. This is for sure a simplifying assumption, and buying on margin, for instance, may not always be possible. Code adjustments in this regard are easily added to the <code>BacktestingBase</code> class.<a data-type="indexterm" data-primary="" data-startref="ix_event_backtest_gen" id="idm45625264628904"/><a data-type="indexterm" data-primary="" data-startref="ix_risk_man_event_backtest" id="idm45625264627896"/><a data-type="indexterm" data-primary="" data-startref="ix_event_backtest_trans_cost" id="idm45625264234952"/><a data-type="indexterm" data-primary="" data-startref="ix_tbbacktester_class" id="idm45625264234040"/><a data-type="indexterm" data-primary="" data-startref="ix_trans_cost_event_backtest" id="idm45625264233096"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Assessing Risk"><div class="sect1" id="rm_assessing_risk">
<h1>Assessing Risk</h1>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="assessing risk" id="ix_risk_man_assess"/>The implementation of risk measures requires the understanding of the risks involved in trading the chosen financial instrument. Therefore, to properly set parameters for risk measures, such as stop loss orders, an assessment of the risk of the underlying instrument is important. There are many approaches available to measure the risk of a financial instrument. <a data-type="indexterm" data-primary="directed risk measures, financial instruments" id="idm45625263901528"/><a data-type="indexterm" data-primary="non-directed risk measures, financial instruments" id="idm45625264224792"/><a data-type="indexterm" data-primary="volatility" data-secondary="ATR risk measure" id="ix_volatility_ATR"/><a data-type="indexterm" data-primary="ATR (average true range) risk measure" id="ix_ATR_ch11"/>There are, for example, <em>nondirected risk measures</em>, such as volatility or average true range (ATR). <a data-type="indexterm" data-primary="VaR (value-at-risk) risk measure" id="idm45625264953736"/>There are also <em>directed measures</em>, such as maximum drawdown or value-at-risk (VaR).</p>

<p><a data-type="indexterm" data-primary="market orders" data-secondary="backtesting risk measures" id="idm45625264952344"/><a data-type="indexterm" data-primary="stop loss (SL) order" data-secondary="backtesting risk measures" id="idm45625264951176"/><a data-type="indexterm" data-primary="take profit (TP) order" data-secondary="backtesting risk measures" id="idm45625264810376"/><a data-type="indexterm" data-primary="trailing stop loss (TSL) order" data-secondary="backtesting risk measures" id="idm45625264809416"/>A common practice when setting target levels for stop loss (SL), trailing stop loss (TSL), or take profit orders (TP) is to relate such levels to ATR values.<sup><a data-type="noteref" id="idm45625264808136-marker" href="ch11.xhtml#idm45625264808136">1</a></sup> The following Python code calculates the ATR in absolute and relative terms for the financial instrument on which the trading bot is trained and backtested (that is, the EUR/USD exchange rate). The calculations rely on the data from the learning environment and use a typical window length of 14 days (bars). <a data-type="xref" href="#figure_rm_08">Figure 11-8</a> shows the calculated 
<span class="keep-together">values</span>, which vary significantly over time:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">53</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">learn_env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-1" href="#callout_risk_management_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-2" href="#callout_risk_management_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Out</code><code class="p">[</code><code class="mi">54</code><code class="p">]</code><code class="p">:</code><code>              </code><code class="n">EUR</code><code class="o">=</code><code>
</code><code>         </code><code class="n">Date</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">02</code><code> </code><code class="mf">1.3961</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">03</code><code> </code><code class="mf">1.3898</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">04</code><code> </code><code class="mf">1.3734</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mo">05</code><code> </code><code class="mf">1.3662</code><code>
</code><code>         </code><code class="mi">2010</code><code class="o">-</code><code class="mo">02</code><code class="o">-</code><code class="mi">08</code><code> </code><code class="mf">1.3652</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">55</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">window</code><code> </code><code class="o">=</code><code> </code><code class="mi">14</code><code>  </code><a class="co" id="co_risk_management_CO7-3" href="#callout_risk_management_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">56</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">min</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-4" href="#callout_risk_management_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">57</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">max</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-5" href="#callout_risk_management_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">58</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mami</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" id="co_risk_management_CO7-6" href="#callout_risk_management_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">59</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mac</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">max</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-7" href="#callout_risk_management_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">60</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mic</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">min</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-8" href="#callout_risk_management_CO7-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">61</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">maximum</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mami</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mac</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-9" href="#callout_risk_management_CO7-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">62</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">np</code><code class="o">.</code><code class="n">maximum</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">mic</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO7-10" href="#callout_risk_management_CO7-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">63</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">%</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">/</code><code> </code><code class="n">data</code><code class="p">[</code><code class="n">symbol</code><code class="p">]</code><code>  </code><a class="co" id="co_risk_management_CO7-11" href="#callout_risk_management_CO7-10"><img src="Images/10.png" alt="10" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">64</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">data</code><code class="p">[</code><code class="p">[</code><code class="s1">'</code><code class="s1">atr</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">atr</code><code class="s1">%</code><code class="s1">'</code><code class="p">]</code><code class="p">]</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">subplots</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code><code> </code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">6</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO7-1" href="#co_risk_management_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The instrument price column from the original <code>DataFrame</code> object</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-2" href="#co_risk_management_CO7-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The window length to be used for the calculations</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-3" href="#co_risk_management_CO7-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The rolling minimum</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-4" href="#co_risk_management_CO7-5"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The rolling maximum</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-5" href="#co_risk_management_CO7-6"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The difference between rolling maximum and minimum</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-6" href="#co_risk_management_CO7-7"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>The absolute difference between rolling maximum and previous day’s price</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-7" href="#co_risk_management_CO7-8"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>The absolute difference between rolling minimum and previous day’s price</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-8" href="#co_risk_management_CO7-9"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>The maximum of the max-min difference and the max-price difference</p></dd>
<dt><a class="co" id="callout_risk_management_CO7-9" href="#co_risk_management_CO7-10"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>The maximum between the previous maximum and the min-price difference 
<span class="keep-together">(= ATR)</span></p></dd>
<dt><a class="co" id="callout_risk_management_CO7-10" href="#co_risk_management_CO7-11"><img src="Images/10.png" alt="10" width="12" height="12"/></a></dt>
<dd><p>The ATR value in percent from the absolute ATR value and the price</p></dd>
</dl>

<figure class="thumb"><div id="figure_rm_08" class="figure">
<img src="Images/aiif_1108.png" alt="aiif 1108" width="2444" height="1394"/>
<h6><span class="label">Figure 11-8. </span>Average true range (ATR) in absolute (price) and relative (%) terms</h6>
</div></figure>

<p>The code that follows displays the final values for ATR in absolute and relative terms. A typical rule would be to set, for example, the SL level at the entry price minus <em>x</em> times ATR. Depending on the risk appetite of the trader or investor, <em>x</em> might be smaller than 1 or larger. This is where human judgment or formal risk policies come into play. If <em>x = 1</em>, then the SL level is set at about 2% below the entry level:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">65</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'atr'</code><code class="p">,</code> <code class="s1">'atr%'</code><code class="p">]]</code><code class="o">.</code><code class="n">tail</code><code class="p">()</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">65</code><code class="p">]:</code>               <code class="n">atr</code>   <code class="n">atr</code><code class="o">%</code>
         <code class="n">Date</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">06</code> <code class="mf">0.0218</code> <code class="mf">0.0207</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">09</code> <code class="mf">0.0218</code> <code class="mf">0.0206</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">10</code> <code class="mf">0.0218</code> <code class="mf">0.0207</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">11</code> <code class="mf">0.0199</code> <code class="mf">0.0188</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code> <code class="mf">0.0206</code> <code class="mf">0.0194</code></pre>

<p><a data-type="indexterm" data-primary="FX (foreign exchange)" id="idm45625266374856"/><a data-type="indexterm" data-primary="leverage, ATR risk measurement in backtesting" id="idm45625266351336"/>However, <em>leverage</em> plays an important role in this context. If a leverage of, say, 10 is used, which is actually quite low for foreign exchange trading, then the ATR numbers need to be multiplied by the leverage. As a consequence, for an assumed ATR factor of 1, the same SL level from before now is to be set at about 20% instead of just 2%. Or, when taking the median value of the ATR from the whole data set, it is set to be at about 25%:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code> <code class="p">[</code><code class="mi">66</code><code class="p">]:</code> <code class="n">leverage</code> <code class="o">=</code> <code class="mi">10</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">67</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'atr'</code><code class="p">,</code> <code class="s1">'atr%'</code><code class="p">]]</code><code class="o">.</code><code class="n">tail</code><code class="p">()</code> <code class="o">*</code> <code class="n">leverage</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">67</code><code class="p">]:</code>               <code class="n">atr</code>   <code class="n">atr</code><code class="o">%</code>
         <code class="n">Date</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mo">06</code> <code class="mf">0.2180</code> <code class="mf">0.2070</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">09</code> <code class="mf">0.2180</code> <code class="mf">0.2062</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">10</code> <code class="mf">0.2180</code> <code class="mf">0.2066</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">11</code> <code class="mf">0.1990</code> <code class="mf">0.1881</code>
         <code class="mi">2017</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">12</code> <code class="mf">0.2060</code> <code class="mf">0.1942</code>

<code class="n">In</code> <code class="p">[</code><code class="mi">68</code><code class="p">]:</code> <code class="n">data</code><code class="p">[[</code><code class="s1">'atr'</code><code class="p">,</code> <code class="s1">'atr%'</code><code class="p">]]</code><code class="o">.</code><code class="n">median</code><code class="p">()</code> <code class="o">*</code> <code class="n">leverage</code>
<code class="n">Out</code><code class="p">[</code><code class="mi">68</code><code class="p">]:</code> <code class="n">atr</code>    <code class="mf">0.3180</code>
         <code class="n">atr</code><code class="o">%</code>   <code class="mf">0.2481</code>
         <code class="n">dtype</code><code class="p">:</code> <code class="n">float64</code></pre>

<p><a data-type="indexterm" data-primary="market orders" data-secondary="backtesting risk measures" id="idm45625265945320"/><a data-type="indexterm" data-primary="stop loss (SL) order" data-secondary="backtesting risk measures" id="idm45625265944472"/><a data-type="indexterm" data-primary="take profit (TP) order" data-secondary="backtesting risk measures" id="idm45625266156184"/>The basic idea behind relating SL or TP levels to ATR is that one should avoid setting them either too low or too high. Consider a 10 times leveraged position for which the ATR is 20%. Setting an SL level of only 3% or 5% might reduce the financial risk for the position, but it introduces the risk of a stop out that happens too early and that is due to typical movements in the financial instrument. <a data-type="indexterm" data-primary="noise, in financial instrument price movements" id="idm45625266154728"/>Such “typical movements” within certain ranges are often called <em>noise</em>. The SL order should protect, in general, from unfavorable market movements that are larger than typical price movements (noise).</p>

<p>The same holds true for a take profit level. If it is set too high, say at three times the ATR level, decent profits might not be secured and positions might remain open for too long until they give up previous profits. Even if formal analyses and mathematical formulas can be used in this context, the setting of such target levels involves, as they say, more art than science. In a financial context, there is quite a degree of freedom for setting such target levels, and human judgment can come to the rescue. In other contexts, such as for AVs, this is different, as no human judgment is needed to instruct the AI to avoid any collisions with human beings.<a data-type="indexterm" data-primary="" data-startref="ix_ATR_ch11" id="idm45625266152344"/><a data-type="indexterm" data-primary="" data-startref="ix_volatility_ATR" id="idm45625266151368"/></p>
<div data-type="important"><h1>NonNormality and NonLinearity</h1>
<p><a data-type="indexterm" data-primary="margin stop out" id="idm45625266149320"/>A <em>margin stop out</em> closes a trading position in cases when the margin, or the invested equity, is used up. Assume a leveraged trading position with a margin stop out in place. For a leverage of 10, for example, the margin is 10% equity. An <em>unfavorable</em> move of 10% or larger in the traded instrument eats up all the equity and triggers the close out of the position—a loss of 100% of the equity. A <em>favorable</em> move of the underlying of, say, 25% leads to a return on equity of 150%. <a data-type="indexterm" data-primary="normally distributed returns" id="idm45625264694776"/><a data-type="indexterm" data-primary="returns" data-secondary="normally distributed" id="idm45625264694216"/>Even if returns of the traded instrument are normally 
<span class="keep-together">distributed,</span> leverage and margin stop outs lead to nonnormally distributed returns and asymmetric, nonlinear relationships between the traded instrument and the trading position.<a data-type="indexterm" data-primary="" data-startref="ix_risk_man_assess" id="idm45625264692312"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Backtesting Risk Measures"><div class="sect1" id="rm_risk_measures">
<h1>Backtesting Risk Measures</h1>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="backtesting risk measures" id="ix_risk_man_backtest_risk"/><a data-type="indexterm" data-primary="backtesting risk measures" id="ix_backtest_risk_meas"/>Having an idea of the ATR of a financial instrument is often a good start for the implementation of risk measures. <a data-type="indexterm" data-primary="BacktestingBase class" id="idm45625264687048"/>To be able to properly backtest the effect of the typical risk management orders, some adjustments to the <code>BacktestingBase</code> class are helpful. <a data-type="indexterm" data-primary="BacktestingBaseRM class" id="idm45625264685736"/>The following Python code presents a new base class—<code>BacktestBaseRM</code>, which inherits from <code>BacktestingBase</code>—that helps in tracking the entry price of the previous trade as well as the maximum and minimum prices since that trade. These values are used to calculate the relevant performance measures during the event-based backtesting to which SL, TSL, and TP orders relate:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code><code>
</code><code class="c1"># Event-Based Backtesting</code><code>
</code><code class="c1"># --Base Class (2)</code><code>
</code><code class="c1">#</code><code>
</code><code class="c1"># (c) Dr. Yves J. Hilpisch</code><code>
</code><code class="c1">#</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">backtesting</code><code> </code><code class="kn">import</code><code> </code><code class="o">*</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">BacktestingBaseRM</code><code class="p">(</code><code class="n">BacktestingBase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">set_prices</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">price</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Sets prices for tracking of performance.
            To test for e.g. trailing stop loss hit.
        '''</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code> </code><code class="o">=</code><code> </code><code class="n">price</code><code>  </code><a class="co" id="co_risk_management_CO8-1" href="#callout_risk_management_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code><code> </code><code class="o">=</code><code> </code><code class="n">price</code><code>  </code><a class="co" id="co_risk_management_CO8-2" href="#callout_risk_management_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code> </code><code class="o">=</code><code> </code><code class="n">price</code><code>  </code><a class="co" id="co_risk_management_CO8-3" href="#callout_risk_management_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">place_buy_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">gprice</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Places a buy order for a given bar and for
            a given amount or number of units.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">gprice</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">gprice</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">units</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">set_prices</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO8-4" href="#callout_risk_management_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | buy {units} units for {price:.4f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">place_sell_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">gprice</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Places a sell order for a given bar and for
            a given amount or number of units.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">gprice</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">gprice</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">units</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">set_prices</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO8-5" href="#callout_risk_management_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | sell {units} units for {price:.4f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO8-1" href="#co_risk_management_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the <em>entry</em> price for the most recent trade</p></dd>
<dt><a class="co" id="callout_risk_management_CO8-2" href="#co_risk_management_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the initial <em>minimum</em> price since the most ecent trade</p></dd>
<dt><a class="co" id="callout_risk_management_CO8-3" href="#co_risk_management_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the initial <em>maximum</em> price since the most recent trade</p></dd>
<dt><a class="co" id="callout_risk_management_CO8-4" href="#co_risk_management_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the relevant prices after a trade is executed</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="TBBacktesterRM class" id="idm45625263644824"/>Based on this new base class, <a data-type="xref" href="#rm_backtest">“Backtesting Class”</a> presents a new backtesting class, <code>TBBacktesterRM</code>, that allows the inclusion of SL, TSL, and TP orders. The relevant code parts are discussed in the following sub-sections. The parametrization of the backtesting examples orients itself roughly on an ATR level of about 2%, as calculated in the previous section.</p>
<div data-type="important"><h1>EUT and Risk Measures</h1>
<p><a data-type="indexterm" data-primary="normative financial theories and models" data-secondary="arbitrage pricing theory" id="idm45625264070504"/><a data-type="indexterm" data-primary="uncertainty and risk" data-secondary="arbitrage pricing theory" id="idm45625264069336"/><a data-type="indexterm" data-primary="uncertainty and risk" data-secondary="capital asset pricing model" id="idm45625264068376"/><a data-type="indexterm" data-primary="uncertainty and risk" data-secondary="expected utility theory" id="idm45625263427976"/><a data-type="indexterm" data-primary="APT (arbitrage pricing theory)" data-secondary="risk measures and" id="idm45625263427032"/><a data-type="indexterm" data-primary="CAPM (capital asset pricing model)" data-secondary="risk measures and" id="idm45625263426072"/><a data-type="indexterm" data-primary="EUT (expected utility theory)" data-secondary="risk measures and" id="idm45625263336072"/>EUT, MVP, and the CAPM (see Chapters <a data-xrefstyle="select:labelnumber" data-type="xref" href="ch03.xhtml#normative_finance">3</a> and <a data-xrefstyle="select:labelnumber" data-type="xref" href="ch04.xhtml#data_driven_finance">4</a>) assume that financial agents know about the future distribution of the returns of a financial instrument. MPT and the CAPM assume furthermore that returns are normally distributed and that there is, for example, a linear relationship between the market portfolio’s returns and the returns of a traded financial instrument. The use of SL, TSL, and TP orders leads—similar and in addition to leverage in combination with margin stop out—to a “guaranteed nonnormal” distribution and to highly asymmetric, nonlinear payoffs of a trading position in relation to the traded instrument.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Stop Loss"><div class="sect2" id="idm45625263372488">
<h2>Stop Loss</h2>

<p><a data-type="indexterm" data-primary="market orders" data-secondary="backtesting risk measures" id="ix_market_order_risk_meas"/><a data-type="indexterm" data-primary="stop loss (SL) order" data-secondary="backtesting risk measures" id="ix_stop_loss_risk_measur"/>The first risk measure is the SL order. It fixes a certain price level or, more often, a fixed percent value that triggers the closing of a position. For example, if the entry price for an unleveraged position is 100 and the SL level is set to 5%, then a long position is closed out at 95 while a short position is closed out at 105.</p>

<p>The following Python code is the relevant part of the <code>TBBacktesterRM</code> class that handles an SL order. For the SL order, the class allows one to specify whether the price level for the order is guaranteed or not.<sup><a data-type="noteref" id="idm45625263710744-marker" href="ch11.xhtml#idm45625263710744">2</a></sup> Working with guaranteed SL price levels might lead to too-optimistic performance results:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1"># stop loss order</code><code>
</code><code class="k">if</code><code> </code><code class="n">sl</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="bp">None</code><code> </code><code class="ow">and</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO9-1" href="#callout_risk_management_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">rc</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">price</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code>  </code><a class="co" id="co_risk_management_CO9-2" href="#callout_risk_management_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="ow">and</code><code> </code><code class="n">rc</code><code> </code><code class="o">&lt;</code><code> </code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO9-3" href="#callout_risk_management_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">guarantee</code><code class="p">:</code><code>
</code><code>            </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">)</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** STOP LOSS (LONG  | {-self.sl:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** STOP LOSS (LONG  | {rc:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code><code> </code><code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO9-4" href="#callout_risk_management_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">wait</code><code> </code><code class="o">=</code><code> </code><code class="n">wait</code><code>  </code><a class="co" id="co_risk_management_CO9-5" href="#callout_risk_management_CO9-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>   </code><a class="co" id="co_risk_management_CO9-6" href="#callout_risk_management_CO9-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code class="ow">and</code><code> </code><code class="n">rc</code><code> </code><code class="o">&gt;</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO9-7" href="#callout_risk_management_CO9-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">guarantee</code><code class="p">:</code><code>
</code><code>            </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code> </code><code class="o">*</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">)</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** STOP LOSS (SHORT | -{self.sl:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** STOP LOSS (SHORT | -{rc:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code><code> </code><code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO9-8" href="#callout_risk_management_CO9-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">wait</code><code> </code><code class="o">=</code><code> </code><code class="n">wait</code><code>  </code><a class="co" id="co_risk_management_CO9-9" href="#callout_risk_management_CO9-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" id="co_risk_management_CO9-10" href="#callout_risk_management_CO9-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO9-1" href="#co_risk_management_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Checks whether an SL is defined and whether the position is not neutral</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-2" href="#co_risk_management_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Calculates the performance based on the entry price for the last trade</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-3" href="#co_risk_management_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Checks whether an SL event is given for a <em>long</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-4" href="#co_risk_management_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Closes the <em>long</em> position, at either the current price or the guaranteed price level</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-5" href="#co_risk_management_CO9-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets the number of bars to wait before the next trade happens to <code>wait</code></p></dd>
<dt><a class="co" id="callout_risk_management_CO9-6" href="#co_risk_management_CO9-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Sets the position to neutral</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-7" href="#co_risk_management_CO9-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Checks whether an SL event is given for a <em>short</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO9-8" href="#co_risk_management_CO9-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Closes the <em>short</em> position, at either the current price or the guaranteed price level</p></dd>
</dl>

<p>The following Python code backtests the trading strategy of the trading bot without and with an SL order. For the given parametrization, the SL order has a negative impact on the strategy performance:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">69</code><code class="p">]</code><code class="p">:</code><code> </code><code class="kn">import</code><code> </code><code class="nn">tbbacktesterrm</code><code> </code><code class="kn">as</code><code> </code><code class="nn">tbbrm</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">70</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">test_env</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">71</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code> </code><code class="o">=</code><code> </code><code class="n">tbbrm</code><code class="o">.</code><code class="n">TBBacktesterRM</code><code class="p">(</code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">agent</code><code class="o">.</code><code class="n">model</code><code class="p">,</code><code> </code><code class="mi">10000</code><code class="p">,</code><code>
</code><code>                                   </code><code class="mf">0.0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO10-1" href="#callout_risk_management_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">72</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tp</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO10-2" href="#callout_risk_management_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10936.79</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">9.3679</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 186</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">73</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="mf">0.0175</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tp</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">guarantee</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO10-3" href="#callout_risk_management_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0203</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10717.32</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">7.1732</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 188</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">74</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="mf">0.017</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tp</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">guarantee</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO10-4" href="#callout_risk_management_CO10-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0170</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10753.52</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">7.5352</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 188</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO10-1" href="#co_risk_management_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Instantiates the backtesting class for risk management</p></dd>
<dt><a class="co" id="callout_risk_management_CO10-2" href="#co_risk_management_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance without any risk measure</p></dd>
<dt><a class="co" id="callout_risk_management_CO10-3" href="#co_risk_management_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with an SL order (<em>no</em> guarantee)</p></dd>
<dt><a class="co" id="callout_risk_management_CO10-4" href="#co_risk_management_CO10-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with an SL order (<em>with</em> guarantee)<a data-type="indexterm" data-primary="" data-startref="ix_stop_loss_risk_measur" id="idm45625262390920"/></p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Trailing Stop Loss"><div class="sect2" id="idm45625262389768">
<h2>Trailing Stop Loss</h2>

<p><a data-type="indexterm" data-primary="trailing stop loss (TSL) order" data-secondary="backtesting risk measures" id="ix_trail_stoploss_risk_measur"/>In contrast to a regular SL order, a TSL order is adjusted whenever a new high is observed after the base order has been placed. Assume the base order for an unleveraged long position has an entry price of 95 and the TSL is set to 5%. If the instrument price reaches 100 and falls back to 95, this implies a TSL event, and the position is closed at the entry price level. If the price reaches 110 and falls back to 104.5, this would imply another TSL event.</p>

<p>The following Python code is the relevant part of the <code>TBBacktesterRM</code> class that handles a TSL order. To handle such an order correctly, the maximum prices (highs) and the minimum prices (lows) need to be tracked. The maximum price is relevant for a long position, whereas the minimum price is relevant for a short position:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1"># trailing stop loss order</code><code>
</code><code class="k">if</code><code> </code><code class="n">tsl</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="bp">None</code><code> </code><code class="ow">and</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">!=</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code> </code><code class="o">=</code><code> </code><code class="nb">max</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code class="p">,</code><code> </code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO11-1" href="#callout_risk_management_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code><code> </code><code class="o">=</code><code> </code><code class="nb">min</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code><code class="p">,</code><code> </code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO11-2" href="#callout_risk_management_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">rc_1</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">price</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code>  </code><a class="co" id="co_risk_management_CO11-3" href="#callout_risk_management_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">rc_2</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code><code> </code><code class="o">-</code><code> </code><code class="n">price</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code>  </code><a class="co" id="co_risk_management_CO11-4" href="#callout_risk_management_CO11-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="mi">1</code><code> </code><code class="ow">and</code><code> </code><code class="n">rc_1</code><code> </code><code class="o">&lt;</code><code> </code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO11-5" href="#callout_risk_management_CO11-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** TRAILING SL (LONG  | {rc_1:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">wait</code><code> </code><code class="o">=</code><code> </code><code class="n">wait</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>    </code><code class="k">elif</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">==</code><code> </code><code class="o">-</code><code class="mi">1</code><code> </code><code class="ow">and</code><code> </code><code class="n">rc_2</code><code> </code><code class="o">&lt;</code><code> </code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl</code><code class="p">:</code><code>  </code><a class="co" id="co_risk_management_CO11-6" href="#callout_risk_management_CO11-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">*** TRAILING SL (SHORT | {rc_2:.4f}) ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">wait</code><code> </code><code class="o">=</code><code> </code><code class="n">wait</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">position</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO11-1" href="#co_risk_management_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Updates the <em>maximum</em> price if necessary</p></dd>
<dt><a class="co" id="callout_risk_management_CO11-2" href="#co_risk_management_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Updates the <em>minimum</em> price if necessary</p></dd>
<dt><a class="co" id="callout_risk_management_CO11-3" href="#co_risk_management_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Calculates the relevant performance for a <em>long</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO11-4" href="#co_risk_management_CO11-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Calculates the relevant performance for a <em>short</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO11-5" href="#co_risk_management_CO11-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Checks whether a TSL event is given for a <em>long</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO11-6" href="#co_risk_management_CO11-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Checks whether a TSL event is given for a <em>short</em> position</p></dd>
</dl>

<p>As the backtesting results that follow show, using a TSL order with the given parametrization reduces the gross performance compared to a strategy without a TSL order in place:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">75</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="mf">0.015</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">tp</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO12-1" href="#callout_risk_management_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0152</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0169</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0164</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0191</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0166</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0194</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0172</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0181</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0153</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0160</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10577.93</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">5.7793</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 201</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO12-1" href="#co_risk_management_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with a TSL order<a data-type="indexterm" data-primary="" data-startref="ix_trail_stoploss_risk_measur" id="idm45625261473368"/></p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Take Profit"><div class="sect2" id="idm45625261472168">
<h2>Take Profit</h2>

<p><a data-type="indexterm" data-primary="take profit (TP) order" data-secondary="backtesting risk measures" id="ix_take_profit_risk_measur"/>Finally, there are TP orders. A TP order closes out a position that has reached a certain profit level. Say an unleveraged long position is opened at a price of 100 and the TP order is set to a level of 5%. If the price reaches 105, the position is closed.</p>

<p>The following code from the <code>TBBacktesterRM</code> class finally shows the part that handles a TP order. The TP implementation is straightforward, given the references of the SL and TSL order codes. For the TP order, there is also the option to backtest with a guaranteed price level as compared to the relevant high/low price levels, which would most probably lead to performance values that are too optimistic:<sup><a data-type="noteref" id="idm45625261444776-marker" href="ch11.xhtml#idm45625261444776">3</a></sup></p>

<pre data-type="programlisting" data-code-language="python"><code class="c1"># take profit order</code>
<code class="k">if</code> <code class="n">tp</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
    <code class="n">rc</code> <code class="o">=</code> <code class="p">(</code><code class="n">price</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code>
    <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">:</code>
        <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
        <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
            <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">)</code>
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (LONG  | {self.tp:.4f}) ***'</code><code class="p">)</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (LONG  | {rc:.4f}) ***'</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&lt;</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">:</code>
        <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
        <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
            <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">)</code>
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (SHORT | {self.tp:.4f}) ***'</code><code class="p">)</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (SHORT | {-rc:.4f}) ***'</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code></pre>

<p>For the given parametrization, adding a TP order—without guarantee—improves the trading bot performance noticeably compared to the passive benchmark investment. This result might be too optimistic given the considerations from before. Therefore, the TP order with guarantee leads to a more realistic performance value in this case:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">76</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tp</code><code class="o">=</code><code class="mf">0.015</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">guarantee</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO13-1" href="#callout_risk_management_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0155</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0155</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0204</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0240</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0168</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0156</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0183</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">11210.33</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">12.1033</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 198</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">77</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tp</code><code class="o">=</code><code class="mf">0.015</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="n">guarantee</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO13-2" href="#callout_risk_management_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0150</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10980.86</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">9.8086</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 198</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO13-1" href="#co_risk_management_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with a TP order (<em>no</em> guarantee)</p></dd>
<dt><a class="co" id="callout_risk_management_CO13-2" href="#co_risk_management_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with a TP order (<em>with</em> guarantee)</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="stop loss (SL) order" data-secondary="backtesting risk measures" id="idm45625250979560"/><a data-type="indexterm" data-primary="trailing stop loss (TSL) order" data-secondary="backtesting risk measures" id="idm45625250978568"/>Of course, SL/TSL orders can also be combined with TP orders. The backtest results of the Python code that follows are in both cases worse than those for the strategy without the risk measures in place. In managing risk, there is hardly any free lunch:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">78</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="mf">0.015</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">tp</code><code class="o">=</code><code class="mf">0.0185</code><code class="p">,</code><code> </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO14-1" href="#callout_risk_management_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0203</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0202</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0213</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0240</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0171</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0188</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0153</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">STOP</code><code> </code><code class="n">LOSS</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0154</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10552.00</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">5.5200</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 201</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>
</code><code class="n">In</code><code> </code><code class="p">[</code><code class="mi">79</code><code class="p">]</code><code class="p">:</code><code> </code><code class="n">tb</code><code class="o">.</code><code class="n">backtest_strategy</code><code class="p">(</code><code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">tsl</code><code class="o">=</code><code class="mf">0.02</code><code class="p">,</code><code>
</code><code>                              </code><code class="n">tp</code><code class="o">=</code><code class="mf">0.02</code><code class="p">,</code><code> </code><code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO14-2" href="#callout_risk_management_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">START</code><code> </code><code class="n">BACKTEST</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2018</code><code class="o">-</code><code class="mo">01</code><code class="o">-</code><code class="mi">17</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10000.00</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0235</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0202</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0250</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0227</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0240</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0216</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TAKE</code><code> </code><code class="n">PROFIT</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="mf">0.0241</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code class="o">-</code><code>
</code><code>         </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">TRAILING</code><code> </code><code class="n">SL</code><code> </code><code class="p">(</code><code class="n">SHORT</code><code> </code><code class="o">|</code><code> </code><code class="o">-</code><code class="mf">0.0206</code><code class="p">)</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="n">CLOSING</code><code> </code><code class="n">OUT</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">current</code><code> </code><code class="n">balance</code><code> </code><code class="o">=</code><code> </code><code class="mf">10346.38</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">net</code><code> </code><code class="n">performance</code><code> </code><code class="p">[</code><code class="o">%</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mf">3.4638</code><code>
</code><code>         </code><code class="mi">2019</code><code class="o">-</code><code class="mi">12</code><code class="o">-</code><code class="mi">31</code><code> </code><code class="o">|</code><code> </code><code class="n">number</code><code> </code><code class="n">of</code><code> </code><code class="n">trades</code><code> </code><code class="p">[</code><code class="c1">#] = 198</code><code>
</code><code>         </code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code><code class="o">==</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO14-1" href="#co_risk_management_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with an SL and TP order</p></dd>
<dt><a class="co" id="callout_risk_management_CO14-2" href="#co_risk_management_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Backtests the trading bot performance with a TSL and TP order</p></dd>
</dl>
<div data-type="note" epub:type="note"><h1>Performance Impact</h1>
<p>Risk measures have their reasoning and benefits. However, reducing risk may come at the price of lower overall performance. On the other hand, the backtesting example with the TP order shows performance improvements that can be explained by the fact that, given the ATR of a financial instrument, a certain profit level can be considered good enough to realize the profit. Any hope to see even higher profits typically is smashed by the market turning around again.<a data-type="indexterm" data-primary="" data-startref="ix_risk_man_alg_trading_ch11" id="idm45625247132792"/><a data-type="indexterm" data-primary="" data-startref="ix_backtest_risk_meas" id="idm45625247131800"/><a data-type="indexterm" data-primary="" data-startref="ix_risk_man_backtest_risk" id="idm45625247130856"/><a data-type="indexterm" data-primary="" data-startref="ix_market_order_risk_meas" id="idm45625247240760"/><a data-type="indexterm" data-primary="" data-startref="ix_take_profit_risk_measur" id="idm45625247239800"/></p>
</div>
<div style="page-break-after: always;"/>
</div></section>





</div></section>













<section data-type="sect1" class="less_space" data-pdf-bookmark="Conclusions"><div class="sect1" id="idm45625264691032">
<h1>Conclusions</h1>

<p>This chapter has three main topics. It backtests the performance of a trading bot (that is, a trained deep Q-learning agent) out-of-sample in both vectorized and event-based fashion. It also assesses risks in the form of the average true range (ATR) indicator that measures the <em>typical</em> variation in the price of the financial instrument of interest. Finally, the chapter discusses and backtests event-based typical risk measures in the form of stop loss (SL), trailing stop loss (TSL), and take profit (TP) orders.</p>

<p>Similar to autonomous vehicles (AVs), trading bots are hardly ever deployed based on the predictions of their AI only. To avoid large downside risks and to improve the (risk-adjusted) performance, risk measures usually come into play. Standard risk measures, as discussed in this chapter, are available on almost every trading platform, as well as for retail traders. The next chapter illustrates this in the context of the <a href="http://oanda.com">Oanda</a> trading platform. The event-based backtesting approach provides the algorithmic flexibility to properly backtest the effects of such risk measures. While “reducing risk” may sound appealing, the backtest results indicate that the reduction in risk often comes at a cost: the performance might be lower when compared to the pure strategy without any risk measures. However, when finely tuned, the results also show that TP orders, for example, can also have a positive effect on the performance.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="References"><div class="sect1" id="idm45625247778136">
<h1>References</h1>

<p>Books and papers cited in this chapter:</p>

<ul class="author-date-bib">
<li>
<p>Agrawal, Ajay, Joshua Gans, and Avi Goldfarb. 2018. <em>Prediction Machines: The Simple Economics of Artificial Intelligence.</em> Boston: Harvard Business Review Press.</p>
</li>
<li>
<p>Hilpisch, Yves. 2020. <em>Python for Algorithmic Trading: From Idea to Cloud Deployment.</em> Sebastopol: O’Reilly.</p>
</li>
<li>
<p>Khonji, Majid, Jorge Dias, and Lakmal Seneviratne. 2019. “Risk-Aware Reasoning for Autonomous Vehicles.” arXiv. October 6, 2019. <a href="https://oreil.ly/2Z6WR"><em class="hyperlink">https://oreil.ly/2Z6WR</em></a>.</p>
</li>
</ul>
<div style="page-break-after: always;"/>
</div></section>













<section data-type="sect1" class="less_space" data-pdf-bookmark="Python Code"><div class="sect1" id="idm45625247160552">
<h1>Python Code</h1>








<section data-type="sect2" data-pdf-bookmark="Finance Environment"><div class="sect2" id="rm_finance">
<h2>Finance Environment</h2>

<p><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="backtesting Python code" id="ix_risk_man_pythoncode"/><a data-type="indexterm" data-primary="Finance environment class" id="idm45625247156264"/>The following is the Python module with the <code>Finance</code> environment class:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code>
<code class="c1"># Finance Environment</code>
<code class="c1">#</code>
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>
<code class="c1"># Artificial Intelligence in Finance</code>
<code class="c1">#</code>
<code class="kn">import</code> <code class="nn">math</code>
<code class="kn">import</code> <code class="nn">random</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>


<code class="k">class</code> <code class="nc">observation_space</code><code class="p">:</code>
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">n</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">shape</code> <code class="o">=</code> <code class="p">(</code><code class="n">n</code><code class="p">,)</code>


<code class="k">class</code> <code class="nc">action_space</code><code class="p">:</code>
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">n</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">n</code> <code class="o">=</code> <code class="n">n</code>

    <code class="k">def</code> <code class="nf">sample</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">n</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>


<code class="k">class</code> <code class="nc">Finance</code><code class="p">:</code>
    <code class="n">intraday</code> <code class="o">=</code> <code class="bp">False</code>
    <code class="k">if</code> <code class="n">intraday</code><code class="p">:</code>
        <code class="n">url</code> <code class="o">=</code> <code class="s1">'http://hilpisch.com/aiif_eikon_id_eur_usd.csv'</code>
    <code class="k">else</code><code class="p">:</code>
        <code class="n">url</code> <code class="o">=</code> <code class="s1">'http://hilpisch.com/aiif_eikon_eod_data.csv'</code>

    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">symbol</code><code class="p">,</code> <code class="n">features</code><code class="p">,</code> <code class="n">window</code><code class="p">,</code> <code class="n">lags</code><code class="p">,</code>
                 <code class="n">leverage</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">min_performance</code><code class="o">=</code><code class="mf">0.85</code><code class="p">,</code> <code class="n">min_accuracy</code><code class="o">=</code><code class="mf">0.5</code><code class="p">,</code>
                 <code class="n">start</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">mu</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">std</code><code class="o">=</code><code class="bp">None</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">symbol</code> <code class="o">=</code> <code class="n">symbol</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">features</code> <code class="o">=</code> <code class="n">features</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">n_features</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">features</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">window</code> <code class="o">=</code> <code class="n">window</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">=</code> <code class="n">lags</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">leverage</code> <code class="o">=</code> <code class="n">leverage</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">min_performance</code> <code class="o">=</code> <code class="n">min_performance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">min_accuracy</code> <code class="o">=</code> <code class="n">min_accuracy</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">start</code> <code class="o">=</code> <code class="n">start</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">=</code> <code class="n">end</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">mu</code> <code class="o">=</code> <code class="n">mu</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">std</code> <code class="o">=</code> <code class="n">std</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">observation_space</code> <code class="o">=</code> <code class="n">observation_space</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">action_space</code> <code class="o">=</code> <code class="n">action_space</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">_get_data</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">_prepare_data</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">_get_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="p">,</code> <code class="n">index_col</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code>
                               <code class="n">parse_dates</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">intraday</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">raw</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="o">.</code><code class="n">resample</code><code class="p">(</code><code class="s1">'30min'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'right'</code><code class="p">)</code><code class="o">.</code><code class="n">last</code><code class="p">()</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">raw</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="p">[</code><code class="s1">'CLOSE'</code><code class="p">])</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="o">.</code><code class="n">columns</code> <code class="o">=</code> <code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">_prepare_data</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">raw</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">])</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">:]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">shift</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'s'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'m'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'v'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">rolling</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">window</code><code class="p">)</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">mu</code> <code class="ow">is</code> <code class="bp">None</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">mu</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">std</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">std</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data_</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">mu</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">std</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'d'</code><code class="p">]</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'d'</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'d'</code><code class="p">]</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">]</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">data_</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="o">.</code><code class="n">iloc</code><code class="p">[:</code><code class="bp">self</code><code class="o">.</code><code class="n">end</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">_get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">-</code>
                                              <code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">get_state</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">bar</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="n">bar</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">seed</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">seed</code><code class="p">):</code>
        <code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
        <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">reset</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">treward</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">performance</code> <code class="o">=</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data_</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">features</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">-</code>
                                               <code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">:</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code>
        <code class="k">return</code> <code class="n">state</code><code class="o">.</code><code class="n">values</code>

    <code class="k">def</code> <code class="nf">step</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">action</code><code class="p">):</code>
        <code class="n">correct</code> <code class="o">=</code> <code class="n">action</code> <code class="o">==</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'d'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code>
        <code class="n">ret</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="s1">'r'</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code><code class="p">]</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">leverage</code>
        <code class="n">reward_1</code> <code class="o">=</code> <code class="mi">1</code> <code class="k">if</code> <code class="n">correct</code> <code class="k">else</code> <code class="mi">0</code>
        <code class="n">reward_2</code> <code class="o">=</code> <code class="nb">abs</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code> <code class="k">if</code> <code class="n">correct</code> <code class="k">else</code> <code class="o">-</code><code class="nb">abs</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">treward</code> <code class="o">+=</code> <code class="n">reward_1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">+=</code> <code class="mi">1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">treward</code> <code class="o">/</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">performance</code> <code class="o">*=</code> <code class="n">math</code><code class="o">.</code><code class="n">exp</code><code class="p">(</code><code class="n">reward_2</code><code class="p">)</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">&gt;=</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">data</code><code class="p">):</code>
            <code class="n">done</code> <code class="o">=</code> <code class="bp">True</code>
        <code class="k">elif</code> <code class="n">reward_1</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
            <code class="n">done</code> <code class="o">=</code> <code class="bp">False</code>
        <code class="k">elif</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">performance</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">min_performance</code> <code class="ow">and</code>
              <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">15</code><code class="p">):</code>
            <code class="n">done</code> <code class="o">=</code> <code class="bp">True</code>
        <code class="k">elif</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">accuracy</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">min_accuracy</code> <code class="ow">and</code>
              <code class="bp">self</code><code class="o">.</code><code class="n">bar</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">lags</code> <code class="o">+</code> <code class="mi">15</code><code class="p">):</code>
            <code class="n">done</code> <code class="o">=</code> <code class="bp">True</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="n">done</code> <code class="o">=</code> <code class="bp">False</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">_get_state</code><code class="p">()</code>
        <code class="n">info</code> <code class="o">=</code> <code class="p">{}</code>
        <code class="k">return</code> <code class="n">state</code><code class="o">.</code><code class="n">values</code><code class="p">,</code> <code class="n">reward_1</code> <code class="o">+</code> <code class="n">reward_2</code> <code class="o">*</code> <code class="mi">5</code><code class="p">,</code> <code class="n">done</code><code class="p">,</code> <code class="n">info</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Trading Bot"><div class="sect2" id="rm_bot">
<h2>Trading Bot</h2>

<p><a data-type="indexterm" data-primary="TradingBot class" id="idm45625251348472"/><a data-type="indexterm" data-primary="agents" data-secondary="FQLAgent" id="idm45625251347768"/><a data-type="indexterm" data-primary="FQLAgent" id="idm45625251346824"/><a data-type="indexterm" data-primary="QL (Q-learning)" data-secondary="FQLAgent" id="idm45625251346152"/><a data-type="indexterm" data-primary="risk management, algorithmic trading" data-secondary="FQLAgent trading bot" id="idm45625251345208"/>The following is the Python module with the <code>TradingBot</code> class, based on a financial Q-learning agent:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code>
<code class="c1"># Financial Q-Learning Agent</code>
<code class="c1">#</code>
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>
<code class="c1"># Artificial Intelligence in Finance</code>
<code class="c1">#</code>
<code class="kn">import</code> <code class="nn">os</code>
<code class="kn">import</code> <code class="nn">random</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="kn">from</code> <code class="nn">pylab</code> <code class="kn">import</code> <code class="n">plt</code><code class="p">,</code> <code class="n">mpl</code>
<code class="kn">from</code> <code class="nn">collections</code> <code class="kn">import</code> <code class="n">deque</code>
<code class="kn">import</code> <code class="nn">tensorflow</code> <code class="kn">as</code> <code class="nn">tf</code>
<code class="kn">from</code> <code class="nn">keras.layers</code> <code class="kn">import</code> <code class="n">Dense</code><code class="p">,</code> <code class="n">Dropout</code>
<code class="kn">from</code> <code class="nn">keras.models</code> <code class="kn">import</code> <code class="n">Sequential</code>
<code class="kn">from</code> <code class="nn">keras.optimizers</code> <code class="kn">import</code> <code class="n">Adam</code><code class="p">,</code> <code class="n">RMSprop</code>

<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s1">'PYTHONHASHSEED'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'0'</code>
<code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'seaborn'</code><code class="p">)</code>
<code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'savefig.dpi'</code><code class="p">]</code> <code class="o">=</code> <code class="mi">300</code>
<code class="n">mpl</code><code class="o">.</code><code class="n">rcParams</code><code class="p">[</code><code class="s1">'font.family'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'serif'</code>


<code class="k">def</code> <code class="nf">set_seeds</code><code class="p">(</code><code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">):</code>
    <code class="sd">''' Function to set seeds for all</code>
<code class="sd">        random number generators.</code>
<code class="sd">    '''</code>
    <code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
    <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>
    <code class="n">tf</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">set_seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code>


<code class="k">class</code> <code class="nc">TradingBot</code><code class="p">:</code>
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">hidden_units</code><code class="p">,</code> <code class="n">learning_rate</code><code class="p">,</code> <code class="n">learn_env</code><code class="p">,</code>
                 <code class="n">valid_env</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">val</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">dropout</code><code class="o">=</code><code class="bp">False</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code> <code class="o">=</code> <code class="n">learn_env</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code> <code class="o">=</code> <code class="n">valid_env</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">val</code> <code class="o">=</code> <code class="n">val</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">epsilon</code> <code class="o">=</code> <code class="mf">1.0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">epsilon_min</code> <code class="o">=</code> <code class="mf">0.1</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">epsilon_decay</code> <code class="o">=</code> <code class="mf">0.99</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">learning_rate</code> <code class="o">=</code> <code class="n">learning_rate</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">gamma</code> <code class="o">=</code> <code class="mf">0.5</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code> <code class="o">=</code> <code class="mi">128</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">max_treward</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">averages</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">trewards</code> <code class="o">=</code> <code class="p">[]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">performances</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">aperformances</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">vperformances</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">memory</code> <code class="o">=</code> <code class="n">deque</code><code class="p">(</code><code class="n">maxlen</code><code class="o">=</code><code class="mi">2000</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">model</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">_build_model</code><code class="p">(</code><code class="n">hidden_units</code><code class="p">,</code>
                             <code class="n">learning_rate</code><code class="p">,</code> <code class="n">dropout</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">_build_model</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">hu</code><code class="p">,</code> <code class="n">lr</code><code class="p">,</code> <code class="n">dropout</code><code class="p">):</code>
        <code class="sd">''' Method to create the DNN model.</code>
<code class="sd">        '''</code>
        <code class="n">model</code> <code class="o">=</code> <code class="n">Sequential</code><code class="p">()</code>
        <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="n">hu</code><code class="p">,</code> <code class="n">input_shape</code><code class="o">=</code><code class="p">(</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">),</code>
            <code class="n">activation</code><code class="o">=</code><code class="s1">'relu'</code><code class="p">))</code>
        <code class="k">if</code> <code class="n">dropout</code><code class="p">:</code>
            <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dropout</code><code class="p">(</code><code class="mf">0.3</code><code class="p">,</code> <code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">))</code>
        <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="n">hu</code><code class="p">,</code> <code class="n">activation</code><code class="o">=</code><code class="s1">'relu'</code><code class="p">))</code>
        <code class="k">if</code> <code class="n">dropout</code><code class="p">:</code>
            <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dropout</code><code class="p">(</code><code class="mf">0.3</code><code class="p">,</code> <code class="n">seed</code><code class="o">=</code><code class="mi">100</code><code class="p">))</code>
        <code class="n">model</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">Dense</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="n">activation</code><code class="o">=</code><code class="s1">'linear'</code><code class="p">))</code>
        <code class="n">model</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code>
            <code class="n">loss</code><code class="o">=</code><code class="s1">'mse'</code><code class="p">,</code>
            <code class="n">optimizer</code><code class="o">=</code><code class="n">RMSprop</code><code class="p">(</code><code class="n">lr</code><code class="o">=</code><code class="n">lr</code><code class="p">)</code>
        <code class="p">)</code>
        <code class="k">return</code> <code class="n">model</code>

    <code class="k">def</code> <code class="nf">act</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">state</code><code class="p">):</code>
        <code class="sd">''' Method for taking action based on</code>
<code class="sd">            a) exploration</code>
<code class="sd">            b) exploitation</code>
<code class="sd">        '''</code>
        <code class="k">if</code> <code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">()</code> <code class="o">&lt;=</code> <code class="bp">self</code><code class="o">.</code><code class="n">epsilon</code><code class="p">:</code>
            <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">action_space</code><code class="o">.</code><code class="n">sample</code><code class="p">()</code>
        <code class="n">action</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">state</code><code class="p">)[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code>
        <code class="k">return</code> <code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code class="n">action</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">replay</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="sd">''' Method to retrain the DNN model based on</code>
<code class="sd">            batches of memorized experiences.</code>
<code class="sd">        '''</code>
        <code class="n">batch</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">memory</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">state</code><code class="p">,</code> <code class="n">action</code><code class="p">,</code> <code class="n">reward</code><code class="p">,</code> <code class="n">next_state</code><code class="p">,</code> <code class="n">done</code> <code class="ow">in</code> <code class="n">batch</code><code class="p">:</code>
            <code class="k">if</code> <code class="ow">not</code> <code class="n">done</code><code class="p">:</code>
                <code class="n">reward</code> <code class="o">+=</code> <code class="bp">self</code><code class="o">.</code><code class="n">gamma</code> <code class="o">*</code> <code class="n">np</code><code class="o">.</code><code class="n">amax</code><code class="p">(</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">next_state</code><code class="p">)[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
            <code class="n">target</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">state</code><code class="p">)</code>
            <code class="n">target</code><code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">action</code><code class="p">]</code> <code class="o">=</code> <code class="n">reward</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="n">target</code><code class="p">,</code> <code class="n">epochs</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code>
                           <code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
        <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">epsilon</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">epsilon_min</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">epsilon</code> <code class="o">*=</code> <code class="bp">self</code><code class="o">.</code><code class="n">epsilon_decay</code>

    <code class="k">def</code> <code class="nf">learn</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">episodes</code><code class="p">):</code>
        <code class="sd">''' Method to train the DQL agent.</code>
<code class="sd">        '''</code>
        <code class="k">for</code> <code class="n">e</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">episodes</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>
            <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">reset</code><code class="p">()</code>
            <code class="n">state</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                       <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>
            <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10000</code><code class="p">):</code>
                <code class="n">action</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">act</code><code class="p">(</code><code class="n">state</code><code class="p">)</code>
                <code class="n">next_state</code><code class="p">,</code> <code class="n">reward</code><code class="p">,</code> <code class="n">done</code><code class="p">,</code> <code class="n">info</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">step</code><code class="p">(</code><code class="n">action</code><code class="p">)</code>
                <code class="n">next_state</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">next_state</code><code class="p">,</code>
                                        <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                         <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">memory</code><code class="o">.</code><code class="n">append</code><code class="p">([</code><code class="n">state</code><code class="p">,</code> <code class="n">action</code><code class="p">,</code> <code class="n">reward</code><code class="p">,</code>
                                    <code class="n">next_state</code><code class="p">,</code> <code class="n">done</code><code class="p">])</code>
                <code class="n">state</code> <code class="o">=</code> <code class="n">next_state</code>
                <code class="k">if</code> <code class="n">done</code><code class="p">:</code>
                    <code class="n">treward</code> <code class="o">=</code> <code class="n">_</code> <code class="o">+</code> <code class="mi">1</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">trewards</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">treward</code><code class="p">)</code>
                    <code class="n">av</code> <code class="o">=</code> <code class="nb">sum</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">trewards</code><code class="p">[</code><code class="o">-</code><code class="mi">25</code><code class="p">:])</code> <code class="o">/</code> <code class="mi">25</code>
                    <code class="n">perf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">learn_env</code><code class="o">.</code><code class="n">performance</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">averages</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">av</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">performances</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">perf</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">aperformances</code><code class="o">.</code><code class="n">append</code><code class="p">(</code>
                        <code class="nb">sum</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">performances</code><code class="p">[</code><code class="o">-</code><code class="mi">25</code><code class="p">:])</code> <code class="o">/</code> <code class="mi">25</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">max_treward</code> <code class="o">=</code> <code class="nb">max</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">max_treward</code><code class="p">,</code> <code class="n">treward</code><code class="p">)</code>
                    <code class="n">templ</code> <code class="o">=</code> <code class="s1">'episode: {:2d}/{} | treward: {:4d} | '</code>
                    <code class="n">templ</code> <code class="o">+=</code> <code class="s1">'perf: {:5.3f} | av: {:5.1f} | max: {:4d}'</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">templ</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">e</code><code class="p">,</code> <code class="n">episodes</code><code class="p">,</code> <code class="n">treward</code><code class="p">,</code> <code class="n">perf</code><code class="p">,</code>
                                       <code class="n">av</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">max_treward</code><code class="p">),</code> <code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="se">\r</code><code class="s1">'</code><code class="p">)</code>
                    <code class="k">break</code>
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">val</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">validate</code><code class="p">(</code><code class="n">e</code><code class="p">,</code> <code class="n">episodes</code><code class="p">)</code>
            <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">memory</code><code class="p">)</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">batch_size</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">replay</code><code class="p">()</code>
        <code class="k">print</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">validate</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">e</code><code class="p">,</code> <code class="n">episodes</code><code class="p">):</code>
        <code class="sd">''' Method to validate the performance of the</code>
<code class="sd">            DQL agent.</code>
<code class="sd">        '''</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">reset</code><code class="p">()</code>
        <code class="n">state</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                   <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>
        <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10000</code><code class="p">):</code>
            <code class="n">action</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">state</code><code class="p">)[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
            <code class="n">next_state</code><code class="p">,</code> <code class="n">reward</code><code class="p">,</code> <code class="n">done</code><code class="p">,</code> <code class="n">info</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">step</code><code class="p">(</code><code class="n">action</code><code class="p">)</code>
            <code class="n">state</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">next_state</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code>
                                            <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>
            <code class="k">if</code> <code class="n">done</code><code class="p">:</code>
                <code class="n">treward</code> <code class="o">=</code> <code class="n">_</code> <code class="o">+</code> <code class="mi">1</code>
                <code class="n">perf</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">valid_env</code><code class="o">.</code><code class="n">performance</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">vperformances</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">perf</code><code class="p">)</code>
                <code class="k">if</code> <code class="n">e</code> <code class="o">%</code> <code class="nb">int</code><code class="p">(</code><code class="n">episodes</code> <code class="o">/</code> <code class="mi">6</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
                    <code class="n">templ</code> <code class="o">=</code> <code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code>
                    <code class="n">templ</code> <code class="o">+=</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">episode: {:2d}/{} | VALIDATION | '</code>
                    <code class="n">templ</code> <code class="o">+=</code> <code class="s1">'treward: {:4d} | perf: {:5.3f} | eps: {:.2f}</code><code class="se">\n</code><code class="s1">'</code>
                    <code class="n">templ</code> <code class="o">+=</code> <code class="mi">71</code> <code class="o">*</code> <code class="s1">'='</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">templ</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">e</code><code class="p">,</code> <code class="n">episodes</code><code class="p">,</code> <code class="n">treward</code><code class="p">,</code>
                                       <code class="n">perf</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">epsilon</code><code class="p">))</code>
                <code class="k">break</code>


<code class="k">def</code> <code class="nf">plot_treward</code><code class="p">(</code><code class="n">agent</code><code class="p">):</code>
    <code class="sd">''' Function to plot the total reward</code>
<code class="sd">        per training episode.</code>
<code class="sd">    '''</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>
    <code class="n">x</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">agent</code><code class="o">.</code><code class="n">averages</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
    <code class="n">y</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">polyfit</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">averages</code><code class="p">,</code> <code class="n">deg</code><code class="o">=</code><code class="mi">3</code><code class="p">),</code> <code class="n">x</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">averages</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'moving average'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="s1">'r--'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'regression'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s1">'episodes'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'total reward'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">()</code>


<code class="k">def</code> <code class="nf">plot_performance</code><code class="p">(</code><code class="n">agent</code><code class="p">):</code>
    <code class="sd">''' Function to plot the financial gross</code>
<code class="sd">        performance per training episode.</code>
<code class="sd">    '''</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>
    <code class="n">x</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">agent</code><code class="o">.</code><code class="n">performances</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
    <code class="n">y</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">polyfit</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">performances</code><code class="p">,</code> <code class="n">deg</code><code class="o">=</code><code class="mi">3</code><code class="p">),</code> <code class="n">x</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">performances</code><code class="p">[:],</code> <code class="n">label</code><code class="o">=</code><code class="s1">'training'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="s1">'r--'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'regression (train)'</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">agent</code><code class="o">.</code><code class="n">val</code><code class="p">:</code>
        <code class="n">y_</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">polyval</code><code class="p">(</code><code class="n">np</code><code class="o">.</code><code class="n">polyfit</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">vperformances</code><code class="p">,</code> <code class="n">deg</code><code class="o">=</code><code class="mi">3</code><code class="p">),</code> <code class="n">x</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">agent</code><code class="o">.</code><code class="n">vperformances</code><code class="p">[:],</code> <code class="n">label</code><code class="o">=</code><code class="s1">'validation'</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y_</code><code class="p">,</code> <code class="s1">'r-.'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'regression (valid)'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s1">'episodes'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'gross performance'</code><code class="p">)</code>
    <code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">()</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Backtesting Base Class"><div class="sect2" id="rm_base">
<h2>Backtesting Base Class</h2>

<p><a data-type="indexterm" data-primary="BacktestingBase class" id="idm45625260220152"/>The following is the Python module with the <code>BacktestingBase</code> class for event-based backtesting:</p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code><code>
</code><code class="c1"># Event-Based Backtesting</code><code>
</code><code class="c1"># --Base Class (1)</code><code>
</code><code class="c1">#</code><code>
</code><code class="c1"># (c) Dr. Yves J. Hilpisch</code><code>
</code><code class="c1"># Artificial Intelligence in Finance</code><code>
</code><code class="c1">#</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">BacktestingBase</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">env</code><code class="p">,</code><code> </code><code class="n">model</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="p">,</code><code> </code><code class="n">ptc</code><code class="p">,</code><code> </code><code class="n">ftc</code><code class="p">,</code><code> </code><code class="n">verbose</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code> </code><code class="o">=</code><code> </code><code class="n">env</code><code>  </code><a class="co" id="co_risk_management_CO15-1" href="#callout_risk_management_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">model</code><code>  </code><a class="co" id="co_risk_management_CO15-2" href="#callout_risk_management_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code> </code><code class="o">=</code><code> </code><code class="n">amount</code><code>  </code><a class="co" id="co_risk_management_CO15-3" href="#callout_risk_management_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">=</code><code> </code><code class="n">amount</code><code>  </code><a class="co" id="co_risk_management_CO15-4" href="#callout_risk_management_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code> </code><code class="o">=</code><code> </code><code class="n">ptc</code><code>   </code><a class="co" id="co_risk_management_CO15-5" href="#callout_risk_management_CO15-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code> </code><code class="o">=</code><code> </code><code class="n">ftc</code><code>   </code><a class="co" id="co_risk_management_CO15-6" href="#callout_risk_management_CO15-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code> </code><code class="o">=</code><code> </code><code class="n">verbose</code><code>  </code><a class="co" id="co_risk_management_CO15-7" href="#callout_risk_management_CO15-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" id="co_risk_management_CO15-8" href="#callout_risk_management_CO15-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>  </code><a class="co" id="co_risk_management_CO15-9" href="#callout_risk_management_CO15-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">get_date_price</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Returns date and price for a given bar.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code> </code><code class="o">=</code><code> </code><code class="nb">str</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">index</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code class="p">)</code><code class="p">[</code><code class="p">:</code><code class="mi">10</code><code class="p">]</code><code>  </code><a class="co" id="co_risk_management_CO15-10" href="#callout_risk_management_CO15-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">symbol</code><code class="p">]</code><code class="o">.</code><code class="n">iloc</code><code class="p">[</code><code class="n">bar</code><code class="p">]</code><code>  </code><a class="co" id="co_risk_management_CO15-11" href="#callout_risk_management_CO15-10"><img src="Images/10.png" alt="10" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">print_balance</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Prints the current cash balance for a given bar.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | current balance = {self.current_balance:.2f}</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-12" href="#callout_risk_management_CO15-11"><img src="Images/11.png" alt="11" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">calculate_net_wealth</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">price</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code>  </code><a class="co" id="co_risk_management_CO15-13" href="#callout_risk_management_CO15-12"><img src="Images/12.png" alt="12" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">print_net_wealth</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Prints the net wealth for a given bar
            (cash + position).
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="n">net_wealth</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">calculate_net_wealth</code><code class="p">(</code><code class="n">price</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | net wealth = {net_wealth:.2f}</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-14" href="#callout_risk_management_CO15-13"><img src="Images/13.png" alt="13" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">place_buy_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Places a buy order for a given bar and for
            a given amount or number of units.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-15" href="#callout_risk_management_CO15-14"><img src="Images/14.png" alt="14" width="12" height="12"/></a><code>
</code><code>            </code><code class="c1"># units = amount / price  </code><a class="co" id="co_risk_management_CO15-16" href="#callout_risk_management_CO15-14"><img src="Images/14.png" alt="14" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code>\
</code><code>            </code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code> </code><code class="o">+</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>  </code><a class="co" id="co_risk_management_CO15-17" href="#callout_risk_management_CO15-15"><img src="Images/15.png" alt="15" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">units</code><code>  </code><a class="co" id="co_risk_management_CO15-18" href="#callout_risk_management_CO15-16"><img src="Images/16.png" alt="16" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_risk_management_CO15-19" href="#callout_risk_management_CO15-17"><img src="Images/17.png" alt="17" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | buy {units} units for {price:.4f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">place_sell_order</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">amount</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Places a sell order for a given bar and for
            a given amount or number of units.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">units</code><code> </code><code class="ow">is</code><code> </code><code class="bp">None</code><code class="p">:</code><code>
</code><code>            </code><code class="n">units</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">amount</code><code> </code><code class="o">/</code><code> </code><code class="n">price</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-20" href="#callout_risk_management_CO15-14"><img src="Images/14.png" alt="14" width="12" height="12"/></a><code>
</code><code>            </code><code class="c1"># units = amount / price  </code><a class="co" id="co_risk_management_CO15-21" href="#callout_risk_management_CO15-14"><img src="Images/14.png" alt="14" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="p">(</code><code class="mi">1</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ptc</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code>\
</code><code>            </code><code class="n">units</code><code> </code><code class="o">*</code><code> </code><code class="n">price</code><code> </code><code class="o">-</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">ftc</code><code>  </code><a class="co" id="co_risk_management_CO15-22" href="#callout_risk_management_CO15-15"><img src="Images/15.png" alt="15" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">-</code><code class="o">=</code><code> </code><code class="n">units</code><code>  </code><a class="co" id="co_risk_management_CO15-23" href="#callout_risk_management_CO15-16"><img src="Images/16.png" alt="16" width="12" height="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">trades</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>  </code><a class="co" id="co_risk_management_CO15-24" href="#callout_risk_management_CO15-17"><img src="Images/17.png" alt="17" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | sell {units} units for {price:.4f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">close_out</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">bar</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">''' Closes out any open position at a given bar.
        '''</code><code>
</code><code>        </code><code class="n">date</code><code class="p">,</code><code> </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | *** CLOSING OUT ***</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">0</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-25" href="#callout_risk_management_CO15-18"><img src="Images/18.png" alt="18" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">else</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code><code> </code><code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code><code>  </code><a class="co" id="co_risk_management_CO15-26" href="#callout_risk_management_CO15-19"><img src="Images/19.png" alt="19" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code><code>
</code><code>            </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | current balance = {self.current_balance:.2f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="n">perf</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code> </code><code class="o">/</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mi">100</code><code>  </code><a class="co" id="co_risk_management_CO15-27" href="#callout_risk_management_CO15-20"><img src="Images/20.png" alt="20" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | net performance [</code><code class="s1">%</code><code class="s1">] = {perf:.4f}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{date} | number of trades [#] = {self.trades}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">print</code><code class="p">(</code><code class="mi">50</code><code> </code><code class="o">*</code><code> </code><code class="s1">'</code><code class="s1">=</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_risk_management_CO15-1" href="#co_risk_management_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The relevant <code>Finance</code> environment</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-2" href="#co_risk_management_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The relevant DNN model (from the trading bot)</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-3" href="#co_risk_management_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The initial/current balance</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-4" href="#co_risk_management_CO15-5"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Proportional transaction costs</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-5" href="#co_risk_management_CO15-6"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Fixed transaction costs</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-6" href="#co_risk_management_CO15-7"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Whether the prints are verbose or not</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-7" href="#co_risk_management_CO15-8"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>The initial number of units of the financial instrument traded</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-8" href="#co_risk_management_CO15-9"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>The initial number of trades implemented</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-9" href="#co_risk_management_CO15-10"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>The relevant <em>date</em> given a certain bar</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-10" href="#co_risk_management_CO15-11"><img src="Images/10.png" alt="10" width="12" height="12"/></a></dt>
<dd><p>The relevant <em>instrument price</em> at a certain bar</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-11" href="#co_risk_management_CO15-12"><img src="Images/11.png" alt="11" width="12" height="12"/></a></dt>
<dd><p>The output of the <em>date</em> and <em>current balance</em> for a certain bar</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-12" href="#co_risk_management_CO15-13"><img src="Images/12.png" alt="12" width="12" height="12"/></a></dt>
<dd><p>The calculation of the <em>net wealth</em> from the current balance and the instrument position</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-13" href="#co_risk_management_CO15-14"><img src="Images/13.png" alt="13" width="12" height="12"/></a></dt>
<dd><p>The output of the <em>date</em> and the <em>net wealth</em> at a certain bar</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-14" href="#co_risk_management_CO15-15"><img src="Images/14.png" alt="14" width="12" height="12"/></a></dt>
<dd><p>The number of units to be traded given the trade amount</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-15" href="#co_risk_management_CO15-17"><img src="Images/15.png" alt="15" width="12" height="12"/></a></dt>
<dd><p>The impact of the trade and the associated costs on the current balance</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-16" href="#co_risk_management_CO15-18"><img src="Images/16.png" alt="16" width="12" height="12"/></a></dt>
<dd><p>The adjustment of the number of units held</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-17" href="#co_risk_management_CO15-19"><img src="Images/17.png" alt="17" width="12" height="12"/></a></dt>
<dd><p>The adjustment of the number of trades implemented</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-18" href="#co_risk_management_CO15-25"><img src="Images/18.png" alt="18" width="12" height="12"/></a></dt>
<dd><p>The closing of a <em>short</em> position…</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-19" href="#co_risk_management_CO15-26"><img src="Images/19.png" alt="19" width="12" height="12"/></a></dt>
<dd><p>…or of a <em>long</em> position</p></dd>
<dt><a class="co" id="callout_risk_management_CO15-20" href="#co_risk_management_CO15-27"><img src="Images/20.png" alt="20" width="12" height="12"/></a></dt>
<dd><p>The net performance given the initial amount and the final current balance</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Backtesting Class"><div class="sect2" id="rm_backtest">
<h2>Backtesting Class</h2>

<p><a data-type="indexterm" data-primary="TBBacktesterRM class" id="idm45625254930216"/>The following is the Python module with the <code>TBBacktesterRM</code> class for event-based backtesting including risk measures (stop loss, trailing stop loss, take profit orders):<a data-type="indexterm" data-primary="" data-startref="ix_risk_man_pythoncode" id="idm45625254928984"/></p>

<pre data-type="programlisting" data-code-language="python"><code class="c1">#</code>
<code class="c1"># Event-Based Backtesting</code>
<code class="c1"># --Trading Bot Backtester</code>
<code class="c1"># (incl. Risk Management)</code>
<code class="c1">#</code>
<code class="c1"># (c) Dr. Yves J. Hilpisch</code>
<code class="c1">#</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code>
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>
<code class="kn">import</code> <code class="nn">backtestingrm</code> <code class="kn">as</code> <code class="nn">btr</code>


<code class="k">class</code> <code class="nc">TBBacktesterRM</code><code class="p">(</code><code class="n">btr</code><code class="o">.</code><code class="n">BacktestingBaseRM</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">_reshape</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">state</code><code class="p">):</code>
        <code class="sd">''' Helper method to reshape state objects.</code>
<code class="sd">        '''</code>
        <code class="k">return</code> <code class="n">np</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">n_features</code><code class="p">])</code>

    <code class="k">def</code> <code class="nf">backtest_strategy</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">sl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">tsl</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code> <code class="n">tp</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code>
                          <code class="n">wait</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code> <code class="n">guarantee</code><code class="o">=</code><code class="bp">False</code><code class="p">):</code>
        <code class="sd">''' Event-based backtesting of the trading bot's performance.</code>
<code class="sd">            Incl. stop loss, trailing stop loss and take profit.</code>
<code class="sd">        '''</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">units</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">sl</code> <code class="o">=</code> <code class="n">sl</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tsl</code> <code class="o">=</code> <code class="n">tsl</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">tp</code> <code class="o">=</code> <code class="n">tp</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">initial_amount</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code> <code class="o">=</code> <code class="nb">list</code><code class="p">()</code>
        <code class="k">for</code> <code class="n">bar</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">lags</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">data</code><code class="p">)):</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="nb">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>
            <code class="n">date</code><code class="p">,</code> <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_date_price</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">trades</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
                <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>
                <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | *** START BACKTEST ***'</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">print_balance</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>
                <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'='</code><code class="p">)</code>

            <code class="c1"># stop loss order</code>
            <code class="k">if</code> <code class="n">sl</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
                <code class="n">rc</code> <code class="o">=</code> <code class="p">(</code><code class="n">price</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&lt;</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
                        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">)</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** STOP LOSS (LONG  | {-self.sl:.4f}) ***'</code><code class="p">)</code>
                    <code class="k">else</code><code class="p">:</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** STOP LOSS (LONG  | {rc:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
                <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
                        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">sl</code><code class="p">)</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** STOP LOSS (SHORT | -{self.sl:.4f}) ***'</code><code class="p">)</code>
                    <code class="k">else</code><code class="p">:</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** STOP LOSS (SHORT | -{rc:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>

            <code class="c1"># trailing stop loss order</code>
            <code class="k">if</code> <code class="n">tsl</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">max_price</code> <code class="o">=</code> <code class="nb">max</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code class="p">,</code> <code class="n">price</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">min_price</code> <code class="o">=</code> <code class="nb">min</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code><code class="p">,</code> <code class="n">price</code><code class="p">)</code>
                <code class="n">rc_1</code> <code class="o">=</code> <code class="p">(</code><code class="n">price</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">max_price</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code>
                <code class="n">rc_2</code> <code class="o">=</code> <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">min_price</code> <code class="o">-</code> <code class="n">price</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">rc_1</code> <code class="o">&lt;</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TRAILING SL (LONG  | {rc_1:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
                <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">rc_2</code> <code class="o">&lt;</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tsl</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TRAILING SL (SHORT | {rc_2:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>

            <code class="c1"># take profit order</code>
            <code class="k">if</code> <code class="n">tp</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">:</code>
                <code class="n">rc</code> <code class="o">=</code> <code class="p">(</code><code class="n">price</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code><code class="p">)</code> <code class="o">/</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&gt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
                        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">)</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (LONG  | {self.tp:.4f}) ***'</code><code class="p">)</code>
                    <code class="k">else</code><code class="p">:</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (LONG  | {rc:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>
                <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="n">rc</code> <code class="o">&lt;</code> <code class="o">-</code><code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">if</code> <code class="n">guarantee</code><code class="p">:</code>
                        <code class="n">price</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">entry_price</code> <code class="o">*</code> <code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="bp">self</code><code class="o">.</code><code class="n">tp</code><code class="p">)</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (SHORT | {self.tp:.4f}) ***'</code><code class="p">)</code>
                    <code class="k">else</code><code class="p">:</code>
                        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'*** TAKE PROFIT (SHORT | {-rc:.4f}) ***'</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">,</code> <code class="n">gprice</code><code class="o">=</code><code class="n">price</code><code class="p">)</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">=</code> <code class="n">wait</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">0</code>

            <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">env</code><code class="o">.</code><code class="n">get_state</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>
            <code class="n">action</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">argmax</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">_reshape</code><code class="p">(</code><code class="n">state</code><code class="o">.</code><code class="n">values</code><code class="p">))[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
            <code class="n">position</code> <code class="o">=</code> <code class="mi">1</code> <code class="k">if</code> <code class="n">action</code> <code class="o">==</code> <code class="mi">1</code> <code class="k">else</code> <code class="o">-</code><code class="mi">1</code>
            <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">position</code> <code class="o">==</code> <code class="mi">1</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | *** GOING LONG ***'</code><code class="p">)</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">:</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code> <code class="o">-</code> <code class="mi">1</code><code class="p">,</code> <code class="n">units</code><code class="o">=-</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">place_buy_order</code><code class="p">(</code><code class="n">bar</code> <code class="o">-</code> <code class="mi">1</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code class="p">)</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="mi">1</code>
            <code class="k">elif</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">]</code> <code class="ow">and</code> <code class="n">position</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code> <code class="ow">and</code> <code class="bp">self</code><code class="o">.</code><code class="n">wait</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
                    <code class="k">print</code><code class="p">(</code><code class="mi">50</code> <code class="o">*</code> <code class="s1">'-'</code><code class="p">)</code>
                    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{date} | *** GOING SHORT ***'</code><code class="p">)</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code> <code class="o">-</code> <code class="mi">1</code><code class="p">,</code> <code class="n">units</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">units</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">place_sell_order</code><code class="p">(</code><code class="n">bar</code> <code class="o">-</code> <code class="mi">1</code><code class="p">,</code> <code class="n">amount</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">current_balance</code><code class="p">)</code>
                <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">verbose</code><code class="p">:</code>
                    <code class="bp">self</code><code class="o">.</code><code class="n">print_net_wealth</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">position</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">append</code><code class="p">((</code><code class="n">date</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">calculate_net_wealth</code><code class="p">(</code><code class="n">price</code><code class="p">)))</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="p">,</code>
                                        <code class="n">columns</code><code class="o">=</code><code class="p">[</code><code class="s1">'date'</code><code class="p">,</code> <code class="s1">'net_wealth'</code><code class="p">])</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="s1">'date'</code><code class="p">,</code> <code class="n">inplace</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">index</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DatetimeIndex</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">net_wealths</code><code class="o">.</code><code class="n">index</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">close_out</code><code class="p">(</code><code class="n">bar</code><code class="p">)</code></pre>
</div></section>





</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45625264808136"><sup><a href="ch11.xhtml#idm45625264808136-marker">1</a></sup> For more details on the ATR measure, see <a href="https://oreil.ly/2sUsg">ATR (1) Investopedia</a> or <a href="https://oreil.ly/zwrnO">ATR (2) Investopedia</a>.</p><p data-type="footnote" id="idm45625263710744"><sup><a href="ch11.xhtml#idm45625263710744-marker">2</a></sup> A <em>guaranteed</em> stop loss order might only be available in certain jurisdictions for certain groups of broker clients, such as retail investors/traders.</p><p data-type="footnote" id="idm45625261444776"><sup><a href="ch11.xhtml#idm45625261444776-marker">3</a></sup> A take profit order has a fixed target price level. Therefore, it is unrealistic to use the high price of a time interval for a long position or the low price of the interval for a short position to calculate the realized profit.</p></div></div></section></div>



  </body></html>